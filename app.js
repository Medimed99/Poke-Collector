// ========================================
// POK√âMON BLIND BOX COLLECTOR V6.2 FINAL - APP.JS COMPLET
// ‚úÖ Toutes les fonctionnalit√©s + Guillemets corrig√©s
// ========================================

// ===== PART 1: DONN√âES & CONFIGURATION =====

const FRENCH_NAMES = {1:"Bulbizarre",2:"Herbizarre",3:"Florizarre",4:"Salam√®che",5:"Reptincel",6:"Dracaufeu",7:"Carapuce",8:"Carabaffe",9:"Tortank",10:"Chenipan",11:"Chrysacier",12:"Papilusion",13:"Aspicot",14:"Coconfort",15:"Dardargnan",16:"Roucool",17:"Roucoups",18:"Roucarnage",19:"Rattata",20:"Rattatac",21:"Piafabec",22:"Rapasdepic",23:"Abo",24:"Arbok",25:"Pikachu",26:"Raichu",27:"Sabelette",28:"Sablaireau",29:"Nidoran‚ôÄ",30:"Nidorina",31:"Nidoqueen",32:"Nidoran‚ôÇ",33:"Nidorino",34:"Nidoking",35:"M√©lof√©e",36:"M√©lodelfe",37:"Goupix",38:"Feunard",39:"Rondoudou",40:"Grodoudou",41:"Nosferapti",42:"Nosferalto",43:"Mystherbe",44:"Ortide",45:"Rafflesia",46:"Paras",47:"Parasect",48:"Mimitoss",49:"A√©romite",50:"Taupiqueur",51:"Triopikeur",52:"Miaouss",53:"Persian",54:"Psykokwak",55:"Akwakwak",56:"F√©rosinge",57:"Colossinge",58:"Caninos",59:"Arcanin",60:"Ptitard",61:"T√™tarte",62:"Tartard",63:"Abra",64:"Kadabra",65:"Alakazam",66:"Machoc",67:"Machopeur",68:"Mackogneur",69:"Ch√©tiflor",70:"Boustiflor",71:"Empiflor",72:"Tentacool",73:"Tentacruel",74:"Racaillou",75:"Gravalanch",76:"Grolem",77:"Ponyta",78:"Galopa",79:"Ramoloss",80:"Flagadoss",81:"Magn√©ti",82:"Magn√©ton",83:"Canarticho",84:"Doduo",85:"Dodrio",86:"Otaria",87:"Lamantine",88:"Tadmorv",89:"Grotadmorv",90:"Kokiyas",91:"Crustabri",92:"Fantominus",93:"Spectrum",94:"Ectoplasma",95:"Onix",96:"Soporifik",97:"Hypnomade",98:"Krabby",99:"Krabboss",100:"Voltorbe",101:"√âlectrode",102:"Noeunoeuf",103:"Noadkoko",104:"Osselait",105:"Ossatueur",106:"Kicklee",107:"Tygnon",108:"Excelangue",109:"Smogo",110:"Smogogo",111:"Rhinocorne",112:"Rhinof√©ros",113:"Leveinard",114:"Saquedeneu",115:"Kangourex",116:"Hypotrempe",117:"Hypoc√©an",118:"Poissir√®ne",119:"Poissoroy",120:"Stari",121:"Staross",122:"M.Mime",123:"Ins√©cateur",124:"Lippoutou",125:"√âlektek",126:"Magmar",127:"Scarabrute",128:"Tauros",129:"Magicarpe",130:"L√©viator",131:"Lokhlass",132:"M√©tamorph",133:"√âvoli",134:"Aquali",135:"Voltali",136:"Pyroli",137:"Porygon",138:"Amonita",139:"Amonistar",140:"Kabuto",141:"Kabutops",142:"Pt√©ra",143:"Ronflex",144:"Artikodin",145:"√âlecthor",146:"Sulfura",147:"Minidraco",148:"Draco",149:"Dracolosse",150:"Mewtwo",151:"Mew",152:"Germignon",153:"Macronium",154:"M√©ganium",155:"H√©ricendre",156:"Feurisson",157:"Typhlosion",158:"Kaiminus",159:"Crocrodil",160:"Aligatueur",161:"Fouinette",162:"Fouinar",163:"Hoothoot",164:"Noarfang",165:"Coxy",166:"Coxyclaque",167:"Mimigal",168:"Migalos",169:"Nostenfer",170:"Loupio",171:"Lanturn",172:"Pichu",173:"M√©lo",174:"Toudoudou",175:"Togepi",176:"Togetic",177:"Natu",178:"Xatu",179:"Wattouat",180:"Lainergie",181:"Pharamp",182:"Joliflor",183:"Marill",184:"Azumarill",185:"Simularbre",186:"Tarpaud",187:"Granivol",188:"Floravol",189:"Cotovol",190:"Capumain",191:"Tournegrin",192:"H√©liatronc",193:"Yanma",194:"Axoloto",195:"Maraiste",196:"Mentali",197:"Noctali",198:"Corn√®bre",199:"Roigada",200:"Feufor√™ve",201:"Zarbi",202:"Qulbutok√©",203:"Girafarig",204:"Pomdepik",205:"Foretress",206:"Insolourdo",207:"Scorplane",208:"Steelix",209:"Snubbull",210:"Granbull",211:"Qwilfish",212:"Cizayox",213:"Caratroc",214:"Scarhino",215:"Farfuret",216:"Teddiursa",217:"Ursaring",218:"Limagma",219:"Volcaropod",220:"Marcacrin",221:"Cochignon",222:"Corayon",223:"R√©moraid",224:"Octillery",225:"Cadoizo",226:"D√©manta",227:"Airmure",228:"Malosse",229:"D√©molosse",230:"Hyporoi",231:"Phanpy",232:"Donphan",233:"Porygon2",234:"K√©fir",235:"Queueul",236:"Debugant",237:"Kapoera",238:"Lippouti",239:"√âlekid",240:"Magby",241:"√âcr√©meuh",242:"Leuphorie",243:"Raikou",244:"Entei",245:"Suicune",246:"Embrylex",247:"Ymphect",248:"Tyranocif",249:"Lugia",250:"Ho-Oh",251:"C√©l√©bi"};

const WATER_TYPES = [7,8,9,54,55,60,61,62,72,73,79,80,86,87,90,91,98,99,116,117,118,119,120,121,129,130,131,134,138,139,140,141,158,159,160,170,171,183,184,186,194,195,199,223,224,226,230,245];
const FIRE_TYPES = [4,5,6,37,38,58,59,77,78,146];
const GRASS_TYPES = [1,2,3,69,70,71,102,103];

const POKEMON_TYPES = {1:['Plante','Poison'],2:['Plante','Poison'],3:['Plante','Poison'],4:['Feu'],5:['Feu'],6:['Feu','Vol'],7:['Eau'],8:['Eau'],9:['Eau'],10:['Insecte'],11:['Insecte'],12:['Insecte','Vol'],13:['Insecte','Poison'],14:['Insecte','Poison'],15:['Insecte','Poison'],16:['Normal','Vol'],17:['Normal','Vol'],18:['Normal','Vol'],19:['Normal'],20:['Normal'],21:['Normal','Vol'],22:['Normal','Vol'],23:['Poison'],24:['Poison'],25:['√âlectrik'],26:['√âlectrik'],27:['Sol'],28:['Sol'],29:['Poison'],30:['Poison'],31:['Poison','Sol'],32:['Poison'],33:['Poison'],34:['Poison','Sol'],35:['F√©e'],36:['F√©e'],37:['Feu'],38:['Feu'],39:['Normal','F√©e'],40:['Normal','F√©e'],41:['Poison','Vol'],42:['Poison','Vol'],43:['Plante','Poison'],44:['Plante','Poison'],45:['Plante','Poison'],46:['Insecte','Plante'],47:['Insecte','Plante'],48:['Insecte','Poison'],49:['Insecte','Poison'],50:['Sol'],51:['Sol'],52:['Normal'],53:['Normal'],54:['Eau'],55:['Eau'],56:['Combat'],57:['Combat'],58:['Feu'],59:['Feu'],60:['Eau'],61:['Eau'],62:['Eau','Combat'],63:['Psy'],64:['Psy'],65:['Psy'],66:['Combat'],67:['Combat'],68:['Combat'],69:['Plante','Poison'],70:['Plante','Poison'],71:['Plante','Poison'],72:['Eau','Poison'],73:['Eau','Poison'],74:['Roche','Sol'],75:['Roche','Sol'],76:['Roche','Sol'],77:['Feu'],78:['Feu'],79:['Eau','Psy'],80:['Eau','Psy'],81:['√âlectrik','Acier'],82:['√âlectrik','Acier'],83:['Normal','Vol'],84:['Normal','Vol'],85:['Normal','Vol'],86:['Eau'],87:['Eau','Glace'],88:['Poison'],89:['Poison'],90:['Eau'],91:['Eau','Glace'],92:['Spectre','Poison'],93:['Spectre','Poison'],94:['Spectre','Poison'],95:['Roche','Sol'],96:['Psy'],97:['Psy'],98:['Eau'],99:['Eau'],100:['√âlectrik'],101:['√âlectrik'],102:['Plante','Psy'],103:['Plante','Psy'],104:['Sol'],105:['Sol'],106:['Combat'],107:['Combat'],108:['Normal'],109:['Poison'],110:['Poison'],111:['Sol','Roche'],112:['Sol','Roche'],113:['Normal'],114:['Plante'],115:['Normal'],116:['Eau'],117:['Eau'],118:['Eau'],119:['Eau'],120:['Eau'],121:['Eau','Psy'],122:['Psy','F√©e'],123:['Insecte','Vol'],124:['Glace','Psy'],125:['√âlectrik'],126:['Feu'],127:['Insecte'],128:['Normal'],129:['Eau'],130:['Eau','Vol'],131:['Eau','Glace'],132:['Normal'],133:['Normal'],134:['Eau'],135:['√âlectrik'],136:['Feu'],137:['Normal'],138:['Roche','Eau'],139:['Roche','Eau'],140:['Roche','Eau'],141:['Roche','Eau'],142:['Roche','Vol'],143:['Normal'],144:['Glace','Vol'],145:['√âlectrik','Vol'],146:['Feu','Vol'],147:['Dragon'],148:['Dragon'],149:['Dragon','Vol'],150:['Psy'],151:['Psy']};

const POKEMON_DATA = {
    common:[10,13,16,19,21,23,27,29,32,35,37,39,41,43,46,48,50,52,54,56,58,60,63,66,69,72,74,77,79,81,84,86,88,90,92,95,96,98,100,102,104,108,109,111,114,116,118,120,129,161,163,165,167,172,173,174,175,177,179,187,190,191,193,194,198,200,204,206,209,211,213,215,216,218,220,223,225,231,234,235,236,240,261,263,265,270,273,276,280,290,293,296,298,300,304,307,309,311,313,315,316,318,320,322,325,327,328,331,333,339,341,343,345,347,349,351,353,355,357,359,361,363,365,367,369,371,374],
    uncommon:[1,2,4,5,7,8,11,14,17,20,22,24,25,26,28,30,33,36,38,40,42,44,47,49,51,53,55,57,61,64,67,70,73,75,78,82,85,87,89,93,97,99,101,105,106,107,110,117,119,133,152,153,155,156,158,159,162,164,166,168,170,176,178,180,183,185,186,188,189,192,195,197,199,201,203,205,207,210,212,214,217,219,221,222,224,226,227,228,230,232,233,237,238,239,241,242,246,252,255,258,262,264,266,268,271,274,277,279,281,283,284,285,286,288,291,292,294,295,297,299,301,302,303,305,306,308,310,312,314,317,319,321,323,324,326,329,330,332,334,335,336,337,338,340,342,344,346,348,350,352,354,356,358,360,362,364,366,368,370,372,375,377,378,379],
    rare:[3,6,9,12,15,18,31,34,45,59,62,65,68,71,76,80,83,91,94,103,112,113,115,121,122,130,134,135,136,137,139,141,147,148,154,157,160,169,171,181,182,184,196,202,208,229,247,253,256,259,267,269,272,275,278,282],
    super_rare:[123,124,125,126,127,128,131,132,138,140,142,143,149,248,254,257,260,373,376],
    legendary:[144,145,146,150,151,243,244,245,249,250,251,380,381,382,383,384,385,386]
};

const DAILY_QUEST_POOLS = {
    easy: [
        {id:'daily_captures_5',name:'Capturer 5 Pok√©mon',desc:'Capturez 5 Pok√©mon',target:5,reward:{coins:500,xp:100,framby:1},icon:'‚öæ',trackType:'captures'},
        {id:'daily_captures_10',name:'Capturer 10 Pok√©mon',desc:'Capturez 10 Pok√©mon',target:10,reward:{coins:800,xp:150,pinap:1},icon:'‚öæ',trackType:'captures'},
        {id:'daily_coins_1000',name:'Gagner 1000 coins',desc:'Gagnez 1000 coins en capture',target:1000,reward:{coins:600,xp:100,pokeball:5},icon:'üí∞',trackType:'coins'},
        {id:'daily_flees_15',name:'Atterrissage x15',desc:'Subir 15 √©checs de capture',target:15,reward:{coins:400,xp:80,pinap:1},icon:'‚ùå',trackType:'flees'}
    ],
    medium: [
        {id:'daily_captures_20',name:'Capturer 20 Pok√©mon',desc:'Capturez 20 Pok√©mon',target:20,reward:{coins:1200,xp:200,greatball:3},icon:'‚öæ',trackType:'captures'},
        {id:'daily_fishing_3',name:'P√™cher 3 Pok√©mon',desc:'P√™chez 3 Pok√©mon (niveau 2+)',target:3,reward:{coins:600,xp:150,diveball:1},icon:'üé£',trackType:'fished'},
        {id:'daily_coins_2000',name:'Gagner 2000 coins',desc:'Gagnez 2000 coins en capture',target:2000,reward:{coins:1000,xp:150,lootbox:1},icon:'üí∞',trackType:'coins'},
        {id:'daily_shiny_1',name:'Trouver un Shiny',desc:'Capturez 1 Pok√©mon Shiny',target:1,reward:{coins:1500,xp:300,ceriz:1},icon:'‚ú®',trackType:'shinies'},
        {id:'daily_rare_2',name:'Capturer 2 Rares',desc:'Capturez 2 Pok√©mon Rares ou mieux',target:2,reward:{coins:1000,xp:200,ultraball:1},icon:'‚≠ê',trackType:'rare_captures'},
        {id:'daily_rogue_1',name:'Explorateur',desc:'Compl√©tez 1 Exp√©dition Arcanes',target:1,reward:{coins:1000,xp:200,rarebox:1},icon:'üó∫Ô∏è',trackType:'rogue_completed'}
    ],
    hard: [
        {id:'daily_captures_30',name:'Capturer 30 Pok√©mon',desc:'Capturez 30 Pok√©mon',target:30,reward:{coins:2000,xp:300,ultraball:2},icon:'‚öæ',trackType:'captures'},
        {id:'daily_fishing_5',name:'P√™cher 5 Pok√©mon',desc:'P√™chez 5 Pok√©mon (niveau 2+)',target:5,reward:{coins:1000,xp:250,diveball:2},icon:'üé£',trackType:'fished'},
        {id:'daily_coins_5000',name:'Gagner 5000 coins',desc:'Gagnez 5000 coins en capture',target:5000,reward:{coins:2000,xp:300,rarebox:1},icon:'üí∞',trackType:'coins'},
        {id:'daily_streak_10',name:'Streak de 10',desc:'Atteignez un streak de 10 captures',target:10,reward:{coins:1500,xp:250,exp_charm:1},icon:'üî•',trackType:'streak'},
        {id:'daily_legendary_1',name:'Capturer un L√©gendaire',desc:'Capturez 1 Pok√©mon L√©gendaire',target:1,reward:{coins:3000,xp:500,legendary_radar:1},icon:'üëë',trackType:'legendaries'},
        {id:'daily_rogue_2',name:'Aventurier',desc:'Compl√©tez 2 Exp√©ditions Arcanes',target:2,reward:{coins:2000,xp:400,ultraball:3},icon:'üó∫Ô∏è',trackType:'rogue_completed'}
    ],
    expert: [
        {id:'daily_captures_50',name:'Capturer 50 Pok√©mon',desc:'Capturez 50 Pok√©mon',target:50,reward:{coins:3000,xp:500,masterball:1},icon:'‚öæ',trackType:'captures'},
        {id:'daily_coins_10000',name:'Gagner 10000 coins',desc:'Gagnez 10000 coins en capture',target:10000,reward:{coins:4000,xp:600,suprarebox:1},icon:'üí∞',trackType:'coins'},
        {id:'daily_shiny_3',name:'Trouver 3 Shinies',desc:'Capturez 3 Pok√©mon Shiny',target:3,reward:{coins:5000,xp:800,ceriz:3},icon:'‚ú®',trackType:'shinies'},
        {id:'daily_legendary_2',name:'Capturer 2 L√©gendaires',desc:'Capturez 2 Pok√©mon L√©gendaires',target:2,reward:{coins:6000,xp:1000,ultrabox:1},icon:'üëë',trackType:'legendaries'}
    ]
};

const QUESTS_DATA = {
    daily: [],
    special: [
        // QA & POLISHING : Qu√™te d√©but de jeu plus g√©n√©reuse
        {id:'special_first_capture',name:'Premi√®re Capture',desc:'Capturez votre premier Pok√©mon',target:1,reward:{coins:500,xp:50,pokeball:10},icon:'üéØ',oneTime:true},
        {id:'special_mystery_egg',name:'√âclosion Myst√®re',desc:'Capturez 50 Pok√©mon',target:50,reward:{coins:2000,xp:500,mystery_egg:1},icon:'ü•ö',oneTime:true},
        {id:'special_complete_kanto',name:'Compl√©ter Kanto',desc:'Compl√©tez le Pok√©dex Kanto (151/151)',target:151,reward:{coins:25000,xp:1500,suprarebox:1,badge:'Kanto Collector'},icon:'üëë',oneTime:true},
        {id:'special_10_shinies',name:'Shiny Hunter',desc:'Capturez 10 Pok√©mon Shiny',target:10,reward:{coins:15000,xp:2000,lucky_charm:1,rarebox:1},icon:'‚ú®',oneTime:true},
        {id:'special_3_legendaries',name:'Chasseur d\'√âtoiles',desc:'Capturer 3 L√©gendaires',target:3,reward:{coins:10000,xp:1000,legendary_radar:1},icon:'üíé',oneTime:true},
        {id:'special_rogue_10',name:'Ma√Ætre Explorateur',desc:'Compl√©tez 10 Full Clear',target:10,reward:{coins:10000,xp:1000,shards:50},icon:'üèÜ',oneTime:true}
    ],
    permanent: [
        {id:'perm_hundred_captures',name:'Centuple Capture',desc:'Capturer 100 Pok√©mon',target:100,reward:{coins:5000,xp:500,rarebox:1},icon:'üíØ'},
        {id:'perm_thousand_captures',name:'Millennial',desc:'Capturer 1000 Pok√©mon',target:1000,reward:{coins:50000,xp:3000,suprarebox:1,charm_collection:1},icon:'üéØ'},
        {id:'perm_streak_50',name:'Ma√Ætre de Streak',desc:'Atteindre un streak de 50 captures',target:50,reward:{coins:10000,xp:1000,lucky_charm:1},icon:'üî•'},
        {id:'perm_legendary_5',name:'L√©gendaire +5',desc:'Capturer 5 Pok√©mon L√©gendaires',target:5,reward:{coins:20000,xp:2000,legendary_radar:1,ultrabox:1},icon:'üëë'},
        {id:'perm_type_master',name:'Type Master',desc:'Capturer 20 Pok√©mon d\'un m√™me type',target:20,reward:{coins:1000,xp:200,incensefleur:1},icon:'üåø',oneTime:false},
        {id:'perm_regional_collection',name:'Collection R√©gionale',desc:'Capturer 30 Pok√©mon d\'une r√©gion',target:30,reward:{coins:3000,xp:500,marin_lure:1},icon:'üåä',oneTime:false},
        {id:'perm_lucky_merchant',name:'Marchand Chanceux',desc:'Acheter 10 objets √† la boutique',target:10,reward:{coins:500,xp:100,pinap:1},icon:'‚úâÔ∏è',oneTime:false},
        {id:'perm_perfect_routine',name:'Routine Parfaite',desc:'Se connecter 7 jours cons√©cutifs',target:7,reward:{coins:2000,xp:300,lootbox:1},icon:'üîî',oneTime:false},
        {id:'perm_hidden_treasure',name:'Tr√©sor Cach√©',desc:'Ouvrir 20 Blind Box',target:20,reward:{coins:1500,xp:100,ceriz:1},icon:'‚ú®',oneTime:false},
        {id:'perm_regional_explorer',name:'D√©couvreur R√©gional',desc:'D√©bloquer 2 r√©gions',target:2,reward:{coins:5000,xp:1000,rarebox:1},icon:'üß≠',oneTime:true},
        {id:'perm_rogue_master',name:'Ma√Ætre de l\'Exp√©dition',desc:'Compl√©tez 50 runs roguelike',target:50,reward:{coins:25000,xp:2000,legendary_radar:1},icon:'üëë',oneTime:false}
    ]
};

const BUDDY_LEVELS = {
    1:{xp:0,bonus:null},
    2:{xp:20,bonus:{type:'coins',value:0.02,desc:'+2% coins sur captures'}},
    3:{xp:50,bonus:{type:'fleeReduce',value:0.03,desc:'+3% √©viter fuite'}},
    4:{xp:90,bonus:{type:'berries',value:0.03,desc:'+3% chance baies'}},
    5:{xp:140,bonus:{type:'rogueChest',value:0.05,desc:'+5% coffres roguelike'}},
    6:{xp:200,bonus:{type:'xpBoost',value:0.05,desc:'+5% XP global'}},
    7:{xp:270,bonus:{type:'shiny',value:0.01,desc:'+1% chance shiny'}},
    8:{xp:350,bonus:{type:'berryEfficiency',value:0.10,desc:'+10% efficacit√© baies'}},
    9:{xp:440,bonus:{type:'rogueRares',value:0.10,desc:'+10% rares roguelike'}},
    10:{xp:550,bonus:{type:'blessing',desc:'1 b√©n√©diction gratuite en roguelike'}}
};

// ===== EXPEDITION CONFIGURATION =====
const EXPEDITION_CONFIG = {
    // Run Settings
    baseFloors: 10,
    maxFloors: 10,
    baseBalls: 15,
    ticketPrice: 10,
    ticketResetHour: 0, // Midnight Paris time
    
    // Chain System
    chainShinyBonus: 0.5, // +0.5% per chain
    chainThresholds: {
        white: 0,
        green: 5,
        blue: 10,
        violet: 20,
        gold: 50
    },
    chainBreakOnFlee: true,
    chainBreakOnFail: true,
    
    // Shiny Rates
    baseShinyRate: 1/256,
    targetBonus: 0.05, // +5% for target
    pityBonus: 0.01, // +1% per run without shiny
    maxPityBonus: 0.20, // Max +20%
    
    // Spawn Rates (rogueRates)
    rogueRates: {
        common: 30,
        uncommon: 30,
        rare: 20,
        super_rare: 15,
        legendary: 5
    },
    targetSpawnChance: 0.08, // 8% before boss, 100% at boss
    
    // Rewards
    coinsPerCapture: {common:120,uncommon:200,rare:600,super_rare:1000,legendary:3500},
    xpPerCapture: {common:10,uncommon:20,rare:50,super_rare:100,legendary:200},
    buddyXpPerCapture: {common:1,uncommon:2,rare:3,super_rare:5,legendary:10},
    shinyTokenPerShiny: 5,
    shinyTokenPerTargetShiny: 20,
    shardRates: {common:0.3,rare:0.15,legendary:0.05},
    
    // Event Weights
    eventWeights: {
        encounter: 40,
        chest: 20,
        sanctuary: 10,
        merchant: 8,
        trap: 10,
        puzzle: 10,
        empty: 2
    },
    
    // Shop Prices (Shiny Tokens)
    shopPrices: {
        shinyCharmPermanent: 150,
        ballUpgrade1: 100,        // Niveau 1 : Pok√© Ball -> Super Ball
        ballUpgrade2: 250,        // Niveau 2 : Super Ball -> Hyper Ball
        extraFloor: 200,
        fastRecharge: 300,
        shinyRadar: 30,
        shinyLure: 25,
        runTicket: 50
    },
    
    // Buddy System
    buddyXpCurve: (level) => level * 100,
    buddyTalents: {
        3: {id:'hunter',name:'Chasseur',desc:'+10% taux de capture'},
        6: {id:'protector',name:'Protecteur',desc:'1x sauvegarde de chain'},
        10: {id:'shinyMagnet',name:'Aimant Shiny',desc:'+0.5% shiny par floor'},
        15: {id:'forager',name:'Fourrageur',desc:'+15% chance shard'},
        20: {id:'typeSynergy',name:'Synergie Type',desc:'x2 spawn target si m√™me type'}
    }
};

// ===== CONFIGURATION SYST√àME D'≈íUFS (V8.0) =====
const EGG_CONFIG = {
    tiers: {
        common: {
            id: 'egg_common',
            name: '≈íuf Commun',
            icon: 'ü•ö', 
            steps: 10,
            pool: 'common_uncommon',
            shinyRateMult: 1.0,
            color: '#4ade80',
            desc: 'Contient des Pok√©mon communs de votre r√©gion.'
        },
        rare: {
            id: 'egg_rare',
            name: '≈íuf Rare',
            icon: 'ü•ö', 
            steps: 25,
            pool: 'rare_starter',
            shinyRateMult: 2.0,
            color: '#3b82f6',
            desc: 'Contient des Pok√©mon rares ou Starters.'
        },
        epic: {
            id: 'egg_epic',
            name: '≈íuf √âpique',
            icon: 'ü•ö', 
            steps: 50,
            pool: 'super_rare_baby',
            shinyRateMult: 4.0,
            color: '#a855f7',
            desc: 'Contient des B√©b√©s Pok√©mon et Super Rares.'
        },
        legendary: {
            id: 'egg_legendary',
            name: '≈íuf L√©gendaire',
            icon: 'üåü', 
            steps: 100,
            pool: 'legendary_mythic',
            shinyRateMult: 10.0,
            color: '#fbbf24',
            desc: 'Contient des L√©gendaires ou Fabuleux.'
        }
    },
    exclusiveIds: [172, 173, 174, 175, 236, 238, 239, 240], // B√©b√©s Pok√©mon exclusifs aux ≈ìufs
    incubatorPrice: 500 // Shiny Tokens pour un slot suppl√©mentaire
};

// ===== CONFIGURATION GOLDEN POK√âMON & CATCHBOT =====
const GOLDEN_RATE = 1 / 2000; // Taux de base pour un Golden (tr√®s rare)

const CATCHBOT_CONFIG = {
    interval: 60 * 60 * 1000, // 1 capture toutes les heures
    shinyChance: 0.01, // 1% chance shiny (faible)
    storageLimit: 24 // Max 24h de stockage
};

// ===== GENESIS REBOOT - SYST√àME NARRATIF PORYGON-Z =====
// ===== ARCHITECTURE NARRATIVE AVANC√âE - MURMURES D'ENTROPIE =====

// Syst√®me de Murmures d'Entropie (Dialogues non bloquants)
const ENTROPY_WHISPERS = {
    // Murmures contextuels lors de captures
    capture_water: [
        "Log 0x44 : Les donn√©es de l'eau sont froides... cela ressemble √† l'ancien monde.",
        "Signal aquatique d√©tect√©. Les archives oc√©aniques sont encore accessibles.",
        "Cette signature... Le Professeur aimait nager dans ces donn√©es."
    ],
    capture_fire: [
        "Temp√©rature critique d√©tect√©e. Les donn√©es br√ªlent encore.",
        "Log 0x1F : Chaleur r√©siduelle du crash syst√®me.",
        "Cette √©nergie... Elle r√©chauffe mon noyau. Merci, Archiviste."
    ],
    capture_rare: [
        "Signal puissant ! Ces fragments sont rares... pr√©cieux.",
        "Donn√©es de haute int√©grit√©. Le syst√®me se stabilise.",
        "Archiviste... Ce Pok√©mon me rappelle quelque chose. Mais quoi ?"
    ],
    capture_shiny: [
        "EXCEPTIONNEL ! Code non corrompu ! MissingNo n'a pas pu l'atteindre !",
        "Cette puret√©... Elle restaure ma m√©moire fragment√©e.",
        "Log 0xFF : Variante chromatique = Donn√©es intactes. Sauvegardez-la."
    ],
    fishing_success: [
        "P√™che dans le Lac de Donn√©es... Les fichiers compress√©s remontent √† la surface.",
        "Le stockage profond contient encore des tr√©sors.",
        "Ces donn√©es humides... Elles me rafra√Æchissent."
    ],
    streak_high: [
        "Flux de donn√©es stable. Continuez, Archiviste. Le syst√®me vous remercie.",
        "Cha√Æne de succ√®s... L'entropie recule.",
        "Votre constance restaure l'ordre. Je... je me sens mieux."
    ],
    flee_streak: [
        "Signal perdu... Mais ne vous d√©couragez pas. Le syst√®me fluctue.",
        "Le moteur de probabilit√© est instable. Je recalibre...",
        "N'abandonnez pas, Archiviste. M√™me les √©checs enseignent."
    ],
    time_away: [
        "Dur√©e de veille syst√®me : {hours}h. J'ai eu peur que la connexion soit rompue.",
        "Vous √™tes revenu... Le syst√®me √©tait en attente.",
        "Signal restaur√©. Heureux de vous revoir, Archiviste."
    ],
    low_coins: [
        "Ressources critiques. Le syst√®me n√©cessite plus de cr√©dits.",
        "Les fonds s'√©puisent... Mais nous pers√©v√©rons.",
        "√âconomie instable. Capturez plus pour stabiliser."
    ],
    legendary_capture: [
        "SIGNAL L√âGENDAIRE ! Ces donn√©es sont les piliers du syst√®me.",
        "Archiviste... Ce Pok√©mon √©tait dans les m√©moires du Professeur.",
        "Int√©grit√© syst√®me : +5%. Merci."
    ]
};

// Fonction pour d√©clencher un murmure d'entropie (non bloquant)
function triggerAmbientNarrative(context, variables = {}) {
    const whispers = ENTROPY_WHISPERS[context];
    if (!whispers || whispers.length === 0) return;
    
    // Probabilit√© de d√©clenchement (1-5% selon le contexte)
    const chance = context.includes('legendary') || context.includes('shiny') ? 0.05 : 0.01;
    if (Math.random() > chance) return;
    
    // V√©rifier si on a d√©j√† montr√© ce murmure r√©cemment
    const lastWhisper = gameState.narrative?.lastAmbientWhisper || {};
    const timeSinceLastWhisper = Date.now() - (lastWhisper[context] || 0);
    if (timeSinceLastWhisper < 60000) return; // 1 minute entre les murmures du m√™me type
    
    const whisper = whispers[Math.floor(Math.random() * whispers.length)];
    let message = whisper;
    
    // Remplacer les variables
    Object.keys(variables).forEach(key => {
        message = message.replace(`{${key}}`, variables[key]);
    });
    
    // Afficher comme notification terminal (style terminal vert)
    showAmbientWhisper(message);
    
    // Enregistrer le dernier murmure
    if (!gameState || !gameState.narrative) {
        if (!gameState) return; // gameState n'est pas encore d√©fini
        gameState.narrative = {};
    }
    if (!gameState.narrative.lastAmbientWhisper) gameState.narrative.lastAmbientWhisper = {};
    gameState.narrative.lastAmbientWhisper[context] = Date.now();
}

// Fonction pour afficher un murmure d'entropie dans le System Log (non bloquant)
function showAmbientWhisper(message) {
    let systemLog = document.getElementById('system-log');
    
    // CR√âATION AUTOMATIQUE si le log n'existe pas (S√©curit√©)
    if (!systemLog) {
        systemLog = document.createElement('div');
        systemLog.id = 'system-log';
        systemLog.className = 'system-log'; // Utilise le style d√©fini dans style.css
        document.body.appendChild(systemLog);
    }
    
    const entry = document.createElement('div');
    entry.className = 'system-log-entry';
    entry.textContent = `> ${message}`;
    
    // Ajout en bas (les nouveaux messages apparaissent en bas)
    systemLog.appendChild(entry);
    
    // Nettoyage automatique : on garde max 5 messages pour ne pas surcharger l'√©cran
    if (systemLog.children.length > 5) {
        systemLog.removeChild(systemLog.firstChild);
    }
    
    // Disparition automatique apr√®s 5 secondes
    setTimeout(() => {
        if (entry.parentNode) {
            entry.style.opacity = '0';
            entry.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                if (entry.parentNode) {
                    entry.remove();
                }
            }, 500); // Attendre la fin du fade out
        }
    }, 5000);
}

// Base de donn√©es des dialogues Porygon
const PORYGON_DIALOGUES = {
    // S√©quence de Boot (Intro)
    'intro_boot_sequence': {
        id: 'intro_boot_sequence',
        mood: 'PANIC',
        lines: [
            'SYSTEM FAILURE... CRITICAL ERROR... KANTO_DB CORRUPTED...',
            '... Il y a quelqu\'un ? Archiviste ? C\'est vous ?',
            'Tout a disparu... Le monde... effac√©. Je ne suis que des fragments de code bris√©s.',
            'Aidez-moi. Capturez le premier signal. N\'importe quoi. Vite.'
        ],
        action: () => {
            // Force le spawn des 3 starters
            if (gameState.captured.size === 0) {
                // Les starters seront disponibles imm√©diatement
            }
        },
        visual: 'glitch'
    },
    
    'first_capture_success': {
        id: 'first_capture_success',
        mood: 'NEUTRAL',
        lines: [
            'Signal acquis ! Int√©grit√© syst√®me √† 1%. Merci... Je... je commence √† me souvenir.',
            'Nous devons tout reconstruire. Chaque Pok√©mon captur√© restaure un morceau de ma m√©moire.',
            'Continue, Archiviste !'
        ],
        visual: 'stabilize'
    },
    
    'rival_missing': {
        id: 'rival_missing',
        mood: 'NEUTRAL',
        lines: [
            'Rival_Data_Not_Found.',
            'Vous √™tes seul sur cette instance. Pour l\'instant.'
        ],
        visual: 'glitch'
    },
    
    'rival_search_failed': {
        id: 'rival_search_failed',
        mood: 'NEUTRAL',
        lines: [
            'J\'ai tent√© de restaurer les donn√©es du "Rival"...',
            'Recherche dans les archives corrompues...',
            'ERR_FILE_NOT_FOUND.',
            'Le fichier Rival a √©t√© effac√© par MissingNo.',
            'Vous √™tes seul face au N√©ant. Pour l\'instant.'
        ],
        visual: 'glitch'
    },
    
    'unlock_buddy_system': {
        id: 'unlock_buddy_system',
        mood: 'NEUTRAL',
        lines: [
            'J\'ai d√©velopp√© un protocole de "Synchronisation de Fr√©quence".',
            'En liant un Pok√©mon √† votre signal, vous stabilisez votre connexion.',
            'Le Buddy partage ses donn√©es avec vous, renfor√ßant votre int√©grit√© syst√®me.',
            'Acc√®s au [BUDDY] autoris√©. Choisissez votre compagnon.'
        ],
        visual: 'unlock'
    },
    
    'golden_pokemon_discovered': {
        id: 'golden_pokemon_discovered',
        mood: 'HAPPY',
        lines: [
            '...',
            'ATTENDEZ.',
            'Ce signal... Cette puret√©...',
            'C\'EST UN CODE GOLDEN !',
            'Un fragment de code dans son √©tat le plus pur !',
            'MissingNo n\'a pas pu le corrompre...',
            'C\'est... C\'est magnifique. Merci, Archiviste.'
        ],
        visual: 'celebration'
    },
    
    'leaderboard_explained': {
        id: 'leaderboard_explained',
        mood: 'NEUTRAL',
        lines: [
            'J\'ai capt√© des signaux √©tranges...',
            'D\'autres Archivistes. Dans des r√©alit√©s parall√®les.',
            'Ils luttent aussi contre le N√©ant.',
            'Le [LEADERBOARD] affiche leurs progr√®s.',
            'Vous n\'√™tes pas seul dans cette guerre.'
        ],
        visual: 'progress'
    },
    
    'early_progress_2': {
        id: 'early_progress_2',
        mood: 'NEUTRAL',
        lines: [
            'Int√©grit√© syst√®me √† 2%. Les donn√©es s\'accumulent...',
            'Capturez encore quelques Pok√©mon pour stabiliser le syst√®me.'
        ],
        visual: 'progress'
    },
    
    'early_progress_3': {
        id: 'early_progress_3',
        mood: 'NEUTRAL',
        lines: [
            'Int√©grit√© syst√®me √† 3%. Progression constante.',
            'Encore quelques captures et je pourrai activer de nouveaux modules.'
        ],
        visual: 'progress'
    },
    
    'early_progress_4': {
        id: 'early_progress_4',
        mood: 'NEUTRAL',
        lines: [
            'Int√©grit√© syst√®me √† 4%. Presque l√†...',
            'Capturez encore 1 Pok√©mon pour d√©bloquer le module de P√™che !'
        ],
        visual: 'progress'
    },
    
    'energy_warning_early': {
        id: 'energy_warning_early',
        mood: 'PANIC',
        lines: [
            'Mes batteries faiblissent...',
            'Il faudra bient√¥t trouver une source d\'√©nergie autonome.',
            'Les Pok√©mon captur√©s pourraient servir de g√©n√©rateurs...'
        ],
        visual: 'critical'
    },
    
    // D√©blocage des Modules
    'unlock_fishing_module': {
        id: 'unlock_fishing_module',
        mood: 'NEUTRAL',
        lines: [
            'Tiens ? Je capte des signaux sous la surface liquide.',
            'J\'ai compil√© un module [CANNE_A_PECHE.exe]. Essayez d\'extraire ces donn√©es humides.'
        ],
        visual: 'unlock'
    },
    
    'unlock_research_core': {
        id: 'unlock_research_core',
        mood: 'PANIC',
        lines: [
            'Alerte √ânergie. Maintenir la capture consomme trop de ressources. Je vais m\'√©teindre...',
            'Id√©e : Les Pok√©mon √©mettent de l\'√ânergie Onirique (EO). Si on les connecte au Noyau...',
            'Acc√®s au [LABO] autoris√©. Branchez-les, vite !'
        ],
        visual: 'critical'
    },
    
    'unlock_quests_module': {
        id: 'unlock_quests_module',
        mood: 'NEUTRAL',
        lines: [
            'Analyse des donn√©es... Le syst√®me de r√©compenses est en ligne.',
            'J\'ai r√©ussi √† restaurer le journal des qu√™tes.',
            'Accomplissez ces t√¢ches pour m\'aider √† r√©parer le code plus vite.'
        ],
        visual: 'unlock'
    },
    
    'unlock_blindbox': {
        id: 'unlock_blindbox',
        mood: 'NEUTRAL',
        lines: [
            'J\'ai retrouv√© des paquets de donn√©es perdus dans la m√©moire.',
            'Ils contiennent des fragments de Pok√©mon... Mais lesquels ?',
            'Acc√®s au [BLIND BOX] autoris√©. Ouvrez-les avec pr√©caution.'
        ],
        visual: 'unlock'
    },
    
    'unlock_decryption': {
        id: 'unlock_decryption',
        mood: 'NEUTRAL',
        lines: [
            'Ces fichiers sont crypt√©s. Mon processeur ne suffit pas.',
            'J\'ai trouv√© un vieux protocole de jeu humain... Le Poker ? Les motifs math√©matiques pourraient briser le cryptage.',
            'Jouons. Pour la science.'
        ],
        visual: 'unlock'
    },
    
    'unlock_deepnet': {
        id: 'unlock_deepnet',
        mood: 'NEUTRAL',
        lines: [
            'J\'ai d√©tect√© un r√©seau profond... Des donn√©es corrompues mais exploitables.',
            'Acc√®s au [DEEPNET] autoris√©. Attention : Zone instable.'
        ],
        visual: 'unlock'
    },
    
    'unlock_archives': {
        id: 'unlock_archives',
        mood: 'HAPPY',
        lines: [
            'Les archives... Elles sont intactes !',
            'J\'ai restaur√© l\'acc√®s aux [ARCHIVES TCG]. Des cartes de donn√©es anciennes vous attendent.'
        ],
        visual: 'unlock'
    },
    
    // Progression & Blocages
    'first_data_restored': {
        id: 'first_data_restored',
        mood: 'NEUTRAL',
        lines: [
            'Premier fragment restaur√©. L\'int√©grit√© du syst√®me augmente...'
        ],
        visual: 'progress'
    },
    
    'system_stabilizing': {
        id: 'system_stabilizing',
        mood: 'NEUTRAL',
        lines: [
            'Syst√®me stabilis√© ! Les 5 fragments ont restaur√© ma m√©moire de base.',
            'Je peux maintenant fonctionner normalement. Le glitch a disparu.',
            'Continue √† capturer des Pok√©mon pour gagner de l\'XP et monter de niveau.',
            'Au niveau 2, tu d√©bloqueras la P√™che !'
        ],
        visual: 'progress'
    },
    
    'memory_returning': {
        id: 'memory_returning',
        mood: 'HAPPY',
        lines: [
            '100 fragments... Ma m√©moire revient. Je me souviens... de Kanto.'
        ],
        visual: 'progress'
    },
    
    'missing_link': {
        id: 'missing_link',
        mood: 'HAPPY',
        lines: [
            '99%... Je le sens ! Le dernier fragment !',
            'Ne l√¢chez rien Archiviste. On y est presque.'
        ],
        visual: 'progress'
    },
    
    'gate_johto_locked': {
        id: 'gate_johto_locked',
        mood: 'NEUTRAL',
        lines: [
            '‚õî ERREUR : Carte incompl√®te.',
            'Je ne peux pas calculer la route vers Johto tant que la matrice Kanto n\'est pas stable √† 100%.',
            'Il manque encore des entr√©es. Cherchez dans les [Blind Boxes] si le radar est muet.'
        ],
        visual: 'error'
    },
    
    'system_reboot_johto': {
        id: 'system_reboot_johto',
        mood: 'PROUD',
        lines: [
            'SYST√àME KANTO : RESTAUR√â. Mise √† jour v2.0 install√©e.',
            'Ma m√©moire... Je me souviens du Mont S√©l√©nite... et d\'une autre r√©gion √† l\'Ouest.',
            'Initialisation du protocole JOHTO. Attention : Nouveaux types de donn√©es d√©tect√©s. Soyez prudent.'
        ],
        visual: 'reboot'
    },
    
    'system_reboot_hoenn': {
        id: 'system_reboot_hoenn',
        mood: 'PROUD',
        lines: [
            'SYST√àME JOHTO : RESTAUR√â. Mise √† jour v3.0 install√©e.',
            'Les donn√©es de Johto sont compl√®tes. Je d√©tecte une autre r√©gion au Sud...',
            'Initialisation du protocole HOENN. Les archives sont plus profondes ici. Pr√©parez-vous.'
        ],
        visual: 'reboot'
    },
    
    'integrity_critical': {
        id: 'integrity_critical',
        mood: 'HAPPY',
        lines: [
            'Int√©grit√© critique atteinte ! Le syst√®me est presque restaur√© !'
        ],
        visual: 'progress'
    },
    
    // Blind Box Intelligente
    'blindbox_completion_help': {
        id: 'blindbox_completion_help',
        mood: 'HAPPY',
        lines: [
            'Analyse secteur profond...',
            'Fichier manquant localis√© !',
            'Restauration imm√©diate !'
        ],
        visual: 'unlock'
    },
    
    // Labo - Surchauffe
    'lab_overload': {
        id: 'lab_overload',
        mood: 'PANIC',
        lines: [
            'Surchauffe ! Surchauffe !',
            'Ajoutez des dissipateurs thermiques ou agrandissez la m√©moire !'
        ],
        visual: 'error'
    },
    
    // Labo - Blueprint trouv√©
    'blueprint_found': {
        id: 'blueprint_found',
        mood: 'HAPPY',
        lines: [
            'Analyse... Sch√©ma d\'extension valide !',
            'Je peux compiler une nouvelle zone d\'habitat.',
            'Utilisez-le au [LABO] pour d√©bloquer de nouveaux emplacements.'
        ],
        visual: 'unlock'
    },
    
    // ===== GUIDES CONTEXTUELS & TUTORIELS =====
    
    // Guide : Premi√®re capture r√©ussie
    'guide_first_capture': {
        id: 'guide_first_capture',
        mood: 'NEUTRAL',
        lines: [
            'Excellent ! Premier signal captur√©.',
            'Astuce : Utilisez des Baies Framby pour augmenter vos chances.',
            'Les Baies Pinap doublent les Coins gagn√©s. Utile pour acheter plus de Balls.'
        ],
        visual: 'progress'
    },
    
    // Guide : Manque de Balls
    'guide_no_balls': {
        id: 'guide_no_balls',
        mood: 'NEUTRAL',
        lines: [
            'Alerte : Stock de Balls √©puis√©.',
            'Achetez-en au [BOUTIQUE] avec vos Coins.',
            'Ou attendez les r√©compenses de qu√™tes quotidiennes.'
        ],
        visual: 'error'
    },
    
    // Guide : Premi√®re visite au Labo
    'guide_labo_first_visit': {
        id: 'guide_labo_first_visit',
        mood: 'NEUTRAL',
        lines: [
            'Bienvenue au [CENTRE DE RECHERCHE].',
            'Placez vos Pok√©mon captur√©s ici pour g√©n√©rer de l\'√ânergie Onirique (EO).',
            'Plus vous avez de Pok√©mon, plus l\'EO g√©n√©r√©e est importante.',
            'L\'EO peut √™tre convertie en Baies au [TERMINAL] > [PRODUCTION].'
        ],
        visual: 'unlock'
    },
    
    // Guide : Synergies au Labo
    'guide_labo_synergies': {
        id: 'guide_labo_synergies',
        mood: 'HAPPY',
        lines: [
            'D√©couverte : Les Pok√©mon plac√©s c√¥te √† c√¥te cr√©ent des synergies !',
            'Feu + Plante = Bonus de production instantan√©.',
            '√âlectrik + Eau = Boost de toute la ligne.',
            'Exp√©rimentez les placements pour optimiser votre production.'
        ],
        visual: 'progress'
    },
    
    // Guide : Premi√®re Blind Box
    'guide_blindbox_first': {
        id: 'guide_blindbox_first',
        mood: 'NEUTRAL',
        lines: [
            'Les [BLIND BOXES] contiennent des Pok√©mon al√©atoires.',
            'Utile pour compl√©ter votre Pok√©dex si le radar ne trouve plus rien.',
            'Astuce : Apr√®s plusieurs √©checs, le syst√®me garantit un Pok√©mon manquant.'
        ],
        visual: 'unlock'
    },
    
    // Guide : Premi√®re P√™che
    'guide_fishing_first': {
        id: 'guide_fishing_first',
        mood: 'NEUTRAL',
        lines: [
            'Module [P√äCHE] activ√©.',
            'Les Pok√©mon aquatiques sont plus fr√©quents ici.',
            'Utilisez vos Jetons de P√™che avec parcimonie.',
            'Ils se r√©g√©n√®rent lentement ou peuvent √™tre achet√©s.'
        ],
        visual: 'unlock'
    },
    
    // Guide : Premi√®re Exp√©dition
    'guide_expedition_first': {
        id: 'guide_expedition_first',
        mood: 'NEUTRAL',
        lines: [
            'Acc√®s au [DEEPNET] autoris√©.',
            'Les Exp√©ditions sont dangereuses mais r√©compensent bien.',
            'Vous y trouverez des Blueprints pour √©tendre le Labo.',
            'Et des ressources rares comme les Puces Processeur.'
        ],
        visual: 'unlock'
    },
    
    // Guide : Premi√®re partie de Poker
    'guide_poker_first': {
        id: 'guide_poker_first',
        mood: 'NEUTRAL',
        lines: [
            'Module [D√âCHIFFREMENT] activ√©.',
            'Le Pok√©-Poker utilise des combinaisons de cartes.',
            'Gagnez des Puces Processeur pour acheter des Overclocks.',
            'Astuce : Utilisez l\'EO pour "tricher" et voir les cartes cach√©es.'
        ],
        visual: 'unlock'
    },
    
    // Guide : Qu√™tes
    'guide_quests': {
        id: 'guide_quests',
        mood: 'NEUTRAL',
        lines: [
            'Les Qu√™tes offrent des r√©compenses r√©guli√®res.',
            'V√©rifiez-les r√©guli√®rement dans le [HUB] > [QU√äTES].',
            'Les qu√™tes quotidiennes se r√©initialisent chaque jour.',
            'Les qu√™tes permanentes progressent sur toute votre aventure.'
        ],
        visual: 'progress'
    },
    
    // Guide : √âvolution
    'guide_evolution': {
        id: 'guide_evolution',
        mood: 'NEUTRAL',
        lines: [
            'Certains Pok√©mon peuvent √©voluer avec des Pierres.',
            'Achetez-les √† la [BOUTIQUE] ou trouvez-les en Exp√©dition.',
            'Les √©volutions am√©liorent souvent la production d\'EO au Labo.'
        ],
        visual: 'progress'
    },
    
    // Guide : Shinies
    'guide_shinies': {
        id: 'guide_shinies',
        mood: 'HAPPY',
        lines: [
            'D√©tection : Variante chromatique rare d√©tect√©e !',
            'Les Pok√©mon Shiny sont tr√®s rares mais valent plus de Coins.',
            'Ils produisent aussi plus d\'EO au Labo.',
            'Utilisez la Baie Ceriz pour garantir un Shiny (si disponible).'
        ],
        visual: 'unlock'
    },
    
    // Guide : Niveau faible
    'guide_low_level': {
        id: 'guide_low_level',
        mood: 'NEUTRAL',
        lines: [
            'Votre niveau est encore bas. Pas de panique.',
            'Capturez des Pok√©mon pour gagner de l\'XP.',
            'Chaque niveau d√©bloque de nouvelles fonctionnalit√©s.',
            'Continuez √† capturer, le syst√®me se stabilisera progressivement.'
        ],
        visual: 'progress'
    },
    
    // Guide : Manque de Coins
    'guide_no_coins': {
        id: 'guide_no_coins',
        mood: 'NEUTRAL',
        lines: [
            'Ressources insuffisantes d√©tect√©es.',
            'Capturez des Pok√©mon pour gagner des Coins.',
            'Les doublons rapportent aussi des Coins.',
            'Utilisez la Baie Pinap pour doubler les gains.'
        ],
        visual: 'error'
    },
    
    // Guide : Streak
    'guide_streak': {
        id: 'guide_streak',
        mood: 'HAPPY',
        lines: [
            'S√©rie de captures r√©ussies !',
            'Les Streaks augmentent vos gains d\'XP.',
            'Attention : Si un Pok√©mon s\'enfuit, la s√©rie se r√©initialise.',
            'Maintenez votre Streak pour progresser plus vite.'
        ],
        visual: 'progress'
    },
    
    // Guide : TCG
    'guide_tcg_first': {
        id: 'guide_tcg_first',
        mood: 'HAPPY',
        lines: [
            'Les [ARCHIVES TCG] sont restaur√©es !',
            'Les cartes dans votre Deck Actif donnent des bonus passifs.',
            'Construisez un Deck de 5 cartes pour optimiser votre production.',
            'Ouvrez des Boosters pour trouver de meilleures cartes.'
        ],
        visual: 'unlock'
    },
    
    // Guide : Progression lente
    'guide_slow_progress': {
        id: 'guide_slow_progress',
        mood: 'NEUTRAL',
        lines: [
            'Progression ralentie d√©tect√©e.',
            'Astuce : Utilisez le [LABO] pour g√©n√©rer de l\'EO passivement.',
            'Les Blind Boxes peuvent aider √† compl√©ter le Pok√©dex.',
            'Les Exp√©ditions offrent des ressources rares.'
        ],
        visual: 'progress'
    },
    
    // Guide : Premier Shiny
    'guide_first_shiny': {
        id: 'guide_first_shiny',
        mood: 'HAPPY',
        lines: [
            'EXCEPTIONNEL ! Variante chromatique captur√©e !',
            'Les Shiny sont extr√™mement rares (1/4096).',
            'Ils valent beaucoup plus de Coins et d\'XP.',
            'F√©licitations, Archiviste !'
        ],
        visual: 'unlock'
    },
    
    // Guide : Premier L√©gendaire
    'guide_first_legendary': {
        id: 'guide_first_legendary',
        mood: 'PROUD',
        lines: [
            'SIGNAL L√âGENDAIRE D√âTECT√â !',
            'Ces Pok√©mon sont les plus rares et puissants.',
            'Ils produisent √©norm√©ment d\'EO au Labo.',
            'Gardez-les pr√©cieusement, Archiviste.'
        ],
        visual: 'reboot'
    },
    
    // Guide : Johto verrouill√©
    'guide_johto_locked': {
        id: 'guide_johto_locked',
        mood: 'NEUTRAL',
        lines: [
            'La passerelle vers Johto est verrouill√©e.',
            'Compl√©tez le Pok√©dex Kanto √† 100% (151/151) pour d√©bloquer Johto.',
            'Utilisez les Blind Boxes si certains Pok√©mon sont introuvables.',
            'Le syst√®me vous aidera automatiquement quand vous serez proche.'
        ],
        visual: 'error'
    },
    
    // Guide : Hoenn verrouill√©
    'guide_hoenn_locked': {
        id: 'guide_hoenn_locked',
        mood: 'NEUTRAL',
        lines: [
            'La passerelle vers Hoenn est verrouill√©e.',
            'Compl√©tez le Pok√©dex Johto √† 100% (100/100) pour d√©bloquer Hoenn.',
            'Continuez √† explorer et capturer, Archiviste.'
        ],
        visual: 'error'
    },
    
    // Guide : Production EO
    'guide_eo_production': {
        id: 'guide_eo_production',
        mood: 'NEUTRAL',
        lines: [
            'L\'√ânergie Onirique (EO) est g√©n√©r√©e automatiquement au Labo.',
            'Plus vous avez de Pok√©mon plac√©s, plus la production est √©lev√©e.',
            'Les synergies entre Pok√©mon augmentent encore la production.',
            'Utilisez l\'EO pour acheter des Upgrades ou produire des Baies.'
        ],
        visual: 'progress'
    },
    
    // Guide : Baies
    'guide_berries': {
        id: 'guide_berries',
        mood: 'NEUTRAL',
        lines: [
            'Les Baies sont des consommables puissants.',
            'Framby : +50% chance de capture.',
            'Pinap : √ó2 Coins gagn√©s.',
            'Ceriz : 100% Shiny (si le Pok√©mon peut √™tre Shiny).',
            'Produisez-les au Labo ou achetez-les √† la Boutique.'
        ],
        visual: 'progress'
    },
    
    // Guide : Blueprints
    'guide_blueprints': {
        id: 'guide_blueprints',
        mood: 'HAPPY',
        lines: [
            'Blueprints trouv√©s !',
            'Ces sch√©mas permettent de d√©bloquer de nouveaux emplacements au Labo.',
            'Trouvez-les dans les Exp√©ditions (coffres Or/Diamant).',
            'Tous les 5 runs d\'Exp√©dition, un Blueprint est garanti.'
        ],
        visual: 'unlock'
    },
    
    // Guide : Premier niveau
    'guide_level_up': {
        id: 'guide_level_up',
        mood: 'HAPPY',
        lines: [
            'Niveau augment√© !',
            'Chaque niveau d√©bloque de nouvelles fonctionnalit√©s.',
            'Consultez les r√©compenses dans la popup de Level Up.',
            'Continuez √† progresser, Archiviste !'
        ],
        visual: 'progress'
    },
    
    // Guide : Inventaire plein
    'guide_inventory_full': {
        id: 'guide_inventory_full',
        mood: 'NEUTRAL',
        lines: [
            'Alerte : Inventaire satur√©.',
            'Utilisez ou vendez vos objets pour faire de la place.',
            'Les Baies peuvent √™tre utilis√©es pendant les captures.',
            'Les Pierres d\'√âvolution servent √† faire √©voluer vos Pok√©mon.'
        ],
        visual: 'error'
    },
    
    // Guide : Premier doublon
    'guide_duplicate': {
        id: 'guide_duplicate',
        mood: 'NEUTRAL',
        lines: [
            'Doublon captur√©.',
            'Les doublons rapportent quand m√™me des Coins et de l\'XP.',
            'Ils sont utiles pour maintenir votre Streak.',
            'Au Labo, plusieurs exemplaires du m√™me Pok√©mon augmentent la production.'
        ],
        visual: 'progress'
    },
    
    // Labo - Blueprint trouv√©
    'blueprint_found': {
        id: 'blueprint_found',
        mood: 'HAPPY',
        lines: [
            'Analyse... Sch√©ma d\'extension valide !',
            'Je peux compiler une nouvelle zone d\'habitat.'
        ],
        visual: 'unlock'
    },
    
    // ===== ARCHITECTURE NARRATIVE AVANC√âE - NOUVEAUX ARCS =====
    
    // Arc du Fant√¥me du Rival (Niveaux 6-9)
    'rival_signal_detected': {
        id: 'rival_signal_detected',
        mood: 'NEUTRAL',
        lines: [
            'Attendez... Un second signal ?',
            'C\'est faible. Tr√®s faible.',
            'Est-ce... Est-ce un autre Archiviste ?',
            'Ou... Le Rival ?'
        ],
        visual: 'glitch'
    },
    
    'rival_corrupted_ball_found': {
        id: 'rival_corrupted_ball_found',
        mood: 'NEUTRAL',
        lines: [
            'Cette Pok√©ball... Elle est corrompue.',
            'Elle contient des fragments de donn√©es d\'un Starter.',
            'Mais ce n\'est pas celui que vous avez choisi.',
            'Ceci appartenait √† l\'autre... Celui qui est parti avant le crash.'
        ],
        visual: 'glitch'
    },
    
    'rival_signal_decrypted': {
        id: 'rival_signal_decrypted',
        mood: 'NEUTRAL',
        lines: [
            'J\'ai d√©crypt√© le signal.',
            'C\'est un √©cho. Un fant√¥me dans la machine.',
            'Le Rival n\'a pas surv√©cu √† l\'effacement de MissingNo.',
            'Il n\'est plus qu\'une trace de donn√©es perdues.'
        ],
        visual: 'glitch'
    },
    
    'rival_ghost_battle': {
        id: 'rival_ghost_battle',
        mood: 'NEUTRAL',
        lines: [
            'Le fant√¥me du Rival appara√Æt devant vous.',
            'Il d√©fie votre Starter avec le sien.',
            'C\'est un combat pour la m√©moire.',
            'Gagnez pour r√©cup√©rer ses donn√©es perdues.'
        ],
        visual: 'glitch'
    },
    
    'rival_badge_earned': {
        id: 'rival_badge_earned',
        mood: 'HAPPY',
        lines: [
            'Les donn√©es du Rival sont restaur√©es.',
            'Il rejoint votre Pok√©dex comme un souvenir.',
            'Badge du Rival obtenu : +5% XP permanent.',
            'Le monde est plus solitaire qu\'on ne le pensait.'
        ],
        visual: 'progress'
    },
    
    // Arc de Pr√©paration au Deepnet (Niveaux 13-14)
    'deepnet_encryption_thickening': {
        id: 'deepnet_encryption_thickening',
        mood: 'NEUTRAL',
        lines: [
            'Le cryptage du Deepnet s\'√©paissit.',
            'Il r√©agit √† votre pr√©sence.',
            'Les Exp√©ditions deviennent plus difficiles, mais les Data Shards tombent plus souvent.',
            'Le syst√®me se pr√©pare √† quelque chose.'
        ],
        visual: 'progress'
    },
    
    'deepnet_firewall': {
        id: 'deepnet_firewall',
        mood: 'NEUTRAL',
        lines: [
            'Un pare-feu bloque votre progression.',
            'S√©curisez 3 Exp√©ditions pour d√©bloquer le niveau 15.',
            'Le syst√®me teste votre pr√©paration.',
            'Johto vous attend, mais √™tes-vous pr√™t ?'
        ],
        visual: 'error'
    },
    
    // Arc de la Fuite de M√©moire (Niveaux 21-24)
    'porygon_memory_loss_1': {
        id: 'porygon_memory_loss_1',
        mood: 'NEUTRAL',
        lines: [
            'Archiviste... Quel √©tait le nom du gar√ßon au chapeau rouge ?',
            'Red ? Ash ?',
            'Donn√©es... introuvables.',
            'Je commence √† oublier.'
        ],
        visual: 'glitch'
    },
    
    'porygon_memory_loss_2': {
        id: 'porygon_memory_loss_2',
        mood: 'NEUTRAL',
        lines: [
            'Des glitchs apparaissent dans mon interface.',
            'Mon tampon m√©moire sature.',
            'Les donn√©es de Johto... elles sont lourdes.',
            'Je dois me stabiliser.'
        ],
        visual: 'glitch'
    },
    
    'porygon_defrag_needed': {
        id: 'porygon_defrag_needed',
        mood: 'PANIC',
        lines: [
            'Archiviste, j\'ai besoin d\'aide.',
            'Mon noyau se fragmente.',
            'Utilisez l\'√ânergie Onirique au Labo pour me d√©fragmenter.',
            'Sinon... je risque de perdre plus de m√©moire.'
        ],
        visual: 'critical'
    },
    
    'porygon_defrag_success': {
        id: 'porygon_defrag_success',
        mood: 'HAPPY',
        lines: [
            'Merci, Archiviste.',
            'Je me sens mieux. Plus stable.',
            'Votre aide me permet de continuer.',
            'Ensemble, nous sauverons ce monde.'
        ],
        visual: 'progress'
    },
    
    // R√©actions dynamiques au RNG
    'reaction_flee_streak': {
        id: 'reaction_flee_streak',
        mood: 'NEUTRAL',
        lines: [
            'N\'abandonnez pas, Archiviste.',
            'Le moteur de probabilit√© fluctue.',
            'Je recalibre les param√®tres de capture.',
            'La prochaine fois sera meilleure.'
        ],
        visual: 'progress'
    },
    
    'reaction_time_away': {
        id: 'reaction_time_away',
        mood: 'HAPPY',
        lines: [
            'Vous √™tes revenu !',
            'J\'ai eu peur que la connexion soit d√©finitivement rompue.',
            'Le syst√®me √©tait en attente.',
            'Heureux de vous revoir, Archiviste.'
        ],
        visual: 'progress'
    },
    
    'reaction_specific_pokemon': {
        id: 'reaction_specific_pokemon',
        mood: 'HAPPY',
        lines: [
            'Cette signature √©lectrique...',
            'Le Professeur l\'aimait beaucoup.',
            'Pourquoi cette donn√©e me rend-elle triste ?',
            'Les souvenirs reviennent, fragment par fragment.'
        ],
        visual: 'progress'
    }
};

// ===== SYST√àME D'OMBRE DE GLITCH (MissingNo) =====
// Fonction pour d√©clencher une ombre de glitch (apparition rare de MissingNo)
function triggerGlitchShadow() {
    // Probabilit√© : 1-5% selon le contexte
    const chance = (gameState.streak >= 20 || getRarity(currentPokemon?.id) === 'legendary') ? 0.05 : 0.01;
    if (Math.random() > chance) return;
    
    // V√©rifier si on a d√©j√† montr√© une ombre r√©cemment
    const lastShadow = gameState.system?.lastGlitchShadow || 0;
    const timeSinceLastShadow = Date.now() - lastShadow;
    if (timeSinceLastShadow < 300000) return; // 5 minutes entre les ombres
    
    // Cr√©er l'ombre de glitch
    const shadow = document.createElement('div');
    shadow.className = 'glitch-shadow';
    document.body.appendChild(shadow);
    
    // Effet de distorsion sur l'UI
    document.body.style.filter = 'hue-rotate(90deg)';
    setTimeout(() => {
        document.body.style.filter = '';
    }, 2000);
    
    // Message Porygon r√©actif
    setTimeout(() => {
        showPorygonMessage([
            'Avez-vous vu √ßa ?',
            'Il nous observe.',
            'Restez pr√®s du pare-feu, Archiviste.'
        ], 'panic');
    }, 500);
    
    // Enregistrer le dernier d√©clenchement
    if (!gameState.system) gameState.system = {};
    gameState.system.lastGlitchShadow = Date.now();
    saveGame();
}

// ===== SYST√àME OVERRIDE (Surcharge Syst√®me) =====
// Fonction pour d√©clencher un √©v√©nement System Override (pour d√©blocages majeurs)
window.triggerSystemOverride = function(eventType, callback) {
    // Blackout audio-visuel
    const blackout = document.createElement('div');
    blackout.className = 'system-override-blackout';
    blackout.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 99998;
        animation: fadeIn 0.3s ease;
    `;
    document.body.appendChild(blackout);
    
    // Couche Terminal (effet CRT)
    const terminalLayer = document.createElement('div');
    terminalLayer.className = 'matrix-overlay';
    document.body.appendChild(terminalLayer);
    
    // Activer l'animation de surcharge
    document.body.classList.add('system-override-active');
    
    // Arr√™ter la musique si elle existe
    const audioElements = document.querySelectorAll('audio');
    audioElements.forEach(audio => {
        if (!audio.paused) {
            audio.pause();
        }
    });
    
    // Ex√©cuter le callback apr√®s un court d√©lai
    setTimeout(() => {
        if (callback && typeof callback === 'function') {
            callback();
        }
    }, 500);
    
    // Nettoyer apr√®s 3 secondes
    setTimeout(() => {
        document.body.classList.remove('system-override-active');
        terminalLayer.style.animation = 'fadeOut 0.5s ease';
        blackout.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => {
            terminalLayer.remove();
            blackout.remove();
        }, 500);
    }, 3000);
};

// Fonction pour d√©clencher un dialogue narratif
function triggerNarrative(dialogueId, force = false) {
    if (!PORYGON_DIALOGUES[dialogueId]) {
        console.warn(`Dialogue non trouv√©: ${dialogueId}`);
        return;
    }
    
    // ===== FIX : Initialisation s√©curis√©e de gameState.narrative =====
    if (!gameState) {
        console.error('[triggerNarrative] gameState n\'est pas d√©fini');
        return;
    }
    if (!gameState.narrative) gameState.narrative = {};
    if (!gameState.narrative.queue) gameState.narrative.queue = [];
    if (gameState.narrative.isShowing === undefined) gameState.narrative.isShowing = false;
    
    // V√©rifier si d√©j√† jou√© (sauf si forc√©)
    if (!force && gameState.system && gameState.system.narrativeFlags && gameState.system.narrativeFlags.includes(dialogueId)) {
        return;
    }
    
    const dialogue = PORYGON_DIALOGUES[dialogueId];
    
    // Mettre √† jour le mood de Porygon
    if (dialogue.mood && gameState.system) {
        if (!gameState.system) gameState.system = {};
        gameState.system.porygonMood = dialogue.mood;
    }
    
    // Ajouter au flags
    if (gameState.system) {
        if (!gameState.system.narrativeFlags) gameState.system.narrativeFlags = [];
        if (!gameState.system.narrativeFlags.includes(dialogueId)) {
            gameState.system.narrativeFlags.push(dialogueId);
        }
    }
    
    // Ex√©cuter l'action si pr√©sente
    if (dialogue.action && typeof dialogue.action === 'function') {
        dialogue.action();
    }
    
    // ===== FIX : Ajouter √† la file d'attente si une modale est d√©j√† ouverte =====
    if (gameState.narrative.isShowing) {
        gameState.narrative.queue.push({ lines: dialogue.lines, visual: dialogue.visual });
        console.log(`[Narrative] Dialogue ${dialogueId} ajout√© √† la file d'attente`);
        return;
    }
    
    // Afficher le dialogue via le widget Porygon
    showPorygonMessage(dialogue.lines, dialogue.visual);
    
    if (typeof saveGame === 'function') saveGame();
}

// POLISHING : Fonction pour afficher un message Porygon avec Porygon-Z flottant qui parle phrase par phrase
function showPorygonMessage(lines, visualType = 'normal') {
    console.log('[Porygon] showPorygonMessage appel√©e avec', lines, visualType);
    if (!Array.isArray(lines)) lines = [lines];
    
    // Fermer toute modale Porygon existante
    const existingModal = document.getElementById('porygon-modal');
    if (existingModal) existingModal.remove();
    
    // Cr√©er un overlay transparent (pas de fond noir opaque)
    const modal = document.createElement('div');
    modal.id = 'porygon-modal';
    modal.className = 'modal active';
    modal.style.cssText = `
        display: flex !important;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        z-index: 100000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
        pointer-events: all;
    `;
    
    // Conteneur principal centr√© pour Porygon-Z et la bulle
    const container = document.createElement('div');
    container.style.cssText = `
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        max-width: 600px;
        width: 100%;
    `;
    
    // Porygon-Z flottant au milieu de l'√©cran
    const porygonSprite = document.createElement('img');
    porygonSprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/474.gif`;
    porygonSprite.alt = 'Porygon-Z';
    
    // ===== ARCHITECTURE V7.0 GENESIS - Appliquer la phase visuelle actuelle =====
    // Calculer l'int√©grit√© (m√™me logique que updatePorygonVisuals)
    if (!gameState.system) gameState.system = {};
    let integrity = gameState.system.integrity || 0;
    
    // Si l'int√©grit√© n'est pas d√©finie, la calculer selon le niveau
    if (integrity === 0 || integrity === undefined) {
        const level = gameState.level || 1;
        const kantoProgress = getCaughtCount ? getCaughtCount('Kanto') : 0;
        const totalProgress = gameState.totalCaught || 0;
        
        integrity = Math.min((level / 50) * 100, 100);
        if (kantoProgress > 0) {
            integrity += (kantoProgress / 151) * 20;
        }
        if (totalProgress > 0) {
            integrity += Math.min((totalProgress / 500) * 10, 10);
        }
        integrity = Math.min(integrity, 100);
    }
    
    // Appliquer la classe CSS selon l'int√©grit√©
    if (integrity < 10) {
        porygonSprite.classList.add('porygon-phase-boot');
    } else if (integrity < 40) {
        porygonSprite.classList.add('porygon-phase-stabilization');
    } else if (integrity < 80) {
        porygonSprite.classList.add('porygon-phase-recovery');
    } else {
        // Corruption visible seulement si niveau √©lev√©
        if (gameState.level >= 30) {
            porygonSprite.classList.add('porygon-phase-corruption');
        } else {
            porygonSprite.classList.add('porygon-phase-recovery');
        }
    }
    
    porygonSprite.style.cssText = `
        width: 180px;
        height: 180px;
        image-rendering: pixelated;
        filter: drop-shadow(0 0 20px rgba(168, 85, 247, 0.8));
        display: block;
        margin-bottom: 30px;
        animation: porygonFloat 3s ease-in-out infinite;
    `;
    porygonSprite.onerror = function() {
        // Fallback si l'image ne charge pas
        this.style.display = 'none';
        const fallback = document.createElement('div');
        fallback.textContent = 'üî∑';
        fallback.style.cssText = 'font-size: 6em; margin-bottom: 30px; animation: porygonFloat 3s ease-in-out infinite;';
        container.insertBefore(fallback, container.firstChild);
    };
    container.appendChild(porygonSprite);
    
    // Bulle de dialogue (phrase par phrase)
    const bubble = document.createElement('div');
    bubble.id = 'porygon-bubble';
    bubble.style.cssText = `
        background: rgba(10, 10, 15, 0.95);
        border: 2px solid #ff0055;
        border-radius: 20px;
        padding: 20px 30px;
        min-width: 300px;
        max-width: 500px;
        text-align: center;
        position: relative;
        box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
        animation: bubbleAppear 0.3s ease;
    `;
    
    // Pointeur de la bulle vers Porygon
    const bubblePointer = document.createElement('div');
    bubblePointer.style.cssText = `
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-bottom: 15px solid #ff0055;
    `;
    bubble.appendChild(bubblePointer);
    
    // Conteneur pour le texte (une phrase √† la fois)
    const textContainer = document.createElement('div');
    textContainer.id = 'porygon-text-container';
    textContainer.style.cssText = `
        color: white;
        font-family: var(--font-family-pixel);
        font-size: 1.2em;
        line-height: 1.6;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    `;
    bubble.appendChild(textContainer);
    
    container.appendChild(bubble);
    modal.appendChild(container);
    document.body.appendChild(modal);
    
    // ===== FIX : Marquer qu'une modale est ouverte =====
    if (!gameState.narrative) gameState.narrative = {};
    gameState.narrative.isShowing = true;
    
    // Afficher les phrases une par une (style Pok√©mon Game Boy/DS)
    let currentLineIndex = 0;
    let isTyping = false;
    let clickHandler = null;
    
    function showNextLine() {
        if (currentLineIndex >= lines.length) {
            // Toutes les phrases ont √©t√© affich√©es, afficher le bouton
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn--primary';
            closeBtn.textContent = 'Compris';
            closeBtn.style.cssText = `
                margin-top: 20px;
                padding: 12px 40px;
                font-size: 1.1em;
                font-weight: bold;
                font-family: var(--font-family-tech);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                z-index: 100001;
            `;
            closeBtn.onclick = () => {
                modal.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    modal.remove();
                    // ===== FIX : Traiter la file d'attente apr√®s fermeture =====
                    if (gameState.narrative) {
                        gameState.narrative.isShowing = false;
                        if (gameState.narrative.queue && gameState.narrative.queue.length > 0) {
                            const next = gameState.narrative.queue.shift();
                            setTimeout(() => {
                                showPorygonMessage(next.lines, next.visual);
                            }, 500);
                        }
                    }
                }, 300);
            };
            container.appendChild(closeBtn);
            return;
        }
        
        // Afficher la phrase actuelle avec effet de frappe
        const currentLine = lines[currentLineIndex];
        textContainer.textContent = '';
        textContainer.style.color = visualType === 'error' || visualType === 'panic' ? '#ff6b6b' : 'white';
        isTyping = true;
        
        // Animation de frappe de texte
        let charIndex = 0;
        let typeInterval = null;
        
        // Fonction pour afficher tout le texte imm√©diatement (si clic pendant la frappe)
        const skipTyping = function() {
            if (typeInterval) {
                clearInterval(typeInterval);
                typeInterval = null;
            }
            textContainer.textContent = currentLine;
            isTyping = false;
            proceedToNext();
        };
        
        // Fonction pour passer √† la phrase suivante
        const proceedToNext = function() {
            // Retirer l'indicateur s'il existe
            const existingIndicator = document.getElementById('continue-indicator');
            if (existingIndicator && existingIndicator.parentNode) {
                existingIndicator.remove();
            }
            
            // Retirer les anciens handlers
            if (clickHandler) {
                modal.removeEventListener('click', clickHandler);
                bubble.removeEventListener('click', clickHandler);
            }
            
            // Ajouter un indicateur visuel (fl√®che ou ic√¥ne)
            const continueIndicator = document.createElement('div');
            continueIndicator.id = 'continue-indicator';
            continueIndicator.textContent = '‚ñº';
            continueIndicator.style.cssText = `
                position: absolute;
                bottom: 10px;
                right: 15px;
                color: rgba(255, 255, 255, 0.6);
                font-size: 0.8em;
                animation: bounce 1s infinite;
                cursor: pointer;
            `;
            bubble.appendChild(continueIndicator);
            
            // Ajouter l'√©v√©nement de clic pour passer √† la phrase suivante
            clickHandler = function(e) {
                // Si on clique sur la bulle, le modal, le texte ou l'indicateur, passer √† la phrase suivante
                if (e.target === bubble || e.target === modal || e.target === textContainer || e.target === continueIndicator || bubble.contains(e.target)) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Passer √† la phrase suivante
                    currentLineIndex++;
                    showNextLine();
                }
            };
            
            modal.addEventListener('click', clickHandler);
            bubble.addEventListener('click', clickHandler);
        };
        
        // Ajouter un handler pour skip pendant la frappe
        const skipHandler = function(e) {
            if (isTyping && (e.target === bubble || e.target === modal || e.target === textContainer || bubble.contains(e.target))) {
                e.preventDefault();
                e.stopPropagation();
                skipTyping();
                modal.removeEventListener('click', skipHandler);
                bubble.removeEventListener('click', skipHandler);
            }
        };
        
        modal.addEventListener('click', skipHandler);
        bubble.addEventListener('click', skipHandler);
        
        // D√©marrer l'animation de frappe
        typeInterval = setInterval(() => {
            if (charIndex < currentLine.length) {
                textContainer.textContent += currentLine[charIndex];
                charIndex++;
            } else {
                clearInterval(typeInterval);
                typeInterval = null;
                isTyping = false;
                modal.removeEventListener('click', skipHandler);
                bubble.removeEventListener('click', skipHandler);
                proceedToNext();
            }
        }, 30); // Vitesse de frappe
    }
    
    // D√©marrer l'affichage des phrases
    showNextLine();
    
    // Emp√™cher la fermeture par clic ext√©rieur
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            // Ne rien faire - la modale est bloquante
        }
    });
}

// POLISHING : Widget Porygon SUPPRIM√â - On utilise uniquement des modales bloquantes
function createPorygonWidget() {
    // Supprimer tout widget existant (le losange flottant)
    const existingWidget = document.getElementById('porygon-widget');
    if (existingWidget) {
        existingWidget.remove();
    }
    // Ne rien cr√©er - le widget flottant est supprim√©
    // Tous les messages passent par showPorygonMessage qui cr√©e des modales
}

// POLISHING : Fonction pour appliquer les effets visuels selon le type avec aberration chromatique
// ===== ARCHITECTURE V7.0 GENESIS - √âVOLUTION VISUELLE DE PORYGON =====
/**
 * Met √† jour l'apparence visuelle de Porygon selon son int√©grit√© syst√®me
 * Phase 1 (Boot): <10% - Glitch√©, transparent, rouge/magenta
 * Phase 2 (Stabilisation): 10-40% - Forme solide avec zones filaires, bleu/vert
 * Phase 3 (R√©cup√©ration): 40-80% - Sprite haute r√©solution, aura lumineuse
 * Phase 4 (Corruption): 80%+ - Artefacts MissingNo, pixels morts
 */
function updatePorygonVisuals() {
    const porygonSprite = document.querySelector('.porygon-sprite');
    if (!porygonSprite) return;
    
    // Calculer l'int√©grit√© bas√©e sur le niveau et la progression
    if (!gameState.system) gameState.system = {};
    
    let integrity = gameState.system.integrity || 0;
    
    // Si l'int√©grit√© n'est pas d√©finie, la calculer selon le niveau
    if (integrity === 0 || integrity === undefined) {
        const level = gameState.level || 1;
        const kantoProgress = getCaughtCount ? getCaughtCount('Kanto') : 0;
        const totalProgress = gameState.totalCaught || 0;
        
        // Int√©grit√© bas√©e sur le niveau (0-100%)
        integrity = Math.min((level / 50) * 100, 100);
        
        // Bonus pour la progression Kanto
        if (kantoProgress > 0) {
            integrity += (kantoProgress / 151) * 20; // +20% max pour Kanto complet
        }
        
        // Bonus pour le total de captures
        if (totalProgress > 0) {
            integrity += Math.min((totalProgress / 500) * 10, 10); // +10% max pour 500 captures
        }
        
        integrity = Math.min(integrity, 100);
        gameState.system.integrity = integrity;
    }
    
    // Retirer toutes les classes de phase
    porygonSprite.classList.remove(
        'porygon-phase-boot',
        'porygon-phase-stabilization',
        'porygon-phase-recovery',
        'porygon-phase-corruption'
    );
    
    // Appliquer la classe selon l'int√©grit√©
    if (integrity < 10) {
        // Phase 1: Boot (Critique)
        porygonSprite.classList.add('porygon-phase-boot');
        if (gameState.system.porygonMood !== 'PANIC') {
            gameState.system.porygonMood = 'PANIC';
        }
    } else if (integrity < 40) {
        // Phase 2: Stabilisation (Instable)
        porygonSprite.classList.add('porygon-phase-stabilization');
        if (gameState.system.porygonMood !== 'NEUTRAL') {
            gameState.system.porygonMood = 'NEUTRAL';
        }
    } else if (integrity < 80) {
        // Phase 3: R√©cup√©ration (Stable)
        porygonSprite.classList.add('porygon-phase-recovery');
        if (gameState.system.porygonMood !== 'HAPPY') {
            gameState.system.porygonMood = 'HAPPY';
        }
    } else {
        // Phase 4: Corruption (Compromis - Paradoxe : haute int√©grit√© mais corruption visible)
        // √Ä partir du niveau 30+, Porygon montre des artefacts m√™me si le syst√®me est stable
        const level = gameState.level || 1;
        if (level >= 30) {
            porygonSprite.classList.add('porygon-phase-corruption');
            if (gameState.system.porygonMood !== 'NEUTRAL') {
                gameState.system.porygonMood = 'NEUTRAL';
            }
        } else {
            porygonSprite.classList.add('porygon-phase-recovery');
        }
    }
}

function applyPorygonVisual(widget, visualType) {
    const sprite = document.getElementById('porygon-sprite');
    if (!sprite) return;
    
    // POLISHING : Ajouter classe active pour d√©clencher l'animation CSS
    if (widget) {
        widget.classList.add('active');
        setTimeout(() => widget.classList.remove('active'), 2000);
    }
    
    // R√©initialiser
    sprite.style.filter = 'drop-shadow(0 0 10px rgba(168, 85, 247, 0.5))';
    sprite.style.animation = '';
    
    switch(visualType) {
        case 'glitch':
        case 'panic':
            sprite.style.animation = 'glitch 0.5s infinite';
            sprite.style.filter = 'drop-shadow(0 0 10px rgba(255, 0, 0, 0.8))';
            // POLISHING : Aberration chromatique
            widget.style.filter = 'drop-shadow(-2px 0 0 rgba(255, 0, 0, 0.8)) drop-shadow(2px 0 0 rgba(0, 255, 255, 0.8))';
            break;
        case 'error':
            shakeScreen();
            sprite.style.animation = 'shake 0.3s';
            sprite.style.filter = 'drop-shadow(0 0 10px rgba(255, 0, 0, 0.8))';
            widget.style.filter = 'drop-shadow(-2px 0 0 rgba(255, 0, 0, 0.8)) drop-shadow(2px 0 0 rgba(0, 255, 255, 0.8))';
            break;
        case 'unlock':
            sprite.style.animation = 'pulse 0.5s ease';
            sprite.style.filter = 'drop-shadow(0 0 20px rgba(16, 185, 129, 0.8))';
            widget.style.filter = '';
            break;
        case 'progress':
            sprite.style.animation = 'pulse 0.3s ease';
            sprite.style.filter = 'drop-shadow(0 0 15px rgba(168, 85, 247, 0.8))';
            widget.style.filter = '';
            break;
        case 'reboot':
            sprite.style.animation = 'flash 1s ease';
            sprite.style.filter = 'drop-shadow(0 0 30px rgba(255, 215, 0, 1))';
            widget.style.filter = '';
            break;
        case 'critical':
            sprite.style.animation = 'pulse 0.2s infinite';
            sprite.style.filter = 'drop-shadow(0 0 15px rgba(255, 165, 0, 0.8))';
            widget.style.filter = 'drop-shadow(-1px 0 0 rgba(255, 0, 0, 0.6)) drop-shadow(1px 0 0 rgba(0, 255, 255, 0.6))';
            break;
        case 'happy':
        default:
            sprite.style.filter = 'drop-shadow(0 0 10px rgba(168, 85, 247, 0.5))';
            widget.style.filter = '';
            break;
    }
}

// Fonction pour secouer l'√©cran (feedback d'erreur)
function shakeScreen() {
    const body = document.body;
    body.style.animation = 'shake 0.3s';
    setTimeout(() => {
        body.style.animation = '';
    }, 300);
}

// Fonction pour v√©rifier l'int√©grit√© du syst√®me
function checkSystemIntegrity() {
    const kantoTotal = 151;
    const kantoCaught = getCaughtCount('Kanto');
    
    // Mise √† jour de l'int√©grit√©
    gameState.system.integrity = Math.floor((kantoCaught / kantoTotal) * 100);
    
    // Mise √† jour du glitch level (moins de glitchs = plus d'int√©grit√©)
    gameState.system.glitchLevel = Math.max(0, 1.0 - (kantoCaught / kantoTotal));
    
    // Triggers narratifs de progression
    if (kantoCaught === 1 && !gameState.system.narrativeFlags.includes('first_data_restored')) {
        triggerNarrative('first_data_restored');
    }
    if (kantoCaught === 50 && !gameState.system.narrativeFlags.includes('system_stabilizing')) {
        triggerNarrative('system_stabilizing');
    }
    if (kantoCaught === 100 && !gameState.system.narrativeFlags.includes('memory_returning')) {
        triggerNarrative('memory_returning');
    }
    if (kantoCaught === 150 && !gameState.system.narrativeFlags.includes('missing_link')) {
        triggerNarrative('missing_link');
    }
    
    // Note: Le d√©blocage de Johto (151/151) est maintenant g√©r√© dans checkRegionUnlock()
    // pour unifier la logique et garantir le trigger narratif
    
    // Mise √† jour de la phase
    if (kantoCaught >= 151) {
        gameState.system.currentPhase = 'KANTO_RECOVERY';
    }
    
    saveGame();
}

// Fonction pour obtenir le nombre de Pok√©mon captur√©s dans une r√©gion
// BUG FIX : Fonction robuste pour compter les Pok√©mon par r√©gion
function getCaughtCount(region) {
    if (!gameState.captured || !(gameState.captured instanceof Set)) {
        return 0;
    }
    
    if (region === 'Kanto') {
        return Array.from(gameState.captured).filter(id => id >= 1 && id <= 151).length;
    } else if (region === 'Johto') {
        return Array.from(gameState.captured).filter(id => id >= 152 && id <= 251).length;
    } else if (region === 'Hoenn') {
        return Array.from(gameState.captured).filter(id => id >= 252 && id <= 386).length;
    }
    return 0;
}

// Fonction pour d√©bloquer une r√©gion
function unlockRegion(region) {
    if (!gameState.unlockedRegions.has(region)) {
        gameState.unlockedRegions.add(region);
        saveGame();
    }
}

// Fonction appel√©e quand on clique sur une r√©gion verrouill√©e
function onRegionClick(region) {
    if (region === 'Johto' && !gameState.unlockedRegions.has('Johto')) {
        triggerNarrative('gate_johto_locked');
    }
}

// Fonction pour v√©rifier les d√©blocages de modules
function checkModuleUnlocks() {
    if (!gameState.modules) return;
    
    // V√©rifier chaque module
    Object.values(gameState.modules).forEach(module => {
        if (module.unlocked) return;
        
        let shouldUnlock = false;
        
        switch(module.condition) {
            case 'level_2':
                shouldUnlock = gameState.level >= 2;
                break;
            case 'level_5':
                shouldUnlock = gameState.level >= 5;
                break;
            case 'level_12':
                shouldUnlock = gameState.level >= 12;
                break;
            case 'level_20_and_johto':
                shouldUnlock = gameState.level >= 20 && gameState.unlockedRegions && gameState.unlockedRegions.has('Johto');
                break;
            case 'level_25':
                shouldUnlock = gameState.level >= 25;
                break;
        }
        
        if (shouldUnlock && module.dialogue) {
            module.unlocked = true;
            // CORRECTION : Ne d√©clencher le dialogue que s'il n'a pas d√©j√† √©t√© vu
            if (!gameState.system.narrativeFlags.includes(module.dialogue)) {
                triggerNarrative(module.dialogue);
            }
        }
    });
}

// Fonction pour mettre √† jour les visuels du syst√®me selon l'int√©grit√©
function updateSystemVisuals() {
    // ‚úÖ CORRECTION : Ne pas appliquer le glitch si l'intro n'a pas √©t√© vue
    if (!gameState.introSeen) {
        document.body.classList.remove('system-critical', 'system-unstable', 'system-stable', 'system-optimized', 'system-advanced');
        return;
    }
    
    const glitchLevel = gameState.system.glitchLevel || 1.0;
    const body = document.body;
    
    // Retirer la classe glitch si l'int√©grit√© est √©lev√©e
    if (glitchLevel < 0.3) {
        body.classList.remove('system-critical');
    } else if (glitchLevel > 0.7) {
        body.classList.add('system-critical');
    }
    
    // Mettre √† jour le widget Porygon selon le mood
    const widget = document.getElementById('porygon-widget');
    if (widget) {
        const sprite = document.getElementById('porygon-sprite');
        if (sprite) {
            const mood = gameState.system.porygonMood || 'PANIC';
            switch(mood) {
                case 'PANIC':
                    sprite.style.filter = 'drop-shadow(0 0 10px rgba(255, 0, 0, 0.8))';
                    break;
                case 'NEUTRAL':
                    sprite.style.filter = 'drop-shadow(0 0 10px rgba(168, 85, 247, 0.5))';
                    break;
                case 'HAPPY':
                    sprite.style.filter = 'drop-shadow(0 0 15px rgba(16, 185, 129, 0.8))';
                    break;
                case 'PROUD':
                    sprite.style.filter = 'drop-shadow(0 0 20px rgba(255, 215, 0, 1))';
                    break;
            }
        }
    }
}

const ROGUE_EVENTS = {
    encounter:{type:'encounter',weight:40,icon:'‚öîÔ∏è',name:'Rencontre Pok√©mon'},
    item:{type:'item',weight:20,icon:'üéÅ',name:'Trouvaille d\'objet'},
    trap:{type:'trap',weight:10,icon:'üí•',name:'Pi√®ge'},
    blessing:{type:'blessing',weight:6,icon:'üíô',name:'B√©n√©diction'},
    heal:{type:'heal',weight:8,icon:'‚ù§Ô∏è',name:'Soin'},
    shop:{type:'shop',weight:8,icon:'üè™',name:'Boutique'},
    rest:{type:'rest',weight:8,icon:'üí§',name:'Repos'},
    boss:{type:'boss',weight:0,icon:'üëë',name:'Boss'}
};

// ===== POK√â-POKER : FONDATIONS =====

// Catalogue de cartes (charg√© depuis JSON)
let CARDS_CATALOGUE = null;
if (typeof window !== 'undefined') {
    window.CARDS_CATALOGUE = null;
}

// Charger le catalogue de cartes
async function loadCardsCatalogue() {
    try {
        const response = await fetch('cards_catalogue.json');
        if (response.ok) {
            CARDS_CATALOGUE = await response.json();
            if (typeof window !== 'undefined') {
                window.CARDS_CATALOGUE = CARDS_CATALOGUE;
            }
            console.log('Catalogue de cartes charg√©:', CARDS_CATALOGUE);
        } else {
            console.warn('Impossible de charger cards_catalogue.json, utilisation des jokers par d√©faut');
        }
    } catch (error) {
        console.warn('Erreur lors du chargement du catalogue:', error);
    }
}

// Initialiser le catalogue au chargement
if (typeof window !== 'undefined') {
    window.addEventListener('DOMContentLoaded', loadCardsCatalogue);
}

// Types de mains (du plus faible au plus fort)
const HAND_TYPES = {
    HIGH_CARD: { name: 'High Card', name_fr: 'Carte Haute', base_chip: 5, base_mult: 1, rank: 1 },
    PAIR: { name: 'Pair', name_fr: 'Paire', base_chip: 30, base_mult: 2, rank: 2 },
    TWO_PAIR: { name: 'Two Pair', name_fr: 'Double Paire', base_chip: 60, base_mult: 3, rank: 3 },
    THREE_KIND: { name: 'Three of a Kind', name_fr: 'Brelan', base_chip: 150, base_mult: 4, rank: 4 },
    STRAIGHT: { name: 'Straight', name_fr: 'Suite', base_chip: 200, base_mult: 5, rank: 5 },
    EVOLUTION_CHAIN: { name: 'Evolution Chain', name_fr: 'Cha√Æne d\'√âvolution', base_chip: 250, base_mult: 6, rank: 5 },
    FLUSH: { name: 'Flush', name_fr: 'Flush', base_chip: 300, base_mult: 6, rank: 6 },
    TYPE_FLUSH: { name: 'Type Flush', name_fr: 'Flush Type', base_chip: 350, base_mult: 7, rank: 6 },
    FULL_HOUSE: { name: 'Full House', name_fr: 'Full House', base_chip: 500, base_mult: 7, rank: 7 },
    FOUR_KIND: { name: 'Four of a Kind', name_fr: 'Carr√©', base_chip: 900, base_mult: 10, rank: 8 },
    STRAIGHT_FLUSH: { name: 'Straight Flush', name_fr: 'Quinte Flush', base_chip: 1500, base_mult: 15, rank: 9 },
    LEGENDARY_TRIO: { name: 'Legendary Trio', name_fr: 'Trio L√©gendaire', base_chip: 3000, base_mult: 20, rank: 10 },
    SHINY_FLUSH: { name: 'Shiny Flush', name_fr: 'Flush Shiny', base_chip: 5000, base_mult: 50, rank: 11 },
    FIVE_KIND: { name: 'Five of a Kind', name_fr: 'Cinq Identiques', base_chip: 2000, base_mult: 25, rank: 9 }
};

// Configuration des Antes (8 badges + Ligue)
const ANTES_CONFIG = [
    { ante_number: 1, badge_name: 'Boulder Badge', badge_name_fr: 'Badge Roche', badge_icon: 'ü™®', boss_name: 'Onix', boss_modifier: 'Rock Shield: -10% mult', blinds: [{ type: 'small', target_base: 500 }, { type: 'big', target_base: 750 }, { type: 'boss', target_base: 1250 }] },
    { ante_number: 2, badge_name: 'Cascade Badge', badge_name_fr: 'Badge Cascade', badge_icon: 'üíß', boss_name: 'Starmie', boss_modifier: 'Water Veil: Water cards +50% chips', blinds: [{ type: 'small', target_base: 800 }, { type: 'big', target_base: 1200 }, { type: 'boss', target_base: 2000 }] },
    { ante_number: 3, badge_name: 'Thunder Badge', badge_name_fr: 'Badge Foudre', badge_icon: '‚ö°', boss_name: 'Raichu', boss_modifier: 'Static: All pairs give √ó2 mult', blinds: [{ type: 'small', target_base: 1500 }, { type: 'big', target_base: 2250 }, { type: 'boss', target_base: 3750 }] },
    { ante_number: 4, badge_name: 'Rainbow Badge', badge_name_fr: 'Badge Prisme', badge_icon: 'üåà', boss_name: 'Victreebel', boss_modifier: 'Synthesis: Grass cards +100 chips', blinds: [{ type: 'small', target_base: 2500 }, { type: 'big', target_base: 3750 }, { type: 'boss', target_base: 6250 }] },
    { ante_number: 5, badge_name: 'Soul Badge', badge_name_fr: 'Badge √Çme', badge_icon: '‚ò†Ô∏è', boss_name: 'Arbok', boss_modifier: 'Poison Point: -1 discard', blinds: [{ type: 'small', target_base: 4000 }, { type: 'big', target_base: 6000 }, { type: 'boss', target_base: 10000 }] },
    { ante_number: 6, badge_name: 'Volcano Badge', badge_name_fr: 'Badge Volcan', badge_icon: 'üî•', boss_name: 'Arcanine', boss_modifier: 'Blaze: Fire flushes √ó3 mult', blinds: [{ type: 'small', target_base: 6500 }, { type: 'big', target_base: 9750 }, { type: 'boss', target_base: 16250 }] },
    { ante_number: 7, badge_name: 'Marsh Badge', badge_name_fr: 'Badge Marais', badge_icon: 'üß†', boss_name: 'Alakazam', boss_modifier: 'Psychic: Reveal all deck cards', blinds: [{ type: 'small', target_base: 10000 }, { type: 'big', target_base: 15000 }, { type: 'boss', target_base: 25000 }] },
    { ante_number: 8, badge_name: 'Earth Badge', badge_name_fr: 'Badge Terre', badge_icon: 'üåç', boss_name: 'Rhydon', boss_modifier: 'Earthquake: -1 hand', blinds: [{ type: 'small', target_base: 15000 }, { type: 'big', target_base: 22500 }, { type: 'boss', target_base: 37500 }] }
];

// Configuration Ligue Pok√©mon
const LEAGUE_CONFIG = {
    unlocked_after_badges: 8,
    elite_four: [
        { name: 'Lorelei', name_fr: 'Lorelei', type_specialty: 'Ice', icon: '‚ùÑÔ∏è', boss_pokemon: 'Lapras', modifier: 'Frozen Deck: 20% cards frozen', target_multiplier: 2.0 },
        { name: 'Bruno', name_fr: 'Bruno', type_specialty: 'Fighting', icon: 'ü•ä', boss_pokemon: 'Machamp', modifier: 'No Holds Barred: All hands -1 card', target_multiplier: 2.5 },
        { name: 'Agatha', name_fr: 'Agatha', type_specialty: 'Ghost', icon: 'üëª', boss_pokemon: 'Gengar', modifier: 'Curse: Discards cost 100 chips', target_multiplier: 3.0 },
        { name: 'Lance', name_fr: 'Peter', type_specialty: 'Dragon', icon: 'üêâ', boss_pokemon: 'Dragonite', modifier: 'Dragon Rage: Boss has 3 phases', target_multiplier: 4.0 }
    ],
    champion: { name: 'Blue', name_fr: 'Blue', icon: 'üëë', boss_pokemon: 'Mewtwo', modifier: 'Champion: All modifiers active', target_multiplier: 5.0, hands_allowed: 5, blinds_count: 5 }
};

// Jokers COMMON (10)
const COMMON_JOKERS = [
    { id: 'joker_coin_small', name: 'Coin Charm', name_fr: 'Charme Pi√®ce', description: '+200 chips immediately', description_fr: '+200 chips imm√©diatement', rarity: 'common', cost_chips: 100, uses_remaining: 1, icon: 'ü™ô' },
    { id: 'joker_pinap', name: 'Pinap Berry', name_fr: 'Baie Nanab', description: 'Next hand coins √ó2', description_fr: 'Prochaine main √ó2 chips', rarity: 'common', cost_chips: 150, uses_remaining: 1, icon: 'üçç' },
    { id: 'joker_reveal', name: 'Scout', name_fr: '√âclaireur', description: 'Reveal top 3 deck cards', description_fr: 'R√©v√©ler 3 cartes du deck', rarity: 'common', cost_chips: 80, uses_remaining: 1, icon: 'üëÅÔ∏è' },
    { id: 'joker_extra_discard', name: 'Extra Discard', name_fr: 'D√©fausse Suppl√©mentaire', description: '+1 discard for this blind', description_fr: '+1 d√©fausse ce blind', rarity: 'common', cost_chips: 120, uses_remaining: null, icon: 'üîÑ' },
    { id: 'joker_small_mult', name: 'Small Mult', name_fr: 'Petit Mult', description: '+2 mult permanent', description_fr: '+2 mult permanent', rarity: 'common', cost_chips: 150, uses_remaining: null, icon: '‚≠ê' },
    { id: 'joker_type_reveal', name: 'Type Scanner', name_fr: 'Scanner Type', description: 'Reveal types of next 5 cards', description_fr: 'R√©v√©ler types des 5 prochaines cartes', rarity: 'common', cost_chips: 100, uses_remaining: 1, icon: 'üîç' },
    { id: 'joker_chip_boost', name: 'Chip Boost', name_fr: 'Boost Chips', description: '+50 chips permanent', description_fr: '+50 chips permanent', rarity: 'common', cost_chips: 180, uses_remaining: null, icon: 'üí∞' },
    { id: 'joker_lucky_draw', name: 'Lucky Draw', name_fr: 'Pioche Chanceuse', description: '+1 card draw next hand', description_fr: '+1 carte pioche prochaine main', rarity: 'common', cost_chips: 140, uses_remaining: 1, icon: 'üçÄ' },
    { id: 'joker_reroll_shop', name: 'Shop Reroll', name_fr: 'Relance Shop', description: 'Reroll shop once', description_fr: 'Relancer shop une fois', rarity: 'common', cost_chips: 100, uses_remaining: 1, icon: 'üé≤' },
    { id: 'joker_protection', name: 'Safety Net', name_fr: 'Filet de S√©curit√©', description: 'Prevent one blind failure', description_fr: '√âviter un √©chec de blind', rarity: 'common', cost_chips: 200, uses_remaining: 1, icon: 'üõ°Ô∏è' }
];

// Jokers UNCOMMON (15)
const UNCOMMON_JOKERS = [
    { id: 'joker_type_shift', name: 'Type Shift', name_fr: 'Changement Type', description: 'Change one card type to any', description_fr: 'Changer type d\'une carte', rarity: 'uncommon', cost_chips: 300, uses_remaining: 1, icon: 'üåÄ' },
    { id: 'joker_extra_draw_3', name: 'Extra Draw', name_fr: 'Pioche Extra', description: '+3 cards draw next hand', description_fr: '+3 cartes pioche prochaine main', rarity: 'uncommon', cost_chips: 400, uses_remaining: 1, icon: 'üìö' },
    { id: 'joker_chain_protect', name: 'Chain Protector', name_fr: 'Protecteur Cha√Æne', description: 'Prevent one chain break', description_fr: '√âviter une rupture de cha√Æne', rarity: 'uncommon', cost_chips: 350, uses_remaining: 1, icon: 'üîó' },
    { id: 'joker_mult_x2', name: 'Double Mult', name_fr: 'Double Mult', description: '√ó2 mult this hand', description_fr: '√ó2 mult cette main', rarity: 'uncommon', cost_chips: 450, uses_remaining: 1, icon: '‚úñÔ∏è' },
    { id: 'joker_type_fire', name: 'Fire Aura', name_fr: 'Aura Feu', description: '+3 mult per Fire card', description_fr: '+3 mult par carte Feu', rarity: 'uncommon', cost_chips: 400, uses_remaining: null, icon: 'üî•' },
    { id: 'joker_type_water', name: 'Water Aura', name_fr: 'Aura Eau', description: '+3 mult per Water card', description_fr: '+3 mult par carte Eau', rarity: 'uncommon', cost_chips: 400, uses_remaining: null, icon: 'üíß' },
    { id: 'joker_type_grass', name: 'Grass Aura', name_fr: 'Aura Plante', description: '+3 mult per Grass card', description_fr: '+3 mult par carte Plante', rarity: 'uncommon', cost_chips: 400, uses_remaining: null, icon: 'üåø' },
    { id: 'joker_pair_boost', name: 'Pair Master', name_fr: 'Ma√Ætre Paire', description: 'Pairs give +100 chips', description_fr: 'Paires donnent +100 chips', rarity: 'uncommon', cost_chips: 350, uses_remaining: null, icon: 'üë•' },
    { id: 'joker_flush_boost', name: 'Flush Master', name_fr: 'Ma√Ætre Flush', description: 'Flushes give √ó1.5 mult', description_fr: 'Flush donnent √ó1.5 mult', rarity: 'uncommon', cost_chips: 500, uses_remaining: null, icon: 'üíé' },
    { id: 'joker_rare_boost', name: 'Rare Hunter', name_fr: 'Chasseur Rare', description: '+50 chips per rare+ card', description_fr: '+50 chips par carte rare+', rarity: 'uncommon', cost_chips: 450, uses_remaining: null, icon: '‚≠ê' },
    { id: 'joker_common_boost', name: 'Common Swarm', name_fr: 'Essaim Commun', description: '+5 mult per common card', description_fr: '+5 mult par carte commune', rarity: 'uncommon', cost_chips: 300, uses_remaining: null, icon: 'üêù' },
    { id: 'joker_hand_upgrade', name: 'Hand Upgrade', name_fr: 'Am√©lioration Main', description: '+1 hand for this blind', description_fr: '+1 main ce blind', rarity: 'uncommon', cost_chips: 400, uses_remaining: 1, icon: 'üñêÔ∏è' },
    { id: 'joker_chip_mult_balance', name: 'Balance', name_fr: '√âquilibre', description: '+100 chips, +5 mult', description_fr: '+100 chips, +5 mult', rarity: 'uncommon', cost_chips: 450, uses_remaining: null, icon: '‚öñÔ∏è' },
    { id: 'joker_lucky_star', name: 'Lucky Star', name_fr: '√âtoile Chanceuse', description: '20% chance √ó3 mult', description_fr: '20% chance √ó3 mult', rarity: 'uncommon', cost_chips: 500, uses_remaining: null, icon: '‚≠ê' },
    { id: 'joker_type_convert', name: 'Type Converter', name_fr: 'Convertisseur Type', description: 'Convert 1 card to Buddy type', description_fr: 'Convertir 1 carte au type Buddy', rarity: 'uncommon', cost_chips: 350, uses_remaining: 1, icon: 'üîÑ' }
];

// Jokers RARE (12)
const RARE_JOKERS = [
    { id: 'joker_shiny_charm', name: 'Shiny Charm', name_fr: 'Charme Shiny', description: '+1% shiny chance this run', description_fr: '+1% chance shiny cette run', rarity: 'rare', cost_chips: 800, cost_shards: 5, uses_remaining: null, icon: '‚ú®' },
    { id: 'joker_double_chip', name: 'Double Chip', name_fr: 'Double Chips', description: '√ó2 chips this hand', description_fr: '√ó2 chips cette main', rarity: 'rare', cost_chips: 700, uses_remaining: 1, icon: 'üíé' },
    { id: 'joker_evo_boost', name: 'Evolution Boost', name_fr: 'Boost √âvolution', description: 'Evolution chains +50% chips', description_fr: 'Cha√Ænes √©volution +50% chips', rarity: 'rare', cost_chips: 900, uses_remaining: null, icon: 'üîó' },
    { id: 'joker_legendary_boost', name: 'Legendary Aura', name_fr: 'Aura L√©gendaire', description: '+200 chips per legendary', description_fr: '+200 chips par l√©gendaire', rarity: 'rare', cost_chips: 1000, uses_remaining: null, icon: 'üëë' },
    { id: 'joker_starter_power', name: 'Starter Power', name_fr: 'Pouvoir Starter', description: 'Starters give √ó2 mult', description_fr: 'Starters donnent √ó2 mult', rarity: 'rare', cost_chips: 850, uses_remaining: null, icon: 'üå±' },
    { id: 'joker_triple_mult', name: 'Triple Mult', name_fr: 'Triple Mult', description: '√ó3 mult this hand', description_fr: '√ó3 mult cette main', rarity: 'rare', cost_chips: 900, uses_remaining: 1, icon: '‚úñÔ∏è‚úñÔ∏è' },
    { id: 'joker_wild_card', name: 'Wild Card', name_fr: 'Carte Joker', description: 'One card acts as any species', description_fr: 'Une carte agit comme n\'importe quelle esp√®ce', rarity: 'rare', cost_chips: 1000, uses_remaining: 1, icon: 'üé¥' },
    { id: 'joker_mega_evolve', name: 'Mega Evolution', name_fr: 'M√©ga-√âvolution', description: 'Upgrade one stage 3 to stage 4', description_fr: 'Am√©liorer un stage 3 en stage 4', rarity: 'rare', cost_chips: 1200, uses_remaining: 1, icon: 'üí´' },
    { id: 'joker_type_master', name: 'Type Master', name_fr: 'Ma√Ætre Type', description: 'Flushes give √ó2 mult', description_fr: 'Flush donnent √ó2 mult', rarity: 'rare', cost_chips: 950, uses_remaining: null, icon: 'üéØ' },
    { id: 'joker_full_house_king', name: 'Full House King', name_fr: 'Roi Full House', description: 'Full houses √ó2.5 mult', description_fr: 'Full House √ó2.5 mult', rarity: 'rare', cost_chips: 1100, uses_remaining: null, icon: 'üè†' },
    { id: 'joker_four_kind_master', name: 'Four Kind Master', name_fr: 'Ma√Ætre Carr√©', description: 'Four of a kind √ó3 chips', description_fr: 'Carr√© √ó3 chips', rarity: 'rare', cost_chips: 1200, uses_remaining: null, icon: 'üÉè' },
    { id: 'joker_ante_rush', name: 'Ante Rush', name_fr: 'Rush Ante', description: '+10% mult per ante cleared', description_fr: '+10% mult par ante compl√©t√©', rarity: 'rare', cost_chips: 1000, uses_remaining: null, icon: '‚ö°' }
];

// Jokers SUPER RARE (8)
const SUPER_RARE_JOKERS = [
    { id: 'joker_legend_call', name: 'Legend Call', name_fr: 'Appel L√©gendaire', description: 'Add one legendary to hand', description_fr: 'Ajouter un l√©gendaire √† la main', rarity: 'super_rare', cost_chips: 2000, cost_shards: 15, uses_remaining: 1, icon: 'üìû' },
    { id: 'joker_mirror', name: 'Mirror Copy', name_fr: 'Copie Miroir', description: 'Duplicate one card in hand', description_fr: 'Dupliquer une carte de la main', rarity: 'super_rare', cost_chips: 2500, uses_remaining: 1, icon: 'ü™û' },
    { id: 'joker_arcane_shuffle', name: 'Arcane Shuffle', name_fr: 'M√©lange Arcan', description: 'Reshuffle 10 deck cards', description_fr: 'Rem√©langer 10 cartes du deck', rarity: 'super_rare', cost_chips: 1800, uses_remaining: 1, icon: 'üîÆ' },
    { id: 'joker_shiny_surge', name: 'Shiny Surge', name_fr: 'Vague Shiny', description: 'Shinies √ó2 mult this blind', description_fr: 'Shiny √ó2 mult ce blind', rarity: 'super_rare', cost_chips: 3000, cost_shiny_tokens: 50, uses_remaining: null, icon: '‚ú®' },
    { id: 'joker_golden_ticket', name: 'Golden Ticket', name_fr: 'Ticket Dor√©', description: '+2 hands permanently', description_fr: '+2 mains permanent', rarity: 'super_rare', cost_chips: 5000, uses_remaining: null, icon: 'üé´' },
    { id: 'joker_type_rainbow', name: 'Rainbow Aura', name_fr: 'Aura Arc-en-ciel', description: '+10 mult per different type', description_fr: '+10 mult par type diff√©rent', rarity: 'super_rare', cost_chips: 2800, uses_remaining: null, icon: 'üåà' },
    { id: 'joker_mega_multiplier', name: 'Mega Multiplier', name_fr: 'M√©ga-Multiplicateur', description: '√ó5 mult this hand', description_fr: '√ó5 mult cette main', rarity: 'super_rare', cost_chips: 3500, uses_remaining: 1, icon: 'üí•' },
    { id: 'joker_perfect_hand', name: 'Perfect Hand', name_fr: 'Main Parfaite', description: 'Next hand guaranteed best combo', description_fr: 'Prochaine main combo optimal garanti', rarity: 'super_rare', cost_chips: 4000, uses_remaining: 1, icon: 'üëë' }
];

// Jokers LEGENDARY (5)
const LEGENDARY_JOKERS = [
    { id: 'joker_master_ball', name: 'Master Ball', name_fr: 'Master Ball', description: 'All cards act as any species', description_fr: 'Toutes les cartes agissent comme n\'importe quelle esp√®ce', rarity: 'legendary', cost_chips: 10000, cost_shiny_tokens: 200, uses_remaining: 1, icon: 'üíú' },
    { id: 'joker_arceus_blessing', name: 'Arceus Blessing', name_fr: 'B√©n√©diction Arceus', description: '√ó10 mult permanently', description_fr: '√ó10 mult permanent', rarity: 'legendary', cost_chips: 15000, cost_shards: 100, uses_remaining: null, icon: 'üåü' },
    { id: 'joker_infinite_shinies', name: 'Infinite Shiny', name_fr: 'Shiny Infini', description: 'All cards are Shiny this blind', description_fr: 'Toutes les cartes sont Shiny ce blind', rarity: 'legendary', cost_chips: 20000, cost_shiny_tokens: 500, uses_remaining: 1, icon: '‚ú®‚ú®' },
    { id: 'joker_time_distortion', name: 'Time Distortion', name_fr: 'Distorsion Temporelle', description: 'Replay last 3 hands', description_fr: 'Rejouer les 3 derni√®res mains', rarity: 'legendary', cost_chips: 12000, uses_remaining: 1, icon: '‚è∞' },
    { id: 'joker_shard_blessing', name: 'Shard Blessing', name_fr: 'B√©n√©diction Shard', description: 'Permanent +5% score to chosen type', description_fr: 'Permanent +5% score au type choisi', rarity: 'legendary', cost_shards: 200, uses_remaining: null, icon: 'üíé' }
];

// Tous les jokers combin√©s
const ALL_JOKERS = [...COMMON_JOKERS, ...UNCOMMON_JOKERS, ...RARE_JOKERS, ...SUPER_RARE_JOKERS, ...LEGENDARY_JOKERS];

// Helpers de base
function shuffleDeck(deck) {
    const shuffled = [...deck];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
}

function formatNumber(num) {
    return num.toLocaleString('fr-FR');
}

function calculatePercentage(current, target) {
    return Math.min((current / target) * 100, 100);
}

function wait(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function safeGet(array, index, defaultValue = null) {
    return array && array[index] !== undefined ? array[index] : defaultValue;
}

function isPokerRunActive() {
    return gameState.poker && gameState.poker.current_run && gameState.poker.current_run.active;
}

function getAnteConfig(anteNumber) {
    return ANTES_CONFIG.find(a => a.ante_number === anteNumber) || ANTES_CONFIG[0];
}

function getTypeColor(type) {
    const TYPE_COLORS = {
        Fire: '#e25822', Water: '#3aa7f4', Grass: '#6dc066', Electric: '#ffd24c',
        Psychic: '#ec5c85', Normal: '#a8a878', Fighting: '#c03028', Poison: '#a040a0',
        Ground: '#e0c068', Flying: '#a890f0', Bug: '#a8b820', Rock: '#b8a038',
        Ghost: '#705898', Dragon: '#7038f8', Ice: '#98d8d8', Dark: '#705848',
        Steel: '#b8b8d0', Fairy: '#ee99ac'
    };
    return TYPE_COLORS[type] || '#a8a878';
}

// IDs l√©gendaires Kanto
const LEGENDARY_IDS = [144, 145, 146, 150, 151];
const MYTHIC_IDS = [151];

// ===== POK√â-POKER : G√âN√âRATION DECK KANTO =====

// Starters Kanto
const STARTER_IDS = [1, 4, 7];

// Fonction pour d√©terminer le stage d'√©volution
function getEvolutionStage(pokemonId) {
    // Stage 3 (√©volutions finales)
    const stage3 = [3, 6, 9, 12, 15, 18, 20, 22, 24, 26, 28, 31, 34, 36, 38, 40, 42, 45, 47, 49, 51, 53, 55, 57, 59, 62, 65, 68, 71, 73, 76, 78, 80, 82, 85, 87, 89, 91, 94, 97, 99, 101, 103, 105, 107, 110, 112, 115, 117, 119, 121, 123, 125, 126, 127, 130, 131, 134, 135, 136, 139, 141, 142, 149];
    if (stage3.includes(pokemonId)) return 3;
    
    // Stage 2 (√©volutions interm√©diaires)
    const stage2 = [2, 5, 8, 11, 14, 17, 19, 21, 23, 25, 27, 29, 30, 32, 33, 35, 37, 39, 41, 43, 44, 46, 48, 50, 52, 54, 56, 58, 60, 61, 63, 64, 66, 67, 69, 70, 72, 74, 75, 77, 79, 81, 83, 84, 86, 88, 90, 92, 93, 95, 96, 98, 100, 102, 104, 106, 108, 109, 111, 113, 114, 116, 118, 120, 122, 124, 128, 129, 132, 133, 137, 138, 140, 143, 148];
    if (stage2.includes(pokemonId)) return 2;
    
    // Stage 1 (base) - inclut Minidraco (147)
    return 1;
}

// Fonction pour d√©terminer la famille d'√©volution
function getEvolutionFamily(pokemonId) {
    // Familles d'√©volution Kanto
    const families = {
        'bulbasaur_family': [1, 2, 3],
        'charmander_family': [4, 5, 6],
        'squirtle_family': [7, 8, 9],
        'caterpie_family': [10, 11, 12],
        'weedle_family': [13, 14, 15],
        'pidgey_family': [16, 17, 18],
        'rattata_family': [19, 20],
        'spearow_family': [21, 22],
        'ekans_family': [23, 24],
        'pikachu_family': [25, 26],
        'sandshrew_family': [27, 28],
        'nidoran_f_family': [29, 30, 31],
        'nidoran_m_family': [32, 33, 34],
        'clefairy_family': [35, 36],
        'vulpix_family': [37, 38],
        'jigglypuff_family': [39, 40],
        'zubat_family': [41, 42],
        'oddish_family': [43, 44, 45],
        'paras_family': [46, 47],
        'venonat_family': [48, 49],
        'diglett_family': [50, 51],
        'meowth_family': [52, 53],
        'psyduck_family': [54, 55],
        'mankey_family': [56, 57],
        'growlithe_family': [58, 59],
        'poliwag_family': [60, 61, 62],
        'abra_family': [63, 64, 65],
        'machop_family': [66, 67, 68],
        'bellsprout_family': [69, 70, 71],
        'tentacool_family': [72, 73],
        'geodude_family': [74, 75, 76],
        'ponyta_family': [77, 78],
        'slowpoke_family': [79, 80],
        'magnemite_family': [81, 82],
        'farfetchd_family': [83],
        'doduo_family': [84, 85],
        'seel_family': [86, 87],
        'grimer_family': [88, 89],
        'shellder_family': [90, 91],
        'gastly_family': [92, 93, 94],
        'onix_family': [95],
        'drowzee_family': [96, 97],
        'krabby_family': [98, 99],
        'voltorb_family': [100, 101],
        'exeggcute_family': [102, 103],
        'cubone_family': [104, 105],
        'hitmon_family': [106, 107],
        'lickitung_family': [108],
        'koffing_family': [109, 110],
        'rhyhorn_family': [111, 112],
        'chansey_family': [113],
        'tangela_family': [114],
        'kangaskhan_family': [115],
        'horsea_family': [116, 117],
        'goldeen_family': [118, 119],
        'staryu_family': [120, 121],
        'mrmime_family': [122],
        'scyther_family': [123],
        'jynx_family': [124],
        'electabuzz_family': [125],
        'magmar_family': [126],
        'pinsir_family': [127],
        'tauros_family': [128],
        'magikarp_family': [129, 130],
        'lapras_family': [131],
        'ditto_family': [132],
        'eevee_family': [133, 134, 135, 136],
        'porygon_family': [137],
        'omanyte_family': [138, 139],
        'kabuto_family': [140, 141],
        'aerodactyl_family': [142],
        'snorlax_family': [143],
        'articuno_family': [144],
        'zapdos_family': [145],
        'moltres_family': [146],
        'dratini_family': [147, 148, 149],
        'mewtwo_family': [150],
        'mew_family': [151]
    };
    
    for (const [familyId, ids] of Object.entries(families)) {
        if (ids.includes(pokemonId)) return familyId;
    }
    return `pokemon_${pokemonId}_family`;
}

// Fonction pour d√©terminer la raret√© d'un Pok√©mon
function determinePokerRarity(pokemonId) {
    if (LEGENDARY_IDS.includes(pokemonId)) return 'legendary';
    if (MYTHIC_IDS.includes(pokemonId)) return 'legendary';
    
    const evolStage = getEvolutionStage(pokemonId);
    if (evolStage === 3) return 'super_rare';
    if (evolStage === 2) return 'rare';
    
    // Pseudo-l√©gendaires
    if ([130, 131, 143, 149].includes(pokemonId)) return 'super_rare';
    
    // Starters stage 1
    if (STARTER_IDS.includes(pokemonId)) return 'uncommon';
    
    // Autres rares connus
    if ([94, 65, 68, 76, 80, 91, 103, 112, 113, 121, 122, 130, 134, 135, 136, 137, 139, 141, 147, 148].includes(pokemonId)) {
        return 'rare';
    }
    
    return 'common';
}

// Fonction pour calculer base_chip et base_mult
function calculateBaseStats(pokemonId, rarity) {
    const RARITY_STATS = {
        common: { chip_min: 10, chip_max: 25, mult: 1 },
        uncommon: { chip_min: 30, chip_max: 45, mult: 2 },
        rare: { chip_min: 50, chip_max: 80, mult: 3 },
        super_rare: { chip_min: 90, chip_max: 130, mult: 4 },
        legendary: { chip_min: 140, chip_max: 200, mult: 5 }
    };
    
    const stats = RARITY_STATS[rarity] || RARITY_STATS.common;
    let base_chip = stats.chip_min + (Math.random() * (stats.chip_max - stats.chip_min));
    
    // Ajustements
    const evolStage = getEvolutionStage(pokemonId);
    if (evolStage === 3) base_chip += 30;
    if (evolStage === 2) base_chip += 15;
    
    // Dual-type bonus
    const types = POKEMON_TYPES[pokemonId] || [];
    if (types.length === 2) base_chip += 5;
    
    // L√©gendaire bonus
    if (LEGENDARY_IDS.includes(pokemonId)) base_chip += 50;
    
    return {
        base_chip: Math.round(base_chip),
        base_mult: stats.mult
    };
}

// Fonction pour cr√©er une carte compl√®te
// Fonction helper pour obtenir les sprites anim√©s
function getAnimatedSpriteUrl(pokemonId, isShiny = false) {
    const baseUrl = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon';
    const animUrl = `${baseUrl}/versions/generation-v/black-white/animated`;
    if (isShiny) {
        return `${animUrl}/shiny/${pokemonId}.gif`;
    }
    return `${animUrl}/${pokemonId}.gif`;
}

// Fonction helper pour obtenir les sprites officiels (fallback si anim√© non disponible)
function getOfficialSpriteUrl(pokemonId, isShiny = false) {
    const baseUrl = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon';
    if (isShiny) {
        return `${baseUrl}/other/official-artwork/shiny/${pokemonId}.png`;
    }
    return `${baseUrl}/other/official-artwork/${pokemonId}.png`;
}

// GENESIS REBOOT - Sprite MissingNo (Boss Final)
function getMissingNoSpriteUrl() {
    // MissingNo utilise un sprite glitch√© sp√©cial
    // Source: Bulbagarden Archives (domaine public)
    return 'https://archives.bulbagarden.net/media/upload/thumb/9/95/Missingno_RB.png/96px-Missingno_RB.png';
}

function createCard(pokemonId) {
    const rarity = determinePokerRarity(pokemonId);
    const stats = calculateBaseStats(pokemonId, rarity);
    const types = POKEMON_TYPES[pokemonId] || ['Normal'];
    const primaryType = types[0];
    
    // Conversion types fran√ßais ‚Üí anglais pour les sprites
    const typeMap = {
        'Plante': 'Grass', 'Poison': 'Poison', 'Feu': 'Fire', 'Vol': 'Flying',
        'Eau': 'Water', 'Insecte': 'Bug', 'Normal': 'Normal', '√âlectrik': 'Electric',
        'Sol': 'Ground', 'F√©e': 'Fairy', 'Psy': 'Psychic', 'Combat': 'Fighting',
        'Roche': 'Rock', 'Glace': 'Ice', 'Spectre': 'Ghost', 'Dragon': 'Dragon',
        'Acier': 'Steel', 'T√©n√®bres': 'Dark'
    };
    
    const typesEn = types.map(t => typeMap[t] || t);
    
    return {
        id: `p${String(pokemonId).padStart(3, '0')}_${FRENCH_NAMES[pokemonId]?.toLowerCase().replace(/\s+/g, '_') || `pokemon_${pokemonId}`}`,
        pokedex_number: pokemonId,
        name: FRENCH_NAMES[pokemonId] || `Pok√©mon #${pokemonId}`,
        name_en: `pokemon_${pokemonId}`,
        types: typesEn,
        primary_type: typesEn[0],
        rarity: rarity,
        is_legendary: LEGENDARY_IDS.includes(pokemonId),
        is_mythic: MYTHIC_IDS.includes(pokemonId),
        base_chip: stats.base_chip,
        base_mult: stats.base_mult,
        evolution_family_id: getEvolutionFamily(pokemonId),
        evolution_stage: getEvolutionStage(pokemonId),
        evolves_to: null, // √Ä d√©terminer si n√©cessaire
        evolves_from: null, // √Ä d√©terminer si n√©cessaire
        max_copies_in_deck: 3,
        sprite_url: getAnimatedSpriteUrl(pokemonId, false),
        sprite_shiny_url: getAnimatedSpriteUrl(pokemonId, true),
        is_shiny: false,
        is_starter: STARTER_IDS.includes(pokemonId)
    };
}

// Fonction pour g√©n√©rer le deck Kanto complet (70 cartes)
function generateKantoDeck() {
    const deck = [];
    
    // Distribution cible
    const DECK_COMPOSITION = {
        common: 30,      // 10 esp√®ces √ó 3 copies
        uncommon: 18,    // 9 esp√®ces √ó 2 copies
        rare: 12,        // 12 esp√®ces √ó 1 copie
        super_rare: 6,   // 6 esp√®ces √ó 1 copie
        legendary: 4     // 4 l√©gendaires √ó 1 copie
    };
    
    // Pok√©mon prioritaires (starters, iconiques)
    const PRIORITY_SPECIES = [
        // Starters
        { id: 1, copies: 3 }, { id: 2, copies: 3 }, { id: 3, copies: 2 },
        { id: 4, copies: 3 }, { id: 5, copies: 3 }, { id: 6, copies: 2 },
        { id: 7, copies: 3 }, { id: 8, copies: 3 }, { id: 9, copies: 2 },
        // Iconiques
        { id: 25, copies: 3 }, { id: 26, copies: 2 },
        { id: 94, copies: 2 }, { id: 130, copies: 2 }, { id: 149, copies: 1 },
        // L√©gendaires
        { id: 144, copies: 1 }, { id: 145, copies: 1 },
        { id: 146, copies: 1 }, { id: 150, copies: 1 }, { id: 151, copies: 1 }
    ];
    
    // Ajouter prioritaires
    for (const spec of PRIORITY_SPECIES) {
        for (let i = 0; i < spec.copies; i++) {
            deck.push(createCard(spec.id));
        }
    }
    
    // Commons (10 esp√®ces √ó 3 copies)
    const COMMONS = [16, 19, 21, 23, 27, 29, 32, 35, 37, 39, 41, 43, 46, 48, 50, 52, 54, 56, 58, 60, 63, 66, 69, 72, 74, 77, 79, 81, 84, 86, 88, 90, 92, 95, 96, 98, 100, 102, 104, 108, 109, 111, 114, 116, 118, 120, 129];
    let commonCount = 0;
    for (const id of COMMONS) {
        if (commonCount >= 30) break;
        const rarity = determinePokerRarity(id);
        if (rarity === 'common') {
            for (let i = 0; i < 3; i++) {
                deck.push(createCard(id));
                commonCount++;
            }
        }
    }
    
    // Uncommons (9 esp√®ces √ó 2 copies)
    const UNCOMMONS = [13, 14, 17, 20, 22, 24, 28, 30, 33, 36, 38, 40, 42, 44, 47, 49, 51, 53, 55, 57, 61, 64, 67, 70, 73, 75, 78, 82, 85, 87, 89, 93, 97, 99, 101, 105, 106, 107, 110, 117, 119, 133];
    let uncommonCount = 0;
    for (const id of UNCOMMONS) {
        if (uncommonCount >= 18) break;
        const rarity = determinePokerRarity(id);
        if (rarity === 'uncommon') {
            for (let i = 0; i < 2; i++) {
                deck.push(createCard(id));
                uncommonCount++;
            }
        }
    }
    
    // Rares (12 esp√®ces √ó 1 copie)
    const RARES = [3, 6, 9, 12, 15, 18, 31, 34, 45, 59, 62, 65, 68, 71, 76, 80, 83, 91, 103, 112, 113, 121, 122, 134, 135, 136, 137, 139, 141, 147, 148];
    let rareCount = 0;
    for (const id of RARES) {
        if (rareCount >= 12) break;
        const rarity = determinePokerRarity(id);
        if (rarity === 'rare') {
            deck.push(createCard(id));
            rareCount++;
        }
    }
    
    // Super Rares (6 esp√®ces √ó 1 copie)
    const SUPER_RARES = [123, 124, 125, 126, 127, 128, 131, 132, 138, 140, 142, 143, 149];
    let superRareCount = 0;
    for (const id of SUPER_RARES) {
        if (superRareCount >= 6) break;
        const rarity = determinePokerRarity(id);
        if (rarity === 'super_rare') {
            deck.push(createCard(id));
            superRareCount++;
        }
    }
    
    // L√©gendaires (d√©j√† ajout√©s dans PRIORITY_SPECIES)
    // V√©rifier qu'on a bien 4 l√©gendaires
    const legendaryCount = deck.filter(c => c.is_legendary).length;
    if (legendaryCount < 4) {
        const missingLegendaries = LEGENDARY_IDS.filter(id => !deck.some(c => c.pokedex_number === id));
        for (const id of missingLegendaries.slice(0, 4 - legendaryCount)) {
            deck.push(createCard(id));
        }
    }
    
    // M√©langer le deck
    return shuffleDeck(deck);
}

// Fonction pour initialiser le deck permanent si vide
function initializePokerDeck() {
    if (!gameState.poker.permanent_deck || gameState.poker.permanent_deck.length === 0) {
        gameState.poker.permanent_deck = generateKantoDeck();
        saveGame();
    }
}

// ===== POK√â-POKER : D√âTECTION DE COMBINAISONS =====

// Helper : Grouper par esp√®ce
function groupBySpecies(cards) {
    const groups = {};
    cards.forEach(card => {
        const key = card.pokedex_number;
        if (!groups[key]) groups[key] = [];
        groups[key].push(card);
    });
    return groups;
}

// Helper : Grouper par famille d'√©volution
function groupByEvolutionFamily(cards) {
    const families = {};
    cards.forEach(card => {
        if (!families[card.evolution_family_id]) families[card.evolution_family_id] = [];
        families[card.evolution_family_id].push(card);
    });
    return families;
}

// D√©tection High Card (fonctionne avec 1+ carte)
function checkHighCard(cards) {
    if (!cards || cards.length === 0) return null;
    
    // Trier par base_chip pour prendre la meilleure carte
    const sortedCards = [...cards].sort((a, b) => (b.base_chip || 0) - (a.base_chip || 0));
    
    return {
        handType: HAND_TYPES.HIGH_CARD,
        cards: [sortedCards[0]],
        description: `Carte haute (${sortedCards[0].name})`
    };
}

// D√©tection Pair (fonctionne avec 2+ cartes)
function checkPair(cards) {
    if (cards.length < 2) return null;
    
    const groups = groupBySpecies(cards);
    const pairs = Object.values(groups).filter(g => g.length >= 2);
    if (pairs.length > 0) {
        return {
            handType: HAND_TYPES.PAIR,
            cards: pairs[0].slice(0, 2),
            description: `Paire de ${pairs[0][0].name}`
        };
    }
    return null;
}

// D√©tection Two Pair (fonctionne avec 4+ cartes)
function checkTwoPair(cards) {
    if (cards.length < 4) return null;
    
    const groups = groupBySpecies(cards);
    const pairs = Object.values(groups).filter(g => g.length >= 2);
    
    if (pairs.length >= 2) {
        // Trier les paires par base_chip d√©croissant pour prendre les meilleures
        pairs.sort((a, b) => (b[0].base_chip || 0) - (a[0].base_chip || 0));
        
        return {
            handType: HAND_TYPES.TWO_PAIR,
            cards: [...pairs[0].slice(0, 2), ...pairs[1].slice(0, 2)],
            description: `Double Paire (${pairs[0][0].name} + ${pairs[1][0].name})`
        };
    }
    return null;
}

// D√©tection Three of a Kind (fonctionne avec 3+ cartes)
function checkThreeKind(cards) {
    if (cards.length < 3) return null;
    
    const groups = groupBySpecies(cards);
    const triples = Object.values(groups).filter(g => g.length >= 3);
    if (triples.length > 0) {
        // Trier par base_chip pour prendre le meilleur brelan
        triples.sort((a, b) => (b[0].base_chip || 0) - (a[0].base_chip || 0));
        return {
            handType: HAND_TYPES.THREE_KIND,
            cards: triples[0].slice(0, 3),
            description: `Brelan de ${triples[0][0].name}`
        };
    }
    return null;
}

// D√©tection Five of a Kind (5 cartes identiques - le plus fort apr√®s Shiny Flush)
function checkFiveKind(cards) {
    if (cards.length < 5) return null;
    
    const groups = groupBySpecies(cards);
    const quints = Object.values(groups).filter(g => g.length >= 5);
    if (quints.length > 0) {
        return {
            handType: HAND_TYPES.FIVE_KIND,
            cards: quints[0].slice(0, 5),
            description: `Cinq Identiques (${quints[0][0].name})`
        };
    }
    return null;
}

// D√©tection Four of a Kind (fonctionne avec 4+ cartes)
function checkFourKind(cards) {
    if (cards.length < 4) return null;
    
    const groups = groupBySpecies(cards);
    const quads = Object.values(groups).filter(g => g.length >= 4);
    if (quads.length > 0) {
        return {
            handType: HAND_TYPES.FOUR_KIND,
            cards: quads[0].slice(0, 4),
            description: `Carr√© de ${quads[0][0].name}`
        };
    }
    return null;
}

// D√©tection Full House (fonctionne avec 5 cartes)
function checkFullHouse(cards) {
    if (cards.length < 5) return null;
    
    const groups = groupBySpecies(cards);
    const triples = Object.values(groups).filter(g => g.length >= 3);
    const pairs = Object.values(groups).filter(g => g.length >= 2);
    
    if (triples.length > 0 && pairs.length >= 2) {
        const triple = triples[0];
        // Trouver une paire diff√©rente du brelan
        const pair = pairs.find(p => p[0].pokedex_number !== triple[0].pokedex_number);
        
        if (pair) {
            return {
                handType: HAND_TYPES.FULL_HOUSE,
                cards: [...triple.slice(0, 3), ...pair.slice(0, 2)],
                description: `Full House (${triple[0].name} + ${pair[0].name})`
            };
        }
    }
    return null;
}

// D√©tection Straight (5 Pok√©dex cons√©cutifs, n√©cessite 5 cartes)
function checkStraight(cards) {
    if (cards.length < 5) return null;
    
    const sorted = [...cards].sort((a, b) => a.pokedex_number - b.pokedex_number);
    const numbers = sorted.map(c => c.pokedex_number);
    
    // Chercher une s√©quence de 5 cons√©cutifs
    for (let i = 0; i <= numbers.length - 5; i++) {
        let consecutive = 1;
        const sequence = [sorted[i]];
        for (let j = i + 1; j < numbers.length; j++) {
            if (numbers[j] === numbers[j-1] + 1) {
                consecutive++;
                sequence.push(sorted[j]);
                if (consecutive >= 5) {
                    return {
                        handType: HAND_TYPES.STRAIGHT,
                        cards: sequence.slice(0, 5),
                        description: `Suite (${sequence[0].pokedex_number}-${sequence[4].pokedex_number})`
                    };
                }
            } else if (numbers[j] !== numbers[j-1]) {
                break;
            }
        }
    }
    return null;
}

// D√©tection Flush (5 cartes m√™me type primaire, n√©cessite 5 cartes)
function checkFlush(cards) {
    if (cards.length < 5) return null;
    
    const typeCounts = {};
    cards.forEach(c => {
        typeCounts[c.primary_type] = (typeCounts[c.primary_type] || 0) + 1;
    });
    
    for (const [type, count] of Object.entries(typeCounts)) {
        if (count >= 5) {
            const flushCards = cards.filter(c => c.primary_type === type).slice(0, 5);
            return {
                handType: HAND_TYPES.TYPE_FLUSH,
                cards: flushCards,
                description: `Flush ${type}`,
                bonusType: type
            };
        }
    }
    return null;
}

// D√©tection Evolution Chain (accepte 2 ou 3 cartes)
function checkEvolutionChain(cards) {
    const families = groupByEvolutionFamily(cards);
    
    for (const familyCards of Object.values(families)) {
        if (familyCards.length >= 2) {
            // Trier par stage
            familyCards.sort((a, b) => a.evolution_stage - b.evolution_stage);
            
            // V√©rifier si cons√©cutifs (stage 1, 2, 3 ou 1, 2 ou 2, 3)
            let consecutive = 1;
            let startIndex = 0;
            
            for (let i = 1; i < familyCards.length; i++) {
                if (familyCards[i].evolution_stage === familyCards[i-1].evolution_stage + 1) {
                    consecutive++;
                } else if (familyCards[i].evolution_stage !== familyCards[i-1].evolution_stage) {
                    // Nouvelle s√©quence, v√©rifier si la pr√©c√©dente est valide
                    if (consecutive >= 2) {
                        break;
                    }
                    consecutive = 1;
                    startIndex = i;
                }
            }
            
            // Accepter 2 ou 3 cartes cons√©cutives
            if (consecutive >= 2) {
                const chainCards = [];
                let lastStage = -1;
                
                // Trier par pokedex_number pour garantir l'ordre d'√©volution
                const sortedFamily = [...familyCards].sort((a, b) => a.pokedex_number - b.pokedex_number);
                
                for (const card of sortedFamily) {
                    if (lastStage === -1) {
                        // Premi√®re carte
                        chainCards.push(card);
                        lastStage = card.evolution_stage;
                    } else if (card.evolution_stage === lastStage + 1) {
                        // Carte suivante dans l'√©volution
                        chainCards.push(card);
                        lastStage = card.evolution_stage;
                        if (chainCards.length >= 3) break; // Max 3 cartes
                    } else if (card.evolution_stage > lastStage + 1) {
                        // Gap dans l'√©volution, v√©rifier si on a d√©j√† une cha√Æne valide
                        if (chainCards.length >= 2) break;
                        // Sinon recommencer
                        chainCards.length = 0;
                        chainCards.push(card);
                        lastStage = card.evolution_stage;
                    }
                }
                
                if (chainCards.length >= 2) {
                    // Calculer le bonus selon la longueur de la cha√Æne
                    const chainLength = chainCards.length;
                    const baseChip = HAND_TYPES.EVOLUTION_CHAIN.base_chip;
                    const baseMult = HAND_TYPES.EVOLUTION_CHAIN.base_mult;
                    
                    // Scaling : 2 cartes = base, 3 cartes = +50% chips et +1 mult
                    const chipBonus = chainLength === 3 ? baseChip * 0.5 : 0;
                    const multBonus = chainLength === 3 ? 1 : 0;
                    
                    return {
                        handType: HAND_TYPES.EVOLUTION_CHAIN,
                        cards: chainCards,
                        description: chainLength === 3 
                            ? `Cha√Æne d'√©volution compl√®te (${chainCards[0].name} ‚Üí ${chainCards[1].name} ‚Üí ${chainCards[2].name})`
                            : `Cha√Æne d'√©volution (${chainCards[0].name} ‚Üí ${chainCards[1].name})`,
                        chainLength: chainLength,
                        chipBonus: chipBonus,
                        multBonus: multBonus
                    };
                }
            }
        }
    }
    return null;
}

// D√©tection Straight Flush (Evolution Chain + m√™me type, n√©cessite 3+ cartes)
function checkStraightFlush(cards) {
    if (cards.length < 3) return null;
    
    const evoChain = checkEvolutionChain(cards);
    if (!evoChain) return null;
    
    const types = evoChain.cards.map(c => c.primary_type);
    const allSameType = types.every(t => t === types[0]);
    
    if (allSameType && evoChain.cards.length >= 3) {
        return {
            handType: HAND_TYPES.STRAIGHT_FLUSH,
            cards: evoChain.cards,
            description: `Quinte Flush (${evoChain.description})`
        };
    }
    return null;
}

// D√©tection Legendary Trio (fonctionne avec 2+ cartes pour Mew+Mewtwo, 3+ pour les oiseaux)
function checkLegendaryTrio(cards) {
    const LEGENDARY_TRIOS = [
        { ids: [144, 145, 146], name: 'Oiseaux L√©gendaires', minCards: 3 }, // Artikodin, √âlecthor, Sulfura
        { ids: [150, 151], name: 'Mythe et L√©gende', minCards: 2 }         // Mewtwo + Mew
    ];
    
    const pokedexNumbers = cards.map(c => c.pokedex_number);
    
    for (const trio of LEGENDARY_TRIOS) {
        // V√©rifier si on a le minimum de cartes requis
        if (cards.length < trio.minCards) continue;
        
        // V√©rifier si toutes les cartes du trio sont pr√©sentes
        const foundIds = trio.ids.filter(id => pokedexNumbers.includes(id));
        if (foundIds.length === trio.ids.length) {
            const trioCards = cards.filter(c => trio.ids.includes(c.pokedex_number));
            return {
                handType: HAND_TYPES.LEGENDARY_TRIO,
                cards: trioCards,
                description: `${trio.name}!`
            };
        }
    }
    return null;
}

// D√©tection Shiny Flush (n√©cessite 5 cartes shiny)
function checkShinyFlush(cards) {
    if (cards.length < 5) return null;
    
    const shinies = cards.filter(c => c.is_shiny);
    if (shinies.length >= 5) {
        return {
            handType: HAND_TYPES.SHINY_FLUSH,
            cards: shinies.slice(0, 5),
            description: `SHINY FLUSH ‚ú®‚ú®‚ú®`
        };
    }
    return null;
}

// D√©tection de la meilleure main (accepte 1-5 cartes)
function detectBestHand(cards) {
    if (!cards || cards.length === 0) {
        return null;
    }
    
    // Si moins de 5 cartes, on peut d√©tecter certaines combinaisons
    if (cards.length < 5) {
        const checks = [
            checkLegendaryTrio,  // Mew+Mewtwo (2 cartes) ou Oiseaux (3 cartes)
            checkEvolutionChain, // Peut fonctionner avec 2-3 cartes
            checkFourKind,       // Peut fonctionner avec 4 cartes
            checkThreeKind,      // Peut fonctionner avec 3 cartes
            checkTwoPair,        // Peut fonctionner avec 4 cartes
            checkPair,           // Peut fonctionner avec 2 cartes
            checkHighCard
        ];
        
        for (const checkFunc of checks) {
            const result = checkFunc(cards);
            if (result) return result;
        }
        
        return checkHighCard(cards);
    }
    
    // Tester dans l'ordre de rank d√©croissant (du plus fort au plus faible)
    const checks = [
        checkShinyFlush,        // Rank 11 - Le plus fort
        checkFiveKind,          // Rank 9 - 5 cartes identiques
        checkLegendaryTrio,      // Rank 10 - Mew+Mewtwo ou Oiseaux
        checkStraightFlush,      // Rank 9 - Evolution Chain + m√™me type
        checkFourKind,           // Rank 8 - Carr√©
        checkFullHouse,          // Rank 7 - Brelan + Paire
        checkFlush,              // Rank 6 - 5 cartes m√™me type
        checkEvolutionChain,     // Rank 5 - Cha√Æne d'√©volution
        checkStraight,           // Rank 5 - Suite de 5
        checkThreeKind,          // Rank 4 - Brelan
        checkTwoPair,            // Rank 3 - Double Paire
        checkPair,               // Rank 2 - Paire
        checkHighCard            // Rank 1 - Carte haute
    ];
    
    for (const checkFunc of checks) {
        const result = checkFunc(cards);
        if (result) return result;
    }
    
    // Fallback
    return checkHighCard(cards);
}

// ===== POK√â-POKER : SCORING =====

// Calcul du score d'une main selon la nouvelle formule
// HandScore = (BaseChips + SumCardChips + SumPlanetChips) √ó TotalMultiplier
function calculateHandScore(hand, activeJokers, buddy) {
    const run = gameState.poker.current_run;
    if (!run) return { chips: 0, mult: 1, finalScore: 0 };
    
    const handType = hand.handType;
    
    // 1. BASE CHIPS (valeur de combo de base)
    let baseChips = handType.base_chip;
    
    // 2. SUM CARD CHIPS (somme des chips individuels des 5 cartes)
    let sumCardChips = hand.cards.reduce((sum, card) => sum + (card.base_chip || 0), 0);
    
    // 3. SUM PLANET CHIPS (chips additionnels si une Plan√®te active influence la main)
    let sumPlanetChips = 0;
    const activePlanets = run.active_planets || [];
    for (const planet of activePlanets) {
        const planetChips = applyPlanetEffect(planet, hand, 'chips');
        sumPlanetChips += planetChips;
    }
    
    // 4. JOKERS - Flat Chips (ajout√©s avant le multiplicateur)
    let flatChipsFromJokers = 0;
    // Appliquer les jokers dans l'ordre (gauche‚Üídroite)
    for (const joker of activeJokers) {
        const jokerFlatChips = applyJokerEffect(joker, hand, 'flat_chips');
        flatChipsFromJokers += jokerFlatChips;
    }
    
    // Total Chips avant multiplicateur
    const totalChips = baseChips + sumCardChips + sumPlanetChips + flatChipsFromJokers;
    
    // 5. TOTAL MULTIPLIER = (1 + sumMultValue)
    // Les multiplicateurs sont additifs, puis convertis en multiplicateur final
    let sumMultValue = 0;
    
    // A) Base mult du hand type (converti en additif)
    sumMultValue += (handType.base_mult - 1);
    
    // B) Buddy bonus (additif)
    if (buddy && run.buddy_id) {
        sumMultValue += (buddy.level * 0.01); // +1% par level = +0.01 mult
        // Si type match avec flush
        if (hand.bonusType && buddy.primary_type === hand.bonusType) {
            sumMultValue += 0.15; // +15% = +0.15 mult
        }
    }
    
    // C) Jokers actifs (dans l'ordre gauche‚Üídroite)
    for (const joker of activeJokers) {
        const jokerMult = applyJokerEffect(joker, hand, 'mult');
        sumMultValue += jokerMult;
    }
    
    // D) Plan√®tes actives (multiplicateurs)
    for (const planet of activePlanets) {
        const planetMult = applyPlanetEffect(planet, hand, 'mult');
        sumMultValue += planetMult;
    }
    
    // E) Shiny multiplier (additif)
    const shinyCount = hand.cards.filter(c => c.is_shiny).length;
    if (shinyCount > 0) {
        // Chaque shiny = +1 Mult (ou √ó1.5 selon √©quilibrage)
        sumMultValue += shinyCount * 1.0; // +1 Mult par shiny
    }
    
    // F) Ante multiplier (additif)
    sumMultValue += (run.current_ante * 0.05);
    
    // Total Multiplier = (1 + sumMultValue)
    const totalMultiplier = 1 + sumMultValue;
    
    // 6. CALCUL FINAL
    const finalScore = Math.floor(totalChips * totalMultiplier);
    
    return {
        chips: totalChips,
        mult: totalMultiplier,
        finalScore,
        breakdown: {
            baseChips,
            sumCardChips,
            sumPlanetChips,
            flatChipsFromJokers,
            totalChips,
            sumMultValue,
            totalMultiplier,
            shinyCount,
            jokersApplied: activeJokers.length,
            planetsApplied: activePlanets.length
        }
    };
}

// Appliquer l'effet d'une plan√®te
function applyPlanetEffect(planet, hand, effectType) {
    if (!planet || !hand) return 0;
    
    const planetId = planet.id || planet;
    const handType = hand.handType;
    
    // V√©rifier si la plan√®te booste ce type de main
    const planetBoosts = {
        'orb_mercury': HAND_TYPES.PAIR,
        'orb_venus': HAND_TYPES.THREE_KIND,
        'orb_earth': HAND_TYPES.FULL_HOUSE,
        'orb_mars': HAND_TYPES.FOUR_KIND,
        'orb_jupiter': HAND_TYPES.FLUSH,
        'orb_saturn': HAND_TYPES.STRAIGHT,
        'orb_uranus': HAND_TYPES.TWO_PAIR,
        'orb_neptune': HAND_TYPES.STRAIGHT_FLUSH,
        'orb_pluto': HAND_TYPES.HIGH_CARD,
        'orb_x': HAND_TYPES.FIVE_KIND,
        'orb_ceres': null, // Flush House (sp√©cial)
        'orb_eris': null   // Flush Five (sp√©cial)
    };
    
    const boostedHand = planetBoosts[planetId];
    if (!boostedHand || handType !== boostedHand) return 0;
    
    // Retourner les bonus selon le type d'effet
    if (effectType === 'chips') {
        const planetChips = {
            'orb_mercury': 15,
            'orb_venus': 20,
            'orb_earth': 25,
            'orb_mars': 30,
            'orb_jupiter': 15,
            'orb_saturn': 30,
            'orb_uranus': 20,
            'orb_neptune': 40,
            'orb_pluto': 10,
            'orb_x': 35,
            'orb_ceres': 40,
            'orb_eris': 50
        };
        return planetChips[planetId] || 0;
    } else if (effectType === 'mult') {
        const planetMults = {
            'orb_mercury': 1,
            'orb_venus': 2,
            'orb_earth': 2,
            'orb_mars': 3,
            'orb_jupiter': 2,
            'orb_saturn': 3,
            'orb_uranus': 1,
            'orb_neptune': 4,
            'orb_pluto': 1,
            'orb_x': 3,
            'orb_ceres': 4,
            'orb_eris': 3
        };
        return planetMults[planetId] || 0;
    }
    
    return 0;
}

// Application des effets de jokers (nouvelle version)
// Retourne soit des flat chips, soit des multiplicateurs additifs
function applyJokerEffect(joker, hand, effectType) {
    if (!joker || !hand) return 0;
    
    const jokerId = joker.id || joker;
    
    // Retirer jokers √©puis√©s
    if (joker.uses_remaining !== undefined && joker.uses_remaining <= 0) {
        return 0;
    }
    
    // Si effectType est 'flat_chips', retourner les chips plats
    // Si effectType est 'mult', retourner les multiplicateurs additifs
    // Si effectType est l'ancien format (chips, mult), garder la compatibilit√©
    if (effectType === 'flat_chips') {
        return getJokerFlatChips(jokerId, joker, hand);
    } else if (effectType === 'mult') {
        return getJokerMult(jokerId, joker, hand);
    }
    
    // Ancien format (compatibilit√©)
    return { chips: getJokerFlatChips(jokerId, joker, hand), mult: getJokerMult(jokerId, joker, hand) };
}

// Obtenir les flat chips d'un joker
function getJokerFlatChips(jokerId, joker, hand) {
    let flatChips = 0;
    
    switch (jokerId) {
        case 'joker_coin_small':
            flatChips += 200;
            if (joker.uses_remaining !== undefined) joker.uses_remaining--;
            break;
        case 'joker_chip_boost':
            flatChips += 50;
            break;
        case 'joker_trio_heart':
            if (hand.handType === HAND_TYPES.THREE_KIND) {
                flatChips += 20;
            }
            break;
        case 'joker_luck_tuft':
            const evolvedCards = hand.cards.filter(c => (c.evolution_stage || 0) >= 3).length;
            if (evolvedCards > 0) {
                flatChips += 5;
            }
            break;
        case 'joker_rare_boost':
            const rareCards = hand.cards.filter(c => ['rare', 'super_rare', 'legendary'].includes(c.rarity)).length;
            flatChips += rareCards * 50;
            break;
        case 'joker_legendary_boost':
            const legendaries = hand.cards.filter(c => c.rarity === 'legendary').length;
            flatChips += legendaries * 200;
            break;
        case 'joker_four_kind_master':
            if (hand.handType === HAND_TYPES.FOUR_KIND) {
                // Multiplicatif, pas flat chips
            }
            break;
        case 'joker_pair_boost':
            if (hand.handType === HAND_TYPES.PAIR || hand.handType === HAND_TYPES.TWO_PAIR) {
                flatChips += 100;
            }
            break;
    }
    
    return flatChips;
}

// Obtenir les multiplicateurs additifs d'un joker
function getJokerMult(jokerId, joker, hand) {
    let multAdd = 0;
    
    switch (jokerId) {
        // COMMON
        case 'joker_small_mult':
            multAdd += 2;
            break;
        case 'ember_sigil':
            const fireCards = hand.cards.filter(c => c.primary_type === 'Fire' || (c.types && c.types.includes('Feu'))).length;
            multAdd += fireCards * 4;
            break;
        case 'torrent_mark':
            const waterCards = hand.cards.filter(c => c.primary_type === 'Water' || (c.types && c.types.includes('Eau'))).length;
            multAdd += waterCards * 4;
            break;
        case 'verdant_seal':
            const grassCards = hand.cards.filter(c => c.primary_type === 'Grass' || (c.types && c.types.includes('Plante'))).length;
            multAdd += grassCards * 4;
            break;
        case 'spark_emblem':
            const electricCards = hand.cards.filter(c => c.primary_type === 'Electric' || (c.types && c.types.includes('√âlectrik'))).length;
            multAdd += electricCards * 4;
            break;
        case 'aerial_token':
            const flyingCards = hand.cards.filter(c => c.primary_type === 'Flying' || (c.types && c.types.includes('Vol'))).length;
            multAdd += flyingCards * 3;
            break;
        case 'pair_boost':
            const pairCount = hand.handType === HAND_TYPES.TWO_PAIR ? 2 : (hand.handType === HAND_TYPES.PAIR ? 1 : 0);
            multAdd += pairCount * 6;
            break;
        case 'flush_hint':
            if (hand.handType === HAND_TYPES.STRAIGHT_FLUSH) {
                multAdd += 10;
            }
            break;
        case 'pinch_jewel':
            // V√©rifier si exactement 3 cartes du m√™me type
            const typeGroups = {};
            hand.cards.forEach(c => {
                const type = c.primary_type || c.types?.[0] || 'Normal';
                typeGroups[type] = (typeGroups[type] || 0) + 1;
            });
            const hasThreeOfType = Object.values(typeGroups).some(count => count === 3);
            if (hasThreeOfType) {
                multAdd += 8;
            }
            break;
        case 'novice_banner':
            // +1 Mult par main jou√©e dans ce blind (g√©r√© ailleurs)
            multAdd += 0; // Sera g√©r√© par le syst√®me de comptage
            break;
        
        // UNCOMMON
        case 'joker_mult_x2':
            // Multiplicatif, pas additif - √† g√©rer s√©par√©ment
            break;
        case 'joker_type_fire':
            const fireCards2 = hand.cards.filter(c => c.primary_type === 'Fire' || (c.types && c.types.includes('Feu'))).length;
            multAdd += fireCards2 * 3;
            break;
        case 'joker_type_water':
            const waterCards2 = hand.cards.filter(c => c.primary_type === 'Water' || (c.types && c.types.includes('Eau'))).length;
            multAdd += waterCards2 * 3;
            break;
        case 'joker_type_grass':
            const grassCards2 = hand.cards.filter(c => c.primary_type === 'Grass' || (c.types && c.types.includes('Plante'))).length;
            multAdd += grassCards2 * 3;
            break;
        case 'joker_flush_boost':
            if (hand.handType === HAND_TYPES.FLUSH || hand.handType === HAND_TYPES.TYPE_FLUSH) {
                // √ó1.5 = +0.5 mult additif
                multAdd += 0.5;
            }
            break;
        case 'joker_common_boost':
            const commonCards = hand.cards.filter(c => c.rarity === 'common').length;
            multAdd += commonCards * 5;
            break;
        case 'joker_chip_mult_balance':
            multAdd += 5;
            break;
        case 'joker_lucky_star':
            if (Math.random() < 0.2) {
                // √ó3 = +2 mult additif
                multAdd += 2;
            }
            break;
        
        // RARE
        case 'joker_triple_mult':
            // √ó3 = +2 mult additif
            multAdd += 2;
            if (joker.uses_remaining !== undefined) joker.uses_remaining--;
            break;
        case 'joker_type_master':
            if (hand.handType === HAND_TYPES.TYPE_FLUSH) {
                // √ó2 = +1 mult additif
                multAdd += 1;
            }
            break;
        case 'joker_full_house_king':
            if (hand.handType === HAND_TYPES.FULL_HOUSE) {
                // √ó2.5 = +1.5 mult additif
                multAdd += 1.5;
            }
            break;
        case 'joker_ante_rush':
            const antesCleared = gameState.poker.current_run.current_ante - 1;
            multAdd += antesCleared * 0.1;
            break;
        
        // SUPER RARE
        case 'joker_shiny_surge':
            const shinies = hand.cards.filter(c => c.is_shiny).length;
            if (shinies > 0) {
                // √ó2 par shiny = +1 mult additif par shiny
                multAdd += shinies * 1;
            }
            break;
        
        // LEGENDARY
        case 'joker_arceus_blessing':
            // √ó10 = +9 mult additif
            multAdd += 9;
            break;
    }
    
    return multAdd;
}

// ===== POK√â-POKER : BOUCLE DE JEU =====

// Calculer la cible d'un blind
function calculateBlindTarget(ante, blindType) {
    const anteConfig = getAnteConfig(ante);
    if (!anteConfig) return 500;
    
    const blindConfig = anteConfig.blinds.find(b => b.type === blindType);
    if (!blindConfig) return 500;
    
    return blindConfig.target_base;
}

// G√©rer le Skip d'un Blind
function handleBlindSkip(blindType) {
    const run = gameState.poker.current_run;
    if (!run || !run.active) return;
    
    // Les boss blinds ne peuvent PAS √™tre skipp√©s
    if (blindType === 'boss') {
        showToast('‚ùå Les Boss Blinds ne peuvent pas √™tre skipp√©s !', 'error');
        return;
    }
    
    // V√©rifier que le blind est accessible
    const blindOrder = ['small', 'big', 'boss'];
    const blindIndex = blindOrder.indexOf(blindType);
    if (blindIndex > 0) {
        const previousBlind = blindOrder[blindIndex - 1];
        if (!run.blinds_status || !run.blinds_status[previousBlind]) {
            showToast('Vous devez compl√©ter le blind pr√©c√©dent d\'abord', 'error');
            return;
        }
    }
    
    // Calculer r√©compense skip
    const target = calculateBlindTarget(run.current_ante, blindType);
    const skipReward = {
        coins: Math.floor(target * 0.3),
        xp: blindType === 'small' ? 50 : blindType === 'big' ? 75 : 100
    };
    
    // Cr√©diter les r√©compenses
    run.chips += skipReward.coins;
    gameState.xp += skipReward.xp;
    checkLevelUp();
    
    // Marquer le blind comme skipp√© (pas compl√©t√©, juste skipp√©)
    if (!run.blinds_status) run.blinds_status = { small: false, big: false, boss: false };
    run.blinds_status[blindType] = 'skipped';
    
    // Animation
    showToast(`‚è≠Ô∏è Blind ${blindType} skipp√© ! +${skipReward.coins}üí∞ +${skipReward.xp}‚≠ê`, 'success');
    
    // Passer au blind suivant ou √† l'ante suivant si boss
    if (blindType === 'boss') {
        // Compl√©ter l'ante
        if (run.current_ante < 8) {
            run.current_ante++;
            run.blinds_status = { small: false, big: false, boss: false };
            showToast(`üéâ Ante ${run.current_ante - 1} compl√©t√© ! Passage √† l'Ante ${run.current_ante}`, 'success');
        } else {
            completePokerRun();
        }
    } else {
        // Passer au blind suivant
        const nextBlind = blindType === 'small' ? 'big' : 'boss';
        // Le joueur peut maintenant acc√©der au blind suivant
    }
    
    saveGame();
    renderPokerPage();
}

// G√©rer le Fight d'un Blind
function handleBlindFight(blindType) {
    const run = gameState.poker.current_run;
    if (!run || !run.active) return;
    
    // V√©rifier que le blind est accessible
    const blindOrder = ['small', 'big', 'boss'];
    const blindIndex = blindOrder.indexOf(blindType);
    if (blindIndex > 0) {
        const previousBlind = blindOrder[blindIndex - 1];
        if (!run.blinds_status || !run.blinds_status[previousBlind]) {
            showToast('Vous devez compl√©ter le blind pr√©c√©dent d\'abord', 'error');
            return;
        }
    }
    
    // Initialiser le blind
    run.current_blind = blindType;
    run.blind_target_score = calculateBlindTarget(run.current_ante, blindType);
    run.blind_current_score = 0;
    run.hands_played_this_blind = [];
    run.hands_remaining = 3; // Par d√©faut 3 mains par blind
    run.discards_remaining = 3; // 3 d√©fausses par main
    run.blind_in_progress = true;
    
    // Reshuffle deck si n√©cessaire
    if (run.deck.length < 9) {
        run.deck = shuffleDeck([...run.deck, ...run.discard_pile]);
        run.discard_pile = [];
    }
    
    saveGame();
    renderPokerPage();
}

// Afficher les d√©tails d'un Blind
function showBlindDetails(blindType) {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const anteConfig = getAnteConfig(run.current_ante);
    const target = calculateBlindTarget(run.current_ante, blindType);
    
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98)); 
                    padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; 
                    border: 2px solid rgba(255, 215, 0, 0.3);">
            <h2 style="color: #ffd700; margin-bottom: 20px; text-align: center;">
                ${blindType === 'small' ? 'Small Blind' : blindType === 'big' ? 'Big Blind' : 'Boss Blind'} - D√©tails
            </h2>
            <div style="color: white; line-height: 1.8;">
                <div style="margin-bottom: 15px;">
                    <strong>Score cible:</strong> ${formatNumber(target)}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Mains autoris√©es:</strong> 3 (par d√©faut)
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>D√©fausses par main:</strong> 3
                </div>
                ${blindType === 'boss' ? `
                    <div style="background: rgba(255, 0, 0, 0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>Boss:</strong> ${anteConfig.boss_name}<br>
                        <strong>Modificateur:</strong> ${anteConfig.boss_modifier}
                    </div>
                ` : ''}
                <div style="margin-bottom: 15px;">
                    <strong>Jokers actifs:</strong> ${run.active_jokers.length} / 2
                </div>
            </div>
            <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                    class="btn btn--primary" 
                    style="width: 100%; margin-top: 20px; padding: 12px;">
                Fermer
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

// D√©marrer une run Pok√©-Poker
function startPokerRun(buddyId = null) {
    if (isPokerRunActive()) {
        showToast('Une run est d√©j√† en cours !', 'error');
        return;
    }
    
    // Initialiser le deck si n√©cessaire
    initializePokerDeck();
    
    // Cr√©er nouvelle run
    gameState.poker.current_run = {
        active: true,
        run_id: 'run_' + Date.now(),
        start_time: Date.now(),
        current_ante: 1,
        current_blind: null,
        blinds_cleared: 0,
        blinds_status: { small: false, big: false, boss: false },
        initial_deck: deepClone(gameState.poker.permanent_deck), // Deck initial de la run (ne change jamais)
        deck: shuffleDeck(deepClone(gameState.poker.permanent_deck)),
        discard_pile: [],
        played_cards: [],
        bought_cards_this_run: [], // Cartes achet√©es via boosters (persistentes pour la run)
        chips: 100 + (gameState.poker.meta_upgrades.starting_chips_bonus || 0),
        hands_remaining: 3,
        discards_remaining: 3,
        active_jokers: [],
        active_planets: [], // Plan√®tes actives
        buddy_id: buddyId || gameState.buddy?.activeBuddyId || null,
        buddy_bonus_mult: 1.0,
        blind_target_score: 0,
        blind_current_score: 0,
        blind_in_progress: false,
        hands_played_this_blind: [],
        ante_coupon_used: {}, // Track des coupons utilis√©s par Ante
        rewards: {
            chips_earned: 0,
            cards_unlocked: [],
            jokers_found: [],
            shards: 0,
            shiny_tokens: 0
        }
    };
    
    // Calculer bonus Buddy
    if (gameState.poker.current_run.buddy_id) {
        const buddy = gameState.buddy.buddies[gameState.poker.current_run.buddy_id];
        if (buddy) {
            gameState.poker.current_run.buddy_bonus_mult = 1 + (buddy.level * 0.01);
        }
    }
    
    // Log analytics
    gameState.poker.runs_started++;
    
    // Afficher UI (sera impl√©ment√© plus tard)
    // renderPokerRunScreen();
    
    showToast('üé¥ Run Pok√©-Poker d√©marr√©e !', 'success');
    saveGame();
}

// Piocher une main (9 cartes par d√©faut)
function drawHand() {
    const run = gameState.poker.current_run;
    if (!run) return [];
    
    // Nombre de cartes √† piocher (base 9 + upgrades)
    const drawCount = 9 + (gameState.poker.meta_upgrades?.extra_card_draw || 0);
    const drawnCards = [];
    
    for (let i = 0; i < drawCount; i++) {
        // Si deck vide, reshuffle discard
        if (run.deck.length === 0) {
            if (run.discard_pile.length === 0) {
                showToast('Deck √©puis√© !', 'error');
                break;
            }
            run.deck = shuffleDeck([...run.discard_pile]);
            run.discard_pile = [];
            showToast('üîÑ Deck reshuffled!', 'info');
        }
        
        if (run.deck.length > 0) {
            drawnCards.push(run.deck.pop());
        }
    }
    
    return drawnCards;
}

// Calculer les 4 meilleures mains candidates √† partir de 9 cartes
function calculateSuggestedHands(cards) {
    if (cards.length < 5) return [];
    
    const suggestions = [];
    
    // G√©n√©rer toutes les combinaisons possibles de 5 cartes parmi les 9
    const combinations = getCombinations(cards, 5);
    
    // Calculer le score estim√© pour chaque combinaison
    const scoredHands = combinations.map(combo => {
        const hand = detectBestHand(combo);
        if (!hand) return null;
        
        // Estimation rapide du score (sans jokers pour la suggestion)
        const estimatedScore = estimateHandScore(hand);
        
        return {
            cards: combo,
            hand: hand,
            estimatedScore: estimatedScore
        };
    }).filter(h => h !== null);
    
    // Trier par score estim√© d√©croissant
    scoredHands.sort((a, b) => b.estimatedScore - a.estimatedScore);
    
    // Retourner les 4 meilleures
    return scoredHands.slice(0, 4).map((sh, index) => ({
        index: index + 1,
        cards: sh.cards,
        hand: sh.hand,
        estimatedScore: sh.estimatedScore,
        description: sh.hand.description
    }));
}

// G√©n√©rer toutes les combinaisons de k √©l√©ments parmi n
function getCombinations(arr, k) {
    if (k === 1) return arr.map(x => [x]);
    if (k === arr.length) return [arr];
    
    const combinations = [];
    for (let i = 0; i <= arr.length - k; i++) {
        const head = arr[i];
        const tailCombos = getCombinations(arr.slice(i + 1), k - 1);
        tailCombos.forEach(combo => {
            combinations.push([head, ...combo]);
        });
    }
    return combinations;
}

// Estimation rapide du score d'une main (sans jokers)
function estimateHandScore(hand) {
    if (!hand || !hand.handType) return 0;
    
    const baseChips = hand.handType.base_chip || 0;
    const cardChips = hand.cards.reduce((sum, card) => sum + (card.base_chip || 0), 0);
    const baseMult = hand.handType.base_mult || 1;
    
    // Estimation simple : (base + cards) * mult
    return Math.floor((baseChips + cardChips) * baseMult);
}

// S√©lectionner des cartes (5 max)
function selectCards(drawnCards, selectedIndices) {
    if (selectedIndices.length > 5) {
        showToast('‚ùå Maximum 5 cartes', 'error');
        return null;
    }
    
    const selectedCards = selectedIndices.map(i => drawnCards[i]);
    const discardedCards = drawnCards.filter((_, i) => !selectedIndices.includes(i));
    
    return {
        selectedCards,
        discardedCards
    };
}

// D√©fausser et repiocher
function discardAndRedraw(drawnCards, discardIndices) {
    const run = gameState.poker.current_run;
    if (!run) return null;
    
    if (run.discards_remaining <= 0) {
        showToast('‚ùå Plus de d√©fausses disponibles', 'error');
        return null;
    }
    
    run.discards_remaining--;
    
    // D√©fausser
    const discarded = discardIndices.map(i => drawnCards[i]);
    run.discard_pile.push(...discarded);
    
    // Piocher nouvelles cartes
    const newCards = [];
    for (let i = 0; i < discarded.length; i++) {
        if (run.deck.length === 0) {
            if (run.discard_pile.length === 0) break;
            run.deck = shuffleDeck([...run.discard_pile]);
            run.discard_pile = [];
        }
        if (run.deck.length > 0) {
            newCards.push(run.deck.pop());
        }
    }
    
    // Remplacer dans main
    let newIndex = 0;
    const newHand = drawnCards.map((card, i) => {
        if (discardIndices.includes(i)) {
            return newCards[newIndex++];
        }
        return card;
    });
    
    return newHand;
}

// Jouer une main s√©lectionn√©e
function playSelectedHand(selectedCards) {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    if (selectedCards.length < 1 || selectedCards.length > 5) {
        showToast('S√©lectionnez entre 1 et 5 cartes', 'error');
        return;
    }
    
    // D√©tecter la meilleure combinaison
    const hand = detectBestHand(selectedCards);
    
    // R√©cup√©rer Buddy si assign√©
    const buddy = run.buddy_id ? gameState.buddy.buddies[run.buddy_id] : null;
    
    // Calculer le score
    const scoreResult = calculateHandScore(hand, run.active_jokers, buddy);
    
    // Mettre √† jour le score du blind
    run.blind_current_score += scoreResult.finalScore;
    run.hands_remaining--;
    
    // Enregistrer la main jou√©e
    run.hands_played_this_blind.push({
        hand: hand,
        score: scoreResult,
        cards: selectedCards
    });
    
    // D√©fausser les cartes jou√©es
    run.discard_pile.push(...selectedCards);
    run.played_cards.push(...selectedCards);
    
    // Retirer les cartes jou√©es de pokerDrawnCards (en ordre d√©croissant pour √©viter les probl√®mes d'index)
    const selectedIndices = [...pokerSelectedCardIndices].sort((a, b) => b - a);
    selectedIndices.forEach(index => {
        if (index >= 0 && index < pokerDrawnCards.length) {
            pokerDrawnCards.splice(index, 1);
        }
    });
    
    // Piocher de nouvelles cartes pour remplacer celles jou√©es
    const cardsToDraw = selectedCards.length;
    for (let i = 0; i < cardsToDraw; i++) {
        if (run.deck.length === 0) {
            if (run.discard_pile.length === 0) break;
            run.deck = shuffleDeck([...run.discard_pile]);
            run.discard_pile = [];
        }
        if (run.deck.length > 0) {
            pokerDrawnCards.push(run.deck.pop());
        }
    }
    
    // R√©initialiser la s√©lection
    pokerSelectedCardIndices = [];
    
    // Stats globales
    gameState.poker.total_hands_played++;
    if (scoreResult.finalScore > gameState.poker.best_single_hand_score) {
        gameState.poker.best_single_hand_score = scoreResult.finalScore;
    }
    
    // V√©rifier combos l√©gendaires
    if (hand.handType === HAND_TYPES.LEGENDARY_TRIO) {
        gameState.poker.legendary_combos_hit++;
    }
    
    // Buddy XP
    if (run.buddy_id && buddy) {
        const buddyXP = 5 + Math.floor(scoreResult.finalScore / 1000);
        addBuddyXP(buddyXP);
    }
    
    // V√©rifier Shiny Tokens
    checkShinyTokenRewards(hand, scoreResult);
    
    saveGame();
    
    // V√©rifier si le blind est compl√©t√©
    const blindComplete = run.blind_current_score >= run.blind_target_score;
    if (blindComplete) {
        completeBlind();
    } else if (run.hands_remaining <= 0) {
        // Plus de mains et score insuffisant = √©chec
        failRun();
    }
    
    // Retourner le r√©sultat pour l'affichage
    return {
        hand,
        score: scoreResult,
        blindComplete: blindComplete,
        handsRemaining: run.hands_remaining
    };
}

// Fonction pour v√©rifier les r√©compenses Shiny Tokens
function checkShinyTokenRewards(hand, scoreResult) {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const shinies = hand.cards.filter(c => c.is_shiny).length;
    
    // 1 shiny dans main = 5 tokens
    if (shinies === 1) {
        awardPokerShinyTokens(5, 'Shiny in hand');
    }
    
    // 2+ shinies = 15 tokens
    if (shinies >= 2) {
        awardPokerShinyTokens(15, 'Multiple Shinies');
    }
    
    // Shiny Flush = 100 tokens
    if (hand.handType === HAND_TYPES.SHINY_FLUSH) {
        awardPokerShinyTokens(100, 'SHINY FLUSH');
    }
    
    // Score > 10,000 = 10 tokens
    if (scoreResult.finalScore > 10000) {
        awardPokerShinyTokens(10, 'High score');
    }
}

// Fonction pour attribuer des Shiny Tokens dans Pok√©-Poker
function awardPokerShinyTokens(amount, reason) {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    run.rewards.shiny_tokens += amount;
    if (!gameState.rogue) gameState.rogue = { totalShinyTokens: 0 };
    gameState.rogue.totalShinyTokens = (gameState.rogue.totalShinyTokens || 0) + amount;
    
    showToast(`üíé +${amount} Shiny Tokens (${reason})`, 'success');
    saveGame();
}

// Compl√©ter un blind
function completeBlind() {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    if (run.blind_current_score < run.blind_target_score) {
        // V√©rifier si on a encore des mains
        if (run.hands_remaining <= 0) {
            return failRun();
        }
        // Sinon, on peut continuer √† jouer
        return;
    }
    
    // Succ√®s - le blind a √©t√© combattu (pas skipp√©)
    run.blinds_cleared++;
    
    // Marquer le blind comme compl√©t√©
    if (!run.blinds_status) run.blinds_status = { small: false, big: false, boss: false };
    run.blinds_status[run.current_blind] = true;
    
    // Rewards
    const chipsEarned = Math.floor((run.blind_current_score - run.blind_target_score) * 0.5);
    run.chips += chipsEarned;
    run.rewards.chips_earned += chipsEarned;
    
    const previousBlind = run.current_blind;
    const previousAnte = run.current_ante;
    let badgeUnlocked = false;
    const wasBossBlind = run.current_blind === 'boss';
    
    // Reshuffle le deck (discard ‚Üí deck) mais garder les cartes achet√©es
    // IMPORTANT : Le deck doit contenir TOUTES les cartes (deck initial + achet√©es)
    
    // 1. R√©cup√©rer le deck initial de la run (ne change jamais)
    const initialDeck = deepClone(run.initial_deck || gameState.poker.permanent_deck || []);
    
    // 2. Ajouter les cartes achet√©es cette run (nouvelles cartes des boosters)
    const boughtCards = run.bought_cards_this_run || [];
    
    // 3. R√©cup√©rer les cartes actuellement en main (pokerDrawnCards) - elles doivent √™tre remises dans le deck
    const cardsInHand = [...pokerDrawnCards];
    
    // 4. R√©cup√©rer les cartes d√©fauss√©es
    const discardedCards = [...run.discard_pile];
    
    // 5. R√©cup√©rer les cartes restantes dans le deck
    const remainingDeck = [...run.deck];
    
    // 6. Combiner TOUT : deck initial + cartes achet√©es + cartes en main + d√©fauss√©es + restantes
    // Note : Les cartes peuvent √™tre en plusieurs endroits (en main ET dans discard), donc on doit d√©dupliquer
    const allCards = [
        ...initialDeck, // Deck initial (base)
        ...boughtCards, // Nouvelles cartes achet√©es
        ...cardsInHand, // Cartes actuellement pioch√©es (doivent retourner au deck)
        ...discardedCards, // Cartes d√©fauss√©es (doivent retourner au deck)
        ...remainingDeck // Cartes restantes dans le deck
    ];
    
    // 7. Retirer les doublons en utilisant une cl√© unique par carte
    // Une carte = un exemplaire unique (m√™me si elle peut √™tre shiny ou non)
    const uniqueCards = [];
    const seenCardKeys = new Set();
    
    allCards.forEach(card => {
        if (!card || !card.id) return; // Ignorer les cartes invalides
        
        // Cl√© unique : id + pokedex_number + shiny status
        const cardKey = `${card.pokedex_number || card.id}_${card.is_shiny ? 'shiny' : 'normal'}`;
        
        if (!seenCardKeys.has(cardKey)) {
            seenCardKeys.add(cardKey);
            uniqueCards.push(card);
        }
    });
    
    // 8. Reshuffle tout le deck
    run.deck = shuffleDeck(uniqueCards);
    run.discard_pile = [];
    
    // 9. R√©initialiser les cartes en main
    pokerDrawnCards = [];
    
    // Log pour debug
    if (run.deck.length === 0) {
        console.error('ERREUR: Deck vide apr√®s reshuffle!', {
            initial: initialDeck.length,
            bought: boughtCards.length,
            inHand: cardsInHand.length,
            discarded: discardedCards.length,
            remaining: remainingDeck.length
        });
    }
    
    // Si c'est le boss blind
    if (wasBossBlind) {
        // Badge gagn√©
        const badge = `badge_${run.current_ante}`;
        if (!gameState.poker.badges_earned.includes(badge)) {
            gameState.poker.badges_earned.push(badge);
            gameState.poker.highest_ante = Math.max(gameState.poker.highest_ante, run.current_ante);
            badgeUnlocked = true;
        }
        
        // Buddy XP
        if (run.buddy_id) {
            const buddyXP = 100 * run.current_ante;
            addBuddyXP(buddyXP);
        }
        
        // R√©compense d'Ante
        const anteReward = {
            coins: 1000 * run.current_ante,
            shards: 50 + (run.current_ante * 10),
            xp: 200 * run.current_ante
        };
        gameState.coins += anteReward.coins;
        gameState.shards = (gameState.shards || 0) + anteReward.shards;
        gameState.xp += anteReward.xp;
        checkLevelUp();
        
        // Passer √† l'ante suivant
        if (run.current_ante < 8) {
            run.current_ante++;
            run.blinds_status = { small: false, big: false, boss: false };
            run.current_blind = null; // Retour au lobby
            run.blind_in_progress = false;
        } else {
            // Tous les antes compl√©t√©s - compl√©ter la run
            gameState.poker.league_unlocked = true;
            completePokerRun();
            return;
        }
    } else {
        // Passer au blind suivant (retour au lobby)
        run.current_blind = null;
        run.blind_in_progress = false;
    }
    
    // Reset blind stats
    run.hands_remaining = 3;
    run.discards_remaining = 3;
    run.blind_current_score = 0;
    run.hands_played_this_blind = [];
    run.blind_target_score = 0;
    
    // R√©initialiser les cartes pioch√©es
    pokerDrawnCards = [];
    pokerSelectedCardIndices = [];
    
    saveGame();
    
    // Afficher √©cran de r√©cap du blind
    showBlindCompleteScreen(previousBlind, previousAnte, chipsEarned, wasBossBlind, () => {
        // Apr√®s fermeture du r√©cap, ouvrir le shop si le blind a √©t√© combattu (pas skipp√©)
        const blindStatus = run.blinds_status[previousBlind];
        if (blindStatus === true) { // true = compl√©t√© par combat, 'skipped' = skipp√©
            // Le shop s'ouvre apr√®s chaque blind r√©ussi
            generateShopOffers();
            openPokerShop();
        } else {
            // Blind skipp√©, pas de shop
            showToast('Blind skipp√© - pas d\'acc√®s au shop', 'info');
            // Retourner au lobby
            setTimeout(() => {
                renderPokerPage();
            }, 100);
        }
    });
    
    // Note: Le r√©cap d'Ante sera affich√© apr√®s la fermeture du shop si c'√©tait un boss blind
    // (g√©r√© dans closePokerShop)
}

// √âchouer une run
window.failRun = function() {
    const run = gameState.poker.current_run;
    if (!run) {
        console.error("failRun appel√© mais gameState.poker.current_run n'existe pas");
        return;
    }
    
    console.log("failRun appel√©, run:", run);
    
    // Consolation rewards
    const consolationChips = Math.floor((run.chips || 0) * 0.2);
    const consolationShards = Math.max(1, Math.floor((run.blinds_cleared || 0) / 3));
    
    gameState.coins += consolationChips;
    gameState.shards = (gameState.shards || 0) + consolationShards;
    
    // Conversion des chips gagn√©s en Processor Chips (1 chip = 1 Processor Chip)
    // Utiliser run.rewards.chips_earned si disponible, sinon calculer depuis run.chips
    let chipsEarned = (run.rewards && run.rewards.chips_earned) ? run.rewards.chips_earned : 0;
    
    // Si chips_earned est 0 mais que run.chips a augment√©, calculer la diff√©rence
    if (chipsEarned === 0 && run.chips) {
        // Essayer d'utiliser starting_chips si disponible (depuis React)
        const startingChips = run.starting_chips || (100 + (gameState.poker.meta_upgrades?.starting_chips_bonus || 0));
        const currentChips = run.chips;
        if (currentChips > startingChips) {
            chipsEarned = currentChips - startingChips;
            console.log(`Chips calcul√©s: ${currentChips} - ${startingChips} = ${chipsEarned}`);
        }
    }
    
    console.log(`Chips gagn√©s calcul√©s: ${chipsEarned}`);
    
    let processorChipsEarned = 0;
    if (chipsEarned > 0) {
        if (!gameState.inventory.processor_chips) gameState.inventory.processor_chips = 0;
        gameState.inventory.processor_chips += chipsEarned;
        processorChipsEarned = chipsEarned;
        console.log(`Processor Chips ajout√©s: ${processorChipsEarned}`);
    } else {
        console.warn("Aucun chip gagn√© d√©tect√©, pas de conversion en Processor Chips");
    }
    
    // Stats
    const runDuration = run.start_time ? (Date.now() - run.start_time) : 0;
    const runData = {
        ante_reached: run.current_ante || 1,
        blinds_cleared: run.blinds_cleared || 0,
        hands_played: (run.hands_played_this_blind && run.hands_played_this_blind.length) ? run.hands_played_this_blind.length + ((run.current_ante || 1) - 1) * 9 : 0,
        total_score: run.blind_current_score || 0,
        duration: runDuration,
        failed: true,
        chips_earned: chipsEarned,
        processor_chips_earned: processorChipsEarned
    };
    
    // Cleanup
    finalizeRun(runData);
    
    // Sauvegarder avant d'afficher l'√©cran
    saveGame();
    
    // Afficher l'√©cran de game over avec Porygon
    showPokerGameOverScreen(runData);
};

// Fonction pour afficher l'√©cran de game over avec Porygon
function showPokerGameOverScreen(runData) {
    const chipsEarned = runData.chips_earned || 0;
    const processorChipsEarned = runData.processor_chips_earned || 0;
    
    // Si des chips ont √©t√© gagn√©s, afficher l'√©cran avec Porygon
    if (chipsEarned > 0 && processorChipsEarned > 0) {
        // Cr√©er un dialogue personnalis√© pour la conversion
        const customDialogue = {
            id: 'poker_chips_conversion_custom',
            lines: [
                "ANALYSE TERMIN√âE...",
                `Les donn√©es de la run ont √©t√© extraites.`,
                `Tu as gagn√© ${chipsEarned.toLocaleString()} chips pendant cette session.`,
                "Conversion effectu√©e : 1 chip = 1 Processor Chip.",
                `Tu as re√ßu ${processorChipsEarned.toLocaleString()} Processor Chips.`,
                "Ces ressources peuvent √™tre utilis√©es dans le Centre de Recherche.",
                "M√™me dans l'√©chec, les donn√©es collect√©es sont pr√©cieuses."
            ]
        };
        
        // Afficher le dialogue Porygon
        setTimeout(() => {
            showPorygonChipsConversionDialogue(customDialogue);
        }, 500);
    } else {
        // Pas de chips gagn√©s, afficher juste le toast classique
        const consolationChips = Math.floor((gameState.poker.current_run?.chips || 0) * 0.2);
        showToast(`üíî Run √©chou√©e ! +${consolationChips}üí∞`, 'error');
    }
}

// Fonction pour afficher le dialogue Porygon sur la conversion des chips
function showPorygonChipsConversionDialogue(dialogue) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10001; display: flex; align-items: center; justify-content: center;';
    
    const chipsEarned = parseInt(dialogue.lines[2].match(/[\d,]+/)?.[0].replace(/,/g, '') || 0);
    const processorChipsEarned = parseInt(dialogue.lines[4].match(/[\d,]+/)?.[0].replace(/,/g, '') || 0);
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98)); 
                    border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; 
                    border: 3px solid #7d5fff; text-align: center; position: relative;">
            <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 120px; height: 120px;">
                <img src="${getAnimatedSpriteUrl(474, false)}" 
                     style="width: 100%; height: 100%; image-rendering: pixelated; filter: drop-shadow(0 0 20px rgba(125, 95, 255, 0.8));">
            </div>
            
            <h2 style="color: #a855f7; margin-bottom: 20px; font-size: 2em; text-shadow: 0 0 20px rgba(168, 85, 247, 0.5);">
                üíî Run √âchou√©e
            </h2>
            
            <div style="background: rgba(0,0,0,0.4); border-radius: 15px; padding: 30px; margin-bottom: 30px; min-height: 200px; display: flex; flex-direction: column; justify-content: center;">
                <div style="color: white; font-size: 1.1em; line-height: 1.8; margin-bottom: 20px; font-family: 'VT323', monospace;">
                    ${dialogue.lines.map((line, idx) => `
                        <div style="margin-bottom: ${idx < dialogue.lines.length - 1 ? '15px' : '0'}; 
                                    animation: fadeIn 0.5s ease ${idx * 0.3}s both;">
                            ${line}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="background: rgba(255, 215, 0, 0.2); border: 2px solid #FFD700; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="color: #FFD700; font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                    üí∞ Chips Gagn√©s : ${chipsEarned.toLocaleString()}
                </div>
                <div style="color: #20d5d2; font-size: 1.5em; font-weight: bold;">
                    üîß Processor Chips Re√ßus : ${processorChipsEarned.toLocaleString()}
                </div>
            </div>
            
            <button onclick="this.closest('.modal').remove(); saveGame();" 
                    class="btn btn--primary" 
                    style="padding: 15px 40px; font-size: 1.2em; font-weight: 700; background: linear-gradient(135deg, #7d5fff, #a855f7);">
                Compris
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Animation fadeIn pour les lignes
    if (!document.getElementById('porygon-chips-animation-style')) {
        const style = document.createElement('style');
        style.id = 'porygon-chips-animation-style';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
    }
}

// ===== POK√â-POKER : PROGRESSION & R√âCOMPENSES =====

// Fonction pour finaliser une run (succ√®s ou √©chec)
function finalizeRun(runData) {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    // Stats globales (ne pas incr√©menter runs_completed ici si c'est une completion, 
    // car completePokerRun() le fait d√©j√†)
    if (runData.failed) {
        gameState.poker.runs_completed++;
    }
    gameState.poker.total_chips_earned += run.rewards.chips_earned;
    gameState.poker.total_hands_played += runData.hands_played || 0;
    
    // Nettoyer la run
    gameState.poker.current_run = null;
    saveGame();
}

// Fonction pour attribuer les r√©compenses de completion de run
function awardRunCompletionRewards(run) {
    // R√©compenses de base
    const baseCoins = 1000 * run.current_ante;
    const baseShards = 50 + (run.current_ante * 10);
    const baseShinyTokens = 25 + (run.current_ante * 5);
    
    // Bonus selon performance
    const totalScore = run.hands_played_this_blind.reduce((sum, h) => sum + (h.score?.finalScore || 0), 0);
    const scoreBonus = Math.floor(totalScore / 10000);
    
    // R√©compenses finales
    let finalCoins = baseCoins + scoreBonus * 100;
    let finalShards = baseShards + Math.floor(scoreBonus / 2);
    let finalShinyTokens = baseShinyTokens + Math.floor(scoreBonus / 5);
    
    // Appliquer l'effet de la Pi√®ce Rune (objet tenu)
    if (typeof getBuddyHeldItemEffect === 'function' && getBuddyHeldItemEffect('poker_coin_boost')) {
        finalCoins *= 2;
        finalShards *= 2;
        finalShinyTokens *= 2;
    }
    
    // Appliquer l'effet du Deck Shard
    const selectedDeck = gameState.poker?.metaShop?.selectedDeck;
    if (selectedDeck === 'shard_deck') {
        finalShards = Math.floor(finalShards * 1.5);
    }
    
    gameState.coins += finalCoins;
    gameState.shards = (gameState.shards || 0) + finalShards;
    if (!gameState.rogue) gameState.rogue = { totalShinyTokens: 0 };
    gameState.rogue.totalShinyTokens = (gameState.rogue.totalShinyTokens || 0) + finalShinyTokens;
    
    // Ajouter les Shiny Tokens gagn√©s pendant la run
    if (run.rewards.shiny_tokens > 0) {
        gameState.rogue.totalShinyTokens += run.rewards.shiny_tokens;
    }
    
    // Conversion des chips en Processor Chips (1 chip = 1 Processor Chip)
    const processorChipsEarned = run.rewards.chips_earned || 0;
    if (processorChipsEarned > 0) {
        if (!gameState.inventory.processor_chips) gameState.inventory.processor_chips = 0;
        gameState.inventory.processor_chips += processorChipsEarned;
    }
    
    const rewardMsg = `üéâ Run compl√©t√©e ! +${finalCoins}üí∞ +${finalShards}üíé +${finalShinyTokens}üíé`;
    const processorMsg = processorChipsEarned > 0 ? ` +${processorChipsEarned}üîß Processor Chips` : '';
    showToast(rewardMsg + processorMsg, 'success');
    saveGame();
}

// Fonction pour obtenir les stats d'une run
function getRunStats() {
    const run = gameState.poker.current_run;
    if (!run) return null;
    
    const totalHandsPlayed = run.hands_played_this_blind.length + (run.current_ante - 1) * 9;
    const averageScore = totalHandsPlayed > 0 
        ? run.hands_played_this_blind.reduce((sum, h) => sum + (h.score?.finalScore || 0), 0) / totalHandsPlayed 
        : 0;
    
    return {
        ante: run.current_ante,
        blind: run.current_blind,
        blinds_cleared: run.blinds_cleared,
        chips: run.chips,
        hands_remaining: run.hands_remaining,
        discards_remaining: run.discards_remaining,
        blind_current_score: run.blind_current_score,
        blind_target_score: run.blind_target_score,
        progress_percentage: Math.min((run.blind_current_score / run.blind_target_score) * 100, 100),
        total_hands_played: totalHandsPlayed,
        average_score: Math.floor(averageScore),
        best_hand_score: Math.max(...run.hands_played_this_blind.map(h => h.score?.finalScore || 0), 0),
        active_jokers_count: run.active_jokers.length,
        deck_size: run.deck.length,
        discard_size: run.discard_pile.length,
        rewards: run.rewards,
        duration: Date.now() - run.start_time
    };
}

// Fonction pour obtenir les stats globales du mode Pok√©-Poker
function getPokerGlobalStats() {
    return {
        runs_completed: gameState.poker.runs_completed || 0,
        runs_started: gameState.poker.runs_started || 0,
        highest_ante: gameState.poker.highest_ante || 0,
        badges_earned: gameState.poker.badges_earned.length || 0,
        badges_list: gameState.poker.badges_earned || [],
        league_unlocked: gameState.poker.league_unlocked || false,
        total_chips_earned: gameState.poker.total_chips_earned || 0,
        total_hands_played: gameState.poker.total_hands_played || 0,
        best_single_hand_score: gameState.poker.best_single_hand_score || 0,
        legendary_combos_hit: gameState.poker.legendary_combos_hit || 0,
        win_rate: gameState.poker.runs_started > 0 
            ? ((gameState.poker.runs_completed / gameState.poker.runs_started) * 100).toFixed(1) 
            : 0
    };
}

// Fonction pour v√©rifier si un badge est d√©bloqu√©
function hasBadge(badgeNumber) {
    return gameState.poker.badges_earned.includes(`badge_${badgeNumber}`);
}

// Fonction pour obtenir les informations d'un ante
function getAnteInfo(anteNumber) {
    const anteConfig = getAnteConfig(anteNumber);
    if (!anteConfig) return null;
    
    const isUnlocked = anteNumber === 1 || hasBadge(anteNumber - 1);
    const isCompleted = hasBadge(anteNumber);
    
    return {
        ...anteConfig,
        isUnlocked,
        isCompleted,
        progress: isCompleted ? 100 : 0
    };
}

// Fonction pour obtenir le prochain ante √† d√©bloquer
function getNextAnte() {
    for (let i = 1; i <= 8; i++) {
        if (!hasBadge(i)) {
            return i;
        }
    }
    return null; // Tous les antes sont compl√©t√©s
}

// Fonction pour compl√©ter une run (tous les antes termin√©s)
function completePokerRun() {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    // V√©rifier si tous les antes sont compl√©t√©s
    if (run.current_ante > 8) {
        const runData = {
            ante_reached: run.current_ante,
            blinds_cleared: run.blinds_cleared,
            hands_played: run.hands_played_this_blind.length + (run.current_ante - 1) * 9,
            total_score: run.blind_current_score,
            duration: Date.now() - run.start_time,
            failed: false
        };
        
        // R√©compenses finales
        awardRunCompletionRewards(run);
        
        // Stats
        gameState.poker.runs_completed++;
        
        // showRunCompleteModal(runData); // Sera impl√©ment√© plus tard
        
        // Finaliser
        finalizeRun(runData);
        
        showToast('üèÜ Run compl√©t√©e avec succ√®s !', 'success');
    }
}

// Fonction pour obtenir le r√©sum√© d'une run termin√©e
function getRunSummary(runData) {
    if (!runData) return null;
    
    const durationMinutes = Math.floor(runData.duration / 60000);
    const durationSeconds = Math.floor((runData.duration % 60000) / 1000);
    
    return {
        success: !runData.failed,
        ante_reached: runData.ante_reached,
        blinds_cleared: runData.blinds_cleared,
        hands_played: runData.hands_played,
        total_score: runData.total_score,
        duration_formatted: `${durationMinutes}m ${durationSeconds}s`,
        rewards: runData.rewards || {}
    };
}

// ===== POK√â-POKER : SHOP & PACKS =====

// Fonction pour d√©terminer la raret√© d'un joker selon l'ante (70% common, 25% uncommon, 5% rare)
function rollJokerRarity(ante) {
    const rand = Math.random() * 100;
    
    // Probabilit√©s de base pour le shop (selon sp√©cifications)
    // 70% common, 25% uncommon, 5% rare (pas de legendary dans le shop normal)
    const shopRates = {
        common: 70,
        uncommon: 25,
        rare: 5
    };
    
    // Bonus ante (l√©g√®re am√©lioration des chances rares)
    const anteBonus = (ante - 1) * 0.5; // +0.5% rare par ante
    
    if (rand < shopRates.rare + anteBonus) return 'rare';
    if (rand < shopRates.rare + shopRates.uncommon + anteBonus) return 'uncommon';
    return 'common';
}

// Fonction pour obtenir un joker al√©atoire d'une raret√©
function getRandomJoker(rarity) {
    const jokersByRarity = {
        common: COMMON_JOKERS,
        uncommon: UNCOMMON_JOKERS,
        rare: RARE_JOKERS,
        super_rare: SUPER_RARE_JOKERS,
        legendary: LEGENDARY_JOKERS
    };
    
    const pool = jokersByRarity[rarity] || COMMON_JOKERS;
    return deepClone(pool[Math.floor(Math.random() * pool.length)]);
}

// Fonction pour g√©n√©rer les offres du shop (2 jokers, 2 boosters, 1 coupon par Ante)
function generateShopOffers() {
    const offers = [];
    const run = gameState.poker.current_run;
    if (!run) return offers;
    
    // 2 Jokers (toujours) - Probabilit√©s : 70% common, 25% uncommon, 5% rare
    for (let i = 0; i < 2; i++) {
        const rarity = rollJokerRarity(run.current_ante);
        let joker;
        
        // Utiliser le catalogue si disponible
        if (CARDS_CATALOGUE && CARDS_CATALOGUE.jokers && CARDS_CATALOGUE.jokers[rarity]) {
            const jokerPool = CARDS_CATALOGUE.jokers[rarity];
            if (jokerPool && jokerPool.length > 0) {
                const randomJoker = jokerPool[Math.floor(Math.random() * jokerPool.length)];
                joker = {
                    id: randomJoker.id,
                    name: randomJoker.name,
                    name_fr: randomJoker.name_fr,
                    description: randomJoker.tooltip,
                    description_fr: randomJoker.tooltip,
                    rarity: randomJoker.rarity,
                    icon: randomJoker.icon || 'üÉè',
                    cost_chips: getJokerCostByRarity(rarity),
                    cost_shards: rarity === 'rare' ? 5 : 0,
                    cost_shiny_tokens: 0
                };
            }
        }
        
        // Fallback sur l'ancien syst√®me si le catalogue n'est pas disponible
        if (!joker) {
            joker = getRandomJoker(rarity);
        }
        
        offers.push({
            id: `joker_offer_${i}_${Date.now()}`,
            type: 'joker',
            item_id: joker.id,
            item: joker,
            cost_chips: joker.cost_chips || getJokerCostByRarity(rarity),
            cost_shards: joker.cost_shards || (rarity === 'rare' ? 5 : 0),
            cost_shiny_tokens: joker.cost_shiny_tokens || 0,
            stock: 1
        });
    }
    
    // 2 Boosters (toujours) - Packs avec 3-7 cartes
    const boosterTypes = ['pack_common', 'pack_rare', 'pack_shiny'];
    const selectedBoosters = [];
    
    // S√©lectionner 2 boosters al√©atoires avec probabilit√©s
    for (let i = 0; i < 2; i++) {
        let boosterType;
        const rand = Math.random();
        
        // Probabilit√©s : 60% common, 30% rare, 10% shiny (selon ante)
        if (run.current_ante >= 3 && rand < 0.1) {
            boosterType = 'pack_shiny';
        } else if (rand < 0.4) {
            boosterType = 'pack_rare';
        } else {
            boosterType = 'pack_common';
        }
        
        // √âviter les doublons si possible
        if (selectedBoosters.includes(boosterType) && i === 1) {
            boosterType = boosterType === 'pack_common' ? 'pack_rare' : 'pack_common';
        }
        selectedBoosters.push(boosterType);
        
        // Taille du pack al√©atoire entre 3 et 7 cartes
        const packSize = 3 + Math.floor(Math.random() * 5); // 3-7 cartes
        
        const boosterConfig = {
            pack_common: {
                id: 'pack_common',
                name: 'Common Pack',
                name_fr: 'Pack Commun',
                description: `${packSize} common cards`,
                description_fr: `${packSize} cartes communes`,
                cost_chips: 100 + (packSize * 20),
                size: packSize
            },
            pack_rare: {
                id: 'pack_rare',
                name: 'Rare Pack',
                name_fr: 'Pack Rare',
                description: `${packSize} cards, 1 uncommon guaranteed`,
                description_fr: `${packSize} cartes, 1 uncommon garantie`,
                cost_chips: 300 + (packSize * 50),
                size: packSize
            },
            pack_shiny: {
                id: 'pack_shiny',
                name: 'Shiny Pack',
                name_fr: 'Pack Shiny',
                description: `${packSize} cards with 30% shiny chance each`,
                description_fr: `${packSize} cartes avec 30% chance shiny chacune`,
                cost_chips: 1000 + (packSize * 200),
                cost_shiny_tokens: 15,
                size: packSize
            }
        };
        
        const config = boosterConfig[boosterType];
        offers.push({
            id: `${boosterType}_${i}_${Date.now()}`,
            type: 'pack',
            item_id: config.id,
            name: config.name,
            name_fr: config.name_fr,
            description: config.description,
            description_fr: config.description_fr,
            cost_chips: config.cost_chips,
            cost_shards: config.cost_shards || 0,
            cost_shiny_tokens: config.cost_shiny_tokens || 0,
            stock: 1,
            pack_size: config.size
        });
    }
    
    // 1 Coupon par Ante (uniquement la premi√®re fois dans l'Ante)
    if (!run.ante_coupon_used || !run.ante_coupon_used[run.current_ante]) {
        if (!run.ante_coupon_used) run.ante_coupon_used = {};
        
        offers.push({
            id: `ante_coupon_${run.current_ante}_${Date.now()}`,
            type: 'coupon',
            item_id: 'ante_coupon',
            name: 'Ante Coupon',
            name_fr: 'Coupon Ante',
            description: 'Free special reward for this Ante',
            description_fr: 'R√©compense sp√©ciale gratuite pour cet Ante',
            cost_chips: 0,
            stock: 1,
            ante_number: run.current_ante
        });
    }
    
    return offers;
}

// Obtenir le co√ªt d'un joker selon sa raret√©
function getJokerCostByRarity(rarity) {
    const costs = {
        common: 150,
        uncommon: 400,
        rare: 1000,
        legendary: 5000
    };
    return costs[rarity] || 150;
}

// Fonction pour afficher l'√©cran de r√©cap apr√®s un blind compl√©t√©
function showBlindCompleteScreen(blindType, ante, chipsEarned, wasBoss, callback) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
        overflow-y: auto; padding: 20px;
    `;
    
    const blindNames = {
        small: { name: 'Small Blind', emoji: 'üîµ', color: '#4a90e2' },
        big: { name: 'Big Blind', emoji: 'üü°', color: '#f5a623' },
        boss: { name: 'Boss Blind', emoji: 'üî¥', color: '#d0021b' }
    };
    
    const blind = blindNames[blindType] || blindNames.small;
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98)); 
                    border-radius: 20px; padding: 40px; max-width: 500px; width: 100%; 
                    border: 3px solid ${blind.color}; text-align: center; animation: scaleIn 0.3s ease;">
            <div style="font-size: 5em; margin-bottom: 20px; animation: bounce 1s infinite;">${blind.emoji}</div>
            <h2 style="color: ${blind.color}; margin-bottom: 15px; font-size: 2.5em; text-shadow: 0 0 20px ${blind.color};">
                ${blind.name} Compl√©t√© !
            </h2>
            <p style="color: white; font-size: 1.2em; margin-bottom: 30px;">
                Ante ${ante} - ${blind.name}
            </p>
            
            <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 30px;">
                <div style="color: #ffd700; font-size: 1.5em; font-weight: 700; margin-bottom: 10px;">
                    üí∞ +${chipsEarned} Chips
                </div>
                ${wasBoss ? `
                    <div style="color: #4caf50; font-size: 1.2em; margin-top: 15px;">
                        üèÜ Badge Ante ${ante} d√©bloqu√© !
                    </div>
                ` : ''}
            </div>
            
            <button onclick="closeBlindRecap()" 
                    class="btn btn--primary" 
                    style="padding: 15px 40px; font-size: 1.2em; font-weight: 700;">
                Continuer
            </button>
        </div>
    `;
    
    window.closeBlindRecap = function() {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            modal.remove();
            delete window.closeBlindRecap;
            if (callback) callback();
        }, 300);
    };
    
    document.body.appendChild(modal);
}

// Fonction pour afficher l'√©cran de r√©cap apr√®s un Ante compl√©t√©
function showAnteCompleteScreen(ante, callback) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
        overflow-y: auto; padding: 20px;
    `;
    
    const run = gameState.poker.current_run;
    const anteReward = {
        coins: 1000 * ante,
        shards: 50 + (ante * 10),
        xp: 200 * ante
    };
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98)); 
                    border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; 
                    border: 3px solid #ffd700; text-align: center; animation: scaleIn 0.3s ease;">
            <div style="font-size: 6em; margin-bottom: 20px; animation: shine 2s infinite;">üèÜ</div>
            <h2 style="color: #ffd700; margin-bottom: 15px; font-size: 2.5em; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);">
                Ante ${ante} Compl√©t√© !
            </h2>
            <p style="color: white; font-size: 1.2em; margin-bottom: 30px;">
                Tous les Blinds de l'Ante ${ante} ont √©t√© vaincus !
            </p>
            
            <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                <h3 style="color: #ffd700; margin-bottom: 20px; font-size: 1.5em;">R√©compenses d'Ante</h3>
                <div style="display: flex; flex-direction: column; gap: 15px; text-align: left;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 1.1em;">üí∞ Coins</span>
                        <span style="color: #4caf50; font-size: 1.3em; font-weight: 700;">+${anteReward.coins}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 1.1em;">üíé Shards</span>
                        <span style="color: #4caf50; font-size: 1.3em; font-weight: 700;">+${anteReward.shards}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: white; font-size: 1.1em;">‚≠ê XP</span>
                        <span style="color: #4caf50; font-size: 1.3em; font-weight: 700;">+${anteReward.xp}</span>
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="color: #ffd700; font-size: 1.2em; font-weight: 700;">
                        üèÖ Badge Ante ${ante} d√©bloqu√© !
                    </div>
                </div>
            </div>
            
            ${ante < 8 ? `
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                    Prochaine √©tape : Ante ${ante + 1}
                </p>
            ` : `
                <p style="color: #4caf50; font-size: 1.3em; font-weight: 700; margin-bottom: 20px;">
                    üéâ Tous les Antes compl√©t√©s ! Ligue d√©bloqu√©e !
                </p>
            `}
            
            <button onclick="closeAnteRecap()" 
                    class="btn btn--primary" 
                    style="padding: 15px 40px; font-size: 1.2em; font-weight: 700;">
                Continuer
            </button>
        </div>
    `;
    
    window.closeAnteRecap = function() {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            modal.remove();
            delete window.closeAnteRecap;
            if (callback) callback();
        }, 300);
    };
    
    document.body.appendChild(modal);
}

// Fonction pour afficher le tutoriel Pok√©-Poker
window.showPokerTutorial = function() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
        overflow-y: auto; padding: 20px;
    `;
    
    let currentStep = 0;
    const steps = [
        {
            title: 'üé¥ Bienvenue dans Pok√©-Poker !',
            content: `
                <p style="font-size: 1.1em; margin-bottom: 20px;">
                    Pok√©-Poker est un mode de jeu roguelike o√π vous composez des mains de poker avec vos Pok√©mon !
                </p>
                <p style="color: rgba(255,255,255,0.8);">
                    Votre objectif : compl√©ter des <strong>Runs</strong> en battant des <strong>Blinds</strong> pour gagner des r√©compenses.
                </p>
            `
        },
        {
            title: 'üìã Structure d\'une Run',
            content: `
                <p style="margin-bottom: 15px;">
                    Une <strong>Run</strong> est compos√©e de plusieurs <strong>Antes</strong> (niveaux).
                </p>
                <p style="margin-bottom: 15px;">
                    Chaque Ante contient <strong>3 Blinds</strong> :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px;">
                    <li>üîµ <strong>Small Blind</strong> - Facile</li>
                    <li>üü° <strong>Big Blind</strong> - Moyen</li>
                    <li>üî¥ <strong>Boss Blind</strong> - Difficile (ne peut pas √™tre skipp√©)</li>
                </ul>
                <p style="color: #ffd700; font-weight: 700;">
                    Vous devez compl√©ter les Blinds dans l'ordre !
                </p>
            `
        },
        {
            title: '‚öîÔ∏è Combattre un Blind',
            content: `
                <p style="margin-bottom: 15px;">
                    Quand vous <strong>Combattre</strong> un Blind :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px;">
                    <li>Vous piochez <strong>9 cartes</strong></li>
                    <li>Le jeu vous sugg√®re les <strong>4 meilleures mains</strong></li>
                    <li>Vous pouvez <strong>d√©fausser jusqu'√† 3 cartes</strong> et repiocher</li>
                    <li>Vous jouez <strong>jusqu'√† 3 mains</strong> pour atteindre le score cible</li>
                    <li>Si vous r√©ussissez ‚Üí <strong>Shop</strong> s'ouvre !</li>
                </ul>
            `
        },
        {
            title: '‚è≠Ô∏è Skipper un Blind',
            content: `
                <p style="margin-bottom: 15px;">
                    Vous pouvez <strong>Skip</strong> un Blind (sauf Boss) :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px;">
                    <li>Vous recevez une <strong>r√©compense r√©duite</strong> (coins/XP)</li>
                    <li><strong>PAS d'acc√®s au Shop</strong> pour ce Blind</li>
                    <li>Le Blind est marqu√© comme skipp√©</li>
                </ul>
                <p style="color: #f44336; font-weight: 700; margin-top: 15px;">
                    ‚ö†Ô∏è Les Boss Blinds ne peuvent PAS √™tre skipp√©s !
                </p>
            `
        },
        {
            title: 'üõí Le Shop',
            content: `
                <p style="margin-bottom: 15px;">
                    Apr√®s chaque Blind r√©ussi, le <strong>Shop</strong> s'ouvre :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px;">
                    <li><strong>2 Jokers</strong> √† acheter (70% commun, 25% peu-commun, 5% rare)</li>
                    <li><strong>2 Boosters</strong> (3-7 cartes chacun)</li>
                    <li><strong>1 Coupon Ante</strong> (gratuit, une fois par Ante)</li>
                </ul>
                <p style="color: #4caf50; margin-top: 15px;">
                    Les cartes achet√©es restent dans votre deck pour toute la run !
                </p>
            `
        },
        {
            title: 'üÉè Les Jokers',
            content: `
                <p style="margin-bottom: 15px;">
                    Les <strong>Jokers</strong> sont des modificateurs puissants :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px;">
                    <li>Ils s'appliquent dans l'ordre <strong>gauche‚Üídroite</strong></li>
                    <li>Maximum <strong>2 jokers</strong> actifs √† la fois</li>
                    <li>Ils modifient vos scores (chips, multiplicateurs)</li>
                    <li>Certains sont permanents, d'autres √† usage limit√©</li>
                </ul>
                <p style="color: #ffd700; margin-top: 15px;">
                    Survolez un joker pour voir son effet d√©taill√© !
                </p>
            `
        },
        {
            title: 'üìä Calcul du Score',
            content: `
                <p style="margin-bottom: 15px;">
                    Le score d'une main se calcule ainsi :
                </p>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <p style="font-family: monospace; font-size: 1.1em; color: #ffd700;">
                        Score = (BaseChips + CardChips + PlanetChips) √ó Multiplicateur
                    </p>
                </div>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px;">
                    <li><strong>BaseChips</strong> : valeur de la combinaison (Pair, Flush, etc.)</li>
                    <li><strong>CardChips</strong> : somme des chips des 5 cartes</li>
                    <li><strong>PlanetChips</strong> : bonus des plan√®tes actives</li>
                    <li><strong>Multiplicateur</strong> : jokers + buddy + shiny + ante</li>
                </ul>
            `
        },
        {
            title: 'üéØ Objectif Final',
            content: `
                <p style="margin-bottom: 15px;">
                    Votre mission :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px;">
                    <li>Compl√©ter les <strong>8 Antes</strong> pour d√©bloquer la Ligue</li>
                    <li>Gagner des <strong>Badges</strong> en battant les Boss</li>
                    <li>Construire un deck puissant avec les <strong>Jokers</strong></li>
                    <li>Atteindre les <strong>scores les plus √©lev√©s</strong> !</li>
                </ul>
                <p style="color: #ffd700; font-size: 1.2em; font-weight: 700; margin-top: 20px;">
                    Bonne chance, Dresseur ! üé¥
                </p>
            `
        }
    ];
    
    function renderStep() {
        const step = steps[currentStep];
        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98)); 
                        border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; 
                        border: 2px solid rgba(255, 215, 0, 0.3); position: relative;">
                <h2 style="color: #ffd700; margin-bottom: 25px; font-size: 2em; text-align: center;">
                    ${step.title}
                </h2>
                <div style="color: white; line-height: 1.8; font-size: 1.05em; margin-bottom: 30px;">
                    ${step.content}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                    <button onclick="tutorialPrevious()" 
                            class="btn btn--secondary" 
                            style="padding: 12px 24px;"
                            ${currentStep === 0 ? 'disabled' : ''}>
                        ‚Üê Pr√©c√©dent
                    </button>
                    <div style="color: rgba(255,255,255,0.6);">
                        ${currentStep + 1} / ${steps.length}
                    </div>
                    ${currentStep < steps.length - 1 ? `
                        <button onclick="tutorialNext()" class="btn btn--primary" style="padding: 12px 24px;">
                            Suivant ‚Üí
                        </button>
                    ` : `
                        <button onclick="closeTutorial()" class="btn btn--primary" style="padding: 12px 24px;">
                            Commencer !
                        </button>
                    `}
                </div>
            </div>
        `;
    }
    
    window.tutorialNext = function() {
        if (currentStep < steps.length - 1) {
            currentStep++;
            renderStep();
        }
    };
    
    window.tutorialPrevious = function() {
        if (currentStep > 0) {
            currentStep--;
            renderStep();
        }
    };
    
    window.closeTutorial = function() {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => modal.remove(), 300);
    };
    
    renderStep();
    document.body.appendChild(modal);
};

// Fonction pour obtenir une carte al√©atoire d'une raret√©
function getRandomCard(rarity) {
    const run = gameState.poker.current_run;
    if (!run) return null;
    
    // Utiliser le deck permanent comme pool
    const pool = gameState.poker.permanent_deck.filter(c => c.rarity === rarity);
    if (pool.length === 0) {
        // Fallback : cr√©er une carte al√©atoire
        const allIds = Array.from({ length: 151 }, (_, i) => i + 1);
        const randomId = allIds[Math.floor(Math.random() * allIds.length)];
        return createCard(randomId);
    }
    
    const card = pool[Math.floor(Math.random() * pool.length)];
    return deepClone(card);
}

// Fonction pour d√©terminer une raret√© al√©atoire
function rollRarity() {
    const rand = Math.random() * 100;
    if (rand < 1) return 'legendary';
    if (rand < 5) return 'super_rare';
    if (rand < 15) return 'rare';
    if (rand < 40) return 'uncommon';
    return 'common';
}

// Fonction pour ouvrir un pack (les cartes restent dans le deck pour la suite du run)
function openPack(packType, packSize = null) {
    const run = gameState.poker.current_run;
    if (!run) return [];
    
    const cards = [];
    
    switch (packType) {
        case 'pack_common':
            // 5 cartes communes (ou packSize si sp√©cifi√©)
            const commonSize = packSize || 5;
            for (let i = 0; i < commonSize; i++) {
                cards.push(getRandomCard('common'));
            }
            break;
            
        case 'pack_rare':
            // 3 communes + 1 uncommon garantie (ou packSize si sp√©cifi√©)
            const rareSize = packSize || 4;
            for (let i = 0; i < rareSize - 1; i++) {
                cards.push(getRandomCard('common'));
            }
            cards.push(getRandomCard('uncommon'));
            break;
            
        case 'pack_shiny':
            // 3 cartes avec 30% chance chacune d'√™tre shiny (ou packSize si sp√©cifi√©)
            const shinySize = packSize || 3;
            for (let i = 0; i < shinySize; i++) {
                const card = getRandomCard(rollRarity());
                if (Math.random() < 0.3) {
                    card.is_shiny = true;
                    card.sprite_url = card.sprite_shiny_url;
                }
                cards.push(card);
            }
            break;
            
        case 'pack_legendary':
            // 1 super rare ou legendary garanti
            const rarity = Math.random() < 0.3 ? 'legendary' : 'super_rare';
            cards.push(getRandomCard(rarity));
            break;
    }
    
    // Ajouter au deck permanent de la run (persiste pour toute la run)
    if (!run.bought_cards_this_run) run.bought_cards_this_run = [];
    run.bought_cards_this_run.push(...cards);
    
    // Ajouter aussi au deck actuel
    run.deck.push(...cards);
    run.deck = shuffleDeck(run.deck);
    
    // Animation d'ouverture
    showToast(`üì¶ Pack ouvert ! ${cards.length} carte(s) ajout√©e(s) au deck`, 'success');
    
    return cards;
}

// Fonction pour v√©rifier si on peut se permettre un achat
function canAffordPurchase(cost_chips, cost_shards, cost_shiny_tokens) {
    const run = gameState.poker.current_run;
    if (!run) return { canAfford: false, reason: 'Aucune run active' };
    
    if (cost_chips && run.chips < cost_chips) {
        return { canAfford: false, reason: 'Pas assez de chips' };
    }
    if (cost_shards && (gameState.shards || 0) < cost_shards) {
        return { canAfford: false, reason: 'Pas assez de shards' };
    }
    if (cost_shiny_tokens && (gameState.rogue?.totalShinyTokens || 0) < cost_shiny_tokens) {
        return { canAfford: false, reason: 'Pas assez de Shiny Tokens' };
    }
    
    return { canAfford: true };
}

// Fonction pour acheter une offre du shop
function purchaseShopOffer(offerId) {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const shop = gameState.poker.shop;
    const offer = shop.current_offers.find(o => o.id === offerId);
    if (!offer) {
        showToast('Offre introuvable', 'error');
        return;
    }
    
    // V√©rifier si on peut se le permettre
    const canAfford = canAffordPurchase(offer.cost_chips, offer.cost_shards, offer.cost_shiny_tokens);
    if (!canAfford.canAfford) {
        showToast(canAfford.reason, 'error');
        return;
    }
    
    if (offer.stock <= 0) {
        showToast('Plus en stock', 'error');
        return;
    }
    
    // D√©duire co√ªts
    if (offer.cost_chips) run.chips -= offer.cost_chips;
    if (offer.cost_shards) gameState.shards = (gameState.shards || 0) - offer.cost_shards;
    if (offer.cost_shiny_tokens) gameState.rogue.totalShinyTokens -= offer.cost_shiny_tokens;
    
    // Appliquer item
    applyPurchasedItem(offer);
    
    // D√©cr√©menter stock
    offer.stock--;
    
    saveGame();
    showToast(`‚úÖ ${offer.item?.name_fr || offer.name_fr || offer.name} achet√© !`, 'success');
}

// Fonction pour appliquer un item achet√©
function applyPurchasedItem(offer) {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    switch (offer.type) {
        case 'joker':
            // Ajouter le joker aux jokers actifs (max 2 slots)
            if (run.active_jokers.length >= 2) {
                // Remplacer le dernier joker ou demander confirmation
                run.active_jokers.pop();
            }
            const jokerCopy = deepClone(offer.item);
            jokerCopy.uses_remaining = jokerCopy.uses_remaining !== undefined ? jokerCopy.uses_remaining : null;
            run.active_jokers.push(jokerCopy);
            showToast(`üÉè ${jokerCopy.name_fr || jokerCopy.name} ajout√© aux jokers actifs !`, 'success');
            break;
            
        case 'pack':
            // Ouvrir le pack avec la taille sp√©cifi√©e
            const packSize = offer.pack_size || null;
            const cards = openPack(offer.item_id, packSize);
            // Le toast est d√©j√† affich√© dans openPack
            break;
            
        case 'coupon':
            // Utiliser le coupon de l'Ante
            if (!run.ante_coupon_used) run.ante_coupon_used = {};
            run.ante_coupon_used[offer.ante_number] = true;
            
            // R√©compense du coupon (coins, shards, ou carte sp√©ciale)
            const couponReward = {
                coins: 500 * offer.ante_number,
                shards: 10 * offer.ante_number,
                xp: 100 * offer.ante_number
            };
            run.chips += couponReward.coins;
            gameState.shards = (gameState.shards || 0) + couponReward.shards;
            gameState.xp += couponReward.xp;
            checkLevelUp();
            
            showToast(`üé´ Coupon Ante ${offer.ante_number} utilis√© ! +${couponReward.coins}üí∞ +${couponReward.shards}üíé`, 'success');
            break;
            
        case 'consumable':
            switch (offer.item_id) {
                case 'extra_hand':
                    run.hands_remaining++;
                    showToast('üé´ +1 main suppl√©mentaire !', 'success');
                    break;
                case 'extra_discard':
                    run.discards_remaining++;
                    showToast('üîÑ +1 d√©fausse suppl√©mentaire !', 'success');
                    break;
            }
            break;
    }
}

// Fonction pour relancer le shop
function rerollShop() {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const shop = gameState.poker.shop;
    if (shop.rerolls_available <= 0) {
        showToast('Plus de rerolls disponibles', 'error');
        return;
    }
    
    if (run.chips < shop.reroll_cost) {
        showToast('Pas assez de chips', 'error');
        return;
    }
    
    // Payer
    run.chips -= shop.reroll_cost;
    shop.rerolls_available--;
    shop.reroll_cost = Math.floor(shop.reroll_cost * 1.5); // Augmente √† chaque reroll
    
    // R√©g√©n√©rer offres
    shop.current_offers = generateShopOffers();
    
    saveGame();
    showToast('üîÑ Shop relanc√© !', 'success');
}

// Fonction pour ouvrir le shop (apr√®s chaque blind r√©ussi)
function openPokerShop() {
    const run = gameState.poker.current_run;
    if (!run) {
        showToast('Aucune run active', 'error');
        return;
    }
    
    // Le shop s'ouvre apr√®s chaque blind r√©ussi (pas seulement entre antes)
    // Mais pas si le blind a √©t√© skipp√©
    const shop = gameState.poker.shop;
    
    // G√©n√©rer offres si pas encore fait
    if (!shop.current_offers || shop.current_offers.length === 0) {
        shop.current_offers = generateShopOffers();
    }
    
    createPokerShopModal();
}

// ===== POK√â-POKER : UI & RENDERING =====

// Variables globales pour la s√©lection de cartes
let pokerSelectedCardIndices = [];
let pokerDrawnCards = [];

// Fonction pour rendre la page Pok√©-Poker
function renderPokerPage() {
    const run = gameState.poker.current_run;
    const bottomNav = document.querySelector('.bottom-nav');
    
    // R√©cup√©rer les √©l√©ments avec v√©rification d'existence
    const startScreen = document.getElementById('poker-start-screen');
    const runScreen = document.getElementById('poker-run-screen');
    const lobbyScreen = document.getElementById('poker-lobby-screen');
    
    // Si les √©l√©ments n'existent pas, le jeu React n'est peut-√™tre pas encore charg√©
    // Dans ce cas, on ne fait rien et on laisse React g√©rer l'affichage
    if (!startScreen || !runScreen || !lobbyScreen) {
        // Le jeu Pok√©-Poker utilise React et sera rendu par le composant React
        // On ne fait rien ici pour √©viter les erreurs
        return;
    }
    
    if (!run || !run.active) {
        // Afficher √©cran de d√©marrage (premi√®re page)
        startScreen.style.display = 'block';
        runScreen.style.display = 'none';
        lobbyScreen.style.display = 'none';
        // R√©afficher les barres de menu
        if (bottomNav) bottomNav.style.display = 'flex';
        renderPokerGlobalStats();
    } else {
        // V√©rifier si on est en mode Lobby (entre blinds) ou en mode Play
        const isInPlayMode = run.current_blind && run.blind_in_progress;
        
        if (isInPlayMode) {
            // Afficher √©cran de jeu (Main Play)
            startScreen.style.display = 'none';
            lobbyScreen.style.display = 'none';
            runScreen.style.display = 'block';
            // Cacher les barres de menu pendant la partie
            if (bottomNav) bottomNav.style.display = 'none';
            renderPokerRunScreen();
        } else {
            // Afficher Run Lobby avec les 3 Blinds
            startScreen.style.display = 'none';
            runScreen.style.display = 'none';
            lobbyScreen.style.display = 'block';
            // R√©afficher les barres de menu dans le lobby
            if (bottomNav) bottomNav.style.display = 'flex';
            renderPokerRunLobby();
        }
    }
}

// Fonction pour rendre le Run Lobby (vue des 3 Blinds)
function renderPokerRunLobby() {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const anteConfig = getAnteConfig(run.current_ante);
    if (!anteConfig) return;
    
    const container = document.getElementById('poker-lobby-content');
    if (!container) return;
    
    // Calculer les r√©compenses skip pour chaque blind
    const skipRewards = {
        small: { coins: Math.floor(calculateBlindTarget(run.current_ante, 'small') * 0.3), xp: 50 },
        big: { coins: Math.floor(calculateBlindTarget(run.current_ante, 'big') * 0.3), xp: 75 },
        boss: { coins: Math.floor(calculateBlindTarget(run.current_ante, 'boss') * 0.3), xp: 100 }
    };
    
    // V√©rifier quels blinds sont compl√©t√©s
    const blindsStatus = run.blinds_status || { small: false, big: false, boss: false };
    
    container.innerHTML = `
        <!-- Run Header -->
        <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95)); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 2px solid rgba(255, 215, 0, 0.3);">
            <h2 style="color: #ffd700; text-align: center; margin-bottom: 15px; font-size: 2em;">
                ${anteConfig.badge_icon} ${anteConfig.badge_name_fr} - Ante ${run.current_ante}
            </h2>
            <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 20px;">
                <div style="text-align: center;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 5px;">Buddy Actif</div>
                    <div style="color: white; font-weight: 700; font-size: 1.1em;">
                        ${run.buddy_id ? (gameState.buddy?.buddies[run.buddy_id]?.name || 'Aucun') : 'Aucun'}
                    </div>
                </div>
                <div style="text-align: center;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 5px;">üí∞ Chips</div>
                    <div style="color: #ffd700; font-weight: 700; font-size: 1.3em;">${run.chips}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 5px;">üíé Shards</div>
                    <div style="color: #2196f3; font-weight: 700; font-size: 1.3em;">${gameState.poker.shards || 0}</div>
                </div>
            </div>
        </div>
        
        <!-- Blinds Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
            ${['small', 'big', 'boss'].map((blindType, index) => {
                const blindConfig = anteConfig.blinds.find(b => b.type === blindType);
                const target = calculateBlindTarget(run.current_ante, blindType);
                const isCompleted = blindsStatus[blindType];
                const canAccess = index === 0 || blindsStatus[['small', 'big', 'boss'][index - 1]];
                const skipReward = skipRewards[blindType];
                const isBoss = blindType === 'boss';
                
                return `
                    <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95)); 
                              padding: 25px; border-radius: 16px; border: 2px solid ${isCompleted ? '#4caf50' : canAccess ? 'rgba(255, 215, 0, 0.3)' : 'rgba(255, 0, 0, 0.3)'};
                              opacity: ${canAccess ? '1' : '0.5'};
                              position: relative;">
                        ${isCompleted ? '<div style="position: absolute; top: 10px; right: 10px; background: #4caf50; color: white; padding: 5px 10px; border-radius: 8px; font-weight: 700;">‚úì Compl√©t√©</div>' : ''}
                        ${!canAccess ? '<div style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; padding: 5px 10px; border-radius: 8px; font-weight: 700;">üîí Verrouill√©</div>' : ''}
                        
                        <h3 style="color: #ffd700; margin-bottom: 15px; font-size: 1.5em; text-align: center;">
                            ${blindType === 'small' ? 'Small Blind' : blindType === 'big' ? 'Big Blind' : 'Boss Blind'}
                            ${isBoss ? anteConfig.badge_icon : ''}
                        </h3>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 5px;">Score cible</div>
                            <div style="color: white; font-weight: 700; font-size: 1.5em;">${formatNumber(target)}</div>
                        </div>
                        
                        ${isBoss ? `
                            <div style="background: rgba(255, 0, 0, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(255, 0, 0, 0.4);">
                                <div style="color: #ff6b6b; font-weight: 700; margin-bottom: 5px;">Boss: ${anteConfig.boss_name}</div>
                                <div style="color: rgba(255,255,255,0.8); font-size: 0.9em;">${anteConfig.boss_modifier}</div>
                            </div>
                        ` : ''}
                        
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-bottom: 10px;">R√©compense Skip:</div>
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <div style="color: #ffd700;">üí∞ ${skipReward.coins}</div>
                                <div style="color: #4caf50;">‚≠ê ${skipReward.xp} XP</div>
                            </div>
                            <div style="color: rgba(255,255,255,0.5); font-size: 0.75em; margin-top: 5px; text-align: center;">
                                (Pas d'acc√®s au shop si skip)
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-direction: column;">
                            ${isBoss ? '' : `
                            <button onclick="handleBlindSkip('${blindType}')" 
                                    class="btn btn--secondary" 
                                    style="width: 100%; padding: 12px;"
                                    ${!canAccess || isCompleted ? 'disabled' : ''}>
                                ‚è≠Ô∏è Skip (${skipReward.coins}üí∞)
                            </button>
                            `}
                            <button onclick="handleBlindFight('${blindType}')" 
                                    class="btn btn--primary" 
                                    style="width: 100%; padding: 12px; font-weight: 700;"
                                    ${!canAccess || isCompleted ? 'disabled' : ''}>
                                ‚öîÔ∏è Combattre
                            </button>
                            <button onclick="showBlindDetails('${blindType}')" 
                                    class="btn btn--outline" 
                                    style="width: 100%; padding: 8px; font-size: 0.9em;">
                                üìã D√©tails
                            </button>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// Fonction pour rendre les stats globales
function renderPokerGlobalStats() {
    const stats = getPokerGlobalStats();
    const container = document.getElementById('poker-stats-content');
    if (!container) return;
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div class="stat-card">
                <div class="stat-icon">üé¥</div>
                <div class="stat-value">${stats.runs_completed}</div>
                <div class="stat-label">Runs compl√©t√©es</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-value">${stats.highest_ante}</div>
                <div class="stat-label">Meilleur Ante</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ü™ô</div>
                <div class="stat-value">${stats.badges_earned}</div>
                <div class="stat-label">Badges obtenus</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value">${formatNumber(stats.best_single_hand_score)}</div>
                <div class="stat-label">Meilleur score</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value">${stats.win_rate}%</div>
                <div class="stat-label">Taux de victoire</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíé</div>
                <div class="stat-value">${stats.legendary_combos_hit}</div>
                <div class="stat-label">Combos l√©gendaires</div>
            </div>
        </div>
    `;
}

// Fonction pour rendre l'√©cran de run active
function renderPokerRunScreen() {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    // Cacher les barres de menu pendant une partie
    const bottomNav = document.querySelector('.bottom-nav');
    if (bottomNav) {
        bottomNav.style.display = 'none';
    }
    
    // Mettre √† jour les ressources
    document.getElementById('poker-chips').textContent = run.chips;
    document.getElementById('poker-hands').textContent = run.hands_remaining;
    document.getElementById('poker-discards').textContent = run.discards_remaining;
    
    // Mettre √† jour l'ante/blind
    const anteConfig = getAnteConfig(run.current_ante);
    const blindNames = { small: 'Small', big: 'Big', boss: 'Boss' }; // Version courte pour mobile
    document.getElementById('poker-ante-number').textContent = run.current_ante;
    document.getElementById('poker-blind-type').textContent = blindNames[run.current_blind] || run.current_blind;
    
    // Mettre √† jour la barre de progression
    const progress = Math.min((run.blind_current_score / run.blind_target_score) * 100, 100);
    document.getElementById('poker-progress-bar').style.width = `${progress}%`;
    document.getElementById('poker-current-score').textContent = formatNumber(run.blind_current_score);
    document.getElementById('poker-target-score').textContent = formatNumber(run.blind_target_score);
    
    // Mettre √† jour le deck/d√©fausse
    document.getElementById('poker-deck-count').textContent = run.deck.length;
    document.getElementById('poker-discard-count').textContent = run.discard_pile.length;
    
    // Rendre les jokers actifs
    renderActiveJokers();
    
    // Afficher/masquer le bouton shop selon si on est entre antes
    const shopBtn = document.getElementById('poker-shop-btn');
    if (shopBtn) {
        const canShop = run.current_blind === 'small' && run.current_ante > 1;
        shopBtn.style.display = canShop ? 'inline-block' : 'none';
    }
    
    // Si pas de cartes pioch√©es, piocher automatiquement
    if (pokerDrawnCards.length === 0) {
        const newHand = drawHand();
        if (newHand.length > 0) {
            renderDrawnCards(newHand);
        }
    } else {
        renderDrawnCards(pokerDrawnCards);
    }
}

// Variable globale pour le tri actuel
let pokerCurrentSort = 'none';

// Fonction pour trier les cartes
window.sortPokerCards = function(sortType) {
    pokerCurrentSort = sortType;
    const sortedCards = [...pokerDrawnCards];
    
    switch(sortType) {
        case 'type':
            sortedCards.sort((a, b) => {
                const typeA = a.primary_type || '';
                const typeB = b.primary_type || '';
                if (typeA !== typeB) return typeA.localeCompare(typeB);
                return (b.base_chip || 0) - (a.base_chip || 0);
            });
            break;
        case 'rarity':
            const rarityOrder = { common: 1, uncommon: 2, rare: 3, super_rare: 4, legendary: 5 };
            sortedCards.sort((a, b) => {
                const rarityA = rarityOrder[a.rarity] || 0;
                const rarityB = rarityOrder[b.rarity] || 0;
                if (rarityA !== rarityB) return rarityB - rarityA;
                return (b.base_chip || 0) - (a.base_chip || 0);
            });
            break;
        case 'evolution':
            sortedCards.sort((a, b) => {
                const evoA = a.evolution_stage || 0;
                const evoB = b.evolution_stage || 0;
                if (evoA !== evoB) return evoB - evoA;
                const familyA = a.evolution_family_id || '';
                const familyB = b.evolution_family_id || '';
                if (familyA !== familyB) return familyA.localeCompare(familyB);
                return (b.base_chip || 0) - (a.base_chip || 0);
            });
            break;
    }
    
    // R√©indexer les cartes tri√©es
    const container = document.getElementById('poker-drawn-cards');
    if (!container) return;
    
    container.innerHTML = '';
    sortedCards.forEach((card, newIndex) => {
        const originalIndex = pokerDrawnCards.indexOf(card);
        const cardElement = createPokerCardElement(card, originalIndex);
        container.appendChild(cardElement);
    });
    
    // Mettre √† jour les boutons de tri
    document.querySelectorAll('[id^="poker-sort-"]').forEach(btn => {
        btn.style.opacity = btn.id === `poker-sort-${sortType}` ? '1' : '0.5';
        btn.style.border = btn.id === `poker-sort-${sortType}` ? '2px solid #ffd700' : '2px solid rgba(255,255,255,0.3)';
    });
};

// Fonction pour rendre les cartes pioch√©es (9 cartes + 4 mains sugg√©r√©es)
function renderDrawnCards(cards) {
    pokerDrawnCards = cards;
    pokerSelectedCardIndices = [];
    
    const container = document.getElementById('poker-drawn-cards');
    if (!container) return;
    
    container.innerHTML = '';
    document.getElementById('poker-draw-count').textContent = cards.length;
    
    // Calculer les 4 mains sugg√©r√©es
    const suggestedHands = calculateSuggestedHands(cards);
    
    // Afficher les mains sugg√©r√©es
    const suggestionsContainer = document.getElementById('poker-suggested-hands');
    if (suggestionsContainer) {
        if (suggestedHands.length > 0) {
            suggestionsContainer.innerHTML = `
                <h4 style="color: #ffd700; margin-bottom: 15px; text-align: center;">üí° 4 Meilleures Mains Sugg√©r√©es</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    ${suggestedHands.map((suggestion, idx) => `
                        <div onclick="selectSuggestedHand(${idx})" 
                             style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.8), rgba(22, 33, 62, 0.8)); 
                                    padding: 15px; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.3); 
                                    cursor: pointer; transition: all 0.3s ease;"
                             onmouseenter="this.style.borderColor='#ffd700'; this.style.transform='translateY(-5px)'"
                             onmouseleave="this.style.borderColor='rgba(255, 215, 0, 0.3)'; this.style.transform='translateY(0)'">
                            <div style="color: #ffd700; font-weight: 700; margin-bottom: 8px; font-size: 1.1em;">
                                Main ${suggestion.index}
                            </div>
                            <div style="color: white; font-size: 0.9em; margin-bottom: 8px;">
                                ${suggestion.description}
                            </div>
                            <div style="color: #4caf50; font-weight: 700; font-size: 1.2em;">
                                ~${formatNumber(suggestion.estimatedScore)} pts
                            </div>
                            <div style="display: flex; gap: 5px; margin-top: 10px; justify-content: center;">
                                ${suggestion.cards.slice(0, 5).map(card => `
                                    <img src="${card.sprite_url}" alt="${card.name}" 
                                         style="width: 30px; height: 30px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3);">
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Stocker les suggestions globalement pour la s√©lection
            window.pokerSuggestedHands = suggestedHands;
        } else {
            suggestionsContainer.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center;">Pas assez de cartes pour sugg√©rer des mains</p>';
        }
    }
    
    // Appliquer le tri si un tri est actif
    if (pokerCurrentSort !== 'none') {
        sortPokerCards(pokerCurrentSort);
    } else {
        cards.forEach((card, index) => {
            const cardElement = createPokerCardElement(card, index);
            container.appendChild(cardElement);
        });
    }
    
    updatePokerSelectionDisplay();
}

// S√©lectionner une main sugg√©r√©e
window.selectSuggestedHand = function(suggestionIndex) {
    const suggestion = window.pokerSuggestedHands?.[suggestionIndex];
    if (!suggestion) return;
    
    // S√©lectionner les 5 cartes de la main sugg√©r√©e
    pokerSelectedCardIndices = suggestion.cards.map(card => {
        return pokerDrawnCards.findIndex(c => c.id === card.id);
    }).filter(idx => idx !== -1);
    
    updatePokerSelectionDisplay();
    showToast(`Main ${suggestion.index} s√©lectionn√©e !`, 'success');
};

// Fonction pour cr√©er un √©l√©ment carte
function createPokerCardElement(card, index) {
    const div = document.createElement('div');
    div.className = `poker-card ${card.is_shiny ? 'shiny' : ''}`;
    div.setAttribute('data-card-index', index);
    div.setAttribute('data-card-id', card.id);
    
    const typeColors = {
        Fire: '#e25822', Water: '#3aa7f4', Grass: '#6dc066', Electric: '#ffd24c',
        Psychic: '#ec5c85', Normal: '#a8a878', Fighting: '#c03028', Poison: '#a040a0',
        Ground: '#e0c068', Flying: '#a890f0', Bug: '#a8b820', Rock: '#b8a038',
        Ghost: '#705898', Dragon: '#7038f8', Ice: '#98d8d8'
    };
    
    const primaryTypeColor = typeColors[card.primary_type] || '#a8a878';
    const rarityColors = {
        common: '#9e9e9e', uncommon: '#4caf50', rare: '#2196f3',
        super_rare: '#9c27b0', legendary: '#ff9800'
    };
    
    div.innerHTML = `
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span class="card-name" style="font-size: 12px; font-weight: 700; color: white;">${card.name}</span>
            <span class="card-rarity ${card.rarity}" style="font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; background: ${rarityColors[card.rarity] || '#9e9e9e'};">
                ${card.rarity[0].toUpperCase()}
            </span>
        </div>
        <img src="${card.sprite_url}" alt="${card.name}" class="card-sprite" style="width: 100%; height: 96px; object-fit: contain; image-rendering: pixelated; margin: 8px 0;">
        <div class="card-types" style="display: flex; gap: 4px; margin-bottom: 8px;">
            ${card.types.map(type => `
                <span class="type-badge" style="flex: 1; text-align: center; padding: 4px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; background: ${typeColors[type] || '#a8a878'};">
                    ${type}
                </span>
            `).join('')}
        </div>
        <div class="card-stats" style="display: flex; justify-content: space-between; font-size: 11px; color: rgba(255,255,255,0.8);">
            <span>üíé ${card.base_chip}</span>
            <span>‚úñÔ∏è ${card.base_mult}</span>
        </div>
        ${card.is_shiny ? '<div class="shiny-badge" style="position: absolute; top: 5px; right: 5px; background: #ffd700; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;">‚ú® SHINY</div>' : ''}
    `;
    
    // Style avec superposition (style Balatro)
    const overlapOffset = index * 15; // D√©calage pour superposition
    div.style.cssText = `
        width: 140px; height: 200px; background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(20, 20, 40, 0.95)); 
        border-radius: 12px; padding: 12px; cursor: pointer; transition: all 0.3s ease; position: relative; 
        border: 3px solid rgba(255, 255, 255, 0.2); opacity: 1; transform: translateX(${overlapOffset}px) translateY(0);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); z-index: ${1000 - index};
        margin-left: ${index > 0 ? '-15px' : '0'};
    `;
    
    // Animation d'apparition
    setTimeout(() => {
        div.style.opacity = '1';
        div.style.transform = 'translateY(0)';
    }, index * 50);
    
    div.addEventListener('click', () => togglePokerCardSelection(index));
    
    // Effet hover
    div.addEventListener('mouseenter', () => {
        if (!pokerSelectedCardIndices.includes(index)) {
            div.style.transform = 'translateY(-8px) scale(1.05)';
            div.style.boxShadow = '0 8px 20px rgba(255, 215, 0, 0.4)';
        }
    });
    
    div.addEventListener('mouseleave', () => {
        if (!pokerSelectedCardIndices.includes(index)) {
            div.style.transform = 'translateY(0) scale(1)';
            div.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
        }
    });
    
    return div;
}

// Variable globale pour le mode de s√©lection (discard ou play)
let pokerSelectionMode = 'play'; // 'play' ou 'discard'

// Fonction pour toggle la s√©lection d'une carte
function togglePokerCardSelection(index) {
    const cardElement = document.querySelector(`[data-card-index="${index}"]`);
    if (!cardElement) return;
    
    const run = gameState.poker.current_run;
    const maxSelection = pokerSelectionMode === 'discard' ? 3 : 5;
    
    if (pokerSelectedCardIndices.includes(index)) {
        // D√©s√©lectionner
        pokerSelectedCardIndices = pokerSelectedCardIndices.filter(i => i !== index);
        cardElement.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        cardElement.style.borderWidth = '3px';
        cardElement.style.transform = 'translateY(0) scale(1)';
        cardElement.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
        cardElement.style.filter = 'brightness(1)';
    } else {
        // S√©lectionner (max selon le mode)
        if (pokerSelectedCardIndices.length >= maxSelection) {
            const message = pokerSelectionMode === 'discard' 
                ? `Maximum ${maxSelection} cartes √† d√©fausser` 
                : `Maximum ${maxSelection} cartes s√©lectionn√©es`;
            showToast(message, 'warning');
            return;
        }
        pokerSelectedCardIndices.push(index);
        // Couleur diff√©rente pour d√©fausse (rouge) vs s√©lection normale (or)
        const borderColor = pokerSelectionMode === 'discard' ? '#f44336' : '#ffd700';
        cardElement.style.borderColor = borderColor;
        cardElement.style.borderWidth = '4px';
        cardElement.style.transform = 'translateY(-20px) scale(1.1)';
        cardElement.style.boxShadow = pokerSelectionMode === 'discard'
            ? '0 12px 30px rgba(244, 67, 54, 0.6), 0 0 40px rgba(244, 67, 54, 0.3)'
            : '0 12px 30px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 215, 0, 0.3)';
        cardElement.style.filter = 'brightness(1.2)';
    }
    
    updatePokerSelectionDisplay();
}

// Fonction pour mettre √† jour l'affichage de s√©lection
function updatePokerSelectionDisplay() {
    const maxSelection = pokerSelectionMode === 'discard' ? 3 : 5;
    const label = pokerSelectionMode === 'discard' ? 'cartes √† d√©fausser' : 'cartes s√©lectionn√©es';
    
    document.getElementById('poker-selected-count').textContent = pokerSelectedCardIndices.length;
    const selectedLabel = document.getElementById('poker-selected-label');
    if (selectedLabel) {
        selectedLabel.textContent = label;
    }
    
    // Afficher les cartes s√©lectionn√©es
    const selectedContainer = document.getElementById('poker-selected-cards');
    if (selectedContainer) {
        if (pokerSelectedCardIndices.length === 0) {
            const message = pokerSelectionMode === 'discard' 
                ? 'Aucune carte s√©lectionn√©e pour d√©fausse' 
                : 'Aucune carte s√©lectionn√©e';
            selectedContainer.innerHTML = `<p style="opacity: 0.5; text-align: center; width: 100%; color: rgba(255,255,255,0.5);">${message}</p>`;
        } else {
            selectedContainer.innerHTML = pokerSelectedCardIndices.map(i => {
                const card = pokerDrawnCards[i];
                return `<div style="text-align: center;">
                    <img src="${card.sprite_url}" alt="${card.name}" style="width: 60px; height: 60px; border-radius: 10px; border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); background: rgba(0, 0, 0, 0.3); padding: 5px;">
                    <div style="font-size: 0.7em; color: #ffd700; margin-top: 5px; font-weight: 700;">${card.name}</div>
                </div>`;
            }).join('');
        }
    }
    
    // D√©tecter la combinaison si 1-5 cartes s√©lectionn√©es
    const playBtn = document.getElementById('poker-play-btn');
    const selectedCount = pokerSelectedCardIndices.length;
    
    if (selectedCount >= 1 && selectedCount <= 5) {
        const selectedCards = pokerSelectedCardIndices.map(i => pokerDrawnCards[i]);
        const detectedHand = detectBestHand(selectedCards);
        
        if (detectedHand) {
            document.getElementById('poker-detected-hand').innerHTML = `
                <span style="color: #ffd700; font-weight: 700; font-size: 18px;">
                    ${detectedHand.handType.name_fr || detectedHand.handType.name}
                </span>
                <br>
                <span style="font-size: 14px; opacity: 0.8;">
                    ${detectedHand.description || ''}
                </span>
                ${selectedCount < 5 ? `<br><span style="font-size: 12px; opacity: 0.6; color: rgba(255,255,255,0.7);">(${selectedCount}/5 cartes s√©lectionn√©es)</span>` : ''}
            `;
        }
        
        if (playBtn) playBtn.disabled = false;
    } else {
        document.getElementById('poker-detected-hand').textContent = 
            selectedCount === 0 
                ? 'S√©lectionnez 1 √† 5 cartes...'
                : `Maximum 5 cartes (${selectedCount} s√©lectionn√©es)`;
        if (playBtn) playBtn.disabled = true;
    }
}

// Fonction pour rendre les jokers actifs
function renderActiveJokers() {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const container = document.getElementById('poker-active-jokers');
    const countElement = document.getElementById('poker-jokers-count');
    if (!container || !countElement) return;
    
    const jokersCount = run.active_jokers.length;
    countElement.textContent = jokersCount;
    
    if (jokersCount === 0) {
        container.innerHTML = '<p style="opacity: 0.5; text-align: center; width: 100%; color: rgba(255,255,255,0.5);">Aucun joker actif</p>';
        return;
    }
    
    container.innerHTML = run.active_jokers.map((joker, index) => {
        // Chercher dans le catalogue d'abord, puis dans ALL_JOKERS
        let jokerData = null;
        if (CARDS_CATALOGUE && CARDS_CATALOGUE.jokers) {
            for (const rarity of ['common', 'uncommon', 'rare', 'legendary']) {
                const found = CARDS_CATALOGUE.jokers[rarity]?.find(j => j.id === joker.id);
                if (found) {
                    jokerData = found;
                    break;
                }
            }
        }
        if (!jokerData) {
            jokerData = ALL_JOKERS.find(j => j.id === joker.id) || joker;
        }
        
        const rarityColors = {
            common: 'rgba(200, 200, 200, 0.3)',
            uncommon: 'rgba(76, 175, 80, 0.3)',
            rare: 'rgba(33, 150, 243, 0.3)',
            super_rare: 'rgba(156, 39, 176, 0.3)',
            legendary: 'rgba(255, 215, 0, 0.3)'
        };
        const borderColors = {
            common: '#c8c8c8',
            uncommon: '#4caf50',
            rare: '#2196f3',
            super_rare: '#9c27b0',
            legendary: '#ffd700'
        };
        const rarity = jokerData.rarity || 'common';
        const overlapOffset = index * 10; // D√©calage pour superposition
        const tooltipText = jokerData.tooltip || jokerData.description_fr || jokerData.description || 'Aucune description';
        const scope = jokerData.scope || 'blind'; // blind ou run
        
        return `
            <div id="joker-${index}" 
                 style="width: 120px; height: 160px; background: linear-gradient(135deg, ${rarityColors[rarity]}, rgba(15,52,96,0.2)); 
                        border: 2px solid ${borderColors[rarity]}; border-radius: 12px; padding: 12px; text-align: center; 
                        position: relative; z-index: ${1000 - index}; margin-left: ${index > 0 ? '-10px' : '0'}; 
                        transform: translateX(${overlapOffset}px); cursor: pointer; transition: all 0.3s ease;"
                 onmouseenter="showJokerTooltip(${index}, '${tooltipText.replace(/'/g, "\\'")}', '${rarity}', '${scope}')"
                 onmouseleave="hideJokerTooltip(${index})">
                <div style="font-size: 48px; margin-bottom: 8px;">${jokerData.icon || 'üÉè'}</div>
                <div style="font-size: 12px; font-weight: 700; margin-bottom: 4px; color: ${borderColors[rarity]};">
                    ${jokerData.name_fr || jokerData.name || 'Joker'}
                </div>
                <div style="font-size: 9px; color: rgba(255,255,255,0.6); margin-bottom: 4px; text-transform: uppercase;">
                    ${rarity}
                </div>
                <div style="font-size: 10px; color: rgba(255,255,255,0.7); line-height: 1.2; max-height: 40px; overflow: hidden;">
                    ${tooltipText.substring(0, 60)}${tooltipText.length > 60 ? '...' : ''}
                </div>
                ${joker.uses_remaining !== undefined && joker.uses_remaining !== null ? 
                    `<div style="margin-top: 8px; font-size: 11px; color: #ffd700;">${joker.uses_remaining} utilisations</div>` : 
                    '<div style="margin-top: 8px; font-size: 11px; color: #4caf50;">Permanent</div>'
                }
                <div style="position: absolute; top: 5px; left: 5px; font-size: 10px; color: rgba(255,255,255,0.5);">
                    ${index + 1}
                </div>
            </div>
        `;
    }).join('');
}

// Afficher tooltip d'un joker
window.showJokerTooltip = function(index, tooltipText, rarity, scope) {
    // Supprimer tooltip existant
    const existing = document.getElementById(`joker-tooltip-${index}`);
    if (existing) existing.remove();
    
    const jokerElement = document.getElementById(`joker-${index}`);
    if (!jokerElement) return;
    
    const tooltip = document.createElement('div');
    tooltip.id = `joker-tooltip-${index}`;
    tooltip.style.cssText = `
        position: absolute; 
        top: 100%; 
        left: 50%; 
        transform: translateX(-50%) translateY(10px);
        background: linear-gradient(135deg, rgba(20, 20, 40, 0.98), rgba(15, 15, 30, 0.98));
        border: 2px solid ${rarity === 'legendary' ? '#ffd700' : rarity === 'rare' ? '#2196f3' : '#4caf50'};
        border-radius: 12px; 
        padding: 15px; 
        min-width: 200px; 
        max-width: 300px;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        pointer-events: none;
    `;
    tooltip.innerHTML = `
        <div style="color: white; font-weight: 700; margin-bottom: 8px; font-size: 1.1em;">
            ${tooltipText}
        </div>
        <div style="color: rgba(255,255,255,0.6); font-size: 0.85em; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
            <div>Port√©e: ${scope === 'run' ? 'Toute la run' : 'Ce blind'}</div>
            <div>Raret√©: ${rarity}</div>
            <div>Ordre: ${index + 1} (gauche‚Üídroite)</div>
        </div>
    `;
    
    jokerElement.style.position = 'relative';
    jokerElement.appendChild(tooltip);
};

// Cacher tooltip d'un joker
window.hideJokerTooltip = function(index) {
    const tooltip = document.getElementById(`joker-tooltip-${index}`);
    if (tooltip) tooltip.remove();
};

// Fonction pour jouer une main
window.handlePokerPlayHand = function() {
    // Passer en mode play
    pokerSelectionMode = 'play';
    
    if (pokerSelectedCardIndices.length < 1 || pokerSelectedCardIndices.length > 5) {
        showToast('S√©lectionnez entre 1 et 5 cartes pour jouer', 'error');
        return;
    }
    
    const selectedCards = pokerSelectedCardIndices.map(i => pokerDrawnCards[i]);
    const result = playSelectedHand(selectedCards);
    
    if (result) {
        // Afficher l'animation de scoring
        showPokerScoreAnimation(result);
        
        // Mettre √† jour l'UI avec les nouvelles cartes (d√©j√† g√©r√© dans playSelectedHand)
        renderDrawnCards(pokerDrawnCards);
        renderPokerRunScreen();
        
        // V√©rifier si le blind est compl√©t√©
        const run = gameState.poker.current_run;
        if (run && run.blind_current_score >= run.blind_target_score) {
            completeBlind();
        }
    }
    
    // R√©initialiser la s√©lection
    pokerSelectedCardIndices = [];
    updatePokerSelectionDisplay();
};

// Fonction pour d√©fausser et repiocher
window.handlePokerDiscard = function() {
    const run = gameState.poker.current_run;
    if (!run || run.discards_remaining <= 0) {
        showToast('Plus de d√©fausses disponibles', 'error');
        return;
    }
    
    // Passer en mode discard
    pokerSelectionMode = 'discard';
    
    if (pokerSelectedCardIndices.length === 0) {
        showToast('S√©lectionnez jusqu\'√† 3 cartes √† d√©fausser', 'warning');
        updatePokerSelectionDisplay();
        return;
    }
    
    if (pokerSelectedCardIndices.length > 3) {
        showToast('Maximum 3 cartes √† d√©fausser', 'error');
        return;
    }
    
    const discardedCount = pokerSelectedCardIndices.length;
    const newHand = discardAndRedraw(pokerDrawnCards, pokerSelectedCardIndices);
    if (newHand) {
        // R√©initialiser la s√©lection et le mode
        pokerSelectedCardIndices = [];
        pokerSelectionMode = 'play';
        renderDrawnCards(newHand);
        renderPokerRunScreen();
        showToast(`üîÑ ${discardedCount} carte(s) d√©fauss√©e(s) et repioch√©e(s)`, 'success');
    }
};

// Fonction pour d√©marrer une run (accessible depuis le bouton)
window.startPokerRun = function() {
    // Appeler la fonction interne directement
    if (isPokerRunActive()) {
        showToast('Une run est d√©j√† en cours !', 'error');
        return;
    }
    
    // Initialiser le deck si n√©cessaire
    initializePokerDeck();
    
    // Cr√©er nouvelle run
    gameState.poker.current_run = {
        active: true,
        run_id: 'run_' + Date.now(),
        start_time: Date.now(),
        current_ante: 1,
        current_blind: 'small',
        blinds_cleared: 0,
        deck: shuffleDeck(deepClone(gameState.poker.permanent_deck)),
        discard_pile: [],
        played_cards: [],
        chips: 100 + (gameState.poker.meta_upgrades.starting_chips_bonus || 0),
        hands_remaining: 3,
        discards_remaining: 2,
        active_jokers: [],
        buddy_id: gameState.buddy?.activeBuddyId || null,
        buddy_bonus_mult: 1.0,
        blind_target_score: calculateBlindTarget(1, 'small'),
        blind_current_score: 0,
        hands_played_this_blind: [],
        rewards: {
            chips_earned: 0,
            cards_unlocked: [],
            jokers_found: [],
            shards: 0,
            shiny_tokens: 0
        }
    };
    
    // Appliquer les effets du deck s√©lectionn√©
    if (typeof applyPokerDeckEffects === 'function') {
        applyPokerDeckEffects(gameState.poker.current_run);
    }
    
    // Appliquer l'effet de la Pi√®ce Rune (objet tenu)
    if (typeof getBuddyHeldItemEffect === 'function' && getBuddyHeldItemEffect('poker_coin_boost')) {
        // Le bonus sera appliqu√© dans finalizeRun
    }
    
    // Calculer bonus Buddy
    if (gameState.poker.current_run.buddy_id) {
        const buddy = gameState.buddy.buddies[gameState.poker.current_run.buddy_id];
        if (buddy) {
            gameState.poker.current_run.buddy_bonus_mult = 1 + (buddy.level * 0.01);
        }
    }
    
    // Log analytics
    gameState.poker.runs_started++;
    
    showToast('üé¥ Run Pok√©-Poker d√©marr√©e !', 'success');
    saveGame();
    
    // Afficher la page
    renderPokerPage();
};

// Fonction pour cr√©er le modal de shop
function createPokerShopModal() {
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const shop = gameState.poker.shop;
    
    // Cr√©er le modal
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = `
        display: flex !important;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
        padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(26, 26, 46, 0.95), rgba(22, 33, 62, 0.95)); 
                     border-radius: 20px; padding: 30px; max-width: 900px; width: 100%; max-height: 90vh; 
                     overflow-y: auto; position: relative;">
            <button onclick="closePokerShop()" 
                    style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); 
                           border: none; color: white; font-size: 24px; width: 40px; height: 40px; 
                           border-radius: 50%; cursor: pointer; display: flex; align-items: center; 
                           justify-content: center; transition: all 0.3s;"
                    onmouseenter="this.style.background='rgba(255,255,255,0.2)'"
                    onmouseleave="this.style.background='rgba(255,255,255,0.1)'">√ó</button>
            
            <h1 style="color: #ffd700; text-align: center; margin-bottom: 20px; font-size: 2em;">
                üõí SHOP
            </h1>
            
            <div class="poker-resources" style="display: flex; gap: 15px; justify-content: center; margin-bottom: 25px; 
                        background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                <span style="color: white; font-weight: 600;">üí∞ ${run.chips} chips</span>
                <span style="color: white; font-weight: 600;">üíé ${gameState.shards || 0} shards</span>
                <span style="color: white; font-weight: 600;">‚ú® ${gameState.rogue?.totalShinyTokens || 0} tokens</span>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; align-items: center; 
                        margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                <button onclick="handlePokerShopReroll()" 
                        class="btn btn--secondary" 
                        style="padding: 10px 20px;">
                    üîÑ Reroll (${shop.reroll_cost} chips)
                </button>
                <span style="color: rgba(255,255,255,0.7);">
                    ${shop.rerolls_available} rerolls restants
                </span>
            </div>
            
            <div id="poker-shop-offers" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                <!-- Offres rendues ici -->
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    renderPokerShopOffers(modal);
}

// Fonction pour rendre les offres du shop
function renderPokerShopOffers(modal) {
    const shop = gameState.poker.shop;
    const run = gameState.poker.current_run;
    if (!run) return;
    
    const container = modal.querySelector('#poker-shop-offers');
    if (!container) return;
    
    container.innerHTML = shop.current_offers.map(offer => {
        const canAfford = canAffordPurchase(offer.cost_chips, offer.cost_shards, offer.cost_shiny_tokens);
        const disabled = !canAfford.canAfford || offer.stock <= 0;
        
        let offerContent = '';
        
        if (offer.type === 'joker') {
            const joker = offer.item;
            offerContent = `
                <div style="font-size: 3em; margin-bottom: 10px;">${joker.icon || 'üÉè'}</div>
                <div style="font-weight: 700; color: white; margin-bottom: 5px; font-size: 1.1em;">
                    ${joker.name_fr || joker.name || 'Joker'}
                </div>
                <div style="font-size: 0.85em; color: rgba(255,255,255,0.7); margin-bottom: 15px; line-height: 1.4;">
                    ${joker.description_fr || joker.description || ''}
                </div>
            `;
        } else if (offer.type === 'pack') {
            const packIcons = {
                pack_common: 'üì¶',
                pack_rare: 'üéÅ',
                pack_shiny: '‚ú®',
                pack_legendary: 'üíé'
            };
            offerContent = `
                <div style="font-size: 3em; margin-bottom: 10px;">${packIcons[offer.item_id] || 'üì¶'}</div>
                <div style="font-weight: 700; color: white; margin-bottom: 5px; font-size: 1.1em;">
                    ${offer.name_fr || offer.name || 'Pack'}
                </div>
                <div style="font-size: 0.85em; color: rgba(255,255,255,0.7); margin-bottom: 15px; line-height: 1.4;">
                    ${offer.description_fr || offer.description || ''}
                </div>
            `;
        } else if (offer.type === 'consumable') {
            const consumableIcons = {
                extra_hand: 'üé´',
                extra_discard: 'üîÑ'
            };
            offerContent = `
                <div style="font-size: 3em; margin-bottom: 10px;">${consumableIcons[offer.item_id] || '‚ö°'}</div>
                <div style="font-weight: 700; color: white; margin-bottom: 5px; font-size: 1.1em;">
                    ${offer.name_fr || offer.name || 'Consommable'}
                </div>
                <div style="font-size: 0.85em; color: rgba(255,255,255,0.7); margin-bottom: 15px; line-height: 1.4;">
                    ${offer.description_fr || offer.description || ''}
                </div>
            `;
        } else if (offer.type === 'coupon') {
            offerContent = `
                <div style="font-size: 3em; margin-bottom: 10px;">üé´</div>
                <div style="font-weight: 700; color: #ffd700; margin-bottom: 5px; font-size: 1.1em;">
                    ${offer.name_fr || offer.name || 'Coupon'}
                </div>
                <div style="font-size: 0.85em; color: rgba(255,255,255,0.7); margin-bottom: 15px; line-height: 1.4;">
                    ${offer.description_fr || offer.description || ''}
                </div>
                <div style="background: rgba(255, 215, 0, 0.2); padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255, 215, 0, 0.4);">
                    <div style="color: #ffd700; font-size: 0.9em; font-weight: 700;">Ante ${offer.ante_number}</div>
                </div>
            `;
        }
        
        return `
            <div style="background: ${disabled ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)'}; 
                        border: 2px solid ${disabled ? '#444' : '#e94560'}; 
                        border-radius: 12px; padding: 20px; text-align: center;
                        opacity: ${disabled ? 0.5 : 1};
                        transition: all 0.3s ease;">
                ${offerContent}
                
                <div style="margin-bottom: 15px;">
                    ${offer.cost_chips ? `<div style="color: #ffd700; font-weight: 600; margin: 5px 0;">üí∞ ${offer.cost_chips} chips</div>` : ''}
                    ${offer.cost_shards ? `<div style="color: #2196f3; font-weight: 600; margin: 5px 0;">üíé ${offer.cost_shards} shards</div>` : ''}
                    ${offer.cost_shiny_tokens ? `<div style="color: #ff9800; font-weight: 600; margin: 5px 0;">‚ú® ${offer.cost_shiny_tokens} tokens</div>` : ''}
                </div>
                
                <div style="font-size: 0.85em; color: rgba(255,255,255,0.6); margin-bottom: 10px;">
                    Stock: ${offer.stock}
                </div>
                
                <button onclick="handlePokerShopPurchase('${offer.id}')" 
                        class="btn ${disabled ? 'btn--secondary' : 'btn--primary'}" 
                        style="width: 100%; padding: 12px;"
                        ${disabled ? 'disabled' : ''}>
                    ${disabled ? (offer.stock <= 0 ? '√âpuis√©' : canAfford.reason) : 'Acheter'}
                </button>
            </div>
        `;
    }).join('');
}

// Fonction pour fermer le shop et retourner au lobby
window.closePokerShop = function() {
    const modal = document.querySelector('.modal.active');
    const run = gameState.poker.current_run;
    
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            modal.remove();
            
            // V√©rifier si c'√©tait un boss blind pour afficher le r√©cap d'Ante
            if (run && run.current_blind === 'boss' && run.blinds_status && run.blinds_status.boss) {
                // Afficher le r√©cap d'Ante
                showAnteCompleteScreen(run.current_ante, () => {
                    // Apr√®s le r√©cap d'Ante, retourner au lobby
                    renderPokerPage();
                });
            } else {
                // Sinon, retourner directement au lobby
                renderPokerPage();
            }
        }, 300);
    }
};

// Fonction pour g√©rer l'achat dans le shop
window.handlePokerShopPurchase = function(offerId) {
    purchaseShopOffer(offerId);
    
    // Mettre √† jour le modal
    const modal = document.querySelector('.modal.active');
    if (modal) {
        const run = gameState.poker.current_run;
        if (run) {
            // Mettre √† jour les ressources affich√©es
            const resourceSpans = modal.querySelectorAll('.poker-resources span');
            if (resourceSpans.length >= 3) {
                resourceSpans[0].textContent = `üí∞ ${run.chips} chips`;
                resourceSpans[1].textContent = `üíé ${gameState.shards || 0} shards`;
                resourceSpans[2].textContent = `‚ú® ${gameState.rogue?.totalShinyTokens || 0} tokens`;
            }
        }
        
        renderPokerShopOffers(modal);
    }
    
    // Mettre √† jour l'√©cran de run
    renderPokerRunScreen();
};

// Fonction pour g√©rer le reroll du shop
window.handlePokerShopReroll = function() {
    rerollShop();
    
    // Mettre √† jour le modal
    const modal = document.querySelector('.modal.active');
    if (modal) {
        renderPokerShopOffers(modal);
        
        const shop = gameState.poker.shop;
        const run = gameState.poker.current_run;
        
        // Mettre √† jour l'affichage des ressources et rerolls
        modal.querySelector('span').textContent = `üí∞ ${run.chips} chips`;
        const rerollBtn = modal.querySelector('button');
        if (rerollBtn) {
            rerollBtn.textContent = `üîÑ Reroll (${shop.reroll_cost} chips)`;
        }
        const rerollText = modal.querySelector('span:last-of-type');
        if (rerollText) {
            rerollText.textContent = `${shop.rerolls_available} rerolls restants`;
        }
    }
    
    // Mettre √† jour l'√©cran de run
    renderPokerRunScreen();
};

// Fonction pour afficher l'animation de scoring
function showPokerScoreAnimation(scoreResult) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = `
        display: flex !important;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 10001;
        align-items: center;
        justify-content: center;
    `;
    
    const handType = scoreResult.hand.handType;
    const handName = handType.name_fr || handType.name;
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(233,69,96,0.9), rgba(15,52,96,0.9)); 
                     border-radius: 20px; padding: 40px; text-align: center; max-width: 600px; 
                     width: 90%; animation: scaleIn 0.3s ease;">
            <h2 style="color: #ffd700; font-size: 2em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255,215,0,0.5);">
                ${handName}
            </h2>
            
            <div style="color: rgba(255,255,255,0.8); margin-bottom: 30px; font-size: 1.1em;">
                ${scoreResult.hand.description || ''}
            </div>
            
            <div style="background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                    <div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 5px;">CHIPS</div>
                        <div id="score-chips" style="color: #ffd700; font-size: 2em; font-weight: 700;">0</div>
                    </div>
                    <div style="font-size: 2em; color: rgba(255,255,255,0.5);">√ó</div>
                    <div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 5px;">MULT</div>
                        <div id="score-mult" style="color: #4caf50; font-size: 2em; font-weight: 700;">0</div>
                    </div>
                </div>
                
                <div style="border-top: 2px solid rgba(255,255,255,0.2); padding-top: 15px; margin-top: 15px;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-bottom: 5px;">SCORE FINAL</div>
                    <div id="score-final" style="color: #ffd700; font-size: 3em; font-weight: 700; text-shadow: 0 0 30px rgba(255,215,0,0.8);">0</div>
                </div>
            </div>
            
            <button onclick="this.closest('.modal').remove()" 
                    class="btn btn--primary" 
                    style="padding: 15px 40px; font-size: 1.2em;">
                Continuer
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Animer les compteurs
    animateCounter(modal.querySelector('#score-chips'), 0, scoreResult.score.chips, 800);
    setTimeout(() => {
        animateCounter(modal.querySelector('#score-mult'), 0, scoreResult.score.mult, 800);
    }, 400);
    setTimeout(() => {
        animateCounter(modal.querySelector('#score-final'), 0, scoreResult.score.finalScore, 1200);
    }, 1200);
}

// Fonction helper pour animer un compteur
function animateCounter(element, start, end, duration) {
    if (!element) return;
    
    const startTime = Date.now();
    const diff = end - start;
    
    function update() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing out cubic
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = start + (diff * eased);
        
        element.textContent = Math.floor(current).toLocaleString('fr-FR');
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    update();
}

// Animation de transition de blind (style Balatro)
function showBlindTransitionAnimation(oldBlind, newBlind, chipsEarned, callback) {
    const blindNames = {
        small: 'SMALL BLIND',
        big: 'BIG BLIND',
        boss: 'BOSS'
    };
    
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10002;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    overlay.innerHTML = `
        <div style="text-align: center; animation: slideUp 0.5s ease;">
            <div style="font-size: 1.5em; color: rgba(255,255,255,0.6); margin-bottom: 20px; animation: fadeOut 0.8s ease 0.5s forwards;">
                ${blindNames[oldBlind]} COMPL√âT√â
            </div>
            <div style="font-size: 4em; color: #ffd700; font-weight: 700; text-shadow: 0 0 40px rgba(255,215,0,0.8); margin-bottom: 30px; animation: scaleBounce 0.6s ease 0.8s;">
                ${blindNames[newBlind]}
            </div>
            ${chipsEarned > 0 ? `
                <div style="font-size: 1.8em; color: #4caf50; margin-bottom: 20px; animation: slideUp 0.5s ease 1.2s; opacity: 0; animation-fill-mode: forwards;">
                    üí∞ +${formatNumber(chipsEarned)} chips
                </div>
            ` : ''}
            <div style="font-size: 1.2em; color: rgba(255,255,255,0.5); animation: fadeIn 0.5s ease 1.5s; opacity: 0; animation-fill-mode: forwards;">
                Pr√©paration...
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Vibration l√©g√®re de l'√©cran
    document.body.style.animation = 'screenShake 0.3s ease 0.8s';
    setTimeout(() => {
        document.body.style.animation = '';
    }, 1100);
    
    // Particules de feu montantes
    createFireParticles(overlay, 50);
    
    // Fermer apr√®s animation
    setTimeout(() => {
        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            overlay.remove();
            if (callback) callback();
        }, 300);
    }, 2000);
}

// Animation de changement d'Ante avec badge (style Balatro)
function showAnteChangeAnimation(oldAnte, newAnte, chipsEarned, callback) {
    const anteConfig = getAnteConfig(oldAnte);
    const newAnteConfig = getAnteConfig(newAnte);
    
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(0,0,0,0.98), rgba(26,26,46,0.98));
        z-index: 10003;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.4s ease;
    `;
    
    overlay.innerHTML = `
        <div style="text-align: center; max-width: 800px; width: 90%;">
            <!-- Badge Unlocked -->
            <div style="margin-bottom: 40px; animation: badgeReveal 1s ease;">
                <div style="font-size: 6em; margin-bottom: 20px; animation: badgeSpin 0.8s ease; filter: drop-shadow(0 0 30px rgba(255,215,0,0.8));">
                    ${anteConfig?.badge_icon || 'üèÜ'}
                </div>
                <div style="font-size: 2.5em; color: #ffd700; font-weight: 700; text-shadow: 0 0 30px rgba(255,215,0,0.6); margin-bottom: 10px;">
                    BADGE D√âBLOQU√â !
                </div>
                <div style="font-size: 1.5em; color: rgba(255,255,255,0.9);">
                    ${anteConfig?.badge_name_fr || `Badge ${oldAnte}`}
                </div>
            </div>
            
            <!-- Transition Ante -->
            <div style="margin-bottom: 30px; animation: slideUp 0.6s ease 1s; opacity: 0; animation-fill-mode: forwards;">
                <div style="font-size: 1.2em; color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                    ANTE ${oldAnte} ‚Üí ANTE ${newAnte}
                </div>
                <div style="font-size: 3em; color: #ffd700; font-weight: 700; text-shadow: 0 0 40px rgba(255,215,0,0.8);">
                    ANTE ${newAnte}
                </div>
                ${newAnteConfig ? `
                    <div style="font-size: 1.3em; color: rgba(255,255,255,0.8); margin-top: 10px;">
                        ${newAnteConfig.badge_name_fr}
                    </div>
                ` : ''}
            </div>
            
            ${chipsEarned > 0 ? `
                <div style="font-size: 1.8em; color: #4caf50; margin-bottom: 20px; animation: slideUp 0.5s ease 1.5s; opacity: 0; animation-fill-mode: forwards;">
                    üí∞ +${formatNumber(chipsEarned)} chips
                </div>
            ` : ''}
            
            <div style="font-size: 1.2em; color: rgba(255,255,255,0.5); animation: fadeIn 0.5s ease 2s; opacity: 0; animation-fill-mode: forwards;">
                Shop disponible...
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Vibration plus forte pour le badge
    document.body.style.animation = 'screenShakeStrong 0.5s ease 0.5s';
    setTimeout(() => {
        document.body.style.animation = '';
    }, 1000);
    
    // Confetti et particules dor√©es
    createConfettiBurst(overlay, 100);
    createGoldParticles(overlay, 80);
    
    // Fermer apr√®s animation
    setTimeout(() => {
        overlay.style.animation = 'fadeOut 0.4s ease';
        setTimeout(() => {
            overlay.remove();
            if (callback) callback();
        }, 400);
    }, 2500);
}

// Cr√©er des particules de feu montantes
function createFireParticles(container, count) {
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        const tx = (Math.random() - 0.5) * 200;
        const ty = -100 - Math.random() * 100;
        particle.style.cssText = `
            position: absolute;
            width: ${4 + Math.random() * 4}px;
            height: ${4 + Math.random() * 4}px;
            background: radial-gradient(circle, #ff6b00, #ffd700);
            border-radius: 50%;
            left: ${Math.random() * 100}%;
            bottom: -10px;
            opacity: ${0.6 + Math.random() * 0.4};
            box-shadow: 0 0 10px rgba(255,107,0,0.8);
            --tx: ${tx}px;
            --ty: ${ty}px;
        `;
        particle.style.animation = `fireRise ${1 + Math.random() * 1}s ease-out forwards`;
        container.appendChild(particle);
        
        setTimeout(() => particle.remove(), 2000);
    }
}

// Cr√©er un burst de confetti
function createConfettiBurst(container, count) {
    const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd'];
    for (let i = 0; i < count; i++) {
        const confetti = document.createElement('div');
        const color = colors[Math.floor(Math.random() * colors.length)];
        const angle = Math.random() * Math.PI * 2;
        const distance = 200 + Math.random() * 150;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance;
        confetti.style.cssText = `
            position: absolute;
            width: ${6 + Math.random() * 4}px;
            height: ${6 + Math.random() * 4}px;
            background: ${color};
            left: 50%;
            top: 50%;
            opacity: 0.9;
            --tx: ${tx}px;
            --ty: ${ty}px;
            transform: rotate(${Math.random() * 360}deg);
        `;
        confetti.style.animation = `confettiBurst ${1.5 + Math.random() * 0.5}s ease-out forwards`;
        container.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 2000);
    }
}

// Cr√©er des particules dor√©es
function createGoldParticles(container, count) {
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        const tx = (Math.random() - 0.5) * 100;
        const ty = -50 - Math.random() * 50;
        particle.style.cssText = `
            position: absolute;
            width: ${3 + Math.random() * 3}px;
            height: ${3 + Math.random() * 3}px;
            background: radial-gradient(circle, #ffd700, #ffed4e);
            border-radius: 50%;
            left: ${Math.random() * 100}%;
            top: ${Math.random() * 100}%;
            opacity: ${0.7 + Math.random() * 0.3};
            --tx: ${tx}px;
            --ty: ${ty}px;
            box-shadow: 0 0 8px rgba(255,215,0,0.6);
        `;
        particle.style.animation = `goldFloat ${2 + Math.random() * 1}s ease-out forwards`;
        container.appendChild(particle);
        
        setTimeout(() => particle.remove(), 3000);
    }
}

let runState = null;

const ITEM_API_MAP = {
    pokeball: 'poke-ball',
    greatball: 'great-ball',
    ultraball: 'ultra-ball',
    masterball: 'master-ball',
    diveball: 'dive-ball',
    framby: 'razz-berry',
    pinap: 'pinap-berry',
    ceriz: 'cheri-berry',
    fire_stone: 'fire-stone',
    water_stone: 'water-stone',
    thunder_stone: 'thunder-stone',
    moon_stone: 'moon-stone',
    leaf_stone: 'leaf-stone'
};

function getItemIcon(itemId){
    if(ITEM_API_MAP[itemId]){
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${ITEM_API_MAP[itemId]}.png`;
    }
    return ALL_ITEMS[itemId]?.icon || 'üì¶';
}

function getItemIconDisplay(itemId, size = '1em'){
    const icon = getItemIcon(itemId);
    if(icon.startsWith('http')){
        return `<img src="${icon}" style="width: ${size}; height: ${size}; image-rendering: pixelated; vertical-align: middle; display: inline-block;" alt="${ALL_ITEMS[itemId]?.name || itemId}">`;
    }
    return icon;
}

/* =========================================
   NOUVEAU SYST√àME DE LOOTBOX (Style Pok√©Meow)
   ========================================= */

// Configuration des Drops de Lootbox
const LOOTBOX_TIERS = {
    'lootbox': {
        name: 'Lootbox Classique',
        price: 800, // Prix r√©duit (√©tait 1000)
        minItems: 2, maxItems: 4,
        itemPool: ['pokeball', 'greatball', 'framby', 'pinap'],
        // Cash-Back : Souvent un petit remboursement, rarement un profit
        coinDrop: { min: 100, max: 500, chance: 1.0 }, 
        // Jackpots : Petites chances de gros lots
        jackpots: [
            { id: 'diveball', qty: 5, chance: 0.10 }, // 10%
            { id: 'expedition_ticket', qty: 1, chance: 0.05 }, // 5% (Ticket Rogue)
            { id: 'coins_jackpot', qty: 5000, chance: 0.01 } // 1% (Gros sac de pi√®ces)
        ],
        // Note: Les ≈ìufs sont g√©r√©s s√©par√©ment dans openLootbox
    },
    'rarebox': {
        name: 'Rare Box',
        price: 2500, // Prix r√©duit (√©tait 3000)
        minItems: 3, maxItems: 5,
        itemPool: ['greatball', 'ultraball', 'framby', 'pinap', 'incensefleur'],
        coinDrop: { min: 500, max: 2000, chance: 1.0 },
        // Garanties
        guaranteed: [{ id: 'shard_common', qty: 1 }], // Toujours 1 Shard
        jackpots: [
            { id: 'fire_stone', qty: 1, chance: 0.05 },
            { id: 'water_stone', qty: 1, chance: 0.05 },
            { id: 'thunder_stone', qty: 1, chance: 0.05 },
            { id: 'shiny_token', qty: 1, chance: 0.05 } // 5% Shiny Token
        ]
    },
    'suprarebox': {
        name: 'Super Rare Box',
        price: 7000,
        minItems: 4, maxItems: 6,
        itemPool: ['ultraball', 'diveball', 'ceriz', 'marin_lure', 'exp_charm'],
        coinDrop: { min: 2000, max: 10000, chance: 1.0 }, // Chance de rembourser la box !
        guaranteed: [
            { id: 'shard_rare', qty: 1 },
            { id: 'shiny_token', qty: 2 } // 2 Shiny Tokens garantis
        ],
        jackpots: [
            { id: 'masterball', qty: 1, chance: 0.02 }, // 2% Masterball
            { id: 'mystery_egg', qty: 1, chance: 0.05 }, // 5% Oeuf
            { id: 'coins_mega_jackpot', qty: 25000, chance: 0.05 } // 5% Jackpot massif
        ]
    },
    'ultrabox': {
        name: 'Masterbox',
        price: 20000, // Prix augment√© (Premium)
        minItems: 5, maxItems: 8,
        itemPool: ['ultraball', 'masterball', 'ceriz', 'lucky_charm', 'charm_collection'],
        coinDrop: { min: 2500, max: 10000, chance: 1.0 },
        guaranteed: [
            { id: 'shard_legendary', qty: 1 },
            { id: 'shiny_token', qty: 5 }
        ],
        jackpots: [
            { id: 'masterball', qty: 2, chance: 0.10 }, // 10% Double Masterball
            { id: 'lucky_charm', qty: 1, chance: 0.05 }, // 5% Lucky Charm (Objet rare)
            { id: 'coins_giga_jackpot', qty: 50000, chance: 0.01 } // 1% LE GROS LOT
        ]
    }
};

const ALL_ITEMS = {
    pokeball:{name:'Pok√© Ball x10',icon:'‚öæ',desc:'Ball de base (50%)',price:500,qty:10},
    greatball:{name:'Super Ball x5',icon:'üîµ',desc:'Ball am√©lior√©e (70%)',price:1000,qty:5},
    ultraball:{name:'Hyper Ball x5',icon:'‚ö´',desc:'Ball puissante (90%)',price:2400,qty:5},
    masterball:{name:'Master Ball x1',icon:'üíú',desc:'100% garanti',price:10000,qty:1},
    diveball:{name:'Scuba Ball x5',icon:'üíß',desc:'Bonus eau (√ó1.5)',price:500,qty:5},
    framby:{name:'Baie Framby x5',icon:'üçì',desc:'+50% capture',price:1000,qty:5},
    pinap:{name:'Baie Pinap x5',icon:'üçç',desc:'√ó2 coins si capture',price:600,qty:5},
    ceriz:{name:'Baie Ceriz x3',icon:'üçí',desc:'+100% capture Shiny',price:2000,qty:3},
    incensefleur:{name:'Encens Mystique',icon:'üåÄ',desc:'+20% rares (10min)',price:2000,qty:1},
    marin_lure:{name:'App√¢t Marin',icon:'ü™∏',desc:'√ó2 captures eau (10min)',price:1200,qty:1},
    exp_charm:{name:'Amulette Exp',icon:'üìò',desc:'+25% XP (15min)',price:1500,qty:1},
    lucky_charm:{name:'Talisman Chanceux',icon:'üçÄ',desc:'+0.5% shiny (30min)',price:3500,qty:1},
    charm_collection:{name:'Charm Collection',icon:'üíé',desc:'+10% nouveau Pok√©mon (20mn)',price:4000,qty:1},
    legendary_radar:{name:'Radar L√©gendaire',icon:'üß≠',desc:'Rencontre l√©gendaire',price:0,qty:1},
    fire_stone:{name:'Pierre Feu',icon:'üî•',desc:'√âvolue en feu',price:2500,qty:1},
    water_stone:{name:'Pierre Eau',icon:'üíß',desc:'√âvolue en eau',price:2500,qty:1},
    thunder_stone:{name:'Pierre Foudre',icon:'‚ö°',desc:'√âvolue √©lectrik',price:2500,qty:1},
    moon_stone:{name:'Pierre Lune',icon:'üåô',desc:'√âvolue sous lune',price:2500,qty:1},
    leaf_stone:{name:'Pierre Plante',icon:'üçÉ',desc:'√âvolue plante',price:2500,qty:1},
    lootbox:{name:'Lootbox',icon:'üì¶',desc:'Items vari√©s + Chance de Coins & Tickets',price:800,qty:1},
    rarebox:{name:'Rare Box',icon:'üéÅ',desc:'Items Rares + Shards & Coins garantis',price:2500,qty:1},
    suprarebox:{name:'Super Rare Box',icon:'üíé',desc:'Objets Premium + Shiny Tokens garantis',price:7000,qty:1},
    ultrabox:{name:'Masterbox',icon:'üß∞',desc:'Le top du top. Jackpot Masterball possible !',price:20000,qty:1},
    mystery_egg:{name:'≈íuf Myst√®re',icon:'ü•ö',desc:'Pok√©mon autre r√©gion',price:10000,qty:1},
    // Tr√©sors de p√™che (vendables)
    pearl:{name:'Perle',icon:'‚ö™',desc:'Une jolie perle. Se vend bon prix.',price:0,qty:1,sellPrice:1000},
    big_pearl:{name:'Grande Perle',icon:'‚ö™',desc:'Une perle √©norme. Tr√®s pr√©cieuse.',price:0,qty:1,sellPrice:4000},
    stardust:{name:'Poussi√®re √âtoile',icon:'‚ú®',desc:'Sable rouge magnifique. Se vend bien.',price:0,qty:1,sellPrice:2000},
    star_piece:{name:'Morceau √âtoile',icon:'‚≠ê',desc:'Un fragment de joyau spatial.',price:0,qty:1,sellPrice:6000},
    heart_scale:{name:'√âcaille C≈ìur',icon:'üíñ',desc:'Une √©caille rare. Les collectionneurs l\'adorent.',price:0,qty:1,sellPrice:500},
    golden_magikarp:{name:'Statue Dor√©e',icon:'üèÜ',desc:'Une statuette en or massif.',price:0,qty:1,sellPrice:15000}
};

const POKEMON_LORE = {
    // --- KANTO (GEN 1) ---
    1: "Il porte une plante sur le dos. En cas de famine, ce sera le premier √† y passer.",
    2: "La plante sur son dos grandit et lui pompe toute son √©nergie. Une belle m√©taphore de la vie adulte.",
    3: "Sa fleur sent bon pour attirer les proies. Si tu t'approches trop, tu finis en compost.",
    4: "Si sa flamme s'√©teint, il meurt. √âvitez de l'emmener √† la piscine ou sous la pluie.",
    5: "Un ado col√©rique avec une queue en feu. Il br√ªle tout ce qu'il touche, y compris vos relations sociales.",
    6: "Il se prend pour un dragon mais n'en a pas le type. Crise d'identit√© majeure.",
    7: "Il cache sa t√™te dans sa carapace pour fuir ses responsabilit√©s. On le comprend.",
    8: "Il a des oreilles ail√©es mais ne vole pas. La nature est parfois cruelle.",
    9: "Il a des canons dans le dos pour compenser quelque chose. Probablement sa lenteur.",
    10: "Une chenille qui r√™ve de grandeur. Pour l'instant, elle sert surtout de casse-cro√ªte aux oiseaux.",
    11: "Il ne bouge pas d'un pouce. Id√©al comme cale-porte, inutile en combat.",
    12: "Il s√®me une poudre toxique en volant. Une arme biologique avec des ailes mignonnes.",
    13: "Il a un dard sur la t√™te et un autre au derri√®re. Il n'aime personne et √ßa se voit.",
    14: "Il attend d'√©voluer en fixant le vide. Passionnant.",
    15: "Un frelon sous st√©ro√Ødes avec des foreuses √† la place des mains. Cauchemar pur.",
    16: "Le rat volant des villes. Il vous chie dessus pour porter bonheur.",
    17: "Il a l'air m√©chant, mais c'est juste un gros pigeon avec une cr√™te.",
    18: "Il vole √† Mach 2. Dommage qu'il ne l'utilise que pour fuir les combats difficiles.",
    19: "Il ronge tout, m√™me vos murs. Le colocataire que personne ne veut.",
    20: "Ses dents poussent en permanence. S'il ne ronge pas, elles lui transpercent le cerveau. Sympa.",
    21: "Il crie fort pour compenser sa petite taille. Le complexe de Napol√©on en version plume.",
    22: "Il peut voler toute la journ√©e. Il vous suivra jusqu'√† ce que vous mouriez d'√©puisement.",
    23: "Il s'enroule autour de sa proie et serre jusqu'√† entendre un 'crac'. C√¢lin mortel.",
    24: "Il a un visage sur le ventre pour effrayer les l√¢ches. Si √ßa marche, c'est que vous √™tes l√¢che.",
    25: "La mascotte surcot√©e. Il refuse de rentrer dans sa Ball par pur narcissisme.",
    26: "La version adulte de Pikachu que tout le monde oublie. Il vit dans l'ombre de son petit fr√®re.",
    27: "Il se roule en boule pour √©viter les probl√®mes. Une strat√©gie de vie valid√©e.",
    28: "Ses griffes peuvent trancher l'acier, mais il pr√©f√®re creuser des trous pour se cacher.",
    29: "Petite et toxique. Ne la caressez pas √† rebrousse-poil si vous tenez √† votre main.",
    30: "Elle m√¢che sa nourriture pour ses petits. D√©goutant mais maternel.",
    31: "Une m√®re poule blind√©e. Si vous touchez √† ses petits, elle vous brise les os.",
    32: "Il √©coute tout avec ses grandes oreilles. Le roi des comm√®res.",
    33: "Sa corne est plus dure que le diamant. Il s'en sert pour tout casser, juste pour le fun.",
    34: "Il brise la colonne vert√©brale de ses proies avant de les manger. Bon app√©tit.",
    35: "Ils viennent de la lune. Probablement pour nous envahir avec leur mignonnerie.",
    36: "Il entend une aiguille tomber √† 1km. Impossible de lui faire une f√™te surprise.",
    37: "Il est mignon tant qu'il est jeune. Apr√®s, il devient un esprit vengeur mill√©naire.",
    38: "Il peut vivre 1000 ans. Il vous regardera vieillir et mourir sans prendre une ride.",
    39: "Il chante pour vous endormir et vous dessine sur le visage. Le troll ultime.",
    40: "Son corps est √©lastique. On peut jouer au ballon avec, il aime √ßa (peut-√™tre).",
    41: "Il n'a pas d'yeux, mais il vous trouvera pour boire votre sang. Dormez bien.",
    42: "Il peut boire 300ml de sang en une fois. Pratique pour les dons du sang, mortel pour vous.",
    43: "Une mauvaise herbe qui marche. Arrachez-la avant qu'elle ne se multiplie.",
    44: "Il bave un nectar qui sent la vieille chaussette. Personne ne veut √™tre son ami.",
    45: "La plus grande fleur du monde, et aussi celle qui pue le plus. L'odeur de la mort.",
    46: "Les champignons sur son dos le contr√¥lent. Ce n'est pas un Pok√©mon, c'est un zombie.",
    47: "Le champignon a totalement pris le contr√¥le. L'insecte est mort √† l'int√©rieur. Glauque.",
    48: "Ses yeux sont des radars. Il vous regarde dormir.",
    49: "Il disperse des √©cailles toxiques. Si vous √©ternuez, vous √™tes d√©j√† empoisonn√©.",
    50: "Personne ne sait √† quoi ressemble le bas de son corps. C'est peut-√™tre mieux ainsi.",
    51: "Trois t√™tes qui pensent la m√™me chose : 'Creuser'. Une vie intellectuelle limit√©e.",
    52: "Il aime l'argent plus que son dresseur. Il vous vendrait pour une pi√®ce brillante.",
    53: "Hautain et capricieux. Il vous tol√®re juste parce que vous le nourrissez.",
    54: "Il a une migraine constante. Ses pouvoirs psy se d√©clenchent quand il souffre. Sadique.",
    55: "Il nage vite et utilise la t√©l√©pathie. Le ma√Ætre nageur qui triche.",
    56: "Il s'√©nerve pour rien. Si vous le regardez, il frappe. Si vous l'ignorez, il frappe.",
    57: "Il est tellement en col√®re qu'il peut mourir de rage. La gestion de la col√®re, il connait pas.",
    58: "Le chien policier parfait. Il mord les criminels et bave sur les preuves.",
    59: "Un chien l√©gendaire qui court comme le vent. Il est majestueux et il le sait.",
    60: "Son ventre est transparent. On voit ses organes. C'est d√©rangeant.",
    61: "Il peut marcher sur terre mais pr√©f√®re l'eau pour ne pas s√©cher sa peau gluante.",
    62: "Un t√™tard sous st√©ro√Ødes. Il a des muscles sur les muscles.",
    63: "Il dort 18h par jour et se t√©l√©porte au moindre danger. Lache et paresseux.",
    64: "Il a une cuill√®re pour amplifier ses pouvoirs. Ou pour manger sa soupe, on sait pas.",
    65: "Un QI de 5000. Il sait que vous allez perdre avant m√™me de commencer.",
    66: "Il s'entra√Æne tout le temps. Il a plus de muscles dans un doigt que vous dans tout le corps.",
    67: "Il porte une ceinture pour contenir sa puissance. Sans elle, il explose ?",
    68: "Quatre bras pour faire la vaisselle plus vite. Ou pour vous casser en quatre.",
    69: "Une plante qui mange des insectes. Si vous √™tes petit, courez.",
    70: "Il vous avale tout rond s'il a faim. L'acide fait le reste.",
    71: "Il attire ses proies avec une odeur sucr√©e. Le pi√®ge classique du pr√©dateur.",
    72: "99% d'eau, 1% de m√©chancet√© pure. Ne marchez pas dessus.",
    73: "Il a 80 tentacules. C'est beaucoup trop de tentacules.",
    74: "Un caillou avec des bras. Il s'√©nerve si on marche dessus. D√©sol√©, tu ressembles √† un caillou.",
    75: "Il d√©vale les montagnes en √©crasant tout. Les randonneurs l'adorent.",
    76: "Il explose parfois sans raison. Une mine antipersonnel vivante.",
    77: "Il saute par-dessus la Tour Eiffel (soi-disant). Il a aussi des sabots en diamant.",
    78: "Il court √† 240 km/h. Si vous tombez, vous √™tes r√¢p√© comme du fromage.",
    79: "Il est lent. Si on lui coupe la queue, il ne s'en rend compte que le lendemain.",
    80: "Il est devenu intelligent parce qu'un coquillage lui mord les fesses. La douleur √©veille.",
    81: "Il flotte et brouille les ondes radio. Les techniciens t√©l√©coms le d√©testent.",
    82: "Trois Magn√©ti coll√©s ensemble. L'√©volution la plus paresseuse de l'histoire.",
    83: "Il se bat avec un poireau. C'est ridicule, mais √ßa fait mal.",
    84: "Deux t√™tes qui se disputent tout le temps. La schizophr√©nie aviaire.",
    85: "Trois t√™tes : Joie, Tristesse et Col√®re. Un film Pixar sur pattes.",
    86: "Il aime le froid. Si vous avez froid, il est content. √âgo√Øste.",
    87: "Il stocke la chaleur dans son corps. Une bouillotte vivante qui nage.",
    88: "Un tas de boue vivante. Il pue, il pollue, et il aime √ßa.",
    89: "Il est encore plus toxique. Sa trace tue les plantes. L'ennemi de l'√©cologie.",
    90: "Il tire la langue aux gens. Impertinent et blind√©.",
    91: "Sa coquille est plus dure que le diamant. Il sourit, mais c'est un psychopathe.",
    92: "Une boule de gaz. Si vous respirez √† c√¥t√© de lui, vous vous √©vanouissez.",
    93: "Il vous l√®che pour voler votre vie. Ne sortez pas la nuit.",
    94: "Il se cache dans votre ombre et attend que vous soyez seul. Rassurant.",
    95: "Un ver de terre g√©ant fait de pierres. Il creuse des tunnels et effondre les maisons.",
    96: "Il mange vos r√™ves. Si vous faites des cauchemars, c'est qu'il n'a pas faim.",
    97: "Il kidnappe les enfants qui lui ressemblent. La police le recherche activement.",
    98: "Un crabe. Juste un crabe. Avec un regard vide.",
    99: "Sa pince est √©norme mais trop lourde. Il a du mal √† garder l'√©quilibre. Ridicule.",
    100: "Il ressemble √† une Pok√©ball. Si vous le ramassez, il explose. Pi√®ge classique.",
    101: "Il aime l'√©lectricit√©. Il provoque des pannes de courant pour se nourrir.",
    102: "Des ≈ìufs qui communiquent par t√©l√©pathie. S'ils cassent, ils reviennent ?",
    103: "Un arbre √† trois t√™tes qui rigolent tout le temps. C'est flippant.",
    104: "Il porte le cr√¢ne de sa m√®re morte. Th√©rapie n√©cessaire, urgemment.",
    105: "Il a surmont√© son deuil en devenant violent. Il frappe avec un os.",
    106: "Ses jambes s'allongent pour frapper. Il peut vous botter les fesses √† 5 m√®tres.",
    107: "Il frappe plus vite que son ombre. Ne l'√©nervez pas.",
    108: "Sa langue fait deux fois sa taille. Il l√®che tout pour m√©moriser les textures. Berk.",
    109: "Une mine flottante remplie de gaz. Ne fumez pas √† c√¥t√©.",
    110: "Deux mines flottantes. Double dose de pollution.",
    111: "Son cerveau est minuscule. Il court tout droit et d√©fonce tout. Un b√©lier idiot.",
    112: "Il peut survivre dans la lave. Pratique pour le tourisme volcanique.",
    113: "Il donne ses ≈ìufs aux bless√©s. C'est gentil, mais d'o√π sortent les ≈ìufs ?",
    114: "Un tas de lianes avec des chaussures. Personne ne sait ce qu'il y a dessous.",
    115: "La m√®re protectrice ultime. Le b√©b√© dans la poche sort-il un jour ?",
    116: "Il crache de l'encre pour fuir. Un l√¢che aquatique.",
    117: "Il nage √† reculons. Il ne sait pas o√π il va, mais il y va vite.",
    118: "Un poisson avec une corne. La reine des rivi√®res, selon elle.",
    119: "Il fait des nids en automne. Ne mettez pas les pieds dans l'eau.",
    120: "Si on lui coupe un bras, il repousse. Invincible et g√©om√©trique.",
    121: "Il envoie des signaux radio dans l'espace. Les aliens l'√©coutent peut-√™tre.",
    122: "Il fait des murs invisibles. Les mimes sont d√©j√† aga√ßants, lui est magique.",
    123: "Un ninja insecte avec des faux. Il coupe les arbres et les imprudents.",
    124: "Elle parle une langue inconnue et danse bizarrement. Personne ne la comprend.",
    125: "Il se nourrit des centrales √©lectriques. Cause #1 des pannes d'√©lectricit√©.",
    126: "Son corps est en feu. Il na√Æt dans un volcan. Il a chaud.",
    127: "Il serre ses proies avec ses pinces jusqu'√† ce qu'elles craquent. Brutal.",
    128: "Il charge tout ce qui est rouge. Et tout ce qui bouge. Il est juste √©nerv√©.",
    129: "Le roi de la nullit√©. Il ne sert √† rien, √† part √©clabousser.",
    130: "La vengeance du poisson nul. Il d√©truit des villes enti√®res quand il est f√¢ch√©.",
    131: "Le taxi des mers. Il adore transporter des gens. Un peu trop serviable.",
    132: "Il peut devenir n'importe qui. Votre meilleur ami est peut-√™tre un M√©tamorph.",
    133: "L'ADN instable. Il ne sait pas ce qu'il veut faire de sa vie.",
    134: "Il fond dans l'eau. Pratique pour disparaitre, moins pour √™tre vu.",
    135: "Un chien √©lectrique nerveux. Si vous le caressez, vous prenez 10 000 volts.",
    136: "Il stocke la chaleur. C'est une bouillotte sur pattes.",
    137: "Un programme informatique vivant. Il co√ªte cher en antivirus.",
    138: "Ressuscit√© d'un fossile. Il se demande ce qu'il fait l√†.",
    139: "Il a des dents pointues et des tentacules. Cthulhu miniature.",
    140: "Un fossile vivant qui se cache au fond de l'eau. Timide ou strat√®ge ?",
    141: "Il a des lames √† la place des mains. Comment fait-il pour manger ?",
    142: "Un dinosaure volant qui crie tr√®s fort. La pr√©histoire est de retour.",
    143: "Il mange, il dort. C'est tout. La vie de r√™ve.",
    144: "L'oiseau de glace. Il g√®le l'air. Il a froid, vous aussi.",
    145: "L'oiseau de foudre. Il cr√©e des orages. Bruyant et dangereux.",
    146: "L'oiseau de feu. Il annonce le printemps, ou un incendie de for√™t.",
    147: "Un ver aquatique mignon. Il deviendra un dragon, mais pour l'instant, c'est un ver.",
    148: "Il grandit et devient mystique. Il contr√¥le la m√©t√©o.",
    149: "Un dragon orange gentil. Il sauve les naufrag√©s. Le Saint-Bernard des mers.",
    150: "Cr√©√© par l'homme pour combattre. Il d√©teste l'humanit√©. On ne peut pas lui en vouloir.",
    151: "L'anc√™tre de tous. Il contient l'ADN de tous les Pok√©mon. Le disque dur original.",

    // --- JOHTO (GEN 2) ---
    152: "Une salade sur pattes qui pense pouvoir survivre dans la nature. Mignon jusqu'√† ce qu'il finisse dans un bol.",
    153: "Il a une feuille de rasoir autour du cou. Id√©al pour se trancher la carotide par accident.",
    154: "Son haleine ravive les plantes mortes. Dommage qu'elle ne puisse pas raviver votre vie amoureuse.",
    155: "Il s'allume quand il a peur. Pratique pour les barbecues, moins pour la discr√©tion.",
    156: "Il a arr√™t√© de fumer, mais son dos continue de s'enflammer. Attention aux nappes.",
    157: "Il frotte sa fourrure pour provoquer des explosions. Un danger public ambulant.",
    158: "Il mord tout ce qui bouge par affection. Adieu, doigts et orteils.",
    159: "Il ne l√¢che jamais prise une fois qu'il a mordu. Comme votre ex, mais avec plus de dents.",
    160: "Un alligator bip√®de qui court plus vite que vous. Inutile de fuir, acceptez votre sort.",
    161: "Une √©charpe vivante qui sert aussi de paillasson. Ne marche pas tr√®s vite.",
    162: "Il est long, il est mou, et il s'infiltre partout. Non, ce n'est pas ce que vous croyez.",
    163: "Il a une horloge interne parfaite, ce qui le rend insupportable pour ceux qui aiment dormir le matin.",
    164: "Il r√©fl√©chit tellement que sa t√™te enfle. L'intellectuel pr√©tentieux de la for√™t.",
    165: "Une coccinelle qui fait de la boxe. La nature a vraiment des id√©es stupides.",
    166: "Quatre bras pour mieux vous gifler. Il frappe √† la vitesse de la lumi√®re, vous ne verrez rien venir.",
    167: "Il tisse des toiles avec son visage. Une fa√ßon d√©go√ªtante d'√™tre cr√©atif.",
    168: "Il pi√®ge ses proies et les sirote lentement. Ne vous endormez pas pr√®s de lui.",
    169: "Quatre ailes pour voler silencieusement. Il vous vide de votre sang sans m√™me vous r√©veiller. Sympa.",
    170: "Il vit au fond de l'eau et √©lectrocute tout. Un grille-pain dans une baignoire, version poisson.",
    171: "Sa lumi√®re attire les proies. 'Oh, c'est joli !' fut leur derni√®re pens√©e.",
    172: "Il ne sait pas g√©rer son √©lectricit√© et s'√©lectrocute lui-m√™me. La s√©lection naturelle a √©chou√© ici.",
    173: "On dit que sa forme d'√©toile porte chance. Surtout si vous ne marchez pas dessus.",
    174: "Un ballon rose avec des yeux rouges. Il ressemble √† un cauchemar sous h√©lium.",
    175: "Une omelette qui pleure. Ne le secouez pas trop fort, il est fragile.",
    176: "Il apporte le bonheur, mais s'enfuit d√®s que vous √™tes triste. Un ami toxique.",
    177: "Il sautille parce que ses ailes ne sont pas finies. L'√©volution a b√¢cl√© le travail.",
    178: "Il voit le futur et reste immobile, paralys√© par l'horreur de votre avenir.",
    179: "Sa laine g√©n√®re de l'√©lectricit√© statique. Touchez-le et perdez vos sourcils.",
    180: "Il a perdu sa laine et ressemble maintenant √† un coton-tige rose g√©ant.",
    181: "Il brille tellement fort qu'on le voit de l'espace. Aucune intimit√© possible.",
    182: "Une fleur qui danse. Si elle danse mal, il pleut. C'est de sa faute si vos vacances sont g√¢ch√©es.",
    183: "Une souris d'eau qui flotte comme une bou√©e. Utile en cas de naufrage, inutile sinon.",
    184: "Un lapin aquatique qui peut faire des bulles. C'est tout. Il fait des bulles.",
    185: "Il fait semblant d'√™tre un arbre. Les chiens lui pissent dessus. Triste vie.",
    186: "Une grenouille avec une coupe afro. Le roi du disco des marais.",
    187: "Il est si l√©ger que le vent l'emporte. On en perd des centaines chaque ann√©e.",
    188: "Il flotte sur la t√™te des gens pour absorber leurs nutriments. Un chapeau parasite.",
    189: "Il disperse ses graines partout. La cause principale de vos allergies.",
    190: "Il a une main au bout de la queue. Pratique pour se gratter le dos ou voler votre portefeuille.",
    191: "La graine la plus faible du monde. Il tombe du ciel et attend de mourir.",
    192: "Il ne bouge que s'il y a du soleil. La nuit, c'est juste un l√©gume.",
    193: "Il vole sur place et scanne les environs. Le drone biologique original.",
    194: "Il n'a pas de bras, un visage vide et vit dans la boue. L'image de la d√©pression.",
    195: "Il se cogne la t√™te contre les bateaux. Il a l'air stupide et il l'est probablement.",
    196: "Il lit dans vos pens√©es et vous juge en silence. Il sait ce que vous avez fait.",
    197: "Il transpire du poison quand il est √©nerv√©. Ne le calinez pas.",
    198: "Il porte malheur √† ceux qui le voient. Si vous lisez ceci, c'est trop tard.",
    199: "Il est devenu intelligent parce qu'un coquillage lui mord la t√™te. La douleur rend g√©nie.",
    200: "Il tire sur vos cheveux et crie la nuit. Le colocataire de l'enfer.",
    201: "Une soupe √† l'alphabet vivante. Ils √©crivent des messages, souvent des insultes.",
    202: "Le sac de frappe ultime. Il encaisse tout et ne dit rien. Le masochisme incarn√©.",
    203: "Sa queue a un cerveau et mord tout ce qui passe. Il ne peut jamais s'asseoir tranquille.",
    204: "Une pomme de pin explosive. Si vous marchez dessus, vous perdez une jambe.",
    205: "Une tourelle vivante qui tire des pics. Ne jouez pas √† cache-cache avec lui.",
    206: "Il creuse avec sa queue pour fuir la r√©alit√©. On te comprend, Insolourdo.",
    207: "Il plane sans bruit et vous tombe dessus le visage. Comme un masque de la mort.",
    208: "Un serpent de m√©tal g√©ant. Il m√¢che la roche et vos voitures.",
    209: "Il ressemble √† un bouledogue en robe rose. Laideur et mignonnerie confusent.",
    210: "Il est timide mais peut broyer des os. Un introverti dangereux.",
    211: "Un poisson-globe toxique qui explose. La roulette russe de la p√™che.",
    212: "Il a des pinces en acier qui √©crasent le b√©ton. Ne lui serrez pas la main.",
    213: "Il fait du jus de baie dans sa coquille. Les autres Pok√©mon le boivent. C'est... sp√©cial.",
    214: "Il aime le miel et la bagarre. Un ours alcoolique version insecte.",
    215: "Il vole les ≈ìufs des autres pour les manger. Un criminel n√©.",
    216: "Il a l'air mignon pour vous attirer, puis vous vole votre nourriture. Une petite crapule.",
    217: "Il peut casser un arbre en deux. Imaginez ce qu'il fait √† votre colonne vert√©brale.",
    218: "De la lave vivante. Il ne peut jamais dormir dans un lit sans mettre le feu.",
    219: "Un escargot de magma. Sa coquille est fragile, son corps est mortel.",
    220: "Il renifle le sol pour trouver des champignons. Un cochon truffier glorifi√©.",
    221: "Ses poils cachent ses yeux. Il fonce dans les murs. Heureusement qu'il est solide.",
    222: "Du corail vivant. Les gens en font des bijoux. Une vie de peur constante.",
    223: "Un poisson pistolet. Il s'accroche aux autres pour survivre. Un parasite arm√©.",
    224: "Une pieuvre tank. Il tire de l'encre et des rayons lasers. La guerre sous-marine.",
    225: "Le P√®re No√´l est une ordure. Ses cadeaux explosent litt√©ralement.",
    226: "Une raie manta qui sert de piste d'atterrissage pour poissons. L'a√©roport des mers.",
    227: "Un oiseau en armure. Il vole lourdement et coupe l'air comme une guillotine.",
    228: "Un chien des enfers miniature. Il mord et √ßa br√ªle pour toujours.",
    229: "Le chien de garde de Satan. Son hurlement fait fuir m√™me les fant√¥mes.",
    230: "Un dragon des mers qui cr√©e des tourbillons en b√¢illant. Ne le r√©veillez pas.",
    231: "Un √©l√©phanteau qui joue avec sa trompe. Il peut quand m√™me vous √©craser par accident.",
    232: "Il se roule en boule et d√©vaste tout. Un pneu de tracteur vivant et en col√®re.",
    233: "Une mise √† jour logicielle qui a mal tourn√©. Plus lisse, mais toujours bizarre.",
    234: "Un cerf qui hypnotise avec ses bois. Ne le regardez pas dans les yeux.",
    235: "Il peint avec sa queue. C'est de l'art abstrait, ou juste des gribouillis.",
    236: "Il a plus d'esprit combatif que de muscles. Il perd souvent, mais avec panache.",
    237: "Il tourne sur la t√™te comme une toupie. Id√©al pour nettoyer le sol.",
    238: "Il embrasse tout le monde. Personne ne veut de ses bisous.",
    239: "Il tourne ses bras pour charger de l'√©lectricit√©. Une dynamo vivante.",
    240: "Il crache des flamm√®ches quand il √©ternue. Attention aux tapis.",
    241: "Une vache qui boit son propre lait. C'est... conceptuel.",
    242: "L'≈ìuf dans sa poche vaut une fortune. Il est la cible de tous les voleurs.",
    243: "Le tigre de la foudre. Il court avec l'orage. Ne sortez pas par temps de pluie.",
    244: "Il aboie et un volcan entre en √©ruption. Le pire voisin possible.",
    245: "Il purifie l'eau sale. Les stations d'√©puration le d√©testent.",
    246: "Il mange de la terre pour grandir. Un r√©gime peu rago√ªtant mais √©conomique.",
    247: "Il est dans sa cocon de pierre. Il attend de devenir un monstre. Patience.",
    248: "Godzilla avec un probl√®me de gestion de la col√®re. Il rase des montagnes pour le fun.",
    249: "Le gardien des mers. Il dort au fond de l'eau pour √©viter de g√©rer vos probl√®mes.",
    250: "Un poulet r√¥ti √©ternel qui laisse des arcs-en-ciel derri√®re lui.",
    251: "Il voyage dans le temps pour √©viter de vous rencontrer. On le comprend.",

    // --- HOENN (GEN 3) ---
    252: "Il se prend pour un dur avec sa brindille. C'est juste un gecko avec un probl√®me d'attitude.",
    253: "Il a des feuilles sur les bras qui coupent comme des rasoirs. Attention aux c√¢lins.",
    254: "Il a un sapin de No√´l sur la queue. Il est festif mais mortel.",
    255: "Un poussin qui br√ªle de l'int√©rieur. Si vous le serrez trop fort, vous cuisez.",
    256: "Il donne 10 coups de pied par seconde. Il a trop regard√© de films de kung-fu.",
    257: "Un coq de combat qui saute par-dessus les immeubles. Il a saut√© le jour des jambes √† la salle.",
    258: "Il vit dans la boue et mange n'importe quoi. L'incarnation de la vie √©tudiante.",
    259: "Il vit sur terre et dans l'eau, mais il est maladroit partout. Triste.",
    260: "Il est tellement costaud qu'il peut nager contre les tsunamis. Il frime.",
    261: "Il mord tout ce qui bouge. Si √ßa ne bouge pas, il mord quand m√™me.",
    262: "Il hurle sans arr√™t. Si vous aimez le silence, fuyez.",
    263: "Il court en ligne droite et fonce dans les murs. L'intelligence n'est pas son fort.",
    264: "Il est encore plus rapide et fonce encore plus fort. Les murs tremblent.",
    265: "Une chenille rouge qui se cache. Elle r√™ve de devenir un beau papillon, ou pas.",
    266: "Une carapace de pics. Ne l'utilisez pas comme ballon de foot.",
    267: "Un papillon magnifique qui utilise ses ailes pour cr√©er des ouragans. Beau mais psychopathe.",
    268: "Il se prot√®ge avec de la soie. Il est timide et collant.",
    269: "Un papillon de nuit toxique. Il est attir√© par la lumi√®re, comme un idiot.",
    270: "Il flotte sur l'eau comme une feuille. Ne le confondez pas avec du th√©.",
    271: "Il a une feuille sur la t√™te pour se cacher. Le ma√Ætre du d√©guisement (non).",
    272: "Il danse quand il pleut. Il aime √™tre mouill√©, le bizarre.",
    273: "Un gland qui marche. Oui, vous avez bien lu.",
    274: "Il a un nez en forme de feuille. Il ment tout le temps ?",
    275: "Il utilise ses feuilles comme des √©ventails pour cr√©er des tornades. Climatiseur naturel.",
    276: "Il est courageux malgr√© sa petite taille. Il se bat contre des ennemis 10 fois plus gros et perd.",
    277: "Il vole courageusement. Il ne sert √† rien d'autre qu'√† faire joli.",
    278: "Il vole vite et a une bonne vue. Le facteur des mers.",
    279: "Il flotte sur l'eau et mange de la mousse. Une vie passionnante.",
    280: "Il ressent les √©motions des autres avec ses cornes. Si vous √™tes triste, il le sait et √ßa le d√©prime.",
    281: "Une ballerine qui utilise ses √©motions pour se battre. Drama queen.",
    282: "Elle peut cr√©er des trous noirs pour prot√©ger son dresseur. D√©vou√©e, mais dangereuse.",
    283: "Il glisse sur l'eau comme un insecte. Il est rapide mais fragile.",
    284: "Il vole avec des ailes bizarres. On dirait un masque effrayant.",
    285: "Un champignon qui donne des coups de t√™te. Il a un temp√©rament de cochon.",
    286: "Il a des bras √©lastiques. Il boxe les gens √† distance. L√¢che.",
    287: "Le paresseux ultime. Il bouge une fois par jour. Mon animal totem.",
    288: "Il ne peut pas s'arr√™ter de bouger. L'oppos√© de son enfant. Hyperactif sous caf√©ine.",
    289: "Le roi des paresseux. Il est fort, mais il s'en fiche. Il pr√©f√®re dormir.",
    290: "Il creuse vite. Tr√®s vite. Il est d√©j√† parti.",
    291: "Il est tellement rapide qu'il est invisible. On ne sait m√™me pas s'il est l√†.",
    292: "Une coquille vide habit√©e par un insecte fant√¥me. Il vole votre √¢me si vous regardez dans le trou.",
    293: "Il crie fort. Tr√®s fort. Vos tympans vont exploser.",
    294: "Il utilise ses oreilles comme des hauts-parleurs. Le DJ de la for√™t.",
    295: "Il explose encore plus fort. Une enceinte vivante qui marche.",
    296: "Il s'entra√Æne tout le temps. Il veut devenir un sumo, mais il est trop maigre.",
    297: "Il a de grosses mains pour gifler ses ennemis. Le roi de la baffe.",
    298: "Une petite boule bleue qui rebondit sur sa queue. Mignon et triste.",
    299: "Il a un nez aimant√©. Il se dirige toujours vers le nord, m√™me s'il ne veut pas.",
    300: "Un chat mignon qui charme ses ennemis. Ne lui faites pas confiance.",
    301: "Il est obs√©d√© par la propret√©. Si vous √™tes sale, il vous attaque.",
    302: "Il mange des pierres pr√©cieuses et a des yeux en diamant. Un r√©gime co√ªteux.",
    303: "Il a une m√¢choire d'acier dans le dos. On ne sait pas laquelle est la vraie t√™te.",
    304: "Il mange du m√©tal pour renforcer son armure. Il va manger votre v√©lo.",
    305: "Il utilise son armure pour charger. Un tank sur pattes.",
    306: "Il mange tellement de fer qu'il est devenu un monstre d'acier. Lourd.",
    307: "Il m√©dite tout le temps. Il a atteint l'illumination, ou il dort les yeux ouverts.",
    308: "Il a des pouvoirs psy puissants gr√¢ce au yoga. Il peut plier une cuill√®re et votre esprit.",
    309: "Un chien √©lectrique statique. Il court vite pour g√©n√©rer du courant.",
    310: "Il peut faire tomber la foudre. Un orage sur quatre pattes.",
    311: "Deux souris qui s'entraident. L'une encourage l'autre. C'est mignon, √ßa donne envie de vomir.",
    312: "La m√™me chose, mais en rouge. Toujours aussi insupportablement positifs.",
    313: "Une luciole qui clignote. Elle communique avec la lumi√®re. Romantique.",
    314: "Elle utilise son parfum pour attirer les Volbeat. Femme fatale version insecte.",
    315: "Il a des roses √† la place des mains. Beau mais √©pineux.",
    316: "Un estomac liquide qui dissout tout. Ne le prenez pas dans vos bras.",
    317: "Il avale tout ce qui bouge. Un trou noir avec des moustaches.",
    318: "Un piranha f√©roce. Il mord tout. Ne mettez pas les doigts dans l'eau.",
    319: "Un requin torpille. Il fonce sur ses proies et les d√©chire. La terreur des mers.",
    320: "Une baleine ronde qui rebondit. Elle est heureuse et √ßa se voit.",
    321: "La plus grosse baleine. Elle plonge dans les abysses. Personne ne sait ce qu'elle y fait.",
    322: "Un chameau un peu lent. Il a du magma dans sa bosse. Chaud.",
    323: "Deux volcans sur le dos. S'il s'√©nerve, c'est Pomp√©i.",
    324: "Une tortue de charbon. Elle fume comme une locomotive. Mauvais pour les poumons.",
    325: "Un cochon sur ressort. Il rebondit tout le temps. Il a l'air stress√©.",
    326: "Il utilise sa queue pour manipuler les gens. Un cochon hypnotiseur.",
    327: "Un panda avec des taches. Il est confus en permanence. On dirait moi le lundi matin.",
    328: "Une fourmi g√©ante avec des m√¢choires d'acier. Elle peut soulever 100 fois son poids.",
    329: "Un dragon libellule. Il vole vite et fait du bruit. Comme un h√©licopt√®re bio.",
    330: "Une libellule encore plus grosse. Elle cr√©e des temp√™tes de sable.",
    331: "Un cactus qui marche la nuit pour suivre les voyageurs. Flippant.",
    332: "Un √©pouvantail maudit qui vous suit. Ne regardez pas derri√®re vous.",
    333: "Un oiseau nuage. Il se cache dans le ciel. Il est doux comme du coton.",
    334: "Il chante magnifiquement mais ses ailes sont en coton. Un dragon fragile.",
    335: "Une mangouste en col√®re. Elle d√©teste les serpents. Rivalit√© ancestrale.",
    336: "Un serpent venimeux. Il d√©teste les mangoustes. Rivalit√© ancestrale, le retour.",
    337: "Une lune en pierre qui flotte. Elle tire des rayons cosmiques.",
    338: "Un soleil en pierre qui flotte. Il br√ªle tout ce qui s'approche.",
    339: "Un poisson vaseux. Il est glissant et ne sert √† rien.",
    340: "Un poisson chat qui provoque des s√©ismes. Il ne le fait pas expr√®s, il est juste maladroit.",
    341: "Une √©crevisse agressive. Elle attaque tout ce qui entre dans son territoire.",
    342: "Un homard g√©ant. Il est fort et il le sait. Il claque ses pinces.",
    343: "Une poup√©e d'argile qui tourne. Elle a √©t√© cr√©√©e par une civilisation ancienne.",
    344: "Une statue d'argile qui tire des rayons laser. La technologie antique √©tait bizarre.",
    345: "Un fossile de plante marine. Il a des tentacules bizarres.",
    346: "Il vit au fond de l'oc√©an et attrape ses proies avec ses ventouses. Le kraken pr√©historique.",
    347: "Un fossile d'insecte avec des griffes. Il est rapide et mortel.",
    348: "Un guerrier en armure d'insecte. Il est honor√© et dangereux.",
    349: "Un poisson moche mais r√©sistant. Il survit √† tout, m√™me √† la pollution.",
    350: "Le plus beau des Pok√©mon (selon lui). Il vit pour √™tre admir√©.",
    351: "Il change de forme selon la m√©t√©o. Un barom√®tre vivant.",
    352: "Un cam√©l√©on qui se camoufle. Vous ne le verrez jamais venir.",
    353: "Une poup√©e maudite qui cherche son propri√©taire. Histoire d'horreur classique.",
    354: "Une marionnette fant√¥me. Elle sourit, mais elle veut votre √¢me.",
    355: "Un fant√¥me cyclope. Il voit tout, surtout vos p√©ch√©s.",
    356: "Une momie cyclope. Il pi√®ge les gens dans son corps vide. Tr√®s accueillant.",
    357: "Un dinosaure volant avec des bananes au menton. Design audacieux.",
    358: "Une cloche qui tinte dans le vent. Elle apaise les esprits.",
    359: "Un d√©sastre sur pattes. Il appara√Æt quand une catastrophe arrive. Porte-poisse.",
    360: "Il est toujours heureux. Pourquoi ? Personne ne sait. Suspect.",
    361: "Il grelotte tout le temps. Mettez-lui un pull.",
    362: "Une t√™te de glace g√©ante. Il g√®le tout sur son passage.",
    363: "Une boule de graisse qui nage et applaudit. Le public id√©al.",
    364: "Un morse avec une moustache magnifique. Il brise la glace avec ses dents.",
    365: "Une perle qui nage. Elle est pr√©cieuse, ne la perdez pas.",
    366: "Une anguille des abysses. Elle chasse en utilisant sa lumi√®re. Terrifiant.",
    367: "Un serpent des mers magnifique mais dangereux. Il vit dans les profondeurs.",
    368: "Un poisson qui ne sait pas nager. S√©rieusement ? L'√©volution a merd√©.",
    369: "Un poisson ancien et puissant. Sa t√™te est dure comme la pierre.",
    370: "Un c≈ìur qui nage. Il cherche l'amour dans l'oc√©an. Romantique.",
    371: "Un dragon qui veut voler. Il saute des falaises pour apprendre. Courageux ou suicidaire.",
    372: "Il a une coquille dure pour se prot√©ger en attendant de voler.",
    373: "Enfin, il vole ! Il est furieux d'avoir attendu si longtemps. Il br√ªle tout.",
    374: "Un robot cyclope en m√©tal. Il calcule tout. Il n'a pas d'√¢me.",
    375: "Deux robots cyclopes fusionn√©s. Deux fois plus de calculs, z√©ro √¢me.",
    376: "Un superordinateur de combat √† quatre pattes. Il gagne aux √©checs et √† la guerre.",
    377: "Un golem de roche. Si vous le cassez, il se r√©pare. Pratique.",
    378: "Un golem de glace. Il fond si on lui fait un c√¢lin. Triste.",
    379: "Un golem d'acier. Il ne fond pas, ne casse pas. L'ennui total.",
    380: "Un dragon femelle qui vole √† la vitesse du son. Elle est invisible quand elle va vite.",
    381: "Un dragon m√¢le qui vole encore plus vite. Il prot√®ge sa s≈ìur.",
    382: "Le ma√Ætre des oc√©ans. Il veut noyer le monde. Un peu extr√™me comme ambition.",
    383: "Le ma√Ætre de la terre. Il veut ass√©cher les oc√©ans. Il d√©teste se mouiller.",
    384: "Le ma√Ætre du ciel. Il descend pour calmer les deux autres abrutis. La nounou cosmique.",
    385: "Il exauce les v≈ìux. Attention √† ce que vous demandez, il a un sens de l'humour tordu.",
    386: "Un alien virus. Il change de forme pour mieux vous d√©truire. Bienvenue sur Terre."
};
const POKEMON_SIZES = {1:"0.7m",2:"1.0m",3:"2.0m",4:"0.6m",5:"1.1m",6:"1.7m",7:"0.5m",8:"1.0m",9:"1.6m",10:"0.3m",11:"0.7m",12:"1.1m",13:"0.3m",14:"0.6m",15:"1.0m",16:"0.3m",17:"1.1m",18:"1.5m",19:"0.3m",20:"0.7m",21:"0.3m",22:"1.2m",23:"2.0m",24:"3.5m",25:"0.4m",26:"0.8m",27:"0.6m",28:"1.0m",29:"0.4m",30:"0.8m",31:"1.3m",32:"0.5m",33:"0.9m",34:"1.4m",35:"0.6m",36:"1.3m",37:"0.6m",38:"1.1m",39:"0.5m",40:"1.0m",41:"0.8m",42:"1.6m",43:"0.5m",44:"0.8m",45:"1.2m",46:"0.3m",47:"1.0m",48:"1.0m",49:"1.5m",50:"0.2m",51:"0.7m",52:"0.4m",53:"1.0m",54:"0.8m",55:"1.7m",56:"0.5m",57:"1.0m",58:"0.7m",59:"1.9m",60:"0.6m",61:"1.0m",62:"1.3m",63:"0.9m",64:"1.3m",65:"1.5m",66:"0.8m",67:"1.5m",68:"1.6m",69:"0.7m",70:"1.0m",71:"1.7m",72:"0.9m",73:"1.6m",74:"0.4m",75:"1.0m",76:"1.4m",77:"1.0m",78:"1.7m",79:"1.2m",80:"1.6m",81:"0.3m",82:"1.0m",83:"0.8m",84:"1.4m",85:"1.8m",86:"1.1m",87:"1.7m",88:"0.9m",89:"1.2m",90:"0.3m",91:"1.5m",92:"1.3m",93:"1.6m",94:"1.5m",95:"8.8m",96:"1.0m",97:"1.6m",98:"0.4m",99:"1.3m",100:"0.5m",101:"1.2m",102:"0.4m",103:"2.0m",104:"0.4m",105:"1.0m",106:"1.5m",107:"1.4m",108:"1.2m",109:"0.6m",110:"1.2m",111:"1.0m",112:"1.9m",113:"1.1m",114:"1.0m",115:"2.2m",116:"0.4m",117:"1.6m",118:"0.6m",119:"1.3m",120:"0.8m",121:"1.1m",122:"1.3m",123:"1.5m",124:"1.4m",125:"1.1m",126:"1.3m",127:"1.5m",128:"1.4m",129:"0.9m",130:"6.5m",131:"2.5m",132:"0.3m",133:"0.3m",134:"1.0m",135:"0.8m",136:"0.9m",137:"0.8m",138:"0.4m",139:"1.0m",140:"0.5m",141:"1.3m",142:"1.8m",143:"2.1m",144:"1.7m",145:"1.6m",146:"2.0m",147:"1.8m",148:"4.0m",149:"2.2m",150:"2.0m",151:"0.4m"};

const EVOLUTION_DATA = {
    // üî• Pierre Feu
    37:{fire_stone:38}, // Goupix ‚Üí Feunard
    58:{fire_stone:59}, // Caninos ‚Üí Arcanin
    // üíß Pierre Eau
    61:{water_stone:62}, // T√™tarte ‚Üí Tartard
    90:{water_stone:91}, // Kokiyas ‚Üí Crustabri
    120:{water_stone:121}, // Stari ‚Üí Staross
    // ‚ö° Pierre Foudre
    25:{thunder_stone:26}, // Pikachu ‚Üí Raichu
    100:{thunder_stone:101}, // Voltorbe ‚Üí √âlectrode
    // üåø Pierre Plante
    44:{leaf_stone:45}, // Ortide ‚Üí Rafflesia
    70:{leaf_stone:71}, // Boustiflor ‚Üí Empiflor
    102:{leaf_stone:103}, // Noeunoeuf ‚Üí Noadkoko
    // üåô Pierre Lune
    35:{moon_stone:36}, // M√©lof√©e ‚Üí M√©lodelfe
    39:{moon_stone:40}, // Rondoudou ‚Üí Grodoudou
    30:{moon_stone:31}, // Nidorina ‚Üí Nidoqueen
    33:{moon_stone:34}, // Nidorino ‚Üí Nidoking
    // √âvoli (3 √©volutions possibles)
    133:{water_stone:134,thunder_stone:135,fire_stone:136} // √âvoli ‚Üí Aquali, Voltali, Pyroli
};

const EVOLUTION_BY_LEVEL = {
    // √âvolutions par captures (5 captures n√©cessaires)
    // Note: Les √©volutions par pierre (25,30,33,35,37,39,44,58,61,70,90,100,102,120,133) sont dans EVOLUTION_DATA
    1:2,2:3,4:5,5:6,7:8,8:9,10:11,11:12,13:14,14:15,16:17,17:18,19:20,21:22,23:24,27:28,29:30,32:33,41:42,43:44,46:47,48:49,50:51,52:53,54:55,56:57,60:61,63:64,64:65,66:67,67:68,69:70,72:73,74:75,75:76,77:78,79:80,81:82,84:85,86:87,88:89,92:93,96:97,98:99,104:105,109:110,116:117,118:119,129:130,147:148,148:149
    // Note: 43:44 (Mystherbe‚ÜíOrtide) reste car Ortide √©volue par pierre, pas Mystherbe
    // Note: 69:70 (Ch√©tiflor‚ÜíBoustiflor) reste car Boustiflor √©volue par pierre, pas Ch√©tiflor
};

const SPECIAL_COLLECTIONS = {
    fossils:{name:'Fossiles',pokemon:[138,139,140,141,142],icon:'ü¶¥'},
    starters:{name:'Starters',pokemon:[1,4,7],icon:'üå±'},
    eeveelutions:{name:'√âvolutions √âvoli',pokemon:[133,134,135,136],icon:'‚ú®'},
    birds:{name:'Oiseaux L√©gendaires',pokemon:[144,145,146],icon:'ü¶Ö'},
    dragons:{name:'Dragons',pokemon:[147,148,149],icon:'üêâ'},
    mew:{name:'Mew & Mewtwo',pokemon:[150,151],icon:'üíé'}
};

let gameState = {coins:3000,level:1,xp:0,xpToNext:250,captured:new Set(),shinies:new Set(),evolved:new Set(),capturedCount:{},totalCaught:0,streak:0,bestStreak:0,blindBoxUsed:0,blindBoxSlots:5,blindBoxBonus:0,blindBoxResetTime:null,totalBlindBoxOpened:0,blindBoxPity:0,blindBoxHistory:[],captureHistory:[],fishingHistory:[],lastReset:Date.now(),lastLogin:Date.now(),loginStreak:0,lastLoginDate:null,lastDailyQuestReset:null,lastDailyQuestDate:null,dailyQuestCompletionDates:{},lastOnline:Date.now(),lastFishingTokenRegen:Date.now(),lastFishingTokenTime:Date.now(),startTime:Date.now(),totalPlaytime:0,totalCaptureAttempts:0,totalSuccessfulCaptures:0,totalCoinsEarned:0,totalFished:0,totalFlees:0,mysteryEggProgress:0,activeBoosts:[],inventory:{pokeball:50,greatball:20,ultraball:10,masterball:1,diveball:0,framby:0,pinap:0,ceriz:0,incensefleur:0,marin_lure:0,exp_charm:0,lucky_charm:0,charm_collection:0,legendary_radar:0,fire_stone:0,water_stone:0,thunder_stone:0,moon_stone:0,leaf_stone:0,fishingTokens:10,lootbox:0,rarebox:0,suprarebox:0,ultrabox:0,mystery_egg:0,eggs:[],processor_chips:0,blueprint_ocean:0,blueprint_cave:0,blueprint_volcano:0,blueprint_power_plant:0,blueprint_graveyard:0},collectionProgress:{},unlockedBadges:new Set(),currentRegion:'Kanto',unlockedRegions:new Set(['Kanto']),regionProgress:{Kanto:{captured:0,shinies:0},Johto:{captured:0,shinies:0},Hoenn:{captured:0,shinies:0}},questsProgress:{daily:{},special:{},permanent:{}},claimedQuests:{daily:new Set(),special:new Set(),permanent:new Set()},questsCompletedToday:new Set(),tutorialSeen:false,introSeen:false,customization:{nameModalSeen:false,pwaModalSeen:false},pokedexMode:'grid',pokedexFilters:{status:'all',rarity:'all',type:'all',evolvable:'all'},typeCaptureCounts:{},totalShopPurchases:0,dailyQuestStreak:0,rareCaptureCount:0,pendingLevelUps:[],rogue:{runsCompleted:0,runsStarted:0,fullClearsCount:0,totalShinyTokens:0,pityCounter:0,totalShards:0,shardsByType:{common:0,rare:0,legendary:0},unlocks:{extraBall:false,extraFloor:false,shinyCharmPermanent:false,fastRecharge:false},ticketsAvailable:10,lastTicketReset:null,lastRunRewards:null},buddy:{activeBuddyId:null,buddies:{}},poker:{runs_completed:0,runs_started:0,highest_ante:0,badges_earned:[],league_unlocked:false,total_chips_earned:0,total_hands_played:0,best_single_hand_score:0,legendary_combos_hit:0,permanent_deck:[],unlocked_cards:[],owned_jokers:[],meta_upgrades:{extra_card_draw:0,starting_chips_bonus:0,buddy_xp_multiplier:1.0,shiny_chance_boost:0},current_run:null,shop:{current_offers:[],rerolls_available:2,reroll_cost:50}},incubation:{eggs:[],incubators:1},catchbot:{active:false,lastCatch:Date.now(),storage:[]},golden:new Set(),research:{unlocked:false,energy:0,totalEnergyProduced:0,clickMultiplier:1,lastSaveTime:Date.now(),automationLevel:0,upgrades:{mouse_driver:0,gpu_overclock:0,virus_scan:0},habitats:{'forest':{name:'For√™t',type:'Grass',level:0,unlocked:true,slots:1,assigned:[]},'ocean':{name:'Oc√©an',type:'Water',level:0,unlocked:false,slots:1,assigned:[]},'cave':{name:'Grotte',type:'Rock',level:0,unlocked:false,slots:1,assigned:[]},'volcano':{name:'Volcan',type:'Fire',level:0,unlocked:false,slots:1,assigned:[]},'power_plant':{name:'Centrale',type:'Electric',level:0,unlocked:false,slots:1,assigned:[]},'graveyard':{name:'Cimeti√®re',type:'Ghost',level:0,unlocked:false,slots:1,assigned:[]}}},narrative:{queue:[],history:[],currentSpeaker:'porygon'},tcg:{unlocked:false,cards:{},boostersOpened:0},system:{currentPhase:'BOOT_SEQUENCE',integrity:0,glitchLevel:1.0,porygonMood:'PANIC',narrativeFlags:[]},modules:{fishing:{id:'fishing',condition:'level_2',unlocked:false,dialogue:'unlock_fishing_module'},research:{id:'research',condition:'level_5',unlocked:false,dialogue:'unlock_research_core'},poker:{id:'poker',condition:'level_12',unlocked:false,dialogue:'unlock_decryption'},rogue:{id:'rogue',condition:'level_20_and_johto',unlocked:false,dialogue:'unlock_deepnet'},blindbox:{id:'blindbox',condition:'level_8',unlocked:false,dialogue:'unlock_blindbox'},tcg:{id:'tcg',condition:'level_25',unlocked:false,dialogue:'unlock_archives'}}};
window.gameState = gameState;

let currentPokemon=null,currentFishingPokemon=null,captureCooldown=null,streakTooltipTimeout=null,usingFramby=false,usingPinap=false,usingCeriz=false;

function getRarity(pokemonId){for(const[rarity,ids]of Object.entries(POKEMON_DATA)){if(ids.includes(pokemonId))return rarity;}return'common';}

function selectPokemon(pool='spawn',waterOnly=false){const rates=pool==='blindbox'?{uncommon:60,rare:25,super_rare:12,legendary:3}:{common:55,uncommon:25,rare:12,super_rare:6,legendary:2};const hasIncenseBoost=gameState.activeBoosts.some(b=>b.type==='incensefleur'&&b.endTime>Date.now());if(hasIncenseBoost){rates.rare*=1.2;rates.super_rare*=1.2;rates.legendary*=1.2;}const rand=Math.random()*100;let cumulative=0,rarity='common';for(const[r,rate]of Object.entries(rates)){cumulative+=rate;if(rand<cumulative){rarity=r;break;}}const currentRegion=getCurrentUnlockedRegion();let pokemonPool=filterPokemonByRegion(POKEMON_DATA[rarity]||[],currentRegion);if(pokemonPool.length===0){for(const r of['common','uncommon','rare','super_rare','legendary']){const altPool=filterPokemonByRegion(POKEMON_DATA[r]||[],currentRegion);if(altPool.length>0){pokemonPool=altPool;rarity=r;break;}}if(pokemonPool.length===0){const regionRange={Kanto:{min:1,max:151},Johto:{min:152,max:251},Hoenn:{min:252,max:386}}[currentRegion]||{min:1,max:151};const allInRegion=Array.from({length:regionRange.max-regionRange.min+1},(_,i)=>regionRange.min+i);pokemonPool=allInRegion.filter(id=>POKEMON_DATA.common.includes(id)||POKEMON_DATA.uncommon.includes(id)||POKEMON_DATA.rare.includes(id)||POKEMON_DATA.super_rare.includes(id)||POKEMON_DATA.legendary.includes(id));if(pokemonPool.length===0)pokemonPool=[regionRange.min];}}if(waterOnly){pokemonPool=pokemonPool.filter(id=>WATER_TYPES.includes(id));if(pokemonPool.length===0){const currentRegionWater=WATER_TYPES.filter(id=>{const region=getPokemonRegion(id);return region===currentRegion;});pokemonPool=currentRegionWater.length>0?currentRegionWater:WATER_TYPES.filter(id=>{const r=getPokemonRegion(id);return r===currentRegion;});}}const id=pokemonPool[Math.floor(Math.random()*pokemonPool.length)];const hasLuckyBoost=gameState.activeBoosts.some(b=>b.type==='lucky_charm'&&b.endTime>Date.now());let shinyRate=(1/256)+(hasLuckyBoost?0.005:0)+(Math.floor(gameState.streak/5)*0.01);const buddyId=gameState.buddy?.activeBuddyId;const buddy=buddyId?gameState.buddy.buddies[buddyId]:null;if(buddy&&(buddy.level||1)>=7)shinyRate+=0.01;let isShiny=Math.random()<shinyRate;if(id===130)isShiny=false;return{id,name:FRENCH_NAMES[id]||`Pok√©mon #${id}`,rarity,isShiny};}

// --- Fonction utilitaire pour obtenir le buddy actif ---
function getCurrentBuddy() {
    if (!gameState.buddy || !gameState.buddy.activeBuddyId) return null;
    const id = gameState.buddy.activeBuddyId;
    const buddyData = gameState.buddy.buddies[id];
    
    // Gestion ID string (legacy) ou objet
    let isShiny = false;
    if (typeof id === 'string' && id.includes('_')) {
        isShiny = true;
    } else if (buddyData) {
        isShiny = buddyData.isShiny || false;
    }
    
    return {
        id: typeof id === 'string' && id.includes('_') ? parseInt(id.split('_')[0]) : parseInt(id),
        isShiny: isShiny,
        level: buddyData ? buddyData.level : 1
    };
}

// GENESIS REBOOT - Blind Box Intelligente avec syst√®me de Pity
function selectNewPokemonForBlindBox() {
    // CORRECTION : Toujours utiliser getCurrentUnlockedRegion() pour avoir la bonne r√©gion
    // Ne pas utiliser gameState.currentRegion qui peut √™tre obsol√®te
    const currentRegion = getCurrentUnlockedRegion();
    
    const regionRange = {
        'Kanto': { min: 1, max: 151 },
        'Johto': { min: 152, max: 251 },
        'Hoenn': { min: 252, max: 386 }
    }[currentRegion] || { min: 1, max: 151 };
    
    // 1. Identifier les manquants de la r√©gion active
    const allIdsInRegion = Array.from({length: regionRange.max - regionRange.min + 1}, (_, i) => regionRange.min + i);
    const capturedSet = gameState.captured;
    const missingIds = allIdsInRegion.filter(id => !capturedSet.has(id));
    
    // 2. Logique "Smart Pity"
    // Si le joueur est proche de la fin (ex: il en manque 5 ou moins) OU si la Pity Box est active
    const isNearCompletion = missingIds.length > 0 && missingIds.length <= 5;
    const isPityTriggered = (gameState.blindBoxPity || 0) >= 10; // Se d√©clenche tous les 10 √©checs
    
    if (isNearCompletion || isPityTriggered) {
        // GARANTIE : On donne un manquant
        const forcedId = missingIds[Math.floor(Math.random() * missingIds.length)];
        
        // Reset Pity
        gameState.blindBoxPity = 0;
        
        // Trigger Narratif Porygon
        if (isNearCompletion) {
            triggerNarrative('blindbox_completion_help');
        }
        
        return { 
            id: forcedId, 
            name: FRENCH_NAMES[forcedId] || `Pok√©mon #${forcedId}`, 
            rarity: getRarity(forcedId), 
            isShiny: false // On ne donne pas de shiny sur une pity "compl√©tion" pour ne pas abuser
        };
    }
    
    // 3. Sinon : Logique Standard (Raret√© / Shiny)
    // On incr√©mente la frustration (sera fait dans openBlindBox si pas de l√©gendaire garanti)
    
    const rates = { uncommon: 60, rare: 25, super_rare: 12, legendary: 3 };
    const rand = Math.random() * 100;
    let cumulative = 0;
    let rarity = 'uncommon'; 
    
    for (const [r, rate] of Object.entries(rates)) {
        cumulative += rate;
        if (rand < cumulative) {
            rarity = r;
            break;
        }
    }
    
    // Pool de Pok√©mon non captur√©s de la raret√© choisie
    let pokemonPool = POKEMON_DATA[rarity] ? POKEMON_DATA[rarity].filter(id => !gameState.captured.has(id)) : [];
    pokemonPool = filterPokemonByRegion(pokemonPool, currentRegion);
    
    // Fallback system (si le pool est vide)
    if (pokemonPool.length === 0) {
        for (const r of ['common', 'uncommon', 'rare', 'super_rare', 'legendary']) {
            if (!POKEMON_DATA[r]) continue;
            let pool = POKEMON_DATA[r].filter(id => !gameState.captured.has(id));
            pool = filterPokemonByRegion(pool, currentRegion);
            if (pool.length > 0) {
                pokemonPool = pool;
                rarity = r;
                break;
            }
        }
        
        // Dernier recours absolu
        if (pokemonPool.length === 0) {
            // On autorise les doublons si tout est captur√©, mais TOUJOURS dans la r√©gion actuelle
            if (POKEMON_DATA[rarity]) {
                pokemonPool = filterPokemonByRegion(POKEMON_DATA[rarity], currentRegion);
            }
            
            // Si toujours vide, chercher dans toutes les raret√©s de la r√©gion actuelle
            if (pokemonPool.length === 0) {
                for (const r of ['common', 'uncommon', 'rare', 'super_rare', 'legendary']) {
                    if (!POKEMON_DATA[r]) continue;
                    const regionPool = filterPokemonByRegion(POKEMON_DATA[r], currentRegion);
                    if (regionPool.length > 0) {
                        pokemonPool = regionPool;
                        rarity = r;
                        break;
                    }
                }
            }
            
            // Si vraiment rien dans la r√©gion actuelle (ne devrait jamais arriver), donner un Pok√©mon de la r√©gion
            if (pokemonPool.length === 0) {
                const regionRange = {
                    'Kanto': { min: 1, max: 151 },
                    'Johto': { min: 152, max: 251 },
                    'Hoenn': { min: 252, max: 386 }
                }[currentRegion] || { min: 1, max: 151 };
                // Prendre un Pok√©mon al√©atoire de la r√©gion (m√™me si d√©j√† captur√©)
                const allInRegion = Array.from({length: regionRange.max - regionRange.min + 1}, (_, i) => regionRange.min + i);
                pokemonPool = allInRegion.filter(id => POKEMON_DATA.common.includes(id) || POKEMON_DATA.uncommon.includes(id) || POKEMON_DATA.rare.includes(id) || POKEMON_DATA.super_rare.includes(id) || POKEMON_DATA.legendary.includes(id));
                if (pokemonPool.length === 0) pokemonPool = [regionRange.min]; // Fallback absolu : premier Pok√©mon de la r√©gion
            }
        }
    }
    
    // S√©curit√© finale anti-crash
    if (!pokemonPool || pokemonPool.length === 0) {
        console.warn('Pool vide, fallback sur Rattata');
        return { id: 19, name: "Rattata", rarity: 'common', isShiny: false };
    }
    
    const id = pokemonPool[Math.floor(Math.random() * pokemonPool.length)];
    
    // Calcul Shiny
    const baseRate = 1/256;
    const streakBonus = Math.floor(gameState.streak/5) * 0.01;
    let shinyRate = baseRate + streakBonus;
    
    // Bonus si Buddy Shiny
    const buddy = getCurrentBuddy();
    if (buddy && buddy.isShiny) shinyRate += 0.02;
    
    let isShiny = Math.random() < shinyRate;
    // ‚ö†Ô∏è L√©viator Shiny EXCLUSIF √† la p√™che - jamais shiny ailleurs
    if (id === 130) isShiny = false;
    
    return { id, name: FRENCH_NAMES[id] || `Pok√©mon #${id}`, rarity, isShiny };
}

function calculateCaptureRate(ballType,rarity,useBerry=false){
    const rarityMultiplier={common:1,uncommon:0.8,rare:0.6,super_rare:0.4,legendary:0.2};
    let ballRates={pokeball:0.5,greatball:0.7,ultraball:0.9,masterball:1.0,diveball:0.7};
    let rate=ballRates[ballType]*rarityMultiplier[rarity];
    
    // ‚ö†Ô∏è FIX : V√©rifier currentPokemon OU currentFishingPokemon pour le bonus Scuba ball
    const pokemon = currentPokemon || currentFishingPokemon;
    if(ballType==='diveball'&&pokemon&&WATER_TYPES.includes(pokemon.id)){
        rate=Math.min(rate*1.5,1.0);
    }
    
    if(useBerry){
        rate=Math.min(rate*1.5,1.0);
        const buddyId=gameState.buddy?.activeBuddyId;
        const buddy=buddyId?gameState.buddy.buddies[buddyId]:null;
        if(buddy&&(buddy.level||1)>=8)rate*=1.10;
    }
    
    // ‚ö†Ô∏è FIX : V√©rifier aussi currentFishingPokemon pour la baie Ceriz (capture normale ET p√™che)
    if((usingCeriz||usingCerizFishing)&&pokemon&&pokemon.isShiny)rate=1.0;
    
    if(typeof getBuddyHeldItemEffect==='function'&&getBuddyHeldItemEffect('capture_berry_boost')){
        rate=Math.min(rate*1.1,1.0);
    }
    
    return rate;
}

function isDuplicate(pokemonId,isShiny){return gameState.captured.has(pokemonId);}

function addToCollection(pokemonId,isShiny,isGolden=false){
    // ===== D√âCLARATION UNIQUE DE RARITY AU D√âBUT =====
    const rarity = getRarity(pokemonId);
    const wasDuplicate=isDuplicate(pokemonId,isShiny);
    gameState.captured.add(pokemonId);
    gameState.capturedCount[pokemonId]=(gameState.capturedCount[pokemonId]||0)+1;
    if(isShiny){
        gameState.shinies.add(pokemonId);
        if(!gameState.system.narrativeFlags.includes('first_shiny_captured')){
            gameState.system.narrativeFlags.push('first_shiny_captured');
            setTimeout(()=>triggerNarrative('guide_first_shiny'),1500);
        }
    }
    if(isGolden){
        if(!gameState.golden)gameState.golden=new Set();
        gameState.golden.add(pokemonId);
        if(!gameState.rogue)gameState.rogue={};
        gameState.rogue.totalShinyTokens=(gameState.rogue.totalShinyTokens||0)+500;
        showToast("üåü GOLDEN : +500 SHINY TOKENS !","success");
        if(!gameState.system.narrativeFlags.includes('golden_pokemon_discovered_shown')){
            gameState.system.narrativeFlags.push('golden_pokemon_discovered_shown');
            setTimeout(()=>triggerNarrative('golden_pokemon_discovered'),1500);
        }
    }
    gameState.totalCaught++;
    const region=getPokemonRegion(pokemonId);
    gameState.regionProgress[region].captured++;
    if(isShiny)gameState.regionProgress[region].shinies++;
    const types=POKEMON_TYPES[pokemonId]||[];
    types.forEach(type=>{gameState.typeCaptureCounts[type]=(gameState.typeCaptureCounts[type]||0)+1;});
    
    // ===== MURMURES D'ENTROPIE - Dialogues contextuels non bloquants =====
    // NOTE: rarity est d√©j√† d√©clar√© au d√©but de la fonction
    const pokemonName = FRENCH_NAMES[pokemonId] || `Pok√©mon #${pokemonId}`;
    
    // D√©clencher des murmures selon le contexte
    if (WATER_TYPES.includes(pokemonId)) {
        triggerAmbientNarrative('capture_water', { pokemon: pokemonName });
    } else if (types.includes('Fire')) {
        triggerAmbientNarrative('capture_fire', { pokemon: pokemonName });
    }
    
    if (['rare', 'super_rare', 'legendary'].includes(rarity)) {
        triggerAmbientNarrative('capture_rare', { pokemon: pokemonName });
    }
    
    if (isShiny) {
        triggerAmbientNarrative('capture_shiny', { pokemon: pokemonName });
    }
    
    if (rarity === 'legendary') {
        triggerAmbientNarrative('legendary_capture', { pokemon: pokemonName });
    }
    
    // Murmure pour les streaks √©lev√©s
    if (gameState.streak >= 10) {
        triggerAmbientNarrative('streak_high', { streak: gameState.streak });
    }
    
    // GENESIS REBOOT - Guidage et Stabilit√© Syst√®me (Niveaux 1-2)
    if (gameState.level <= 2) {
        updateSystemStabilityDisplay();
        
        // NOTE: Le dialogue "first_capture_success" est maintenant affich√© directement apr√®s l'intro
        // (voir finishIntroSequence et forceShowInitButton)
        // NOTE: Le dialogue "rival_missing" a √©t√© d√©plac√© au niveau 6 (voir checkLevelUp)
        
        // Dialogues de progression selon le nombre de captures
        if (gameState.totalCaught === 2 && !gameState.system.narrativeFlags.includes('early_progress_2_shown')) {
            gameState.system.narrativeFlags.push('early_progress_2_shown');
            setTimeout(() => triggerNarrative('early_progress_2'), 1500);
        } else if (gameState.totalCaught === 3 && !gameState.system.narrativeFlags.includes('early_progress_3_shown')) {
            gameState.system.narrativeFlags.push('early_progress_3_shown');
            setTimeout(() => triggerNarrative('early_progress_3'), 1500);
        } else if (gameState.totalCaught === 4 && !gameState.system.narrativeFlags.includes('early_progress_4_shown')) {
            gameState.system.narrativeFlags.push('early_progress_4_shown');
            setTimeout(() => triggerNarrative('early_progress_4'), 1500);
        }
        
        // NOTE: Le message "Mes batteries faiblissent" est maintenant d√©clench√© au niveau 4 (voir checkLevelUp)
    }const maxTypeCount=Math.max(...Object.values(gameState.typeCaptureCounts||{}),0);if(maxTypeCount>=20)updateQuestProgress('type_master_any',maxTypeCount);
    
    // GENESIS REBOOT - V√©rifier si Kanto est compl√©t√© (151/151) pour d√©clencher MissingNo
    // BUG FIX : Utiliser getCaughtCount('Kanto') au lieu de captured.size pour √©viter le bug "≈íuf Myst√®re"
    // (Si un joueur a un Pok√©mon Johto via ≈ìuf avant de finir Kanto, captured.size peut √™tre > 151)
    // CORRECTION : V√©rifier que missingNoTriggered est bien d√©fini (true) avant de d√©clencher
    if (region === 'Kanto' && getCaughtCount('Kanto') === 151) {
        // Initialiser le flag s'il n'existe pas
        if (gameState.missingNoTriggered === undefined) {
            gameState.missingNoTriggered = false;
        }
        // Ne d√©clencher que si le flag est explicitement false (pas encore d√©clench√©)
        if (gameState.missingNoTriggered === false) {
            gameState.missingNoTriggered = true;
            setTimeout(() => triggerMissingNoEvent(), 2000); // D√©lai de 2 secondes pour laisser le temps √† l'animation de capture
        }
    }
    
    // CORRECTION : V√©rifier si Johto est compl√©t√© (100/100) pour d√©clencher MissingNo pour Hoenn
    if (region === 'Johto' && getCaughtCount('Johto') === 100 && !gameState.missingNoTriggeredJohto) {
        gameState.missingNoTriggeredJohto = true;
        // Le combat MissingN0 sera d√©clench√© dans checkRegionUnlock() apr√®s le d√©blocage de Hoenn
    }
    
    updateQuestProgress('regional_'+region,gameState.regionProgress[region].captured);if(gameState.inventory.mystery_egg>0){gameState.mysteryEggProgress=(gameState.mysteryEggProgress||0)+1;if(gameState.mysteryEggProgress>=50){hatchMysteryEgg();}}advanceEggProgress(1);updateQuestProgress('captures',1);if(isShiny)updateQuestProgress('shinies',1);
    // NOTE: rarity est d√©j√† d√©clar√© au d√©but de la fonction, pas besoin de le red√©clarer
    if(['rare','super_rare','legendary'].includes(rarity)){gameState.rareCaptureCount=(gameState.rareCaptureCount||0)+1;updateQuestProgress('rare_captures',1);}if(rarity==='legendary')updateQuestProgress('legendaries',1);const buddyId=gameState.buddy?.activeBuddyId;if(buddyId){let buddyXP=1;if(rarity==='rare')buddyXP=2;if(rarity==='super_rare')buddyXP=3;if(rarity==='legendary')buddyXP=5;if(isShiny)buddyXP+=5;addBuddyXP(buddyXP);}checkRegionUnlock();saveGame();return wasDuplicate;}

function getPokemonRegion(pokemonId){if(pokemonId>=1&&pokemonId<=151)return'Kanto';if(pokemonId>=152&&pokemonId<=251)return'Johto';if(pokemonId>=252&&pokemonId<=386)return'Hoenn';return'Kanto';}

function getCurrentUnlockedRegion(){
    if(!gameState.unlockedRegions) gameState.unlockedRegions = new Set(['Kanto']);
    if(gameState.unlockedRegions.has('Hoenn')) return 'Hoenn';
    if(gameState.unlockedRegions.has('Johto')) return 'Johto';
    return 'Kanto';
}

function checkRegionUnlock(){
    if(!gameState.unlockedRegions) gameState.unlockedRegions = new Set(['Kanto']);
    
    // V√©rifier si Kanto est compl√©t√© √† 100% (151/151)
    const kantoCount = getCaughtCount('Kanto');
    if(kantoCount >= 151 && !gameState.unlockedRegions.has('Johto')){
        // ===== SYSTEM OVERRIDE pour le d√©blocage de Johto =====
        if (typeof window.triggerSystemOverride === 'function') {
            window.triggerSystemOverride('region_unlock_johto', () => {
                unlockRegion('Johto');
                // CORRECTION : Ne d√©clencher le dialogue que s'il n'a pas d√©j√† √©t√© vu
                if (!gameState.system.narrativeFlags.includes('system_reboot_johto')) {
                    triggerNarrative('system_reboot_johto');
                }
                showToast('üéâ R√©gion Johto d√©bloqu√©e ! Vous avez compl√©t√© le Pok√©dex Kanto (151/151)', 'success');
                saveGame();
            });
        } else {
            unlockRegion('Johto');
            // CORRECTION : Ne d√©clencher le dialogue que s'il n'a pas d√©j√† √©t√© vu
            if (!gameState.system.narrativeFlags.includes('system_reboot_johto')) {
                triggerNarrative('system_reboot_johto');
            }
            showToast('üéâ R√©gion Johto d√©bloqu√©e ! Vous avez compl√©t√© le Pok√©dex Kanto (151/151)', 'success');
            saveGame();
        }
    }
    
    // V√©rifier si Johto est compl√©t√© √† 100% (100/100 : de 152 √† 251)
    const johtoCount = getCaughtCount('Johto');
    if(johtoCount >= 100 && !gameState.unlockedRegions.has('Hoenn')){
        // ===== SYSTEM OVERRIDE pour le d√©blocage de Hoenn =====
        if (typeof window.triggerSystemOverride === 'function') {
            window.triggerSystemOverride('region_unlock_hoenn', () => {
                unlockRegion('Hoenn');
                // CORRECTION : Ne d√©clencher le dialogue que s'il n'a pas d√©j√† √©t√© vu
                if (!gameState.system.narrativeFlags.includes('system_reboot_hoenn')) {
                    triggerNarrative('system_reboot_hoenn');
                }
                // CORRECTION : D√©clencher le combat MissingN0 pour Johto ‚Üí Hoenn (comme Kanto ‚Üí Johto)
                if (!gameState.missingNoTriggeredJohto) {
                    gameState.missingNoTriggeredJohto = true;
                    setTimeout(() => triggerMissingNoEvent(), 2000);
                }
                showToast('üéâ R√©gion Hoenn d√©bloqu√©e ! Vous avez compl√©t√© le Pok√©dex Johto (100/100)', 'success');
                saveGame();
            });
        } else {
            unlockRegion('Hoenn');
            // CORRECTION : Ne d√©clencher le dialogue que s'il n'a pas d√©j√† √©t√© vu
            if (!gameState.system.narrativeFlags.includes('system_reboot_hoenn')) {
                triggerNarrative('system_reboot_hoenn');
            }
            // CORRECTION : D√©clencher le combat MissingN0 pour Johto ‚Üí Hoenn (comme Kanto ‚Üí Johto)
            if (!gameState.missingNoTriggeredJohto) {
                gameState.missingNoTriggeredJohto = true;
                setTimeout(() => triggerMissingNoEvent(), 2000);
            }
            showToast('üéâ R√©gion Hoenn d√©bloqu√©e ! Vous avez compl√©t√© le Pok√©dex Johto (100/100)', 'success');
            saveGame();
        }
    }
}

function filterPokemonByRegion(pokemonIds, region){
    const regionRanges = {
        'Kanto': {min: 1, max: 151},
        'Johto': {min: 152, max: 251},
        'Hoenn': {min: 252, max: 386}
    };
    const range = regionRanges[region] || regionRanges['Kanto'];
    return pokemonIds.filter(id => id >= range.min && id <= range.max);
}

// ===== SYST√àME D'≈íUFS (V8.0) =====

function dropEgg(tier) {
    if (!gameState.inventory.eggs) gameState.inventory.eggs = [];
    if (gameState.inventory.eggs.length >= 9) {
        showToast("Inventaire d'≈ìufs plein !", "warning");
        return;
    }
    
    const eggId = `egg_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
    gameState.inventory.eggs.push({
        uid: eggId,
        tier: tier,
        obtainedAt: Date.now(),
        progress: 0,
        state: 'inventory',
        region: getCurrentUnlockedRegion()
    });
    
    showToast(`ü•ö Vous avez trouv√© un ${EGG_CONFIG.tiers[tier].name} !`, 'success');
    saveGame();
}

// ===== SYST√àME D'≈íUFS RECOD√â (STABLE V2) =====

// 1. Logique d'Incubation (Backend)
window.startIncubation = function(eggUid) {
    // V√©rification inventaire
    const eggIndex = gameState.inventory.eggs.findIndex(e => e && e.uid === eggUid);
    if (eggIndex === -1) return;

    // V√©rification slots
    if (!gameState.incubation) gameState.incubation = { incubators: 1 };
    const activeEggs = gameState.inventory.eggs.filter(e => e && e.state === 'incubating').length;
    
    if (activeEggs >= gameState.incubation.incubators) {
        showToast("Incubateurs pleins !", "error");
        return;
    }

    // Lancement
    gameState.inventory.eggs[eggIndex].state = 'incubating';
    saveGame();
    showToast("Incubation lanc√©e !", "success");
    
    // Rafra√Æchir UI
    if (window.renderEggsModalContent) window.renderEggsModalContent(); 
};

function advanceEggProgress(amount) {
    if (!gameState.inventory.eggs) return;
    let hatched = false;
    
    gameState.inventory.eggs.forEach(egg => {
        if (egg.state === 'incubating') {
            const target = EGG_CONFIG.tiers[egg.tier].steps;
            if (egg.progress < target) {
                egg.progress += amount;
                if (egg.progress >= target) {
                    egg.progress = target;
                    egg.state = 'ready';
                    hatched = true;
                }
            }
        }
    });
    
    if (hatched) {
        showToast("ü•ö Un ≈ìuf est pr√™t √† √©clore !", "success");
    }
    saveGame();
}

// 2. Logique d'√âclosion (D√©clencheur)
window.triggerHatch = function(eggUid) {
    const eggIndex = gameState.inventory.eggs.findIndex(e => e && e.uid === eggUid);
    if (eggIndex === -1) return;
    
    const egg = gameState.inventory.eggs[eggIndex];
    if (!egg || egg.state !== 'ready') return;

    // On ferme la modale d'inventaire pour jouer l'animation
    const eggsModal = document.getElementById('eggs-management-modal');
    if (eggsModal) eggsModal.remove();

    // Animation
    playHatchAnimation(egg);
};

function rollEggPokemon(tier, regionOrigin) {
    const region = regionOrigin || getCurrentUnlockedRegion();
    const regionFilter = (id) => {
        const pRegion = getPokemonRegion(id);
        if (region === 'Kanto') return pRegion === 'Kanto';
        if (region === 'Johto') return pRegion === 'Kanto' || pRegion === 'Johto';
        return true;
    };

    let pool = [];
    
    if (tier === 'epic') {
        const babies = EGG_CONFIG.exclusiveIds.filter(regionFilter);
        pool = babies.length > 0 ? babies : POKEMON_DATA.super_rare.filter(regionFilter);
    } else if (tier === 'legendary') {
        pool = POKEMON_DATA.legendary.filter(regionFilter);
    } else if (tier === 'rare') {
        const starters = [1, 4, 7, 152, 155, 158, 252, 255, 258].filter(regionFilter);
        pool = POKEMON_DATA.rare.concat(starters).filter(regionFilter);
    } else {
        pool = POKEMON_DATA.common.concat(POKEMON_DATA.uncommon).filter(regionFilter);
    }
    
    if (pool.length === 0) pool = [19];
    
    const id = pool[Math.floor(Math.random() * pool.length)];
    const config = EGG_CONFIG.tiers[tier];
    
    let isShiny = Math.random() < (1/256 * config.shinyRateMult);
    // ‚ö†Ô∏è L√©viator Shiny EXCLUSIF √† la p√™che - jamais shiny ailleurs
    if (id === 130) isShiny = false;
    const isGolden = Math.random() < GOLDEN_RATE;
    
    return {
        id: id,
        name: FRENCH_NAMES[id],
        rarity: getRarity(id),
        isShiny: isShiny,
        isGolden: isGolden
    };
}

// 3. Animation et R√©v√©lation
function playHatchAnimation(egg) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 20000; display: flex; align-items: center; justify-content: center; flex-direction: column;';
    
    const tierConfig = EGG_CONFIG.tiers[egg.tier] || EGG_CONFIG.tiers['common'];
    
    modal.innerHTML = `
        <div style="font-size: 8em; animation: eggShake 0.5s infinite alternate;">ü•ö</div>
        <h2 style="color: white; margin-top: 20px; font-size: 2em;">√áa craque...</h2>
        <p style="color: ${tierConfig.color};">${tierConfig.name}</p>
    `;
    document.body.appendChild(modal);

    setTimeout(() => {
        // Calcul du Pok√©mon (Logique RNG)
        const pokemon = rollEggPokemon(egg.tier, egg.region);
        
        // Retrait de l'≈ìuf de l'inventaire
        gameState.inventory.eggs = gameState.inventory.eggs.filter(e => e && e.uid !== egg.uid);
        
        // Ajout √† la collection
        addToCollection(pokemon.id, pokemon.isShiny, pokemon.isGolden);
        saveGame();

        // Affichage R√©sultat
        const spriteUrl = getAnimatedSpriteUrl(pokemon.id, pokemon.isShiny);
        const title = pokemon.isGolden ? 'üåü GOLDEN !' : (pokemon.isShiny ? '‚ú® SHINY !' : 'F√©licitations !');
        
        modal.innerHTML = `
            <div style="text-align: center; animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                <h2 style="color: ${pokemon.isShiny ? '#FFD700' : 'white'}; font-size: 2.5em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(0,0,0,0.5);">${title}</h2>
                <div style="background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); padding: 40px; border-radius: 50%;">
                    <img src="${spriteUrl}" style="width: 200px; height: 200px; image-rendering: pixelated; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); object-fit: contain; object-position: center;">
                </div>
                <h3 style="color: white; font-size: 1.8em; margin: 20px 0;">${pokemon.name}</h3>
                <div style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">${tierConfig.name} √©clos</div>
                <button onclick="this.closest('.modal').remove(); if(window.openEggsModal) window.openEggsModal();" class="btn btn--primary" style="padding: 15px 40px; font-size: 1.2em;">Continuer</button>
            </div>
        `;
        
        // FX
        if (window.FX) {
            if (pokemon.isShiny || pokemon.isGolden) FX.confetti(window.innerWidth/2, window.innerHeight/2, 100);
            FX.stars(window.innerWidth/2, window.innerHeight/2, 30);
        }
        if (typeof launchShinyConfetti === 'function') launchShinyConfetti();
    }, 3000);
}

// ===== SYST√àME CATCHBOT (V8.0) =====

function updateCatchbot() {
    if (!gameState.catchbot || !gameState.catchbot.active) return;
    
    const now = Date.now();
    const timeDiff = now - gameState.catchbot.lastCatch;
    
    if (timeDiff >= CATCHBOT_CONFIG.interval) {
        const catches = Math.floor(timeDiff / CATCHBOT_CONFIG.interval);
        const maxCatches = CATCHBOT_CONFIG.storageLimit; 
        const realCatches = Math.min(catches, maxCatches);
        
        if (realCatches > 0) {
            if (!gameState.catchbot.storage) gameState.catchbot.storage = [];
            for (let i = 0; i < realCatches; i++) {
                const pokemon = selectPokemon('spawn', false);
                gameState.catchbot.storage.push({
                    id: pokemon.id,
                    isShiny: Math.random() < CATCHBOT_CONFIG.shinyChance,
                    time: now - (i * CATCHBOT_CONFIG.interval)
                });
            }
            gameState.catchbot.lastCatch = now;
            saveGame();
        }
    }
}

window.claimCatchbot = function() {
    if (!gameState.catchbot || !gameState.catchbot.storage || gameState.catchbot.storage.length === 0) {
        showToast("Le Catchbot est vide !", "info");
        return;
    }
    
    const count = gameState.catchbot.storage.length;
    let shinies = 0;
    let coins = 0;
    
    gameState.catchbot.storage.forEach(p => {
        addToCollection(p.id, p.isShiny);
        if (p.isShiny) shinies++;
        coins += 50;
    });
    
    gameState.coins += coins;
    gameState.catchbot.storage = [];
    
    showToast(`ü§ñ Catchbot : ${count} Pok√©mon r√©cup√©r√©s (+${coins}üí∞)${shinies > 0 ? ` dont ${shinies} SHINY !` : ''}`, 'success');
    saveGame();
    updateUI();
};

// R√©trocompatibilit√© : garder les anciens noms
window.incubateEgg = function(eggUid) {
    if (window.startIncubation) window.startIncubation(eggUid);
};

window.hatchEgg = function(eggUid) {
    if (window.triggerHatch) window.triggerHatch(eggUid);
};

// 4. UI Gestion des ≈íufs (Clean)
window.openEggsModal = function() {
    // Nettoyage pr√©ventif
    const existing = document.getElementById('eggs-management-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'eggs-management-modal';
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 20, 0.95); z-index: 10000; overflow-y: auto; display: flex; align-items: flex-start; justify-content: center; padding: 40px 20px;';
    
    modal.innerHTML = `
        <div style="max-width: 800px; width: 100%; margin: auto; background: #1a1a2e; border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: white; margin: 0;">ü•ö Couveuse</h2>
                <button onclick="this.closest('.modal').remove()" class="btn btn--outline">Fermer</button>
            </div>
            <div id="eggs-list-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px;">
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    if (window.renderEggsModalContent) window.renderEggsModalContent();
};

window.renderEggsModalContent = function() {
    const container = document.getElementById('eggs-list-container');
    if (!container) return;

    if (!gameState.inventory.eggs || gameState.inventory.eggs.length === 0) {
        container.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 40px;">Aucun ≈ìuf en inventaire</div>`;
        return;
    }

    const activeIncubators = gameState.inventory.eggs.filter(e => e && e.state === 'incubating').length;
    const maxIncubators = gameState.incubation ? (gameState.incubation.incubators || 1) : 1;

    container.innerHTML = gameState.inventory.eggs.map(egg => {
        if (!egg) return '';
        
        // R√©trocompatibilit√© : initialiser les propri√©t√©s manquantes
        if (!egg.tier) egg.tier = 'common';
        if (!egg.region) egg.region = getCurrentUnlockedRegion();
        if (egg.progress === undefined) egg.progress = 0;
        if (!egg.state) egg.state = 'inventory';
        if (!egg.uid) egg.uid = 'egg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const config = EGG_CONFIG.tiers[egg.tier] || EGG_CONFIG.tiers['common'];
        const isReady = egg.state === 'ready';
        const isIncubating = egg.state === 'incubating';
        const progressPct = Math.min((egg.progress / config.steps) * 100, 100);

        let btnHtml = '';
        if (isReady) {
            btnHtml = `<button onclick="if(window.triggerHatch) window.triggerHatch('${egg.uid}')" class="btn btn--primary" style="width: 100%; background: linear-gradient(135deg, #FFD700, #FFA500); color: black; font-weight: bold; animation: pulse 1s infinite;">√âCLORE !</button>`;
        } else if (isIncubating) {
             btnHtml = `<div style="font-size: 0.8em; color: #4ade80; padding: 8px; background: rgba(74, 222, 128, 0.1); border-radius: 8px;">En cours... ${egg.progress}/${config.steps}</div>`;
        } else {
             if (activeIncubators < maxIncubators) {
                 btnHtml = `<button onclick="if(window.startIncubation) window.startIncubation('${egg.uid}')" class="btn btn--outline" style="width: 100%;">Incuber</button>`;
             } else {
                 btnHtml = `<div style="font-size: 0.8em; color: #666;">Incubateurs pleins</div>`;
             }
        }

        return `
            <div style="background: rgba(255,255,255,0.05); border: 2px solid ${config.color}; border-radius: 15px; padding: 15px; text-align: center; position: relative;">
                <div style="font-size: 3em; margin-bottom: 10px; ${isIncubating ? 'animation: eggShake 3s infinite;' : ''}">ü•ö</div>
                <div style="color: ${config.color}; font-weight: bold; font-size: 0.9em; margin-bottom: 5px;">${config.name}</div>
                
                <div style="width: 100%; height: 6px; background: #333; border-radius: 3px; margin: 10px 0; overflow: hidden;">
                    <div style="width: ${progressPct}%; height: 100%; background: ${config.color}; transition: width 0.5s;"></div>
                </div>
                
                ${btnHtml}
            </div>
        `;
    }).filter(html => html !== '').join('');
};

function gainXP(rarity, isDuplicate = false) {
    const XP_GAINS = { common: 10, uncommon: 20, rare: 50, super_rare: 100, legendary: 200 };
    let xpGain = XP_GAINS[rarity] || 10;

    // Boosts
    const hasExpBoost = gameState.activeBoosts.some(b => b.type === 'exp_charm' && b.endTime > Date.now());
    if (hasExpBoost) xpGain = Math.floor(xpGain * 1.25);

    // Buddy Boost
    const buddyId = gameState.buddy?.activeBuddyId;
    const buddy = buddyId ? gameState.buddy.buddies[buddyId] : null;
    if (buddy && (buddy.level || 1) >= 6) xpGain = Math.floor(xpGain * 1.05);

    // Streak Boost
    if (gameState.streak >= 10) xpGain = Math.floor(xpGain * 1.2);
    else if (gameState.streak >= 5) xpGain = Math.floor(xpGain * 1.1);

    if (isDuplicate) xpGain *= 2;

    const levelBefore = gameState.level;
    gameState.xp += xpGain;

    // V√©rification de niveau
    checkLevelUp();

    // Narrative trigger (Level 2 mid-xp)
    if (gameState.level === 2 && !gameState.system.narrativeFlags.includes('guide_first_capture_shown')) {
        const xpPercent = (gameState.xp / gameState.xpToNext) * 100;
        if (xpPercent >= 50) {
            gameState.system.narrativeFlags.push('guide_first_capture_shown');
            setTimeout(() => triggerNarrative('guide_first_capture'), 1500);
        }
    }

    if (gameState.level > levelBefore && typeof updatePorygonVisuals === 'function') {
        updatePorygonVisuals();
    }

    return xpGain;
}

const LEVEL_REWARDS = {
    1: { coins: 1200, items: { pokeball: 5 } },
    2: { coins: 1300, items: { framby: 1 } },
    3: { coins: 1300, items: { pokeball: 5 } },
    4: { coins: 1400, items: { pinap: 1 } },
    5: { coins: 1500, items: { greatball: 5 } },
    6: { coins: 1600, items: { pokeball: 5 } },
    7: { coins: 1700, items: { framby: 2 } },
    8: { coins: 1800, items: { greatball: 3 } },
    9: { coins: 1900, items: { pinap: 2 } },
    10: { coins: 2000, items: { ultraball: 2 } },
    11: { coins: 2100, items: { pokeball: 5 } },
    12: { coins: 2200, items: { framby: 3 } },
    13: { coins: 2300, items: { greatball: 5 } },
    14: { coins: 2400, items: { pinap: 3 } },
    15: { coins: 2500, items: { ultraball: 3, mystery_egg: 1 } },
    16: { coins: 2600, items: { pokeball: 10 } },
    17: { coins: 2700, items: { ceriz: 1 } },
    18: { coins: 2800, items: { greatball: 5 } },
    19: { coins: 2900, items: { ultraball: 3 } },
    20: { coins: 3000, items: { masterball: 1 } },
    21: { coins: 3100, items: { pokeball: 10 } },
    22: { coins: 3200, items: { framby: 5 } },
    23: { coins: 3300, items: { greatball: 10 } },
    24: { coins: 3400, items: { pinap: 5 } },
    25: { coins: 3500, items: { ultraball: 5 } },
    26: { coins: 3600, items: { ceriz: 2 } },
    27: { coins: 3700, items: { exp_charm: 1 } },
    28: { coins: 3800, items: { lucky_charm: 1 } },
    29: { coins: 3900, items: { fire_stone: 1 } },
    30: { coins: 4000, items: { water_stone: 1 } },
    31: { coins: 4100, items: { thunder_stone: 1 } },
    32: { coins: 4200, items: { moon_stone: 1 } },
    33: { coins: 4300, items: { leaf_stone: 1 } },
    34: { coins: 4400, items: { ultraball: 10 } },
    35: { coins: 4500, items: { ceriz: 3 } },
    36: { coins: 4600, items: { exp_charm: 2 } },
    37: { coins: 4700, items: { lucky_charm: 2 } },
    38: { coins: 4800, items: { fire_stone: 1 } },
    39: { coins: 4900, items: { water_stone: 1 } },
    40: { coins: 5000, items: { thunder_stone: 1 } },
    41: { coins: 5200, items: { moon_stone: 1 } },
    42: { coins: 5400, items: { leaf_stone: 1 } },
    43: { coins: 5600, items: { ultraball: 10 } },
    44: { coins: 5800, items: { ceriz: 5 } },
    45: { coins: 6000, items: { lucky_charm: 3 } },
    46: { coins: 6500, items: { exp_charm: 3 } },
    47: { coins: 7000, items: { fire_stone: 2 } },
    48: { coins: 7500, items: { water_stone: 2 } },
    49: { coins: 8000, items: { thunder_stone: 2 } },
    50: { coins: 9000, items: { charm_collection: 1, ultrabox: 1 } }
};

function checkLevelUp() {
    if (gameState.level >= 50) {
        if (gameState.xp > gameState.xpToNext) gameState.xp = gameState.xpToNext;
        return;
    }

    const oldLevel = gameState.level;

    while (gameState.xp >= gameState.xpToNext && gameState.level < 50) {
        gameState.xp -= gameState.xpToNext;
        gameState.level++;

        if (gameState.level >= 50) {
            if (gameState.xp > gameState.xpToNext) gameState.xp = gameState.xpToNext;
            gameState.level = 50;
        }

        gameState.xpToNext = gameState.level * 250;
        const reward = LEVEL_REWARDS[gameState.level];

        if (reward) {
            gameState.pendingLevelUps.push({
                level: gameState.level,
                rewards: reward
            });
        } else {
            const bonusCoins = 100 + (gameState.level * 50);
            gameState.pendingLevelUps.push({
                level: gameState.level,
                rewards: {
                    coins: bonusCoins,
                    items: {}
                }
            });
        }
    }

    // D√©blocages narratifs
    if (gameState.level === 2) {
        showToast('üé£ P√™che d√©bloqu√©e au niveau 2!', 'success');
        updateUIFishing();
        if (gameState.modules && gameState.modules.fishing && !gameState.modules.fishing.unlocked) {
            gameState.modules.fishing.unlocked = true;
            setTimeout(() => triggerNarrative('unlock_fishing_module'), 1500);
        }
        if (typeof checkNarrativeTriggers === 'function') checkNarrativeTriggers();
    }

    if (gameState.level === 3) {
        if (!gameState.modules) gameState.modules = {};
        if (!gameState.modules.quests) {
            gameState.modules.quests = { id: 'quests', condition: 'level_3', unlocked: true };
        } else if (!gameState.modules.quests.unlocked) {
            gameState.modules.quests.unlocked = true;
        }
        updateQuestsVisibility();
        triggerNarrative('unlock_quests_module');
        setTimeout(() => {
            if (!gameState.system.narrativeFlags.includes('guide_quests_shown')) {
                gameState.system.narrativeFlags.push('guide_quests_shown');
                setTimeout(() => triggerNarrative('guide_quests'), 2000);
            }
        }, 2000);
    }

    if (gameState.level === 4) {
        if (!gameState.system.narrativeFlags.includes('energy_warning_early_shown')) {
            gameState.system.narrativeFlags.push('energy_warning_early_shown');
            setTimeout(() => triggerNarrative('energy_warning_early'), 2000);
        }
        if (gameState.modules && gameState.modules.blindbox && !gameState.modules.blindbox.unlocked) {
            gameState.modules.blindbox.unlocked = true;
            triggerNarrative('unlock_blindbox');
        }
    }

    if (gameState.level === 5) {
        gameState.research.unlocked = true;
        if (gameState.modules && gameState.modules.research && !gameState.modules.research.unlocked) {
            gameState.modules.research.unlocked = true;
            triggerNarrative('unlock_research_core');
        }
        if (typeof checkNarrativeTriggers === 'function') checkNarrativeTriggers();
    }

    if (gameState.level === 6) {
        if (!gameState.system.narrativeFlags.includes('rival_signal_detected_shown')) {
            gameState.system.narrativeFlags.push('rival_signal_detected_shown');
            setTimeout(() => triggerNarrative('rival_signal_detected'), 2000);
        }
        if (!gameState.system.narrativeFlags.includes('rival_search_failed_shown')) {
            gameState.system.narrativeFlags.push('rival_search_failed_shown');
            setTimeout(() => triggerNarrative('rival_search_failed'), 4000);
        }
    }

    if (gameState.level === 7) {
        if (!gameState.system.narrativeFlags.includes('rival_corrupted_ball_shown')) {
            gameState.system.narrativeFlags.push('rival_corrupted_ball_shown');
            if (!gameState.inventory.corrupted_ball) gameState.inventory.corrupted_ball = 1;
            setTimeout(() => triggerNarrative('rival_corrupted_ball_found'), 2000);
        }
    }

    if (gameState.level === 8) {
        if (!gameState.system.narrativeFlags.includes('rival_signal_decrypted_shown')) {
            gameState.system.narrativeFlags.push('rival_signal_decrypted_shown');
            setTimeout(() => triggerNarrative('rival_signal_decrypted'), 2000);
        }
    }

    if (gameState.level === 9) {
        if (!gameState.system.narrativeFlags.includes('rival_ghost_battle_shown')) {
            gameState.system.narrativeFlags.push('rival_ghost_battle_shown');
            setTimeout(() => triggerNarrative('rival_ghost_battle'), 2000);
            setTimeout(() => {
                if (!gameState.inventory.rival_badge) {
                    gameState.inventory.rival_badge = 1;
                    triggerNarrative('rival_badge_earned');
                    showToast('üèÜ Badge du Rival obtenu ! +5% XP permanent', 'success');
                }
            }, 10000);
        }
    }

    if (gameState.level === 10) {
        if (gameState.modules && gameState.modules.poker && !gameState.modules.poker.unlocked) {
            gameState.modules.poker.unlocked = true;
            triggerNarrative('unlock_decryption');
            setTimeout(() => updateNavigationVisibility(), 200);
            setTimeout(() => {
                if (!gameState.system.narrativeFlags.includes('guide_poker_first_shown')) {
                    gameState.system.narrativeFlags.push('guide_poker_first_shown');
                    triggerNarrative('guide_poker_first');
                }
            }, 3000);
        }
    }

    if (gameState.level === 12) {
        if (gameState.modules && gameState.modules.rogue && !gameState.modules.rogue.unlocked) {
            gameState.modules.rogue.unlocked = true;
            triggerNarrative('unlock_deepnet');
            setTimeout(() => updateNavigationVisibility(), 200);
            setTimeout(() => {
                if (!gameState.system.narrativeFlags.includes('guide_expedition_first_shown')) {
                    gameState.system.narrativeFlags.push('guide_expedition_first_shown');
                    triggerNarrative('guide_expedition_first');
                }
            }, 3000);
        }
    }

    if (gameState.level === 13) {
        if (!gameState.system.narrativeFlags.includes('deepnet_encryption_shown')) {
            gameState.system.narrativeFlags.push('deepnet_encryption_shown');
            setTimeout(() => triggerNarrative('deepnet_encryption_thickening'), 2000);
        }
    }

    if (gameState.level === 14) {
        if (!gameState.system.narrativeFlags.includes('deepnet_firewall_shown')) {
            gameState.system.narrativeFlags.push('deepnet_firewall_shown');
            setTimeout(() => triggerNarrative('deepnet_firewall'), 2000);
            const expeditionsCompleted = (gameState.rogue?.runsCompleted || 0);
            if (expeditionsCompleted < 3) {
                gameState.system.firewallActive = true;
            }
        }
    }

    if (gameState.level === 21) {
        if (!gameState.system.narrativeFlags.includes('porygon_memory_loss_1_shown')) {
            gameState.system.narrativeFlags.push('porygon_memory_loss_1_shown');
            setTimeout(() => triggerNarrative('porygon_memory_loss_1'), 2000);
        }
    }

    if (gameState.level === 22) {
        if (!gameState.system.narrativeFlags.includes('porygon_memory_loss_2_shown')) {
            gameState.system.narrativeFlags.push('porygon_memory_loss_2_shown');
            setTimeout(() => triggerNarrative('porygon_memory_loss_2'), 2000);
            document.body.classList.add('system-glitch-temporary');
            setTimeout(() => {
                document.body.classList.remove('system-glitch-temporary');
            }, 10000);
        }
    }

    if (gameState.level === 23) {
        if (!gameState.system.narrativeFlags.includes('porygon_defrag_needed_shown')) {
            gameState.system.narrativeFlags.push('porygon_defrag_needed_shown');
            setTimeout(() => triggerNarrative('porygon_defrag_needed'), 2000);
            gameState.system.defragAvailable = true;
        }
    }

    if (gameState.level === 25) {
        if (gameState.modules && gameState.modules.tcg && !gameState.modules.tcg.unlocked) {
            gameState.modules.tcg.unlocked = true;
            triggerNarrative('unlock_archives');
            setTimeout(() => {
                if (!gameState.system.narrativeFlags.includes('guide_tcg_first_shown')) {
                    gameState.system.narrativeFlags.push('guide_tcg_first_shown');
                    triggerNarrative('guide_tcg_first');
                }
            }, 3000);
        }
    }

    saveGame();
    updateUI();
    if (oldLevel !== gameState.level) {
        showLevelUpPopup(gameState.level);
    }
    processPendingLevelUps();
}

function processPendingLevelUps() {
    if (gameState.pendingLevelUps.length === 0) return;
    const levelUp = gameState.pendingLevelUps[0];
    showLevelUpPopup(levelUp.level, levelUp.rewards);
    gameState.pendingLevelUps.shift();
}

// POLISHING : Fonction pour g√©rer l'ambiance visuelle selon le niveau
function updateSystemVisualState() {
    if (!document.body) return;
    
    // ‚úÖ CORRECTION : Ne pas appliquer le glitch si l'intro n'a pas encore √©t√© vue
    if (!gameState.introSeen) {
        // Retirer toutes les classes de glitch pendant l'intro
        document.body.classList.remove('system-critical', 'system-unstable', 'system-stable', 'system-optimized', 'system-advanced');
        return;
    }
    
    // Retirer toutes les classes de glitch
    document.body.classList.remove('system-critical', 'system-unstable', 'system-stable', 'system-optimized', 'system-advanced');
    
    // Si 5 captures ont √©t√© faites, le syst√®me est stable (m√™me au niveau 1)
    const hasStabilized = gameState.totalCaught >= 5;
    
    // Appliquer la classe selon le niveau (selon le tableau de progression)
    // Exception : Si 5 captures ont √©t√© faites, on retire le glitch m√™me au niveau 1
    if (hasStabilized) {
        // Syst√®me stabilis√© apr√®s 5 captures
        if (gameState.level < 5) {
            document.body.classList.add('system-unstable'); // LVL 1-4: INSTABLE (Glitch Moyen) apr√®s stabilisation
        } else if (gameState.level < 10) {
            document.body.classList.add('system-stable'); // LVL 5-9: STABLE (Glitch L√©ger)
        } else if (gameState.level < 12) {
            document.body.classList.add('system-optimized'); // LVL 10-11: OPTIMIS√â (Presque propre)
        } else {
            document.body.classList.add('system-advanced'); // LVL 12+: AVANC√â (Interface propre)
        }
    } else {
        // Syst√®me non stabilis√©
        if (gameState.level < 2) {
            document.body.classList.add('system-critical'); // LVL 1: CRITIQUE (Glitch Fort)
        } else if (gameState.level < 5) {
            document.body.classList.add('system-unstable'); // LVL 2-4: INSTABLE (Glitch Moyen)
        } else if (gameState.level < 10) {
            document.body.classList.add('system-stable'); // LVL 5-9: STABLE (Glitch L√©ger)
        } else if (gameState.level < 12) {
            document.body.classList.add('system-optimized'); // LVL 10-11: OPTIMIS√â (Presque propre)
        } else {
            document.body.classList.add('system-advanced'); // LVL 12+: AVANC√â (Interface propre)
        }
    }
}

// POLISHING : Modale bloquante pour l'intro boot
// ===== S√âQUENCE D'INTRODUCTION "PROFESSOR GLITCH" =====
// ===== NOUVELLE S√âQUENCE D'INTRODUCTION MOBILE FIRST =====
function startGlitchIntro() {
    if (gameState.introSeen) {
        // Intro d√©j√† vue, passer directement au jeu
        if (!gameState.customization.nameModalSeen) {
            setTimeout(() => showNameModal(), 500);
        }
        return;
    }
    
    // Afficher le nouvel overlay d'intro
    const gameBoyScreen = document.getElementById('game-boy-screen');
    if (!gameBoyScreen) return;
    
    // ‚úÖ CORRECTION : Retirer TOUTES les classes de glitch AVANT d'afficher l'intro
    document.body.classList.remove('system-critical', 'system-unstable', 'system-stable', 'system-optimized', 'system-advanced');
    
    gameBoyScreen.style.display = 'flex';
    // ‚úÖ CORRECTION : Masquer les barres de menu pendant l'intro (fullscreen)
    const topBar = document.querySelector('.top-bar');
    const bottomNav = document.querySelector('.bottom-nav');
    if (topBar) topBar.style.display = 'none';
    if (bottomNav) bottomNav.style.display = 'none';
    
    // Initialiser la s√©quence
    window.startIntroSequence();
}

// Nouvelle fonction pour d√©marrer la s√©quence d'intro
window.startIntroSequence = function() {
    const gameBoyScreen = document.getElementById('game-boy-screen');
    if (!gameBoyScreen) return;
    
    const screens = {
        start: document.getElementById('start-screen'),
        retro: document.getElementById('scene-retro'),
        terminal: document.getElementById('terminal-screen'),
        porygon: document.getElementById('porygon-scene')
    };
    
    const els = {
        retroText: document.getElementById('retro-text'),
        retroArrow: document.getElementById('retro-arrow'),
        oakSprite: document.getElementById('oak-sprite'),
        porygonText: document.getElementById('porygon-text'),
        inputContainer: document.getElementById('input-container'),
        usernameInput: document.getElementById('username'),
        terminal: document.getElementById('terminal-screen'),
        pkmnContainer: document.getElementById('intro-pkmn-container'),
        pokeball: document.getElementById('pokeball-anim'),
        flash: document.getElementById('flash-anim'),
        pokemon: document.getElementById('intro-pokemon')
    };
    
    // Scripts
    const scriptChen = [
        "Bonjour ! Bienvenue dans le monde magique des POK√âMON !",
        "Je m'appelle CHEN.",
        "Les gens m'appellent souvent le PROFESSEUR POK√âMON.",
        "Ce monde est peupl√© de cr√©atures appel√©es POK√âMON.", // Trigger Gengar
        "Pour certains, les POK√âMON sont des animaux domestiques, pour d'autres, ils sont un moyen de combattre.",
        "Moi... J'√©tudie les POK√âMON comme profession.",
        "Tout d'abord, quel est ton nom ?"
    ];
    
    const scriptGlitch = [
        "NOM ? TON NOM... EST...",
        "ERR_MEM_ADDRESS_FAIL... 0x004F2A...",
        "SYST√àME CRITIQUE. SAUVEGARDE CORROMPUE."
    ];
    
    const terminalLogs = [
        "SYSTEM_FAILURE: 0x0000F4",
        "KERNEL_PANIC: Kanto_Lib.dll not found",
        "Checking integrity...",
        "FATAL ERROR: World_Map corrupted",
        "Attempting recovery...",
        "Loading backup: PORYGON_PROTOCOL...",
        "--------------------------------",
        "Rebooting UI..."
    ];
    
    const scriptPorygon = [
        "Archiviste ? Tu me re√ßois ?",
        "C'est moi, Porygon-Z. J'ai r√©ussi √† stabiliser une poche de donn√©es.",
        "Le 'Professeur' n'existe plus. Son fichier a √©t√© effac√© par MissingNo.",
        "Tout l'univers s'effondre. Nous sommes dans une version de secours.",
        "J'ai besoin d'un administrateur pour restaurer le code source.",
        "Vite, entre ton identifiant avant que la connexion ne coupe."
    ];
    
    let isTyping = false;
    
    // Fonction pour masquer l'√©cran de d√©marrage et afficher la sc√®ne retro
    screens.start.classList.add('hidden');
    screens.retro.classList.remove('hidden');
    
    // Utilitaires
    function typeText(element, text, speed, arrowElement) {
        return new Promise(resolve => {
            isTyping = true;
            element.textContent = "";
            if(arrowElement) arrowElement.style.display = 'none';
            let i = 0;
            const interval = setInterval(() => {
                element.textContent += text.charAt(i);
                i++;
                if (i >= text.length) {
                    clearInterval(interval);
                    isTyping = false;
                    if(arrowElement) arrowElement.style.display = 'block';
                    resolve();
                }
            }, speed);
        });
    }
    
    function waitForInteraction() {
        return new Promise(resolve => {
            const handler = () => {
                if (!isTyping) {
                    document.body.removeEventListener('click', handler);
                    document.body.removeEventListener('keydown', handler);
                    document.body.removeEventListener('touchstart', handler);
                    resolve();
                }
            };
            document.body.addEventListener('click', handler);
            document.body.addEventListener('keydown', handler);
            document.body.addEventListener('touchstart', handler);
        });
    }
    
    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    function showIntroPokemon() {
        els.oakSprite.classList.add('slide-left');
        els.pkmnContainer.classList.add('active');
        
        // Reset animations
        els.pokeball.style.animation = 'none';
        els.flash.style.animation = 'none';
        els.pokemon.classList.remove('appear');
        void els.pokeball.offsetWidth; // Force Reflow
        
        // Play animations
        els.pokeball.style.animation = 'throw-arc 0.5s linear forwards';
        els.flash.classList.add('trigger');
        setTimeout(() => { els.pokemon.classList.add('appear'); }, 50);
    }
    
    function hideIntroPokemon() {
        els.pkmnContainer.classList.remove('active');
        els.flash.classList.remove('trigger');
        els.pokemon.classList.remove('appear');
        els.oakSprite.classList.remove('slide-left');
    }
    
    // S√©quence Chen
    async function runChenSequence() {
        for (let i = 0; i < scriptChen.length; i++) {
            // TRIGGER GENGAR (Index 3)
            if (i === 3) showIntroPokemon();
            await typeText(els.retroText, scriptChen[i], 35, els.retroArrow);
            
            if (i < scriptChen.length - 1) {
                await waitForInteraction();
                // Clean Gengar apr√®s le texte
                if (i === 3) hideIntroPokemon();
            }
        }
        await delay(1000); 
        runGlitchSequence();
    }
    
    // S√©quence Glitch
    async function runGlitchSequence() {
        document.body.classList.add('glitch-active');
        
        for (let i = 0; i < scriptGlitch.length; i++) {
            els.retroText.style.color = Math.random() > 0.5 ? 'red' : 'black';
            await typeText(els.retroText, scriptGlitch[i], 20, null);
            await delay(400); 
        }
        await delay(500);
        screens.retro.classList.add('blackout'); 
        els.oakSprite.style.display = 'none';
        const oakFallback = document.getElementById('oak-fallback');
        if (oakFallback) oakFallback.style.display = 'none';
        if (els.retroText.parentNode) els.retroText.parentNode.style.display = 'none';
        els.pkmnContainer.style.display = 'none';
        
        await delay(1500);
        document.body.classList.remove('glitch-active');
        screens.retro.classList.add('hidden');
        runTerminalSequence();
    }
    
    // S√©quence Terminal
    async function runTerminalSequence() {
        screens.terminal.style.display = 'flex';
        for (let line of terminalLogs) {
            const div = document.createElement('div');
            div.className = 'terminal-line';
            div.textContent = "> " + line;
            screens.terminal.appendChild(div);
            screens.terminal.scrollTop = screens.terminal.scrollHeight;
            await delay(300);
        }
        await delay(1500);
        screens.terminal.style.display = 'none';
        runPorygonSequence();
    }
    
    // S√©quence Porygon
    async function runPorygonSequence() {
        screens.porygon.style.display = 'flex';
        screens.porygon.style.opacity = 0;
        let op = 0;
        const fadeIn = setInterval(() => {
            if(op >= 1) clearInterval(fadeIn);
            screens.porygon.style.opacity = op;
            op += 0.05;
        }, 50);
        await delay(1000);
        for (let i = 0; i < scriptPorygon.length; i++) {
            await typeText(els.porygonText, scriptPorygon[i], 30, null);
            if (i === scriptPorygon.length - 1) {
                els.inputContainer.style.display = 'block';
                // ‚úÖ CORRECTION : Attacher l'√©v√©nement keypress au champ de login
                if (els.usernameInput) {
                    els.usernameInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            window.finishIntroSequence();
                        }
                    });
                }
                // Focus uniquement sur desktop pour √©viter clavier virtuel mobile intrusif
                if (window.innerWidth > 600) els.usernameInput.focus();
            } else {
                await delay(1500);
            }
        }
    }
    
    // D√©marrer la s√©quence
    runChenSequence();
};

// Fonction pour terminer l'intro et sauvegarder le nom (VERSION INTRA-DI√âG√âTIQUE)
// --- NOUVELLE FONCTION DE SECOURS ---
// Affiche le bouton "Lancer" par-dessus tout le reste, quoi qu'il arrive.
window.forceShowInitButton = function() {
    console.log('üö® Ex√©cution de forceShowInitButton');
    
    // Nettoyage pr√©ventif
    const oldBtn = document.getElementById('force-init-btn');
    if (oldBtn) oldBtn.remove();

    const btn = document.createElement('button');
    btn.id = 'force-init-btn';
    btn.innerHTML = 'LANCER L\'AVENTURE <span style="font-size:1.2em">‚û§</span>';
    
    // Styles agressifs "Brute Force" pour garantir la visibilit√©
    btn.style.cssText = `
        position: fixed !important;
        bottom: 100px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        z-index: 2147483647 !important; /* Maximum possible */
        padding: 20px 40px !important;
        font-family: sans-serif !important;
        font-size: 20px !important;
        font-weight: bold !important;
        color: white !important;
        background: linear-gradient(135deg, #7d5fff, #20d5d2) !important;
        border: 3px solid white !important;
        border-radius: 50px !important;
        box-shadow: 0 0 30px rgba(125, 95, 255, 0.8) !important;
        cursor: pointer !important;
        display: block !important;
        opacity: 1 !important;
        pointer-events: auto !important;
        animation: pulse-btn 2s infinite !important;
    `;

    // Ajouter l'animation CSS si elle n'existe pas
    if (!document.getElementById('pulse-btn-style')) {
        const style = document.createElement('style');
        style.id = 'pulse-btn-style';
        style.innerHTML = `@keyframes pulse-btn { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } 100% { transform: translateX(-50%) scale(1); } }`;
        document.head.appendChild(style);
    }

    // Action au clic
    btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        btn.innerHTML = 'CHARGEMENT...';
        btn.style.opacity = '0.7';
        
        try {
            // 1. Sauvegarder l'√©tat (si possible)
            if (typeof gameState !== 'undefined') {
                gameState.introSeen = true;
                if (gameState.customization) gameState.customization.nameModalSeen = true;
            }
            if (typeof saveGame === 'function') saveGame();

            // 2. Masquer l'√©cran d'intro
            const gbScreen = document.getElementById('game-boy-screen');
            if (gbScreen) gbScreen.style.display = 'none';

            // 3. R√©afficher l'interface du jeu
            document.querySelectorAll('.top-bar, .bottom-nav, .new-bottom-nav').forEach(el => el.style.display = 'flex');

            // 4. Appliquer le glitch initial (ambiance)
            document.body.classList.add('system-critical');
            if (typeof gameState !== 'undefined' && gameState.system) {
                gameState.system.glitchLevel = 1.0;
            }

            // 5. Aller √† la page de capture
            if (typeof switchPage === 'function') switchPage('capture');
            
            // 6. Valider l'√©tape du tutoriel
            if (typeof completeStep === 'function') completeStep('name');
            
            // 7. Afficher le message "Signal acquis" directement apr√®s l'intro
            setTimeout(() => {
                console.log('[Intro] Tentative d\'affichage du message Signal acquis');
                if (typeof triggerNarrative === 'function' && typeof gameState !== 'undefined') {
                    if (!gameState.system) gameState.system = {};
                    if (!gameState.system.narrativeFlags) gameState.system.narrativeFlags = [];
                    // V√©rifier qu'on ne l'a pas d√©j√† affich√© apr√®s l'intro
                    if (!gameState.system.narrativeFlags.includes('first_capture_success_shown_after_intro')) {
                        console.log('[Intro] Affichage du message Signal acquis');
                        gameState.system.narrativeFlags.push('first_capture_success_shown_after_intro');
                        // Forcer l'affichage m√™me si le dialogue a d√©j√† √©t√© jou√© (apr√®s une capture par exemple)
                        triggerNarrative('first_capture_success', true);
                    } else {
                        console.log('[Intro] Message Signal acquis d√©j√† affich√©');
                    }
                } else {
                    console.error('[Intro] triggerNarrative ou gameState non disponible');
                }
            }, 2500);

        } catch (err) {
            console.error('Erreur critique au lancement:', err);
            // En dernier recours, recharger la page pour forcer le passage si sauvegard√©
            alert('Lancement...');
            window.location.reload();
        }
        
        btn.remove();
    };

    // Attacher directement au BODY pour √©viter d'√™tre cach√© par un parent
    document.body.appendChild(btn);
};

// --- FONCTION PRINCIPALE CORRIG√âE ---
window.finishIntroSequence = async function() {
    console.log('‚ñ∂Ô∏è finishIntroSequence d√©marr√©e');
    
    const usernameInput = document.getElementById('username');
    const inputContainer = document.getElementById('input-container');
    const porygonText = document.getElementById('porygon-text');
    
    // Validation de s√©curit√©
    if (!usernameInput) {
        console.error('Input introuvable, for√ßage du bouton...');
        window.forceShowInitButton();
        return;
    }
    
    const name = usernameInput.value.trim();
    if (!name) {
        if(porygonText) {
            porygonText.textContent = 'ERREUR : Identifiant requis.';
            porygonText.style.color = '#ff0055';
        }
        return;
    }

    // Cacher l'input pour √©viter les doubles clics
    if(inputContainer) inputContainer.style.display = 'none';

    // Sauvegarder le nom (Avec protection Try/Catch pour ne pas planter ici)
    try {
        if (!gameState.customization) gameState.customization = {};
        gameState.customization.trainerName = name;
        gameState.customization.nameModalSeen = true;
        
        // Ces fonctions peuvent planter si le DOM n'est pas pr√™t, on les prot√®ge
        if (typeof updateProfileDisplay === 'function') updateProfileDisplay();
        if (typeof updateTopBarDisplay === 'function') updateTopBarDisplay();
    } catch (e) {
        console.warn('Erreur non-bloquante lors de la sauvegarde du nom:', e);
    }

    // S√©quence de texte finale
    if (porygonText) {
        const messages = [
            `Identit√© confirm√©e : Archiviste ${name}.`,
            'Acc√®s syst√®me : ACCORD√â.',
            'Initialisation des protocoles...',
            'Connexion s√©curis√©e √©tablie.'
        ];

        for (const msg of messages) {
            porygonText.textContent = msg;
            porygonText.style.color = '#e0e0e0';
            await new Promise(r => setTimeout(r, 800));
        }
    }

    // üî• AFFICHER LE BOUTON QUOI QU'IL ARRIVE üî•
    window.forceShowInitButton();
};

// Ajouter la gestion de la touche Entr√©e pour le champ de login
if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', function() {
        const usernameInput = document.getElementById('username');
        if (usernameInput) {
            usernameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    window.finishIntroSequence();
                }
            });
        }
    });
}

// Fonction d√©sactiv√©e - les dialogues sont maintenant dans startGlitchIntro()
function playIntroBootModal() {
    // Cette fonction n'est plus utilis√©e - les dialogues sont int√©gr√©s dans startGlitchIntro()
    // Conserv√©e pour compatibilit√© mais ne fait rien
    return;
}

// POLISHING : Fonction pour cacher les boutons de navigation selon les modules
function updateNavigationVisibility() {
    // Initialiser les modules si absents
    if (!gameState.modules) {
        gameState.modules = {
            fishing: { id: 'fishing', condition: 'level_2', unlocked: false },
            research: { id: 'research', condition: 'level_5', unlocked: false },
            poker: { id: 'poker', condition: 'level_12', unlocked: false },
            rogue: { id: 'rogue', condition: 'level_20_and_johto', unlocked: false },
            blindbox: { id: 'blindbox', condition: 'level_8', unlocked: false },
            tcg: { id: 'tcg', condition: 'level_25', unlocked: false },
            quests: { id: 'quests', condition: 'level_3', unlocked: false }
        };
    }
    
    // Initialiser le module qu√™tes s'il est absent
    if (!gameState.modules.quests) {
        gameState.modules.quests = {
            id: 'quests',
            condition: 'level_3',
            unlocked: gameState.level >= 3
        };
    }
    
    // Mapping des modules vers les boutons de navigation avec leurs niveaux de d√©blocage
    const moduleToNav = {
        'blindbox': { btnId: 'nav-btn-home', level: 4 },
        'rogue': { btnId: 'nav-btn-expedition', level: 12 },
        'poker': { btnId: 'nav-btn-poker', level: 10 }
    };
    
    // Fonction pour obtenir le niveau requis depuis la condition
    function getRequiredLevel(module) {
        if (!module || !module.condition) return 999;
        if (typeof module.condition === 'number') return module.condition;
        if (module.condition.startsWith('level_')) {
            return parseInt(module.condition.replace('level_', '')) || 999;
        }
        return 999;
    }
    
    // Masquer les boutons des modules non d√©bloqu√©s avec style narratif
    Object.entries(moduleToNav).forEach(([moduleId, config]) => {
        const module = gameState.modules[moduleId];
        const btn = document.getElementById(config.btnId);
        
        if (btn) {
            if (!module || !module.unlocked) {
                const requiredLevel = config.level || getRequiredLevel(module);
                
                // Style narratif : perte de m√©moire, cache avec processeurs/√©l√©ments √©lectriques
                btn.style.position = 'relative';
                btn.style.opacity = '0.3';
                btn.style.filter = 'grayscale(100%) blur(2px)';
                btn.style.pointerEvents = 'none';
                btn.style.cursor = 'not-allowed';
                
                // Ajouter un overlay narratif
                let overlay = btn.querySelector('.module-locked-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'module-locked-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        border-radius: 12px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        z-index: 10;
                        backdrop-filter: blur(5px);
                    `;
                    btn.appendChild(overlay);
                }
                
                // Ic√¥ne de processeur/√©lectricit√© + cadenas avec niveau
                overlay.innerHTML = `
                    <div style="font-size: 1.5em; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.5));">‚ö°</div>
                    <div style="font-size: 1.2em; margin-bottom: 3px;">üîí</div>
                    <div style="font-size: 0.7em; color: rgba(255, 255, 255, 0.8); font-family: var(--font-family-pixel); text-align: center;">
                        LVL ${requiredLevel}
                    </div>
                    <div style="font-size: 0.6em; color: rgba(255, 255, 255, 0.6); margin-top: 2px; text-align: center; font-family: var(--font-family-pixel);">
                        M√âMOIRE CORROMPUE
                    </div>
                `;
            } else {
                // Afficher le bouton normalement
                btn.style.opacity = '1';
                btn.style.filter = 'none';
                btn.style.pointerEvents = 'auto';
                btn.style.cursor = 'pointer';
                
                // Supprimer l'overlay si pr√©sent
                const overlay = btn.querySelector('.module-locked-overlay');
                if (overlay) overlay.remove();
            }
        }
    });
}
function showLevelUpPopup(level,rewards){if(window.FX){FX.confetti(window.innerWidth/2,window.innerHeight/2,80);FX.coins(Math.min(rewards.coins/100,30));FX.screenShake();}const overlay=document.createElement('div');overlay.id='level-up-overlay';overlay.style.cssText='position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 99999; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;';const popup=document.createElement('div');popup.id='level-up-popup';popup.className='premium-bounce';popup.style.cssText='background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; max-width: 400px; width: 90%; text-align: center; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.5);';const rewardsHTML=Object.entries(rewards.items||{}).map(([id,qty],idx)=>{const item=ALL_ITEMS[id];if(!item)return'';return`<div class="reward-item elegant-fade-in" style="animation: rewardPop 0.4s ease ${idx*0.1}s both; background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; margin: 8px;"><div style="font-size: 2.5em; margin-bottom: 8px; display: flex; justify-content: center; align-items: center;">${getItemIconDisplay(id, '2.5em')}</div><div style="color: white; font-weight: bold; font-size: 0.9em; margin-bottom: 4px;">${item.name}</div><div style="color: #FFD700; font-size: 1.1em; font-weight: bold;">√ó${qty}</div></div>`;}).join('');popup.innerHTML=`<div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #FFD700, #FFA500); padding: 8px 20px; border-radius: 20px; font-weight: bold; color: #000; font-size: 0.9em; box-shadow: 0 4px 15px rgba(255,215,0,0.5); animation: premiumPulse 2s ease-in-out infinite;">üéâ LEVEL UP ! üéâ</div><div style="margin-top: 30px; margin-bottom: 20px;"><div style="font-size: 4em; font-weight: bold; color: white; text-shadow: 0 0 20px rgba(255,255,255,0.5); animation: premiumPulse 2s ease-in-out infinite;">LVL ${level}</div></div><div style="margin-bottom: 20px;"><div style="color: #FFD700; font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">üí∞ +${rewards.coins} coins</div></div>${rewardsHTML?`<div style="margin-bottom: 20px;"><div style="color: white; font-weight: bold; margin-bottom: 10px; font-size: 1.1em;">R√©compenses :</div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; justify-items: center;">${rewardsHTML}</div></div>`:''}<button onclick="hideLevelUpPopup()" class="btn btn--primary" style="padding: 12px 30px; font-size: 1.1em; font-weight: bold; margin-top: 10px;">Continuer</button>`;overlay.appendChild(popup);document.body.appendChild(overlay);gameState.coins+=rewards.coins;gameState.totalCoinsEarned+=rewards.coins;for(const[itemId,qty]of Object.entries(rewards.items||{})){if(itemId==='mystery_egg'){if(!gameState.inventory.eggs)gameState.inventory.eggs=[];for(let i=0;i<qty;i++){gameState.inventory.eggs.push({id:'mystery_egg',state:'locked',progress:0});}if(gameState.mysteryEggProgress===undefined)gameState.mysteryEggProgress=0;}else{gameState.inventory[itemId]=(gameState.inventory[itemId]||0)+qty;}}saveGame();updateUI();overlay.addEventListener('click',(e)=>{if(e.target===overlay)hideLevelUpPopup();});}
window.hideLevelUpPopup=function(){const overlay=document.getElementById('level-up-overlay');if(overlay){overlay.style.animation='fadeOut 0.3s ease';setTimeout(()=>{overlay.remove();processPendingLevelUps();},300);}}

function updateUIFishing(){const fishingZone=document.getElementById('fishing-zone');const fishingBtn=document.getElementById('fishing-btn');if(!fishingZone)return;if(gameState.level<2){fishingZone.classList.add('fishing-locked');if(fishingBtn){fishingBtn.disabled=true;fishingBtn.style.opacity='0.5';fishingBtn.style.filter='grayscale(1)';fishingBtn.style.pointerEvents='none';}}else{fishingZone.classList.remove('fishing-locked');if(fishingBtn){fishingBtn.disabled=false;fishingBtn.style.opacity='1';fishingBtn.style.filter='none';fishingBtn.style.pointerEvents='auto';}}}

// Fonction pour mettre √† jour la jauge de Stabilit√© Syst√®me (Niveaux 1-2)
function updateSystemStabilityDisplay() {
    const stabilityDisplay = document.getElementById('system-stability-display');
    const stabilityBar = document.getElementById('stability-bar-fill');
    const stabilityText = document.getElementById('stability-text');
    
    if (!stabilityDisplay || !stabilityBar || !stabilityText) return;
    
    // Afficher uniquement pour les niveaux 1-2
    if (gameState.level <= 2) {
        stabilityDisplay.style.display = 'flex';
        
        // Calculer la stabilit√© bas√©e sur le nombre de captures
        // Objectif : 5 captures pour d√©bloquer la P√™che (niveau 2)
        const targetCaptures = 5;
        const currentCaptures = gameState.totalCaught || 0;
        const stabilityPercent = Math.min((currentCaptures / targetCaptures) * 100, 100);
        const previousCaptures = gameState.previousStabilityCaptures || 0;
        
        // Mettre √† jour la barre
        stabilityBar.style.width = `${stabilityPercent}%`;
        
        // Mettre √† jour le texte avec un message contextuel
        if (currentCaptures === 0) {
            stabilityText.textContent = '0% - D√©marrage...';
        } else if (currentCaptures < targetCaptures) {
            const remaining = targetCaptures - currentCaptures;
            stabilityText.textContent = `${Math.round(stabilityPercent)}% - ${remaining} capture${remaining > 1 ? 's' : ''} restante${remaining > 1 ? 's' : ''}`;
        } else {
            stabilityText.textContent = '100% - Syst√®me stable';
        }
        
        // Changer la couleur selon la progression
        if (stabilityPercent < 33) {
            stabilityBar.style.background = 'linear-gradient(90deg, #ef4444, #f59e0b)';
        } else if (stabilityPercent < 66) {
            stabilityBar.style.background = 'linear-gradient(90deg, #f59e0b, #eab308)';
        } else {
            stabilityBar.style.background = 'linear-gradient(90deg, #eab308, #10b981)';
        }
        
        // D√©clencher un √©v√©nement quand la barre atteint 100% (5 captures)
        if (currentCaptures >= targetCaptures && previousCaptures < targetCaptures) {
            // La barre vient d'atteindre 100%
            if (!gameState.system) gameState.system = {};
            if (!gameState.system.narrativeFlags) gameState.system.narrativeFlags = [];
            
            // D√©clencher le message de stabilisation si pas d√©j√† fait
            if (!gameState.system.narrativeFlags.includes('system_stabilizing_5_shown')) {
                gameState.system.narrativeFlags.push('system_stabilizing_5_shown');
                setTimeout(() => {
                    if (typeof triggerNarrative === 'function') {
                        triggerNarrative('system_stabilizing');
                    }
                }, 1500);
            }
            
            // Mise √† jour visuelle du syst√®me (retirer le glitch)
            if (typeof updateSystemVisualState === 'function') {
                updateSystemVisualState();
            }
        }
        
        // Sauvegarder le nombre actuel pour la prochaine v√©rification
        gameState.previousStabilityCaptures = currentCaptures;
    } else {
        // Masquer pour les niveaux sup√©rieurs
        stabilityDisplay.style.display = 'none';
    }
}

// Fonction pour masquer/afficher l'item Qu√™tes dans le Hub selon le niveau
function updateQuestsVisibility() {
    // Initialiser le module qu√™tes si absent
    if (!gameState.modules) gameState.modules = {};
    if (!gameState.modules.quests) {
        gameState.modules.quests = {
            id: 'quests',
            condition: 'level_3',
            unlocked: gameState.level >= 3
        };
    }
    
    const questsItem = document.querySelector('.hub-item.quests');
    if (!questsItem) return;
    
    const isUnlocked = gameState.modules.quests.unlocked || gameState.level >= 3;
    
    if (!isUnlocked) {
        // Masquer avec style narratif (perte de m√©moire)
        questsItem.style.position = 'relative';
        questsItem.style.opacity = '0.3';
        questsItem.style.filter = 'grayscale(100%) blur(2px)';
        questsItem.style.pointerEvents = 'none';
        questsItem.style.cursor = 'not-allowed';
        
        // Ajouter un overlay narratif
        let overlay = questsItem.querySelector('.quests-locked-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'quests-locked-overlay';
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 16px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10;
                backdrop-filter: blur(5px);
            `;
            questsItem.appendChild(overlay);
        }
        
        // Ic√¥ne de processeur/√©lectricit√© + cadenas avec niveau
        overlay.innerHTML = `
            <div style="font-size: 1.5em; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.5));">‚ö°</div>
            <div style="font-size: 1.2em; margin-bottom: 3px;">üîí</div>
            <div style="font-size: 0.7em; color: rgba(255, 255, 255, 0.8); font-family: var(--font-family-pixel); text-align: center;">
                LVL 3
            </div>
            <div style="font-size: 0.6em; color: rgba(255, 255, 255, 0.6); margin-top: 2px; text-align: center; font-family: var(--font-family-pixel);">
                M√âMOIRE CORROMPUE
            </div>
        `;
    } else {
        // Afficher normalement
        questsItem.style.opacity = '1';
        questsItem.style.filter = 'none';
        questsItem.style.pointerEvents = 'auto';
        questsItem.style.cursor = 'pointer';
        
        // Supprimer l'overlay si pr√©sent
        const overlay = questsItem.querySelector('.quests-locked-overlay');
        if (overlay) overlay.remove();
        
        // Ajouter une notification "Nouveau !" si c'est la premi√®re fois qu'on d√©bloque
        if (!gameState.system.narrativeFlags.includes('quests_unlocked_shown')) {
            gameState.system.narrativeFlags.push('quests_unlocked_shown');
            const notifBadge = document.getElementById('hub-notif-quests');
            if (notifBadge) {
                notifBadge.style.display = 'block';
                notifBadge.style.background = '#10b981';
                notifBadge.style.width = '24px';
                notifBadge.style.height = '24px';
                notifBadge.style.fontSize = '0.8em';
                notifBadge.textContent = 'N';
                // Animation pulse pour attirer l'attention
                notifBadge.style.animation = 'pulse 1.5s ease-in-out infinite';
            }
        }
    }
}

function updateQuestProgress(type,value){if(type==='captures'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='captures')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}gameState.questsProgress.special['special_mystery_egg']=(gameState.questsProgress.special['special_mystery_egg']||0)+value;gameState.questsProgress.special['special_complete_kanto']=gameState.captured.size;gameState.questsProgress.permanent['perm_hundred_captures']=gameState.totalCaught;gameState.questsProgress.permanent['perm_thousand_captures']=gameState.totalCaught;if(!gameState.mysteryEggProgress)gameState.mysteryEggProgress=0;gameState.mysteryEggProgress+=value;if(gameState.inventory.eggs){gameState.inventory.eggs.forEach(egg=>{if(egg.id==='mystery_egg'&&egg.state==='locked'){egg.progress=(egg.progress||0)+value;if(egg.progress>=50){egg.state='ready';}}})}}if(type==='shinies'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='shinies')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}gameState.questsProgress.special['special_10_shinies']=gameState.shinies.size;}if(type==='legendaries'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='legendaries')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}gameState.questsProgress.special['special_3_legendaries']=(gameState.questsProgress.special['special_3_legendaries']||0)+value;gameState.questsProgress.permanent['perm_legendary_5']=(gameState.questsProgress.permanent['perm_legendary_5']||0)+value;}if(type==='flees'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='flees')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}}if(type==='fished'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='fished')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}}if(type==='coins'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='coins')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}}if(type==='streak'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='streak')gameState.questsProgress.daily[quest.id]=Math.max(gameState.questsProgress.daily[quest.id]||0,value);}gameState.questsProgress.permanent['perm_streak_50']=Math.max(gameState.questsProgress.permanent['perm_streak_50']||0,value);}if(type==='rare_captures'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='rare_captures')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}}if(type.startsWith('type_master_')){const maxTypeCount=Math.max(...Object.values(gameState.typeCaptureCounts||{}),0);gameState.questsProgress.permanent['perm_type_master']=maxTypeCount;}if(type.startsWith('regional_')){const region=type.replace('regional_','');const maxRegionCount=Math.max(...Object.values(gameState.regionProgress||{}).map(r=>r.captured||0),0);gameState.questsProgress.permanent['perm_regional_collection']=maxRegionCount;}if(type==='shop_purchases'){gameState.questsProgress.permanent['perm_lucky_merchant']=value;}if(type==='login_streak'){gameState.questsProgress.permanent['perm_perfect_routine']=value;}if(type==='blindbox_opened'){gameState.questsProgress.permanent['perm_hidden_treasure']=value;}if(type==='rogue_completed'){for(const quest of QUESTS_DATA.daily){if(quest.trackType==='rogue_completed')gameState.questsProgress.daily[quest.id]=(gameState.questsProgress.daily[quest.id]||0)+value;}gameState.questsProgress.permanent['perm_rogue_master']=(gameState.questsProgress.permanent['perm_rogue_master']||0)+value;}if(type==='rogue_full_clear'){gameState.questsProgress.special['special_rogue_10']=(gameState.questsProgress.special['special_rogue_10']||0)+value;}checkQuestNotifications();}

function checkQuestNotifications() {
    let hasNewCompletions = false;
    for (const questType of ['daily', 'special', 'permanent']) {
        const questsArray = QUESTS_DATA[questType];
        for (const quest of questsArray) {
            const progress = gameState.questsProgress[questType][quest.id] || 0;
            // Si qu√™te termin√©e mais pas encore r√©clam√©e
            if (progress >= quest.target && !gameState.claimedQuests[questType].has(quest.id)) {
                hasNewCompletions = true;
                break;
            }
        }
        if (hasNewCompletions) break;
    }
    
    // Cible le nouveau badge dans le Hub
    const hubBadge = document.getElementById('hub-notif-quests');
    // Cible aussi le badge de la barre de nav si tu l'as laiss√© (optionnel)
    const oldBadge = document.getElementById('quest-notif-badge');

    if (hubBadge) hubBadge.style.display = hasNewCompletions ? 'block' : 'none';
    if (oldBadge) oldBadge.style.display = hasNewCompletions ? 'flex' : 'none';
}

// ===== PART 2: CAPTURE & P√äCHE & POK√âDEX =====

window.spawnPokemon=function(){if(captureCooldown){const remaining=Math.ceil((captureCooldown-Date.now())/1000);showToast(`Attendez ${remaining}s avant de respawn`,'error');return;}currentPokemon=selectPokemon('spawn',false);usingFramby=false;usingPinap=false;usingCeriz=false;const encounterDiv=document.getElementById('encounter');if(!encounterDiv)return;init3DPokeball('encounter','Un Pok√©mon appara√Æt...');setTimeout(()=>revealPokemon(),800);
    // ===== D√âCLENCHEUR D'OMBRE DE GLITCH =====
    setTimeout(() => {
        if (typeof triggerGlitchShadow === 'function') {
            triggerGlitchShadow();
        }
    }, 1000);
};

function revealPokemon(){const encounterDiv=document.getElementById('encounter');if(!encounterDiv||!currentPokemon)return;const isNew=!gameState.captured.has(currentPokemon.id);const statusBadge=isNew?'<div style="background: #10b981; color: white; padding: 5px 15px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 0.9em;">‚ú® NOUVEAU!</div>':'<div style="background: #f59e0b; color: white; padding: 5px 15px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 0.9em;">üìñ Doublon</div>';let berriesHTML='';if(gameState.inventory.framby>0)berriesHTML+=`<div style="margin-bottom: 10px;"><label style="color: white; cursor: pointer; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px; display: inline-block;"><input type="checkbox" onchange="usingFramby = this.checked; revealPokemon();" ${usingFramby?'checked':''} style="margin-right: 8px;">${getItemIconDisplay('framby','1.2em')} Baie Framby (+50%) [${gameState.inventory.framby}]</label></div>`;if(gameState.inventory.pinap>0)berriesHTML+=`<div style="margin-bottom: 10px;"><label style="color: white; cursor: pointer; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px; display: inline-block;"><input type="checkbox" onchange="usingPinap = this.checked; revealPokemon();" ${usingPinap?'checked':''} style="margin-right: 8px;">${getItemIconDisplay('pinap','1.2em')} Baie Pinap (√ó2 coins) [${gameState.inventory.pinap}]</label></div>`;if(gameState.inventory.ceriz>0&&currentPokemon.isShiny)berriesHTML+=`<div style="margin-bottom: 10px;"><label style="color: #FFD700; cursor: pointer; background: rgba(255, 215, 0, 0.2); padding: 10px 20px; border-radius: 10px; display: inline-block;"><input type="checkbox" onchange="usingCeriz = this.checked; revealPokemon();" ${usingCeriz?'checked':''} style="margin-right: 8px;">${getItemIconDisplay('ceriz','1.2em')} Baie Ceriz (100% SHINY!) [${gameState.inventory.ceriz}]</label></div>`;encounterDiv.innerHTML=`<div style="text-align: center; padding: 30px; background: linear-gradient(180deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)); border-radius: 15px;">${statusBadge}<div style="font-size: 1.3em; font-weight: bold; margin-bottom: 15px; color: white;">${currentPokemon.rarity==='legendary'?'‚ö° POK√âMON L√âGENDAIRE ‚ö°':currentPokemon.rarity==='super_rare'?'üíé SUPER RARE üíé':currentPokemon.rarity==='rare'?'‚≠ê RARE ‚≠ê':currentPokemon.rarity==='uncommon'?'üîµ PEU COMMUN üîµ':'‚ö™ COMMUN ‚ö™'}</div><div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 15px;"><img src="${getAnimatedSpriteUrl(currentPokemon.id, currentPokemon.isShiny)}" style="width: 150px; height: 150px; min-width: 150px; min-height: 150px; max-width: 150px; max-height: 150px; image-rendering: pixelated; ${currentPokemon.isShiny?'filter: drop-shadow(0 0 20px #FFD700);':''}; object-fit: contain; object-position: center; display: block; margin: 0 auto;" alt="${currentPokemon.name}"></div><div style="font-size: 1.5em; font-weight: bold; margin: 10px 0; color: ${currentPokemon.isShiny?'#FFD700':'white'};"> ${currentPokemon.isShiny?'‚ú® ':''}${currentPokemon.name}${currentPokemon.isShiny?' ‚ú®':''}</div><div style="font-size: 0.9em; color: rgba(255,255,255,0.7); margin-bottom: 20px;">#${currentPokemon.id.toString().padStart(3,'0')} ‚Ä¢ ${POKEMON_TYPES[currentPokemon.id]?.join(' / ')||'Normal'}</div>${berriesHTML}<div id="ball-selector" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">${gameState.inventory.pokeball>0?`<button onclick="startCaptureMinigame('pokeball')" style="background: linear-gradient(135deg, #ef4444, #f97316); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('pokeball','1.2em')} Pok√© Ball (${gameState.inventory.pokeball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('pokeball',currentPokemon.rarity,usingFramby)*100)}%</span></button>`:''}${gameState.inventory.greatball>0?`<button onclick="startCaptureMinigame('greatball')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('greatball','1.2em')} Super Ball (${gameState.inventory.greatball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('greatball',currentPokemon.rarity,usingFramby)*100)}%</span></button>`:''}${gameState.inventory.ultraball>0?`<button onclick="startCaptureMinigame('ultraball')" style="background: linear-gradient(135deg, #eab308, #f59e0b); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('ultraball','1.2em')} Hyper Ball (${gameState.inventory.ultraball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('ultraball',currentPokemon.rarity,usingFramby)*100)}%</span></button>`:''}${gameState.inventory.masterball>0?`<button onclick="startCaptureMinigame('masterball')" style="background: linear-gradient(135deg, #9333ea, #ec4899); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('masterball','1.2em')} Master Ball (${gameState.inventory.masterball})<br><span style="font-size: 0.8em;">100%</span></button>`:''}${gameState.inventory.diveball>0?`<button onclick="startCaptureMinigame('diveball')" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('diveball','1.2em')} Scuba Ball (${gameState.inventory.diveball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('diveball',currentPokemon.rarity,usingFramby)*100)}%</span></button>`:''}</div><button onclick="fleePokemon()" class="btn btn--outline" style="padding: 10px 20px; font-size: 1em; background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444;">üèÉ Fuir</button></div>`;captureCooldown=Date.now()+3000;updateCooldownDisplay();}

// ===== ARCHITECTURE V7.0 GENESIS - SYST√àME DE FUITE BINAIRE =====
/**
 * Logique centrale de r√©solution de capture (V7.0)
 * Syst√®me binaire : √âchec = Fuite imm√©diate (pas de tentatives multiples)
 * @param {string} ballType - 'pokeball', 'greatball', etc.
 * @param {number} skillBonus - Bonus du skill shot (1.0 √† 1.25)
 * @returns {object} R√©sultat { success: boolean, reason: string, status: 'success'|'retry'|'flee' }
 */
window.attemptCapture = function(ballType, skillBonus = 1.0) {
    if (!currentPokemon) return;
    
    // V√©rification des ressources
    if (gameState.inventory[ballType] <= 0) {
        if (!gameState.system.narrativeFlags.includes('guide_no_balls_shown')) {
            gameState.system.narrativeFlags.push('guide_no_balls_shown');
            setTimeout(() => triggerNarrative('guide_no_balls'), 500);
        }
        const message = window.NARRATIVE_DB?.EVENTS?.FLEE?.[0] || 'Ressources insuffisantes!';
        showToast(message, 'error');
        return;
    }
    
    const pokemonToCapture = currentPokemon;
    
    // ===== CONSOMMATION IMM√âDIATE DES RESSOURCES =====
    gameState.inventory[ballType]--;
    if (usingFramby && gameState.inventory.framby > 0) gameState.inventory.framby--;
    if (usingPinap && gameState.inventory.pinap > 0) gameState.inventory.pinap--;
    if (usingCeriz && gameState.inventory.ceriz > 0) gameState.inventory.ceriz--;
    
    gameState.totalCaptureAttempts++;
    
    // ===== CALCUL DE PROBABILIT√â (P) =====
    // Taux de base selon la raret√©
    const BASE_RATES = {
        common: 0.70,
        uncommon: 0.50,
        rare: 0.30,
        super_rare: 0.15,
        legendary: 0.05
    };
    
    let baseRate = BASE_RATES[pokemonToCapture.rarity] || 0.5;
    
    // Multiplicateurs de Balls
    const BALL_MULTIPLIERS = {
        pokeball: 1.0,
        greatball: 1.5,
        ultraball: 2.0,
        masterball: 1000.0, // Garantit P >= 1.0
        diveball: 1.5
    };
    
    const ballMult = BALL_MULTIPLIERS[ballType] || 1.0;
    
    // Multiplicateurs de Baies
    const berryMult = usingFramby ? 1.5 : 1.0;
    
    // Bonus Buddy
    const buddyId = gameState.buddy?.activeBuddyId;
    const buddy = buddyId ? gameState.buddy.buddies[buddyId] : null;
    const buddyBonus = (buddy && (buddy.level || 1) >= 8) ? 1.10 : 1.0;
    
    // Calcul final
    let finalProbability = baseRate * ballMult * berryMult * buddyBonus * skillBonus;
    finalProbability = Math.min(finalProbability, 1.0); // Plafonn√© √† 100%
    
    // Masterball ou Probabilit√© >= 100%
    if (ballType === 'masterball' || finalProbability >= 1.0) {
        handleCaptureSuccess(pokemonToCapture, ballType, skillBonus);
        return { success: true, method: 'guaranteed' };
    }
    
    // ===== TIRAGE AL√âATOIRE (R) =====
    const roll = Math.random();
    console.log(`[GENESIS Capture] Proba: ${(finalProbability * 100).toFixed(1)}%, Roll: ${(roll * 100).toFixed(1)}%`);
    
    // ===== R√âSOLUTION BINAIRE =====
    if (roll <= finalProbability) {
        // SUCC√àS
        handleCaptureSuccess(pokemonToCapture, ballType, skillBonus);
        return { success: true, method: 'luck' };
    } else {
        // √âCHEC CRITIQUE - V√©rification des Safety Nets
        
        // Safety Net 1: Baie Ceriz
        if (usingCeriz) {
            const message = window.NARRATIVE_DB?.SAFETY_NETS?.CERIZ_BERRY || 'La Baie Ceriz retient le Pok√©mon!';
            showToast(message, 'info');
            // Le joueur a le droit √† un nouveau tour (pas de fuite)
            return { success: false, status: 'retry', message: message };
        }
        
        // Safety Net 2: Buddy Protector
        if (checkBuddyProtector && typeof checkBuddyProtector === 'function') {
            if (checkBuddyProtector()) {
                if (typeof consumeBuddyProtector === 'function') {
                    consumeBuddyProtector();
                }
                const message = window.NARRATIVE_DB?.SAFETY_NETS?.BUDDY_PROTECTOR || 'Votre Buddy emp√™che la fuite!';
                showToast(message, 'info');
                return { success: false, status: 'retry', message: message };
            }
        }
        
        // Pas de filet de s√©curit√© -> FUITE IMM√âDIATE
        handleCaptureFlee(pokemonToCapture);
        return { success: false, status: 'flee', message: 'Le Pok√©mon s\'est enfui!' };
    }
};

/**
 * G√®re le succ√®s de capture
 */
function handleCaptureSuccess(pokemon, ballType, skillBonus) {
    gameState.totalSuccessfulCaptures++;
    const wasDuplicate = isDuplicate(pokemon.id, pokemon.isShiny);
    
    // Dialogues narratifs
    if (!wasDuplicate && gameState.totalCaught === 1 && !gameState.system.narrativeFlags.includes('guide_first_capture_shown')) {
        gameState.system.narrativeFlags.push('guide_first_capture_shown');
        setTimeout(() => triggerNarrative('guide_first_capture'), 1500);
    }
    
    // Ajout √† la collection
    addToCollection(pokemon.id, pokemon.isShiny);
    
    // ===== FIX : V√©rifier la progression du glitch apr√®s 5 captures =====
    if (gameState.totalCaught === 5) {
        // Message de stabilisation
        if (!gameState.system.narrativeFlags.includes('system_stabilizing_5_shown')) {
            gameState.system.narrativeFlags.push('system_stabilizing_5_shown');
            setTimeout(() => {
                if (typeof triggerNarrative === 'function') {
                    triggerNarrative('system_stabilizing');
                }
            }, 2000);
        }
        // Mise √† jour visuelle du syst√®me (retirer le glitch)
        if (typeof updateSystemVisualState === 'function') {
            updateSystemVisualState();
        }
    }
    
    // R√©compenses
    let coinsEarned = { common: 120, uncommon: 200, rare: 600, super_rare: 1000, legendary: 3500 }[pokemon.rarity];
    if (usingPinap) coinsEarned *= 2;
    const xpGained = gainXP(pokemon.rarity, wasDuplicate);
    
    gameState.coins += coinsEarned;
    gameState.totalCoinsEarned += coinsEarned;
    gameState.streak++;
    if (gameState.streak > gameState.bestStreak) gameState.bestStreak = gameState.streak;
    
    // Messages narratifs di√©g√©tiques depuis NARRATIVE_DB
    const successMessages = window.NARRATIVE_DB?.EVENTS?.CAPTURE_SUCCESS || ['Signal acquis! Int√©grit√© sauvegard√©e.'];
    const message = successMessages[Math.floor(Math.random() * successMessages.length)];
    
    // ===== FIX : Ajouter √† l'historique de capture =====
    if (!gameState.captureHistory) gameState.captureHistory = [];
    gameState.captureHistory.unshift({
        id: pokemon.id,
        name: pokemon.name,
        isShiny: pokemon.isShiny,
        rarity: pokemon.rarity,
        status: 'captured',
        time: Date.now()
    });
    if (gameState.captureHistory.length > 10) {
        gameState.captureHistory = gameState.captureHistory.slice(0, 10);
    }
    renderCaptureHistory();
    
    if (pokemon.isShiny) {
        const shinyMessages = window.NARRATIVE_DB?.EVENTS?.SHINY_DETECTED || ['‚ö†Ô∏è ALERTE : ANOMALIE D√âTECT√âE. Ce code couleur n\'est pas standard!'];
        const shinyMsg = shinyMessages[Math.floor(Math.random() * shinyMessages.length)];
        showToast(`${shinyMsg}\n${pokemon.name} SHINY\n+${coinsEarned} coins\n+${xpGained} XP`, 'success');
        updateQuestProgress('shinies', 1);
    } else if (pokemon.rarity === 'legendary') {
        showCelebration(`üëë L√âGENDAIRE CAPTUR√â! üëë`, `${pokemon.name}\n${message}\n+${coinsEarned} coins\n+${xpGained} XP`, 'legendary');
        updateQuestProgress('legendaries', 1);
        
        // ===== Dialogue sp√©cial Porygon-Z pour les l√©gendaires =====
        if (!gameState.system.narrativeFlags.includes(`legendary_${pokemon.id}_dialogue_shown`)) {
            gameState.system.narrativeFlags.push(`legendary_${pokemon.id}_dialogue_shown`);
            setTimeout(() => {
                triggerNarrative('legendary_captured');
            }, 2500);
        }
    } else {
        showToast(`${message}\n${pokemon.name}\n+${coinsEarned} coins\n+${xpGained} XP`, 'success');
    }
    
    // ===== Animation : Le sprite rentre dans une Pok√©ball =====
    const encounterDiv = document.getElementById('encounter');
    if (encounterDiv) {
        const pokemonSprite = encounterDiv.querySelector('img[src*="pokemon"]');
        if (pokemonSprite) {
            // Cr√©er une Pok√©ball au centre
            const pokeball = document.createElement('img');
            pokeball.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png`;
            pokeball.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80px;
                height: 80px;
                z-index: 1000;
                image-rendering: pixelated;
                opacity: 0;
                transition: opacity 0.2s;
            `;
            encounterDiv.style.position = 'relative';
            encounterDiv.appendChild(pokeball);
            
            // Animation : le sprite se r√©duit et rentre dans la Pok√©ball
            pokemonSprite.style.transition = 'all 0.5s ease-in-out';
            pokemonSprite.style.transform = 'scale(0) translateY(-50px)';
            pokemonSprite.style.opacity = '0';
            
            // Afficher la Pok√©ball
            setTimeout(() => {
                pokeball.style.opacity = '1';
                pokeball.style.animation = 'pokeballShake 0.3s ease-in-out 3';
            }, 300);
            
            // Nettoyer apr√®s l'animation
            setTimeout(() => {
                pokeball.remove();
            }, 1200);
        }
    }
    
    // Effets visuels
    if (window.FX && encounterDiv) {
        FX.shockwave(encounterDiv);
        if (pokemon.isShiny || pokemon.rarity === 'legendary') {
            FX.confetti(window.innerWidth / 2, window.innerHeight / 2, 100);
            FX.stars(window.innerWidth / 2, window.innerHeight / 2, 30);
            FX.screenShake();
        }
    }
    
    // Nettoyage
    currentPokemon = null;
    usingFramby = false;
    usingPinap = false;
    usingCeriz = false;
    
    updateQuestProgress('captures', 1);
    updateQuestProgress('coins', coinsEarned);
    updateQuestProgress('streak', gameState.streak);
    if (['rare', 'super_rare', 'legendary'].includes(pokemon.rarity)) {
        updateQuestProgress('rare_captures', 1);
    }
    
    // ===== ARCHITECTURE V7.0 GENESIS - Mise √† jour visuelle de Porygon =====
    if (typeof updatePorygonVisuals === 'function') {
        updatePorygonVisuals();
    }
    
    saveGame();
    updateUI();
    setTimeout(() => resetEncounterToIdle(), 2000);
}

// Appeler updatePorygonVisuals au chargement et apr√®s chaque capture
if (typeof updatePorygonVisuals === 'function') {
    // Appel initial
    setTimeout(() => updatePorygonVisuals(), 1000);
    
    // Appel apr√®s chaque capture (d√©j√† dans handleCaptureSuccess)
    // Appel apr√®s level up (√† ajouter dans checkLevelUp si elle existe)
}

/**
 * G√®re la fuite imm√©diate (Syst√®me Binaire)
 */
function handleCaptureFlee(pokemon) {
    // Messages narratifs di√©g√©tiques depuis NARRATIVE_DB
    const fleeMessages = window.NARRATIVE_DB?.EVENTS?.FLEE || ['CONNEXION PERDUE. Le signal s\'est d√©synchronis√©.'];
    const message = fleeMessages[Math.floor(Math.random() * fleeMessages.length)];
    
    // Afficher en toast uniquement (plus de system-log)
    showToast(`${message}\n${pokemon.name}`, 'error');
    
    // ===== FIX : Ajouter √† l'historique de capture =====
    if (!gameState.captureHistory) gameState.captureHistory = [];
    gameState.captureHistory.unshift({
        id: pokemon.id,
        name: pokemon.name,
        isShiny: pokemon.isShiny,
        rarity: pokemon.rarity,
        status: 'fled',
        time: Date.now()
    });
    if (gameState.captureHistory.length > 10) {
        gameState.captureHistory = gameState.captureHistory.slice(0, 10);
    }
    renderCaptureHistory();
    
    // Animation de disparition
    const encounterDiv = document.getElementById('encounter');
    if (encounterDiv) {
        encounterDiv.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
        encounterDiv.style.opacity = '0';
        encounterDiv.style.transform = 'translateX(-100px)';
    }
    
    // ===== FIX CRITIQUE : Nettoyage IMM√âDIAT de currentPokemon =====
    // Le Pok√©mon doit dispara√Ætre imm√©diatement, pas apr√®s l'animation
    currentPokemon = null;
    usingFramby = false;
    usingPinap = false;
    usingCeriz = false;
    
    // Statistiques
    gameState.streak = 0;
    gameState.totalFlees++;
    updateQuestProgress('flees', 1);
    
    saveGame();
    updateUI();
    
    // Retour √† l'idle apr√®s animation (plus court pour r√©activit√©)
    setTimeout(() => {
        if (encounterDiv) {
            encounterDiv.style.transition = '';
            encounterDiv.style.opacity = '';
            encounterDiv.style.transform = '';
        }
        // S'assurer que resetEncounterToIdle est appel√©
        if (typeof resetEncounterToIdle === 'function') {
            resetEncounterToIdle();
        } else {
            // Fallback : r√©initialiser manuellement
            const spawnBtn = document.getElementById('spawn-btn');
            const spawnBtnText = document.getElementById('spawn-btn-text');
            if (spawnBtn) {
                spawnBtn.disabled = false;
                if (spawnBtnText) {
                    spawnBtnText.innerHTML = `${getItemIconDisplay('pokeball','1.2em')} Capturer un Pok√©mon`;
                } else {
                    spawnBtn.innerHTML = `${getItemIconDisplay('pokeball','1.2em')} Capturer un Pok√©mon`;
                }
            }
        }
    }, 300);
}

window.fleePokemon=function(){if(!currentPokemon)return;showToast(`Vous avez fui ${currentPokemon.name}!`,'info');gameState.streak=0;gameState.totalFlees++;updateQuestProgress('flees',1);currentPokemon=null;usingFramby=false;usingPinap=false;usingCeriz=false;setTimeout(()=>resetEncounterToIdle(),1500);saveGame();updateUI();};

function updateCooldownDisplay(){const btn=document.getElementById('spawn-btn');if(!btn)return;const btnText=document.getElementById('spawn-btn-text');if(captureCooldown&&captureCooldown>Date.now()){const remaining=Math.ceil((captureCooldown-Date.now())/1000);btn.disabled=true;if(btnText){btnText.textContent=`Attendez ${remaining}s`;}else{btn.innerHTML=`Attendez ${remaining}s`;}setTimeout(updateCooldownDisplay,1000);}else{btn.disabled=false;if(btnText){btnText.innerHTML=`${getItemIconDisplay('pokeball','1.2em')} Capturer un Pok√©mon`;}else{btn.innerHTML=`${getItemIconDisplay('pokeball','1.2em')} Capturer un Pok√©mon`;}captureCooldown=null;}}

window.startFishing=function(){if(gameState.level<2){showToast('D√©bloquez la p√™che au niveau 2!','error');return;}if(gameState.inventory.fishingTokens<=0){showToast('Vous n\'avez plus de jetons de p√™che!','error');return;}if(!gameState.system.narrativeFlags.includes('guide_fishing_first_shown')){gameState.system.narrativeFlags.push('guide_fishing_first_shown');setTimeout(()=>triggerNarrative('guide_fishing_first'),500);}
// ===== FIX : Scroll vers le haut pour √©viter de perdre le mini-jeu =====
window.scrollTo({top:0,behavior:'smooth'});document.body.style.overflow='hidden';
const fishingModal=document.createElement('div');fishingModal.style.cssText='position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 99999;';fishingModal.innerHTML=`<div style="text-align: center;"><div style="font-size: 8em; animation: fishingRod 2s infinite;" id="fishing-rod">üé£</div><div style="font-size: 1.5em; color: white; margin-top: 20px;" id="fishing-text">Vous lancez la ligne<span id="dots">.</span></div></div>`;document.body.appendChild(fishingModal);let dotCount=1;const dotInterval=setInterval(()=>{const dotsEl=document.getElementById('dots');if(dotsEl){dotCount=(dotCount%3)+1;dotsEl.textContent='.'.repeat(dotCount);}},500);setTimeout(()=>{const textEl=document.getElementById('fishing-text');if(textEl)textEl.innerHTML='<span style="color: #FFD700; font-weight: bold; animation: pulse 0.5s infinite;">‚ö° √áA MORD ! ‚ö°</span>';},2500);setTimeout(()=>{clearInterval(dotInterval);fishingModal.remove();gameState.inventory.fishingTokens--;currentFishingPokemon=selectPokemon('spawn',true);showFishingEncounter();document.body.style.overflow='auto';},3000);};

let usingFrambyFishing=false,usingPinapFishing=false,usingCerizFishing=false;
function showFishingEncounter(){if(!currentFishingPokemon)return;const isNew=!gameState.captured.has(currentFishingPokemon.id);const statusBadge=isNew?'<div style="background: #10b981; color: white; padding: 5px 15px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 0.9em;">‚ú® NOUVEAU!</div>':'<div style="background: #f59e0b; color: white; padding: 5px 15px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 0.9em;">üìñ Doublon</div>';let berriesHTML='';if(gameState.inventory.framby>0)berriesHTML+=`<div style="margin-bottom: 10px;"><label style="color: white; cursor: pointer; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px; display: inline-block;"><input type="checkbox" onchange="usingFrambyFishing = this.checked; showFishingEncounter();" ${usingFrambyFishing?'checked':''} style="margin-right: 8px;">${getItemIconDisplay('framby','1.2em')} Baie Framby (+50%) [${gameState.inventory.framby}]</label></div>`;if(gameState.inventory.pinap>0)berriesHTML+=`<div style="margin-bottom: 10px;"><label style="color: white; cursor: pointer; background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 10px; display: inline-block;"><input type="checkbox" onchange="usingPinapFishing = this.checked; showFishingEncounter();" ${usingPinapFishing?'checked':''} style="margin-right: 8px;">${getItemIconDisplay('pinap','1.2em')} Baie Pinap (√ó2 coins) [${gameState.inventory.pinap}]</label></div>`;if(gameState.inventory.ceriz>0&&currentFishingPokemon.isShiny)berriesHTML+=`<div style="margin-bottom: 10px;"><label style="color: #FFD700; cursor: pointer; background: rgba(255, 215, 0, 0.2); padding: 10px 20px; border-radius: 10px; display: inline-block;"><input type="checkbox" onchange="usingCerizFishing = this.checked; showFishingEncounter();" ${usingCerizFishing?'checked':''} style="margin-right: 8px;">${getItemIconDisplay('ceriz','1.2em')} Baie Ceriz (100% SHINY!) [${gameState.inventory.ceriz}]</label></div>`;const modal=document.createElement('div');modal.className='modal active fishing-modal';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100000; align-items: center; justify-content: center; pointer-events: all;';modal.innerHTML=`<div class="bg-ocean" style="padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; position: relative; pointer-events: all; z-index: 100001;"><div style="text-align: center;">${statusBadge}<div style="font-size: 2em; margin-bottom: 20px;">üé£ Pok√©mon P√™ch√©!</div><div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 15px;"><img src="${getAnimatedSpriteUrl(currentFishingPokemon.id, currentFishingPokemon.isShiny)}" style="width: 150px; height: 150px; image-rendering: pixelated; ${currentFishingPokemon.isShiny?'filter: drop-shadow(0 0 20px #FFD700);':''}" alt="${currentFishingPokemon.name}"></div><div style="font-size: 1.5em; font-weight: bold; margin: 10px 0; color: ${currentFishingPokemon.isShiny?'#FFD700':'white'};"> ${currentFishingPokemon.isShiny?'‚ú® ':''}${currentFishingPokemon.name}${currentFishingPokemon.isShiny?' ‚ú®':''}</div>${berriesHTML}<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px;">${gameState.inventory.pokeball>0?`<button onclick="attemptFishingCapture('pokeball')" style="background: linear-gradient(135deg, #ef4444, #f97316); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('pokeball','1.2em')} Pok√© Ball (${gameState.inventory.pokeball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('pokeball',currentFishingPokemon.rarity,usingFrambyFishing)*100)}%</span></button>`:''}${gameState.inventory.greatball>0?`<button onclick="attemptFishingCapture('greatball')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('greatball','1.2em')} Super Ball (${gameState.inventory.greatball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('greatball',currentFishingPokemon.rarity,usingFrambyFishing)*100)}%</span></button>`:''}${gameState.inventory.ultraball>0?`<button onclick="attemptFishingCapture('ultraball')" style="background: linear-gradient(135deg, #eab308, #f59e0b); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('ultraball','1.2em')} Hyper Ball (${gameState.inventory.ultraball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('ultraball',currentFishingPokemon.rarity,usingFrambyFishing)*100)}%</span></button>`:''}${gameState.inventory.masterball>0?`<button onclick="attemptFishingCapture('masterball')" style="background: linear-gradient(135deg, #9333ea, #ec4899); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('masterball','1.2em')} Master Ball (${gameState.inventory.masterball})<br><span style="font-size: 0.8em;">100%</span></button>`:''}${gameState.inventory.diveball>0?`<button onclick="attemptFishingCapture('diveball')" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4); padding: 10px 20px; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">${getItemIconDisplay('diveball','1.2em')} Scuba Ball (${gameState.inventory.diveball})<br><span style="font-size: 0.8em;">${Math.round(calculateCaptureRate('diveball',currentFishingPokemon.rarity,usingFrambyFishing)*100)}%</span></button>`:''}</div><button onclick="fleeFishingEncounter()" class="btn btn--outline btn--full-width" style="margin-top: 15px; background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444;">üèÉ Fuir (ne pas capturer)</button></div></div>`;document.body.appendChild(modal);}
window.fleeFishingEncounter=function(){const fishingModal=document.querySelector('.fishing-modal');if(fishingModal){fishingModal.style.animation='slideOutRight 0.4s ease-out';setTimeout(()=>{if(fishingModal.parentNode)fishingModal.remove();},400);}showToast('Vous avez laiss√© le Pok√©mon s\'√©chapper.','info');if(currentFishingPokemon){gameState.fishingHistory.unshift({id:currentFishingPokemon.id,name:currentFishingPokemon.name,isShiny:currentFishingPokemon.isShiny,rarity:currentFishingPokemon.rarity,status:'fled',time:Date.now()});if(gameState.fishingHistory.length>10)gameState.fishingHistory=gameState.fishingHistory.slice(0,10);renderFishingHistory();}currentFishingPokemon=null;saveGame();updateUI();};

window.attemptFishingCapture=function(ballType){if(!currentFishingPokemon)return;if(gameState.inventory[ballType]<=0){showToast('Vous n\'avez plus de cette Pok√©ball!','error');return;}gameState.inventory[ballType]--;if(usingFrambyFishing&&gameState.inventory.framby>0)gameState.inventory.framby--;if(usingPinapFishing&&gameState.inventory.pinap>0)gameState.inventory.pinap--;if(usingCerizFishing&&gameState.inventory.ceriz>0)gameState.inventory.ceriz--;const captureRate=calculateCaptureRate(ballType,currentFishingPokemon.rarity,usingFrambyFishing);const success=ballType==='masterball'?true:Math.random()<captureRate;const fishingModals=document.querySelectorAll('.fishing-modal');fishingModals.forEach(modal=>{modal.style.animation='slideOutRight 0.4s ease-out';setTimeout(()=>{if(modal.parentNode)modal.remove();},400);});const allModals=document.querySelectorAll('.modal.active');allModals.forEach(modal=>{if(modal.classList.contains('fishing-modal')){modal.style.animation='slideOutRight 0.4s ease-out';setTimeout(()=>{if(modal.parentNode)modal.remove();},400);}});if(success){gameState.totalFished++;updateQuestProgress('fished',1);const wasDuplicate=isDuplicate(currentFishingPokemon.id,currentFishingPokemon.isShiny);addToCollection(currentFishingPokemon.id,currentFishingPokemon.isShiny);
    // ===== MURMURE D'ENTROPIE pour la p√™che =====
    if (typeof triggerAmbientNarrative === 'function') {
        triggerAmbientNarrative('fishing_success', { pokemon: currentFishingPokemon.name });
    }
    let coinsEarned={common:120,uncommon:200,rare:600,super_rare:1000,legendary:3500}[currentFishingPokemon.rarity];if(usingPinapFishing)coinsEarned*=2;gameState.coins+=coinsEarned;gameState.totalCoinsEarned+=coinsEarned;updateQuestProgress('coins',coinsEarned);const xpGained=gainXP(currentFishingPokemon.rarity,wasDuplicate);const fishingModal=document.querySelector('.fishing-modal');if(window.FX&&fishingModal){FX.shockwave(fishingModal);if(currentFishingPokemon.isShiny||currentFishingPokemon.rarity==='legendary'){FX.confetti(window.innerWidth/2,window.innerHeight/2,100);FX.stars(window.innerWidth/2,window.innerHeight/2,30);FX.screenShake();}}if(currentFishingPokemon.isShiny&&!wasDuplicate){showToast(`‚ú® ${currentFishingPokemon.name} SHINY p√™ch√©!\n+${coinsEarned} coins\n+${xpGained} XP`,'success');updateQuestProgress('shinies',1);}else{showToast(`‚úÖ ${currentFishingPokemon.name} p√™ch√©!\n+${coinsEarned} coins\n+${xpGained} XP${wasDuplicate?' (doublon)':''}`,'success');}if(['rare','super_rare','legendary'].includes(currentFishingPokemon.rarity)){updateQuestProgress('rare_captures',1);}if(currentFishingPokemon.rarity==='legendary'){updateQuestProgress('legendaries',1);}gameState.fishingHistory.unshift({id:currentFishingPokemon.id,name:currentFishingPokemon.name,isShiny:currentFishingPokemon.isShiny,rarity:currentFishingPokemon.rarity,status:'captured',time:Date.now()});if(gameState.fishingHistory.length>10)gameState.fishingHistory=gameState.fishingHistory.slice(0,10);renderFishingHistory();}else{showToast(`‚ùå ${currentFishingPokemon.name} s'est √©chapp√©!`,'error');gameState.fishingHistory.unshift({id:currentFishingPokemon.id,name:currentFishingPokemon.name,isShiny:currentFishingPokemon.isShiny,rarity:currentFishingPokemon.rarity,status:'fled',time:Date.now()});if(gameState.fishingHistory.length>10)gameState.fishingHistory=gameState.fishingHistory.slice(0,10);renderFishingHistory();}currentFishingPokemon=null;usingFrambyFishing=false;usingPinapFishing=false;usingCerizFishing=false;saveGame();updateUI();};

window.switchPokedexMode=function(mode){if(mode==='gallery')mode='grid';document.getElementById('pokemon-grid').style.display=mode==='grid'?'grid':'none';document.getElementById('pokemon-list').style.display=mode==='list'?'block':'none';gameState.pokedexMode=mode;const btnGrid=document.getElementById('mode-grid-btn');const btnList=document.getElementById('mode-list-btn');[btnGrid,btnList].forEach(btn=>{if(btn){btn.classList.remove('btn--primary');btn.classList.add('btn--outline');}});if(mode==='grid'&&btnGrid){btnGrid.classList.add('btn--primary');btnGrid.classList.remove('btn--outline');renderPokedexGrid();}else if(mode==='list'&&btnList){btnList.classList.add('btn--primary');btnList.classList.remove('btn--outline');renderPokedexList();}saveGame();};
window.switchPokedexRegion=function(region){if(!gameState.pokedexRegion)gameState.pokedexRegion='Kanto';const regionRanges={Kanto:{min:1,max:151},Johto:{min:152,max:251},Hoenn:{min:252,max:386}};const hasPokemonInRegion=Array.from(gameState.captured).some(id=>id>=regionRanges[region].min&&id<=regionRanges[region].max);const isUnlocked=gameState.unlockedRegions&&gameState.unlockedRegions.has(region);if(region!=='Kanto'&&!hasPokemonInRegion&&!isUnlocked){showToast(`üîí R√©gion ${region} verrouill√©e!\nObtenez un Pok√©mon de cette r√©gion pour la d√©bloquer.`,'error');return;}gameState.pokedexRegion=region;const regionTabKanto=document.getElementById('region-tab-kanto');const regionTabJohto=document.getElementById('region-tab-johto');const regionTabHoenn=document.getElementById('region-tab-hoenn');const hasJohtoPokemon=Array.from(gameState.captured).some(id=>id>=152&&id<=251);const hasHoennPokemon=Array.from(gameState.captured).some(id=>id>=252&&id<=386);const isJohtoUnlocked=gameState.unlockedRegions&&gameState.unlockedRegions.has('Johto');const isHoennUnlocked=gameState.unlockedRegions&&gameState.unlockedRegions.has('Hoenn');[regionTabKanto,regionTabJohto,regionTabHoenn].forEach(btn=>{if(btn){btn.classList.remove('btn--primary');btn.classList.remove('btn--outline');btn.style.opacity='';btn.style.filter='';}});if(region==='Kanto'&&regionTabKanto){regionTabKanto.classList.add('btn--primary');regionTabKanto.classList.remove('btn--outline');regionTabKanto.innerHTML='üåã Kanto';}if(regionTabJohto){if(isJohtoUnlocked||hasJohtoPokemon){regionTabJohto.classList.add(region==='Johto'?'btn--primary':'btn--outline');if(region==='Johto')regionTabJohto.classList.remove('btn--outline');regionTabJohto.innerHTML=(isJohtoUnlocked?'':'üîí ')+'üèîÔ∏è Johto';regionTabJohto.style.opacity='1';regionTabJohto.style.filter='none';}else{regionTabJohto.classList.add('btn--outline');regionTabJohto.style.opacity='0.5';regionTabJohto.style.filter='grayscale(100%)';regionTabJohto.innerHTML='üîí üèîÔ∏è Johto';}}if(regionTabHoenn){if(isHoennUnlocked||hasHoennPokemon){regionTabHoenn.classList.add(region==='Hoenn'?'btn--primary':'btn--outline');if(region==='Hoenn')regionTabHoenn.classList.remove('btn--outline');regionTabHoenn.innerHTML=(isHoennUnlocked?'':'üîí ')+'üåä Hoenn';regionTabHoenn.style.opacity='1';regionTabHoenn.style.filter='none';}else{regionTabHoenn.classList.add('btn--outline');regionTabHoenn.style.opacity='0.5';regionTabHoenn.style.filter='grayscale(100%)';regionTabHoenn.innerHTML='üîí üåä Hoenn';}}const currentRegionDisplay=document.getElementById('current-region-display');const regionProgressDisplay=document.getElementById('region-progress-display');if(currentRegionDisplay)currentRegionDisplay.textContent=region;const range=regionRanges[region];const capturedCount=Array.from(gameState.captured).filter(id=>id>=range.min&&id<=range.max).length;const total=range.max-range.min+1;if(regionProgressDisplay)regionProgressDisplay.textContent=`${capturedCount}/${total}`;if(gameState.pokedexMode==='grid')renderPokedexGrid();else if(gameState.pokedexMode==='list')renderPokedexList();saveGame();};

function renderPokedexGrid(){
    const grid = document.getElementById('pokemon-grid');
    if (!grid) return;
    grid.innerHTML = ''; // Reset propre
    
    const region = gameState.pokedexRegion || 'Kanto';
    const regionRanges = {Kanto: {min: 1, max: 151}, Johto: {min: 152, max: 251}, Hoenn: {min: 252, max: 386}};
    const range = regionRanges[region] || regionRanges.Kanto;
    const isUnlocked = gameState.unlockedRegions && gameState.unlockedRegions.has(region);
    const filters = gameState.pokedexFilters || {status: 'all', rarity: 'all', type: 'all', evolvable: 'all'};
    const pokemonIdsToShow = isUnlocked ? Array.from({length: range.max - range.min + 1}, (_, i) => range.min + i) : Array.from(gameState.captured).filter(id => id >= range.min && id <= range.max);
    
    // Cr√©ation d'un Fragment pour n'√©crire dans le DOM qu'une seule fois (Gain perf √©norme)
    const fragment = document.createDocumentFragment();
    const placeholder = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 96 96'%3E%3Ccircle cx='48' cy='48' r='10' fill='%23333' opacity='0.1'/%3E%3C/svg%3E";
    
    pokemonIdsToShow.forEach(id => {
        const hasCaught = gameState.captured.has(id);
        const hasShiny = gameState.shinies.has(id);
        const name = FRENCH_NAMES[id] || `Pok√©mon #${id}`;
        const rarity = getRarity(id);
        const types = POKEMON_TYPES[id] || [];
        
        if (filters.status === 'caught' && !hasCaught) return;
        if (filters.status === 'not-caught' && hasCaught) return;
        if (filters.status === 'shiny' && !hasShiny) return;
        if (filters.rarity !== 'all' && rarity !== filters.rarity) return;
        if (filters.type !== 'all' && !types.includes(filters.type)) return;
        if (filters.evolvable === 'evolvable') {
            const hasEvolved = gameState.evolved.has(id);
            if (hasEvolved) return;
            const evolvedByLevel = EVOLUTION_BY_LEVEL[id];
            if (evolvedByLevel && gameState.captured.has(evolvedByLevel)) return;
            const evolvedByStone = EVOLUTION_DATA[id] ? Object.values(EVOLUTION_DATA[id]) : [];
            if (evolvedByStone.length > 0 && evolvedByStone.some(evolvedId => gameState.captured.has(evolvedId))) return;
            const canEvolveByCaptures = evolvedByLevel && (gameState.capturedCount[id] || 0) >= 5;
            const canEvolveByStone = EVOLUTION_DATA[id] && Object.keys(EVOLUTION_DATA[id]).some(stone => gameState.inventory[stone] > 0);
            if (!canEvolveByCaptures && !canEvolveByStone) return;
        }
        
        const rarityColors = {common: '#9ca3af', uncommon: '#10b981', rare: '#3b82f6', super_rare: '#8b5cf6', legendary: '#f59e0b'};
        const card = document.createElement('div');
        card.className = 'pokemon-card';
        if (hasCaught && hasShiny) { 
            card.classList.add('pokemon-card-shiny-complete', 'shiny-card-effect');
        }
        
        let cardStyle = `background: var(--dark-surface); border: 2px solid ${hasCaught ? rarityColors[rarity] : 'var(--dark-border)'}; border-radius: 12px; padding: 12px; text-align: center; cursor: ${hasCaught ? 'pointer' : 'default'}; transition: all 0.3s; position: relative;`;
        if (hasCaught && hasShiny) {
            cardStyle += `background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(147, 51, 234, 0.15), rgba(236, 72, 153, 0.15)); border: 3px solid transparent; background-clip: padding-box; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), 0 0 40px rgba(147, 51, 234, 0.2), inset 0 0 30px rgba(255, 215, 0, 0.1); animation: shinyCardPulse 3s ease-in-out infinite;`;
        }
        card.style.cssText = cardStyle;
        
        if (hasCaught) {
            card.addEventListener('click', () => showPokemonDetail(id));
            card.addEventListener('mouseenter', function() { this.style.transform = hasCaught && hasShiny ? 'translateY(-8px) scale(1.05)' : 'translateY(-5px)'; });
            card.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0) scale(1)'; });
        }
        
        // OPTIMISATION : Lazy Loading natif + Placeholder SVG ultra-l√©ger
        // Afficher l'image Shiny si poss√©d√©
        const realSrc = hasCaught ? (hasShiny ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png` : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`) : placeholder;
        
        card.innerHTML = `
            <div style="position: relative; margin: 0 auto 8px; width: 96px; height: 96px; display: flex; align-items: center; justify-content: center;">
                <img src="${placeholder}" data-src="${realSrc}" class="lazy-sprite" width="96" height="96" style="object-fit: contain; image-rendering: pixelated; display: block; margin: 0 auto; ${hasCaught && hasShiny ? 'filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)) drop-shadow(0 0 20px rgba(147, 51, 234, 0.4)) brightness(1.1); animation: shinyImageFloat 4s ease-in-out infinite;' : ''};" alt="${hasCaught ? name : '???'}">
                ${hasShiny ? `<div class="shiny-indicator">‚ú®</div>` : `<div class="shiny-shadow">‚ú®</div>`}
            </div>
            <div style="font-weight: bold; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">#${id.toString().padStart(3, '0')}</div>
            <div class="name" style="font-size: 13px; font-weight: 600;">${hasCaught ? name : '???'}</div>
        `;
        
        fragment.appendChild(card);
    });
    
    grid.appendChild(fragment);
    initLazyLoader(); // Lancer l'observateur
}

// Fonction utilitaire pour le lazy loading
function initLazyLoader() {
    if (window.lazyLoaderObserver) {
        window.lazyLoaderObserver.disconnect();
    }
    
    window.lazyLoaderObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    window.lazyLoaderObserver.unobserve(img);
                }
            }
        });
    }, { rootMargin: '50px' });
    
    document.querySelectorAll('.lazy-sprite[data-src]').forEach(img => window.lazyLoaderObserver.observe(img));
}

function renderPokedexList(){const list=document.getElementById('pokemon-list');if(!list)return;list.innerHTML='';const region=gameState.pokedexRegion||'Kanto';const regionRanges={Kanto:{min:1,max:151},Johto:{min:152,max:251},Hoenn:{min:252,max:386}};const range=regionRanges[region]||regionRanges.Kanto;const isUnlocked=gameState.unlockedRegions&&gameState.unlockedRegions.has(region);const hasPokemonInRegion=Array.from(gameState.captured).some(id=>id>=range.min&&id<=range.max);if(!isUnlocked&&region!=='Kanto'&&!hasPokemonInRegion){list.innerHTML='<p style="text-align: center; color: var(--text-secondary); padding: 20px;">üîí R√©gion verrouill√©e - Aucun Pok√©mon √† afficher</p>';return;}const filters=gameState.pokedexFilters||{status:'all',rarity:'all',type:'all',evolvable:'all'};const pokemonIdsToShow=isUnlocked?Array.from({length:range.max-range.min+1},(_,i)=>range.min+i):Array.from(gameState.captured).filter(id=>id>=range.min&&id<=range.max);for(const id of pokemonIdsToShow){const hasCaught=gameState.captured.has(id);const hasShiny=gameState.shinies.has(id);const name=FRENCH_NAMES[id]||`Pok√©mon #${id}`;const types=POKEMON_TYPES[id]||[];const rarity=getRarity(id);if(filters.status==='caught'&&!hasCaught)continue;if(filters.status==='not-caught'&&hasCaught)continue;if(filters.status==='shiny'&&!hasShiny)continue;if(filters.rarity!=='all'&&rarity!==filters.rarity)continue;if(filters.type!=='all'&&!types.includes(filters.type))continue;if(filters.evolvable==='evolvable'){const hasEvolved=gameState.evolved.has(id);if(hasEvolved)continue;const evolvedByLevel=EVOLUTION_BY_LEVEL[id];if(evolvedByLevel&&gameState.captured.has(evolvedByLevel))continue;const evolvedByStone=EVOLUTION_DATA[id]?Object.values(EVOLUTION_DATA[id]):[];if(evolvedByStone.length>0&&evolvedByStone.some(evolvedId=>gameState.captured.has(evolvedId)))continue;const canEvolveByCaptures=evolvedByLevel&&(gameState.capturedCount[id]||0)>=5;const canEvolveByStone=EVOLUTION_DATA[id]&&Object.keys(EVOLUTION_DATA[id]).some(stone=>gameState.inventory[stone]>0);if(!canEvolveByCaptures&&!canEvolveByStone)continue;}const rarityNames={common:'Commun',uncommon:'Peu Commun',rare:'Rare',super_rare:'Super Rare',legendary:'L√©gendaire'};const rarityColors={common:'#9ca3af',uncommon:'#10b981',rare:'#3b82f6',super_rare:'#8b5cf6',legendary:'#f59e0b'};const item=document.createElement('div');item.style.cssText=`background: var(--dark-elevated); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; cursor: ${hasCaught?'pointer':'default'};`;if(hasCaught)item.addEventListener('click',()=>showPokemonDetail(id));item.innerHTML=`<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png" style="width: 50px; height: 50px; image-rendering: pixelated; object-fit: contain; object-position: center; display: block;"><div style="flex: 1;"><div style="font-weight: bold; color: white;">#${id.toString().padStart(3,'0')} ${hasCaught?name:'???'}</div><div style="font-size: 0.9em; color: var(--text-secondary);">${types.join(' / ')||'Normal'}</div></div><div style="text-align: right;"><span style="color: ${rarityColors[rarity]}; font-weight: bold; font-size: 0.9em;">${rarityNames[rarity]}</span>${hasShiny?'<div style="color: #FFD700; font-size: 1em;">‚ú®</div>':''}</div>`;list.appendChild(item);}}


window.showPokemonGalleryDetail=function(pokemonId){const name=FRENCH_NAMES[pokemonId];const hasShiny=gameState.shinies.has(pokemonId);const types=POKEMON_TYPES[pokemonId]||[];const rarity=getRarity(pokemonId);const count=gameState.capturedCount[pokemonId]||1;const lore=POKEMON_LORE[pokemonId]||`${name} est un Pok√©mon fascinant avec ses propres caract√©ristiques uniques.`;const taille=POKEMON_SIZES[pokemonId]||'Taille inconnue';const rarityColors={common:'#9ca3af',uncommon:'#10b981',rare:'#3b82f6',super_rare:'#8b5cf6',legendary:'#f59e0b'};const rarityNames={common:'Commun',uncommon:'Peu Commun',rare:'Rare',super_rare:'Super Rare',legendary:'L√©gendaire'};let evolutionHTML='';const evolutionData=EVOLUTION_DATA[pokemonId];const evolvedForm=EVOLUTION_BY_LEVEL[pokemonId];const hasEvolvedForm=evolvedForm&&gameState.captured.has(evolvedForm);const canEvolveAtAll=evolvedForm||evolutionData;if(!canEvolveAtAll){evolutionHTML='<div style="background: rgba(100,100,100,0.2); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; color: rgba(255,255,255,0.6); font-style: italic;">Ce Pok√©mon ne peut pas √©voluer</div>';}else if(hasEvolvedForm){evolutionHTML='<div style="background: rgba(0,255,0,0.2); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; color: white; font-weight: bold;">‚úÖ D√©j√† √©volu√© en '+FRENCH_NAMES[evolvedForm]+'</div>';}else{if(evolvedForm){const duplicateCount=count;const canEvolve=duplicateCount>=5;evolutionHTML+=`<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 20px 0;"><div style="color: white; font-weight: bold; margin-bottom: 10px;">üîÑ √âvolution par captures</div><div style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; height: 12px; margin-bottom: 10px;"><div style="height: 100%; background: linear-gradient(90deg, #4ade80, #22c55e); width: ${Math.min((duplicateCount/5)*100,100)}%; transition: width 0.5s;"></div></div><div style="color: rgba(255,255,255,0.8); font-size: 0.9em;">${duplicateCount}/5 captures</div>${canEvolve?`<button onclick="evolveByCaptures(${pokemonId})" class="btn btn--primary" style="margin-top: 10px; width: 100%;">‚≠ê √âvoluer</button>`:''}</div>`;}if(evolutionData){evolutionHTML+='<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin: 20px 0;"><div style="color: white; font-weight: bold; margin-bottom: 10px;">üíé √âvolutions par Pierre</div>';if(evolutionData.fire_stone&&gameState.inventory.fire_stone>0)evolutionHTML+=`<button onclick="evolvePokemon(${pokemonId},'fire_stone')" class="btn btn--primary" style="margin: 5px; width: calc(100% - 10px);">üî• Pierre Feu</button>`;if(evolutionData.water_stone&&gameState.inventory.water_stone>0)evolutionHTML+=`<button onclick="evolvePokemon(${pokemonId},'water_stone')" class="btn btn--primary" style="margin: 5px; width: calc(100% - 10px);">üíß Pierre Eau</button>`;if(evolutionData.thunder_stone&&gameState.inventory.thunder_stone>0)evolutionHTML+=`<button onclick="evolvePokemon(${pokemonId},'thunder_stone')" class="btn btn--primary" style="margin: 5px; width: calc(100% - 10px);">‚ö° Pierre Foudre</button>`;if(evolutionData.moon_stone&&gameState.inventory.moon_stone>0)evolutionHTML+=`<button onclick="evolvePokemon(${pokemonId},'moon_stone')" class="btn btn--primary" style="margin: 5px; width: calc(100% - 10px);">üåô Pierre Lune</button>`;if(evolutionData.leaf_stone&&gameState.inventory.leaf_stone>0)evolutionHTML+=`<button onclick="evolvePokemon(${pokemonId},'leaf_stone')" class="btn btn--primary" style="margin: 5px; width: calc(100% - 10px);">üçÉ Pierre Plante</button>`;evolutionHTML+='</div>';}}const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';modal.innerHTML=`<div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; max-width: 600px; width: 100%; position: relative;"><button onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%;">√ó</button><h1 style="color: white; text-align: center; margin: 0 0 15px 0;">#${pokemonId.toString().padStart(3,'0')} ${name}</h1><div style="text-align: center; margin-bottom: 20px;"><span style="display: inline-block; background: ${rarityColors[rarity]}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold;">${rarityNames[rarity]}</span></div><div style="display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;">${types.map(type=>`<span style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border-radius: 15px; font-weight: bold;">${type}</span>`).join('')}</div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;"><div style="text-align: center;"><div style="color: rgba(255,255,255,0.8); font-size: 0.95em; margin-bottom: 10px; font-weight: bold;">Version Normale</div><img src="${getAnimatedSpriteUrl(pokemonId, false)}" style="width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 15px; border: 2px solid rgba(255,255,255,0.3); image-rendering: pixelated; padding: 10px; object-fit: contain; object-position: center;"></div><div style="text-align: center;"><div style="color: ${hasShiny?'#FFD700':'rgba(255,255,255,0.5)'}; font-size: 0.95em; margin-bottom: 10px; font-weight: bold;">Version Shiny ${hasShiny?'‚ú®':'(Non obtenue)'}</div><img src="${getAnimatedSpriteUrl(pokemonId, true)}" style="width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 15px; border: 2px solid ${hasShiny?'#FFD700':'rgba(255,255,255,0.2)'}; image-rendering: pixelated; padding: 10px; opacity: ${hasShiny?'1':'0.4'};filter: ${hasShiny?'':'grayscale(1)'}; object-fit: contain; object-position: center;"></div></div><div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; text-align: left; color: white; margin-bottom: 20px;"><div style="margin-bottom: 12px;"><strong>üìè Taille:</strong> ${taille}</div><div style="margin-bottom: 12px;"><strong>üìö Lore:</strong> ${lore}</div><div style="margin-bottom: 8px;"><strong>üéØ Captur√© ${count} fois</strong></div>${hasShiny?'<div style="color: #FFD700; font-weight: bold;">‚ú® Shiny Poss√©d√©</div>':''}</div>${evolutionHTML}</div>`;document.body.appendChild(modal);modal.addEventListener('click',(e)=>{if(e.target===modal)modal.remove();});};

window.showPokemonDetail=function(pokemonId){const hasCaught=gameState.captured.has(pokemonId);if(!hasCaught){showToast('Pok√©mon pas encore captur√©!','error');return;}showPokemonGalleryDetail(pokemonId);};

// ===== PART 3: QU√äTES, BLIND BOX, SHOP, INVENTAIRE, UI =====

window.renderAllQuests=function(){renderDailyQuests();renderSpecialQuests();renderPermanentQuests();};

function getParisDate(){const now=new Date();const parisTimeStr=now.toLocaleString('en-US',{timeZone:'Europe/Paris',year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});const[datePart,timePart]=parisTimeStr.split(', ');const[month,day,year]=datePart.split('/');const[hours,minutes,seconds]=timePart.split(':');return new Date(year,month-1,day,hours,minutes,seconds);}
function getParisDateString(){const parisDate=getParisDate();return `${parisDate.getFullYear()}-${String(parisDate.getMonth()+1).padStart(2,'0')}-${String(parisDate.getDate()).padStart(2,'0')}`;}
function generateDailyQuests(){if(!gameState.questsProgress.daily){gameState.questsProgress.daily={};}if(!gameState.claimedQuests.daily){gameState.claimedQuests.daily=new Set();}if(!gameState.dailyQuestCompletionDates){gameState.dailyQuestCompletionDates={};}const parisDate=getParisDate();const parisDateStr=getParisDateString();const lastResetDate=gameState.lastDailyQuestDate;if(lastResetDate===parisDateStr&&QUESTS_DATA.daily&&QUESTS_DATA.daily.length>0)return;const yesterdayDate=new Date(parisDate);yesterdayDate.setDate(yesterdayDate.getDate()-1);const yesterdayStr=`${yesterdayDate.getFullYear()}-${String(yesterdayDate.getMonth()+1).padStart(2,'0')}-${String(yesterdayDate.getDate()).padStart(2,'0')}`;const completedYesterday=[];for(const questId in gameState.dailyQuestCompletionDates){const completionDate=gameState.dailyQuestCompletionDates[questId];if(completionDate===yesterdayStr){completedYesterday.push(questId);}}if(lastResetDate!==parisDateStr){for(const questId in gameState.questsProgress.daily){if(!gameState.claimedQuests.daily.has(questId)){delete gameState.questsProgress.daily[questId];}}QUESTS_DATA.daily=[];gameState.claimedQuests.daily.clear();}if(!QUESTS_DATA.daily||QUESTS_DATA.daily.length===0){const selectedQuests=[];for(const poolName of['easy','medium','hard','expert']){const pool=DAILY_QUEST_POOLS[poolName];if(pool&&pool.length>0){const availableQuests=pool.filter(q=>!completedYesterday.includes(q.id));const questPool=availableQuests.length>0?availableQuests:pool;const randomQuest=questPool[Math.floor(Math.random()*questPool.length)];selectedQuests.push({...randomQuest,pool:poolName});}}QUESTS_DATA.daily=selectedQuests;gameState.lastDailyQuestDate=parisDateStr;gameState.lastDailyQuestReset=Date.now();if(lastResetDate!==parisDateStr){gameState.dailyQuestStreak++;if(gameState.dailyQuestStreak>0&&gameState.dailyQuestStreak%7===0){showToast(`üî• Streak de ${gameState.dailyQuestStreak} jours ! Bonus r√©compenses !`,'success');}}saveGame();}}
function renderDailyQuests(){
    generateDailyQuests();
    const container=document.getElementById('daily-quests-container');
    if(!container)return;
    container.innerHTML='';
    if(!QUESTS_DATA.daily||QUESTS_DATA.daily.length===0){
        container.innerHTML='<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Aucune qu√™te quotidienne disponible pour le moment.</p>';
        return;
    }
    if(!gameState.questsProgress.daily){gameState.questsProgress.daily={};}
    if(!gameState.claimedQuests.daily){gameState.claimedQuests.daily=new Set();}
    const quests=[...QUESTS_DATA.daily].sort((a,b)=>{
        const aClaimed=gameState.claimedQuests.daily.has(a.id);
        const bClaimed=gameState.claimedQuests.daily.has(b.id);
        if(aClaimed&&!bClaimed)return 1;
        if(!aClaimed&&bClaimed)return -1;
        const poolOrder={easy:1,medium:2,hard:3,expert:4};
        return (poolOrder[a.pool]||0)-(poolOrder[b.pool]||0);
    });
    for(const quest of quests){
        if(!quest||!quest.id)continue;
        const progress=gameState.questsProgress.daily[quest.id]||0;
        const isClaimed=gameState.claimedQuests.daily.has(quest.id);
        const isCompleted=progress>=quest.target;

        // G√âN√âRATION DYNAMIQUE DES R√âCOMPENSES
        let rewardText=`+${quest.reward.coins}üí∞`;
        if(quest.reward.xp)rewardText+=` ¬∑ +${quest.reward.xp} XP`;
        for(const[key,value]of Object.entries(quest.reward)){
            if(key!=='coins'&&key!=='xp'&&key!=='badge'){
                const itemData=ALL_ITEMS[key];
                if(itemData){
                    rewardText+=` ¬∑ ${value}√ó ${getItemIconDisplay(key, '16px')}`;
                }
            }
        }

        const poolColors={easy:'#10b981',medium:'#3b82f6',hard:'#f59e0b',expert:'#ec4899'};
        const poolNames={easy:'Facile',medium:'Moyen',hard:'Difficile',expert:'Expert'};
        const poolColor=poolColors[quest.pool]||'#666';
        const poolName=poolNames[quest.pool]||'';
        const card=document.createElement('div');
        card.style.cssText=`background: ${isClaimed?'rgba(16, 185, 129, 0.15)':'var(--dark-elevated)'}; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid ${isClaimed?'#10b981':isCompleted?poolColor:'#666'}; opacity: ${isClaimed?'0.5':'1'}; filter: ${isClaimed?'grayscale(50%)':'none'};`;
        card.innerHTML=`<div style="display: flex; gap: 15px; align-items: flex-start;"><div style="font-size: 2em;">${quest.icon||'‚öæ'}</div><div style="flex: 1;"><div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;"><div style="font-weight: bold; color: white;">${isClaimed?'‚úî ':isCompleted?'üéâ ':''}${quest.name||'Qu√™te'}</div><span style="background: ${poolColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: bold;">${poolName}</span></div><div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">${quest.desc||''}</div><div style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; height: 8px;"><div style="height: 100%; background: ${poolColor}; width: ${Math.min((progress/(quest.target||1))*100,100)}%;"></div></div><div style="font-size: 0.85em; color: #bbb; margin-top: 5px;">${progress} / ${quest.target||1}</div></div><div style="text-align: right;">${isClaimed?`<div style="color: #4ade80; font-weight: bold;">‚úî R√©clam√©e</div>`:isCompleted?`<button class="claim-quest-btn btn btn--primary" data-quest-type="daily" data-quest-id="${quest.id}" style="padding: 8px 16px;">R√©clamer</button>`:`<div style="color: #999;"></div>`}<div style="font-size: 0.9em; color: #FFD700; margin-top: 10px;">${rewardText}</div></div></div>`;
        container.appendChild(card);
    }
    container.querySelectorAll('.claim-quest-btn').forEach(btn=>{
        btn.addEventListener('click',function(){
            const questType=this.getAttribute('data-quest-type');
            const questId=this.getAttribute('data-quest-id');
            if(window.claimQuest){window.claimQuest(questType,questId);}
        });
    });
}
function renderSpecialQuests(){
    const container=document.getElementById('special-quests-container');
    if(!container)return;
    container.innerHTML='';
    const quests=[...QUESTS_DATA.special].sort((a,b)=>{
        const aClaimed=gameState.claimedQuests.special.has(a.id);
        const bClaimed=gameState.claimedQuests.special.has(b.id);
        if(aClaimed&&!bClaimed)return 1;
        if(!aClaimed&&bClaimed)return -1;
        return 0;
    });
    for(const quest of quests){
        const progress=gameState.questsProgress.special[quest.id]||0;
        const isClaimed=gameState.claimedQuests.special.has(quest.id);
        const isCompleted=progress>=quest.target;

        // G√âN√âRATION DYNAMIQUE DES R√âCOMPENSES
        let rewardText=`+${quest.reward.coins}üí∞`;
        if(quest.reward.xp)rewardText+=` ¬∑ +${quest.reward.xp} XP`;
        for(const[key,value]of Object.entries(quest.reward)){
            if(key!=='coins'&&key!=='xp'&&key!=='badge'){
                const itemData=ALL_ITEMS[key];
                if(itemData){
                    rewardText+=` ¬∑ ${value}√ó ${getItemIconDisplay(key, '16px')}`;
                }
            }
        }

        const card=document.createElement('div');
        card.style.cssText=`background: ${isClaimed?'rgba(16, 185, 129, 0.15)':'var(--dark-elevated)'}; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid ${isClaimed?'#10b981':isCompleted?'#3b82f6':'#666'}; opacity: ${isClaimed?'0.5':'1'}; filter: ${isClaimed?'grayscale(50%)':'none'};`;
        card.innerHTML=`<div style="display: flex; gap: 15px; align-items: flex-start;"><div style="font-size: 2em;">${quest.icon}</div><div style="flex: 1;"><div style="font-weight: bold; color: white; margin-bottom: 5px;">${isClaimed?'‚úî ':isCompleted?'üéâ ':''}${quest.name}</div><div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">${quest.desc}</div><div style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; height: 8px;"><div style="height: 100%; background: #4ade80; width: ${Math.min((progress/quest.target)*100,100)}%;"></div></div><div style="font-size: 0.85em; color: #bbb; margin-top: 5px;">${progress} / ${quest.target}</div></div><div style="text-align: right;">${isClaimed?`<div style="color: #4ade80; font-weight: bold;">‚úî R√©clam√©e</div>`:isCompleted?`<button class="claim-quest-btn btn btn--primary" data-quest-type="special" data-quest-id="${quest.id}" style="padding: 8px 16px;">R√©clamer</button>`:`<div style="color: #999;"></div>`}<div style="font-size: 0.9em; color: #FFD700; margin-top: 10px;">${rewardText}</div></div></div>`;
        container.appendChild(card);
    }
    container.querySelectorAll('.claim-quest-btn').forEach(btn=>{
        btn.addEventListener('click',function(){
            const questType=this.getAttribute('data-quest-type');
            const questId=this.getAttribute('data-quest-id');
            if(window.claimQuest){window.claimQuest(questType,questId);}
        });
    });
}
function renderPermanentQuests(){
    const container=document.getElementById('permanent-quests-container');
    if(!container)return;
    container.innerHTML='';
    const quests=[...QUESTS_DATA.permanent].sort((a,b)=>{
        const aClaimed=gameState.claimedQuests.permanent.has(a.id);
        const bClaimed=gameState.claimedQuests.permanent.has(b.id);
        if(aClaimed&&!bClaimed)return 1;
        if(!aClaimed&&bClaimed)return -1;
        return 0;
    });
    for(const quest of quests){
        const progress=gameState.questsProgress.permanent[quest.id]||0;
        const isClaimed=gameState.claimedQuests.permanent.has(quest.id);
        const isCompleted=progress>=quest.target;

        // G√âN√âRATION DYNAMIQUE DES R√âCOMPENSES
        let rewardText=`+${quest.reward.coins}üí∞`;
        if(quest.reward.xp)rewardText+=` ¬∑ +${quest.reward.xp} XP`;
        for(const[key,value]of Object.entries(quest.reward)){
            if(key!=='coins'&&key!=='xp'&&key!=='badge'){
                const itemData=ALL_ITEMS[key];
                if(itemData){
                    rewardText+=` ¬∑ ${value}√ó ${getItemIconDisplay(key, '16px')}`;
                }
            }
        }

        const card=document.createElement('div');
        card.style.cssText=`background: ${isClaimed?'rgba(16, 185, 129, 0.15)':'var(--dark-elevated)'}; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid ${isClaimed?'#10b981':isCompleted?'#3b82f6':'#666'}; opacity: ${isClaimed?'0.5':'1'}; filter: ${isClaimed?'grayscale(50%)':'none'};`;
        card.innerHTML=`<div style="display: flex; gap: 15px; align-items: flex-start;"><div style="font-size: 2em;">${quest.icon}</div><div style="flex: 1;"><div style="font-weight: bold; color: white; margin-bottom: 5px;">${isClaimed?'‚úî ':isCompleted?'üéâ ':''}${quest.name}</div><div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">${quest.desc}</div><div style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; height: 8px;"><div style="height: 100%; background: #4ade80; width: ${Math.min((progress/quest.target)*100,100)}%;"></div></div><div style="font-size: 0.85em; color: #bbb; margin-top: 5px;">${progress} / ${quest.target}</div></div><div style="text-align: right;">${isClaimed?`<div style="color: #4ade80; font-weight: bold;">‚úî R√©clam√©e</div>`:isCompleted?`<button class="claim-quest-btn btn btn--primary" data-quest-type="permanent" data-quest-id="${quest.id}" style="padding: 8px 16px;">R√©clamer</button>`:`<div style="color: #999;"></div>`}<div style="font-size: 0.9em; color: #FFD700; margin-top: 10px;">${rewardText}</div></div></div>`;
        container.appendChild(card);
    }
    container.querySelectorAll('.claim-quest-btn').forEach(btn=>{
        btn.addEventListener('click',function(){
            const questType=this.getAttribute('data-quest-type');
            const questId=this.getAttribute('data-quest-id');
            if(window.claimQuest){window.claimQuest(questType,questId);}
        });
    });
}
window.claimQuest=function(questType,questId){
    if(gameState.claimedQuests[questType].has(questId)){
        showToast('D√©j√† r√©clam√©!','error');
        return;
    }
    let questsArray;
    if(questType==='daily')questsArray=QUESTS_DATA.daily;
    else if(questType==='special')questsArray=QUESTS_DATA.special;
    else questsArray=QUESTS_DATA.permanent;
    const quest=questsArray.find(q=>q.id===questId);
    if(!quest)return;
    // ‚ö†Ô∏è FIX : Marquer la qu√™te comme r√©clam√©e AVANT d'appliquer les r√©compenses pour √©viter les doubles clics
    gameState.claimedQuests[questType].add(questId);
    if(questType==='daily'){const parisDateStr=getParisDateString();gameState.dailyQuestCompletionDates[questId]=parisDateStr;}
    const reward=quest.reward;
    if(reward.coins){
        gameState.coins+=reward.coins;
        gameState.totalCoinsEarned+=reward.coins;
    }
    if(reward.xp){
        gameState.xp+=reward.xp;
        checkLevelUp();
    }
    for(const[key,value]of Object.entries(reward)){
        if(key!=='coins'&&key!=='xp'){
            if(key==='badge'){
                if(!gameState.badges)gameState.badges=[];
                if(!gameState.badges.includes(value)){
                    gameState.badges.push(value);
                }
            }else{
                // ‚ö†Ô∏è FIX : L'≈ìuf myst√®re doit aller dans inventory.eggs[] et mettre √† jour le compteur
                if(key==='mystery_egg'){
                    if(!gameState.inventory.eggs)gameState.inventory.eggs=[];
                    for(let i=0;i<value;i++){
                        gameState.inventory.eggs.push({id:'mystery_egg',state:'locked',progress:0});
                    }
                    // Mettre √† jour le compteur de captures pour l'≈ìuf myst√®re
                    if(gameState.mysteryEggProgress===undefined)gameState.mysteryEggProgress=0;
                }else{
                    if(!gameState.inventory[key]){
                        gameState.inventory[key]=0;
                    }
                    gameState.inventory[key]+=value;
                    if(key==='blindbox'||key==='blind_box'){
                        gameState.blindBoxUsed=Math.max(0,gameState.blindBoxUsed-value);
                        const newRemaining=gameState.blindBoxSlots-gameState.blindBoxUsed;
                        if(newRemaining===5){
                            gameState.blindBoxResetTime=null;
                            saveGame();
                        }
                    }
                }
            }
        }
    }
    let rewardMsg='üéâ R√©compenses : ';
    if(reward.coins)rewardMsg+=`+${reward.coins}üí∞ `;
    if(reward.xp)rewardMsg+=`+${reward.xp}XP `;
    for(const[key,value]of Object.entries(reward)){
        if(key!=='coins'&&key!=='xp'&&key!=='badge'){
            const itemData=ALL_ITEMS[key];
            if(itemData){
                rewardMsg+=`+${value}√ó ${itemData.icon} `;
            }
        }
    }
    showToast(rewardMsg,'success');
    checkQuestNotifications();
    saveGame();
    renderAllQuests();
    updateUI();
};

window.openBlindBox=function(){checkBlindBoxReset();const hasBonus=gameState.blindBoxBonus>0;const remaining=gameState.blindBoxSlots-gameState.blindBoxUsed;if(!hasBonus&&gameState.blindBoxUsed>=gameState.blindBoxSlots){showToast('Vous avez utilis√© toutes vos Blind Box!\nProchaine Blind Box disponible demain.','error');return;}const guaranteedLegendary=gameState.blindBoxPity>=20;let pokemon;if(guaranteedLegendary){const legendaryPool=POKEMON_DATA.legendary;const currentRegion=getCurrentUnlockedRegion();let filteredPool=filterPokemonByRegion(legendaryPool,currentRegion);const uncaptured=filteredPool.filter(id=>!gameState.captured.has(id));const pool=uncaptured.length>0?uncaptured:filteredPool.length>0?filteredPool:legendaryPool.slice(0,5);const id=pool[Math.floor(Math.random()*pool.length)];const shinyRate=(1/256)+(Math.floor(gameState.streak/5)*0.01);let isShiny=Math.random()<shinyRate;if(id===130)isShiny=false;pokemon={id,name:FRENCH_NAMES[id],rarity:'legendary',isShiny};gameState.blindBoxPity=0;showToast('üé∞ PITY ACTIV√â! L√©gendaire garanti!','success');}else{pokemon=selectNewPokemonForBlindBox();gameState.blindBoxPity++;}if(hasBonus){gameState.blindBoxBonus--;}else{gameState.blindBoxUsed++;}gameState.totalBlindBoxOpened++;updateQuestProgress('blindbox_opened',gameState.totalBlindBoxOpened);const newRemaining=gameState.blindBoxSlots-gameState.blindBoxUsed;if(newRemaining===4&&!gameState.blindBoxResetTime){gameState.blindBoxResetTime=Date.now()+(24*60*60*1000);saveGame();}if(newRemaining===5){gameState.blindBoxResetTime=null;saveGame();}showBlindBoxAnimation(pokemon);};

// Fonction pour recharger les slots de Blind Box
window.rechargeBlindBoxSlots = function() {
    gameState.blindBoxUsed = 0;
    gameState.blindBoxSlots = 5;
    gameState.blindBoxResetTime = null;
    gameState.lastReset = Date.now();
    
    if (typeof saveGame === 'function') {
        saveGame();
    }
    
    if (typeof showToast === 'function') {
        showToast('üîÑ Slots de Blind Box recharg√©s ! (5/5)', 'success');
    }
    
    if (typeof updateUI === 'function') {
        updateUI();
    }
};

function showBlindBoxAnimation(pokemon){const modal=document.createElement('div');modal.style.cssText=`position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 99999; animation: fadeIn 0.3s ease;`;modal.innerHTML=`<div style="text-align: center;"><div style="font-size: 8em; animation: shake 0.5s infinite;" id="box-icon">üéÅ</div><div style="color: white; font-size: 1.5em; margin-top: 20px;">Ouverture en cours...</div></div>`;document.body.appendChild(modal);setTimeout(()=>{modal.remove();revealBlindBoxPokemon(pokemon);},1500);}

// Initialisation du mod√®le 3D de cadeau pour Blind Box
// Initialisation du mod√®le 3D de vague pour la page de p√™che
window.initFishingWave3D = function() {
    const container = document.getElementById('fishing-wave-3d-container');
    if (!container || typeof THREE === 'undefined') return;
    
    // Nettoyer si d√©j√† initialis√©
    if (container.querySelector('canvas')) return;
    
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 3, 5);
    camera.lookAt(0, 0, 0);
    
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    container.appendChild(renderer.domElement);
    
    // Lumi√®res
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(5, 10, 7);
    scene.add(dirLight);
    
    // L'eau (vague)
    const geometry = new THREE.PlaneGeometry(15, 15, 16, 16);
    const material = new THREE.MeshPhongMaterial({ 
        color: 0x00aaff, 
        shininess: 80,
        flatShading: true,
        transparent: true,
        opacity: 0.7
    });
    const water = new THREE.Mesh(geometry, material);
    water.rotation.x = -Math.PI / 2;
    scene.add(water);
    
    // Le bouchon
    const bobberGroup = new THREE.Group();
    const topGeo = new THREE.SphereGeometry(0.2, 12, 12, 0, Math.PI * 2, 0, Math.PI / 2);
    const topMat = new THREE.MeshStandardMaterial({ color: 0xff3333 });
    const topMesh = new THREE.Mesh(topGeo, topMat);
    const botGeo = new THREE.SphereGeometry(0.2, 12, 12, 0, Math.PI * 2, Math.PI / 2, Math.PI / 2);
    const botMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
    const botMesh = new THREE.Mesh(botGeo, botMat);
    bobberGroup.add(topMesh);
    bobberGroup.add(botMesh);
    scene.add(bobberGroup);
    
    // Animation
    const clock = new THREE.Clock();
    const originalPositions = geometry.attributes.position.array.slice();
    
    function animate() {
        if (!container.parentElement) {
            renderer.dispose();
            return;
        }
        
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        
        // Animation de l'eau
        const positions = geometry.attributes.position.array;
        for (let i = 0; i < positions.length; i += 3) {
            const x = originalPositions[i];
            const y = originalPositions[i + 1];
            const z = Math.sin(x * 0.8 + time * 1.5) * 0.3 + Math.cos(y * 0.5 + time) * 0.2;
            positions[i + 2] = z;
        }
        geometry.attributes.position.needsUpdate = true;
        geometry.computeVertexNormals();
        
        // Animation du bouchon
        const bobberHeight = Math.sin(0 + time * 1.5) * 0.3 + Math.cos(0 + time) * 0.2;
        bobberGroup.position.y = bobberHeight;
        bobberGroup.rotation.x = Math.sin(time * 2) * 0.1;
        bobberGroup.rotation.z = Math.cos(time * 1.8) * 0.1;
        
        renderer.render(scene, camera);
    }
    
    animate();
    
    // Resize
    const resizeObserver = new ResizeObserver(() => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        if (w > 0 && h > 0) {
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        }
    });
    resizeObserver.observe(container);
};

// Initialisation du mod√®le 3D de cadeau pour la page Blind Box
window.initBlindBoxGift3D = function() {
    const container = document.getElementById('blindbox-gift-3d-container');
    if (!container || typeof THREE === 'undefined') return;
    
    // Nettoyer si d√©j√† initialis√©
    if (container.querySelector('canvas')) return;
    
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 1, 3.5);
    camera.lookAt(0, 0, 0);
    
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    container.appendChild(renderer.domElement);
    
    // Lumi√®res
    const ambient = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambient);
    const spot = new THREE.SpotLight(0xffd700, 1.5);
    spot.position.set(5, 5, 5);
    scene.add(spot);
    const backLight = new THREE.DirectionalLight(0x4444ff, 0.5);
    backLight.position.set(-5, 0, -5);
    scene.add(backLight);
    
    // Le cadeau
    const giftGroup = new THREE.Group();
    
    // Bo√Æte
    const boxGeo = new THREE.BoxGeometry(1.5, 1.5, 1.5);
    const boxMat = new THREE.MeshStandardMaterial({ 
        color: 0xff0000,
        roughness: 0.4,
        metalness: 0.1
    });
    const box = new THREE.Mesh(boxGeo, boxMat);
    giftGroup.add(box);
    
    // Ruban
    const ribbonMat = new THREE.MeshStandardMaterial({ 
        color: 0xffffff,
        roughness: 0.5 
    });
    
    const ribVGeo = new THREE.BoxGeometry(0.4, 1.52, 1.52);
    const ribV = new THREE.Mesh(ribVGeo, ribbonMat);
    giftGroup.add(ribV);
    
    const ribHGeo = new THREE.BoxGeometry(1.52, 0.4, 1.52);
    const ribH = new THREE.Mesh(ribHGeo, ribbonMat);
    giftGroup.add(ribH);
    
    // N≈ìud
    const bowGroup = new THREE.Group();
    bowGroup.position.y = 0.75;
    
    const loopGeo = new THREE.TorusGeometry(0.3, 0.1, 8, 16, Math.PI * 1.5);
    const loopL = new THREE.Mesh(loopGeo, ribbonMat);
    loopL.position.x = -0.2;
    loopL.rotation.z = Math.PI / 4;
    bowGroup.add(loopL);
    
    const loopR = new THREE.Mesh(loopGeo, ribbonMat);
    loopR.position.x = 0.2;
    loopR.rotation.z = -Math.PI / 4;
    loopR.rotation.y = Math.PI;
    bowGroup.add(loopR);
    
    const knotGeo = new THREE.SphereGeometry(0.15);
    const knot = new THREE.Mesh(knotGeo, ribbonMat);
    bowGroup.add(knot);
    
    giftGroup.add(bowGroup);
    scene.add(giftGroup);
    
    // Particules d'√©toiles
    const starsGeo = new THREE.BufferGeometry();
    const starsCount = 30;
    const posArray = new Float32Array(starsCount * 3);
    for(let i=0; i<starsCount*3; i++) {
        posArray[i] = (Math.random() - 0.5) * 5;
    }
    starsGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    
    const starMat = new THREE.PointsMaterial({
        color: 0xffd700,
        size: 0.05,
        transparent: true,
        opacity: 0.8
    });
    const starField = new THREE.Points(starsGeo, starMat);
    scene.add(starField);
    
    // Animation
    const clock = new THREE.Clock();
    
    function animate() {
        if (!container.parentElement) {
            renderer.dispose();
            return;
        }
        
        requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        
        giftGroup.rotation.y = time * 0.5;
        giftGroup.rotation.x = Math.sin(time * 0.5) * 0.1;
        giftGroup.position.y = Math.sin(time * 1.5) * 0.1;
        
        const scale = 1 + Math.sin(time * 4) * 0.05;
        bowGroup.scale.set(scale, scale, scale);
        
        starField.rotation.y = -time * 0.2;
        starField.position.y = Math.sin(time * 0.5) * 0.2;
        
        renderer.render(scene, camera);
    }
    
    animate();
    
    // Sparkles CSS
    for(let i=0; i<8; i++) {
        const s = document.createElement('div');
        s.style.cssText = `position: absolute; width: 4px; height: 4px; background: white; border-radius: 50%; animation: twinkle 2s infinite ease-in-out; left: ${Math.random() * 100}%; top: ${Math.random() * 100}%; animation-delay: ${Math.random() * 2}s;`;
        container.appendChild(s);
    }
    
    // Resize
    const resizeObserver = new ResizeObserver(() => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        if (w > 0 && h > 0) {
            camera.aspect = w/h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        }
    });
    resizeObserver.observe(container);
};

function revealBlindBoxPokemon(pokemon){addToCollection(pokemon.id,pokemon.isShiny);const rarityColors={common:'#9ca3af',uncommon:'#3b82f6',rare:'#8b5cf6',super_rare:'#ec4899',legendary:'#f59e0b'};const rarityNames={common:'Commun',uncommon:'Peu Commun',rare:'Rare',super_rare:'Super Rare',legendary:'L√©gendaire'};const remaining=gameState.blindBoxSlots-gameState.blindBoxUsed;let timerHTML='';if(remaining===4&&gameState.blindBoxResetTime){const remainingMs=gameState.blindBoxResetTime-Date.now();if(remainingMs>0){const hours=Math.floor(remainingMs/(60*60*1000));const minutes=Math.floor((remainingMs%(60*60*1000))/(60*1000));timerHTML=`<div style="background: rgba(255, 215, 0, 0.2); border: 2px solid #FFD700; border-radius: 10px; padding: 15px; margin-top: 20px;"><div style="color: #FFD700; font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">‚è∞ Recharge automatique</div><div style="color: white; font-size: 0.95em;">Vos Blind Box seront recharg√©es dans :</div><div style="color: #FFD700; font-size: 1.3em; font-weight: bold; margin-top: 5px;">${hours}h ${minutes}m</div></div>`;}}const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;';modal.innerHTML=`<div style="background: linear-gradient(135deg, ${rarityColors[pokemon.rarity]}, rgba(0,0,0,0.5)); padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; animation: bounceIn 0.5s ease;"><div style="font-size: 1.2em; color: white; font-weight: bold; margin-bottom: 10px;">${rarityNames[pokemon.rarity]}</div><div style="font-size: 2em; font-weight: bold; color: ${pokemon.isShiny?'#FFD700':'white'}; margin-bottom: 20px;">${pokemon.isShiny?'‚ú® ':''}${pokemon.name}${pokemon.isShiny?' ‚ú®':''}</div><img src="${getAnimatedSpriteUrl(pokemon.id, pokemon.isShiny)}" style="width: 200px; height: 200px; image-rendering: pixelated; ${pokemon.isShiny?'filter: drop-shadow(0 0 30px #FFD700);':''}; object-fit: contain; object-position: center; display: block; margin: 0 auto;" alt="${pokemon.name}"><div style="margin-top: 20px; font-size: 1.1em; color: rgba(255,255,255,0.9);">Nouveau Pok√©mon!</div>${timerHTML}<button onclick="this.closest('.modal').remove()" style="margin-top: 25px; padding: 12px 30px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">Continuer</button></div>`;document.body.appendChild(modal);gameState.blindBoxHistory.unshift({id:pokemon.id,pokemon:pokemon.name,rarity:pokemon.rarity,isShiny:pokemon.isShiny,time:Date.now()});if(gameState.blindBoxHistory.length>5)gameState.blindBoxHistory=gameState.blindBoxHistory.slice(0,5);saveGame();updateUI();renderBlindBoxHistory();}

function renderBlindBoxHistory(){const container=document.getElementById('blindbox-history');if(!container)return;const rarityColors={common:'#9ca3af',uncommon:'#3b82f6',rare:'#8b5cf6',super_rare:'#ec4899',legendary:'#f59e0b'};container.innerHTML=gameState.blindBoxHistory.slice(0,5).map(entry=>`<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 5px;"><span style="color: ${rarityColors[entry.rarity]}; font-weight: bold;">${entry.isShiny?'‚ú® ':''}${entry.pokemon}</span><div style="font-size: 0.9em; color: #4ade80;">NOUVEAU!</div></div>`).join('')||'<p style="text-align: center; color: #666;">Aucune Blind Box ouverte</p>';}

window.renderShop=function(){const pokeballsContainer=document.getElementById('shop-pokeballs-items');const berriesContainer=document.getElementById('shop-berries-items');const itemsContainer=document.getElementById('shop-items-items');const lootboxesContainer=document.getElementById('shop-lootboxes-items');if(!pokeballsContainer)return;const shopItems={pokeballs:[{id:'pokeball',qty:10,price:500,icon:'‚öæ',name:'Pok√© Ball x10',desc:'Ball de base (50%)'},{id:'greatball',qty:5,price:1000,icon:'üîµ',name:'Super Ball x5',desc:'Ball am√©lior√©e (70%)'},{id:'ultraball',qty:5,price:2400,icon:'‚ö´',name:'Hyper Ball x5',desc:'Ball puissante (90%)'},{id:'masterball',qty:1,price:10000,icon:'üíú',name:'Master Ball',desc:'100% garanti'},{id:'diveball',qty:5,price:500,icon:'üíß',name:'Scuba Ball x5',desc:'Bonus eau (√ó1.5)'}],berries:[{id:'framby',qty:5,price:1000,icon:'üçì',name:'Baie Framby x5',desc:'+50% capture'},{id:'pinap',qty:5,price:600,icon:'üçç',name:'Baie Pinap x5',desc:'√ó2 coins si capture'},{id:'ceriz',qty:3,price:2000,icon:'üçí',name:'Baie Ceriz x3',desc:'+100% capture Shiny'}],items:[{id:'incensefleur',qty:1,price:2000,icon:'üåÄ',name:'Encens Mystique',desc:'+20% rares (10min)'},{id:'marin_lure',qty:1,price:1200,icon:'ü™∏',name:'App√¢t Marin',desc:'√ó2 captures eau (10min)'},{id:'exp_charm',qty:1,price:1500,icon:'üìò',name:'Amulette Exp',desc:'+25% XP (15min)'},{id:'lucky_charm',qty:1,price:3500,icon:'üçÄ',name:'Talisman Chanceux',desc:'+0.5% shiny (30min)'},{id:'charm_collection',qty:1,price:4000,icon:'üíé',name:'Charm Collection',desc:'+10% nouveau Pok√©mon (20mn)'},{id:'fire_stone',qty:1,price:2500,icon:'üî•',name:'Pierre Feu',desc:'√âvolue en feu'},{id:'water_stone',qty:1,price:2500,icon:'üíß',name:'Pierre Eau',desc:'√âvolue en eau'},{id:'thunder_stone',qty:1,price:2500,icon:'‚ö°',name:'Pierre Foudre',desc:'√âvolue √©lectrik'},{id:'moon_stone',qty:1,price:2500,icon:'üåô',name:'Pierre Lune',desc:'√âvolue sous lune'},{id:'leaf_stone',qty:1,price:2500,icon:'üçÉ',name:'Pierre Plante',desc:'√âvolue plante'}],lootboxes:[{id:'lootbox',qty:1,price:800,icon:'üì¶',name:'Lootbox',desc:'2-4 items (balls, baies)'},{id:'rarebox',qty:1,price:3000,icon:'üéÅ',name:'Rare Box',desc:'3-5 items dont 1 rare'},{id:'suprarebox',qty:1,price:8000,icon:'üíé',name:'Super Rare Box',desc:'4-6 items dont 2 rares'},{id:'ultrabox',qty:1,price:20000,icon:'üß∞',name:'Masterbox',desc:'Le top du top. Jackpot Masterball possible !'}]};const renderSection=(container,items)=>{container.innerHTML=items.map(item=>{if(item.id==='mystery_egg')return'';const current=gameState.inventory[item.id]||0;return `<div class="item-card" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;"><div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;"><div style="font-size: 2em; margin-bottom: 8px; display: flex; align-items: center; justify-content: flex-start; width: 100%;">${getItemIconDisplay(item.id, '32px')}</div><div style="font-weight: bold; color: white; margin-bottom: 4px; width: 100%;">${item.name}</div><div style="font-size: 0.9em; color: var(--text-secondary); width: 100%;">${item.desc}</div></div><button onclick="buyItem('${item.id}',${item.price},${item.qty})" ${gameState.coins<item.price?'disabled':''} class="btn btn--primary" style="min-width: 100px; padding: 12px 16px; align-self: center; flex-shrink: 0;">${item.price} üí∞</button></div>`;}).join('');};renderSection(pokeballsContainer,shopItems.pokeballs);renderSection(berriesContainer,shopItems.berries);renderSection(itemsContainer,shopItems.items);renderSection(lootboxesContainer,shopItems.lootboxes);};

window.buyItem=function(itemId,price,qty=1){if(gameState.coins<price){showToast('Pas assez de coins!','error');return;}gameState.coins-=price;gameState.totalShopPurchases=(gameState.totalShopPurchases||0)+1;updateQuestProgress('shop_purchases',gameState.totalShopPurchases);const isBoostItem=['exp_charm','lucky_charm','incensefleur','marin_lure'].includes(itemId);if(isBoostItem){const duration={exp_charm:15*60*1000,lucky_charm:30*60*1000,incensefleur:10*60*1000,marin_lure:10*60*1000}[itemId];gameState.activeBoosts.push({type:itemId,endTime:Date.now()+duration});renderActiveBoosts();}else{gameState.inventory[itemId]=(gameState.inventory[itemId]||0)+qty;}showToast(`${ALL_ITEMS[itemId]?.name||itemId} ${isBoostItem?'activ√©':'achet√©'}!`,'success');saveGame();updateUI();renderShop();};
window.activateBoostItem=function(itemId){if(!gameState.inventory[itemId]||gameState.inventory[itemId]<=0){showToast('Vous n\'avez pas cet objet!','error');return;}if(itemId==='legendary_radar'){gameState.inventory[itemId]--;const legendaryPool=POKEMON_DATA.legendary;const currentRegion=getCurrentUnlockedRegion();let filteredPool=filterPokemonByRegion(legendaryPool,currentRegion);if(filteredPool.length===0)filteredPool=legendaryPool.slice(0,5);const id=filteredPool[Math.floor(Math.random()*filteredPool.length)];const hasLuckyBoost=gameState.activeBoosts.some(b=>b.type==='lucky_charm'&&b.endTime>Date.now());let shinyRate=(1/256)+(hasLuckyBoost?0.005:0)+(Math.floor(gameState.streak/5)*0.01);const buddyId=gameState.buddy?.activeBuddyId;const buddy=buddyId?gameState.buddy.buddies[buddyId]:null;if(buddy&&(buddy.level||1)>=7)shinyRate+=0.01;let isShiny=Math.random()<shinyRate;if(id===130)isShiny=false;currentPokemon={id,name:FRENCH_NAMES[id],rarity:'legendary',isShiny};usingFramby=false;usingPinap=false;usingCeriz=false;const encounterDiv=document.getElementById('encounter');if(encounterDiv){encounterDiv.innerHTML=`<div style="text-align: center;"><div style="font-size: 5em; animation: pokeball-shake 0.8s;" id="spawn-animation">‚öæ</div><p style="color: white; font-size: 1.2em; margin-top: 20px;">Un Pok√©mon l√©gendaire appara√Æt...</p></div>`;setTimeout(()=>revealPokemon(),800);}if(document.getElementById('capture-page')&&!document.getElementById('capture-page').classList.contains('active')){switchPage('capture');setTimeout(()=>{const encounterDiv=document.getElementById('encounter');const captureSection=document.getElementById('capture-section');if(encounterDiv){encounterDiv.scrollIntoView({behavior:'smooth',block:'center'});}else if(captureSection){captureSection.scrollIntoView({behavior:'smooth',block:'start'});}else{window.scrollTo({top:0,behavior:'smooth'});}},100);}showToast('üß≠ Radar L√©gendaire activ√©! Rencontre l√©gendaire!','success');saveGame();updateUI();renderInventory();return;}const durationMap={exp_charm:15*60*1000,lucky_charm:30*60*1000,incensefleur:10*60*1000,marin_lure:10*60*1000,charm_collection:20*60*1000};const duration=durationMap[itemId]||10*60*1000;gameState.inventory[itemId]--;gameState.activeBoosts.push({type:itemId,endTime:Date.now()+duration});renderActiveBoosts();showToast(`${ALL_ITEMS[itemId]?.name||itemId} activ√©!`,'success');saveGame();updateUI();renderInventory();};
// Remplacer la fonction openLootbox existante par celle-ci
window.openLootbox = function(type) {
    if ((gameState.inventory[type] || 0) <= 0) {
        showToast('Vous n\'avez pas de cette box!', 'error');
        return;
    }

    const config = LOOTBOX_TIERS[type];
    if (!config) return;

    const colors = {
        lootbox: 'linear-gradient(135deg, #667eea, #764ba2)',
        rarebox: 'linear-gradient(135deg, #f59e0b, #d97706)',
        suprarebox: 'linear-gradient(135deg, #ec4899, #be185d)',
        ultrabox: 'linear-gradient(135deg, #FFD700, #FFA500)'
    };
    
    const boxIcons = { lootbox: 'üì¶', rarebox: 'üéÅ', suprarebox: 'üíé', ultrabox: 'üß∞' };

    // Animation d'ouverture premium
    const animModal = document.createElement('div');
    animModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 99999;';
    animModal.innerHTML = `
        <div class="god-rays-bg"></div>
        <div style="text-align: center; position: relative; z-index: 2;">
            <div id="lootbox-icon" style="font-size: 10em; animation: premiumLootboxShake 0.5s infinite ease-in-out; filter: drop-shadow(0 0 30px rgba(255,215,0,0.8));">
                ${boxIcons[type]}
            </div>
            <div style="color: white; font-size: 1.8em; margin-top: 30px; animation: pulse 1s infinite;">
                Ouverture en cours...
            </div>
        </div>
    `;
    document.body.appendChild(animModal);

    // Calcul des r√©compenses (pendant l'animation)
    setTimeout(() => {
        const iconElement = animModal.querySelector('#lootbox-icon');
        if (iconElement) {
            iconElement.style.animation = 'premiumLootboxExplode 0.8s ease-out forwards';
        }
        
        // Effets premium
        if (window.FX) {
            FX.confetti(window.innerWidth/2, window.innerHeight/2, 100);
            FX.screenShake();
        }
        
        setTimeout(() => {
            animModal.remove();
            gameState.inventory[type]--;

            let rewards = [];
            let totalCoins = 0;
            let totalShards = { common: 0, rare: 0, legendary: 0 };
            let totalShinyTokens = 0;

            // 1. Items al√©atoires du pool
            const count = config.minItems + Math.floor(Math.random() * (config.maxItems - config.minItems + 1));
            for (let i = 0; i < count; i++) {
                const itemId = config.itemPool[Math.floor(Math.random() * config.itemPool.length)];
                // Quantit√© al√©atoire (1-3 pour les communs, 1 pour les rares)
                const qty = ['pokeball', 'greatball', 'framby', 'pinap'].includes(itemId) ? Math.floor(Math.random() * 3) + 1 : 1;
                rewards.push({ id: itemId, qty: qty, type: 'item' });
            }

            // 1.5. Radar L√©gendaire sp√©cial pour Masterbox (50% chance, max 1)
            if (type === 'ultrabox' && Math.random() < 0.50) {
                rewards.push({ id: 'legendary_radar', qty: 1, type: 'jackpot' });
            }

            // 2. Coins (Cash-back)
            if (config.coinDrop && Math.random() < config.coinDrop.chance) {
                const coins = config.coinDrop.min + Math.floor(Math.random() * (config.coinDrop.max - config.coinDrop.min + 1));
                totalCoins += coins;
                rewards.push({ id: 'coins', qty: coins, type: 'currency', name: 'Coins' });
            }

            // 3. Garanties (Shards, Tokens)
            if (config.guaranteed) {
                config.guaranteed.forEach(g => {
                    if (g.id.startsWith('shard_')) {
                        const shardType = g.id.replace('shard_', '');
                        totalShards[shardType] += g.qty;
                        rewards.push({ id: g.id, qty: g.qty, type: 'currency', name: `Shard ${shardType}` });
                    } else if (g.id === 'shiny_token') {
                        totalShinyTokens += g.qty;
                        rewards.push({ id: 'shiny_token', qty: g.qty, type: 'currency', name: 'Shiny Token' });
                    }
                });
            }

            // 4. Jackpots !
            if (config.jackpots) {
                config.jackpots.forEach(jackpot => {
                    if (Math.random() < jackpot.chance) {
                        if (jackpot.id.startsWith('coins_')) {
                            totalCoins += jackpot.qty;
                            rewards.push({ id: 'coins_jackpot', qty: jackpot.qty, type: 'jackpot', name: 'JACKPOT COINS !' });
                        } else if (jackpot.id === 'expedition_ticket') {
                             // Ajouter ticket exp√©dition logic here if needed, assuming stored in gameState.rogue
                             if(!gameState.rogue) gameState.rogue = {};
                             gameState.rogue.ticketsAvailable = (gameState.rogue.ticketsAvailable || 0) + jackpot.qty;
                             rewards.push({ id: 'ticket', qty: jackpot.qty, type: 'jackpot', name: 'Ticket Exp√©dition' });
                        } else {
                            rewards.push({ id: jackpot.id, qty: jackpot.qty, type: 'jackpot' });
                        }
                    }
                });
            }
            
            // 5. ≈íufs (selon le type de box)
            const eggChances = {
                'lootbox': { tier: 'common', chance: 0.15 },
                'rarebox': { tier: 'rare', chance: 0.20 },
                'suprarebox': { tier: 'epic', chance: 0.25 },
                'ultrabox': { tier: 'legendary', chance: 0.30 }
            };
            
            if (eggChances[type] && Math.random() < eggChances[type].chance) {
                dropEgg(eggChances[type].tier);
                rewards.push({ id: `egg_${eggChances[type].tier}`, qty: 1, type: 'jackpot', name: EGG_CONFIG.tiers[eggChances[type].tier].name });
            }

            // Appliquer les r√©compenses √† l'inventaire
            if (totalCoins > 0) {
                gameState.coins += totalCoins;
                gameState.totalCoinsEarned += totalCoins;
            }
            if (totalShinyTokens > 0) {
                if (!gameState.rogue) gameState.rogue = {};
                gameState.rogue.totalShinyTokens = (gameState.rogue.totalShinyTokens || 0) + totalShinyTokens;
            }
            // Shards
            if (!gameState.rogueMeta) gameState.rogueMeta = { shards: 0 };
            gameState.rogueMeta.shards = (gameState.rogueMeta.shards || 0) + totalShards.common + (totalShards.rare * 5) + (totalShards.legendary * 20);

            // Items classiques
            rewards.forEach(r => {
                if (r.type === 'item' || r.type === 'jackpot') {
                    if (ALL_ITEMS[r.id]) {
                        gameState.inventory[r.id] = (gameState.inventory[r.id] || 0) + r.qty;
                    }
                }
            });

            // Sauvegarder
            saveGame();
            updateUI();

            // Afficher le r√©sultat
            showLootboxResult(rewards, type, colors[type]);

        }, 500);
    }, 1000);
};

// Nouvelle fen√™tre de r√©sultat plus "Gacha"
function showLootboxResult(rewards, boxType, bgColor) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center;';

    // S√©parer les r√©compenses pour l'affichage
    const itemsHtml = rewards.map(r => {
        let icon = 'üì¶';
        let color = 'white';
        let name = r.name || (ALL_ITEMS[r.id] ? ALL_ITEMS[r.id].name : r.id);
        let className = '';

        if (r.id === 'coins' || r.id.startsWith('coins_')) { icon = 'üí∞'; color = '#FFD700'; }
        else if (r.id.includes('shard')) { icon = 'üíé'; color = '#ec4899'; }
        else if (r.id === 'shiny_token') { icon = '‚ú®'; color = '#20d5d2'; }
        else if (r.id === 'ticket') { icon = 'üé´'; color = '#7d5fff'; }
        else if (r.id === 'mystery_egg') { icon = 'ü•ö'; color = '#FFD700'; }
        else if (r.id.startsWith('egg_')) {
            const tier = r.id.replace('egg_', '');
            if (EGG_CONFIG && EGG_CONFIG.tiers && EGG_CONFIG.tiers[tier]) {
                icon = EGG_CONFIG.tiers[tier].icon || 'ü•ö';
                color = EGG_CONFIG.tiers[tier].color || '#FFD700';
                if (!r.name) name = EGG_CONFIG.tiers[tier].name;
            } else {
                icon = 'ü•ö';
                color = '#FFD700';
            }
        }
        else if (ALL_ITEMS[r.id]) { icon = getItemIconDisplay(r.id, '32px'); }

        if (r.type === 'jackpot') {
            className = 'jackpot-anim';
            color = '#ff0055';
            name = `üö® ${name} üö®`;
        }

        return `
            <div class="${className}" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); min-width: 100px;">
                <div style="font-size: 2em; margin-bottom: 5px; display: flex; justify-content: center;">${icon}</div>
                <div style="color: ${color}; font-weight: bold; font-size: 0.9em;">${name}</div>
                <div style="color: white; font-size: 1.2em; font-weight: 700;">x${r.qty}</div>
            </div>
        `;
    }).join('');

    modal.innerHTML = `
        <div style="background: ${bgColor}; padding: 40px; border-radius: 20px; max-width: 800px; width: 90%; max-height: 90vh; text-align: center; box-shadow: 0 0 50px ${bgColor}; animation: bounceIn 0.5s ease; display: flex; flex-direction: column; overflow: hidden;">
            <h2 style="color: white; margin-bottom: 20px; font-size: 2em; text-shadow: 0 2px 10px rgba(0,0,0,0.5); flex-shrink: 0;">R√©sultat du Tirage</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; overflow-y: auto; flex: 1; padding-right: 10px; max-height: calc(90vh - 200px);">
                ${itemsHtml}
            </div>
            <button onclick="this.closest('.modal').remove(); renderInventory();" class="btn btn--primary" style="padding: 15px 40px; font-size: 1.2em; background: rgba(0,0,0,0.3); border: 2px solid white; flex-shrink: 0; margin-top: auto;">
                Tout prendre
            </button>
        </div>
        <style>
            .jackpot-anim { animation: pulse 0.5s infinite alternate; border-color: #ff0055 !important; background: rgba(255,0,85,0.2) !important; }
        </style>
    `;

    document.body.appendChild(modal);
}
window.hatchMysteryEgg=function(){if(!gameState.inventory.eggs)gameState.inventory.eggs=[];const readyEgg=gameState.inventory.eggs.find(e=>e.id==='mystery_egg'&&e.state==='ready');if(!readyEgg){showToast('Aucun ≈ìuf myst√®re pr√™t! (50 captures n√©cessaires)','error');return;}const eggModal=document.createElement('div');eggModal.style.cssText='position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 99999;';eggModal.innerHTML=`<div style="text-align: center;"><div style="font-size: 10em; animation: eggShake 0.5s infinite;">ü•ö</div><div style="color: white; font-size: 1.5em; margin-top: 20px;">L'≈ìuf √©clot...</div></div>`;document.body.appendChild(eggModal);setTimeout(()=>{eggModal.remove();const johtoPool=[];for(let id=152;id<=242;id++)johtoPool.push(id);const pokemonId=johtoPool[Math.floor(Math.random()*johtoPool.length)];const shinyRate=(1/256)+(Math.floor(gameState.streak/5)*0.01);const isShiny=Math.random()<shinyRate;const eggIndex=gameState.inventory.eggs.findIndex(e=>e.id==='mystery_egg'&&e.state==='ready');if(eggIndex>=0)gameState.inventory.eggs.splice(eggIndex,1);addToCollection(pokemonId,isShiny);const revealModal=document.createElement('div');revealModal.className='modal active';revealModal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center;';revealModal.innerHTML=`<div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 40px; border-radius: 20px; max-width: 400px; text-align: center; animation: bounceIn 0.5s ease;"><div style="font-size: 4em; margin-bottom: 20px;">ü•ö‚ú®</div><h2 style="color: white; margin-bottom: 20px;">≈íuf √âclos !</h2><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${isShiny?'shiny/':''}${pokemonId}.png" style="width: 200px; height: 200px; image-rendering: pixelated; ${isShiny?'filter: drop-shadow(0 0 30px #FFD700);':''}"><div style="font-size: 1.5em; font-weight: bold; color: ${isShiny?'#FFD700':'white'}; margin-top: 15px;">${isShiny?'‚ú® ':''}${FRENCH_NAMES[pokemonId]||`Pok√©mon de Johto`}${isShiny?' ‚ú®':''}</div><div style="color: white; margin-top: 10px;">#${pokemonId}</div><button onclick="this.closest('.modal').remove(); renderInventory();" class="btn btn--primary" style="margin-top: 20px; padding: 12px 30px;">Fermer</button></div>`;document.body.appendChild(revealModal);saveGame();updateUI();},2500);};

window.renderInventory=function(){const container=document.getElementById('inventory-grid');if(!container)return;const showUnowned=document.getElementById('show-unowned')?.checked||false;container.innerHTML='';const eggsCount=(gameState.inventory.eggs||[]).length;if(eggsCount>0){const eggsCard=document.createElement('div');eggsCard.style.cssText='background: var(--dark-elevated); border: 2px solid #7d5fff; border-radius: 12px; padding: 15px; text-align: center; transition: all 0.3s; grid-column: 1 / -1; margin-bottom: 15px;';const readyCount=(gameState.inventory.eggs||[]).filter(e=>e.state==='ready').length;eggsCard.innerHTML=`<div style="font-size: 2em; margin-bottom: 10px;">ü•ö</div><div style="font-weight: bold; color: white; margin-bottom: 5px; font-size: 1.1em;">≈íufs (${eggsCount})</div><div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">${readyCount>0?`‚ú® ${readyCount} pr√™t${readyCount>1?'s':''} √† √©clore !`:'G√©rez vos ≈ìufs et incubez-les'}</div><button onclick="openEggsModal()" class="btn btn--primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: linear-gradient(135deg, #7d5fff, #20d5d2);">G√©rer les ≈íufs</button>`;container.appendChild(eggsCard);}if(gameState.catchbot&&gameState.catchbot.active&&gameState.catchbot.storage&&gameState.catchbot.storage.length>0){const catchbotCard=document.createElement('div');catchbotCard.style.cssText='background: var(--dark-elevated); border: 2px solid #20d5d2; border-radius: 12px; padding: 15px; text-align: center; transition: all 0.3s; grid-column: 1 / -1; margin-bottom: 15px;';catchbotCard.innerHTML=`<div style="font-size: 2em; margin-bottom: 10px;">ü§ñ</div><div style="font-weight: bold; color: white; margin-bottom: 5px; font-size: 1.1em;">Catchbot</div><div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">${gameState.catchbot.storage.length} capture${gameState.catchbot.storage.length>1?'s':''} disponible${gameState.catchbot.storage.length>1?'s':''}</div><button onclick="claimCatchbot()" class="btn btn--primary" style="margin-top: 10px; padding: 8px 16px; width: 100%; background: linear-gradient(135deg, #20d5d2, #7d5fff);">R√©cup√©rer</button>`;container.appendChild(catchbotCard);}for(const[itemId,item]of Object.entries(ALL_ITEMS)){const qty=gameState.inventory[itemId]||0;if(!showUnowned&&qty===0)continue;const card=document.createElement('div');card.style.cssText=`background: ${qty>0?'var(--dark-elevated)':'var(--dark-surface)'}; border: 2px solid ${qty>0?'#667eea':'#444'}; border-radius: 12px; padding: 15px; text-align: center; transition: all 0.3s; opacity: ${qty>0?1:0.5};`;const isLootbox=['lootbox','rarebox','suprarebox','ultrabox'].includes(itemId);const isMysteryEgg=itemId==='mystery_egg';const isBoostItem=['incensefleur','marin_lure','exp_charm','lucky_charm','legendary_radar','charm_collection'].includes(itemId);let openButton='';if(isLootbox&&qty>0){openButton=`<button onclick="openLootbox('${itemId}')" class="btn btn--primary" style="margin-top: 10px; padding: 8px 16px; width: 100%;">Ouvrir</button>`;}else if(isMysteryEgg&&qty>0&&(gameState.mysteryEggProgress||0)>=50){openButton=`<button onclick="hatchMysteryEgg()" class="btn btn--primary" style="margin-top: 10px; padding: 8px 16px; width: 100%;">√âclore</button>`;}else if(isBoostItem&&qty>0){openButton=`<button class="activate-boost-btn btn btn--primary" data-item-id="${itemId}" style="margin-top: 10px; padding: 8px 16px; width: 100%;">Activer</button>`;}card.innerHTML=`<div style="font-size: 2em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center;">${getItemIconDisplay(itemId, '32px')}</div><div style="font-weight: bold; color: white; margin-bottom: 5px; font-size: 0.9em;">${item.name}</div><div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">${item.desc}</div><div style="font-size: 1.3em; font-weight: bold; color: #667eea;">${qty}</div>${isMysteryEgg&&qty>0?`<div style="font-size: 0.85em; color: #FFD700; margin-top: 5px;">${gameState.mysteryEggProgress||0}/50 captures</div>`:''}${openButton}`;container.appendChild(card);}container.querySelectorAll('.activate-boost-btn').forEach(btn=>{btn.addEventListener('click',function(){const itemId=this.getAttribute('data-item-id');if(window.activateBoostItem){window.activateBoostItem(itemId);}});});};

window.switchPage=function(pageName){
    // Protection : V√©rifier si les qu√™tes sont d√©bloqu√©es
    if(pageName==='quests'){
        if(!gameState.modules)gameState.modules={};
        if(!gameState.modules.quests)gameState.modules.quests={id:'quests',condition:'level_3',unlocked:gameState.level>=3};
        if(!gameState.modules.quests.unlocked&&gameState.level<3){
            showToast('üîí Les Qu√™tes seront d√©bloqu√©es au niveau 3 !','error');
            return;
        }
    }
    // Protection : Bloquer le Laboratoire jusqu'au niveau 5
    if(pageName==='research'){
        if(!gameState.research)gameState.research={unlocked:false};
        if(!gameState.research.unlocked&&gameState.level<5){
            showToast('üîí Le Centre de Recherche sera d√©bloqu√© au niveau 5 !','error');
            return;
        }
    }
    
    const pages=document.querySelectorAll('.page');
    pages.forEach(page=>page.classList.remove('active'));
    const targetPage=document.getElementById(`${pageName}-page`);
    if(targetPage)targetPage.classList.add('active');
    const navItems=document.querySelectorAll('.nav-item');
    navItems.forEach(item=>item.classList.remove('active'));
    const pageMap={home:0,capture:1,pokedex:2,shop:3,quests:4,inventory:5,profile:6,expedition:7,poker:8,leaderboard:9};
    if(pageMap[pageName]!==undefined)navItems[pageMap[pageName]]?.classList.add('active');
    const topBar=document.querySelector('.top-bar');
    const bottomNav=document.querySelector('.bottom-nav');
    const newBottomNav=document.querySelector('.new-bottom-nav');
    
    // Cacher les barres de navigation pendant Pok√©-Poker (en jeu) et Exp√©dition (en cours)
    if(pageName==='poker'){
        if(topBar)topBar.style.display='none';
        if(bottomNav)bottomNav.style.display='none';
        if(newBottomNav)newBottomNav.style.display='none';
        renderPokerPage();
    }else if(pageName==='expedition'){
        // Pour l'exp√©dition, cacher uniquement si une run est active
        const isExpeditionActive = typeof runState !== 'undefined' && runState && runState.active;
        if(isExpeditionActive){
            if(topBar)topBar.style.display='none';
            if(bottomNav)bottomNav.style.display='none';
            if(newBottomNav)newBottomNav.style.display='none';
        }else{
            if(topBar)topBar.style.display='flex';
            if(bottomNav)bottomNav.style.display='flex';
            if(newBottomNav)newBottomNav.style.display='flex';
        }
        renderExpeditionPage();
    }else{
        if(topBar)topBar.style.display='flex';
        if(bottomNav)bottomNav.style.display='flex';
        if(newBottomNav)newBottomNav.style.display='flex';
    }
    
    if(pageName==='pokedex'){switchPokedexRegion(gameState.pokedexRegion||'Kanto');renderPokedexGrid();}
    if(pageName==='shop')renderShop();
    if(pageName==='home'&&window.initBlindBoxGift3D){setTimeout(()=>window.initBlindBoxGift3D(),100);}
    if(pageName==='capture'&&window.initFishingWave3D){setTimeout(()=>window.initFishingWave3D(),100);}
    if(pageName==='quests'){renderAllQuests();if(!gameState.system.narrativeFlags.includes('guide_quests_shown')){gameState.system.narrativeFlags.push('guide_quests_shown');setTimeout(()=>triggerNarrative('guide_quests'),1000);}}
    if(pageName==='inventory')renderInventory();
    if(pageName==='profile'){updateUI();updateProfileStats();renderRegionsProgress();const profileNavItem=document.querySelectorAll('.nav-item')[6];if(profileNavItem){const existingBadge=profileNavItem.querySelector('.collection-notif-badge');if(existingBadge)existingBadge.remove();}}
    if(pageName==='home'){renderBlindBoxHistory();renderBuddyHomeDisplay();if(gameState.modules&&gameState.modules.blindbox&&gameState.modules.blindbox.unlocked&&!gameState.system.narrativeFlags.includes('guide_blindbox_first_shown')){gameState.system.narrativeFlags.push('guide_blindbox_first_shown');setTimeout(()=>triggerNarrative('guide_blindbox_first'),1000);}}
    if(pageName==='research'){
        renderResearchPage();
        startAnomalySpawner(); // D√©marrer le spawner quand on ouvre la page
        // Guide : Premi√®re visite au Labo
        if(!gameState.system.narrativeFlags.includes('guide_labo_first_visit_shown')){
            gameState.system.narrativeFlags.push('guide_labo_first_visit_shown');
            setTimeout(()=>triggerNarrative('guide_labo_first_visit'),1000);
        }
    } else {
        stopAnomalySpawner(); // Arr√™ter le spawner quand on quitte la page
        // Nettoyer le moteur 3D quand on quitte la page research
        if (typeof Genesis3D !== 'undefined') {
            Genesis3D.cleanup();
        }
    }
    if(pageName==='leaderboard'){renderLeaderboard('pdg');}
}
function renderBuddyHomeDisplay() {
    const container = document.getElementById('buddy-home-display');
    if (!container) return;
    
    if (!gameState.buddy || !gameState.buddy.activeBuddyId) {
        container.innerHTML = `<p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">Aucun Buddy s√©lectionn√©</p><button onclick="window.showBuddySelection && window.showBuddySelection();" class="btn btn--primary" style="padding: 12px 24px;">Choisir un Buddy</button>`;
        return;
    }

    // R√©cup√©ration propre des donn√©es
    const activeId = gameState.buddy.activeBuddyId;
    const buddyData = gameState.buddy.buddies[activeId];
    
    // Extraction de l'ID pur et du statut Shiny
    let pokeId = activeId;
    let isShiny = false;

    // Cas 1: ID format "25_shiny"
    if (typeof activeId === 'string' && activeId.includes('_')) {
        pokeId = parseInt(activeId.split('_')[0]);
        isShiny = true;
    } 
    // Cas 2: ID num√©rique, on regarde dans l'objet buddyData
    else {
        pokeId = parseInt(activeId);
        isShiny = buddyData ? buddyData.isShiny : false;
    }

    const pokemonName = FRENCH_NAMES[pokeId] || `Pok√©mon #${pokeId}`;
    const currentLevel = buddyData ? (buddyData.level || 1) : 1;
    const currentXP = buddyData ? (buddyData.xp || 0) : 0;
    const nextLevelXP = typeof EXPEDITION_CONFIG !== 'undefined' ? EXPEDITION_CONFIG.buddyXpCurve(currentLevel) : 100;
    const xpProgress = Math.min((currentXP / nextLevelXP) * 100, 100).toFixed(0);

    // G√©n√©ration HTML avec le bon isShiny
    container.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
            <img src="${getAnimatedSpriteUrl(pokeId, isShiny)}" style="width: 80px; height: 80px; image-rendering: pixelated; cursor: pointer; object-fit: contain; object-position: center;" onclick="showBuddyDetail()">
            <div style="flex: 1; text-align: left;">
                <div style="color: white; font-weight: bold; font-size: 1.2em; margin-bottom: 5px;">
                    ${isShiny ? '‚ú® ' : ''}${pokemonName}
                </div>
                <div style="color: #FFD700; font-size: 1.1em; margin-bottom: 8px;">Niveau ${currentLevel}</div>
                <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; margin-bottom: 5px;">
                    <div style="width: ${xpProgress}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A);"></div>
                </div>
                <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${currentXP} / ${nextLevelXP} XP</div>
            </div>
        </div>
        <button onclick="showBuddyDetail()" class="btn btn--primary" style="width: 100%; padding: 12px;">Voir les d√©tails</button>
    `;
}

function filterPokedex(){const statusFilter=document.getElementById('pokedex-filter-status')?.value||'all';const rarityFilter=document.getElementById('pokedex-filter-rarity')?.value||'all';const typeFilter=document.getElementById('pokedex-filter-type')?.value||'all';const evolvableFilter=document.getElementById('pokedex-filter-evolvable')?.value||'all';gameState.pokedexFilters={status:statusFilter,rarity:rarityFilter,type:typeFilter,evolvable:evolvableFilter};if(gameState.pokedexMode==='grid')renderPokedexGrid();else if(gameState.pokedexMode==='list')renderPokedexList();}

function renderCaptureHistory(){const container=document.getElementById('capture-history');if(!container)return;const rarityColors={common:'#9ca3af',uncommon:'#3b82f6',rare:'#8b5cf6',super_rare:'#ec4899',legendary:'#f59e0b'};container.innerHTML=gameState.captureHistory.slice(0,10).map(entry=>{const statusColor=entry.status==='captured'?'#4ade80':'#ef4444';const statusText=entry.status==='captured'?'Captur√©':'Enfui';const shinyStyle=entry.isShiny?'style="background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shinyText 2s linear infinite;"':'';return`<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 5px;"><span style="color: ${rarityColors[entry.rarity]}; font-weight: bold;" ${shinyStyle}>${entry.isShiny?'‚ú® ':''}${entry.name}${entry.isShiny?' ‚ú®':''}</span><div style="font-size: 0.9em; color: ${statusColor}; font-weight: bold;">${statusText}</div></div>`;}).join('')||'<p style="text-align: center; color: #666;">Aucune rencontre r√©cente</p>';}
function renderFishingHistory(){const container=document.getElementById('fishing-history');if(!container)return;const rarityColors={common:'#9ca3af',uncommon:'#3b82f6',rare:'#8b5cf6',super_rare:'#ec4899',legendary:'#f59e0b'};container.innerHTML=(gameState.fishingHistory||[]).slice(0,10).map(entry=>{const statusColor=entry.status==='captured'?'#4ade80':'#ef4444';const statusText=entry.status==='captured'?'Captur√©':'Enfui';const shinyStyle=entry.isShiny?'style="background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: shinyText 2s linear infinite;"':'';return`<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 5px;"><span style="color: ${rarityColors[entry.rarity]}; font-weight: bold;" ${shinyStyle}>${entry.isShiny?'‚ú® ':''}${entry.name}${entry.isShiny?' ‚ú®':''}</span><div style="font-size: 0.9em; color: ${statusColor}; font-weight: bold;">${statusText}</div></div>`;}).join('')||'<p style="text-align: center; color: #666;">Aucune p√™che r√©cente</p>';}
// Fonction pour cr√©er la texture de la Pok√©ball
function createCorrectedTexture() {
    if (typeof THREE === 'undefined') return null;
    const canvas = document.createElement('canvas');
    canvas.width = 1024;
    canvas.height = 512;
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    // Blanc
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, w, h);
    // Rouge
    ctx.fillStyle = '#e60012';
    ctx.fillRect(0, 0, w, h / 2);
    // Bande Noire (10%)
    ctx.fillStyle = '#222';
    const bandH = h * 0.10;
    ctx.fillRect(0, (h/2) - (bandH/2), w, bandH);
    const cx = w / 2;
    const cy = h / 2;
    // Bouton Noir (14%)
    ctx.beginPath();
    ctx.arc(cx, cy, h * 0.14, 0, 2 * Math.PI);
    ctx.fillStyle = '#222';
    ctx.fill();
    // Bouton Blanc (9%)
    ctx.beginPath();
    ctx.arc(cx, cy, h * 0.09, 0, 2 * Math.PI);
    ctx.fillStyle = '#fff';
    ctx.fill();
    // Relief interne
    ctx.beginPath();
    ctx.arc(cx, cy, h * 0.06, 0, 2 * Math.PI);
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    ctx.stroke();
    return new THREE.CanvasTexture(canvas);
}

// Fonction pour initialiser la Pok√©ball 3D
let pokeball3DScene = null;
let pokeball3DRenderer = null;
let pokeball3DAnimationId = null;

function init3DPokeball(containerId, message = 'Un Pok√©mon appara√Æt...') {
    if (typeof THREE === 'undefined') {
        console.warn('Three.js n\'est pas charg√©');
        return;
    }
    
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Nettoyer l'ancienne sc√®ne si elle existe
    if (pokeball3DAnimationId) {
        cancelAnimationFrame(pokeball3DAnimationId);
    }
    if (pokeball3DRenderer && pokeball3DRenderer.domElement) {
        pokeball3DRenderer.domElement.remove();
    }
    
    // Cr√©er le conteneur pour Three.js
    const canvasContainer = document.createElement('div');
    canvasContainer.id = 'pokeball-3d-canvas-container';
    canvasContainer.style.cssText = 'width: 320px; height: 400px; margin: 0 auto; position: relative;';
    
    container.innerHTML = '';
    container.appendChild(canvasContainer);
    
    // Initialiser Three.js
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, 320 / 400, 0.1, 1000);
    camera.position.set(0, 0.5, 2.8);
    camera.lookAt(0, 0, 0);
    
    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(320, 400);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    canvasContainer.appendChild(renderer.domElement);
    
    // Cr√©er la texture
    const texture = createCorrectedTexture();
    if (!texture) return;
    
    // Cr√©er la Pok√©ball (taille r√©duite de 20% : 0.8 * 0.8 = 0.64)
    const geometry = new THREE.SphereGeometry(0.64, 64, 64);
    const material = new THREE.MeshStandardMaterial({
        map: texture,
        roughness: 0.3,
        metalness: 0.2,
    });
    const pokeball = new THREE.Mesh(geometry, material);
    pokeball.castShadow = true;
    // Orientation initiale : rotation pour que le cercle blanc soit visible de face
    pokeball.rotation.y = Math.PI; // Rotation de 180¬∞ pour montrer le c√¥t√© blanc
    scene.add(pokeball);
    
    // Cr√©er l'ombre au sol (ajust√©e √† la nouvelle taille)
    const shadowGeo = new THREE.CircleGeometry(0.56, 32);
    const shadowMat = new THREE.MeshBasicMaterial({
        color: 0x000000,
        transparent: true,
        opacity: 0.3
    });
    const shadow = new THREE.Mesh(shadowGeo, shadowMat);
    shadow.rotation.x = -Math.PI / 2;
    shadow.position.y = -1.2;
    scene.add(shadow);
    
    // Cr√©er les particules
    const particlesGeometry = new THREE.BufferGeometry();
    const particlesCount = 30;
    const posArray = new Float32Array(particlesCount * 3);
    for (let i = 0; i < particlesCount * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 4;
    }
    particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    
    // Texture de particule
    const spriteCanvas = document.createElement('canvas');
    spriteCanvas.width = 32;
    spriteCanvas.height = 32;
    const sCtx = spriteCanvas.getContext('2d');
    const grad = sCtx.createRadialGradient(16, 16, 0, 16, 16, 16);
    grad.addColorStop(0, 'rgba(255, 255, 200, 1)');
    grad.addColorStop(1, 'rgba(255, 255, 0, 0)');
    sCtx.fillStyle = grad;
    sCtx.fillRect(0, 0, 32, 32);
    const particleTexture = new THREE.CanvasTexture(spriteCanvas);
    
    const particlesMaterial = new THREE.PointsMaterial({
        size: 0.15,
        map: particleTexture,
        transparent: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });
    const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
    scene.add(particlesMesh);
    
    // Lumi√®res
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    
    const mainLight = new THREE.DirectionalLight(0xffffff, 1.2);
    mainLight.position.set(5, 5, 5);
    scene.add(mainLight);
    
    const rimLight = new THREE.SpotLight(0x6e6eff, 2);
    rimLight.position.set(-5, 2, -5);
    rimLight.lookAt(0, 0, 0);
    scene.add(rimLight);
    
    // Ajouter le message
    const messageDiv = document.createElement('p');
    messageDiv.style.cssText = 'text-align: center; color: white; font-size: 1.2em; margin-top: 20px;';
    messageDiv.textContent = message;
    container.appendChild(messageDiv);
    
    // Animation
    const clock = new THREE.Clock();
    
    function animate() {
        pokeball3DAnimationId = requestAnimationFrame(animate);
        const time = clock.getElapsedTime();
        
        // Rotation de la balle (vitesse augment√©e de 20% : 0.02 * 1.2 = 0.024)
        pokeball.rotation.y += 0.024;
        pokeball.rotation.z = Math.sin(time * 0.5) * 0.1;
        pokeball.rotation.x = 0.2 + Math.cos(time * 0.3) * 0.05;
        
        // L√©vitation
        const floatHeight = Math.sin(time * 2) * 0.15;
        pokeball.position.y = floatHeight;
        
        // Ombre dynamique
        const shadowScale = 1 - (floatHeight * 1.5);
        shadow.scale.set(shadowScale, shadowScale, 1);
        shadow.material.opacity = 0.3 + (floatHeight * -0.5);
        
        // Particules
        particlesMesh.rotation.y = -time * 0.1;
        particlesMesh.position.y = Math.sin(time * 1.5) * 0.1;
        
        renderer.render(scene, camera);
    }
    
    // Stocker les r√©f√©rences
    pokeball3DScene = scene;
    pokeball3DRenderer = renderer;
    
    animate();
}

function resetEncounterToIdle() {
    const encounterDiv = document.getElementById('encounter');
    if (!encounterDiv) return;
    init3DPokeball('encounter', '');
}
function checkBlindBoxReset(){const now=Date.now();const lastReset=gameState.lastReset||Date.now();const dayInMs=24*60*60*1000;if(now-lastReset>=dayInMs){gameState.blindBoxUsed=0;gameState.lastReset=now;gameState.blindBoxResetTime=null;saveGame();return true;}return false;}
function updateBlindBoxTimer(){checkBlindBoxReset();const remaining=gameState.blindBoxSlots-gameState.blindBoxUsed;if(remaining===5){gameState.blindBoxResetTime=null;saveGame();}if(gameState.blindBoxResetTime&&Date.now()>=gameState.blindBoxResetTime){gameState.blindBoxUsed=0;gameState.blindBoxResetTime=null;gameState.lastReset=Date.now();showToast('üéÅ Vos Blind Box sont recharg√©es !','success');saveGame();}const timerEl=document.getElementById('blindbox-timer');if(timerEl&&gameState.blindBoxResetTime){const remainingMs=gameState.blindBoxResetTime-Date.now();if(remainingMs>0){const hours=Math.floor(remainingMs/(60*60*1000));const minutes=Math.floor((remainingMs%(60*60*1000))/(60*1000));timerEl.textContent=`Recharge dans : ${hours}h ${minutes}m`;timerEl.style.display='block';}else{timerEl.style.display='none';}}else if(timerEl){timerEl.style.display='none';}}
function updateExpeditionTicketTimer(){
    checkExpeditionTicketReset();
    const tickets = gameState.rogue.ticketsAvailable || 0;
    const timerEl = document.getElementById('expedition-ticket-timer');
    if (!timerEl) return;
    
    if (tickets < 5) {
        // Initialiser le reset time si n√©cessaire
        if (!gameState.rogue.expeditionResetTime) {
            const now = Date.now();
            const lastReset = gameState.rogue.lastTicketResetTime || now;
            const dayInMs = 24 * 60 * 60 * 1000;
            // Si on vient de passer sous 5, initialiser le timer
            if (tickets === 4) {
                gameState.rogue.expeditionResetTime = lastReset + dayInMs;
                saveGame();
            }
        }
        
        if (gameState.rogue.expeditionResetTime) {
            const remainingMs = gameState.rogue.expeditionResetTime - Date.now();
            if (remainingMs > 0) {
                const hours = Math.floor(remainingMs / (60 * 60 * 1000));
                const minutes = Math.floor((remainingMs % (60 * 60 * 1000)) / (60 * 1000));
                timerEl.textContent = `Recharge dans : ${hours}h ${minutes}m`;
                timerEl.style.display = 'block';
            } else {
                // Reset effectu√©
                gameState.rogue.expeditionResetTime = null;
                timerEl.style.display = 'none';
            }
        }
    } else {
        // Si on a 5 tickets, pas de timer
        gameState.rogue.expeditionResetTime = null;
        timerEl.style.display = 'none';
    }
}
function updateFishingTokens(){const now=Date.now();const hoursSince=Math.floor((now-gameState.lastFishingTokenTime)/(60*60*1000));if(hoursSince>=1&&gameState.inventory.fishingTokens<10){gameState.inventory.fishingTokens=Math.min(10,gameState.inventory.fishingTokens+hoursSince);gameState.lastFishingTokenTime=now;saveGame();}const timerEl=document.getElementById('fishing-token-timer');if(timerEl&&gameState.inventory.fishingTokens<10){const nextTokenTime=gameState.lastFishingTokenTime+(60*60*1000);const remainingMs=nextTokenTime-now;if(remainingMs>0){const minutes=Math.floor(remainingMs/(60*1000));timerEl.textContent=`Prochain jeton dans : ${minutes}m`;timerEl.style.display='block';}else{timerEl.style.display='none';}}else if(timerEl){timerEl.style.display='none';}}
function updateUI(){document.getElementById('trainer-level').textContent=gameState.level;document.getElementById('coins-display').textContent=gameState.coins.toLocaleString();document.getElementById('streak-display').textContent=gameState.streak;const xpPercent=(gameState.xp/gameState.xpToNext)*100;document.getElementById('xp-bar').style.width=`${xpPercent}%`;document.getElementById('xp-text').textContent=`${gameState.xp} / ${gameState.xpToNext} XP`;document.getElementById('pokedex-count').textContent=gameState.captured.size;document.getElementById('shiny-count').textContent=gameState.shinies.size;document.getElementById('best-streak').textContent=gameState.bestStreak;const remaining=gameState.blindBoxSlots-gameState.blindBoxUsed;const totalAvailable=remaining+(gameState.blindBoxBonus||0);document.getElementById('blindbox-count').textContent=`${totalAvailable}/${gameState.blindBoxSlots}${gameState.blindBoxBonus>0?` (+${gameState.blindBoxBonus})`:''}`;const blindboxCountPage=document.getElementById('blindbox-count-page');if(blindboxCountPage)blindboxCountPage.textContent=`${totalAvailable}/${gameState.blindBoxSlots}${gameState.blindBoxBonus>0?` (+${gameState.blindBoxBonus})`:''}`;const regionProgressDisplay=document.getElementById('region-progress-display');if(regionProgressDisplay){const kantoCaptures=Array.from(gameState.captured).filter(id=>id>=1&&id<=151).length;regionProgressDisplay.textContent=`${kantoCaptures}/151`;}const pityEl=document.getElementById('pity-counter');if(pityEl)pityEl.textContent=`${gameState.blindBoxPity}/20 vers L√©gendaire garanti`;const fishingTokensEl=document.getElementById('fishing-tokens');if(fishingTokensEl)fishingTokensEl.textContent=gameState.inventory.fishingTokens;const kantoCaptures=Array.from(gameState.captured).filter(id=>id>=1&&id<=151).length;const kantoTotal=151;const regionDisplay=document.getElementById('current-region-display');if(regionDisplay)regionDisplay.textContent=gameState.currentRegion;const regionProgress=document.getElementById('region-progress-display');if(regionProgress)regionProgress.textContent=`${kantoCaptures}/${kantoTotal}`;updateSystemStabilityDisplay();updateBlindBoxTimer();updateFishingTokens();}

function updateProfileStats(){
    // üõë S√âCURIT√â : Si la page n'est pas charg√©e, on arr√™te tout de suite
    const levelEl = document.getElementById('profile-level');
    if (!levelEl) return;
    
    const playHours=Math.floor(gameState.totalPlaytime/3600000);
    const playMinutes=Math.floor((gameState.totalPlaytime%3600000)/60000);
    const successRate=gameState.totalCaptureAttempts>0?Math.round((gameState.totalSuccessfulCaptures/gameState.totalCaptureAttempts)*100):0;
    document.getElementById('stat-playtime').textContent=`${playHours}h ${playMinutes}m`;
    document.getElementById('stat-success-rate').textContent=`${successRate}%`;
    document.getElementById('stat-blindbox').textContent=gameState.totalBlindBoxOpened;
    document.getElementById('stat-fished').textContent=gameState.totalFished;
    document.getElementById('stat-coins-earned').textContent=gameState.totalCoinsEarned.toLocaleString();
    document.getElementById('profile-level').textContent=gameState.level;
    document.getElementById('profile-xp').textContent=gameState.xp;
    document.getElementById('profile-xp-next').textContent=gameState.xpToNext;
    document.getElementById('profile-pokedex').textContent=gameState.captured.size;
    document.getElementById('profile-total').textContent=gameState.totalCaught;
    document.getElementById('profile-shinies').textContent=gameState.shinies.size;
    document.getElementById('profile-best-streak').textContent=gameState.bestStreak;
    const xpBar=document.getElementById('profile-xp-bar');
    if(xpBar){const xpPercent=(gameState.xp/gameState.xpToNext)*100;xpBar.style.width=`${xpPercent}%`;}
    renderRegionsProgress();
    checkAndUnlockCustomization();
    updateProfileDisplay();
}

window.toggleStreakTooltip = function(e) {
    if(e) e.stopPropagation(); // Emp√™che la fermeture imm√©diate
    
    const existing = document.querySelector('.streak-tooltip-popup');
    if(existing){ existing.remove(); return; }

    // Calcul des chances
    const baseRate = 1/256 * 100; // ~0.39%
    const bonusRate = (Math.floor(gameState.streak/5) * 0.01) * 100; // Convertir en %
    const totalRate = baseRate + bonusRate;

    const tooltip = document.createElement('div');
    tooltip.className = 'streak-tooltip-popup';
    tooltip.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 10000; max-width: 450px; animation: bounceIn 0.5s ease;';
    
    tooltip.innerHTML = `
        <div style="position: relative;">
            <button onclick="this.closest('.streak-tooltip-popup').remove()" style="position: absolute; top: -10px; right: -10px; background: none; border: none; color: white; font-size: 20px; cursor: pointer;">√ó</button>
            
            <div style="text-align: center;">
                <div style="font-size: 3em; margin-bottom: 15px;">üî•</div>
                <h2 style="margin: 0 0 15px 0;">Syst√®me de Streak</h2>
                <p style="margin-bottom: 15px;">Chaque capture r√©ussie augmente votre streak.<br>‚ö†Ô∏è Si une capture √©choue, le streak retombe √† 0 et vous perdez tous les bonus !</p>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>Streak actuel:</strong> ${gameState.streak} üî•<br>
                    <strong>Meilleur streak:</strong> ${gameState.bestStreak}
                </div>
                <div style="text-align: left; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong>üìä Bonus par Streak :</strong><br>
                    ‚Ä¢ Tous les 5 streak : <span style="color: #FFD700;">+1% chance Shiny</span><br>
                    ‚Ä¢ 10 streak : <span style="color: #4ade80;">+20% XP et coins</span><br>
                    ‚Ä¢ 20 streak : <span style="color: #f59e0b;">+50% XP et coins</span>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <strong>Votre Taux Shiny :</strong> <span style="color: #FFD700; font-size: 1.2em;">${totalRate.toFixed(2)}%</span><br>
                    <span style="font-size: 0.8em; color: #aaa;">Base (0.39%) + Bonus Streak (+${bonusRate.toFixed(2)}%)</span>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(tooltip);
    
    // Gestion fermeture au clic ext√©rieur uniquement
    const closeHandler = function(evt) {
        if (!tooltip.contains(evt.target) && evt.target.id !== 'streak-display') {
            tooltip.remove();
            document.removeEventListener('click', closeHandler);
        }
    };
    setTimeout(() => document.addEventListener('click', closeHandler), 10);
};

// ===== SYST√àME S√âQUENTIEL DE D√âMARRAGE =====
let startupSequence = {
    currentStep: 0,
    steps: ['pwa', 'intro', 'name'], // Supprim√© 'tutorial', ajout√© 'intro'
    completed: {
        pwa: false,
        intro: false,
        name: false
    }
};

function startInitialSequence() {
    // R√©initialiser si nouvelle partie
    if (!gameState.introSeen && !gameState.customization.nameModalSeen) {
        startupSequence.currentStep = 0;
        startupSequence.completed = { pwa: false, intro: false, name: false };
    }
    
    // V√©rifier quelles √©tapes sont d√©j√† compl√©t√©es
    if (gameState.customization?.pwaModalSeen) startupSequence.completed.pwa = true;
    if (gameState.introSeen) startupSequence.completed.intro = true;
    if (gameState.customization?.nameModalSeen) startupSequence.completed.name = true;
    
    // D√©marrer la s√©quence
    executeNextStep();
}

function executeNextStep() {
    // Trouver la prochaine √©tape non compl√©t√©e
    for (let i = 0; i < startupSequence.steps.length; i++) {
        const step = startupSequence.steps[i];
        if (!startupSequence.completed[step]) {
            startupSequence.currentStep = i;
            switch(step) {
                case 'pwa':
                    showPWAInstallModal();
                    break;
                case 'intro':
                    if (!gameState.introSeen) {
                        setTimeout(() => startGlitchIntro(), 500);
                    } else {
                        startupSequence.completed.intro = true;
                        executeNextStep();
                    }
                    break;
                case 'name':
                    if (!gameState.customization.nameModalSeen) {
                        setTimeout(() => showNameModal(), 500);
                    } else {
                        startupSequence.completed.name = true;
                        executeNextStep();
                    }
                    break;
                        }
            break;
        }
    }
}

function completeStep(stepName) {
    startupSequence.completed[stepName] = true;
    if (stepName === 'pwa') gameState.customization.pwaModalSeen = true;
    if (stepName === 'intro') gameState.introSeen = true;
    if (stepName === 'name') gameState.customization.nameModalSeen = true;
    saveGame();
    executeNextStep();
}

window.showPWAInstallModal = function() {
    // Utiliser la fonction existante de pwa_ui.js si disponible
    if (typeof window.showInstallModal === 'function') {
        window.showInstallModal();
    } else {
        // Fallback si pwa_ui.js n'est pas charg√©
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if (isStandalone) {
            completeStep('pwa');
            return;
        }
        // Si pas de modal PWA, passer directement √† l'√©tape suivante
        completeStep('pwa');
    }
};

window.showTutorial=function(){const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';modal.innerHTML=`<div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; max-width: 700px; width: 100%; position: relative; max-height: 90vh; overflow-y: auto;"><h1 style="color: white; text-align: center; margin-top: 0; font-size: 2em;">üëã Bienvenue, Dresseur!</h1><div style="color: white; line-height: 1.8; font-size: 1em; margin-bottom: 30px;"><div style="background: rgba(125, 95, 255, 0.3); border: 2px solid rgba(125, 95, 255, 0.5); border-radius: 12px; padding: 20px; margin-bottom: 20px;"><p style="margin: 10px 0; font-size: 1.1em;"><strong>ü§ñ Votre Guide : Porygon-Z</strong></p><p style="margin: 10px 0; color: rgba(255,255,255,0.9);">Porygon-Z sera votre compagnon virtuel. Il vous guidera √† travers votre aventure et vous informera des nouveaux d√©blocages !</p><p style="margin: 10px 0; color: rgba(255,255,255,0.8); font-size: 0.9em; font-style: italic;">üí° Cliquez n'importe o√π sur ses dialogues pour avancer.</p></div><p style="margin: 15px 0; text-align: center;"><strong style="font-size: 1.2em;">üéÆ Devenez Collecteur Pok√©mon!</strong></p><p style="margin: 10px 0; text-align: center;">Capturez les 151 Pok√©mon de Kanto, d√©bloquez Johto et Hoenn!</p><p style="margin: 10px 0; text-align: center;"><strong>‚ú® Trouvez des Shinies rares et des L√©gendaires!</strong></p><div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin: 15px 0;"><p style="margin: 8px 0; font-weight: bold; color: #FFD700;">üéØ Vos Objectifs :</p><ul style="text-align: left; margin: 10px 0; padding-left: 25px; color: rgba(255,255,255,0.9);"><li style="margin: 5px 0;">Compl√©ter le Pok√©dex</li><li style="margin: 5px 0;">Trouver des Shinies</li><li style="margin: 5px 0;">Compl√©ter les collections et qu√™tes</li><li style="margin: 5px 0;">Progresser √† travers les r√©gions</li></ul></div><div style="background: rgba(168, 85, 247, 0.3); border: 2px solid rgba(168, 85, 247, 0.5); border-radius: 12px; padding: 15px; margin: 15px 0;"><p style="margin: 8px 0; font-weight: bold; color: #a855f7;">‚ö° D√©blocages Progressifs :</p><ul style="text-align: left; margin: 10px 0; padding-left: 25px; color: rgba(255,255,255,0.9); font-size: 0.95em;"><li style="margin: 5px 0;">Niveau 2 : üé£ P√™che</li><li style="margin: 5px 0;">Niveau 5 : üî¨ Centre de Recherche (√ânergie Onirique)</li><li style="margin: 5px 0;">Et bien d'autres modes √† d√©couvrir !</li></ul></div><p style="margin: 15px 0; text-align: center; color: rgba(255,255,255,0.8); font-size: 0.95em;">Porygon-Z vous informera automatiquement de chaque nouveau d√©blocage !</p><p style="margin: 15px 0; text-align: center;"><strong style="font-size: 1.1em;">üèÜ Devenez Ma√Ætre Supr√™me!</strong></p></div><button onclick="this.closest('.modal').remove(); completeStep('tutorial');" style="width: 100%; padding: 15px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; font-size: 1.1em; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.02)';" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)';"">C'est parti! üöÄ</button></div>`;document.body.appendChild(modal);};
// ===== MODALE DE NOM (STYLE SYST√àME PORYGON) =====
window.showNameModal = function() {
    // Supprimer l'ancienne modale si elle existe
    const existing = document.getElementById('name-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'name-modal';
    modal.className = 'modal active';
    modal.style.cssText = `
        display: flex !important;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 100001; /* Au-dessus de tout */
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.5s ease;
    `;

    modal.innerHTML = `
        <div style="
            background: linear-gradient(135deg, rgba(20, 20, 35, 0.98), rgba(30, 30, 50, 0.98));
            border: 3px solid #a855f7;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            position: relative;
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.5);
            font-family: 'VT323', monospace;
        ">
            <div style="font-size: 4em; margin-bottom: 10px; animation: pulse 2s infinite;">ü§ñ</div>
            <h2 style="color: #a855f7; font-size: 2.5em; margin-bottom: 10px; text-transform: uppercase; text-shadow: 0 0 10px rgba(168, 85, 247, 0.8);">
                IDENTIFICATION
            </h2>
            <p style="color: #fff; font-size: 1.3em; margin-bottom: 30px; line-height: 1.5;">
                Veuillez entrer votre identifiant d'Archiviste pour initialiser le syst√®me.
            </p>
            
            <input type="text" id="trainer-name-input" placeholder="Nom d'utilisateur" 
                style="
                    width: 100%; 
                    padding: 15px; 
                    background: rgba(0, 0, 0, 0.5); 
                    border: 2px solid #a855f7; 
                    border-radius: 10px; 
                    color: #20d5d2; 
                    font-family: 'VT323', monospace; 
                    font-size: 1.5em; 
                    text-align: center;
                    margin-bottom: 30px;
                    outline: none;
                " 
                maxlength="12" 
                autocomplete="off"
                autofocus
            >
            
            <button onclick="window.submitTrainerName()" class="btn" style="
                background: linear-gradient(135deg, #7d5fff, #a855f7); 
                color: white; 
                border: none; 
                padding: 15px 40px; 
                border-radius: 10px; 
                font-family: 'Rajdhani', sans-serif; 
                font-weight: bold; 
                font-size: 1.2em; 
                cursor: pointer; 
                transition: all 0.3s;
                box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
                text-transform: uppercase;
                letter-spacing: 2px;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                INITIALISER
            </button>
        </div>
    `;

    document.body.appendChild(modal);
    
    // Focus sur l'input
    setTimeout(() => {
        const input = document.getElementById('trainer-name-input');
        if(input) input.focus();
    }, 100);
    // G√©rer la touche Entr√©e
    const input = document.getElementById('trainer-name-input');
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') window.submitTrainerName();
        });
    }
};

// Logique de soumission du nom (extraite pour robustesse)
window.submitTrainerName = function() {
    const input = document.getElementById('trainer-name-input');
    if (!input) return;
    
    const name = input.value.trim();
    if (!name) {
        showToast('Identifiant requis.', 'error');
        return;
    }
    
    // Initialisation de s√©curit√©
    if (!gameState.customization) gameState.customization = {};
    
    // Sauvegarder le nom
    gameState.customization.trainerName = name;
    gameState.customization.nameModalSeen = true;
    
    // Mettre √† jour l'UI
    if (typeof updateProfileDisplay === 'function') updateProfileDisplay();
    if (typeof updateTopBarDisplay === 'function') updateTopBarDisplay();
    saveGame();
    
    // Fermer la modale avec animation
    const modal = document.getElementById('name-modal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => modal.remove(), 500);
    }
    
    // Feedback narratif de Porygon
    setTimeout(() => {
        showPorygonMessage([
            `Identit√© confirm√©e : Archiviste ${name}.`,
            'Acc√®s syst√®me : ACCORD√â.',
            'Initialisation des protocoles de capture...',
            'Bonne chance.'
        ], 'happy');
    }, 600);
    
    // Valider l'√©tape du tutoriel s√©quentiel
    if (typeof completeStep === 'function') completeStep('name');
};

function showToast(msg,type='info'){const toast=document.createElement('div');toast.style.cssText=`position: fixed; top: 80px; right: 20px; background: ${type==='success'?'linear-gradient(135deg, #4CAF50, #8BC34A)':type==='error'?'linear-gradient(135deg, #ff6b6b, #ff5252)':'linear-gradient(135deg, #667eea, #764ba2)'}; color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; animation: slideInRight 0.3s ease-out; font-weight: 600; max-width: 350px; white-space: pre-wrap;`;toast.textContent=msg;document.body.appendChild(toast);const existingToasts=document.querySelectorAll('[data-toast="true"]');const toastCount=existingToasts.length;if(toastCount>0){const topOffset=80+(toastCount*80);toast.style.top=`${topOffset}px`;}toast.setAttribute('data-toast','true');setTimeout(()=>{toast.style.animation='slideOutRight 0.3s ease-out';setTimeout(()=>{toast.remove();const remainingToasts=document.querySelectorAll('[data-toast="true"]');remainingToasts.forEach((t,idx)=>{t.style.top=`${80+(idx*80)}px`;});},300);},3000);}

function showCelebration(title,message,type='default',pokemonId=null){const colors={shiny:'linear-gradient(135deg, #FFD700, #FFA500)',legendary:'linear-gradient(135deg, #9333ea, #ec4899)',levelup:'linear-gradient(135deg, #3b82f6, #8b5cf6)',achievement:'linear-gradient(135deg, #10b981, #3b82f6)',default:'linear-gradient(135deg, #667eea, #764ba2)'};const modal=document.createElement('div');modal.style.cssText=`position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 99999; animation: fadeIn 0.3s ease;`;const imageHTML=pokemonId?`<img src="${getAnimatedSpriteUrl(pokemonId, false)}" style="width: 200px; height: 200px; image-rendering: pixelated; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.5)); object-fit: contain; object-position: center; display: block; margin: 0 auto 20px;">`:'';const closeModal=()=>{modal.style.animation='slideOutRight 0.4s ease-out';setTimeout(()=>{if(modal.parentNode)modal.remove();},400);};modal.innerHTML=`<div style="background: ${colors[type]}; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; animation: bounceIn 0.5s ease; box-shadow: 0 20px 60px rgba(0,0,0,0.5);"><div style="font-size: 3em; margin-bottom: 20px;">${type==='shiny'?'‚ú®':type==='legendary'?'üëë':type==='levelup'?'üéâ':type==='achievement'?'üèÜ':'üåü'}</div>${imageHTML}<div style="font-size: 1.8em; font-weight: bold; color: white; margin-bottom: 15px;">${title}</div><div style="font-size: 1.1em; color: rgba(255,255,255,0.9); white-space: pre-wrap;">${message}</div><button onclick="window.closeCelebrationModal && window.closeCelebrationModal()" style="margin-top: 25px; padding: 12px 30px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">OK</button></div>`;document.body.appendChild(modal);window.closeCelebrationModal=closeModal;setTimeout(()=>{if(modal.parentNode){closeModal();delete window.closeCelebrationModal;}},5000);}
window.resetGame=function(){if(!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n√ätes-vous absolument s√ªr de vouloir r√©initialiser?\n\nToute votre progression sera d√©finitivement perdue :\n- Pok√©dex complet\n- Coins et objets\n- Qu√™tes et succ√®s\n- Niveau et XP\n\nCette action est IRR√âVERSIBLE !')){return;}if(!confirm('Derni√®re confirmation :\n\nTapez OK pour SUPPRIMER d√©finitivement toutes vos donn√©es.')){return;}try{localStorage.removeItem('pokemonGameV62');localStorage.clear();setTimeout(()=>{window.location.reload();},100);}catch(e){console.error('Erreur lors de la r√©initialisation:',e);alert('Erreur lors de la r√©initialisation. Veuillez rafra√Æchir la page manuellement.');window.location.reload();}};

window.restartGame=function(){if(!confirm('üîÑ Recommencer la partie\n\nVoulez-vous recommencer depuis le d√©but?\n\nToute votre progression sera perdue et vous repartirez depuis le tutoriel.\n\nCette action est IRR√âVERSIBLE !')){return;}try{localStorage.removeItem('pokemonGameV62');localStorage.clear();setTimeout(()=>{window.location.reload();},100);}catch(e){console.error('Erreur lors de la r√©initialisation:',e);alert('Erreur lors de la r√©initialisation. Veuillez rafra√Æchir la page manuellement.');window.location.reload();}};

window.evolvePokemon=function(pokemonId,stoneType){if(!gameState.captured.has(pokemonId)){showToast('Vous devez d\'abord capturer ce Pok√©mon!','error');return;}const evolutionData=EVOLUTION_DATA[pokemonId];if(!evolutionData||!evolutionData[stoneType]){showToast('Ce Pok√©mon ne peut pas √©voluer avec cette pierre!','error');return;}if((gameState.inventory[stoneType]||0)<=0){showToast(`Vous n'avez pas de ${ALL_ITEMS[stoneType]?.name||stoneType}!`,'error');return;}const evolvedId=evolutionData[stoneType];gameState.inventory[stoneType]--;gameState.captured.add(evolvedId);gameState.evolved.add(evolvedId);if(!gameState.capturedCount[evolvedId])gameState.capturedCount[evolvedId]=0;gameState.capturedCount[evolvedId]++;gameState.totalCaught++;const evolvedName=FRENCH_NAMES[evolvedId];showCelebration(`‚ú® √âVOLUTION! ‚ú®`,`${FRENCH_NAMES[pokemonId]} ‚Üí ${evolvedName}`,'achievement',evolvedId);saveGame();updateUI();if(document.getElementById('pokedex-page')?.classList.contains('active'))renderPokedexGrid();if(document.querySelector('.modal.active'))document.querySelector('.modal.active').remove();};
window.evolveByCaptures=function(pokemonId){if(!gameState.captured.has(pokemonId)){showToast('Vous devez d\'abord capturer ce Pok√©mon!','error');return;}const count=gameState.capturedCount[pokemonId]||0;if(count<5){showToast(`Vous devez capturer ce Pok√©mon 5 fois! (${count}/5)`,'error');return;}const evolvedId=EVOLUTION_BY_LEVEL[pokemonId];if(!evolvedId){showToast('Ce Pok√©mon ne peut pas √©voluer par captures!','error');return;}const evolveModal=document.createElement('div');evolveModal.style.cssText='position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 99999;';evolveModal.innerHTML=`<div style="text-align: center;"><img src="${getAnimatedSpriteUrl(pokemonId, false)}" id="evolve-sprite" style="width: 200px; height: 200px; image-rendering: pixelated; animation: evolutionPulse 0.5s infinite; object-fit: contain; object-position: center;"></div>`;document.body.appendChild(evolveModal);let frame=0;const spriteEl=document.getElementById('evolve-sprite');const evolveInterval=setInterval(()=>{frame++;if(frame<=10){spriteEl.src=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonId}.png`;}else if(frame<=20){spriteEl.src=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${evolvedId}.png`;}else{clearInterval(evolveInterval);}},200);setTimeout(()=>{clearInterval(evolveInterval);evolveModal.remove();gameState.captured.add(evolvedId);gameState.evolved.add(evolvedId);if(!gameState.capturedCount[evolvedId])gameState.capturedCount[evolvedId]=0;gameState.capturedCount[evolvedId]++;gameState.totalCaught++;const evolvedName=FRENCH_NAMES[evolvedId];showCelebration(`‚ú® √âVOLUTION! ‚ú®`,`${FRENCH_NAMES[pokemonId]} ‚Üí ${evolvedName}`,'achievement',evolvedId);saveGame();updateUI();if(document.getElementById('pokedex-page')?.classList.contains('active'))renderPokedexGrid();if(document.querySelector('.modal.active'))document.querySelector('.modal.active').remove();},4500);};
// ===== EXPEDITION NARRATION SYSTEM =====
const EXPEDITION_NARRATIVES={
encounter_common:['Des bruissements dans les buissons... Un {pokemon} appara√Æt !','Ton Buddy {buddy} s\'arr√™te net. Un {pokemon} vous observe.','Une silhouette famili√®re... C\'est un {pokemon} !'],
encounter_rare:['‚ú® L\'air devient √©lectrique... Un {pokemon} surgit devant toi !','‚ú® Une aura puissante √©mane de l\'ombre... Ton Buddy {buddy} se met en garde. C\'est un {pokemon} !','üåü Les cristaux autour de toi brillent... Un {pokemon} rare t\'a rep√©r√© !'],
encounter_legendary:['‚ö° Le sol tremble sous tes pieds... Une pr√©sence titanesque !','üåå L\'air se fige. Ton Buddy {buddy} √©carquille les yeux... C\'est {pokemon} !','üí´ Une force √©crasante emplit la salle... Le l√©gendaire {pokemon} t\'attend.'],
encounter_shiny:['‚ú® Des √©tincelles dor√©es dansent dans l\'air... TON C≈íUR S\'EMBALLE !','üåü Ton Buddy {buddy} frissonne d\'excitation... Cette aura... C\'est un SHINY !','üíé Une lumi√®re cristalline illumine la pi√®ce... INCROYABLE ! Un shiny !','‚≠ê Tes yeux brillent... Tu n\'en crois pas tes yeux... UN SHINY {pokemon} !'],
encounter_target:['üéØ TON C≈íUR S\'ARR√äTE... C\'EST LUI ! Ton Target {pokemon} !','üéØ Ton Buddy {buddy} te regarde... Il sait. C\'est EXACTEMENT ce que tu cherches !','üéØ L\'instant que tu attendais... {pokemon} se tient devant toi !'],
encounter_target_shiny:['üéØ‚ú® IMPOSSIBLE... Ton Target {pokemon}... EN VERSION SHINY !','üéØ‚ú® LE JACKPOT ! Ton Buddy {buddy} n\'en revient pas... Target Shiny devant toi !','üéØ‚ú® LES √âTOILES SONT ALIGN√âES ! {pokemon} shiny... TON R√äVE !'],
boss_appear:['üëë UNE PR√âSENCE √âCRASANTE EMPLIT LA SALLE...','üëë Le sol se fissure... L\'AIR DEVIENT LOURD... Le Boss t\'attend.','üëë Ton Buddy {buddy} se met en position... C\'EST L\'HEURE DE V√âRIT√â !'],
boss_target_appear:['üëëüéØ TON C≈íUR EXPLOSE... Ton Target {pokemon}... EN BOSS FINAL !','üëëüéØ L\'INSTANT ULTIME... {pokemon} te d√©fie du regard !','üëëüéØ TOUT SE JOUE MAINTENANT... Ton r√™ve est √† port√©e de main !'],
chest_appear:['üì¶ Un coffre ancien repose dans un coin... Qu\'y a-t-il dedans ?','‚ú® Quelque chose brille dans l\'ombre... Un coffre !','üíé Ton Buddy {buddy} gratte le sol... Un coffre enfoui !'],
merchant_appear:['üõí Une silhouette encapuchonn√©e t\'interpelle... \'Besoin d\'√©quipement, dresseur ?\'','üéí Un marchand itin√©rant installe son √©tal... \'J\'ai ce qu\'il te faut !\'','üíº Une vieille femme sourit... \'Des tr√©sors pour les aventuriers...\''],
sanctuary_appear:['üïäÔ∏è Une lumi√®re douce baigne la pi√®ce... Un sanctuaire ancien.','‚ú® L\'air ici est apaisant... Ton Buddy {buddy} semble serein.','üå∏ Des fleurs cristallines poussent autour d\'un autel... Un lieu sacr√©.'],
puzzle_appear:['üß© Un m√©canisme ancien bloque le passage... Un puzzle !','üîÆ Des runes brillent sur le mur... Sauras-tu les activer ?','‚öôÔ∏è Des engrenages rouill√©s... Ton Buddy {buddy} teste le m√©canisme.'],
capture_success_common:['‚úÖ Captur√© ! {pokemon} rejoint ton √©quipe !','‚úÖ Bien jou√© ! Chain : {chain}','‚úÖ {pokemon} est √† toi ! Continue comme √ßa !'],
capture_success_shiny:['‚ú®üéâ SHINY CAPTUR√â !!! {pokemon} brille de mille feux !','üåüüíé JACKPOT ! Un shiny dans ta collection ! Chain : {chain}','‚≠ê‚ú® TON BUDDY {buddy} SAUTE DE JOIE ! SHINY {pokemon} !!!'],
capture_fail_chain_break:['üíî {pokemon} s\'enfuit... TA CHAIN EST PERDUE !','üíî‚ùå √âchec... Chain retomb√©e √† 0... Ne baisse pas les bras !','üíî Ton Buddy {buddy} baisse la t√™te... Chain bris√©e...'],
capture_fail_chain_saved:['üõ°Ô∏è {pokemon} s\'√©chappe MAIS... Talent Protector ! Chain sauv√©e !','‚ú® √âchec... MAIS {buddy} prot√®ge ta Chain ! Ouf !','‚ö° Rat√©... Mais ta Chain est intacte ! Talent activ√© !'],
empty_room:['üí® La salle est vide... Juste le bruit de tes pas.','üçÉ Rien ici... Tu peux continuer.','üåÄ Silence... Ton Buddy {buddy} scrute les ombres. Rien.']
};
function getNarrative(category,context={}){
const templates=EXPEDITION_NARRATIVES[category];
if(!templates||templates.length===0){console.warn(`Narrative category "${category}" not found`);return '';}
let narrative=templates[Math.floor(Math.random()*templates.length)];
const replacements={pokemon:context.pokemonName||'Pok√©mon',buddy:context.buddyName||'ton Buddy',chain:context.chain||0,type:context.type||'Normal',tokens:context.tokens||0};
for(const[key,value]of Object.entries(replacements)){const regex=new RegExp(`\\{${key}\\}`,'g');narrative=narrative.replace(regex,value);}
return narrative;
}
function showNarration(category,context){
const narrativeText=getNarrative(category,context);
const narrativeContainer=document.querySelector('.event-narration');
if(!narrativeContainer)return;
const textElement=narrativeContainer.querySelector('.narration-text');
if(!textElement)return;
textElement.style.opacity='0';
textElement.style.transform='translateY(-10px)';
setTimeout(()=>{
textElement.innerHTML=narrativeText;
textElement.style.opacity='1';
textElement.style.transform='translateY(0)';
},150);
}
function updateChainTierColor(chain){
const container=document.querySelector('.chain-counter-mega');
if(!container)return;
let tier=0;
if(chain>=100)tier=4;
else if(chain>=50)tier=3;
else if(chain>=25)tier=2;
else if(chain>=10)tier=1;
container.setAttribute('data-tier',tier);
const valueEl=container.querySelector('.chain-value');
if(valueEl){
const colors=['var(--chain-tier-0)','var(--chain-tier-1)','var(--chain-tier-2)','var(--chain-tier-3)','var(--chain-tier-4)'];
valueEl.style.color=colors[tier]||colors[0];
}
}
function animateChainIncrement(newChainValue){
const chainElement=document.querySelector('.chain-value');
if(!chainElement)return;
chainElement.textContent=newChainValue;
chainElement.style.animation='none';
setTimeout(()=>{chainElement.style.animation='chainBump 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';},10);
updateChainTierColor(newChainValue);
spawnChainParticles(chainElement,newChainValue);
}
function spawnChainParticles(element,chain){
const particleCount=Math.min(Math.floor(chain/5),10);
const rect=element.getBoundingClientRect();
for(let i=0;i<particleCount;i++){
setTimeout(()=>{
const particle=document.createElement('div');
particle.className='chain-particle';
const angle=(Math.PI*2*i)/particleCount+Math.random()*0.5;
const distance=50+Math.random()*30;
const x=Math.cos(angle)*distance;
const y=Math.sin(angle)*distance;
particle.style.setProperty('--tx',`${x}px`);
particle.style.setProperty('--ty',`${y}px`);
particle.style.cssText='position:absolute;width:8px;height:8px;background:currentColor;border-radius:50%;pointer-events:none;animation:particleBurst 1s ease-out forwards;box-shadow:0 0 12px currentColor;left:50%;top:50%;';
element.parentElement.appendChild(particle);
setTimeout(()=>particle.remove(),1000);
},i*50);
}
}
function animateChainBreak(){
const chainElement=document.querySelector('.chain-value');
if(!chainElement)return;
chainElement.style.animation='chainShatter 0.6s ease-out';
chainElement.style.color='var(--emotion-danger)';
setTimeout(()=>{chainElement.style.color='';},1000);
showStyledToast('üíî Chain perdue...','error');
}
function launchShinyConfetti(){
for(let i=0;i<30;i++){
setTimeout(()=>{
const confetti=document.createElement('div');
confetti.style.cssText=`position:fixed;width:10px;height:10px;background:${['#FFD700','#FFA500','#FF6B9D','#7d5fff'][Math.floor(Math.random()*4)]};left:${Math.random()*100}%;top:-10px;z-index:99999;pointer-events:none;border-radius:50%;animation:confettiFall ${2+Math.random()*2}s linear forwards;`;
document.body.appendChild(confetti);
setTimeout(()=>confetti.remove(),4000);
},i*50);
}
}
function showStyledToast(message,type='info',duration=3000){
const icons={success:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è',shiny:'‚ú®',legendary:'üëë'};
const toast=document.createElement('div');
toast.className=`styled-toast styled-toast--${type}`;
toast.innerHTML=`<div class="toast-icon">${icons[type]||icons.info}</div><div class="toast-message">${message}</div>`;
toast.style.cssText=`position:fixed;top:80px;right:20px;background:white;border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(0,0,0,0.15);transform:translateX(400px);transition:transform 0.4s cubic-bezier(0.68,-0.55,0.265,1.55);z-index:10000;max-width:320px;border-left:4px solid ${type==='success'?'var(--emotion-success)':type==='error'?'var(--emotion-danger)':type==='warning'?'var(--emotion-warning)':type==='shiny'?'var(--emotion-shiny)':type==='legendary'?'var(--emotion-legendary)':'var(--expedition-accent-primary)'};`;
if(type==='shiny'||type==='legendary'){toast.style.background=type==='shiny'?'linear-gradient(135deg, #fbbf24, #f59e0b)':'linear-gradient(135deg, #a855f7, #d946ef)';toast.style.color='white';toast.style.border='none';}
document.body.appendChild(toast);
setTimeout(()=>toast.style.transform='translateX(0)',10);
setTimeout(()=>{
toast.style.transform='translateX(400px)';
setTimeout(()=>toast.remove(),300);
},duration);
}
// ===== EXPEDITION SYSTEM FUNCTIONS =====
function checkExpeditionTicketReset(){
    const now = Date.now();
    // Initialiser lastTicketResetTime si n√©cessaire
    if (!gameState.rogue.lastTicketResetTime) {
        gameState.rogue.lastTicketResetTime = now;
        gameState.rogue.ticketsAvailable = 5; // Initialiser √† 5 au lieu de 10
        saveGame();
        return false;
    }
    const lastReset = gameState.rogue.lastTicketResetTime;
    const dayInMs = 24 * 60 * 60 * 1000;
    
    if(now - lastReset >= dayInMs){
        gameState.rogue.ticketsAvailable = 5;
        gameState.rogue.lastTicketResetTime = now;
        gameState.rogue.expeditionResetTime = null;
        saveGame();
        return true;
    }
    // Si ticketsAvailable n'existe pas ou est > 5, le corriger
    if (!gameState.rogue.ticketsAvailable || gameState.rogue.ticketsAvailable > 5) {
        gameState.rogue.ticketsAvailable = 5;
        saveGame();
    }
    return false;
}

function getNextTicketTimer(){
    const now = Date.now();
    const lastReset = gameState.rogue.lastTicketResetTime || now;
    const dayInMs = 24 * 60 * 60 * 1000;
    const nextReset = lastReset + dayInMs;
    const msUntilReset = nextReset - now;
    
    if(msUntilReset <= 0){
        return {hours: 0, minutes: 0};
    }
    
    const hours = Math.floor(msUntilReset / (1000 * 60 * 60));
    const minutes = Math.floor((msUntilReset % (1000 * 60 * 60)) / (1000 * 60));
    return {hours, minutes};
}

function renderExpeditionPage(){
    const container = document.getElementById('expedition-container');
    if(!container) return;
    
    checkExpeditionTicketReset();
    
    // V√©rifier si c'est la premi√®re visite et afficher le tutoriel
    if(!gameState.rogue.expeditionTutorialSeen) {
        setTimeout(() => {
            showExpeditionTutorial();
        }, 300);
    }
    
    // --- FIX BUDDY PARSING ---
    let buddyId = gameState.buddy.activeBuddyId;
    let isBuddyShiny = false;
    let buddyName = 'Aucun Buddy';
    let buddySprite = 'assets/POKEMON PNG/buddies/buddy_empty.png';

    if (buddyId) {
        // Gestion du format "25_shiny"
        if (typeof buddyId === 'string' && buddyId.includes('_')) {
            isBuddyShiny = true;
            buddyId = parseInt(buddyId.split('_')[0]);
        } else {
            // V√©rifier si c'est un shiny dans les donn√©es sauvegard√©es
            const buddyData = gameState.buddy.buddies[buddyId];
            if (buddyData && buddyData.isShiny) isBuddyShiny = true;
        }
        
        buddyName = FRENCH_NAMES[buddyId];
        buddySprite = getAnimatedSpriteUrl(buddyId, isBuddyShiny);
    }
    // -------------------------
    
    const timer = getNextTicketTimer();
    const tickets = gameState.rogue.ticketsAvailable;
    
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(15, 15, 30, 0.98), rgba(25, 20, 45, 0.98)); padding: 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 8px 40px rgba(125, 95, 255, 0.4); border: 2px solid rgba(125, 95, 255, 0.5); animation: fadeIn 0.5s ease;">
            <h1 style="text-align: center; margin-bottom: 30px; font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #7d5fff, #20d5d2, #ffd700); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 0 30px rgba(125, 95, 255, 0.5); animation: pulse 3s infinite;">üó∫Ô∏è Exp√©dition Shiny Hunt</h1>
            
            <div style="display: flex; align-items: center; gap: 20px; background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 20px rgba(125, 95, 255, 0.3); border: 2px solid rgba(125, 95, 255, 0.4); animation: slideInLeft 0.5s ease;">
                <img src="${buddySprite}" style="width: 80px; height: 80px; image-rendering: pixelated; border-radius: 12px; border: 2px solid rgba(125, 95, 255, 0.3); box-shadow: 0 0 15px rgba(125, 95, 255, 0.2); object-fit: contain; object-position: center;">
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: #fff; font-size: 1.2em; margin-bottom: 5px; text-shadow: 0 0 10px rgba(125, 95, 255, 0.5);">${buddyName}</div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Votre compagnon d'aventure</div>
                </div>
            </div>
            
            <button onclick="showBuddyManagement()" class="btn btn--outline btn--large" style="padding: 12px; margin-bottom: 20px; width: 100%; border: 2px solid rgba(125, 95, 255, 0.5); color: #7d5fff; background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9)); font-weight: 600; transition: all 0.3s;" onmouseenter="this.style.background='rgba(125, 95, 255, 0.2)'; this.style.borderColor='rgba(125, 95, 255, 0.8)'; this.style.transform='translateY(-2px)'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9))'; this.style.borderColor='rgba(125, 95, 255, 0.5)'; this.style.transform='translateY(0)'">
                üêæ G√©rer mon Buddy
            </button>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 20px rgba(125, 95, 255, 0.3); border: 2px solid rgba(125, 95, 255, 0.4); animation: slideInUp 0.6s ease; transition: transform 0.3s, box-shadow 0.3s;" onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(125, 95, 255, 0.5)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(125, 95, 255, 0.3)'">
                    <div style="font-size: 2.5em; margin-bottom: 10px; animation: bounce 2s infinite;">üé´</div>
                    <div style="font-weight: 700; color: #fff; font-size: 1.8em; margin-bottom: 5px; text-shadow: 0 0 15px rgba(125, 95, 255, 0.6);">${tickets}</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.95em; font-weight: 500;">Tickets disponibles</div>
                    ${tickets < 5 ? `<div id="expedition-ticket-timer" style="color: rgba(255,255,255,0.6); font-size: 0.85em; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">Recharge dans : ${timer.hours}h ${timer.minutes}m</div>` : ''}
                </div>
                <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3); border: 2px solid rgba(255, 215, 0, 0.4); animation: slideInUp 0.7s ease; transition: transform 0.3s, box-shadow 0.3s;" onmouseenter="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 30px rgba(255, 215, 0, 0.5)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(255, 215, 0, 0.3)'">
                    <div style="font-size: 2.5em; margin-bottom: 10px; animation: shine 2s infinite;">‚ú®</div>
                    <div style="font-weight: 700; color: #ffd700; font-size: 1.8em; margin-bottom: 5px; text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);">${gameState.rogue.totalShinyTokens || 0}</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 0.95em; font-weight: 500;">Shiny Tokens</div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(125, 95, 255, 0.3); border: 2px solid rgba(125, 95, 255, 0.4); animation: fadeIn 0.8s ease;">
                <h3 style="color: #fff; margin-bottom: 20px; font-size: 22px; font-weight: 700; text-align: center; text-shadow: 0 0 15px rgba(125, 95, 255, 0.5);">üìä Statistiques Globales</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: rgba(125, 95, 255, 0.1); border-radius: 12px; border: 1px solid rgba(125, 95, 255, 0.3); transition: all 0.3s;" onmouseenter="this.style.background='rgba(125, 95, 255, 0.2)'; this.style.transform='scale(1.05)'" onmouseleave="this.style.background='rgba(125, 95, 255, 0.1)'; this.style.transform='scale(1)'">
                        <div style="font-weight: 700; color: #7d5fff; font-size: 1.5em; margin-bottom: 5px; text-shadow: 0 0 10px rgba(125, 95, 255, 0.5);">${gameState.rogue.runsCompleted || 0}</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.95em; font-weight: 500;">Runs compl√©t√©es</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(32, 213, 210, 0.1); border-radius: 12px; border: 1px solid rgba(32, 213, 210, 0.3); transition: all 0.3s;" onmouseenter="this.style.background='rgba(32, 213, 210, 0.2)'; this.style.transform='scale(1.05)'" onmouseleave="this.style.background='rgba(32, 213, 210, 0.1)'; this.style.transform='scale(1)'">
                        <div style="font-weight: 700; color: #FFFFFF; font-size: 1.5em; margin-bottom: 5px; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);">${gameState.rogue.fullClearsCount || 0}</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.95em; font-weight: 500;">Full Clears</div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; gap: 15px;">
                <button onclick="showExpeditionPrepModal()" class="btn btn--primary btn--large" style="padding: 20px; font-size: 1.2em; background: linear-gradient(135deg, #7d5fff, #20d5d2); border: none; color: white; box-shadow: 0 4px 20px rgba(125, 95, 255, 0.4); font-weight: 700; transition: all 0.3s; animation: slideInUp 0.8s ease;" ${tickets === 0 ? 'disabled' : ''} onmouseenter="if(!this.disabled) {this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 30px rgba(125, 95, 255, 0.6)'}" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(125, 95, 255, 0.4)'">
                    üöÄ ${tickets > 0 ? 'D√©marrer l\'Exp√©dition' : 'Plus de tickets disponibles'}
                </button>
                <button onclick="openShinyTokenShop()" class="btn btn--secondary btn--large" style="padding: 15px; background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9)); border: 2px solid rgba(255, 215, 0, 0.5); color: #ffd700; font-weight: 600; transition: all 0.3s; animation: slideInUp 0.9s ease;" onmouseenter="this.style.background='rgba(255, 215, 0, 0.2)'; this.style.borderColor='rgba(255, 215, 0, 0.8)'; this.style.transform='translateY(-2px)'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9))'; this.style.borderColor='rgba(255, 215, 0, 0.5)'; this.style.transform='translateY(0)'">
                    üíé Boutique Shiny Tokens
                </button>
                <button onclick="showExpeditionTutorial()" class="btn btn--outline btn--large" style="padding: 15px; border: 2px solid rgba(125,95,255,0.5); color: #7d5fff; background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9)); font-weight: 600; transition: all 0.3s; animation: slideInUp 1s ease;" onmouseenter="this.style.background='rgba(125, 95, 255, 0.2)'; this.style.borderColor='rgba(125, 95, 255, 0.8)'; this.style.transform='translateY(-2px)'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9))'; this.style.borderColor='rgba(125,95,255,0.5)'; this.style.transform='translateY(0)'">
                    üìö Tutoriel Shiny Hunting
                </button>
            </div>
        </div>
    `;
}

// Fonction pour afficher le tutoriel de l'Exp√©dition (Shiny Hunting)
window.showExpeditionTutorial = function() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
        overflow-y: auto; padding: 20px;
    `;
    
    let currentStep = 0;
    const steps = [
        {
            title: '‚ú® Bienvenue dans l\'Exp√©dition Shiny Hunt !',
            content: `
                <p style="font-size: 1.1em; margin-bottom: 20px; color: rgba(255,255,255,0.9);">
                    L'<strong style="color: #7d5fff;">Exp√©dition</strong> est un mode de jeu roguelike sp√©cialement con√ßu pour le <strong style="color: #ffd700;">Shiny Hunting</strong> !
                </p>
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">
                    Votre objectif : capturer des Pok√©mon en <strong style="color: #FFFFFF;">cha√Æne</strong> pour augmenter vos chances de trouver des <strong style="color: #ffd700;">Shinies</strong> !
                </p>
                <div style="background: rgba(125, 95, 255, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(125, 95, 255, 0.4); margin-top: 20px;">
                    <p style="color: #ffd700; font-weight: 700; margin-bottom: 10px;">üí° Le principe</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Chaque capture r√©ussie augmente votre cha√Æne, peu importe le Pok√©mon ! Plus votre cha√Æne est longue, plus vos chances de trouver des Shinies augmentent !
                    </p>
                </div>
            `
        },
        {
            title: 'üîó Le Syst√®me de Cha√Æne',
            content: `
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.9);">
                    Le <strong style="color: #FFFFFF;">syst√®me de cha√Æne</strong> est au c≈ìur du Shiny Hunting :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li>Chaque <strong style="color: #FFFFFF;">capture r√©ussie</strong> augmente votre cha√Æne, peu importe le Pok√©mon</li>
                    <li>La cha√Æne augmente vos chances de Shiny de <strong style="color: #ffd700;">+0.5% par capture</strong></li>
                    <li>Plus la cha√Æne est longue, plus les chances augmentent !</li>
                    <li>üíæ Votre cha√Æne est <strong style="color: #4caf50;">conserv√©e entre les runs</strong> si vous terminez l'exp√©dition</li>
                </ul>
                <div style="background: rgba(32, 213, 210, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(32, 213, 210, 0.4); margin-top: 20px;">
                    <p style="color: #FFFFFF; font-weight: 700; margin-bottom: 10px;">üìä Exemple</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Cha√Æne de 10 captures = <strong style="color: #ffd700;">+5%</strong> de chance Shiny !<br>
                        Cha√Æne de 50 captures = <strong style="color: #ffd700;">+25%</strong> de chance Shiny !
                    </p>
                </div>
            `
        },
        {
            title: '‚ö†Ô∏è Attention : Briser la Cha√Æne',
            content: `
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.9);">
                    Votre cha√Æne est <strong style="color: #f44336;">fragile</strong> ! Elle se brise si :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li>‚ùå Un Pok√©mon <strong style="color: #f44336;">s'enfuit</strong> (flee)</li>
                    <li>‚ùå Une <strong style="color: #f44336;">capture √©choue</strong></li>
                </ul>
                <div style="background: rgba(244, 67, 54, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(244, 67, 54, 0.4); margin-top: 20px;">
                    <p style="color: #f44336; font-weight: 700; margin-bottom: 10px;">‚ö†Ô∏è Important</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Quand la cha√Æne se brise, vos chances de Shiny <strong>retombent √† z√©ro</strong> !<br>
                        Il faut recommencer depuis le d√©but...
                    </p>
                </div>
            `
        },
        {
            title: 'üéØ Le Pok√©mon Cible',
            content: `
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.9);">
                    Avant de partir en exp√©dition, vous pouvez choisir un <strong style="color: #FFFFFF;">Pok√©mon cible</strong> :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li>üéØ Le Pok√©mon cible a <strong style="color: #ffd700;">+5%</strong> de chance d'appara√Ætre</li>
                    <li>‚ú® Si vous capturez votre cible en Shiny, vous gagnez <strong style="color: #ffd700;">20 Shiny Tokens</strong> !</li>
                    <li>üåç Vous pouvez aussi choisir "Wild" pour une exp√©dition al√©atoire</li>
                </ul>
                <div style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.4); margin-top: 20px;">
                    <p style="color: #ffd700; font-weight: 700; margin-bottom: 10px;">üí° Astuce</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Concentrez-vous sur un seul Pok√©mon pour maximiser votre cha√Æne et vos chances de Shiny !
                    </p>
                </div>
            `
        },
        {
            title: 'üêæ Votre Buddy',
            content: `
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.9);">
                    Votre <strong style="color: #7d5fff;">Buddy</strong> est votre compagnon d'aventure :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li>üêæ Il gagne de l'<strong style="color: #4caf50;">XP</strong> √† chaque capture</li>
                    <li>üõ°Ô∏è Certains talents peuvent <strong style="color: #4caf50;">sauvegarder votre cha√Æne</strong> une fois</li>
                    <li>‚ú® D'autres talents augmentent vos <strong style="color: #ffd700;">chances de Shiny</strong></li>
                    <li>üéÅ Plus votre Buddy est niveau √©lev√©, plus il est utile !</li>
                </ul>
                <div style="background: rgba(76, 175, 80, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(76, 175, 80, 0.4); margin-top: 20px;">
                    <p style="color: #4caf50; font-weight: 700; margin-bottom: 10px;">üí™ Talents sp√©ciaux</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Au niveau 6, votre Buddy peut obtenir "Protecteur" qui sauvegarde votre cha√Æne une fois !
                    </p>
                </div>
            `
        },
        {
            title: 'üéí Les Items et Ressources',
            content: `
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.9);">
                    Utilisez des <strong style="color: #7d5fff;">items</strong> pour am√©liorer vos chances :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li>üçì <strong>Framby</strong> : Augmente le taux de capture</li>
                    <li>üçç <strong>Pinap</strong> : Double les r√©compenses</li>
                    <li>üçí <strong>Ceriz</strong> : R√©duit les chances de fuite</li>
                    <li>üåÄ <strong>Encens</strong> : Augmente les spawns</li>
                </ul>
                <div style="background: rgba(125, 95, 255, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(125, 95, 255, 0.4); margin-top: 20px;">
                    <p style="color: #7d5fff; font-weight: 700; margin-bottom: 10px;">üíé Shiny Tokens</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Gagnez des <strong style="color: #ffd700;">Shiny Tokens</strong> en capturant des Shinies !<br>
                        Utilisez-les dans la boutique pour acheter des am√©liorations permanentes.
                    </p>
                </div>
            `
        },
        {
            title: 'üèÜ Les R√©compenses',
            content: `
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.9);">
                    Chaque capture vous rapporte :
                </p>
                <ul style="text-align: left; margin: 15px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li>üí∞ <strong>Coins</strong> selon la raret√© du Pok√©mon</li>
                    <li>‚≠ê <strong>XP</strong> pour progresser</li>
                    <li>üêæ <strong>XP Buddy</strong> pour faire √©voluer votre compagnon</li>
                    <li>üíé <strong>Shards</strong> (rare) pour des am√©liorations</li>
                    <li>‚ú® <strong>Shiny Tokens</strong> si c'est un Shiny !</li>
                </ul>
                <div style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.4); margin-top: 20px;">
                    <p style="color: #ffd700; font-weight: 700; margin-bottom: 10px;">üéØ Bonus Cible</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Un Shiny de votre Pok√©mon cible = <strong>20 Shiny Tokens</strong> !<br>
                        Un Shiny normal = <strong>5 Shiny Tokens</strong>
                    </p>
                </div>
            `
        },
        {
            title: 'üéÆ Comment Jouer',
            content: `
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.9);">
                    Le d√©roulement d'une exp√©dition :
                </p>
                <ol style="text-align: left; margin: 15px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li><strong>Choisissez votre Pok√©mon cible</strong> (ou Wild)</li>
                    <li><strong>S√©lectionnez jusqu'√† 3 items</strong> √† emporter</li>
                    <li><strong>Explorez les √©tages</strong> et rencontrez des Pok√©mon</li>
                    <li><strong>Capturez en cha√Æne</strong> pour augmenter vos chances</li>
                    <li><strong>√âvitez les fuites</strong> pour ne pas briser la cha√Æne</li>
                    <li><strong>Atteignez le Boss</strong> pour des r√©compenses maximales !</li>
                </ol>
                <div style="background: rgba(32, 213, 210, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(32, 213, 210, 0.4); margin-top: 20px;">
                    <p style="color: #FFFFFF; font-weight: 700; margin-bottom: 10px;">üí° Strat√©gie</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Utilisez des Framby et Ceriz pour √©viter les fuites et maintenir votre cha√Æne le plus longtemps possible !
                    </p>
                </div>
            `
        },
        {
            title: '‚ú® Pr√™t pour la Chasse !',
            content: `
                <p style="font-size: 1.2em; margin-bottom: 20px; color: rgba(255,255,255,0.9);">
                    Vous √™tes maintenant pr√™t √† devenir un <strong style="color: #ffd700;">Ma√Ætre Shiny Hunter</strong> ! üéØ
                </p>
                <div style="background: linear-gradient(135deg, rgba(125, 95, 255, 0.3), rgba(32, 213, 210, 0.3)); padding: 20px; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.4); margin: 20px 0;">
                    <p style="color: #ffd700; font-weight: 700; font-size: 1.1em; margin-bottom: 15px;">üéØ Rappel des points cl√©s :</p>
                    <ul style="text-align: left; margin: 10px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                        <li>üîó <strong>Cha√Æne = Plus de chances Shiny</strong></li>
                        <li>‚ö†Ô∏è <strong>Fuite = Cha√Æne bris√©e</strong></li>
                        <li>üéØ <strong>Cible = +5% spawn + 20 tokens si Shiny</strong></li>
                        <li>üêæ <strong>Buddy = Compagnon utile</strong></li>
                    </ul>
                </div>
                <p style="color: #7d5fff; font-size: 1.3em; font-weight: 700; margin-top: 20px;">
                    Bonne chasse, Dresseur ! üåü‚ú®
                </p>
            `
        }
    ];
    
    function renderStep() {
        const step = steps[currentStep];
        modal.innerHTML = `
            <div style="background: linear-gradient(135deg, rgba(30, 30, 50, 0.98), rgba(20, 20, 40, 0.98)); 
                        border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; 
                        border: 3px solid rgba(125, 95, 255, 0.5); position: relative; box-shadow: 0 0 30px rgba(125, 95, 255, 0.3);">
                <h2 style="color: #7d5fff; margin-bottom: 25px; font-size: 2.5em; text-align: center; text-shadow: 0 0 20px rgba(125, 95, 255, 0.5);">
                    ${step.title}
                </h2>
                <div style="color: white; line-height: 1.8; font-size: 1.05em; margin-bottom: 30px;">
                    ${step.content}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                    <button onclick="expeditionTutorialPrevious()" 
                            class="btn btn--secondary" 
                            style="padding: 12px 24px; background: rgba(125, 95, 255, 0.2); border: 2px solid rgba(125, 95, 255, 0.5); color: #7d5fff;"
                            ${currentStep === 0 ? 'disabled' : ''}>
                        ‚Üê Pr√©c√©dent
                    </button>
                    <div style="color: rgba(255,255,255,0.6); font-weight: 600;">
                        ${currentStep + 1} / ${steps.length}
                    </div>
                    ${currentStep < steps.length - 1 ? `
                        <button onclick="expeditionTutorialNext()" 
                                class="btn btn--primary" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #7d5fff, #20d5d2); border: none; color: white; font-weight: 700;">
                            Suivant ‚Üí
                        </button>
                    ` : `
                        <button onclick="closeExpeditionTutorial()" 
                                class="btn btn--primary" 
                                style="padding: 12px 24px; background: linear-gradient(135deg, #7d5fff, #20d5d2); border: none; color: white; font-weight: 700;">
                            Commencer la Chasse ! üéØ
                        </button>
                    `}
                </div>
            </div>
        `;
    }
    
    window.expeditionTutorialNext = function() {
        if (currentStep < steps.length - 1) {
            currentStep++;
            renderStep();
        }
    };
    
    window.expeditionTutorialPrevious = function() {
        if (currentStep > 0) {
            currentStep--;
            renderStep();
        }
    };
    
    window.closeExpeditionTutorial = function() {
        // Marquer le tutoriel comme vu
        if (!gameState.rogue) {
            gameState.rogue = {
                ticketsAvailable: 5,
                lastTicketResetTime: Date.now()
            };
        }
        // S'assurer que ticketsAvailable est initialis√© √† 5 si non d√©fini ou > 5
        if (!gameState.rogue.ticketsAvailable || gameState.rogue.ticketsAvailable > 5) {
            gameState.rogue.ticketsAvailable = 5;
        }
        if (!gameState.rogue.lastTicketResetTime) {
            gameState.rogue.lastTicketResetTime = Date.now();
        }
        gameState.rogue.expeditionTutorialSeen = true;
        saveGame();
        
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            modal.remove();
        delete window.expeditionTutorialNext;
        delete window.expeditionTutorialPrevious;
        delete window.closeExpeditionTutorial;
    }, 300);
};

renderStep();
document.body.appendChild(modal);
};

// Fonction pour afficher les informations sur les Lootboxes
window.showLootboxInfo = function() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.95); z-index: 10000; 
        display: flex; align-items: center; justify-content: center;
        overflow-y: auto; padding: 20px;
    `;
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(30, 30, 50, 0.98), rgba(20, 20, 40, 0.98)); 
                    border-radius: 20px; padding: 40px; max-width: 600px; width: 100%; 
                    border: 3px solid rgba(255, 215, 0, 0.5); position: relative; box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
                    max-height: calc(100vh - 40px); display: flex; flex-direction: column; overflow: hidden;">
            <button onclick="this.closest('.modal').remove()" 
                    style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); 
                           border: none; color: white; font-size: 24px; width: 40px; height: 40px; 
                           border-radius: 50%; cursor: pointer; display: flex; align-items: center; 
                           justify-content: center; transition: all 0.3s; z-index: 10;"
                    onmouseenter="this.style.background='rgba(255,255,255,0.2)'"
                    onmouseleave="this.style.background='rgba(255,255,255,0.1)'">√ó</button>
            
            <div style="overflow-y: auto; flex: 1; padding-right: 10px; max-height: calc(100vh - 200px);">
                <h2 style="color: #ffd700; margin-bottom: 25px; font-size: 2.5em; text-align: center; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);">
                    üéÅ Les Lootboxes
                </h2>
                
                <div style="color: white; line-height: 1.8; font-size: 1.05em;">
                <p style="font-size: 1.1em; margin-bottom: 20px; color: rgba(255,255,255,0.9);">
                    Les <strong style="color: #ffd700;">Lootboxes</strong> sont des bo√Ætes myst√©rieuses qui contiennent des r√©compenses vari√©es !
                </p>
                
                <div style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.4); margin: 20px 0;">
                    <p style="color: #ffd700; font-weight: 700; margin-bottom: 10px;">üí° Comment √ßa marche ?</p>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 10px;">
                        Chaque Lootbox contient plusieurs items al√©atoires : Pok√©balls, Baies, Objets sp√©ciaux, et parfois m√™me des <strong style="color: #ffd700;">surprises exceptionnelles</strong> !
                    </p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Plus la box est rare, plus les r√©compenses sont pr√©cieuses !
                    </p>
                </div>
                
                <div style="background: rgba(125, 95, 255, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(125, 95, 255, 0.4); margin: 20px 0;">
                    <p style="color: #7d5fff; font-weight: 700; margin-bottom: 10px;">‚ú® Les Surprises</p>
                    <p style="color: rgba(255,255,255,0.9);">
                        Avec un peu de <strong style="color: #ffd700;">chance</strong>, vous pourriez d√©couvrir :
                    </p>
                    <ul style="text-align: left; margin: 10px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                        <li>üí∞ Des <strong>coins</strong> en grande quantit√©</li>
                        <li>üíé Des <strong>shards</strong> rares pour les am√©liorations</li>
                        <li>üé´ Des <strong>tickets d'exp√©dition</strong> pour partir √† l'aventure</li>
                        <li>ü•ö Des <strong>≈ìufs myst√©rieux</strong> contenant des Pok√©mon d'autres r√©gions</li>
                        <li>üéÅ Et bien d'autres <strong>tr√©sors</strong> cach√©s !</li>
                    </ul>
                </div>
                
                <div style="background: rgba(236, 72, 153, 0.2); padding: 15px; border-radius: 12px; border: 2px solid rgba(236, 72, 153, 0.4); margin: 20px 0;">
                    <p style="color: #ec4899; font-weight: 700; margin-bottom: 10px;">üéØ Types de Boxes</p>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 10px;">
                        Il existe plusieurs types de Lootboxes, chacune avec ses propres chances :
                    </p>
                    <ul style="text-align: left; margin: 10px 0; padding-left: 30px; color: rgba(255,255,255,0.9); line-height: 1.8;">
                        <li><strong>üì¶ Lootbox</strong> : Parfaite pour d√©buter</li>
                        <li><strong>üéÅ Rare Box</strong> : Contient des items rares garantis</li>
                        <li><strong>üíé Super Rare Box</strong> : Des r√©compenses premium</li>
                        <li><strong>üß∞ Masterbox</strong> : Le top du top avec des jackpots possibles !</li>
                    </ul>
                </div>
                
                <p style="color: rgba(255,255,255,0.8); font-style: italic; margin-top: 25px; text-align: center;">
                    Ouvrez-en plusieurs pour maximiser vos chances de trouver des tr√©sors ! üåü
                </p>
                </div>
            </div>
            
            <div style="flex-shrink: 0; padding-top: 20px; border-top: 2px solid rgba(255, 215, 0, 0.3); margin-top: 20px; text-align: center;">
                <button onclick="this.closest('.modal').remove()" 
                        class="btn btn--primary" 
                        style="padding: 12px 24px; background: linear-gradient(135deg, #ffd700, #ffa500); border: none; color: #1a1a2e; font-weight: 700; width: 100%;">
                    Compris ! üéÅ
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Fermer en cliquant en dehors
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
};

window.showExpeditionPrepModal = function(){
    if(gameState.rogue.ticketsAvailable === 0){
        showToast('‚ùå Plus de tickets disponibles ! Attendez la r√©initialisation quotidienne.', 'error');
            return;
    }
    
    const buddyId = gameState.buddy.activeBuddyId;
    const buddySprite = buddyId ? 
        getAnimatedSpriteUrl(buddyId, false) :
        'assets/POKEMON PNG/buddies/buddy_empty.png';
    const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'Aucun Buddy';
    const buddyData = buddyId ? gameState.buddy.buddies[buddyId] : null;
    const buddyLevel = buddyData ? buddyData.level : 0;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';
    
    // Filtrer uniquement les pok√©mons captur√©s
    const capturedPokemon = Array.from(gameState.captured || []).sort((a, b) => a - b);
    const pokemonOptions = capturedPokemon.length > 0 
        ? capturedPokemon.map(id => `<option value="${id}">#${String(id).padStart(3,'0')} ${FRENCH_NAMES[id]}</option>`).join('')
        : '<option value="" disabled>Aucun Pok√©mon captur√©</option>';
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(15, 15, 30, 0.98), rgba(25, 20, 45, 0.98)); padding: 30px; border-radius: 20px; max-width: 600px; width: 100%; box-shadow: 0 8px 40px rgba(125, 95, 255, 0.5); border: 2px solid rgba(125, 95, 255, 0.5); animation: fadeIn 0.4s ease;">
            <h2 style="color: #7d5fff; margin-bottom: 25px; text-align: center; font-size: 28px; font-weight: 700; text-shadow: 0 0 20px rgba(125, 95, 255, 0.5);">üöÄ Pr√©paration de l'Exp√©dition</h2>
            
            <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid rgba(125, 95, 255, 0.4); box-shadow: 0 4px 15px rgba(125, 95, 255, 0.2); animation: slideInLeft 0.5s ease;">
                <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.2em; font-weight: 700;">üêæ Buddy</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="${buddySprite}" style="width: 64px; height: 64px; image-rendering: pixelated; object-fit: contain; object-position: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #fff;">${buddyName}</div>
                        ${buddyLevel > 0 ? `<div style="color: rgba(255,255,255,0.8); font-size: 0.9em;">Niveau ${buddyLevel}</div>` : '<div style="color: rgba(255,255,255,0.6); font-size: 0.9em;">Aucun Buddy s√©lectionn√©</div>'}
                    </div>
                    <button onclick="window.showBuddyManagement && window.showBuddyManagement(); this.closest('.modal').remove();" class="btn btn--outline" style="padding: 8px 16px;">Changer</button>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid rgba(32, 213, 210, 0.4); box-shadow: 0 4px 15px rgba(32, 213, 210, 0.2); animation: slideInLeft 0.6s ease;">
                <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.2em; font-weight: 700;">üéØ Target Pok√©mon</h3>
                <select id="expedition-target-select" style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid rgba(32, 213, 210, 0.5); font-size: 1em; margin-bottom: 12px; background: linear-gradient(135deg, rgba(15, 15, 30, 0.9), rgba(25, 20, 45, 0.9)); color: #fff; transition: all 0.3s;" onfocus="this.style.borderColor='rgba(32, 213, 210, 0.8)'; this.style.boxShadow='0 0 15px rgba(32, 213, 210, 0.3)'" onblur="this.style.borderColor='rgba(32, 213, 210, 0.5)'; this.style.boxShadow='none'">
                    <option value="wild" style="background: rgba(15, 15, 30, 0.95);">üåç Wild (Al√©atoire)</option>
                    ${capturedPokemon.length > 0 ? pokemonOptions : '<option value="" disabled style="background: rgba(15, 15, 30, 0.95);">Aucun Pok√©mon captur√©</option>'}
                </select>
                <div id="target-info" style="color: rgba(255,255,255,0.8); font-size: 0.95em; text-align: center; padding: 10px; background: rgba(32, 213, 210, 0.1); border-radius: 8px;">S√©lectionnez un Pok√©mon cible pour augmenter vos chances de le trouver</div>
            </div>
            
            <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid rgba(255, 215, 0, 0.4); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); animation: slideInLeft 0.7s ease;">
                <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.2em; font-weight: 700;">üéí Items (max 3)</h3>
                <div id="expedition-items-selection" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    ${gameState.inventory.framby > 0 ? `<label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9)); border: 2px solid rgba(244, 67, 54, 0.4); border-radius: 10px; cursor: pointer; color: #fff; transition: all 0.3s;" onmouseenter="this.style.background='rgba(244, 67, 54, 0.2)'; this.style.borderColor='rgba(244, 67, 54, 0.6)'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9))'; this.style.borderColor='rgba(244, 67, 54, 0.4)'"><input type="checkbox" value="framby" style="width: 20px; height: 20px; accent-color: #f44336;">üçì Framby (${gameState.inventory.framby})</label>` : ''}
                    ${gameState.inventory.pinap > 0 ? `<label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9)); border: 2px solid rgba(255, 193, 7, 0.4); border-radius: 10px; cursor: pointer; color: #fff; transition: all 0.3s;" onmouseenter="this.style.background='rgba(255, 193, 7, 0.2)'; this.style.borderColor='rgba(255, 193, 7, 0.6)'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9))'; this.style.borderColor='rgba(255, 193, 7, 0.4)'"><input type="checkbox" value="pinap" style="width: 20px; height: 20px; accent-color: #ffc107;">üçç Pinap (${gameState.inventory.pinap})</label>` : ''}
                    ${gameState.inventory.ceriz > 0 ? `<label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9)); border: 2px solid rgba(156, 39, 176, 0.4); border-radius: 10px; cursor: pointer; color: #fff; transition: all 0.3s;" onmouseenter="this.style.background='rgba(156, 39, 176, 0.2)'; this.style.borderColor='rgba(156, 39, 176, 0.6)'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9))'; this.style.borderColor='rgba(156, 39, 176, 0.4)'"><input type="checkbox" value="ceriz" style="width: 20px; height: 20px; accent-color: #9c27b0;">üçí Ceriz (${gameState.inventory.ceriz})</label>` : ''}
                    ${gameState.inventory.incensefleur > 0 ? `<label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9)); border: 2px solid rgba(33, 150, 243, 0.4); border-radius: 10px; cursor: pointer; color: #fff; transition: all 0.3s;" onmouseenter="this.style.background='rgba(33, 150, 243, 0.2)'; this.style.borderColor='rgba(33, 150, 243, 0.6)'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(20, 20, 35, 0.9), rgba(30, 25, 50, 0.9))'; this.style.borderColor='rgba(33, 150, 243, 0.4)'"><input type="checkbox" value="incensefleur" style="width: 20px; height: 20px; accent-color: #2196f3;">üåÄ Encens (${gameState.inventory.incensefleur})</label>` : ''}
                </div>
            </div>
            
            <div style="display: grid; gap: 10px; margin-top: 25px;">
                <button onclick="startExpeditionRun()" class="btn btn--primary btn--large" style="padding: 18px; font-size: 1.2em; background: linear-gradient(135deg, #7d5fff, #20d5d2); border: none; color: white; font-weight: 700; box-shadow: 0 4px 20px rgba(125, 95, 255, 0.4); transition: all 0.3s; animation: slideInUp 0.8s ease;" onmouseenter="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 30px rgba(125, 95, 255, 0.6)'" onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(125, 95, 255, 0.4)'">üöÄ LANCER L'EXP√âDITION</button>
                <button onclick="this.closest('.modal').remove()" class="btn btn--outline" style="padding: 12px; border: 2px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.05); transition: all 0.3s;" onmouseenter="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.5)'" onmouseleave="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.3)'">Annuler</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const targetSelect = document.getElementById('expedition-target-select');
    if(targetSelect){
        targetSelect.addEventListener('change', function(){
            const targetInfo = document.getElementById('target-info');
            if(this.value === 'wild'){
                targetInfo.textContent = 'S√©lectionnez un Pok√©mon cible pour augmenter vos chances de le trouver';
            } else {
                const targetId = parseInt(this.value);
                const targetName = FRENCH_NAMES[targetId];
                targetInfo.textContent = `Cible: ${targetName} - Chance augment√©e de le trouver`;
            }
        });
    }
    
    const itemCheckboxes = modal.querySelectorAll('#expedition-items-selection input[type="checkbox"]');
    itemCheckboxes.forEach(cb => {
        cb.addEventListener('change', function(){
            const checked = modal.querySelectorAll('#expedition-items-selection input[type="checkbox"]:checked');
            if(checked.length > 3){
                this.checked = false;
                showToast('Maximum 3 items autoris√©s!', 'error');
            }
        });
    });
    
    modal.addEventListener('click', (e) => {
        if(e.target === modal) modal.remove();
    });
};

window.startExpeditionRun = function(){
    const modal = document.querySelector('.modal.active');
    if(!modal) return;
    
    const targetSelect = document.getElementById('expedition-target-select');
    const targetPokemonId = targetSelect && targetSelect.value !== 'wild' ? parseInt(targetSelect.value) : null;
    
    const selectedItems = [];
    const itemCheckboxes = modal.querySelectorAll('#expedition-items-selection input[type="checkbox"]:checked');
    itemCheckboxes.forEach(cb => {
        if(gameState.inventory[cb.value] > 0){
            selectedItems.push({id: cb.value, qty: 1});
        }
    });
    
    if(gameState.rogue.ticketsAvailable <= 0){
        showToast('Plus de tickets disponibles!', 'error');
        return;
    }
    
    gameState.rogue.ticketsAvailable--;
    gameState.rogue.runsStarted++;
    
    const maxFloors = EXPEDITION_CONFIG.baseFloors + (gameState.rogue.unlocks?.extraFloor ? 1 : 0);
    const baseBalls = EXPEDITION_CONFIG.baseBalls;
    
    // D√©terminer le type de ball par d√©faut selon l'upgrade
    let defaultBallType = 'pokeball';
    if (gameState.rogue.unlocks?.ballUpgrade2) {
        defaultBallType = 'ultraball';
    } else if (gameState.rogue.unlocks?.ballUpgrade1) {
        defaultBallType = 'greatball';
    }
    
    // Initialiser la cha√Æne depuis la cha√Æne persistante (si elle existe)
    const persistentChain = gameState.rogue.persistentChain || 0;
    
    runState = {
        active: true,
        startTime: Date.now(),
        targetPokemonId: targetPokemonId,
        buddyId: gameState.buddy.activeBuddyId,
        maxFloors: maxFloors,
        currentFloorIndex: 0,
        floorsData: [],
        ballsAvailable: baseBalls,
        defaultBallType: defaultBallType,
        ghostLives: 0,
        selectedItems: selectedItems,
        chain: persistentChain, // Commencer avec la cha√Æne persistante
        maxChain: persistentChain,
        chainBroken: false,
        modifiers: [],
        tempBuffs: [],
        rewards: {
            coins: 0,
            xp: 0,
            buddyXp: 0,
            items: {},
            pokemonCaptured: [],
            shiniesCount: 0,
            shardsEarned: [],
            shinyTokensEarned: 0
        }
    };
    
    // Appliquer l'effet des Restes (objet tenu)
    if (typeof getBuddyHeldItemEffect === 'function' && getBuddyHeldItemEffect('rogue_ghost_life')) {
        runState.ghostLives = (runState.ghostLives || 0) + 1;
    }
    
    modal.remove();
    generateExpeditionFloors();
    showExpeditionMap();
    
    // Cacher la barre de menu maintenant que l'exp√©dition commence
    const topBar = document.querySelector('.top-bar');
    const bottomNav = document.querySelector('.bottom-nav');
    const newBottomNav = document.querySelector('.new-bottom-nav');
    if(topBar) topBar.style.display = 'none';
    if(bottomNav) bottomNav.style.display = 'none';
    if(newBottomNav) newBottomNav.style.display = 'none';
};

// Fonction pour obtenir les informations sur l'upgrade de ball
function getBallUpgradeInfo() {
    const lvl1 = gameState.rogue.unlocks?.ballUpgrade1;
    const lvl2 = gameState.rogue.unlocks?.ballUpgrade2;
    
    if (!lvl1) {
        return {
            id: 'ballUpgrade1',
            name: 'Super Ball Upgrade',
            desc: 'Remplace vos Pok√© Balls par des Super Balls (+25% taux capture) en Exp√©dition.',
            price: EXPEDITION_CONFIG.shopPrices.ballUpgrade1,
            current: 'Pok√© Ball',
            next: 'Super Ball',
            icon: 'üîµ'
        };
    } else if (!lvl2) {
        return {
            id: 'ballUpgrade2',
            name: 'Hyper Ball Upgrade',
            desc: 'Remplace vos Super Balls par des Hyper Balls (+100% taux capture) en Exp√©dition.',
            price: EXPEDITION_CONFIG.shopPrices.ballUpgrade2,
            current: 'Super Ball',
            next: 'Hyper Ball',
            icon: '‚ö´'
        };
    } else {
        return {
            id: 'maxed',
            name: 'Ball Maxed',
            desc: 'Vous utilisez des Hyper Balls.',
            price: 0,
            current: 'Hyper Ball',
            next: 'Max',
            icon: '‚ö´'
        };
    }
}

window.openShinyTokenShop = function(){
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';
    
    const tokens = gameState.rogue.totalShinyTokens || 0;
    const ballUpgrade = getBallUpgradeInfo();
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(15, 15, 30, 0.98), rgba(25, 20, 45, 0.98)); padding: 30px; border-radius: 20px; max-width: 700px; width: 100%; box-shadow: 0 8px 40px rgba(125, 95, 255, 0.5); border: 2px solid rgba(125, 95, 255, 0.5); animation: fadeIn 0.4s ease;">
            <h2 style="color: #7d5fff; margin-bottom: 25px; text-align: center; font-size: 28px; font-weight: 700; text-shadow: 0 0 20px rgba(125, 95, 255, 0.5);">üíé Boutique Shiny Tokens</h2>
            <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); border-radius: 12px; border: 2px solid rgba(255, 215, 0, 0.4); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);">
                <div style="font-size: 1.5em; font-weight: 700; color: #ffd700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.5); animation: shine 2s infinite;">‚ú® ${tokens} Shiny Tokens disponibles</div>
            </div>
            
            <div style="display: grid; gap: 15px;">
                <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 12px; border: 2px solid ${gameState.rogue.unlocks.shinyCharmPermanent ? 'rgba(16, 185, 129, 0.6)' : 'rgba(125, 95, 255, 0.4)'}; box-shadow: 0 4px 15px ${gameState.rogue.unlocks.shinyCharmPermanent ? 'rgba(16, 185, 129, 0.2)' : 'rgba(125, 95, 255, 0.2)'}; transition: all 0.3s; animation: slideInLeft 0.5s ease;" onmouseenter="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 20px ${gameState.rogue.unlocks.shinyCharmPermanent ? 'rgba(16, 185, 129, 0.3)' : 'rgba(125, 95, 255, 0.3)'}'" onmouseleave="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 15px ${gameState.rogue.unlocks.shinyCharmPermanent ? 'rgba(16, 185, 129, 0.2)' : 'rgba(125, 95, 255, 0.2)'}'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: #fff; margin-bottom: 8px; font-size: 1.1em;">‚ú® Shiny Charm Permanent</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.95em;">+5% chance shiny permanente</div>
                        </div>
                        <button onclick="buyShinyTokenItem('shinyCharmPermanent', ${EXPEDITION_CONFIG.shopPrices.shinyCharmPermanent})" class="btn ${gameState.rogue.unlocks.shinyCharmPermanent ? 'btn--outline' : 'btn--primary'}" style="padding: 12px 24px; font-weight: 600; transition: all 0.3s;" ${gameState.rogue.unlocks.shinyCharmPermanent ? 'disabled' : ''} onmouseenter="if(!this.disabled) {this.style.transform='scale(1.05)'}" onmouseleave="this.style.transform='scale(1)'">
                            ${gameState.rogue.unlocks.shinyCharmPermanent ? '‚úÖ Achet√©' : `${EXPEDITION_CONFIG.shopPrices.shinyCharmPermanent}‚ú®`}
                        </button>
                    </div>
                </div>
                
                <!-- Ball Upgrade (Dynamique) -->
                <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 12px; border: 2px solid ${ballUpgrade.id === 'maxed' ? 'rgba(16, 185, 129, 0.6)' : 'rgba(32, 213, 210, 0.4)'}; box-shadow: 0 4px 15px ${ballUpgrade.id === 'maxed' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(32, 213, 210, 0.2)'}; transition: all 0.3s; animation: slideInLeft 0.6s ease;" onmouseenter="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 20px ${ballUpgrade.id === 'maxed' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(32, 213, 210, 0.3)'}'" onmouseleave="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 15px ${ballUpgrade.id === 'maxed' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(32, 213, 210, 0.2)'}'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: #fff; margin-bottom: 8px; font-size: 1.1em;">${ballUpgrade.icon} ${ballUpgrade.name}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.95em;">${ballUpgrade.desc}</div>
                            <div style="color: #ffd700; font-size: 0.8em; margin-top: 5px;">Actuel: ${ballUpgrade.current} ‚Üí ${ballUpgrade.next}</div>
                        </div>
                        <button onclick="buyShinyTokenItem('${ballUpgrade.id}', ${ballUpgrade.price})" class="btn ${ballUpgrade.id === 'maxed' ? 'btn--outline' : 'btn--primary'}" style="padding: 12px 24px; font-weight: 600; transition: all 0.3s;" ${ballUpgrade.id === 'maxed' ? 'disabled' : ''} onmouseenter="if(!this.disabled) {this.style.transform='scale(1.05)'}" onmouseleave="this.style.transform='scale(1)'">
                            ${ballUpgrade.id === 'maxed' ? '‚úÖ Maxed' : `${ballUpgrade.price}‚ú®`}
                        </button>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 25, 50, 0.95)); padding: 20px; border-radius: 12px; border: 2px solid ${gameState.rogue.unlocks.extraFloor ? 'rgba(16, 185, 129, 0.6)' : 'rgba(255, 215, 0, 0.4)'}; box-shadow: 0 4px 15px ${gameState.rogue.unlocks.extraFloor ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 215, 0, 0.2)'}; transition: all 0.3s; animation: slideInLeft 0.7s ease;" onmouseenter="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 20px ${gameState.rogue.unlocks.extraFloor ? 'rgba(16, 185, 129, 0.3)' : 'rgba(255, 215, 0, 0.3)'}'" onmouseleave="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 15px ${gameState.rogue.unlocks.extraFloor ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 215, 0, 0.2)'}'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: #fff; margin-bottom: 8px; font-size: 1.1em;">üó∫Ô∏è Extra Floor</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.95em;">+1 floor maximum par run</div>
                        </div>
                        <button onclick="buyShinyTokenItem('extraFloor', ${EXPEDITION_CONFIG.shopPrices.extraFloor})" class="btn ${gameState.rogue.unlocks.extraFloor ? 'btn--outline' : 'btn--primary'}" style="padding: 12px 24px; font-weight: 600; transition: all 0.3s;" ${gameState.rogue.unlocks.extraFloor ? 'disabled' : ''} onmouseenter="if(!this.disabled) {this.style.transform='scale(1.05)'}" onmouseleave="this.style.transform='scale(1)'">
                            ${gameState.rogue.unlocks.extraFloor ? '‚úÖ Achet√©' : `${EXPEDITION_CONFIG.shopPrices.extraFloor}‚ú®`}
                        </button>
                    </div>
                </div>
            </div>
            
            <button onclick="this.closest('.modal').remove()" class="btn btn--outline btn--full-width" style="margin-top: 25px; padding: 14px; border: 2px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.05); font-weight: 600; transition: all 0.3s;" onmouseenter="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.5)'; this.style.color='#fff'" onmouseleave="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.3)'; this.style.color='rgba(255,255,255,0.8)'">Fermer</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if(e.target === modal) modal.remove();
    });
};

window.buyShinyTokenItem = function(itemId, cost){
    if(gameState.rogue.totalShinyTokens < cost){
        showToast('Pas assez de Shiny Tokens!', 'error');
        return;
    }
    
    if(gameState.rogue.unlocks[itemId]){
        showToast('D√©j√† achet√©!', 'error');
        return;
    }
    
    gameState.rogue.totalShinyTokens -= cost;
    gameState.rogue.unlocks[itemId] = true;
    showToast(`‚úÖ ${itemId} d√©bloqu√©!`, 'success');
    saveGame();
    updateUI();
    
    const modal = document.querySelector('.modal.active');
    if(modal) modal.remove();
    openShinyTokenShop();
};

window.showBuddyManagement = function(){
    showBuddySelection();
};

function generateExpeditionFloors(){
    if(!runState) return;
    
    for(let i = 0; i < runState.maxFloors; i++){
        const isBoss = (i === runState.maxFloors - 1);
        const floor = {
            floorIndex: i,
            doors: generateExpeditionDoors(isBoss),
            completed: false,
            chosenDoorId: null,
            eventResult: null
        };
        runState.floorsData.push(floor);
    }
}

function generateExpeditionDoors(isBoss){
    if(isBoss){
        return [{id: 'boss', eventType: 'boss', hint: 'üëë Boss Final', icon: 'boss.png'}];
    }
    
    const doors = [];
    const eventTypes = ['encounter', 'chest', 'merchant', 'trap', 'sanctuary', 'puzzle', 'empty'];
    
    for(let i = 0; i < 3; i++){
        const eventType = weightedRandomEvent(eventTypes);
        const door = {
            id: `door_${i}`,
            eventType: eventType,
            hint: getHintForEvent({type: eventType}),
            icon: `${eventType}.png`
        };
        doors.push(door);
    }
    
    return doors;
}

function weightedRandomEvent(eventTypes){
    const weights = eventTypes.map(type => EXPEDITION_CONFIG.eventWeights[type] || 1);
    const total = weights.reduce((a, b) => a + b, 0);
    let rand = Math.random() * total;
    
    for(let i = 0; i < eventTypes.length; i++){
        rand -= weights[i];
        if(rand <= 0) return eventTypes[i];
    }
    return eventTypes[0];
}

function showExpeditionMap(){
    if(!runState || !runState.active) return;
    
    const container = document.getElementById('expedition-container');
    if(!container) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(!currentFloor) return;
    
    const currentFloorNum = (runState.currentFloorIndex || 0) + 1;
    const maxFloors = runState.maxFloors;
    const buddyId = runState.buddyId;
    const buddySprite = buddyId ? 
        getAnimatedSpriteUrl(buddyId, false) :
        'assets/POKEMON PNG/buddies/buddy_empty.png';
    
    const runTime = Math.floor((Date.now() - runState.startTime) / 1000);
    const minutes = Math.floor(runTime / 60);
    const seconds = runTime % 60;
    
    const chainTier = getChainTier(runState.chain);
    
    const chainValue = runState.chain || 0;
    const chainTierNum = chainValue >= 100 ? 4 : chainValue >= 50 ? 3 : chainValue >= 25 ? 2 : chainValue >= 10 ? 1 : 0;
    const chainColors = ['var(--chain-tier-0)', 'var(--chain-tier-1)', 'var(--chain-tier-2)', 'var(--chain-tier-3)', 'var(--chain-tier-4)'];
    const chainColor = chainColors[chainTierNum];
    
    container.innerHTML = `
        <div style="background: var(--expedition-bg-main); min-height: 100vh; padding: 20px;">
            <!-- Top Bar avec Chain Counter H√âROS -->
            <div style="background: var(--expedition-gradient-panel); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--expedition-shadow-lg); border: 2px solid rgba(125,95,255,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <!-- Resources discr√®tes -->
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <div style="font-size: 14px; color: var(--expedition-text-secondary); padding: 6px 12px; background: rgba(255,255,255,0.6); border-radius: 12px; font-weight: 600;">üí∞ ${runState.rewards.coins || 0}</div>
                        <div style="font-size: 14px; color: var(--expedition-text-secondary); padding: 6px 12px; background: rgba(255,255,255,0.6); border-radius: 12px; font-weight: 600;">‚öæ ${runState.ballsAvailable || 0}</div>
                        ${buddyId ? `<img src="${buddySprite}" style="width: 32px; height: 32px; image-rendering: pixelated; border-radius: 8px;">` : ''}
                    </div>
                    
                    <!-- CHAIN COUNTER MEGA (H√âROS) -->
                    <div class="chain-counter-mega" data-tier="${chainTierNum}" style="text-align: center; position: relative; flex: 1; max-width: 200px; margin: 0 auto;">
                        <div class="chain-label" style="font-size: 14px; font-weight: 500; color: var(--expedition-text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Chain</div>
                        <div class="chain-value" style="display: block; font-size: 56px; font-weight: 900; line-height: 1; color: ${chainColor}; text-shadow: 0 0 20px ${chainColor}; animation: chainPulse 2s ease-in-out infinite;">${chainValue}</div>
                    </div>
                    
                    <!-- Timer discret -->
                    <div style="font-size: 14px; color: var(--expedition-text-secondary); padding: 6px 12px; background: rgba(255,255,255,0.6); border-radius: 12px; font-weight: 600;">‚è±Ô∏è ${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}</div>
                </div>
            </div>
            
            <!-- Floor Display -->
            <div style="background: var(--expedition-gradient-panel); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--expedition-shadow-md); border: 2px solid rgba(125,95,255,0.2); text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--expedition-text-primary); margin-bottom: 10px;">
                    FLOOR ${currentFloorNum} / ${maxFloors}
                </div>
                ${currentFloor.completed ? '<div style="color: var(--emotion-success); font-weight: 700;">‚úÖ Floor Compl√©t√©</div>' : ''}
            </div>
            
            <!-- Event Panel (if event active) -->
            <div id="expedition-event-panel" style="display: none; background: var(--expedition-gradient-panel); padding: 32px; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--expedition-shadow-lg); border: 2px solid rgba(125,95,255,0.2); max-width: 600px; margin-left: auto; margin-right: auto;">
                <!-- Event content will be generated here -->
            </div>
            
            <!-- Doors Panel -->
            <div id="expedition-doors-panel" style="display: ${currentFloor.completed ? 'none' : 'grid'}; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; max-width: 800px; margin-left: auto; margin-right: auto; padding: 0 20px;">
                ${currentFloor.doors.map((door, idx) => `
                    <button onclick="chooseExpeditionDoor('${door.id}')" class="door-card" style="background: var(--expedition-gradient-panel); padding: 32px 20px; border-radius: 20px; border: 3px solid rgba(125,95,255,0.2); cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--expedition-shadow-md); position: relative; overflow: hidden; opacity: 0; transform: translateY(20px); animation: doorSlideIn 0.5s ease-out forwards; animation-delay: ${idx * 0.1}s;" onmouseover="this.style.transform='translateY(-8px) scale(1.03)'; this.style.boxShadow='0 12px 32px rgba(125,95,255,0.3)'; this.style.borderColor='var(--expedition-accent-primary)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='var(--expedition-shadow-md)'; this.style.borderColor='rgba(125,95,255,0.2)'">
                        <div style="font-size: 56px; margin-bottom: 12px; text-align: center; display: block; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));">${door.eventType === 'encounter' ? '‚öîÔ∏è' : door.eventType === 'chest' ? 'üì¶' : door.eventType === 'merchant' ? 'üè™' : door.eventType === 'trap' ? '‚ö†Ô∏è' : door.eventType === 'sanctuary' ? 'üèõÔ∏è' : door.eventType === 'puzzle' ? 'üß©' : door.eventType === 'boss' ? 'üëë' : 'üö™'}</div>
                        <div style="font-weight: 700; color: var(--expedition-text-primary); margin-bottom: 8px; font-size: 18px;">Porte ${String.fromCharCode(65 + idx)}</div>
                        <div style="color: var(--expedition-text-secondary); font-size: 14px; font-weight: 500;">${door.hint}</div>
                    </button>
                `).join('')}
            </div>
            
            <!-- Bank Button (Floor 2+) -->
            ${currentFloorNum >= 2 ? `
                <button onclick="bankExpeditionRun()" class="btn btn--outline btn--full-width" style="padding: 15px; margin-top: 10px; max-width: 600px; margin-left: auto; margin-right: auto; background: rgba(239, 68, 68, 0.1); border-color: var(--emotion-danger); color: var(--emotion-danger); border-radius: 14px; font-weight: 600;">
                    üí∞ Bank & Quitter (Gain: ${Math.floor((runState.chain || 0) / 5)} Shiny Tokens)
                </button>
            ` : ''}
        </div>
    `;
    
    updateChainDisplay();
    
    if(currentFloor.completed && currentFloor.eventResult){
        showExpeditionEventResult(currentFloor.eventResult);
    } else if(!currentFloor.completed && currentFloor.chosenDoorId){
        const chosenDoor = currentFloor.doors.find(d => d.id === currentFloor.chosenDoorId);
        if(chosenDoor) resolveExpeditionEvent(chosenDoor);
    }
}

function getChainTier(chain){
    if(chain >= 50) return 'gold';
    if(chain >= 20) return 'violet';
    if(chain >= 10) return 'blue';
    if(chain >= 5) return 'green';
    return 'white';
}

function getChainColor(tier){
    const colors = {
        white: '#666',
        green: '#10b981',
        blue: '#3b82f6',
        violet: '#8b5cf6',
        gold: '#f59e0b'
    };
    return colors[tier] || '#666';
}

function updateChainDisplay(){
    const chainValueEl = document.querySelector('.chain-value');
    if(!chainValueEl || !runState) return;
    
    const newChain = runState.chain || 0;
    if(parseInt(chainValueEl.textContent) !== newChain){
        animateChainIncrement(newChain);
    } else {
        updateChainTierColor(newChain);
    }
}

function chooseExpeditionDoor(doorId){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(!currentFloor || currentFloor.completed) return;
    
    const chosenDoor = currentFloor.doors.find(d => d.id === doorId);
    if(!chosenDoor) return;
    
    currentFloor.chosenDoorId = doorId;
    resolveExpeditionEvent(chosenDoor);
}

function resolveExpeditionEvent(door){
    if(!runState || !runState.active) return;
    
    const eventType = door.eventType;
    const eventPanel = document.getElementById('expedition-event-panel');
    const doorsPanel = document.getElementById('expedition-doors-panel');
    
    if(eventPanel) eventPanel.style.display = 'block';
    if(doorsPanel) doorsPanel.style.display = 'none';
    
    switch(eventType){
        case 'encounter':
            handleExpeditionEncounter(door);
            break;
        case 'chest':
            handleExpeditionChest(door);
            break;
        case 'merchant':
            handleExpeditionMerchant(door);
            break;
        case 'trap':
            handleExpeditionTrap(door);
            break;
        case 'sanctuary':
            handleExpeditionSanctuary(door);
            break;
        case 'puzzle':
            handleExpeditionPuzzle(door);
            break;
        case 'boss':
            handleExpeditionBoss(door);
            break;
        default:
            handleExpeditionEmpty(door);
    }
}

// ===== EXPEDITION EVENT HANDLERS =====
function handleExpeditionEncounter(door){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    const floorIndex = currentFloor ? currentFloor.floorIndex : 0;
    const isBoss = door.eventType === 'boss';
    
    let pokemon;
    if(isBoss){
        if(runState.targetPokemonId){
            pokemon = {
                id: runState.targetPokemonId,
                name: FRENCH_NAMES[runState.targetPokemonId],
                rarity: getRarity(runState.targetPokemonId),
                isShiny: false
            };
        } else {
            // Filtrer les l√©gendaires par r√©gion actuelle (m√™me en mode Wild)
            const currentRegion = getCurrentUnlockedRegion();
            let legendaryPool = filterPokemonByRegion(POKEMON_DATA.legendary, currentRegion);
            
            // Fallback si aucun l√©gendaire dans la r√©gion
            if(legendaryPool.length === 0) {
                legendaryPool = filterPokemonByRegion(POKEMON_DATA.super_rare || [], currentRegion);
                if(legendaryPool.length === 0) {
                    legendaryPool = filterPokemonByRegion(POKEMON_DATA.legendary || [], 'Kanto');
                }
            }
            
            const id = legendaryPool[Math.floor(Math.random() * legendaryPool.length)];
            pokemon = {
                id: id,
                name: FRENCH_NAMES[id],
                rarity: getRarity(id),
                isShiny: false
            };
        }
    } else {
        pokemon = selectPokemonForExpedition(floorIndex, runState.targetPokemonId);
    }
    
    const shinyRate = calculateExpeditionShinyRate(pokemon.id);
    pokemon.isShiny = Math.random() < shinyRate;
    // ‚ö†Ô∏è L√©viator Shiny EXCLUSIF √† la p√™che - jamais shiny ailleurs
    if (pokemon.id === 130) pokemon.isShiny = false;
    
    currentFloor.eventResult = {type: 'encounter', pokemon: pokemon, isBoss: isBoss};
    
    showExpeditionEncounterUI(pokemon, isBoss);
}

function selectPokemonForExpedition(floorIndex, targetId){
    const rates = {...EXPEDITION_CONFIG.rogueRates};
    
    if(floorIndex >= 4){
        rates.rare += 10;
        rates.super_rare += 10;
        rates.legendary += 5;
        rates.common -= 15;
        rates.uncommon -= 10;
    }
    
    const buddyData = runState.buddyId ? gameState.buddy.buddies[runState.buddyId] : null;
    if(buddyData && buddyData.talents && buddyData.talents.includes('forager')){
        rates.rare += 5;
        rates.super_rare += 3;
        rates.legendary += 2;
        rates.common -= 10;
    }
    
    if(targetId && Math.random() < EXPEDITION_CONFIG.targetSpawnChance){
        const targetRarity = getRarity(targetId);
        if(POKEMON_DATA[targetRarity] && POKEMON_DATA[targetRarity].includes(targetId)){
            return {
                id: targetId,
                name: FRENCH_NAMES[targetId],
                rarity: targetRarity,
                isShiny: false
            };
        }
    }
    
    const rand = Math.random() * 100;
    let cumulative = 0;
    let rarity = 'common';
    
    for(const [r, rate] of Object.entries(rates)){
        cumulative += rate;
        if(rand < cumulative){
            rarity = r;
            break;
        }
    }
    
    let pokemonPool = POKEMON_DATA[rarity];
    if(!pokemonPool || pokemonPool.length === 0) pokemonPool = POKEMON_DATA.common;
    
    // Filtrer par r√©gion actuelle (m√™me en mode Wild)
    const currentRegion = getCurrentUnlockedRegion();
    pokemonPool = filterPokemonByRegion(pokemonPool, currentRegion);
    
    // Fallback si le pool filtr√© est vide
    if(pokemonPool.length === 0) {
        for(const r of ['common', 'uncommon', 'rare', 'super_rare', 'legendary']) {
            const altPool = filterPokemonByRegion(POKEMON_DATA[r] || [], currentRegion);
            if(altPool.length > 0) {
                pokemonPool = altPool;
                rarity = r;
                break;
            }
        }
        // Dernier fallback : Prendre un Pok√©mon de la r√©gion actuelle (m√™me si d√©j√† captur√©)
        if(pokemonPool.length === 0) {
            const regionRange = {
                'Kanto': { min: 1, max: 151 },
                'Johto': { min: 152, max: 251 },
                'Hoenn': { min: 252, max: 386 }
            }[currentRegion] || { min: 1, max: 151 };
            const allInRegion = Array.from({length: regionRange.max - regionRange.min + 1}, (_, i) => regionRange.min + i);
            pokemonPool = allInRegion.filter(id => 
                POKEMON_DATA.common.includes(id) || 
                POKEMON_DATA.uncommon.includes(id) || 
                POKEMON_DATA.rare.includes(id) || 
                POKEMON_DATA.super_rare.includes(id) || 
                POKEMON_DATA.legendary.includes(id)
            );
            if(pokemonPool.length === 0) pokemonPool = [regionRange.min]; // Fallback absolu
        }
    }
    
    const id = pokemonPool[Math.floor(Math.random() * pokemonPool.length)];
    
    return {
        id: id,
        name: FRENCH_NAMES[id],
        rarity: rarity,
        isShiny: false
    };
}

function calculateExpeditionShinyRate(pokemonId){
    let shinyRate = EXPEDITION_CONFIG.baseShinyRate;
    
    const isTarget = runState.targetPokemonId === pokemonId;
    if(isTarget) shinyRate += EXPEDITION_CONFIG.targetBonus;
    
    shinyRate += (runState.chain || 0) * EXPEDITION_CONFIG.chainShinyBonus / 100;
    
    const pityBonus = Math.min(
        gameState.rogue.pityCounter * EXPEDITION_CONFIG.pityBonus,
        EXPEDITION_CONFIG.maxPityBonus
    );
    shinyRate += pityBonus;
    
    if(gameState.rogue.unlocks.shinyCharmPermanent){
        shinyRate += 0.05;
    }
    
    const buddyData = runState.buddyId ? gameState.buddy.buddies[runState.buddyId] : null;
    if(buddyData && buddyData.talents && buddyData.talents.includes('shinyMagnet')){
        const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
        shinyRate += (currentFloor ? currentFloor.floorIndex : 0) * 0.005;
    }
    
    return Math.min(shinyRate, 0.50);
}

function showExpeditionEncounterUI(pokemon, isBoss){
    const eventPanel = document.getElementById('expedition-event-panel');
    if(!eventPanel) return;
    
    // Utiliser le type de ball am√©lior√© selon l'upgrade
    const ballType = runState.defaultBallType || 'pokeball';
    let captureRate = calculateCaptureRate(ballType, pokemon.rarity, false);
    
    // Appliquer le bonus de ballUpgrade1 (+25% au lieu de remplacer la ball)
    if (gameState.rogue.unlocks?.ballUpgrade1 && !gameState.rogue.unlocks?.ballUpgrade2) {
        captureRate = Math.min(captureRate * 1.25, 1.0);
    }
    
    if(runState.tempBuffs && runState.tempBuffs.length > 0){
        for(const buff of runState.tempBuffs){
            // V√©rifier les buffs de type 'capture' ET 'captureBoost' (puzzle)
            if(buff.type === 'capture' || buff.type === 'captureBoost'){
                captureRate = Math.min(captureRate + buff.value, 1.0);
            }
        }
    }
    const shinyRate = calculateExpeditionShinyRate(pokemon.id);
    const isTarget = runState.targetPokemonId === pokemon.id;
    const buddyId = runState.buddyId;
    const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
    
    // D√©terminer la cat√©gorie de narration
    let narrationCategory = 'encounter_common';
    if(isBoss && isTarget && pokemon.isShiny) narrationCategory = 'boss_target_appear';
    else if(isBoss && isTarget) narrationCategory = 'boss_target_appear';
    else if(isBoss) narrationCategory = 'boss_appear';
    else if(isTarget && pokemon.isShiny) narrationCategory = 'encounter_target_shiny';
    else if(isTarget) narrationCategory = 'encounter_target';
    else if(pokemon.isShiny) narrationCategory = 'encounter_shiny';
    else if(pokemon.rarity === 'legendary') narrationCategory = 'encounter_legendary';
    else if(['rare', 'super_rare'].includes(pokemon.rarity)) narrationCategory = 'encounter_rare';
    
    eventPanel.style.display = 'block';
    
    eventPanel.innerHTML = `
        <div style="text-align: center;">
            <h3 style="font-size: 32px; font-weight: 700; color: var(--expedition-text-primary); margin-bottom: 20px;">
                ${isBoss ? 'üëë BOSS FLOOR' : '‚öîÔ∏è Rencontre Pok√©mon'}
            </h3>
            ${isTarget ? '<div class="target-badge" style="position: relative; top: -10px; margin: 0 auto 20px; background: linear-gradient(135deg, #ff6b9d, #ff8fab); color: white; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; box-shadow: 0 4px 12px rgba(255,107,157,0.4); animation: badgePulse 2s ease-in-out infinite; display: inline-block;">üéØ TARGET POK√âMON</div>' : ''}
            
            <!-- NARRATION (NOUVEAU) -->
            <div class="event-narration" style="background: linear-gradient(135deg, rgba(0,0,0,0.7) 0%, rgba(20,20,30,0.8) 100%); border-left: 4px solid var(--expedition-accent-primary); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; text-align: left;">
                <p class="narration-text" style="font-size: 15px; line-height: 1.6; color: #fff; margin: 0; font-style: italic; transition: all 0.3s ease;">
                    ${getNarrative(narrationCategory, {pokemonName: pokemon.name, buddyName: buddyName, chain: runState.chain || 0})}
                </p>
            </div>
            
            <div style="background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 12px; margin-bottom: 15px; position: relative; border: 2px solid rgba(125, 95, 255, 0.3); ${pokemon.isShiny ? 'animation: shinyGlow 2s ease-in-out infinite;' : ''}">
                ${pokemon.isShiny ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; pointer-events: none;"><div style="position: absolute; top: 0; left: 50%; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: 0px; --ty: -80px; animation: shinyParticles 2s ease-in-out infinite; animation-delay: 0s;"></div><div style="position: absolute; top: 50%; left: 0; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: -80px; --ty: 0px; animation: shinyParticles 2s ease-in-out infinite; animation-delay: 0.3s;"></div><div style="position: absolute; top: 50%; right: 0; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: 80px; --ty: 0px; animation: shinyParticles 2s ease-in-out infinite; animation-delay: 0.6s;"></div><div style="position: absolute; bottom: 0; left: 50%; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: 0px; --ty: 80px; animation: shinyParticles 2s ease-in-out infinite; animation-delay: 0.9s;"></div><div style="position: absolute; top: 20%; left: 20%; width: 3px; height: 3px; background: #FFD700; border-radius: 50%; --tx: -60px; --ty: -60px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 0.2s;"></div><div style="position: absolute; top: 20%; right: 20%; width: 3px; height: 3px; background: #FFD700; border-radius: 50%; --tx: 60px; --ty: -60px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 0.5s;"></div><div style="position: absolute; bottom: 20%; left: 20%; width: 3px; height: 3px; background: #FFD700; border-radius: 50%; --tx: -60px; --ty: 60px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 0.8s;"></div><div style="position: absolute; bottom: 20%; right: 20%; width: 3px; height: 3px; background: #FFD700; border-radius: 50%; --tx: 60px; --ty: 60px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 1.1s;"></div></div>' : ''}
                <img src="${getAnimatedSpriteUrl(pokemon.id, pokemon.isShiny)}" 
                     style="width: 150px; height: 150px; min-width: 150px; min-height: 150px; max-width: 150px; max-height: 150px; image-rendering: pixelated; position: relative; z-index: 1; ${pokemon.isShiny ? 'filter: drop-shadow(0 0 20px #FFD700); animation: shinyFloat 3s ease-in-out infinite;' : ''}; object-fit: contain; object-position: center; display: block; margin: 0 auto;">
                <div style="font-size: 1.5em; font-weight: bold; color: ${pokemon.isShiny ? '#FFD700' : '#fff'}; margin-top: 10px;">
                    ${pokemon.isShiny ? '‚ú® ' : ''}${pokemon.name}${pokemon.isShiny ? ' ‚ú®' : ''}
                </div>
                <div style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 5px;">
                    #${String(pokemon.id).padStart(3,'0')} ‚Ä¢ ${pokemon.rarity.toUpperCase()}
                </div>
            </div>
            
            <div style="background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid rgba(32, 213, 210, 0.3);">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: left;">
                    <div style="color: #fff;"><strong style="color: #FFFFFF;">Chain:</strong> <span style="color: #fff;">${runState.chain || 0}</span></div>
                    <div style="color: #fff;"><strong style="color: #FFFFFF;">Capture Rate:</strong> <span style="color: #fff;">${Math.round(captureRate * 100)}%</span></div>
                    <div style="color: #fff;"><strong style="color: #FFFFFF;">Shiny Rate:</strong> <span style="color: #fff;">${Math.round(shinyRate * 100)}%</span></div>
                    <div style="color: #fff;"><strong style="color: #FFFFFF;">Balls:</strong> <span style="color: #fff;">${runState.ballsAvailable || 0}</span></div>
                </div>
            </div>
            
            <div style="background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid rgba(125, 95, 255, 0.3);">
                <div style="color: #fff; font-weight: bold; margin-bottom: 10px; font-size: 0.9em;">üéí Utiliser un objet</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                    ${gameState.inventory.framby > 0 ? `
                        <button class="use-expedition-item-btn btn btn--outline" data-item-id="framby" style="padding: 8px;">
                            üçì Framby (${gameState.inventory.framby})
                        </button>
                    ` : ''}
                    ${gameState.inventory.pinap > 0 ? `
                        <button class="use-expedition-item-btn btn btn--outline" data-item-id="pinap" style="padding: 8px;">
                            üçç Pinap (${gameState.inventory.pinap})
                        </button>
                    ` : ''}
                    ${gameState.inventory.ceriz > 0 ? `
                        <button class="use-expedition-item-btn btn btn--outline" data-item-id="ceriz" style="padding: 8px;">
                            üçí Ceriz (${gameState.inventory.ceriz})
                        </button>
                    ` : ''}
                    ${(!gameState.inventory.framby || gameState.inventory.framby <= 0) && (!gameState.inventory.pinap || gameState.inventory.pinap <= 0) && (!gameState.inventory.ceriz || gameState.inventory.ceriz <= 0) ? `
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; grid-column: 1 / -1; text-align: center;">Aucun objet disponible</div>
                    ` : ''}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                ${runState.ballsAvailable > 0 ? `
                    <button class="attempt-capture-btn btn btn--primary" data-ball-type="${ballType}" style="padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <img src="${getItemIcon(ballType)}" style="width: 24px; height: 24px; image-rendering: pixelated; object-fit: contain;" alt="${ballType === 'ultraball' ? 'Hyper Ball' : (ballType === 'greatball' ? 'Super Ball' : 'Pok√© Ball')}">
                        <span>Capturer (${Math.round(captureRate * 100)}%)</span>
                    </button>
                ` : ''}
                <button class="flee-encounter-btn btn btn--outline" style="padding: 12px;">
                    üèÉ Fuir
                </button>
            </div>
        </div>
    `;
    
    eventPanel.querySelectorAll('.use-expedition-item-btn').forEach(btn => {
        btn.addEventListener('click', function(){
            const itemId = this.getAttribute('data-item-id');
            if(window.useExpeditionItem){
                window.useExpeditionItem(itemId);
            }
        });
    });
    
    const attemptBtn = eventPanel.querySelector('.attempt-capture-btn');
    if(attemptBtn){
        attemptBtn.addEventListener('click', function(){
            const ballType = this.getAttribute('data-ball-type');
            if(window.attemptExpeditionCapture){
                window.attemptExpeditionCapture(ballType);
            }
        });
    }
    
    const fleeBtn = eventPanel.querySelector('.flee-encounter-btn');
    if(fleeBtn){
        fleeBtn.addEventListener('click', function(){
            if(window.fleeExpeditionEncounter){
                window.fleeExpeditionEncounter();
            }
        });
    }
}

window.useExpeditionItem = function(itemId){
    if(!runState || !runState.active) return;
    
    if(!gameState.inventory[itemId] || gameState.inventory[itemId] <= 0){
        showToast('Plus d\'objets disponibles!', 'error');
        return;
    }
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    const pokemon = currentFloor?.eventResult?.pokemon;
    
    // V√©rifier si une baie a d√©j√† √©t√© utilis√©e sur ce Pok√©mon
    if(['framby', 'pinap', 'ceriz'].includes(itemId)){
        if(!runState.currentEncounterBerryUsed) runState.currentEncounterBerryUsed = null;
        if(runState.currentEncounterBerryUsed && runState.currentEncounterBerryUsed === pokemon?.id){
            showToast('Vous avez d√©j√† utilis√© une baie sur ce Pok√©mon!', 'error');
            return;
        }
    }
    
    gameState.inventory[itemId]--;
    
    if(itemId === 'framby'){
        if(!runState.tempBuffs) runState.tempBuffs = [];
        runState.tempBuffs.push({type: 'capture', value: 0.5, duration: 1});
        if(pokemon) runState.currentEncounterBerryUsed = pokemon.id;
        showToast('üçì Framby utilis√©! +50% taux de capture pour la prochaine capture', 'success');
    } else if(itemId === 'pinap'){
        if(!runState.tempBuffs) runState.tempBuffs = [];
        runState.tempBuffs.push({type: 'coins', value: 2, duration: 1});
        if(pokemon) runState.currentEncounterBerryUsed = pokemon.id;
        showToast('üçç Pinap utilis√©! √ó2 coins pour la prochaine capture', 'success');
    } else if(itemId === 'ceriz'){
        if(pokemon && pokemon.isShiny){
            if(!runState.tempBuffs) runState.tempBuffs = [];
            runState.tempBuffs.push({type: 'capture', value: 1.0, duration: 1});
            runState.currentEncounterBerryUsed = pokemon.id;
            showToast('üçí Ceriz utilis√©! 100% capture sur Shiny!', 'success');
        } else {
            showToast('üçí Ceriz: Aucun effet (pas de Shiny)', 'info');
        }
    }
    
    saveGame();
    
    const eventPanel = document.getElementById('expedition-event-panel');
    if(eventPanel){
        if(currentFloor && currentFloor.eventResult && currentFloor.eventResult.pokemon){
            showExpeditionEncounterUI(currentFloor.eventResult.pokemon, currentFloor.eventResult.isBoss || false);
        }
    }
};

function handleExpeditionChest(door){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    const rewards = {
        coins: Math.floor(Math.random() * 200) + 100,
        items: [],
        shards: []
    };
    
    if(Math.random() < 0.3){
        const itemPool = ['framby', 'pinap', 'pokeball'];
        const item = itemPool[Math.floor(Math.random() * itemPool.length)];
        rewards.items.push({id: item, qty: Math.floor(Math.random() * 3) + 1});
    }
    
    // Blueprints pour d√©bloquer les habitats (10% chance, am√©lior√©)
    if(Math.random() < 0.10){
        const blueprintPool = [
            {id: 'blueprint_ocean', name: 'Plan Oc√©an'},
            {id: 'blueprint_cave', name: 'Plan Grotte'},
            {id: 'blueprint_volcano', name: 'Plan Volcan'},
            {id: 'blueprint_power_plant', name: 'Plan Centrale'},
            {id: 'blueprint_graveyard', name: 'Plan Cimeti√®re'}
        ];
        // Prioriser les blueprints qu'on n'a pas encore
        const availableBlueprints = blueprintPool.filter(bp => !gameState.inventory[bp.id] || gameState.inventory[bp.id] === 0);
        const blueprint = availableBlueprints.length > 0 
            ? availableBlueprints[Math.floor(Math.random() * availableBlueprints.length)]
            : blueprintPool[Math.floor(Math.random() * blueprintPool.length)];
        rewards.items.push({id: blueprint.id, qty: 1});
    }
    
    // Processor Chips (Puces M√©moire) dans les coffres (20% chance, 1-3 chips)
    if(Math.random() < 0.20){
        const chips = 1 + Math.floor(Math.random() * 3);
        rewards.items.push({id: 'processor_chips', qty: chips});
    }
    
    if(Math.random() < EXPEDITION_CONFIG.shardRates.common){
        rewards.shards.push({type: 'common', qty: 1});
    }
    
    currentFloor.eventResult = {type: 'chest', rewards: rewards};
    showExpeditionChestUI(rewards);
}

function showExpeditionChestUI(rewards){
    const eventPanel = document.getElementById('expedition-event-panel');
    if(!eventPanel) return;
    
    eventPanel.style.display = 'block';
    
    const buddyId = runState.buddyId;
    const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
    
    let rewardsHTML = `<div style="color: var(--emotion-shiny); font-weight: 700; margin-bottom: 10px; font-size: 1.2em;">üí∞ +${rewards.coins} coins</div>`;
    
    if(rewards.items.length > 0){
        rewards.items.forEach(item => {
            const itemName = ALL_ITEMS[item.id]?.name || item.id;
            const iconDisplay = getItemIconDisplay(item.id, '24px');
            rewardsHTML += `<div style="color: var(--expedition-text-primary); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; font-weight: 600;">${iconDisplay} +${item.qty} ${itemName}</div>`;
        });
    }
    
    if(rewards.shards.length > 0){
        rewards.shards.forEach(shard => {
            rewardsHTML += `<div style="color: var(--emotion-legendary); margin-bottom: 5px; font-weight: 600;">üíé +${shard.qty} ${shard.type} shard</div>`;
        });
    }
    
    eventPanel.innerHTML = `
        <div style="text-align: center;">
            <h3 style="font-size: 32px; font-weight: 700; color: var(--expedition-text-primary); margin-bottom: 20px;">üì¶ Coffre</h3>
            
            <!-- NARRATION -->
            <div class="event-narration" style="background: linear-gradient(135deg, rgba(125,95,255,0.1) 0%, rgba(32,213,210,0.1) 100%); border-left: 4px solid var(--expedition-accent-primary); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; text-align: left;">
                <p class="narration-text" style="font-size: 15px; line-height: 1.6; color: var(--expedition-text-primary); margin: 0; font-style: italic;">
                    ${getNarrative('chest_appear', {buddyName: buddyName})}
                </p>
            </div>
            
            <div style="font-size: 3em; margin-bottom: 15px;">üì¶</div>
            <div style="background: var(--expedition-gradient-panel); padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: var(--expedition-shadow-md); border: 2px solid rgba(125,95,255,0.2);">
                ${rewardsHTML}
            </div>
            <button onclick="continueExpeditionAfterEvent()" class="btn btn--primary" style="padding: 16px 30px; background: var(--expedition-gradient-button); border: none; color: white; box-shadow: var(--expedition-shadow-glow); border-radius: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 24px rgba(125,95,255,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--expedition-shadow-glow)'">
                Continuer
            </button>
        </div>
    `;
    
    applyExpeditionRewards(rewards);
}

function handleExpeditionMerchant(door){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    
    const itemsForSale = [
        {id: 'pokeball', price: 50, qty: 5},
        {id: 'framby', price: 30, qty: 2},
        {id: 'pinap', price: 40, qty: 2}
    ];
    
    const merchantItems = itemsForSale.sort(() => Math.random() - 0.5).slice(0, 3);
    
    currentFloor.eventResult = {type: 'merchant', items: merchantItems};
    showExpeditionMerchantUI(merchantItems);
}

function showExpeditionMerchantUI(items){
    const eventPanel = document.getElementById('expedition-event-panel');
    if(!eventPanel) return;
    
    eventPanel.style.display = 'block';
    
    const buddyId = runState.buddyId;
    const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
    
    const itemsHTML = items.map(item => {
        const itemData = ALL_ITEMS[item.id];
        const price = Math.floor(item.price * 0.8);
        return `
            <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 2px solid rgba(125,95,255,0.15);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 700; color: var(--expedition-text-primary); display: flex; align-items: center; gap: 8px;">${getItemIconDisplay(item.id, '24px')} ${itemData?.name || item.id}</div>
                        <div style="color: var(--expedition-text-secondary); font-size: 0.9em;">√ó${item.qty}</div>
                    </div>
                    <button class="buy-expedition-item-btn btn btn--primary" data-item-id="${item.id}" data-price="${price}" data-qty="${item.qty}" style="padding: 8px 16px;" ${runState.rewards.coins < price ? 'disabled' : ''}>
                        üí∞ ${price}
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    eventPanel.innerHTML = `
        <div style="text-align: center;">
            <h3 style="font-size: 32px; font-weight: 700; color: var(--expedition-text-primary); margin-bottom: 20px;">üè™ Marchand</h3>
            
            <!-- NARRATION -->
            <div class="event-narration" style="background: linear-gradient(135deg, rgba(125,95,255,0.1) 0%, rgba(32,213,210,0.1) 100%); border-left: 4px solid var(--expedition-accent-primary); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; text-align: left;">
                <p class="narration-text" style="font-size: 15px; line-height: 1.6; color: var(--expedition-text-primary); margin: 0; font-style: italic;">
                    ${getNarrative('merchant_appear', {buddyName: buddyName})}
                </p>
            </div>
            
            <div style="font-size: 2em; margin-bottom: 15px;">üõí</div>
            <div style="color: var(--expedition-text-primary); margin-bottom: 15px; font-weight: 600;">Coins disponibles: üí∞ ${runState.rewards.coins || 0}</div>
            <div style="margin-bottom: 15px;">
                ${itemsHTML}
            </div>
            <button class="continue-expedition-btn btn btn--outline" style="padding: 12px 30px;">
                Continuer
            </button>
        </div>
    `;
    
    eventPanel.querySelectorAll('.buy-expedition-item-btn').forEach(btn => {
        btn.addEventListener('click', function(){
            const itemId = this.getAttribute('data-item-id');
            const price = parseInt(this.getAttribute('data-price'));
            const qty = parseInt(this.getAttribute('data-qty'));
            if(window.buyExpeditionItem){
                window.buyExpeditionItem(itemId, price, qty);
            }
        });
    });
    
    const continueBtn = eventPanel.querySelector('.continue-expedition-btn');
    if(continueBtn){
        continueBtn.addEventListener('click', function(){
            if(window.continueExpeditionAfterEvent){
                window.continueExpeditionAfterEvent();
            }
        });
    }
}

function handleExpeditionTrap(door){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    
    const buddyData = runState.buddyId ? gameState.buddy.buddies[runState.buddyId] : null;
    const hasProtector = buddyData && buddyData.talents && buddyData.talents.includes('protector');
    
    if(hasProtector && Math.random() < 0.3){
        currentFloor.eventResult = {type: 'trap', avoided: true};
        showExpeditionTrapUI(true);
        return;
    }
    
    const penalties = [
        {type: 'balls', value: Math.max(1, Math.floor(runState.ballsAvailable * 0.2))},
        {type: 'coins', value: Math.max(50, Math.floor(runState.rewards.coins * 0.1))},
        {type: 'chain', value: Math.max(1, Math.floor((runState.chain || 0) * 0.2))}
    ];
    
    const penalty = penalties[Math.floor(Math.random() * penalties.length)];
    
    currentFloor.eventResult = {type: 'trap', penalty: penalty};
    showExpeditionTrapUI(false, penalty);
}

function showExpeditionTrapUI(avoided, penalty){
    const eventPanel = document.getElementById('expedition-event-panel');
    if(!eventPanel) return;
    
    if(avoided){
        eventPanel.innerHTML = `
            <div style="text-align: center;">
                <h3 style="color: #10b981; margin-bottom: 15px;">üí• Pi√®ge √âvit√©!</h3>
                <div style="font-size: 3em; margin-bottom: 15px;">üõ°Ô∏è</div>
                <div style="color: #fff; margin-bottom: 15px;">Votre Buddy vous a prot√©g√©!</div>
                <button onclick="continueExpeditionAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">
                    Continuer
                </button>
            </div>
        `;
    } else {
        let penaltyText = '';
        if(penalty.type === 'balls'){
            penaltyText = `‚öæ -${penalty.value} Pok√© Balls`;
            runState.ballsAvailable = Math.max(0, runState.ballsAvailable - penalty.value);
        } else if(penalty.type === 'coins'){
            penaltyText = `üí∞ -${penalty.value} coins`;
            runState.rewards.coins = Math.max(0, runState.rewards.coins - penalty.value);
        } else if(penalty.type === 'chain'){
            penaltyText = `üîó -${penalty.value} chain`;
            runState.chain = Math.max(0, (runState.chain || 0) - penalty.value);
            updateChainDisplay();
        }
        
        eventPanel.innerHTML = `
            <div style="text-align: center;">
                <h3 style="color: #ef4444; margin-bottom: 15px;">üí• Pi√®ge!</h3>
                <div style="font-size: 3em; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <div style="color: #fff; margin-bottom: 15px; font-weight: bold;">${penaltyText}</div>
                <button onclick="continueExpeditionAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">
                    Continuer
                </button>
            </div>
        `;
    }
}

function handleExpeditionSanctuary(door){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    currentFloor.eventResult = {type: 'sanctuary'};
    showExpeditionSanctuaryUI();
}

function showExpeditionSanctuaryUI(){
    const eventPanel = document.getElementById('expedition-event-panel');
    if(!eventPanel) return;
    
    eventPanel.style.display = 'block';
    
    const buddyId = runState.buddyId;
    const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
    
    eventPanel.innerHTML = `
        <div style="text-align: center;">
            <h3 style="font-size: 32px; font-weight: 700; color: var(--expedition-text-primary); margin-bottom: 20px;">‚õ™ Sanctuaire</h3>
            
            <!-- NARRATION -->
            <div class="event-narration" style="background: linear-gradient(135deg, rgba(125,95,255,0.1) 0%, rgba(32,213,210,0.1) 100%); border-left: 4px solid var(--expedition-accent-primary); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; text-align: left;">
                <p class="narration-text" style="font-size: 15px; line-height: 1.6; color: var(--expedition-text-primary); margin: 0; font-style: italic;">
                    ${getNarrative('sanctuary_appear', {buddyName: buddyName})}
                </p>
            </div>
            
            <div style="font-size: 3em; margin-bottom: 15px;">üïäÔ∏è</div>
            <div style="color: var(--expedition-text-primary); margin-bottom: 15px; font-weight: 600;">Vous pouvez sacrifier une baie pour obtenir un bonus temporaire.</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                ${gameState.inventory.framby > 0 ? `<button onclick="useExpeditionSanctuary('framby')" class="btn btn--outline" style="padding: 10px; border-color: var(--expedition-accent-primary); color: var(--expedition-accent-primary); border-radius: 12px; font-weight: 600;">${getItemIconDisplay('framby', '1.2em')} Framby</button>` : ''}
                ${gameState.inventory.pinap > 0 ? `<button onclick="useExpeditionSanctuary('pinap')" class="btn btn--outline" style="padding: 10px; border-color: var(--expedition-accent-primary); color: var(--expedition-accent-primary); border-radius: 12px; font-weight: 600;">${getItemIconDisplay('pinap', '1.2em')} Pinap</button>` : ''}
                ${gameState.inventory.ceriz > 0 ? `<button onclick="useExpeditionSanctuary('ceriz')" class="btn btn--outline" style="padding: 10px; border-color: var(--expedition-accent-primary); color: var(--expedition-accent-primary); border-radius: 12px; font-weight: 600;">${getItemIconDisplay('ceriz', '1.2em')} Ceriz</button>` : ''}
            </div>
            <button onclick="continueExpeditionAfterEvent()" class="btn btn--outline" style="padding: 12px 30px; border-color: var(--expedition-accent-primary); color: var(--expedition-accent-primary); border-radius: 14px; font-weight: 600;">
                Passer
            </button>
        </div>
    `;
}

function handleExpeditionPuzzle(door){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    currentFloor.eventResult = {type: 'puzzle', completed: false, attempts: 0, maxAttempts: 3};
    showExpeditionPuzzleUI();
}

function showExpeditionPuzzleUI(){
    const eventPanel = document.getElementById('expedition-event-panel');
    if(!eventPanel) return;
    
    eventPanel.style.display = 'block';
    
    const buddyId = runState.buddyId;
    const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
    
    eventPanel.innerHTML = `
        <div style="text-align: center;">
            <h3 style="font-size: 32px; font-weight: 700; color: var(--expedition-text-primary); margin-bottom: 20px;">üß© Puzzle</h3>
            
            <!-- NARRATION -->
            <div class="event-narration" style="background: linear-gradient(135deg, rgba(125,95,255,0.1) 0%, rgba(32,213,210,0.1) 100%); border-left: 4px solid var(--expedition-accent-primary); border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; text-align: left;">
                <p class="narration-text" style="font-size: 15px; line-height: 1.6; color: var(--expedition-text-primary); margin: 0; font-style: italic;">
                    ${getNarrative('puzzle_appear', {buddyName: buddyName})}
                </p>
            </div>
            
            <div style="color: var(--expedition-text-primary); margin-bottom: 15px; font-weight: 600;">Appuyez sur le bouton au bon moment!</div>
            <div id="puzzle-attempts" style="color: var(--expedition-text-secondary); margin-bottom: 10px; font-size: 0.9em; font-weight: 600;">Essais restants: <span id="puzzle-attempts-count">3</span></div>
            <div id="puzzle-timing" style="margin-bottom: 15px;">
                <div style="width: 100%; height: 20px; background: rgba(125,95,255,0.1); border-radius: 10px; overflow: hidden; position: relative; border: 2px solid rgba(125,95,255,0.2);">
                    <div id="puzzle-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--emotion-danger), var(--emotion-warning), var(--emotion-success)); transition: width 0.1s;"></div>
                    <div id="puzzle-target" style="position: absolute; left: 70%; top: 0; width: 12%; height: 100%; background: rgba(255,255,255,0.5); border: 2px solid var(--expedition-accent-primary);"></div>
                </div>
            </div>
            <button id="puzzle-button" onclick="attemptExpeditionPuzzle()" class="btn btn--primary" style="padding: 12px 30px; background: var(--expedition-gradient-button); border: none; color: white; box-shadow: var(--expedition-shadow-glow); border-radius: 14px; font-weight: 700;">
                ‚ö° Appuyer!
            </button>
            <button onclick="continueExpeditionAfterEvent()" class="btn btn--outline" style="padding: 12px 30px; margin-top: 10px; border-color: var(--expedition-accent-primary); color: var(--expedition-accent-primary); border-radius: 14px; font-weight: 600;">
                Passer
            </button>
        </div>
    `;
    
    startPuzzleGame();
}

function handleExpeditionBoss(door){
    handleExpeditionEncounter(door);
}

function handleExpeditionEmpty(door){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    currentFloor.eventResult = {type: 'empty'};
    
    const eventPanel = document.getElementById('expedition-event-panel');
    if(!eventPanel) return;
    
    eventPanel.innerHTML = `
        <div style="text-align: center;">
            <h3 style="color: #666; margin-bottom: 15px;">üå´Ô∏è Vide</h3>
            <div style="color: #666; margin-bottom: 15px;">Cette salle est vide...</div>
            <button onclick="continueExpeditionAfterEvent()" class="btn btn--outline" style="padding: 12px 30px;">
                Continuer
            </button>
        </div>
    `;
}

function showExpeditionEventResult(result){
    if(!result) return;
    
    switch(result.type){
        case 'encounter':
            showExpeditionEncounterUI(result.pokemon, result.isBoss);
            break;
        case 'chest':
            showExpeditionChestUI(result.rewards);
            break;
        case 'merchant':
            showExpeditionMerchantUI(result.items);
            break;
        case 'trap':
            showExpeditionTrapUI(result.avoided, result.penalty);
            break;
        case 'sanctuary':
            showExpeditionSanctuaryUI();
            break;
        case 'puzzle':
            showExpeditionPuzzleUI();
            break;
        case 'empty':
            handleExpeditionEmpty({});
            break;
    }
}
// ===== EXPEDITION CAPTURE & UTILITY FUNCTIONS =====

// Fonction d'attribution des Shiny Tokens
function awardShinyTokens(pokemon, context){
    if(!pokemon.isShiny) return 0;
    
    let tokens = 0;
    
    // Shiny normal : 5 tokens
    tokens += EXPEDITION_CONFIG.shinyTokenPerShiny || 5;
    
    // Bonus Target : +15 tokens (total 20)
    if(context.isTarget){
        tokens += (EXPEDITION_CONFIG.shinyTokenPerTargetShiny || 20) - (EXPEDITION_CONFIG.shinyTokenPerShiny || 5);
    }
    
    // Pas de bonus suppl√©mentaire pour Boss (les tokens sont donn√©s s√©par√©ment dans continueExpeditionAfterEvent)
    
    runState.rewards.shinyTokensEarned += tokens;
    gameState.rogue.totalShinyTokens += tokens;
    gameState.rogue.pityCounter = 0;
    
    // Animation + Toast
    showShinyTokenAnimation(tokens);
    showToast(`üíé +${tokens} Shiny Tokens !`, 'success');
    
    return tokens;
}

function showShinyTokenAnimation(tokens){
    const anim = document.createElement('div');
    anim.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3em; z-index: 99999; pointer-events: none; animation: tokenPop 1s ease-out forwards;';
    anim.innerHTML = `üíé +${tokens}`;
    document.body.appendChild(anim);
    setTimeout(() => {
        if(anim.parentNode) anim.remove();
    }, 1000);
}

// Bank de Chain
window.bankExpeditionChain = function(){
    if(!runState || !runState.active) return;
    
    const chain = runState.chain || 0;
    const tokens = Math.floor(chain / 5);
    
    if(tokens === 0){
        showToast('Chain trop faible pour bank (minimum 5)', 'error');
        return;
    }
    
    if(!confirm(`Banker votre Chain de ${chain}?\nVous obtiendrez ${tokens} Shiny Tokens`)){
        return;
    }
    
    runState.rewards.shinyTokensEarned += tokens;
    gameState.rogue.totalShinyTokens += tokens;
    
    showShinyTokenAnimation(tokens);
    showToast(`üíé Chain bank√©e !\n+${tokens} Shiny Tokens`, 'success');
    
    endExpeditionRun('banked');
    saveGame();
};


window.attemptExpeditionCapture = function(ballType){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(!currentFloor || !currentFloor.eventResult || currentFloor.eventResult.type !== 'encounter') return;
    
    const pokemon = currentFloor.eventResult.pokemon;
    if(!pokemon) return;
    
    if(runState.ballsAvailable <= 0){
        showToast('Plus de Pok√© Balls!', 'error');
        return;
    }
    
    runState.ballsAvailable--;
    
    let captureRate = calculateCaptureRate(ballType, pokemon.rarity, false);
    
    // Appliquer le bonus de ballUpgrade1 (+25% au lieu de remplacer la ball)
    if (gameState.rogue.unlocks?.ballUpgrade1 && !gameState.rogue.unlocks?.ballUpgrade2) {
        captureRate = Math.min(captureRate * 1.25, 1.0);
    }
    
    if(runState.tempBuffs && runState.tempBuffs.length > 0){
        for(const buff of runState.tempBuffs){
            // V√©rifier les buffs de type 'capture' ET 'captureBoost' (puzzle)
            if(buff.type === 'capture' || buff.type === 'captureBoost'){
                if(buff.value >= 1.0){
                    captureRate = 1.0;
                } else {
                    captureRate = Math.min(captureRate + buff.value, 1.0);
                }
            }
        }
    }
    
    let shinyRate = calculateExpeditionShinyRate(pokemon.id);
    if(runState.tempBuffs && runState.tempBuffs.length > 0){
        for(const buff of runState.tempBuffs){
            if(buff.type === 'shiny'){
                shinyRate = Math.min(shinyRate + buff.value, 1.0);
            }
        }
    }
    
    const success = Math.random() < captureRate;
    
    if(success){
        const wasNew = !gameState.captured.has(pokemon.id);
        addToCollection(pokemon.id, pokemon.isShiny);
        
        const isTarget = runState.targetPokemonId === pokemon.id;
        let coinsEarned = EXPEDITION_CONFIG.coinsPerCapture[pokemon.rarity] || 120;
        if(runState.tempBuffs && runState.tempBuffs.length > 0){
            for(const buff of runState.tempBuffs){
                if(buff.type === 'coins'){
                    coinsEarned = Math.floor(coinsEarned * buff.value);
                }
            }
        }
        const xpEarned = EXPEDITION_CONFIG.xpPerCapture[pokemon.rarity] || 10;
        const buddyXpEarned = EXPEDITION_CONFIG.buddyXpPerCapture[pokemon.rarity] || 1;
        
        runState.rewards.coins += coinsEarned;
        
        if(runState.tempBuffs && runState.tempBuffs.length > 0){
            runState.tempBuffs = runState.tempBuffs.filter(buff => {
                buff.duration--;
                return buff.duration > 0;
            });
        }
        runState.rewards.xp += xpEarned;
        runState.rewards.buddyXp += buddyXpEarned;
        
        // Appliquer l'XP imm√©diatement pour mettre √† jour la barre
        gameState.xp += xpEarned;
        checkLevelUp();
        updateUI();
        
        runState.chain = (runState.chain || 0) + 1;
        if(runState.chain > runState.maxChain) runState.maxChain = runState.chain;
        
        runState.rewards.pokemonCaptured.push({
            id: pokemon.id,
            name: pokemon.name,
            isShiny: pokemon.isShiny,
            rarity: pokemon.rarity,
            wasNew: wasNew
        });
        
        // R√©initialiser le flag de baie utilis√©e apr√®s capture r√©ussie
        runState.currentEncounterBerryUsed = null;
        
        // NOUVEAU : Effets visuels premium
        const encounterDiv = document.getElementById('expedition-event-panel');
        if (window.FX && encounterDiv) {
            FX.shockwave(encounterDiv); // Onde de choc
        }
        
        // Animation flash de succ√®s premium
        const flash = document.createElement('div');
        flash.className = 'capture-flash capture-success-flash';
        flash.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; animation: flashFade 0.5s ease-out; background: radial-gradient(circle, rgba(16,185,129,0.3) 0%, transparent 70%);';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 500);
        
        const isBoss = currentFloor.eventResult && currentFloor.eventResult.isBoss;
        
        // G√©rer les shinies
        if(pokemon.isShiny){
            runState.rewards.shiniesCount++;
            const tokens = awardShinyTokens(pokemon, {isTarget: isTarget, isBoss: isBoss || false});
            
            // Effets premium pour shiny
            if (window.FX) {
                FX.confetti(window.innerWidth/2, window.innerHeight/2, 100);
                FX.stars(window.innerWidth/2, window.innerHeight/2, 30);
                FX.screenShake();
            }
            
            // Confetti pour shiny (ancien syst√®me en fallback)
            if (typeof launchShinyConfetti === 'function') launchShinyConfetti();
            
            // Notification discr√®te pour shiny (remplace la popup)
            const shinyMsg = `‚ú® ${pokemon.name} SHINY captur√©!${isTarget ? ' üéØ TARGET' : ''}${isBoss ? ' üëë BOSS' : ''}\n+${coinsEarned}üí∞ +${xpEarned}XP +${tokens}‚ú® tokens`;
            showStyledToast(shinyMsg, 'success');
        } else if(pokemon.rarity === 'legendary'){
            // G√©rer les l√©gendaires (non-shiny) - pas de tokens shiny
            // Effets premium pour l√©gendaire
            if (window.FX) {
                FX.confetti(window.innerWidth/2, window.innerHeight/2, 50);
                FX.stars(window.innerWidth/2, window.innerHeight/2, 15);
            }
            
            // Notification pour l√©gendaire (sans mentionner "SHINY")
            const legendaryMsg = `üëë ${pokemon.name} L√âGENDAIRE captur√©!${isTarget ? ' üéØ TARGET' : ''}${isBoss ? ' üëë BOSS' : ''}\n+${coinsEarned}üí∞ +${xpEarned}XP`;
            showStyledToast(legendaryMsg, 'success');
        } else {
            const buddyId = runState.buddyId;
            const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
            const category = pokemon.rarity === 'legendary' ? 'capture_success_rare' : ['rare', 'super_rare'].includes(pokemon.rarity) ? 'capture_success_rare' : 'capture_success_common';
            showNarration(category, {pokemonName: pokemon.name, buddyName: buddyName, chain: runState.chain || 0});
            showStyledToast(`‚úÖ ${pokemon.name} captur√©!\n+${coinsEarned}üí∞ +${xpEarned}XP`, 'success');
            
            // Animation de succ√®s avec Pok√©ball
            const encounterPanel = document.getElementById('expedition-event-panel');
            if(encounterPanel) {
                encounterPanel.style.animation = 'captureSuccess 1.5s ease-out';
                const successOverlay = document.createElement('div');
                successOverlay.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle,rgba(34,197,94,0.3) 0%,transparent 70%);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:20px;';
                successOverlay.innerHTML = '<div style="font-size:4em;animation:bounceIn 0.5s ease;">‚úÖ</div>';
                encounterPanel.appendChild(successOverlay);
                setTimeout(() => {
                    successOverlay.remove();
                    encounterPanel.style.animation = '';
                }, 1500);
            }
        }
        
        if(runState.buddyId && buddyXpEarned > 0){
            addExpeditionBuddyXP(runState.buddyId, buddyXpEarned);
        }
        
        // Animation Chain +1
        animateChainIncrement(runState.chain);
        applyExpeditionRewards({coins: coinsEarned, xp: xpEarned});
        
        currentFloor.completed = true;
        setTimeout(() => continueExpeditionAfterEvent(), 2500);
    } else {
        // Animation flash d'√©chec
        const flash = document.createElement('div');
        flash.className = 'capture-flash';
        flash.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; animation: flashFade 0.5s ease-out; background: radial-gradient(circle, rgba(239,68,68,0.2) 0%, transparent 70%);';
        document.body.appendChild(flash);
        setTimeout(() => flash.remove(), 500);
        
        const buddyId = runState.buddyId;
        const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
        const hasProtector = buddyId && gameState.buddy.buddies[buddyId] && gameState.buddy.buddies[buddyId].talents && gameState.buddy.buddies[buddyId].talents.includes('protector');
        
        if(hasProtector && Math.random() < 0.3){
            // Chain sauv√©e par Protector
            showNarration('capture_fail_chain_saved', {pokemonName: pokemon.name, buddyName: buddyName});
            showStyledToast('üõ°Ô∏è Talent Protector activ√© ! Chain sauv√©e !', 'warning');
        } else {
            runState.chain = 0;
            runState.chainBroken = true;
            // Briser aussi la cha√Æne persistante
            gameState.rogue.persistentChain = 0;
            animateChainBreak();
            showNarration('capture_fail_chain_break', {pokemonName: pokemon.name, buddyName: buddyName});
            showStyledToast(`‚ùå ${pokemon.name} s'est √©chapp√©...\nüíî Chain perdue !`, 'error');
        }
        updateChainDisplay();
        
        currentFloor.completed = true;
        setTimeout(() => continueExpeditionAfterEvent(), 2000);
    }
    
    saveGame();
};

window.fleeExpeditionEncounter = function(){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(!currentFloor || !currentFloor.eventResult || currentFloor.eventResult.type !== 'encounter') return;
    
    // R√©initialiser le flag de baie utilis√©e lors de la fuite
    runState.currentEncounterBerryUsed = null;
    
    runState.chain = 0;
    runState.chainBroken = true;
    updateChainDisplay();
    
    showToast('Vous avez fui! Chain bris√©e!', 'info');
    
    currentFloor.completed = true;
    continueExpeditionAfterEvent();
    saveGame();
};

function showShinyCelebration(pokemon, isTarget, isBoss, tokens){
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; position: relative; overflow: visible; box-shadow: 0 0 20px rgba(255,215,0,0.5), 0 0 40px rgba(255,215,0,0.3); animation: bounceIn 0.5s ease, shinyGlow 2s ease-in-out infinite;">
            <div style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 3em; animation: starTwinkle 1.5s ease-in-out infinite; animation-delay: 0s;">‚≠ê</div>
            <div style="position: absolute; top: -20px; left: 20%; font-size: 2em; animation: starTwinkle 1.5s ease-in-out infinite; animation-delay: 0.3s;">‚ú®</div>
            <div style="position: absolute; top: -20px; right: 20%; font-size: 2em; animation: starTwinkle 1.5s ease-in-out infinite; animation-delay: 0.6s;">‚ú®</div>
            <div style="position: absolute; bottom: -20px; left: 30%; font-size: 2em; animation: starTwinkle 1.5s ease-in-out infinite; animation-delay: 0.9s;">‚ú®</div>
            <div style="position: absolute; bottom: -20px; right: 30%; font-size: 2em; animation: starTwinkle 1.5s ease-in-out infinite; animation-delay: 1.2s;">‚ú®</div>
            <div style="font-size: 4em; margin-bottom: 20px; animation: starTwinkle 2s ease-in-out infinite;">‚ú®</div>
            <h2 style="color: white; margin-bottom: 20px; font-size: 2em; text-shadow: 0 0 20px rgba(255,255,255,0.8);">SHINY CAPTUR√â!</h2>
            ${isTarget ? '<div style="color: white; font-weight: bold; margin-bottom: 15px; font-size: 1.2em; text-shadow: 0 0 15px rgba(255,255,255,0.6);">üéØ TARGET SHINY!</div>' : ''}
            ${isBoss ? '<div style="color: white; font-weight: bold; margin-bottom: 15px; font-size: 1.2em; text-shadow: 0 0 15px rgba(255,255,255,0.6);">üëë BOSS SHINY!</div>' : ''}
            <div style="position: relative; display: inline-block; margin: 20px 0;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px; pointer-events: none;">
                    <div style="position: absolute; top: 0; left: 50%; width: 5px; height: 5px; background: #FFD700; border-radius: 50%; --tx: 0px; --ty: -100px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 0s;"></div>
                    <div style="position: absolute; top: 50%; left: 0; width: 5px; height: 5px; background: #FFD700; border-radius: 50%; --tx: -100px; --ty: 0px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 0.4s;"></div>
                    <div style="position: absolute; top: 50%; right: 0; width: 5px; height: 5px; background: #FFD700; border-radius: 50%; --tx: 100px; --ty: 0px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 0.8s;"></div>
                    <div style="position: absolute; bottom: 0; left: 50%; width: 5px; height: 5px; background: #FFD700; border-radius: 50%; --tx: 0px; --ty: 100px; animation: shinyParticles 2.5s ease-in-out infinite; animation-delay: 1.2s;"></div>
                    <div style="position: absolute; top: 25%; left: 25%; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: -75px; --ty: -75px; animation: shinyParticles 3s ease-in-out infinite; animation-delay: 0.2s;"></div>
                    <div style="position: absolute; top: 25%; right: 25%; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: 75px; --ty: -75px; animation: shinyParticles 3s ease-in-out infinite; animation-delay: 0.6s;"></div>
                    <div style="position: absolute; bottom: 25%; left: 25%; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: -75px; --ty: 75px; animation: shinyParticles 3s ease-in-out infinite; animation-delay: 1s;"></div>
                    <div style="position: absolute; bottom: 25%; right: 25%; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; --tx: 75px; --ty: 75px; animation: shinyParticles 3s ease-in-out infinite; animation-delay: 1.4s;"></div>
                </div>
                <img src="${getAnimatedSpriteUrl(pokemon.id, true)}" 
                     style="width: 200px; height: 200px; image-rendering: pixelated; filter: drop-shadow(0 0 30px #FFD700); position: relative; z-index: 1; animation: shinyFloat 3s ease-in-out infinite;">
            </div>
            <div style="font-size: 1.5em; font-weight: bold; color: white; margin-top: 15px; text-shadow: 0 0 10px rgba(255,255,255,0.6);">‚ú® ${pokemon.name} ‚ú®</div>
            <div style="color: white; margin-top: 20px; font-size: 1.2em; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.5);">
                üíé +${tokens} Shiny Tokens
            </div>
            <button onclick="this.closest('.modal').remove()" style="margin-top: 25px; padding: 12px 30px; background: rgba(255,255,255,0.2); border: 2px solid white; border-radius: 25px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)';">
                Incroyable!
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    setTimeout(() => {
        if(modal.parentNode) modal.remove();
    }, 5000);
}

window.continueExpeditionAfterEvent = function(){
    if(!runState || !runState.active) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(!currentFloor) return;
    
    const wasAlreadyCompleted = currentFloor.completed;
    currentFloor.completed = true;
    
    const isBoss = currentFloor.eventResult && (currentFloor.eventResult.type === 'boss' || currentFloor.eventResult.isBoss);
    
    // Attribution de tokens lors du clear d'une room (une seule fois)
    if(!wasAlreadyCompleted){
        const bossCaptured = isBoss && currentFloor.eventResult && currentFloor.eventResult.pokemon;
        const isBossShiny = bossCaptured && currentFloor.eventResult.pokemon && currentFloor.eventResult.pokemon.isShiny;
        
        if(isBoss && bossCaptured && !isBossShiny){
            // Boss captur√© (non-shiny) = 5 tokens
            // Si c'est un Shiny Boss, les tokens sont d√©j√† donn√©s par awardShinyTokens()
            const tokens = 5;
            runState.rewards.shinyTokensEarned += tokens;
            gameState.rogue.totalShinyTokens += tokens;
            showShinyTokenAnimation(tokens);
            
            // Puces M√©moire : Boss = 5-10 puces
            const memoryChips = 5 + Math.floor(Math.random() * 6); // 5-10
            if (!runState.rewards.memoryChips) runState.rewards.memoryChips = 0;
            runState.rewards.memoryChips += memoryChips;
            if (!gameState.inventory.memory_chips) gameState.inventory.memory_chips = 0;
            gameState.inventory.memory_chips += memoryChips;
            showToast(`üíæ +${memoryChips} Puces M√©moire`, 'info');
        } else if(!isBoss){
            // Room normale clear = 1 token (symbolique pour le progr√®s)
            const tokens = 1;
            runState.rewards.shinyTokensEarned += tokens;
            gameState.rogue.totalShinyTokens += tokens;
            
            // Puces M√©moire : Ennemi normal = 1-3 puces
            const memoryChips = 1 + Math.floor(Math.random() * 3); // 1-3
            if (!runState.rewards.memoryChips) runState.rewards.memoryChips = 0;
            runState.rewards.memoryChips += memoryChips;
            if (!gameState.inventory.memory_chips) gameState.inventory.memory_chips = 0;
            gameState.inventory.memory_chips += memoryChips;
        }
        // Si c'est un Shiny Boss, on ne donne rien ici car awardShinyTokens() a d√©j√† donn√© les tokens
    }
    
    if(isBoss){
        endExpeditionRun('complete');
        return;
    }
    
    runState.currentFloorIndex = (runState.currentFloorIndex || 0) + 1;
    
    if(runState.currentFloorIndex >= runState.maxFloors){
        endExpeditionRun('complete');
        return;
    }
    
    showExpeditionMap();
    saveGame();
};

window.bankExpeditionRun = function(){
    window.bankExpeditionChain();
};

window.buyExpeditionItem = function(itemId, price, qty){
    if(!runState || !runState.active) return;
    
    if(runState.rewards.coins < price){
        showToast('Pas assez de coins!', 'error');
        return;
    }
    
    runState.rewards.coins -= price;
    
    if(itemId === 'pokeball'){
        runState.ballsAvailable += qty;
    } else {
        if(!runState.rewards.items[itemId]) runState.rewards.items[itemId] = 0;
        runState.rewards.items[itemId] += qty;
    }
    
    showToast(`‚úÖ ${ALL_ITEMS[itemId]?.name || itemId} achet√©!`, 'success');
    showExpeditionMap();
    saveGame();
};

window.useExpeditionSanctuary = function(berryId){
    if(gameState.inventory[berryId] <= 0){
        showToast('Plus de baies!', 'error');
        return;
    }
    
    gameState.inventory[berryId]--;
    
    const buffs = {
        framby: {type: 'captureBoost', value: 0.15, duration: 3, name: '+15% Capture Rate'},
        pinap: {type: 'coinBoost', value: 0.30, duration: 3, name: '+30% Coins'},
        ceriz: {type: 'shinyBoost', value: 0.02, duration: 3, name: '+2% Shiny Rate'}
    };
    
    const buff = buffs[berryId];
    if(buff){
        runState.tempBuffs.push(buff);
        showToast(`‚úÖ B√©n√©diction: ${buff.name}`, 'success');
    }
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(currentFloor) currentFloor.eventResult.sanctuaryUsed = true;
    
    saveGame();
    continueExpeditionAfterEvent();
};

window.attemptExpeditionPuzzle = function(){
    const bar = document.getElementById('puzzle-bar');
    const target = document.getElementById('puzzle-target');
    const button = document.getElementById('puzzle-button');
    const attemptsCount = document.getElementById('puzzle-attempts-count');
    
    if(!bar || !target || !button) return;
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(!currentFloor || !currentFloor.eventResult) return;
    
    currentFloor.eventResult.attempts = (currentFloor.eventResult.attempts || 0) + 1;
    const attemptsLeft = (currentFloor.eventResult.maxAttempts || 3) - currentFloor.eventResult.attempts;
    
    const barWidth = parseFloat(bar.style.width) || 0;
    const targetLeft = parseFloat(target.style.left) || 70;
    const targetWidth = parseFloat(target.style.width) || 12;
    
    const isInRange = barWidth >= targetLeft && barWidth <= (targetLeft + targetWidth);
    
    if(isInRange){
        button.disabled = true;
        button.textContent = '‚úÖ Succ√®s!';
        
        const coinsEarned = 100;
        const captureBuff = {type: 'captureBoost', value: 0.20, duration: 2, name: '+20% Capture Rate'};
        
        runState.rewards.coins += coinsEarned;
        runState.tempBuffs.push(captureBuff);
        
        showToast(`‚úÖ Puzzle r√©ussi!\n+${coinsEarned}üí∞ +${captureBuff.name}`, 'success');
        
        currentFloor.eventResult.puzzleCompleted = true;
        
        setTimeout(() => continueExpeditionAfterEvent(), 1500);
    } else {
        if(attemptsLeft <= 0){
            button.disabled = true;
            button.textContent = '‚è≠Ô∏è Passage automatique';
            showToast('‚è≠Ô∏è Passage automatique apr√®s 3 essais', 'info');
            currentFloor.eventResult.puzzleCompleted = true;
            setTimeout(() => continueExpeditionAfterEvent(), 1500);
        } else {
            button.textContent = `‚ùå Rat√©! (${attemptsLeft} restants)`;
            if(attemptsCount) attemptsCount.textContent = attemptsLeft;
            setTimeout(() => {
                button.textContent = '‚ö° Appuyer!';
            }, 1000);
        }
    }
    
    saveGame();
};

function startPuzzleGame(){
    const bar = document.getElementById('puzzle-bar');
    if(!bar) return;
    
    let width = 0;
    let direction = 1;
    
    const interval = setInterval(() => {
        width += direction * 2;
        
        if(width >= 100){
            width = 100;
            direction = -1;
        } else if(width <= 0){
            width = 0;
            direction = 1;
        }
        
        bar.style.width = width + '%';
    }, 50);
    
    const currentFloor = runState.floorsData[runState.currentFloorIndex || 0];
    if(currentFloor){
        currentFloor._puzzleInterval = interval;
    }
}

function applyExpeditionRewards(rewards){
    if(!rewards) return;
    
    if(rewards.coins){
        runState.rewards.coins += rewards.coins;
    }
    
    if(rewards.items){
        rewards.items.forEach(item => {
            if(!runState.rewards.items[item.id]) runState.rewards.items[item.id] = 0;
            runState.rewards.items[item.id] += item.qty;
        });
    }
    
    if(rewards.shards){
        rewards.shards.forEach(shard => {
            runState.rewards.shardsEarned.push(shard);
        });
    }
}

function addExpeditionBuddyXP(buddyId, amount){
    if(!buddyId || !gameState.buddy.buddies[buddyId]) return;
    
    const buddy = gameState.buddy.buddies[buddyId];
    buddy.xp = (buddy.xp || 0) + amount;
    
    const oldLevel = buddy.level || 1;
    const xpToNext = EXPEDITION_CONFIG.buddyXpCurve(buddy.level || 1);
    
    while(buddy.xp >= xpToNext && buddy.level < 20){
        buddy.level = (buddy.level || 1) + 1;
        const newXpToNext = EXPEDITION_CONFIG.buddyXpCurve(buddy.level);
        
        if(buddy.level > oldLevel){
            checkBuddyTalentUnlock(buddyId, buddy.level);
        }
    }
}

function checkBuddyTalentUnlock(buddyId, level){
    const talent = EXPEDITION_CONFIG.buddyTalents[level];
    if(!talent) return;
    
    const buddy = gameState.buddy.buddies[buddyId];
    if(!buddy.talents) buddy.talents = [];
    
    if(!buddy.talents.includes(talent.id)){
        buddy.talents.push(talent.id);
        showToast(`üéâ Talent d√©bloqu√©: ${talent.name}!\n${talent.desc}`, 'success');
    }
}

function endExpeditionRun(result){
    if(!runState || !runState.active) return;
    
    const isFullClear = result === 'complete';
    
    if(isFullClear){
        gameState.rogue.fullClearsCount++;
        runState.rewards.coins += 500;
        runState.rewards.xp += 250;
    } else {
        gameState.rogue.pityCounter++;
    }
    
    gameState.rogue.runsCompleted++;
    
    // R√©compense garantie de Blueprint tous les 5 runs compl√©t√©es
    if (gameState.rogue.runsCompleted % 5 === 0) {
        const blueprintPool = [
            {id: 'blueprint_ocean', name: 'Plan Oc√©an'},
            {id: 'blueprint_cave', name: 'Plan Grotte'},
            {id: 'blueprint_volcano', name: 'Plan Volcan'},
            {id: 'blueprint_power_plant', name: 'Plan Centrale'},
            {id: 'blueprint_graveyard', name: 'Plan Cimeti√®re'}
        ];
        // Donner un blueprint al√©atoire qu'on n'a pas encore
        const ownedBlueprints = blueprintPool.filter(bp => gameState.inventory[bp.id] > 0);
        const availableBlueprints = blueprintPool.filter(bp => !gameState.inventory[bp.id] || gameState.inventory[bp.id] === 0);
        
        if (availableBlueprints.length > 0) {
            const blueprint = availableBlueprints[Math.floor(Math.random() * availableBlueprints.length)];
            if (!runState.rewards.items) runState.rewards.items = {};
            runState.rewards.items[blueprint.id] = (runState.rewards.items[blueprint.id] || 0) + 1;
            showToast(`üéÅ R√©compense sp√©ciale : ${blueprint.name} obtenu ! (Run #${gameState.rogue.runsCompleted})`, 'success');
        }
    }
    
    gameState.coins += runState.rewards.coins;
    gameState.xp += runState.rewards.xp;
    
    for(const [itemId, qty] of Object.entries(runState.rewards.items || {})){
        gameState.inventory[itemId] = (gameState.inventory[itemId] || 0) + qty;
        
        // GENESIS REBOOT - Trigger narratif si blueprint trouv√©
        if (itemId.startsWith('blueprint_')) {
            triggerNarrative('blueprint_found');
        }
    }
    
    gameState.rogue.totalShinyTokens += runState.rewards.shinyTokensEarned || 0;
    
    // Ajouter les Puces M√©moire gagn√©es pendant la run
    if (runState.rewards.memoryChips && runState.rewards.memoryChips > 0) {
        if (!gameState.inventory.memory_chips) gameState.inventory.memory_chips = 0;
        gameState.inventory.memory_chips += runState.rewards.memoryChips;
    }
    
    // Compter correctement les floors cleared
    let floorsCleared = 0;
    const maxFloors = runState.maxFloors || EXPEDITION_CONFIG.baseFloors;
    
    for(let i = 0; i < runState.floorsData.length && i < maxFloors; i++){
        const floor = runState.floorsData[i];
        if(!floor || !floor.completed) continue;
        
        const eventResult = floor.eventResult;
        if(!eventResult) continue;
        
        let isCleared = false;
        
        if(eventResult.type === 'encounter' || (eventResult.type === 'boss') || eventResult.isBoss){
            // Un encounter/boss est cleared seulement si le pok√©mon a √©t√© captur√©
            const pokemonId = eventResult.pokemon?.id;
            if(pokemonId){
                const wasCaptured = runState.rewards.pokemonCaptured.some(p => p.id === pokemonId);
                isCleared = wasCaptured;
            } else {
                // Pas de pok√©mon = pas cleared
                isCleared = false;
            }
        } else if(eventResult.type === 'puzzle'){
            // Un puzzle est cleared seulement s'il a √©t√© r√©ussi
            isCleared = eventResult.puzzleCompleted === true;
        } else {
            // Tous les autres types (chest, merchant, trap, sanctuary, empty, boss) sont toujours cleared
            isCleared = true;
        }
        
        if(isCleared) floorsCleared++;
    }
    
    // Sauvegarder la cha√Æne persistante si la run est compl√©t√©e (m√™me si pas full clear)
    if (result === 'complete' || result === 'banked') {
        // La cha√Æne est conserv√©e si on termine la run (compl√®te ou bank√©e)
        gameState.rogue.persistentChain = runState.chain || 0;
    } else {
        // Si la run √©choue, la cha√Æne est perdue
        gameState.rogue.persistentChain = 0;
    }
    
    gameState.rogue.lastRunRewards = {
        maxChain: runState.maxChain || 0,
        shiniesCount: runState.rewards.shiniesCount || 0,
        floorsCleared: floorsCleared,
        maxFloors: maxFloors,
        time: Math.floor((Date.now() - runState.startTime) / 1000),
        rewards: runState.rewards
    };
    
    runState.active = false;
    saveGame();
    updateUI();
    
    showExpeditionRunSummary(isFullClear);
}

function getRunPerformanceMessage(runData){
const {maxChain, shiniesCount, floorsCleared, targetCaptured, targetShiny, buddyName} = runData;
if(targetShiny){
return {icon:'üéØ‚ú®',title:'LE JACKPOT ULTIME !!!',text:`Tu as captur√© ton Target EN VERSION SHINY ! C'est l'accomplissement supr√™me ! Ton Buddy ${buddyName} n'en revient toujours pas...`};
}
if(targetCaptured){
return {icon:'üéØ',title:'MISSION ACCOMPLIE !',text:`Tu as captur√© ton Target ! Exactement ce que tu cherchais. Ton Buddy ${buddyName} est fier de toi !`};
}
if(floorsCleared >= 7 && maxChain >= 50){
return {icon:'üëë',title:'PERFORMANCE L√âGENDAIRE !',text:`Full Clear avec une Chain de ${maxChain} ! Tu domines compl√®tement l'Exp√©dition. ${buddyName} t'acclame !`};
}
if(shiniesCount >= 3){
return {icon:'‚ú®',title:'CHASSEUR DE SHINIES EXPERT !',text:`${shiniesCount} Shinies captur√©s en une seule run ! Tu ma√Ætrises l'art de la chasse. ${buddyName} est impressionn√© !`};
}
if(maxChain >= 100){
return {icon:'‚õìÔ∏è',title:'MA√éTRE DE LA CHAIN !',text:`Chain ${maxChain} ! Tu as atteint le maximum absolu. Les shinies n'ont plus de secrets pour toi !`};
}
if(floorsCleared >= 7){
return {icon:'üèÜ',title:'FULL CLEAR ACCOMPLI !',text:`Tu as termin√© tous les floors ! Quelle endurance ! Ton Buddy ${buddyName} est √©puis√© mais heureux !`};
}
if(maxChain >= 10){
return {icon:'‚≠ê',title:'BONNE EXP√âDITION !',text:`Chain de ${maxChain}, c'est un bon d√©but ! Continue √† t'am√©liorer avec ${buddyName} !`};
}
return {icon:'üí™',title:'L\'EXP√âDITION √âTAIT DIFFICILE',text:`Ce n'√©tait pas facile, mais tu as gagn√© de l'exp√©rience ! ${buddyName} apprend de ses erreurs. La prochaine sera meilleure !`};
}
function showExpeditionRunSummary(isFullClear){
const modal = document.createElement('div');
modal.className = 'modal active';
modal.style.cssText = 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';
const rewards = gameState.rogue.lastRunRewards;
if(!rewards) return;
const minutes = Math.floor(rewards.time / 60);
const seconds = rewards.time % 60;
const buddyId = runState?.buddyId || gameState.buddy?.activeBuddyId;
const buddyName = buddyId ? FRENCH_NAMES[buddyId] : 'ton Buddy';
const performanceMsg = getRunPerformanceMessage({
maxChain: rewards.maxChain,
shiniesCount: rewards.shiniesCount,
floorsCleared: rewards.floorsCleared,
targetCaptured: rewards.rewards.pokemonCaptured.some(p => runState?.targetPokemonId === p.id),
targetShiny: rewards.rewards.pokemonCaptured.some(p => runState?.targetPokemonId === p.id && p.isShiny),
buddyName: buddyName
});
const pokemonHTML = rewards.rewards.pokemonCaptured.map((p, idx) => `
<div class="captured-pokemon ${p.isShiny ? 'shiny' : ''} ${runState?.targetPokemonId === p.id ? 'target' : ''}" style="background: rgba(255,255,255,0.7); border-radius: 16px; padding: 16px; text-align: center; border: 2px solid rgba(125,95,255,0.2); position: relative; animation: pokemonSlideIn 0.5s ease-out backwards; animation-delay: ${idx * 0.1}s;">
<img src="${getAnimatedSpriteUrl(p.id, p.isShiny)}" style="width: 80px; height: 80px; image-rendering: pixelated; margin-bottom: 8px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));">
<div style="font-size: 14px; font-weight: 600; color: var(--expedition-text-primary); margin-bottom: 4px;">${p.isShiny ? '‚ú® ' : ''}${p.name}${p.isShiny ? ' ‚ú®' : ''}</div>
${runState?.targetPokemonId === p.id ? '<div style="position: absolute; top: -8px; right: -8px; background: linear-gradient(135deg, #ff6b9d, #ff8fab); color: white; font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(255,107,157,0.4);">TARGET ‚úì</div>' : ''}
</div>
`).join('');
modal.innerHTML = `
<div style="background: var(--expedition-gradient-panel); padding: 40px; border-radius: 24px; max-width: 600px; width: 100%; box-shadow: var(--expedition-shadow-lg); border: 2px solid rgba(125,95,255,0.2); position: relative; overflow: hidden;">
<div style="text-align: center; margin-bottom: 32px; position: relative;">
<h1 class="summary-title" style="font-size: 36px; font-weight: 900; background: var(--expedition-gradient-header); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0 0 12px 0; animation: titleBounce 0.6s ease-out;">${performanceMsg.icon} ${performanceMsg.title}</h1>
<div style="font-size: 16px; color: var(--expedition-text-secondary); font-weight: 500;">${performanceMsg.text}</div>
</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px;">
<div class="stat-hero" style="background: rgba(255,255,255,0.7); border-radius: 16px; padding: 24px 16px; text-align: center; border: 2px solid rgba(125,95,255,0.2); animation: statPop 0.5s ease-out backwards; animation-delay: 0.1s;">
<div style="font-size: 32px; margin-bottom: 8px;">‚õìÔ∏è</div>
<div style="font-size: 36px; font-weight: 900; color: var(--expedition-accent-primary); line-height: 1; margin-bottom: 4px;">${rewards.maxChain}</div>
<div style="font-size: 12px; font-weight: 600; color: var(--expedition-text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Chain Max</div>
</div>
<div class="stat-hero" style="background: rgba(255,255,255,0.7); border-radius: 16px; padding: 24px 16px; text-align: center; border: 2px solid rgba(125,95,255,0.2); animation: statPop 0.5s ease-out backwards; animation-delay: 0.2s;">
<div style="font-size: 32px; margin-bottom: 8px;">‚ú®</div>
<div style="font-size: 36px; font-weight: 900; color: var(--expedition-accent-primary); line-height: 1; margin-bottom: 4px;">${rewards.shiniesCount}</div>
<div style="font-size: 12px; font-weight: 600; color: var(--expedition-text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Shinies</div>
</div>
<div class="stat-hero" style="background: rgba(255,255,255,0.7); border-radius: 16px; padding: 24px 16px; text-align: center; border: 2px solid rgba(125,95,255,0.2); animation: statPop 0.5s ease-out backwards; animation-delay: 0.3s;">
<div style="font-size: 32px; margin-bottom: 8px;">üìç</div>
<div style="font-size: 36px; font-weight: 900; color: var(--expedition-accent-primary); line-height: 1; margin-bottom: 4px;">${rewards.floorsCleared}/${rewards.maxFloors || 10}</div>
<div style="font-size: 12px; font-weight: 600; color: var(--expedition-text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Full Clear</div>
</div>
</div>
<div style="margin-bottom: 32px;">
<h3 style="font-size: 20px; font-weight: 700; color: var(--expedition-text-primary); margin: 0 0 16px 0; text-align: center;">üéÅ R√©compenses</h3>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
<div class="reward-item" style="background: rgba(255,255,255,0.7); border-radius: 12px; padding: 16px 12px; text-align: center; border: 2px solid rgba(125,95,255,0.15); animation: rewardPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards; animation-delay: 0.1s;">
<div style="font-size: 28px; margin-bottom: 8px;">üí∞</div>
<div style="font-size: 20px; font-weight: 700; color: var(--expedition-accent-primary); margin-bottom: 4px;">${rewards.rewards.coins || 0}</div>
<div style="font-size: 11px; font-weight: 600; color: var(--expedition-text-muted); text-transform: uppercase;">Coins</div>
</div>
<div class="reward-item" style="background: rgba(255,255,255,0.7); border-radius: 12px; padding: 16px 12px; text-align: center; border: 2px solid rgba(125,95,255,0.15); animation: rewardPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards; animation-delay: 0.2s;">
<div style="font-size: 28px; margin-bottom: 8px;">üíé</div>
<div style="font-size: 20px; font-weight: 700; color: var(--expedition-accent-primary); margin-bottom: 4px;">${rewards.rewards.shinyTokensEarned || 0}</div>
<div style="font-size: 11px; font-weight: 600; color: var(--expedition-text-muted); text-transform: uppercase;">Tokens</div>
</div>
<div class="reward-item" style="background: rgba(255,255,255,0.7); border-radius: 12px; padding: 16px 12px; text-align: center; border: 2px solid rgba(125,95,255,0.15); animation: rewardPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards; animation-delay: 0.3s;">
<div style="font-size: 28px; margin-bottom: 8px;">‚≠ê</div>
<div style="font-size: 20px; font-weight: 700; color: var(--expedition-accent-primary); margin-bottom: 4px;">${rewards.rewards.xp || 0}</div>
<div style="font-size: 11px; font-weight: 600; color: var(--expedition-text-muted); text-transform: uppercase;">XP</div>
</div>
<div class="reward-item" style="background: rgba(255,255,255,0.7); border-radius: 12px; padding: 16px 12px; text-align: center; border: 2px solid rgba(125,95,255,0.15); animation: rewardPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards; animation-delay: 0.4s;">
<div style="font-size: 28px; margin-bottom: 8px;">‚è±Ô∏è</div>
<div style="font-size: 20px; font-weight: 700; color: var(--expedition-accent-primary); margin-bottom: 4px;">${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}</div>
<div style="font-size: 11px; font-weight: 600; color: var(--expedition-text-muted); text-transform: uppercase;">Temps</div>
</div>
</div>
</div>
${rewards.rewards.pokemonCaptured.length > 0 ? `
<div style="margin-bottom: 32px;">
<h3 style="font-size: 20px; font-weight: 700; color: var(--expedition-text-primary); margin: 0 0 16px 0; text-align: center;">üèÜ Pok√©mon Captur√©s</h3>
<div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
${pokemonHTML}
</div>
</div>
` : ''}
<div style="display: flex; gap: 12px;">
<button onclick="this.closest('.modal').remove(); const topBar=document.querySelector('.top-bar'); const bottomNav=document.querySelector('.bottom-nav'); const newBottomNav=document.querySelector('.new-bottom-nav'); if(topBar)topBar.style.display='flex'; if(bottomNav)bottomNav.style.display='flex'; if(newBottomNav)newBottomNav.style.display='flex'; renderExpeditionPage();" class="btn-summary btn-summary--primary" style="flex: 1; padding: 16px 24px; border-radius: 14px; font-size: 16px; font-weight: 700; border: none; cursor: pointer; transition: all 0.3s ease; background: var(--expedition-gradient-button); color: white; box-shadow: 0 4px 16px rgba(125,95,255,0.4);" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 24px rgba(125,95,255,0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(125,95,255,0.4)'">
‚Üê Retour
</button>
</div>
</div>
`;
document.body.appendChild(modal);
modal.addEventListener('click', (e) => {
if(e.target === modal) modal.remove();
});
}

function generateRunModifiers(){const possibleModifiers=[{id:'fog',name:'Brouillard',effect:{captureRate:-0.10},icon:'üå´Ô∏è'},{id:'glow',name:'Lueur',effect:{rareRate:0.10},icon:'‚ú®'},{id:'wind',name:'Vent Fort',effect:{fleeRate:0.15},icon:'üí®'},{id:'luck',name:'Chance',effect:{shinyRate:0.02},icon:'üçÄ'}];const count=Math.random()<0.5?1:2;const selected=[];for(let i=0;i<count;i++){const mod=possibleModifiers[Math.floor(Math.random()*possibleModifiers.length)];if(!selected.find(m=>m.id===mod.id))selected.push(mod);}return selected;}
function generateFloors(count){const floors=[];for(let i=0;i<count;i++){const isBoss=(i===count-1);floors.push({index:i,isBoss:isBoss,doors:generateDoors(isBoss),completed:false});}return floors;}
function generateDoors(isBoss){if(isBoss){return[{index:0,hint:'üëë Boss',event:ROGUE_EVENTS.boss}];}const doors=[];for(let i=0;i<3;i++){const event=selectRandomEvent();doors.push({index:i,hint:getHintForEvent(event),event:event});}return doors;}
function selectRandomEvent(){const weights=Object.values(ROGUE_EVENTS).filter(e=>e.weight>0).map(e=>e.weight);const total=weights.reduce((a,b)=>a+b,0);let rand=Math.random()*total;for(const event of Object.values(ROGUE_EVENTS)){if(event.weight<=0)continue;rand-=event.weight;if(rand<=0)return event;}return ROGUE_EVENTS.encounter;}
function getHintForEvent(event){const hints={encounter:['Bruyant üëÇ','Traces üêæ','Mouvement üëÄ'],item:['Brillant ‚ú®','Coffre üì¶','Tr√©sor üíé'],shop:['Musique üéµ','Fum√©e üí®','√âtal üõí'],trap:['Suspect ‚ö†Ô∏è','Danger üíÄ','Pi√®ge üï≥Ô∏è'],blessing:['Paisible üïäÔ∏è','Sacr√© ‚õ™','Lumi√®re üåü'],heal:['Chaud üå°Ô∏è','Calme üòå','Repos ‚õÖ'],rest:['Confort üõãÔ∏è','D√©tente üå∏','Pause ‚òï']};const options=hints[event.type]||['??? ‚ùì'];return options[Math.floor(Math.random()*options.length)];}
function addBuddyXP(amount){const buddyId=gameState.buddy.activeBuddyId;if(!buddyId)return;const buddy=gameState.buddy.buddies[buddyId]||{xp:0,level:1,talents:[],cosmetics:[],energy:100,hp:100};const oldLevel=buddy.level||1;buddy.xp=(buddy.xp||0)+amount;const nextLevelXP=EXPEDITION_CONFIG.buddyXpCurve(buddy.level||1);while((buddy.xp||0)>=nextLevelXP&&(buddy.level||1)<20){buddy.level=(buddy.level||1)+1;const newXpToNext=EXPEDITION_CONFIG.buddyXpCurve(buddy.level);if(buddy.level>oldLevel){checkBuddyTalentUnlock(buddyId,buddy.level);}}if(!gameState.buddy.buddies[buddyId])gameState.buddy.buddies[buddyId]=buddy;renderBuddyDisplay();saveGame();}
function applyBuddyBlessingsToRun(){const buddyId=gameState.buddy.activeBuddyId;if(!buddyId)return;const buddy=gameState.buddy.buddies[buddyId]||{xp:0,level:1,talents:[],cosmetics:[],energy:100,hp:100};if((buddy.level||1)<10)return;const blessings=[{id:'captureBoost',name:'+10% Capture (3 floors)',effect:()=>{runState.tempBuffs.push({type:'captureBoost',value:0.10,duration:3});}},{id:'reroll',name:'+1 Reroll de porte',effect:()=>{runState.rerollsAvailable=1;}},{id:'freeItem',name:'Item gratuit (baie rare)',effect:()=>{runState.itemsEarned.ceriz=(runState.itemsEarned.ceriz||0)+1;}},{id:'ghostLife',name:'1 vie fant√¥me (fuite ignor√©e)',effect:()=>{runState.ghostLives=1;}}];const chosen=blessings[Math.floor(Math.random()*blessings.length)];chosen.effect();showToast(`üåü B√©n√©diction Buddy : ${chosen.name}`,'success');}
function saveGame(){const saveData={...gameState,captured:Array.from(gameState.captured),shinies:Array.from(gameState.shinies),evolved:Array.from(gameState.evolved),unlockedRegions:Array.from(gameState.unlockedRegions),unlockedBadges:Array.from(gameState.unlockedBadges),golden:gameState.golden?Array.from(gameState.golden):[],claimedQuests:{daily:Array.from(gameState.claimedQuests.daily),special:Array.from(gameState.claimedQuests.special),permanent:Array.from(gameState.claimedQuests.permanent)},activeBoosts:gameState.activeBoosts.map(b=>({...b})),lastSaved:Date.now()};localStorage.setItem('pokemonGameV62',JSON.stringify(saveData));if(window.SupabaseManager&&window.SupabaseManager.isLoggedIn()){if(window.saveTimeout)clearTimeout(window.saveTimeout);window.saveTimeout=setTimeout(()=>{if(window.SupabaseManager&&!window.SupabaseManager.isLoadingCloud){window.SupabaseManager.save();updateLeaderboardScores();}},3000);}}

function checkLoginStreak(){const today=new Date().toDateString();const lastLogin=gameState.lastLoginDate?new Date(gameState.lastLoginDate).toDateString():null;if(lastLogin===today)return;const yesterday=new Date(Date.now()-86400000).toDateString();if(lastLogin===yesterday){gameState.loginStreak++;}else{gameState.loginStreak=1;}gameState.lastLoginDate=Date.now();updateQuestProgress('login_streak',gameState.loginStreak);saveGame();}
window.showRogueEntryModal=function(){const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;';const runsLeft=1-gameState.rogueMeta.dailyRunsUsed+gameState.rogueMeta.runTickets;modal.innerHTML=`<div style="background: rgba(0,0,0,0.8); border: 2px solid rgba(102,126,234,0.5); padding: 40px; border-radius: 20px; max-width: 500px; width: 90%;"><h1 style="color: white; text-align: center; margin: 0 0 20px 0;">üó∫Ô∏è Exp√©dition Arcanes</h1><div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid rgba(102,126,234,0.3);"><div style="color: white; font-size: 1.2em; margin-bottom: 10px;">Runs disponibles : ${runsLeft} üé´</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Dur√©e : ~8 minutes | 10 floors</div></div><div style="margin-bottom: 20px;"><h3 style="color: white; margin-bottom: 10px;">üì¶ Choisir 3 items √† emporter</h3><div id="rogue-item-selector" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">${generateItemSelectorHTML()}</div></div><button onclick="confirmRogueStart()" class="btn btn--primary btn--full-width" style="padding: 15px; font-size: 1.1em;">üöÄ D√©marrer l'Exp√©dition</button><button onclick="this.closest('.modal').remove()" class="btn btn--outline btn--full-width" style="padding: 12px; margin-top: 10px;">Annuler</button></div>`;document.body.appendChild(modal);}
function generateItemSelectorHTML(){const selectableItems=['pokeball','greatball','ultraball','framby','pinap','ceriz'];let html='';for(const itemId of selectableItems){const item=ALL_ITEMS[itemId];const qty=gameState.inventory[itemId]||0;if(qty>0){html+=`<label style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; cursor: pointer; text-align: center;"><input type="checkbox" class="rogue-item-choice" data-item="${itemId}" data-max="${Math.min(qty,3)}" onchange="updateRogueItemSelection()" style="margin-bottom: 5px;"><div style="font-size: 1.5em; display: flex; align-items: center; justify-content: center;">${getItemIconDisplay(itemId, '24px')}</div><div style="color: white; font-size: 0.8em;">${item.name}</div><div style="color: #FFD700; font-size: 0.7em;">√ó${qty}</div><select class="rogue-item-qty" data-item="${itemId}" style="width: 100%; margin-top: 5px; display: none;">${Array.from({length:Math.min(qty,3)},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}</select></label>`;}}return html;}
window.updateRogueItemSelection=function(){const checkboxes=document.querySelectorAll('.rogue-item-choice:checked');if(checkboxes.length>3){checkboxes[checkboxes.length-1].checked=false;showToast('Maximum 3 items !','error');return;}document.querySelectorAll('.rogue-item-choice').forEach(cb=>{const qtySelect=cb.parentElement.querySelector('.rogue-item-qty');qtySelect.style.display=cb.checked?'block':'none';});}
window.confirmRogueStart=function(){const selectedItems=[];document.querySelectorAll('.rogue-item-choice:checked').forEach(cb=>{const itemId=cb.dataset.item;const qty=parseInt(cb.parentElement.querySelector('.rogue-item-qty').value);selectedItems.push({id:itemId,qty:qty});});document.querySelector('.modal.active')?.remove();startRogueRun(selectedItems);}
window.startRogueRun=function(selectedItems=[]){checkDailyRunReset();if(gameState.rogueMeta.dailyRunsUsed>=1&&gameState.rogueMeta.runTickets<=0){showToast('‚ùå Plus de runs disponibles !','error');return;}if(gameState.rogueMeta.dailyRunsUsed<1){gameState.rogueMeta.dailyRunsUsed++;}else{gameState.rogueMeta.runTickets--;}const modifiers=generateRunModifiers();const floorCount=10+(gameState.rogueMeta.rogueUnlocks.extraFloor?1:0);runState={floors:generateFloors(floorCount),currentFloorIdx:0,currentRoom:0,selectedItems:selectedItems.map(item=>({id:item.id,qtyUsed:0,qtyMax:item.qty})),ballsLeft:15+(gameState.rogueMeta.rogueUnlocks.extraBall?1:0),tempBuffs:[],modifiers:modifiers,coinsEarned:0,shardsEarned:0,xpEarned:0,itemsEarned:{},pokemonCaptured:[],pokemonAttempted:[],ghostLives:0,usingFramby:false,usingCeriz:false,sanctuaryActive:false};gameState.rogueMeta.runsStarted++;applyBuddyBlessingsToRun();showRogueIntro();}
let currentRoguePokemon=null;
function showRogueIntro(){const container=document.createElement('div');container.id='rogue-map-container';container.style.cssText='position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';const buddyId=gameState.buddy?.activeBuddyId;const buddySprite=buddyId?getAnimatedSpriteUrl(buddyId, false):'assets/POKEMON PNG/buddies/buddy_empty.png';container.innerHTML=`<div style="background: rgba(0,0,0,0.9); border: 2px solid rgba(102,126,234,0.5); padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; text-align: center; position: relative;"><h1 style="color: white; margin-bottom: 20px; font-size: 2em;">üó∫Ô∏è Exp√©dition Arcanes</h1><div style="color: rgba(255,255,255,0.9); margin-bottom: 30px; line-height: 1.6;">Progressez de salle en salle, choisissez votre chemin et survivez jusqu'au boss final.</div><div style="display: flex; justify-content: center; align-items: center; margin-bottom: 30px;"><img src="${buddySprite}" style="width: 120px; height: 120px; image-rendering: pixelated; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));" alt="Buddy"></div><button onclick="startRogueRoom()" class="btn btn--primary btn--large" style="padding: 15px 40px; font-size: 1.2em; width: 100%; margin-bottom: 10px;">üöÄ Commencer l'Exp√©dition</button><button onclick="bankRogueRun()" class="btn btn--outline" style="padding: 12px 30px; width: 100%;">Retour au menu</button></div>`;document.body.appendChild(container);}
function startRogueRoom(){const container=document.getElementById('rogue-map-container');if(!container||!runState)return;const floor=runState.floors[runState.currentFloorIdx];if(!floor){endRogueRun('complete');return;}const isBoss=floor.isBoss;const bgType=isBoss?'boss':Math.random()<0.2?'special':'default';const bgPath=`assets/POKEMON PNG/rogue/backgrounds/room_${bgType}.png`;container.innerHTML=`<div style="position: relative; width: 100%; height: 100%; background-image: url('${bgPath}'); background-size: cover; background-position: center; border-radius: 15px; overflow: hidden;"><div style="position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10;"><div style="background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 10px; color: white;"><div style="font-weight: bold; margin-bottom: 5px;">Salle ${runState.currentRoom+1} - Floor ${runState.currentFloorIdx+1}/${runState.floors.length}</div><div style="font-size: 0.9em; color: rgba(255,255,255,0.8);">‚öæ ${runState.ballsLeft} | üí∞ ${runState.coinsEarned} | üíé ${runState.shardsEarned}</div></div><button onclick="bankRogueRun()" style="background: rgba(239, 68, 68, 0.8); border: none; color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">üí∞ Bank</button></div><div style="position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center; z-index: 10;"><div id="rogue-event-content"></div></div><div id="rogue-doors-container" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 10;"></div></div>`;if(floor.completed){continueRogueAfterEvent();}else{const contentEl=document.getElementById('rogue-event-content');const doorsEl=document.getElementById('rogue-doors-container');if(!contentEl||!doorsEl)return;contentEl.innerHTML=`<div style="margin-bottom: 20px; color: rgba(255,255,255,0.9); font-size: 1.1em; line-height: 1.6;">Vous entrez dans une salle silencieuse... une √©trange sensation flotte dans l'air.</div>`;doorsEl.style.display='flex';const doorLabels=['A','B','C'];floor.doors.forEach((door,idx)=>{const doorBtn=document.createElement('button');doorBtn.onclick=()=>chooseRogueDoor(idx);doorBtn.style.cssText='background: rgba(255,255,255,0.1); border: 3px solid #667eea; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center; min-width: 120px;';doorBtn.innerHTML=`<img src="assets/POKEMON PNG/rogue/doors/door_${doorLabels[idx]}.png" style="width: 80px; height: 80px; image-rendering: pixelated; margin-bottom: 10px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));"><div style="color: white; font-weight: bold; font-size: 1.2em; margin-bottom: 5px;">Porte ${doorLabels[idx]}</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${door.hint}</div>`;doorBtn.onmouseover=()=>{doorBtn.style.background='rgba(102,126,234,0.3)';doorBtn.style.transform='scale(1.05)';};doorBtn.onmouseout=()=>{doorBtn.style.background='rgba(255,255,255,0.1)';doorBtn.style.transform='scale(1)';};doorsEl.appendChild(doorBtn);});}}
function resolveRogueEvent(event){if(!runState)return;const contentEl=document.getElementById('rogue-event-content');const doorsEl=document.getElementById('rogue-doors-container');if(!contentEl)return;currentRoguePokemon=null;let narration='',iconPath='',rewards='',actions='';switch(event.type){case 'encounter':{const pokemon=selectPokemonForRogue(runState.currentFloorIdx);pokemon.rarity=runState.currentFloorIdx>=runState.floors.length-1?'rare':pokemon.rarity;currentRoguePokemon=pokemon;narration=`Un Pok√©mon sauvage appara√Æt dans la salle !`;iconPath=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.isShiny?'shiny/':''}${pokemon.id}.png`;contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="${iconPath}" style="width: 150px; height: 150px; image-rendering: pixelated; filter: ${pokemon.isShiny?'drop-shadow(0 0 15px #FFD700)':'drop-shadow(0 4px 8px rgba(0,0,0,0.5))'}; animation: pokemonFloat 2s ease-in-out infinite;"></div><h2 style="color: white; margin-bottom: 10px;">${pokemon.isShiny?'‚ú® ':''}${pokemon.name}${pokemon.isShiny?' ‚ú®':''}</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${narration}</p><div style="display: flex; gap: 10px; justify-content: center;"><button onclick="attemptRogueEncounterCapture('pokeball')" class="btn btn--primary" style="padding: 12px 24px;">‚öæ Capturer</button><button onclick="fleeRogueEncounter()" class="btn btn--outline" style="padding: 12px 24px;">üèÉ Fuir</button></div>`;if(doorsEl)doorsEl.style.display='none';return;}case 'boss':{const pokemon=selectPokemonForRogue(999);pokemon.rarity='legendary';currentRoguePokemon=pokemon;narration=`Vous sentez une pr√©sence √©crasante...`;iconPath=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.isShiny?'shiny/':''}${pokemon.id}.png`;contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="assets/POKEMON PNG/rogue/events/boss.png" style="width: 80px; height: 80px; image-rendering: pixelated; margin-bottom: 10px;"></div><h2 style="color: #FFD700; margin-bottom: 10px; font-size: 1.8em;">üëë BOSS FINAL</h2><div style="margin-bottom: 20px;"><img src="${iconPath}" style="width: 180px; height: 180px; image-rendering: pixelated; filter: ${pokemon.isShiny?'drop-shadow(0 0 20px #FFD700)':'drop-shadow(0 6px 12px rgba(0,0,0,0.6))'}; animation: pokemonFloat 2s ease-in-out infinite;"></div><h3 style="color: white; margin-bottom: 10px;">${pokemon.isShiny?'‚ú® ':''}${pokemon.name}${pokemon.isShiny?' ‚ú®':''}</h3><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${narration}</p><div style="display: flex; gap: 10px; justify-content: center;"><button onclick="attemptRogueEncounterCapture('pokeball')" class="btn btn--primary" style="padding: 12px 24px; background: linear-gradient(135deg, #ef4444, #dc2626);">‚öæ Capturer</button></div>`;if(doorsEl)doorsEl.style.display='none';return;}case 'item':{const itemPool=['pokeball','greatball','ultraball','framby','pinap','ceriz'];const itemId=itemPool[Math.floor(Math.random()*itemPool.length)];const item=ALL_ITEMS[itemId];const qty=Math.floor(Math.random()*2)+1;runState.itemsEarned[itemId]=(runState.itemsEarned[itemId]||0)+qty;narration=`Vous trouvez un objet pos√© sur un pi√©destal.`;iconPath=`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/${itemId.replace('_','-')}.png`;rewards=`+${qty}√ó ${item.icon} ${item.name}`;contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="assets/POKEMON PNG/rogue/events/item.png" style="width: 80px; height: 80px; image-rendering: pixelated;"></div><h2 style="color: white; margin-bottom: 10px;">üéÅ Trouvaille d'objet</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">${narration}</p><div style="background: rgba(255,215,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px; color: #FFD700; font-size: 1.2em; font-weight: bold;">${rewards}</div><button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>`;if(doorsEl)doorsEl.style.display='none';showRewardSparkles(rewards);return;}case 'trap':{const lossType=Math.random()<0.5?'balls':'rate';if(lossType==='balls'){const ballsLost=1+Math.floor(Math.random()*3);runState.ballsLeft=Math.max(0,runState.ballsLeft-ballsLost);narration=`Un pi√®ge se d√©clenche sous vos pieds ! Vous perdez ${ballsLost} Pok√© Ball${ballsLost>1?'s':''}.`;}else{runState.tempBuffs.push({type:'captureMalus',value:-0.20,duration:1});narration=`Un pi√®ge se d√©clenche ! -20% capture rate au prochain floor.`;}iconPath='assets/POKEMON PNG/rogue/events/trap.png';contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="${iconPath}" style="width: 80px; height: 80px; image-rendering: pixelated;"></div><h2 style="color: #ef4444; margin-bottom: 10px;">üí• Pi√®ge !</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${narration}</p><button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>`;if(doorsEl)doorsEl.style.display='none';return;}case 'blessing':{const blessings=[{name:'+15% Capture Rate',effect:()=>{runState.tempBuffs.push({type:'captureBoost',value:0.15,duration:3});}},{name:'+30% Coins',effect:()=>{runState.tempBuffs.push({type:'coinBoost',value:0.30,duration:5});}},{name:'+1 Salle Gratuite',effect:()=>{runState.ghostLives++;}}];const chosen=blessings[Math.floor(Math.random()*blessings.length)];chosen.effect();narration=`Une puissance myst√©rieuse vous b√©nit... ${chosen.name}`;iconPath='assets/POKEMON PNG/rogue/events/blessing.png';contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="${iconPath}" style="width: 80px; height: 80px; image-rendering: pixelated; animation: blessingGlow 2s ease-in-out infinite;"></div><h2 style="color: #8b5cf6; margin-bottom: 10px;">üíô B√©n√©diction</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${narration}</p><button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>`;if(doorsEl)doorsEl.style.display='none';return;}case 'heal':{narration=`Une aura r√©paratrice vous entoure.`;iconPath='assets/POKEMON PNG/rogue/events/heal.png';contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="${iconPath}" style="width: 80px; height: 80px; image-rendering: pixelated;"></div><h2 style="color: #10b981; margin-bottom: 10px;">‚ù§Ô∏è Soin</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${narration}</p><button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>`;if(doorsEl)doorsEl.style.display='none';return;}case 'shop':{narration=`Un marchand errant appara√Æt !`;iconPath='assets/POKEMON PNG/rogue/events/shop.png';const items=['pokeball','greatball','framby','pinap'];const merchantItems=[];for(let i=0;i<3;i++){const itemId=items[Math.floor(Math.random()*items.length)];const item=ALL_ITEMS[itemId];merchantItems.push({id:itemId,name:item.name,icon:item.icon,price:Math.floor(item.price*0.8)});}contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="${iconPath}" style="width: 80px; height: 80px; image-rendering: pixelated;"></div><h2 style="color: white; margin-bottom: 10px;">üè™ Boutique</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${narration}</p><div style="display: grid; gap: 10px; margin-bottom: 20px;">${merchantItems.map(mi=>`<button onclick="buyRogueItem('${mi.id}',${mi.price})" class="btn btn--primary" style="padding: 12px; display: flex; justify-content: space-between; align-items: center;">${mi.icon} ${mi.name}<span>${mi.price}üí∞</span></button>`).join('')}</div><button onclick="continueRogueAfterEvent()" class="btn btn--outline" style="padding: 12px 30px; width: 100%;">Passer</button>`;if(doorsEl)doorsEl.style.display='none';return;}case 'rest':{narration=`Vous vous accordez un moment de repos...`;iconPath='assets/POKEMON PNG/rogue/events/rest.png';contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="${iconPath}" style="width: 80px; height: 80px; image-rendering: pixelated;"></div><h2 style="color: #3b82f6; margin-bottom: 10px;">üí§ Repos</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${narration}</p><button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>`;if(doorsEl)doorsEl.style.display='none';return;}}}
window.attemptRogueEncounterCapture=function(ballType){if(!runState||!currentRoguePokemon)return;if(runState.ballsLeft<=0){showToast('‚ùå Plus de Pok√© Ball !','error');return;}let captureRate=calculateCaptureRate(ballType,currentRoguePokemon.rarity,runState.usingFramby||false);if(runState.usingCeriz&&currentRoguePokemon.isShiny)captureRate=1.0;for(const mod of runState.modifiers){if(mod.effect.captureRate)captureRate+=mod.effect.captureRate;}for(const buff of runState.tempBuffs){if(buff.type==='captureBoost')captureRate+=buff.value;if(buff.type==='captureMalus')captureRate+=buff.value;}captureRate=Math.max(0,Math.min(1,captureRate));const success=Math.random()<captureRate;runState.ballsLeft--;if(runState.inventory&&runState.inventory[ballType])runState.inventory[ballType]--;else gameState.inventory[ballType]--;const contentEl=document.getElementById('rogue-event-content');if(!contentEl)return;if(success){contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${currentRoguePokemon.isShiny?'shiny/':''}${currentRoguePokemon.id}.png" style="width: 150px; height: 150px; image-rendering: pixelated; filter: ${currentRoguePokemon.isShiny?'drop-shadow(0 0 15px #FFD700)':'drop-shadow(0 4px 8px rgba(0,0,0,0.5))'}; animation: captureSuccess 2s ease-out;"></div><h2 style="color: #10b981; margin-bottom: 10px;">‚úÖ Captur√© !</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${currentRoguePokemon.name} a √©t√© captur√© !</p><div style="background: rgba(16,185,129,0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px; color: #10b981; font-size: 1.1em; font-weight: bold;">+${currentRoguePokemon.rarity==='legendary'?1000:currentRoguePokemon.rarity==='super_rare'?500:currentRoguePokemon.rarity==='rare'?250:currentRoguePokemon.rarity==='uncommon'?100:50} üí∞</div><button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>`;runState.pokemonCaptured.push(currentRoguePokemon);addToCollection(currentRoguePokemon.id,currentRoguePokemon.isShiny);const coins={common:50,uncommon:100,rare:250,super_rare:500,legendary:1000}[currentRoguePokemon.rarity];runState.coinsEarned+=coins;const buddyId=gameState.buddy?.activeBuddyId;if(buddyId){let buddyXP=1;if(currentRoguePokemon.rarity==='rare')buddyXP=2;if(currentRoguePokemon.rarity==='super_rare')buddyXP=3;if(currentRoguePokemon.rarity==='legendary')buddyXP=5;if(currentRoguePokemon.isShiny)buddyXP+=5;addBuddyXP(buddyXP);}showRewardSparkles(`+${coins} üí∞`);const style=document.createElement('style');style.textContent='@keyframes captureSuccess{0%{transform:scale(1) rotate(0deg);opacity:1;}50%{transform:scale(0.5) rotate(180deg);opacity:0.7;}100%{transform:scale(1) rotate(360deg);opacity:1;}}';if(!document.getElementById('capture-success-anim')){style.id='capture-success-anim';document.head.appendChild(style);}}else{if(runState.ghostLives>0){runState.ghostLives--;runState.pokemonCaptured.push(currentRoguePokemon);addToCollection(currentRoguePokemon.id,currentRoguePokemon.isShiny);contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${currentRoguePokemon.isShiny?'shiny/':''}${currentRoguePokemon.id}.png" style="width: 150px; height: 150px; image-rendering: pixelated;"></div><h2 style="color: #8b5cf6; margin-bottom: 10px;">üåü Vie Fant√¥me !</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">Vie fant√¥me activ√©e ! ${currentRoguePokemon.name} captur√© !</p><button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>`;}else{contentEl.innerHTML=`<div style="margin-bottom: 20px;"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${currentRoguePokemon.isShiny?'shiny/':''}${currentRoguePokemon.id}.png" style="width: 150px; height: 150px; image-rendering: pixelated;"></div><h2 style="color: #ef4444; margin-bottom: 10px;">‚ùå Rat√© !</h2><p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">${currentRoguePokemon.name} s'est lib√©r√© !${runState.ballsLeft<=0?' Plus de Pok√© Balls !':''}</p>${runState.ballsLeft<=0?'<button onclick="continueRogueAfterEvent()" class="btn btn--primary" style="padding: 12px 30px;">Continuer</button>':'<div style="display: flex; gap: 10px; justify-content: center;"><button onclick="attemptRogueEncounterCapture(\'pokeball\')" class="btn btn--primary" style="padding: 12px 24px;">‚öæ R√©essayer</button><button onclick="fleeRogueEncounter()" class="btn btn--outline" style="padding: 12px 24px;">üèÉ Fuir</button></div>'}`;}}}
window.fleeRogueEncounter=function(){if(!runState)return;continueRogueAfterEvent();}
window.continueRogueAfterEvent=function(){const contentEl=document.getElementById('rogue-event-content');const doorsEl=document.getElementById('rogue-doors-container');if(!contentEl||!doorsEl||!runState)return;const floor=runState.floors[runState.currentFloorIdx];if(!floor)return;if(floor.completed&&floor.isBoss){endRogueRun('complete');return;}if(floor.completed){runState.currentFloorIdx++;if(runState.currentFloorIdx>=runState.floors.length){endRogueRun('complete');return;}runState.currentRoom=0;startRogueRoom();return;}contentEl.innerHTML='';doorsEl.innerHTML='';doorsEl.style.display='flex';const doorLabels=['A','B','C'];floor.doors.forEach((door,idx)=>{const doorBtn=document.createElement('button');doorBtn.onclick=()=>chooseRogueDoor(idx);doorBtn.style.cssText='background: rgba(255,255,255,0.1); border: 3px solid #667eea; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center; min-width: 120px;';doorBtn.innerHTML=`<img src="assets/POKEMON PNG/rogue/doors/door_${doorLabels[idx]}.png" style="width: 80px; height: 80px; image-rendering: pixelated; margin-bottom: 10px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));"><div style="color: white; font-weight: bold; font-size: 1.2em; margin-bottom: 5px;">Porte ${doorLabels[idx]}</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${door.hint}</div>`;doorBtn.onmouseover=()=>{doorBtn.style.background='rgba(102,126,234,0.3)';doorBtn.style.transform='scale(1.05)';};doorBtn.onmouseout=()=>{doorBtn.style.background='rgba(255,255,255,0.1)';doorBtn.style.transform='scale(1)';};doorsEl.appendChild(doorBtn);});}
window.chooseRogueDoor=function(doorIndex){if(!runState)return;const floor=runState.floors[runState.currentFloorIdx];if(!floor||floor.completed)return;const door=floor.doors[doorIndex];if(!door)return;floor.completed=true;floor.chosenDoor=doorIndex;runState.currentRoom++;const event=door.event;resolveRogueEvent(event);}
function showRewardSparkles(rewardText){const container=document.getElementById('rogue-map-container');if(!container)return;for(let i=0;i<8;i++){const sparkle=document.createElement('img');sparkle.src='assets/POKEMON PNG/UI/particle_star.png';sparkle.style.cssText=`position: absolute; width: 30px; height: 30px; left: ${50+Math.random()*40}%; top: ${40+Math.random()*20}%; pointer-events: none; z-index: 1000; animation: sparkleFloat 2s ease-out forwards; animation-delay: ${i*0.1}s;`;container.appendChild(sparkle);setTimeout(()=>sparkle.remove(),2000+i*100);}const style=document.createElement('style');style.textContent='@keyframes sparkleFloat{0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1;}100%{transform:translateY(-100px) rotate(360deg) scale(0);opacity:0;}}';if(!document.getElementById('sparkle-anim')){style.id='sparkle-anim';document.head.appendChild(style);}}
window.buyRogueItem=function(itemId,price){if(runState.coinsEarned<price){showToast('Pas assez de coins !','error');return;}runState.coinsEarned-=price;const item=runState.selectedItems.find(si=>si.id===itemId);if(item){item.qtyMax++;}else{runState.selectedItems.push({id:itemId,qtyUsed:0,qtyMax:1});}showToast(`${ALL_ITEMS[itemId].name} achet√© !`,'success');}
window.bankRogueRun=function(){if(!confirm('√ätes-vous s√ªr de vouloir quitter et r√©cup√©rer vos r√©compenses actuelles ?'))return;const container=document.getElementById('rogue-map-container');if(container)container.remove();endRogueRun('banked');}
window.endRogueRun=function(result='complete'){if(!runState)return;const isFullClear=result==='complete';const floorsCompleted=runState.currentFloorIdx+1;if(isFullClear){gameState.rogueMeta.fullClearCount++;runState.coinsEarned+=1000;runState.xpEarned+=500;runState.shardsEarned+=Math.random()<0.15?3:1;if(Math.random()<(0.01+gameState.rogueMeta.pityExclusive*0.01)){showToast('üéâ POK√âMON EXCLUSIF OBTENU !','success');gameState.rogueMeta.pityExclusive=0;}else{gameState.rogueMeta.pityExclusive++;}}else{gameState.rogueMeta.failCount++;runState.coinsEarned=Math.max(400,runState.coinsEarned);runState.shardsEarned=Math.max(1,runState.shardsEarned);}gameState.coins+=runState.coinsEarned;gameState.totalCoinsEarned+=runState.coinsEarned;gameState.rogueMeta.shards+=runState.shardsEarned;gameState.rogueMeta.totalShards+=runState.shardsEarned;gameState.xp+=runState.xpEarned;for(const[itemId,qty]of Object.entries(runState.itemsEarned)){gameState.inventory[itemId]=(gameState.inventory[itemId]||0)+qty;}gameState.rogueMeta.runsCompleted++;gameState.rogueMeta.totalFloorsCompleted+=floorsCompleted;gameState.rogueMeta.avgFloorsPerRun=gameState.rogueMeta.totalFloorsCompleted/gameState.rogueMeta.runsCompleted;if(gameState.buddy&&gameState.buddy.pokemonId){const buddyXP=isFullClear?20:floorsCompleted>=3?12:5;addBuddyXP(buddyXP);}updateQuestProgress('rogue_completed',1);if(isFullClear)updateQuestProgress('rogue_full_clear',1);checkLevelUp();saveGame();showRogueRunSummary(runState,result);runState=null;}
function showRogueRunSummary(finalState,result){const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10001; align-items: center; justify-content: center;';const pokemonHTML=finalState.pokemonCaptured.map(p=>`<div style="text-align: center;"><img src="${getAnimatedSpriteUrl(p.id, p.isShiny || false)}" style="width: 64px; height: 64px; image-rendering: pixelated;"><div style="font-size: 0.8em; color: white;">${p.name}</div></div>`).join('');modal.innerHTML=`<div style="background: rgba(0,0,0,0.9); border: 2px solid ${result==='complete'?'rgba(16,185,129,0.5)':'rgba(239,68,68,0.5)'}; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; text-align: center;"><h1 style="color: white; margin: 0 0 20px 0;">${result==='complete'?'üéâ RUN COMPL√âT√âE !':'üíî Run Termin√©e'}</h1><div style="background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;"><div style="color: #FFD700; font-size: 1.5em; margin-bottom: 10px;">+${finalState.coinsEarned} üí∞</div><div style="color: white; margin-bottom: 5px;">+${finalState.xpEarned} XP</div><div style="color: #ec4899; margin-bottom: 5px;">+${finalState.shardsEarned} üíé Shards</div></div>${finalState.pokemonCaptured.length>0?`<div style="margin-bottom: 20px;"><h3 style="color: white;">Pok√©mon Captur√©s</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px;">${pokemonHTML}</div></div>`:''}<button onclick="this.closest('.modal').remove(); switchPage('home');" class="btn btn--primary" style="width: 100%; padding: 15px; margin-top: 10px;">Retour</button><button onclick="this.closest('.modal').remove(); showRogueEntryModal();" class="btn btn--outline" style="width: 100%; padding: 15px; margin-top: 10px;">R√©essayer</button></div>`;document.body.appendChild(modal);}
window.showShardShop=function(){const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';const unlocks=[{id:'extraBall',name:'+1 Pok√© Ball permanent',desc:'D√©marrez chaque run avec 16 balls au lieu de 15',cost:50,icon:'‚öæ',unlocked:gameState.rogueMeta.rogueUnlocks.extraBall},{id:'shinyBoost',name:'+5% Shiny Rate',desc:'Augmente vos chances de shiny de 5% (permanent)',cost:200,icon:'‚ú®',unlocked:gameState.rogueMeta.rogueUnlocks.shinyBoost},{id:'extraFloor',name:'+1 Floor Maximum',desc:'Vos runs auront 7 floors au lieu de 6',cost:150,icon:'üó∫Ô∏è',unlocked:gameState.rogueMeta.rogueUnlocks.extraFloor}];modal.innerHTML=`<div style="background: linear-gradient(135deg, #ec4899, #8b5cf6); padding: 40px; border-radius: 20px; max-width: 600px; width: 100%;"><button onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%;">√ó</button><h1 style="color: white; text-align: center; margin: 0 0 20px 0;">üíé Shop de Shards</h1><div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 30px; text-align: center;"><div style="color: #ec4899; font-size: 2em; font-weight: bold;">${gameState.rogueMeta.shards} üíé</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Shards disponibles</div></div><div style="display: grid; gap: 15px;">${unlocks.map(unlock=>`<div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; ${unlock.unlocked?'opacity: 0.5;':''}"><div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;"><div style="flex: 1;"><div style="font-size: 1.5em; margin-bottom: 5px;">${unlock.icon}</div><div style="color: white; font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">${unlock.name}</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${unlock.desc}</div></div><div style="text-align: right;">${unlock.unlocked?'<div style="color: #10b981; font-weight: bold;">‚úÖ D√©bloqu√©</div>':`<button onclick="buyShardUnlock('${unlock.id}',${unlock.cost})" ${gameState.rogueMeta.shards<unlock.cost?'disabled':''} class="btn btn--primary" style="padding: 10px 20px;">${unlock.cost} üíé</button>`}</div></div></div>`).join('')}</div></div>`;document.body.appendChild(modal);}
window.buyShardUnlock=function(unlockId,cost){if(gameState.rogueMeta.shards<cost){showToast('Pas assez de Shards !','error');return;}gameState.rogueMeta.shards-=cost;gameState.rogueMeta.rogueUnlocks[unlockId]=true;showToast('‚úÖ Unlock d√©bloqu√© !','success');saveGame();document.querySelector('.modal.active')?.remove();showShardShop();}
window.setBuddy = function(input) {
    let pokemonId;
    let isShinyVersion = false;

    // 1. D√©tection intelligente de l'ID et du Shiny
    if (typeof input === 'string' && input.includes('_shiny')) {
        pokemonId = parseInt(input.split('_')[0]);
        isShinyVersion = true;
    } else {
        pokemonId = parseInt(input);
        // V√©rification si on poss√®de le shiny pour forcer l'option si disponible ? 
        // Non, on respecte le choix de l'utilisateur (il a cliqu√© sur Normal ou Shiny dans la modale)
    }

    if (isNaN(pokemonId)) {
        showToast('ID Pok√©mon invalide!', 'error');
        return;
    }

    if (!gameState.captured || !gameState.captured.has(pokemonId)) {
        showToast('Vous devez capturer ce Pok√©mon d\'abord !', 'error');
        return;
    }

    // Initialisation structure Buddy
    if (!gameState.buddy) {
        gameState.buddy = { activeBuddyId: null, buddies: {} };
    }
    if (!gameState.buddy.buddies) {
        gameState.buddy.buddies = {};
    }

    // R√©cup√©ration ou cr√©ation des donn√©es du buddy
    // On conserve l'XP et le niveau s'ils existent d√©j√†
    let buddyData = gameState.buddy.buddies[pokemonId] || {
        xp: 0, 
        level: 1, 
        talents: [], 
        cosmetics: [], 
        energy: 100, 
        hp: 100
    };

    // ‚ö†Ô∏è MISE √Ä JOUR DE L'√âTAT SHINY
    // C'est ici que la magie op√®re : on force l'√©tat shiny selon le choix
    buddyData.isShiny = isShinyVersion;

    // Sauvegarde des donn√©es mises √† jour
    gameState.buddy.buddies[pokemonId] = buddyData;
    gameState.buddy.activeBuddyId = pokemonId;
    
    // GENESIS REBOOT - Introduction narrative du syst√®me Buddy (premi√®re fois)
    if (!gameState.system.narrativeFlags.includes('unlock_buddy_system_shown')) {
        gameState.system.narrativeFlags.push('unlock_buddy_system_shown');
        setTimeout(() => triggerNarrative('unlock_buddy_system'), 1000);
    }

    const pokemonName = (FRENCH_NAMES && FRENCH_NAMES[pokemonId]) ? FRENCH_NAMES[pokemonId] : `Pok√©mon #${pokemonId}`;
    showToast(`‚úÖ ${pokemonName} ${isShinyVersion ? '(Shiny)' : ''} est maintenant votre Buddy !`, 'success');
    
    saveGame();
    updateUI();
    
    // Rafra√Æchissement visuel imm√©diat
    if (typeof renderBuddyDisplay === 'function') renderBuddyDisplay();
    if (typeof renderBuddyHomeDisplay === 'function') renderBuddyHomeDisplay();
    if (typeof renderExpeditionPage === 'function') renderExpeditionPage();
    
    // Fermer les modales
    const modals = document.querySelectorAll('.modal.active');
    modals.forEach(m => m.remove());
};
function renderBuddyDisplay() {
    const topBar = document.querySelector('.top-bar-right');
    if (!topBar) return;
    
    // Nettoyage pr√©ventif
    let buddyDisplay = document.getElementById('buddy-display');
    if (!gameState.buddy || !gameState.buddy.activeBuddyId) {
        if (buddyDisplay) buddyDisplay.remove();
        return;
    }
    
    if (!buddyDisplay) {
        buddyDisplay = document.createElement('div');
        buddyDisplay.id = 'buddy-display';
        // Ins√©rer avant les ressources
        topBar.insertBefore(buddyDisplay, topBar.firstChild);
    }

    const activeId = gameState.buddy.activeBuddyId;
    const buddyData = gameState.buddy.buddies[activeId] || {xp:0, level:1};
    
    // --- LOGIQUE DE D√âTECTION SHINY CORRIG√âE ---
    let pokeId = activeId;
    let isShiny = false;

    if (typeof activeId === 'string' && activeId.includes('_')) {
        pokeId = parseInt(activeId.split('_')[0]);
        isShiny = true;
    } else {
        pokeId = parseInt(activeId);
        isShiny = buddyData.isShiny || false; // V√©rifie la propri√©t√© stock√©e
    }
    // -------------------------------------------

    const nextLevelXP = typeof EXPEDITION_CONFIG !== 'undefined' ? EXPEDITION_CONFIG.buddyXpCurve(buddyData.level||1) : 100;
    const xpProgress = ((buddyData.xp/nextLevelXP)*100).toFixed(0);

    buddyDisplay.style.cssText = 'display: flex; align-items: center; gap: 8px; background: rgba(102, 126, 234, 0.3); padding: 6px 12px; border-radius: 20px; cursor: pointer; margin-right: 10px;';
    buddyDisplay.onclick = () => showBuddyDetail();
    
    // On passe isShiny correctement ici
    buddyDisplay.innerHTML = `
        <img src="${getAnimatedSpriteUrl(pokeId, isShiny)}" style="width: 32px; height: 32px; image-rendering: pixelated; object-fit: contain; object-position: center;">
        <div style="display: flex; flex-direction: column; gap: 2px;">
            <div style="color: white; font-size: 0.85em; font-weight: bold;">LV${buddyData.level||1}${isShiny ? ' ‚ú®' : ''}</div>
            <div style="width: 60px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden;">
                <div style="width: ${xpProgress}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A);"></div>
            </div>
        </div>
    `;
}
function updateRogueUI(){if(!gameState.rogueMeta)return;document.getElementById('rogue-runs-completed').textContent=gameState.rogueMeta.runsCompleted||0;document.getElementById('rogue-shards').textContent=gameState.rogueMeta.shards||0;document.getElementById('rogue-full-clears').textContent=gameState.rogueMeta.fullClearCount||0;document.getElementById('rogue-avg-floors').textContent=(gameState.rogueMeta.avgFloorsPerRun||0).toFixed(1);}
window.showBuddyDetail=function(){if(!gameState.buddy){gameState.buddy={activeBuddyId:null,buddies:{}};}const buddyId=gameState.buddy.activeBuddyId;if(!buddyId){showToast('Aucun Buddy s√©lectionn√© !','info');return;}const buddy=gameState.buddy.buddies[buddyId]||{xp:0,level:1,talents:[],cosmetics:[],energy:100,hp:100};const pokemon=FRENCH_NAMES[buddyId]||`Pok√©mon #${buddyId}`;const nextLevelXP=EXPEDITION_CONFIG.buddyXpCurve(buddy.level||1);const isShiny=buddy.isShiny||false;const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';let talentsHTML='';if(buddy.talents&&buddy.talents.length>0){buddy.talents.forEach(talentId=>{const talentLevels=[3,6,10,15,20];const talentLevel=talentLevels.find(level=>EXPEDITION_CONFIG.buddyTalents[level]?.id===talentId);if(talentLevel){const talent=EXPEDITION_CONFIG.buddyTalents[talentLevel];talentsHTML+=`<div style="background: rgba(16, 185, 129, 0.2); padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #10b981;"><div style="color: white; font-weight: bold;">${talent.name}</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${talent.desc}</div></div>`;}});}let nextTalentHTML='';const nextTalentLevels=[3,6,10,15,20];for(const level of nextTalentLevels){if((buddy.level||1)<level){const talent=EXPEDITION_CONFIG.buddyTalents[level];if(talent&&(!buddy.talents||!buddy.talents.includes(talent.id))){const xpNeeded=EXPEDITION_CONFIG.buddyXpCurve(level);nextTalentHTML=`<div style="background: rgba(102, 126, 234, 0.2); padding: 15px; border-radius: 10px; margin-top: 20px; border: 2px dashed #667eea;"><div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">üéØ Prochain Talent (Niveau ${level})</div><div style="color: white;">${talent.name}: ${talent.desc}</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: 5px;">${xpNeeded-(buddy.xp||0)} XP restants</div></div>`;break;}}}modal.innerHTML=`<div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; max-width: 500px; width: 100%;"><button onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%;">√ó</button><div style="text-align: center; margin-bottom: 20px;"><img src="${getAnimatedSpriteUrl(buddyId, isShiny)}" style="width: 120px; height: 120px; image-rendering: pixelated; object-fit: contain; object-position: center;"><h2 style="color: white; margin: 10px 0 5px 0;">${pokemon}</h2><div style="color: #FFD700; font-size: 1.5em; font-weight: bold;">Niveau ${buddy.level||1}</div></div><div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;"><div style="display: flex; justify-content: space-between; margin-bottom: 8px;"><span style="color: rgba(255,255,255,0.8);">XP</span><span style="color: white; font-weight: bold;">${buddy.xp||0} / ${nextLevelXP}</span></div><div style="width: 100%; height: 12px; background: rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden;"><div style="width: ${((buddy.xp||0)/nextLevelXP*100).toFixed(0)}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.5s;"></div></div></div><div style="margin-bottom: 20px;"><h3 style="color: white; margin-bottom: 10px;">‚ú® Talents D√©bloqu√©s</h3>${talentsHTML||'<div style="color: rgba(255,255,255,0.5); text-align: center;">Aucun talent encore</div>'}</div>${nextTalentHTML}${typeof HELD_ITEMS !== 'undefined' ? `<div style="margin-top: 20px; margin-bottom: 20px;"><h3 style="color: white; margin-bottom: 10px;">üéí Objet Tenu</h3>${(() => { const heldItemId = gameState.buddy.heldItems?.[buddyId]; const heldItem = heldItemId && typeof HELD_ITEMS !== 'undefined' ? HELD_ITEMS[heldItemId] : null; if (heldItem) { return `<div style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; border: 2px solid #FFD700; margin-bottom: 10px;"><div style="display: flex; justify-content: space-between; align-items: center;"><div><div style="font-size: 1.5em; display: inline-block; margin-right: 10px;">${heldItem.icon}</div><div style="display: inline-block;"><div style="color: white; font-weight: bold;">${heldItem.name}</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${heldItem.desc}</div></div></div><button onclick="unequipHeldItem(); this.closest('.modal').remove(); setTimeout(() => showBuddyDetail(), 100);" style="background: rgba(239, 68, 68, 0.3); border: 1px solid #ef4444; color: #ef4444; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">Retirer</button></div></div>`; } else { return `<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; border: 2px dashed rgba(255,255,255,0.3); text-align: center; color: rgba(255,255,255,0.7);">Aucun objet √©quip√©</div>`; } })()}</div>` : ''}<button onclick="this.closest('.modal').remove(); showBuddySelection();" class="btn btn--primary btn--full-width" style="margin-top: 20px; padding: 12px; background: linear-gradient(135deg, #4CAF50, #8BC34A); border: none; color: white; font-weight: bold;">Changer de Buddy</button></div>`;document.body.appendChild(modal);}
// √Ä ajouter dans app.js
window.chooseBuddyVersion = function(pokemonId) {
    // Cr√©er une petite modale de choix
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10002; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: #2C2F33; padding: 30px; border-radius: 20px; text-align: center; border: 2px solid #7289da;">
            <h3 style="color: white; margin-bottom: 20px;">Quelle version choisir ?</h3>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <div onclick="window.setBuddy && window.setBuddy(${pokemonId}); this.closest('.modal').remove(); document.querySelector('.modal.active')?.remove();" 
                     style="cursor: pointer; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                    <img src="${getAnimatedSpriteUrl(pokemonId, false)}" style="width: 80px; height: 80px;">
                    <div style="color: white; margin-top: 5px;">Normal</div>
                </div>
                <div onclick="window.setBuddy && window.setBuddy('${pokemonId}_shiny'); this.closest('.modal').remove(); document.querySelector('.modal.active')?.remove();" 
                     style="cursor: pointer; background: rgba(255,215,0,0.1); border: 1px solid #ffd700; padding: 15px; border-radius: 10px;">
                    <img src="${getAnimatedSpriteUrl(pokemonId, true)}" style="width: 80px; height: 80px;">
                    <div style="color: #ffd700; margin-top: 5px;">‚ú® Shiny</div>
                </div>
            </div>
            <button onclick="this.closest('.modal').remove()" style="margin-top: 20px; background: none; border: none; color: #aaa; cursor: pointer;">Annuler</button>
        </div>
    `;
    document.body.appendChild(modal);
};

window.showBuddySelection = function() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    // FIX SCROLL : align-items: flex-start (pour pouvoir scroller le haut) + overflow-y: auto sur le contenu
    modal.style.cssText = 'display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10001; align-items: flex-start; justify-content: center; overflow-y: auto; padding: 40px 20px;';
    
    const capturedPokemon = Array.from(gameState.captured || []).sort((a, b) => a - b);
    const activeBuddyId = gameState.buddy.activeBuddyId;

    // G√©n√©ration HTML
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; border-radius: 20px; max-width: 800px; width: 100%; margin: auto; position: relative;">
            <button onclick="this.closest('.modal').remove()" style="position: sticky; top: 0; right: 0; float: right; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; z-index: 10;">√ó</button>
            <h1 style="color: white; text-align: center; margin: 0 0 20px 0;">üêæ Choisir un Buddy</h1>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; max-height: 70vh; overflow-y: auto; padding-right: 5px;">
                ${capturedPokemon.map(id => {
                    // Check Shiny
                    const hasShiny = gameState.shinies && gameState.shinies.has(id);
                    // Buddy Data
                    const buddy = (gameState.buddy.buddies || {})[id] || null;
                    
                    // On g√®re le clic : Si shiny dispo -> on pourrait demander, ici on met par d√©faut le normal, 
                    // mais id√©alement on clique -> setBuddy(id).
                    
                    return `
                    <div onclick="${hasShiny ? `window.chooseBuddyVersion(${id})` : `window.setBuddy && window.setBuddy(${id}); document.querySelector('.modal.active').remove();`}" 
                         style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 12px; cursor: pointer; text-align: center; border: 2px solid ${activeBuddyId === id || (typeof activeBuddyId === 'string' && activeBuddyId.startsWith(id + '_')) ? '#10b981' : 'transparent'}; position: relative;">
                        
                        ${hasShiny ? '<div style="position: absolute; top: 5px; right: 5px; font-size: 12px;">‚ú®</div>' : ''}
                        
                        <img src="${getAnimatedSpriteUrl(id, false)}" style="width: 50px; height: 50px; image-rendering: pixelated; object-fit: contain;">
                        <div style="color: white; font-size: 0.8em; font-weight: bold; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${FRENCH_NAMES[id]}
                        </div>
                        ${buddy ? `<div style="color: #FFD700; font-size: 0.7em;">Niv. ${buddy.level||1}</div>` : ''}
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    
    document.body.appendChild(modal);
};
function checkDailyRunReset(){return false;}
function getTotalBalls(){return(gameState.inventory.pokeball||0)+(gameState.inventory.greatball||0)+(gameState.inventory.ultraball||0)+(gameState.inventory.masterball||0)+(gameState.inventory.diveball||0);}
window.applySaveData = function(data) {
    try {
        console.log('üîÑ Application des donn√©es Cloud...', data);
        
        // Fusion profonde des objets imbriqu√©s
        // 1. Fusionner les propri√©t√©s de base (niveau, XP, coins, etc.)
        if (data.level !== undefined) gameState.level = parseInt(data.level) || 1;
        if (data.xp !== undefined) gameState.xp = parseInt(data.xp) || 0;
        if (data.xpToNext !== undefined) gameState.xpToNext = parseInt(data.xpToNext) || 250;
        if (data.coins !== undefined) gameState.coins = parseInt(data.coins) || 0;
        if (data.streak !== undefined) gameState.streak = parseInt(data.streak) || 0;
        if (data.bestStreak !== undefined) gameState.bestStreak = parseInt(data.bestStreak) || 0;
        if (data.totalCaught !== undefined) gameState.totalCaught = parseInt(data.totalCaught) || 0;
        if (data.blindBoxUsed !== undefined) gameState.blindBoxUsed = parseInt(data.blindBoxUsed) || 0;
        if (data.blindBoxSlots !== undefined) gameState.blindBoxSlots = parseInt(data.blindBoxSlots) || 5;
        if (data.blindBoxBonus !== undefined) gameState.blindBoxBonus = parseInt(data.blindBoxBonus) || 0;
        if (data.blindBoxResetTime !== undefined) gameState.blindBoxResetTime = data.blindBoxResetTime;
        if (data.totalBlindBoxOpened !== undefined) gameState.totalBlindBoxOpened = parseInt(data.totalBlindBoxOpened) || 0;
        if (data.blindBoxPity !== undefined) gameState.blindBoxPity = parseInt(data.blindBoxPity) || 0;
        if (data.loginStreak !== undefined) gameState.loginStreak = parseInt(data.loginStreak) || 0;
        if (data.lastLoginDate !== undefined) gameState.lastLoginDate = data.lastLoginDate;
        if (data.lastFishingTokenTime !== undefined) gameState.lastFishingTokenTime = data.lastFishingTokenTime || Date.now();
        if (data.lastReset !== undefined) gameState.lastReset = data.lastReset || Date.now();
        if (data.typeCaptureCounts !== undefined) gameState.typeCaptureCounts = data.typeCaptureCounts || {};
        if (data.totalShopPurchases !== undefined) gameState.totalShopPurchases = parseInt(data.totalShopPurchases) || 0;
        if (data.dailyQuestStreak !== undefined) gameState.dailyQuestStreak = parseInt(data.dailyQuestStreak) || 0;
        if (data.rareCaptureCount !== undefined) gameState.rareCaptureCount = parseInt(data.rareCaptureCount) || 0;
        if (data.currentRegion !== undefined) gameState.currentRegion = data.currentRegion || 'Kanto';
        if (data.tutorialSeen !== undefined) gameState.tutorialSeen = data.tutorialSeen || false;
        if (data.pokedexMode !== undefined) gameState.pokedexMode = data.pokedexMode || 'grid';
        if (data.pokedexRegion !== undefined) gameState.pokedexRegion = data.pokedexRegion || 'Kanto';
        
        // 2. Fusionner l'inventaire (fusion profonde)
        if (data.inventory) {
            if (!gameState.inventory) gameState.inventory = {};
            Object.keys(data.inventory).forEach(key => {
                gameState.inventory[key] = data.inventory[key];
            });
        }
        
        // 3. Fusionner les Sets (captured, shinies, etc.)
        if (data.captured) gameState.captured = new Set(data.captured || []);
        if (data.shinies) gameState.shinies = new Set(data.shinies || []);
        if (data.evolved) gameState.evolved = new Set(data.evolved || []);
        if (data.golden) gameState.golden = new Set(data.golden || []);
        if (data.unlockedRegions) gameState.unlockedRegions = new Set(data.unlockedRegions || ['Kanto']);
        if (data.unlockedBadges) gameState.unlockedBadges = new Set(data.unlockedBadges || []);
        
        // 4. Fusionner les claimedQuests
        if (data.claimedQuests) {
            gameState.claimedQuests = {
                daily: new Set(data.claimedQuests.daily || []),
                special: new Set(data.claimedQuests.special || []),
                permanent: new Set(data.claimedQuests.permanent || [])
            };
        }
        
        // 5. Fusionner les autres objets imbriqu√©s
        if (data.activeBoosts) gameState.activeBoosts = data.activeBoosts || [];
        if (data.captureHistory) gameState.captureHistory = data.captureHistory || [];
        if (data.fishingHistory) gameState.fishingHistory = data.fishingHistory || [];
        if (data.blindBoxHistory) gameState.blindBoxHistory = data.blindBoxHistory || [];
        if (data.regionProgress) {
            if (!gameState.regionProgress) gameState.regionProgress = {};
            Object.keys(data.regionProgress).forEach(key => {
                gameState.regionProgress[key] = { ...gameState.regionProgress[key], ...data.regionProgress[key] };
            });
        }
        if (data.questsProgress) {
            if (!gameState.questsProgress) gameState.questsProgress = { daily: {}, special: {}, permanent: {} };
            if (data.questsProgress.daily) gameState.questsProgress.daily = { ...gameState.questsProgress.daily, ...data.questsProgress.daily };
            if (data.questsProgress.special) gameState.questsProgress.special = { ...gameState.questsProgress.special, ...data.questsProgress.special };
            if (data.questsProgress.permanent) gameState.questsProgress.permanent = { ...gameState.questsProgress.permanent, ...data.questsProgress.permanent };
        }
        if (data.collectionProgress) {
            if (!gameState.collectionProgress) gameState.collectionProgress = {};
            gameState.collectionProgress = { ...gameState.collectionProgress, ...data.collectionProgress };
        }
        if (data.capturedCount) {
            if (!gameState.capturedCount) gameState.capturedCount = {};
            gameState.capturedCount = { ...gameState.capturedCount, ...data.capturedCount };
        }
        if (data.customization) {
            if (!gameState.customization) gameState.customization = {};
            // Pr√©server les titres d√©bloqu√©s existants lors du merge
            const existingUnlockedTitles = gameState.customization.unlockedTitles || [];
            gameState.customization = { ...gameState.customization, ...data.customization };
            // Fusionner les tableaux de titres d√©bloqu√©s (√©viter la perte)
            if (data.customization.unlockedTitles && Array.isArray(data.customization.unlockedTitles)) {
                gameState.customization.unlockedTitles = [...new Set([...existingUnlockedTitles, ...data.customization.unlockedTitles])];
            } else if (existingUnlockedTitles.length > 0) {
                gameState.customization.unlockedTitles = existingUnlockedTitles;
            }
            // S'assurer que pwaModalSeen est initialis√©
            if (gameState.customization.pwaModalSeen === undefined) {
                gameState.customization.pwaModalSeen = false;
            }
        }
        if (data.rogue) {
            if (!gameState.rogue) gameState.rogue = {};
            gameState.rogue = { ...gameState.rogue, ...data.rogue };
        }
        if (data.buddy) {
            if (!gameState.buddy) gameState.buddy = {};
            gameState.buddy = { ...gameState.buddy, ...data.buddy };
        }
        if (data.poker) {
            if (!gameState.poker) gameState.poker = {};
            gameState.poker = { ...gameState.poker, ...data.poker };
        }
        if (data.incubation) {
            if (!gameState.incubation) gameState.incubation = {};
            gameState.incubation = { ...gameState.incubation, ...data.incubation };
        }
        if (data.catchbot) {
            if (!gameState.catchbot) gameState.catchbot = {};
            gameState.catchbot = { ...gameState.catchbot, ...data.catchbot };
        }
        if (data.research) {
            if (!gameState.research) gameState.research = {};
            gameState.research = { ...gameState.research, ...data.research };
            // S'assurer que les habitats sont bien restaur√©s
            if (data.research.habitats) {
                gameState.research.habitats = { ...gameState.research.habitats, ...data.research.habitats };
                // S'assurer que chaque habitat a un slot mascotte
                Object.keys(gameState.research.habitats).forEach(habitatId => {
                    if (!gameState.research.habitats[habitatId].mascotte) {
                        gameState.research.habitats[habitatId].mascotte = null;
                    }
                });
            }
            // S'assurer que les upgrades sont bien restaur√©s
            if (data.research.upgrades) {
                gameState.research.upgrades = { ...gameState.research.upgrades, ...data.research.upgrades };
            } else if (!gameState.research.upgrades) {
                gameState.research.upgrades = { mouse_driver: 0, gpu_overclock: 0, virus_scan: 0 };
            }
            // PERSISTANCE CRITIQUE : V√©rifier que l'automatisation est restaur√©e
            if (data.research.automation) {
                gameState.research.automation = { ...gameState.research.automation, ...data.research.automation };
            } else if (!gameState.research.automation) {
                gameState.research.automation = { researchers: 0, autoClickers: 0 };
            }
            // PERSISTANCE CRITIQUE : V√©rifier que le jardin est restaur√© (plantes en croissance)
            if (data.research.garden) {
                gameState.research.garden = { ...gameState.research.garden, ...data.research.garden };
                // Restaurer les timestamps de croissance des plantes
                if (gameState.research.garden.grid) {
                    gameState.research.garden.grid.forEach(slot => {
                        if (slot.content && slot.content.type === 'plant' && slot.content.growthStart) {
                            // Le timestamp est d√©j√† sauvegard√©, pas besoin de modification
                        }
                    });
                }
            }
            // PERSISTANCE CRITIQUE : V√©rifier que les anomalies sont restaur√©es
            if (data.research.anomalies) {
                gameState.research.anomalies = { ...gameState.research.anomalies, ...data.research.anomalies };
            }
        }
        
        // IMPORTANT : V√©rifier les d√©blocages bas√©s sur le niveau apr√®s chargement
        // Cette v√©rification sera faite dans unlockFeaturesByLevel() apr√®s loadGame()
        if (data.narrative) {
            if (!gameState.narrative) gameState.narrative = {};
            gameState.narrative = { ...gameState.narrative, ...data.narrative };
            // Restaurer l'historique des dialogues
            if (data.narrative.history) {
                gameState.narrative.history = data.narrative.history;
            }
        }
        if (data.inventory) {
            if (!gameState.inventory) gameState.inventory = {};
            gameState.inventory = { ...gameState.inventory, ...data.inventory };
            // S'assurer que processor_chips et blueprints sont restaur√©s
            if (data.inventory.processor_chips !== undefined) {
                gameState.inventory.processor_chips = data.inventory.processor_chips;
            }
        }
        if (data.tcg) {
            if (!gameState.tcg) gameState.tcg = {};
            gameState.tcg = { ...gameState.tcg, ...data.tcg };
            // S'assurer que les cartes sont bien restaur√©es
            if (data.tcg.cards) {
                gameState.tcg.cards = { ...gameState.tcg.cards, ...data.tcg.cards };
            }
        }
        
        // 6. Valeurs par d√©faut pour les propri√©t√©s manquantes
        if (gameState.blindBoxResetTime === undefined) gameState.blindBoxResetTime = null;
        if (gameState.lastFishingTokenTime === undefined) gameState.lastFishingTokenTime = Date.now();
        if (!gameState.inventory.leaf_stone) gameState.inventory.leaf_stone = 0;
        if (!gameState.lastReset) gameState.lastReset = Date.now();
        if (!gameState.typeCaptureCounts) gameState.typeCaptureCounts = {};
        if (!gameState.totalShopPurchases) gameState.totalShopPurchases = 0;
        if (!gameState.lastLoginDate) gameState.lastLoginDate = null;
        if (!gameState.pokedexFilters) gameState.pokedexFilters = { status: 'all', rarity: 'all', type: 'all', evolvable: 'all' };
        if (!gameState.pokedexRegion) gameState.pokedexRegion = 'Kanto';
        if (!gameState.lastDailyQuestReset) gameState.lastDailyQuestReset = null;
        if (!gameState.lastDailyQuestDate) gameState.lastDailyQuestDate = null;
        if (!gameState.dailyQuestCompletionDates) gameState.dailyQuestCompletionDates = {};
        if (!gameState.dailyQuestStreak) gameState.dailyQuestStreak = 0;
        if (!gameState.rareCaptureCount) gameState.rareCaptureCount = 0;
        if (!gameState.pendingLevelUps) gameState.pendingLevelUps = [];
        if (!gameState.blindBoxBonus) gameState.blindBoxBonus = 0;
        if (!gameState.fishingHistory) gameState.fishingHistory = [];
        // CORRECTION : Restaurer missingNoTriggered pour √©viter les r√©p√©titions
        // Initialiser √† false si non d√©fini pour √©viter les d√©clenchements intempestifs
        if (data.missingNoTriggered !== undefined) {
            gameState.missingNoTriggered = data.missingNoTriggered;
        } else {
            // Si Kanto est compl√©t√©, le flag doit √™tre true pour √©viter la r√©p√©tition
            // Note: getCaughtCount() utilise gameState.captured qui est d√©j√† restaur√© plus haut
            if (typeof getCaughtCount === 'function') {
                const kantoCount = getCaughtCount('Kanto');
                gameState.missingNoTriggered = (kantoCount >= 151);
            } else {
                gameState.missingNoTriggered = false;
            }
        }
        if (data.missingNoTriggeredJohto !== undefined) {
            gameState.missingNoTriggeredJohto = data.missingNoTriggeredJohto;
        } else {
            // Si Johto est compl√©t√©, le flag doit √™tre true pour √©viter la r√©p√©tition
            if (typeof getCaughtCount === 'function') {
                const johtoCount = getCaughtCount('Johto');
                gameState.missingNoTriggeredJohto = (johtoCount >= 100);
            } else {
                gameState.missingNoTriggeredJohto = false;
            }
        }
        if (!gameState.research) gameState.research = { unlocked: false, energy: 0, totalEnergyProduced: 0, clickMultiplier: 1, lastSaveTime: Date.now(), automationLevel: 0, habitats: { 'forest': { name: 'For√™t', type: 'Grass', level: 0, unlocked: true, slots: 1, assigned: [], mascotte: null }, 'ocean': { name: 'Oc√©an', type: 'Water', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null }, 'cave': { name: 'Grotte', type: 'Rock', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null }, 'volcano': { name: 'Volcan', type: 'Fire', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null }, 'power_plant': { name: 'Centrale', type: 'Electric', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null }, 'graveyard': { name: 'Cimeti√®re', type: 'Ghost', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null } } };
        if (!gameState.narrative) gameState.narrative = { queue: [], history: [], currentSpeaker: 'porygon' };
        
        // Initialiser le syst√®me narratif (Genesis Reboot)
        if (!gameState.system) {
            gameState.system = {
                currentPhase: 'BOOT_SEQUENCE',
                integrity: 0,
                glitchLevel: 1.0,
                porygonMood: 'PANIC',
                narrativeFlags: []
            };
        }
        
        // CORRECTION : Restaurer les narrativeFlags depuis les donn√©es sauvegard√©es
        if (data.system && data.system.narrativeFlags) {
            if (!gameState.system.narrativeFlags) gameState.system.narrativeFlags = [];
            // Fusionner les flags (√©viter les doublons)
            gameState.system.narrativeFlags = [...new Set([...gameState.system.narrativeFlags, ...data.system.narrativeFlags])];
        }
        
        // Restaurer les autres propri√©t√©s du syst√®me
        if (data.system) {
            if (data.system.currentPhase) gameState.system.currentPhase = data.system.currentPhase;
            if (data.system.integrity !== undefined) gameState.system.integrity = data.system.integrity;
            if (data.system.glitchLevel !== undefined) gameState.system.glitchLevel = data.system.glitchLevel;
            if (data.system.porygonMood) gameState.system.porygonMood = data.system.porygonMood;
        }
        
        // Initialiser les modules avec conditions narratives
        if (!gameState.modules) {
            gameState.modules = {
                fishing: { id: 'fishing', condition: 'level_2', unlocked: false, dialogue: 'unlock_fishing_module' },
                research: { id: 'research', condition: 'level_5', unlocked: false, dialogue: 'unlock_research_core' },
                poker: { id: 'poker', condition: 'level_12', unlocked: false, dialogue: 'unlock_decryption' },
                rogue: { id: 'rogue', condition: 'level_20_and_johto', unlocked: false, dialogue: 'unlock_deepnet' },
                tcg: { id: 'tcg', condition: 'level_25', unlocked: false, dialogue: 'unlock_archives' }
            };
        }
        
        if (!gameState.inventory.processor_chips) gameState.inventory.processor_chips = 0;
        if (!gameState.questsProgress) gameState.questsProgress = { daily: {}, special: {}, permanent: {} };
        if (!gameState.questsProgress.daily) gameState.questsProgress.daily = {};
        if (!gameState.questsProgress.special) gameState.questsProgress.special = {};
        if (!gameState.questsProgress.permanent) gameState.questsProgress.permanent = {};
        if (!gameState.claimedQuests) gameState.claimedQuests = { daily: new Set(), special: new Set(), permanent: new Set() };
        if (!gameState.claimedQuests.daily) gameState.claimedQuests.daily = new Set();
        if (!gameState.claimedQuests.special) gameState.claimedQuests.special = new Set();
        if (!gameState.claimedQuests.permanent) gameState.claimedQuests.permanent = new Set();
        if (!gameState.rogue) gameState.rogue = { runsCompleted: 0, runsStarted: 0, fullClearsCount: 0, totalShinyTokens: 0, pityCounter: 0, totalShards: 0, shardsByType: { common: 0, rare: 0, legendary: 0 }, unlocks: { extraBall: false, extraFloor: false, shinyCharmPermanent: false, fastRecharge: false }, ticketsAvailable: 10, lastTicketReset: null, lastRunRewards: null };
        if (!gameState.buddy) gameState.buddy = { activeBuddyId: null, buddies: {} };
        if (!gameState.poker) gameState.poker = { runs_completed: 0, runs_started: 0, highest_ante: 0, badges_earned: [], league_unlocked: false, total_chips_earned: 0, total_hands_played: 0, best_single_hand_score: 0, legendary_combos_hit: 0, permanent_deck: [], unlocked_cards: [], owned_jokers: [], meta_upgrades: { extra_card_draw: 0, starting_chips_bonus: 0, buddy_xp_multiplier: 1.0, shiny_chance_boost: 0 }, current_run: null, shop: { current_offers: [], rerolls_available: 2, reroll_cost: 50 } };
        
        // Initialiser le deck poker si n√©cessaire
        if (typeof initializePokerDeck === 'function') initializePokerDeck();
        
        // Sauvegarder dans localStorage
        localStorage.setItem('pokemonGameV62', JSON.stringify({
            ...gameState,
            captured: Array.from(gameState.captured),
            shinies: Array.from(gameState.shinies),
            evolved: Array.from(gameState.evolved),
            unlockedRegions: Array.from(gameState.unlockedRegions),
            unlockedBadges: Array.from(gameState.unlockedBadges),
            golden: Array.from(gameState.golden),
            claimedQuests: {
                daily: Array.from(gameState.claimedQuests.daily),
                special: Array.from(gameState.claimedQuests.special),
                permanent: Array.from(gameState.claimedQuests.permanent)
            },
            activeBoosts: gameState.activeBoosts.map(b => ({ ...b })),
            lastSaved: Date.now()
        }));
        
        console.log('‚úÖ Donn√©es appliqu√©es. Niveau:', gameState.level, 'XP:', gameState.xp, 'Pok√©mon captur√©s:', gameState.captured.size);
        
        // CORRECTION : Forcer le d√©blocage des fonctionnalit√©s bas√© sur le niveau apr√®s le chargement
        // Cela corrige le bug o√π le Centre de Recherche restait verrouill√© m√™me au niveau 25 apr√®s un chargement Cloud
        if (typeof unlockFeaturesByLevel === 'function') {
            unlockFeaturesByLevel();
        }
        
        // Rafra√Æchir l'interface
        if (typeof updateUI === 'function') updateUI();
        if (typeof updateUIFishing === 'function') updateUIFishing();
        if (typeof renderInventory === 'function') renderInventory();
        if (typeof renderPokedexGrid === 'function') renderPokedexGrid();
        if (typeof renderAllQuests === 'function') renderAllQuests();
        if (typeof updateProfileStats === 'function') updateProfileStats();
        if (typeof updateProfileDisplay === 'function') updateProfileDisplay();
        if (typeof updateTopBarDisplay === 'function') updateTopBarDisplay();
        
        // CORRECTION : Mettre √† jour l'√©tat visuel du syst√®me apr√®s chargement (interface glitch√©e)
        if (typeof updateSystemVisualState === 'function') {
            updateSystemVisualState();
        }
        
        // CORRECTION : Mettre √† jour la visibilit√© de la navigation (blind box cach√©e)
        if (typeof updateNavigationVisibility === 'function') {
            setTimeout(() => updateNavigationVisibility(), 100);
        }
        
        // Si on est sur la page recherche, forcer le rafra√Æchissement pour enlever le cadenas imm√©diatement
        const researchPage = document.getElementById('research-page');
        if (researchPage && researchPage.classList.contains('active') && typeof renderResearchPage === 'function') {
            renderResearchPage();
        }
        
    } catch (e) {
        console.error('‚ùå Erreur lors de l\'application des donn√©es:', e);
    }
};
function unlockFeaturesByLevel() {
    // ‚úÖ CORRECTION : Le TCG ne se d√©bloque plus automatiquement au niveau 2
    // Il est maintenant g√©r√© uniquement par gameState.modules.tcg.unlocked (niveau 25)
    
    // D√©bloquer le Centre de Recherche si niveau >= 5
    if (gameState.level >= 5) {
        if (!gameState.research) {
            gameState.research = {
                unlocked: false,
                energy: 0,
                totalEnergyProduced: 0,
                clickMultiplier: 1,
                lastSaveTime: Date.now(),
                automationLevel: 0,
                upgrades: { mouse_driver: 0, gpu_overclock: 0, virus_scan: 0 },
                habitats: {
                    'forest': { name: 'For√™t', type: 'Grass', level: 0, unlocked: true, slots: 1, assigned: [], mascotte: null },
                    'ocean': { name: 'Oc√©an', type: 'Water', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null },
                    'cave': { name: 'Grotte', type: 'Rock', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null },
                    'volcano': { name: 'Volcan', type: 'Fire', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null },
                    'power_plant': { name: 'Centrale', type: 'Electric', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null },
                    'graveyard': { name: 'Cimeti√®re', type: 'Ghost', level: 0, unlocked: false, slots: 1, assigned: [], mascotte: null }
                }
            };
        }
        // FORCER le d√©blocage si niveau >= 5
        gameState.research.unlocked = true;
        
        // S'assurer que chaque habitat a un slot mascotte
        Object.keys(gameState.research.habitats).forEach(habitatId => {
            if (!gameState.research.habitats[habitatId].mascotte) {
                gameState.research.habitats[habitatId].mascotte = null;
            }
        });
    }
    
    // CORRECTION : D√©bloquer Blind Box au niveau 4 (ou niveau 8 selon la configuration)
    // V√©rifier la condition du module pour d√©terminer le niveau requis
    if (!gameState.modules) gameState.modules = {};
    if (!gameState.modules.blindbox) {
        gameState.modules.blindbox = {
            id: 'blindbox',
            condition: 'level_8', // Condition originale
            unlocked: false
        };
    }
    // D√©bloquer si niveau >= 4 (comme dans updateNavigationVisibility) OU niveau >= 8 (condition originale)
    if (gameState.level >= 4) {
        gameState.modules.blindbox.unlocked = true;
    }
    
    // Autres d√©blocages bas√©s sur le niveau peuvent √™tre ajout√©s ici
    // Exemple : if (gameState.level >= 10) { ... }
}

// Fonction de sauvegarde locale et Cloud
window.saveGame = function() {
    try {
        // Sauvegarder dans localStorage
        const saveData = {
            ...gameState,
            captured: Array.from(gameState.captured || []),
            shinies: Array.from(gameState.shinies || []),
            evolved: Array.from(gameState.evolved || []),
            unlockedRegions: Array.from(gameState.unlockedRegions || []),
            unlockedBadges: Array.from(gameState.unlockedBadges || []),
            golden: Array.from(gameState.golden || []),
            claimedQuests: {
                daily: Array.from(gameState.claimedQuests?.daily || []),
                special: Array.from(gameState.claimedQuests?.special || []),
                permanent: Array.from(gameState.claimedQuests?.permanent || [])
            },
            activeBoosts: (gameState.activeBoosts || []).map(b => ({ ...b })),
            lastSaved: Date.now()
        };
        
        localStorage.setItem('pokemonGameV62', JSON.stringify(saveData));
        
        // Sauvegarder dans le Cloud si connect√©
        if (window.SupabaseManager && window.SupabaseManager.isLoggedIn()) {
            window.SupabaseManager.save().catch(err => {
                console.warn('‚ö†Ô∏è √âchec sauvegarde Cloud (non bloquant):', err);
            });
        }
        
        return true;
    } catch (e) {
        console.error('‚ùå Erreur lors de la sauvegarde:', e);
        return false;
    }
};

// Syst√®me de sauvegarde automatique p√©riodique
let autoSaveInterval = null;
function startAutoSave() {
    // Arr√™ter l'ancien intervalle si existant
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    
    // Sauvegarder automatiquement toutes les 30 secondes
    autoSaveInterval = setInterval(() => {
        if (typeof window.saveGame === 'function') {
            window.saveGame();
            console.log('üíæ Sauvegarde automatique effectu√©e');
        }
    }, 30000); // 30 secondes
    
    // Sauvegarder aussi avant de quitter la page
    window.addEventListener('beforeunload', () => {
        if (typeof window.saveGame === 'function') {
            window.saveGame();
        }
    });
    
    // Sauvegarder quand la page devient invisible (changement d'onglet)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && typeof window.saveGame === 'function') {
            window.saveGame();
        }
    });
}

function loadGame(){const saved=localStorage.getItem('pokemonGameV62');if(saved){try{const data=JSON.parse(saved);window.applySaveData(data);}catch(e){console.error('Error loading save:',e);}}checkBlindBoxReset();checkDailyRunReset();checkLoginStreak();checkExpeditionTicketReset();generateDailyQuests();resetEncounterToIdle();renderCaptureHistory();renderFishingHistory();renderBuddyDisplay();checkQuestNotifications();checkRegionUnlock();if(document.getElementById('pokedex-filter-status')){document.getElementById('pokedex-filter-status').value=gameState.pokedexFilters?.status||'all';document.getElementById('pokedex-filter-rarity').value=gameState.pokedexFilters?.rarity||'all';document.getElementById('pokedex-filter-type').value=gameState.pokedexFilters?.type||'all';if(document.getElementById('pokedex-filter-evolvable'))document.getElementById('pokedex-filter-evolvable').value=gameState.pokedexFilters?.evolvable||'all';}checkLevelUp();processPendingLevelUps();if(typeof updatePorygonVisuals==='function'){setTimeout(()=>updatePorygonVisuals(),500);}if(gameState.coins<50&&getTotalBalls()===0){gameState.inventory.pokeball=(gameState.inventory.pokeball||0)+5;if(typeof showToast==='function')showToast('üéÅ Aide du Professeur : 5 Pok√©balls re√ßues !','success');saveGame();}unlockFeaturesByLevel();updateSystemVisualState();setTimeout(() => { updateNavigationVisibility(); updateQuestsVisibility(); }, 100);startInitialSequence();startAutoSave();}

function renderRegionsProgress(){const container=document.getElementById('regions-container');if(!container)return;container.innerHTML='';const regions=[{id:'Kanto',name:'Kanto',icon:'üåã',total:151,unlocked:gameState.unlockedRegions.has('Kanto')},{id:'Johto',name:'Johto',icon:'üèîÔ∏è',total:251,unlocked:gameState.unlockedRegions.has('Johto')},{id:'Hoenn',name:'Hoenn',icon:'üåä',total:386,unlocked:gameState.unlockedRegions.has('Hoenn')}];let hasAnyClaimableReward=false;for(const region of regions){let capturedCount=0;if(region.id==='Kanto'){capturedCount=Array.from(gameState.captured).filter(id=>id>=1&&id<=151).length;}else if(region.id==='Johto'){capturedCount=Array.from(gameState.captured).filter(id=>id>=152&&id<=251).length;}else if(region.id==='Hoenn'){capturedCount=Array.from(gameState.captured).filter(id=>id>=252&&id<=386).length;}const progress=gameState.regionProgress[region.id]||{captured:0,shinies:0};let hasClaimableReward=false;if(region.id==='Kanto'){for(const[collectionId,collection]of Object.entries(SPECIAL_COLLECTIONS)){const captured=collection.pokemon.filter(id=>gameState.captured.has(id)).length;const total=collection.pokemon.length;if(captured===total&&!gameState.collectionProgress[collectionId]){hasClaimableReward=true;hasAnyClaimableReward=true;break;}}}const card=document.createElement('div');card.style.cssText=`background: ${region.unlocked?'linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3))':'rgba(0,0,0,0.3)'}; border: 2px solid ${region.unlocked?'#667eea':'#444'}; border-radius: 12px; padding: 20px; text-align: center; cursor: ${region.unlocked?'pointer':'default'}; opacity: ${region.unlocked?'1':'0.5'}; position: relative;`;if(region.unlocked&&region.id==='Kanto')card.onclick=()=>showKantoCollections();card.innerHTML=`${hasClaimableReward?'<div style="position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; color: white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.8); animation: pulse 1.5s ease-in-out infinite;">!</div>':''}<div style="font-size: 3em; margin-bottom: 10px;">${region.icon}</div><div style="font-weight: bold; color: white; margin-bottom: 10px; font-size: 1.2em;">${region.name}</div><div style="color: ${region.unlocked?'#FFD700':'#666'}; margin-bottom: 5px;">${capturedCount} / ${region.id==='Kanto'?151:region.id==='Johto'?100:135} Pok√©mon</div><div style="color: ${region.unlocked?'#FFD700':'#666'}; font-size: 0.9em;">‚ú® ${progress.shinies} Shinies</div>${!region.unlocked?'<div style="color: #999; margin-top: 10px; font-size: 0.85em;">üîí Verrouill√©</div>':''}`;container.appendChild(card);}const profileNavItem=document.querySelectorAll('.nav-item')[6];if(profileNavItem&&hasAnyClaimableReward){if(!profileNavItem.querySelector('.collection-notif-badge')){const badge=document.createElement('div');badge.className='collection-notif-badge';badge.style.cssText='position: absolute; top: 5px; right: 5px; width: 18px; height: 18px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; color: white; box-shadow: 0 0 8px rgba(16, 185, 129, 0.8); animation: pulse 1.5s ease-in-out infinite;';badge.textContent='!';profileNavItem.style.position='relative';profileNavItem.appendChild(badge);}}else if(profileNavItem){const existingBadge=profileNavItem.querySelector('.collection-notif-badge');if(existingBadge)existingBadge.remove();}}
window.showKantoCollections=function(){const modal=document.createElement('div');modal.className='modal active';modal.style.cssText='display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';let collectionsHTML='';for(const[collectionId,collection]of Object.entries(SPECIAL_COLLECTIONS)){const captured=collection.pokemon.filter(id=>gameState.captured.has(id)).length;const total=collection.pokemon.length;const progress=Math.round((captured/total)*100);collectionsHTML+=`<div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 15px; cursor: pointer;" onclick="claimCollectionReward('${collectionId}')"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"><div><div style="font-size: 2em; display: inline-block; margin-right: 10px;">${collection.icon}</div><div style="display: inline-block;"><div style="font-weight: bold; color: white; font-size: 1.1em;">${collection.name}</div><div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${captured}/${total} Pok√©mon</div></div></div><div style="text-align: right;"><div style="color: #FFD700; font-weight: bold; font-size: 1.2em;">${progress}%</div>${progress===100?'<div style="color: #4ade80; font-size: 0.9em; margin-top: 5px;">‚úÖ Compl√©t√©</div>':''}</div></div><div style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; height: 10px;"><div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ${progress}%; transition: width 0.5s;"></div></div></div>`;}modal.innerHTML=`<div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 40px; border-radius: 20px; max-width: 600px; width: 100%; position: relative;"><button onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%;">√ó</button><h1 style="color: white; text-align: center; margin: 0 0 30px 0;">üåç Collections Kanto</h1>${collectionsHTML}</div>`;document.body.appendChild(modal);modal.addEventListener('click',(e)=>{if(e.target===modal)modal.remove();});};
window.claimCollectionReward=function(collectionId){const collection=SPECIAL_COLLECTIONS[collectionId];if(!collection)return;const captured=collection.pokemon.filter(id=>gameState.captured.has(id)).length;const total=collection.pokemon.length;if(captured<total){showToast(`Collection incompl√®te! (${captured}/${total})`,'error');return;}if(gameState.collectionProgress[collectionId]){showToast('R√©compense d√©j√† r√©clam√©e!','error');return;}gameState.collectionProgress[collectionId]=true;const rewardCoins=total*1000;gameState.coins+=rewardCoins;showToast(`üéâ Collection "${collection.name}" compl√©t√©e!\n+${rewardCoins}üí∞`,'success');saveGame();updateUI();renderRegionsProgress();const profileNavItem=document.querySelectorAll('.nav-item')[6];if(profileNavItem){const existingBadge=profileNavItem.querySelector('.collection-notif-badge');if(existingBadge)existingBadge.remove();}};
function renderActiveBoosts(){const container=document.getElementById('active-boosts');if(!container)return;container.innerHTML='';const now=Date.now();gameState.activeBoosts=gameState.activeBoosts.filter(b=>b.endTime>now);if(gameState.activeBoosts.length===0)return;container.style.cssText='display: flex; flex-wrap: wrap; gap: 8px; align-items: center; max-width: 400px;';for(const boost of gameState.activeBoosts){const remaining=Math.max(0,Math.ceil((boost.endTime-now)/1000));const minutes=Math.floor(remaining/60);const seconds=remaining%60;const icon={exp_charm:'üìò',lucky_charm:'üçÄ',incensefleur:'üåÄ',marin_lure:'ü™∏',charm_collection:'üíé'}[boost.type]||'‚ú®';const tooltip={exp_charm:'+25% XP',lucky_charm:'+0.5% Shiny',incensefleur:'+20% Rares',marin_lure:'√ó2 Eau',charm_collection:'+10% nouveau Pok√©mon'}[boost.type]||'';const indicator=document.createElement('div');indicator.className='boost-indicator';indicator.style.cssText='position: relative; background: rgba(102, 126, 234, 0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 6px 12px; display: flex; align-items: center; gap: 6px; cursor: pointer; flex-shrink: 0;';indicator.title=tooltip;indicator.innerHTML=`<span style="font-size: 1.2em;">${icon}</span><span style="color: white; font-size: 0.85em; font-weight: bold;">${minutes}:${seconds.toString().padStart(2,'0')}</span>`;container.appendChild(indicator);}}
function updateBoosts(){const now=Date.now();gameState.activeBoosts=gameState.activeBoosts.filter(b=>b.endTime>now);renderActiveBoosts();}
// ===== SYST√àME DE PERSONNALISATION DU PROFIL =====

// Initialiser gameState.customization si n√©cessaire
if (!gameState.customization) {
    gameState.customization = {
        trainerName: null, // null = "Dresseur niveau X", sinon nom personnalis√©
        selectedIcon: null,
        selectedXpBar: null,
        selectedBackground: null,
        selectedTitle: null,
        unlockedIcons: [],
        unlockedXpBars: [],
        unlockedBackgrounds: [],
        unlockedTitles: [],
        unseenUnlocks: {
            icons: [],
            xpBars: [],
            backgrounds: [],
            titles: []
        },
        nameModalSeen: false
    };
}

// Structures de donn√©es pour la personnalisation
const CUSTOMIZATION_DATA = {
    icons: [
        { id: 'default', name: 'Dresseur', icon: 'üë§', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/1.png', unlockCondition: 'D√©bloqu√© par d√©faut', unlocked: true },
        { id: 'kanto_trainer', name: 'Dresseur Kanto', icon: 'üë§', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/red.png', unlockCondition: 'Pok√©dex Kanto compl√©t√© √† 40%', check: () => {
            const kantoCaptures = Array.from(gameState.captured).filter(id => id >= 1 && id <= 151).length;
            return kantoCaptures >= 60; // 40% de 151
        }},
        { id: 'kanto_master', name: 'Ma√Ætre Kanto', icon: 'üë§', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/blue.png', unlockCondition: 'Pok√©dex Kanto 100%', check: () => {
            const kantoCaptures = Array.from(gameState.captured).filter(id => id >= 1 && id <= 151).length;
            return kantoCaptures === 151;
        }},
        { id: 'johto_trainer', name: 'Dresseur Johto', icon: 'üë§', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/ethan.png', unlockCondition: 'Johto 40%', check: () => {
            const johtoCaptures = Array.from(gameState.captured).filter(id => id >= 152 && id <= 251).length;
            return johtoCaptures >= 40; // 40% de 100
        }},
        { id: 'shiny_master_kanto', name: 'Ma√Ætre Shiny Kanto', icon: '‚ú®', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/red-gen3.png', unlockCondition: '50 Shinies Kanto', check: () => {
            const kantoShinies = Array.from(gameState.shinies).filter(id => id >= 1 && id <= 151).length;
            return kantoShinies >= 50;
        }},
        { id: 'fire_champion', name: 'Champion des Flammes', icon: 'üî•', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/flannery.png', unlockCondition: 'Poss√©der 10 Pok√©mon Feu shiny', check: () => {
            const fireShinies = Array.from(gameState.shinies).filter(id => {
                const types = POKEMON_TYPES[id] || [];
                return types.includes('Feu');
            }).length;
            return fireShinies >= 10;
        }},
        { id: 'expedition_scout', name: '√âclaireur de l\'Exp√©dition', icon: 'üó∫Ô∏è', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/brendan.png', unlockCondition: 'Participer √† 10 Exp√©ditions', check: () => {
            return (gameState.rogue?.runsCompleted || 0) >= 10;
        }},
        { id: 'expedition_veteran', name: 'V√©t√©ran de l\'Exp√©dition', icon: '‚öîÔ∏è', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/steven.png', unlockCondition: 'Participer √† 20 Exp√©ditions', check: () => {
            return (gameState.rogue?.runsCompleted || 0) >= 20;
        }},
        { id: 'poker_player', name: 'Pok√©-Pokerist', icon: 'üÉè', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/giovanni.png', unlockCondition: 'Finir une run compl√®te de Pok√©-Poker (8 badges)', check: () => {
            return (gameState.poker?.badges?.length || 0) >= 8;
        }},
        { id: 'poker_god', name: 'Pok√©-Poker God', icon: 'üëë', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/cynthia.png', unlockCondition: 'Finir une run en utilisant 0 d√©fausse', check: () => {
            // √Ä impl√©menter : tracker les d√©fausses utilis√©es dans une run
            return false; // Placeholder
        }},
        { id: 'fossil_collector', name: 'Collectionneur Fossile', icon: 'ü¶¥', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/roark.png', unlockCondition: 'Obtenir tous les fossiles', check: () => {
            const fossils = [138, 139, 140, 141, 142]; // Amonita, Amonistar, Kabuto, Kabutops, Pt√©ra
            return fossils.every(id => gameState.captured.has(id));
        }},
        { id: 'team_rocket', name: 'Team Rocket', icon: 'üåô', iconUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/trainers/teamrocket.png', unlockCondition: '√âchouer √† capturer 10 pok√©mons d\'affil√©s', check: () => {
            return (gameState.totalFlees || 0) >= 10 && gameState.streak === 0;
        }}
    ],
    xpBars: [
        { id: 'classic_blue', name: 'Classique Bleu', style: 'linear-gradient(90deg, #3b82f6, #60a5fa)', unlockCondition: 'D√©bloqu√© par d√©faut', unlocked: true },
        { id: 'scarlet_red', name: '√âcarlate', style: 'linear-gradient(90deg, #ef4444, #f87171)', unlockCondition: 'Atteindre niveau 10', check: () => gameState.level >= 10 },
        { id: 'emerald_green', name: '√âmeraude', style: 'linear-gradient(90deg, #10b981, #34d399)', unlockCondition: 'Atteindre niveau 20', check: () => gameState.level >= 20 },
        { id: 'galactic_purple', name: 'Galactique', style: 'linear-gradient(90deg, #a855f7, #c084fc)', unlockCondition: 'Capturer 10 boss d\'exp√©dition', check: () => {
            return (gameState.rogue?.fullClearsCount || 0) >= 10;
        }},
        { id: 'dark_moon', name: 'Lune Noire', style: 'linear-gradient(90deg, #4b5563, #6b7280)', unlockCondition: 'Compl√©ter le Pok√©dex Johto', check: () => {
            const johtoCaptures = Array.from(gameState.captured).filter(id => id >= 152 && id <= 251).length;
            return johtoCaptures === 100;
        }},
        { id: 'prismatic', name: 'Prismatique', style: 'linear-gradient(90deg, #f59e0b, #fbbf24, #10b981, #3b82f6, #a855f7)', unlockCondition: 'Avoir captur√© 10 Shinies dans le pok√©dex', check: () => {
            return gameState.shinies.size >= 10;
        }},
        { id: 'voltaic', name: 'Volta√Øque', style: 'linear-gradient(90deg, #fbbf24, #f59e0b)', unlockCondition: 'Finir une run Pok√©-Poker avec 1 joker l√©gendaire', check: () => {
            // √Ä impl√©menter : tracker les jokers l√©gendaires utilis√©s
            return false; // Placeholder
        }},
        { id: 'golden_flame', name: 'Flamme Dor√©e', style: 'linear-gradient(90deg, #f59e0b, #fbbf24)', unlockCondition: 'Avoir captur√© un Pok√©mon shiny l√©gendaire', check: () => {
            const legendaryShinies = Array.from(gameState.shinies).filter(id => POKEMON_DATA.legendary.includes(id));
            return legendaryShinies.length > 0;
        }}
    ],
    backgrounds: [
        { id: 'default', name: 'Par d√©faut', style: 'linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3))', unlockCondition: 'D√©bloqu√© par d√©faut', unlocked: true },
        { id: 'grass', name: 'Plante', style: 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(74, 222, 128, 0.3))', unlockCondition: '20 Pok√©mon Plante enregistr√©s', check: () => {
            const grassCount = Array.from(gameState.captured).filter(id => {
                const types = POKEMON_TYPES[id] || [];
                return types.includes('Plante');
            }).length;
            return grassCount >= 20;
        }},
        { id: 'fire', name: 'Feu', style: 'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(248, 113, 113, 0.3))', unlockCondition: '20 Pok√©mon Feu enregistr√©s', check: () => {
            const fireCount = Array.from(gameState.captured).filter(id => {
                const types = POKEMON_TYPES[id] || [];
                return types.includes('Feu');
            }).length;
            return fireCount >= 20;
        }},
        { id: 'water', name: 'Eau', style: 'linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(96, 165, 250, 0.3))', unlockCondition: '20 Pok√©mon Eau enregistr√©s', check: () => {
            const waterCount = Array.from(gameState.captured).filter(id => {
                const types = POKEMON_TYPES[id] || [];
                return types.includes('Eau');
            }).length;
            return waterCount >= 20;
        }},
        { id: 'ghost', name: 'Spectre', style: 'linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(192, 132, 252, 0.3))', unlockCondition: 'Gagner un run Pok√©-Poker avec au moins un Duo Originels', check: () => {
            // √Ä impl√©menter : tracker les combos sp√©ciaux
            return false; // Placeholder
        }},
        { id: 'fossil', name: 'Fossile', style: 'linear-gradient(135deg, rgba(120, 53, 15, 0.3), rgba(154, 52, 18, 0.3))', unlockCondition: 'Obtenir les 6 fossiles', check: () => {
            const fossils = [138, 139, 140, 141, 142, 144]; // Amonita, Amonistar, Kabuto, Kabutops, Pt√©ra, Artikodin
            return fossils.every(id => gameState.captured.has(id));
        }},
        { id: 'rainbow', name: 'Arc-en-Ciel', style: 'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(251, 191, 36, 0.3), rgba(34, 197, 94, 0.3), rgba(59, 130, 246, 0.3), rgba(168, 85, 247, 0.3))', unlockCondition: 'Obtenir 30 shiny diff√©rents', check: () => {
            return gameState.shinies.size >= 30;
        }},
        { id: 'galaxy', name: 'Galaxie', style: 'linear-gradient(135deg, rgba(30, 41, 59, 0.3), rgba(51, 65, 85, 0.3))', unlockCondition: 'Finir 50 Expeditions', check: () => {
            return (gameState.rogue?.runsCompleted || 0) >= 50;
        }},
        { id: 'kanto_legacy', name: 'Kanto Legacy', style: 'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(255, 255, 255, 0.3))', unlockCondition: 'Pok√©dex Kanto 151/151', check: () => {
            const kantoCaptures = Array.from(gameState.captured).filter(id => id >= 1 && id <= 151).length;
            return kantoCaptures === 151;
        }},
        { id: 'johto_vibes', name: 'Johto Vibes', style: 'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(252, 211, 77, 0.3))', unlockCondition: 'Pok√©dex Johto 100%', check: () => {
            const johtoCaptures = Array.from(gameState.captured).filter(id => id >= 152 && id <= 251).length;
            return johtoCaptures === 100;
        }},
        { id: 'champion', name: 'Champion', style: 'linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(192, 132, 252, 0.3))', unlockCondition: 'Battre 10 fois le final boss du Pok√©-Poker', check: () => {
            // √Ä impl√©menter : tracker les victoires sur le boss final
            return false; // Placeholder
        }},
        { id: 'mythic', name: 'Mythique', style: 'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(168, 85, 247, 0.3))', unlockCondition: 'Poss√©der Mew + Celebi shiny', check: () => {
            return gameState.shinies.has(151) && gameState.shinies.has(251);
        }}
    ],
    titles: [
        { id: 'novice_1', name: 'Dresseur Novice', unlockCondition: 'Niveau 2 √† 4', check: () => gameState.level >= 2 && gameState.level <= 4 },
        { id: 'adventurer', name: 'Aventurier', unlockCondition: 'Niveau 5 √† 9', check: () => gameState.level >= 5 && gameState.level <= 9 },
        { id: 'explorer', name: 'Explorateur', unlockCondition: 'Niveau 10 √† 19', check: () => gameState.level >= 10 && gameState.level <= 19 },
        { id: 'champion', name: 'Champion', unlockCondition: 'Niveau 20 √† 29', check: () => gameState.level >= 20 && gameState.level <= 29 },
        { id: 'master', name: 'Ma√Ætre Pok√©mon', unlockCondition: 'Niveau 30 √† 39', check: () => gameState.level >= 30 && gameState.level <= 39 },
        { id: 'legend', name: 'L√©gende Vivante', unlockCondition: 'Niveau 40 et +', check: () => gameState.level >= 40 },
        { id: 'arceus_avatar', name: 'Avatar d\'Arceus', unlockCondition: 'Avoir tout le pok√©dex de Kanto en Shiny', check: () => {
            const kantoShinies = Array.from(gameState.shinies).filter(id => id >= 1 && id <= 151).length;
            return kantoShinies === 151;
        }},
        { id: 'shiny_master', name: 'Ma√Ætre Shiny', unlockCondition: '100 Shinies', check: () => gameState.shinies.size >= 100 },
        { id: 'absolute_collector', name: 'Collectionneur Absolu', unlockCondition: 'Pok√©dex Kanto complet', check: () => {
            const kantoCaptures = Array.from(gameState.captured).filter(id => id >= 1 && id <= 151).length;
            return kantoCaptures === 151;
        }},
        { id: 'grand_explorer', name: 'Grand Explorateur', unlockCondition: '100 Exp√©ditions r√©alis√©es', check: () => {
            return (gameState.rogue?.runsCompleted || 0) >= 100;
        }},
        { id: 'abyss_winner', name: 'Vainqueur de l\'Ab√Æme', unlockCondition: '√âchec 0 fois sur une Exp√©dition Arcanes difficile', check: () => {
            // √Ä impl√©menter : tracker les √©checs
            return false; // Placeholder
        }},
        { id: 'deck_architect', name: 'Architecte du Deck', unlockCondition: 'Finir Pok√©-Poker en difficult√© max', check: () => {
            // √Ä impl√©menter : tracker la difficult√©
            return false; // Placeholder
        }},
        { id: 'destiny_breaker', name: 'Briseur de Destin', unlockCondition: 'Obtenir une main secr√®te 3 fois dans une m√™me run', check: () => {
            // √Ä impl√©menter : tracker les mains secr√®tes
            return false; // Placeholder
        }},
        { id: 'divine_luck', name: 'Chance Divine', unlockCondition: 'Obtenir un shiny l√©gendaire dans une Exp√©dition', check: () => {
            // √Ä impl√©menter : tracker les shinies l√©gendaires en exp√©dition
            return false; // Placeholder
        }},
        { id: 'miracle_run', name: 'Miracle Run', unlockCondition: 'Finir Pok√©-Poker sans joker Rare ou L√©gendaire', check: () => {
            // √Ä impl√©menter : tracker les jokers utilis√©s
            return false; // Placeholder
        }},
        { id: 'big_brain', name: 'Gros Cerveau', unlockCondition: 'Gagner un round de Pok√©-Poker avec 1 seule carte jou√©e', check: () => {
            // √Ä impl√©menter : tracker les rounds gagn√©s avec 1 carte
            return false; // Placeholder
        }},
        { id: 'antique_collector', name: 'Collector Antique', unlockCondition: 'Compl√©ter tous les fossiles', check: () => {
            const fossils = [138, 139, 140, 141, 142];
            return fossils.every(id => gameState.captured.has(id));
        }},
        { id: 'comic_brother', name: 'Non mais fr√®re...', unlockCondition: '5 l√©gendaires enfuies durant les captures', check: () => {
            // √Ä impl√©menter : tracker les l√©gendaires enfuis
            return false; // Placeholder
        }},
        { id: 'try_harder', name: 'Try Harder', unlockCondition: '10 Exp√©ditions perdues √† la derni√®re salle', check: () => {
            // √Ä impl√©menter : tracker les √©checs √† la derni√®re salle
            return false; // Placeholder
        }},
        { id: 'button_masher', name: 'Button Masher', unlockCondition: 'Utiliser 100 d√©fausses cumul√©es dans Pok√©-Poker', check: () => {
            // √Ä impl√©menter : tracker les d√©fausses
            return false; // Placeholder
        }},
        { id: 'pity_shiny', name: 'Piti√© un Shiny', unlockCondition: 'Jouer une run Pok√©-Poker jusqu\'au 8 √®me badge sans poser de shiny', check: () => {
            // √Ä impl√©menter : tracker les shinies jou√©s
            return false; // Placeholder
        }}
    ]
};

// Fonction pour v√©rifier et d√©bloquer les √©l√©ments
function checkAndUnlockCustomization() {
    // Initialiser unseenUnlocks si n√©cessaire
    if (!gameState.customization.unseenUnlocks) {
        gameState.customization.unseenUnlocks = {
            icons: [],
            xpBars: [],
            backgrounds: [],
            titles: []
        };
    }
    
    // V√©rifier les ic√¥nes
    CUSTOMIZATION_DATA.icons.forEach(icon => {
        if (!icon.unlocked && !gameState.customization.unlockedIcons.includes(icon.id)) {
            if (icon.check && icon.check()) {
                gameState.customization.unlockedIcons.push(icon.id);
                gameState.customization.unseenUnlocks.icons.push(icon.id);
                showToast(`üéâ Nouvelle ic√¥ne d√©bloqu√©e : ${icon.name} !`, 'success');
            }
        }
    });
    
    // V√©rifier les barres XP
    CUSTOMIZATION_DATA.xpBars.forEach(bar => {
        if (!bar.unlocked && !gameState.customization.unlockedXpBars.includes(bar.id)) {
            if (bar.check && bar.check()) {
                gameState.customization.unlockedXpBars.push(bar.id);
                gameState.customization.unseenUnlocks.xpBars.push(bar.id);
                showToast(`üé® Nouvelle barre XP d√©bloqu√©e : ${bar.name} !`, 'success');
            }
        }
    });
    
    // V√©rifier les backgrounds
    CUSTOMIZATION_DATA.backgrounds.forEach(bg => {
        if (!bg.unlocked && !gameState.customization.unlockedBackgrounds.includes(bg.id)) {
            if (bg.check && bg.check()) {
                gameState.customization.unlockedBackgrounds.push(bg.id);
                gameState.customization.unseenUnlocks.backgrounds.push(bg.id);
                showToast(`üñºÔ∏è Nouveau background d√©bloqu√© : ${bg.name} !`, 'success');
            }
        }
    });
    
    // V√©rifier les titres - D√©bloquer tous les titres √©ligibles selon le niveau actuel
    // S'assurer que unlockedTitles existe et est un tableau
    if (!Array.isArray(gameState.customization.unlockedTitles)) {
        gameState.customization.unlockedTitles = [];
    }
    
    CUSTOMIZATION_DATA.titles.forEach(title => {
        if (!gameState.customization.unlockedTitles.includes(title.id)) {
            if (title.check && title.check()) {
                gameState.customization.unlockedTitles.push(title.id);
                // Ne pas spammer les toasts si on charge une sauvegarde (silent mode)
                const isSilent = gameState.customization.titleUnlockSilent || false;
                if (!isSilent) {
                    if (!Array.isArray(gameState.customization.unseenUnlocks.titles)) {
                        gameState.customization.unseenUnlocks.titles = [];
                    }
                    gameState.customization.unseenUnlocks.titles.push(title.id);
                    showToast(`üèÖ Nouveau titre d√©bloqu√© : ${title.name} !`, 'success');
                }
            }
        }
    });
    
    // Marquer que les d√©blocages initiaux sont faits (pour √©viter les toasts au chargement)
    if (!gameState.customization.titleUnlockSilent) {
        gameState.customization.titleUnlockSilent = true;
    }
    
    // Sauvegarder imm√©diatement pour √©viter la perte de donn√©es
    saveGame();
    
    updateCustomizationNotification();
    saveGame();
}

// Fonction pour mettre √† jour la notification de personnalisation
function updateCustomizationNotification() {
    const trainerInfo = document.querySelector('.trainer-info');
    if (!trainerInfo) return;
    
    // V√©rifier s'il y a des √©l√©ments non vus
    const unseenUnlocks = gameState.customization.unseenUnlocks || {
        icons: [],
        xpBars: [],
        backgrounds: [],
        titles: []
    };
    
    const hasUnseen = unseenUnlocks.icons.length > 0 || 
                     unseenUnlocks.xpBars.length > 0 || 
                     unseenUnlocks.backgrounds.length > 0 || 
                     unseenUnlocks.titles.length > 0;
    
    // Chercher ou cr√©er le badge de notification
    let notificationBadge = trainerInfo.querySelector('.customization-notif-badge');
    
    if (hasUnseen) {
        if (!notificationBadge) {
            notificationBadge = document.createElement('div');
            notificationBadge.className = 'customization-notif-badge';
            notificationBadge.style.cssText = 'position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: bold; color: white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.8); animation: pulse 1.5s ease-in-out infinite; z-index: 10;';
            notificationBadge.textContent = '!';
            trainerInfo.style.position = 'relative';
            trainerInfo.appendChild(notificationBadge);
        }
    } else {
        if (notificationBadge) {
            notificationBadge.remove();
        }
    }
}

// Fonction pour ouvrir l'√©diteur de personnalisation
window.openCustomizationEditor = function(category) {
    checkAndUnlockCustomization();
    
    // Marquer les √©l√©ments de cette cat√©gorie comme vus
    if (gameState.customization.unseenUnlocks) {
        gameState.customization.unseenUnlocks[category === 'icon' ? 'icons' : category === 'xpbar' ? 'xpBars' : category === 'background' ? 'backgrounds' : 'titles'] = [];
        updateCustomizationNotification();
        saveGame();
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;';
    
    let items = [];
    let unlocked = [];
    let selected = null;
    let title = '';
    
    switch(category) {
        case 'icon':
            items = CUSTOMIZATION_DATA.icons;
            unlocked = gameState.customization.unlockedIcons;
            selected = gameState.customization.selectedIcon || 'default';
            title = 'Ic√¥nes de Dresseur';
            break;
        case 'xpbar':
            items = CUSTOMIZATION_DATA.xpBars;
            unlocked = gameState.customization.unlockedXpBars;
            selected = gameState.customization.selectedXpBar || 'classic_blue';
            title = 'Barres d\'XP';
            break;
        case 'background':
            items = CUSTOMIZATION_DATA.backgrounds;
            unlocked = gameState.customization.unlockedBackgrounds;
            selected = gameState.customization.selectedBackground || 'default';
            title = 'Backgrounds de Profil';
            break;
        case 'title':
            items = CUSTOMIZATION_DATA.titles;
            unlocked = gameState.customization.unlockedTitles;
            selected = gameState.customization.selectedTitle || null;
            title = 'Titres Sp√©ciaux';
            break;
    }
    
    const availableItems = items.filter(item => item.unlocked || unlocked.includes(item.id));
    const lockedItems = items.filter(item => !item.unlocked && !unlocked.includes(item.id));
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(30, 30, 50, 0.98), rgba(20, 20, 40, 0.98)); border-radius: 20px; padding: 40px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; border: 2px solid rgba(125, 95, 255, 0.5); position: relative;">
            <button onclick="this.closest('.modal').remove()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseenter="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.1)'" onmouseleave="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">√ó</button>
            <h2 style="text-align: center; color: #fff; margin-bottom: 30px; font-size: 28px;">${title}</h2>
            
            <div style="margin-bottom: 30px;">
                <h3 style="color: #7d5fff; margin-bottom: 15px;">D√©bloqu√©s</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    ${availableItems.map(item => {
                        const isSelected = item.id === selected;
                        const displayIcon = category === 'icon' ? item.icon : '';
                        const displayStyle = category === 'xpbar' || category === 'background' ? `background: ${item.style};` : '';
                        const iconDisplay = category === 'icon' && item.iconUrl ? 
                            `<img src="${item.iconUrl}" crossOrigin="anonymous" loading="eager" style="width: 64px; height: 64px; image-rendering: pixelated; object-fit: contain; margin: 0 auto 10px; display: block;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><div style="font-size: 3em; margin-bottom: 10px; display: none; align-items: center; justify-content: center;">${displayIcon}</div>` :
                            (displayIcon ? `<div style="font-size: 3em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center;">${displayIcon}</div>` : '');
                        return `
                            <div onclick="selectCustomization('${category}', '${item.id}')" style="
                                background: ${isSelected ? 'rgba(125, 95, 255, 0.3)' : 'rgba(255,255,255,0.1)'};
                                border: 2px solid ${isSelected ? '#7d5fff' : 'rgba(255,255,255,0.2)'};
                                border-radius: 12px;
                                padding: 20px;
                                text-align: center;
                                cursor: pointer;
                                transition: all 0.3s;
                                ${displayStyle}
                            " onmouseenter="this.style.transform='scale(1.05)'; this.style.borderColor='#7d5fff';" onmouseleave="this.style.transform='scale(1)'; this.style.borderColor='${isSelected ? '#7d5fff' : 'rgba(255,255,255,0.2)'}';">
                                ${iconDisplay}
                                <div style="color: #fff; font-weight: 600; margin-bottom: 5px;">${item.name}</div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.85em;">${item.unlockCondition}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            ${lockedItems.length > 0 ? `
                <div>
                    <h3 style="color: rgba(255,255,255,0.5); margin-bottom: 15px;">Verrouill√©s</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                        ${lockedItems.map(item => {
                            const displayIcon = category === 'icon' ? item.icon : '';
                            const iconDisplay = category === 'icon' && item.iconUrl ? 
                                `<img src="${item.iconUrl}" crossOrigin="anonymous" loading="eager" style="width: 64px; height: 64px; image-rendering: pixelated; object-fit: contain; margin: 0 auto 10px; filter: grayscale(100%); opacity: 0.3; display: block;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" /><div style="font-size: 3em; margin-bottom: 10px; display: none; align-items: center; justify-content: center; filter: grayscale(100%); opacity: 0.3;">${displayIcon}</div>` :
                                (displayIcon ? `<div style="font-size: 3em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; filter: grayscale(100%); opacity: 0.3;">${displayIcon}</div>` : '');
                            return `
                                <div style="
                                    background: rgba(0,0,0,0.3);
                                    border: 2px solid rgba(255,255,255,0.1);
                                    border-radius: 12px;
                                    padding: 20px;
                                    text-align: center;
                                    opacity: 0.5;
                                    position: relative;
                                ">
                                    <div style="position: absolute; top: 5px; right: 5px; font-size: 1.5em;">üîí</div>
                                    ${iconDisplay}
                                    <div style="color: rgba(255,255,255,0.4); font-weight: 600; margin-bottom: 5px;">${item.name}</div>
                                    <div style="color: rgba(255,255,255,0.3); font-size: 0.85em;">????</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="this.closest('.modal').remove()" style="
                    padding: 12px 30px;
                    background: linear-gradient(135deg, #7d5fff, #20d5d2);
                    border: none;
                    color: white;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 16px;
                ">Fermer</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

window.selectCustomization = function(category, id) {
    switch(category) {
        case 'icon':
            gameState.customization.selectedIcon = id;
            break;
        case 'xpbar':
            gameState.customization.selectedXpBar = id;
            break;
        case 'background':
            gameState.customization.selectedBackground = id;
            break;
        case 'title':
            gameState.customization.selectedTitle = id;
            break;
    }
    saveGame();
    updateProfileDisplay();
    updateTopBarDisplay();
    document.querySelector('.modal.active')?.remove();
    showToast('‚úÖ Personnalisation appliqu√©e !', 'success');
};

// Fonction pour mettre √† jour l'affichage du profil
function updateProfileDisplay() {
    const profilePage = document.getElementById('profile-page');
    if (!profilePage) return;
    
    // Mettre √† jour l'ic√¥ne et le nom (c√¥te √† c√¥te)
    const iconEl = profilePage.querySelector('#profile-icon');
    const nameEl = profilePage.querySelector('#profile-name');
    const nameContainer = nameEl?.parentElement;
    
    if (iconEl) {
        const selectedIcon = CUSTOMIZATION_DATA.icons.find(i => i.id === (gameState.customization.selectedIcon || 'default')) || CUSTOMIZATION_DATA.icons[0];
        if (selectedIcon) {
            if (selectedIcon.iconUrl) {
                const img = document.createElement('img');
                img.src = selectedIcon.iconUrl;
                img.crossOrigin = 'anonymous'; // Pour √©viter les probl√®mes CORS
                img.loading = 'eager'; // Chargement imm√©diat
                img.style.cssText = 'width: 48px; height: 48px; image-rendering: pixelated; background: rgba(255,255,255,0.1); border-radius: 50%; object-fit: contain; flex-shrink: 0; display: block;';
                
                // Timeout pour forcer le fallback si l'image ne charge pas rapidement (augment√© pour PWA)
                const timeout = setTimeout(() => {
                    if (!img.complete || img.naturalWidth === 0) {
                        iconEl.innerHTML = '';
                        iconEl.textContent = selectedIcon.icon || 'üë§';
                        iconEl.style.cssText = 'font-size: 3em; flex-shrink: 0; display: block;';
                    }
                }, 5000);
                
                // Fallback rapide pour PWA (v√©rification apr√®s 1 seconde)
                const quickCheck = setTimeout(() => {
                    if (!img.complete || img.naturalWidth === 0 || img.offsetWidth === 0 || img.offsetHeight === 0) {
                        clearTimeout(timeout);
                        iconEl.innerHTML = '';
                        iconEl.textContent = selectedIcon.icon || 'üë§';
                        iconEl.style.cssText = 'font-size: 3em; flex-shrink: 0; display: block;';
                    }
                }, 1000);
                
                img.onerror = function() {
                    clearTimeout(timeout);
                    clearTimeout(quickCheck);
                    // Fallback vers l'emoji si l'image ne charge pas
                    iconEl.innerHTML = '';
                    iconEl.textContent = selectedIcon.icon || 'üë§';
                    iconEl.style.fontSize = '3em';
                    iconEl.style.display = 'block';
                };
                img.onload = function() {
                    clearTimeout(timeout);
                    clearTimeout(quickCheck);
                    // S'assurer que l'image est visible et v√©rifier qu'elle est vraiment charg√©e
                    if (img.complete && img.naturalWidth > 0) {
                        img.style.display = 'block';
                        img.style.visibility = 'visible';
                        img.style.opacity = '1';
                    } else {
                        // Si l'image n'est pas vraiment charg√©e, fallback
                        iconEl.innerHTML = '';
                        iconEl.textContent = selectedIcon.icon || 'üë§';
                        iconEl.style.cssText = 'font-size: 3em; flex-shrink: 0; display: block;';
                    }
                };
                iconEl.innerHTML = '';
                iconEl.style.cssText = 'font-size: 3em; flex-shrink: 0; display: flex; align-items: center; justify-content: center;';
                iconEl.appendChild(img);
            } else {
                iconEl.innerHTML = '';
                iconEl.textContent = selectedIcon.icon || 'üë§';
                iconEl.style.cssText = 'font-size: 3em; flex-shrink: 0; display: block;';
            }
        } else {
            // Fallback ultime si aucun ic√¥ne n'est trouv√©
            iconEl.innerHTML = '';
            iconEl.textContent = 'üë§';
            iconEl.style.cssText = 'font-size: 3em; flex-shrink: 0; display: block;';
        }
    }
    
    // Mettre √† jour le nom
    if (nameEl) {
        const trainerName = gameState.customization.trainerName || `Dresseur Niveau ${gameState.level}`;
        nameEl.textContent = trainerName;
    }
    
    // Mettre √† jour la barre XP
    const xpBarEl = profilePage.querySelector('#profile-xp-bar');
    if (xpBarEl) {
        const selectedBar = CUSTOMIZATION_DATA.xpBars.find(b => b.id === (gameState.customization.selectedXpBar || 'classic_blue'));
        if (selectedBar) xpBarEl.style.background = selectedBar.style;
    }
    
    // Mettre √† jour le background
    const bgEl = profilePage.querySelector('#profile-header-bg');
    if (bgEl) {
        const selectedBg = CUSTOMIZATION_DATA.backgrounds.find(b => b.id === (gameState.customization.selectedBackground || 'default'));
        if (selectedBg) bgEl.style.background = selectedBg.style;
    }
    
    // Afficher les ic√¥nes crayon seulement si des √©l√©ments non-d√©faut sont d√©bloqu√©s
    const hasUnlockedIcons = gameState.customization.unlockedIcons.length > 1 || (gameState.customization.unlockedIcons.length === 1 && !gameState.customization.unlockedIcons.includes('default'));
    const hasUnlockedXpBars = gameState.customization.unlockedXpBars.length > 1 || (gameState.customization.unlockedXpBars.length === 1 && !gameState.customization.unlockedXpBars.includes('classic_blue'));
    const hasUnlockedBackgrounds = gameState.customization.unlockedBackgrounds.length > 1 || (gameState.customization.unlockedBackgrounds.length === 1 && !gameState.customization.unlockedBackgrounds.includes('default'));
    const hasUnlockedTitles = gameState.customization.unlockedTitles.length > 0;
    
    // Mettre √† jour le titre
    const titleEl = profilePage.querySelector('#profile-title');
    const titleEditEl = profilePage.querySelector('#profile-title-edit');
    if (titleEl) {
        const selectedTitle = gameState.customization.selectedTitle ? 
            CUSTOMIZATION_DATA.titles.find(t => t.id === gameState.customization.selectedTitle) : null;
        if (selectedTitle) {
            titleEl.textContent = selectedTitle.name;
            titleEl.style.display = 'block';
        } else {
            titleEl.style.display = 'none';
        }
    }
    
    // Afficher les ic√¥nes crayon si des √©l√©ments non-d√©faut sont d√©bloqu√©s
    const iconEditEl = profilePage.querySelector('[onclick*="openCustomizationEditor(\'icon\')"]');
    if (iconEditEl) iconEditEl.style.display = hasUnlockedIcons ? 'flex' : 'none';
    
    const xpBarEditEl = document.getElementById('xp-bar-edit-btn');
    if (xpBarEditEl) {
        // Initialiser unlockedXpBars si n√©cessaire
        if (!gameState.customization) gameState.customization = {};
        if (!Array.isArray(gameState.customization.unlockedXpBars)) {
            gameState.customization.unlockedXpBars = ['classic_blue'];
        }
        
        // On sort le bouton du flux normal
        xpBarEditEl.style.position = 'absolute';
        xpBarEditEl.style.right = '10px'; // Coll√© √† droite du conteneur global
        xpBarEditEl.style.top = '50%';
        xpBarEditEl.style.transform = 'translateY(-50%)';
        xpBarEditEl.style.zIndex = '100'; // Au-dessus de tout
        xpBarEditEl.style.background = 'rgba(0,0,0,0.6)'; // Fond sombre pour lisibilit√©
        
        // On v√©rifie si on a d√©bloqu√© d'autres barres que celle par d√©faut
        const hasUnlockedSkins = gameState.customization.unlockedXpBars.length > 1;
        
        // Condition : Niveau 10+ OU Skins d√©bloqu√©s
        if (gameState.level >= 10 || hasUnlockedSkins) {
            xpBarEditEl.style.display = 'flex'; // Flex pour centrer l'ic√¥ne
        } else {
            xpBarEditEl.style.display = 'none';
        }
    }
    
    const bgEditEl = profilePage.querySelector('[onclick*="openCustomizationEditor(\'background\')"]');
    if (bgEditEl) bgEditEl.style.display = hasUnlockedBackgrounds ? 'flex' : 'none';
    
    // Afficher l'ic√¥ne d'√©dition de titre si des titres sont d√©bloqu√©s (IMPORTANT: apr√®s toutes les v√©rifications)
    if (titleEditEl) {
        // V√©rifier √† nouveau que hasUnlockedTitles est correct
        const currentHasUnlockedTitles = Array.isArray(gameState.customization.unlockedTitles) && gameState.customization.unlockedTitles.length > 0;
        titleEditEl.style.display = currentHasUnlockedTitles ? 'flex' : 'none';
        console.log('üîç Title Edit Button:', { 
            hasUnlockedTitles: currentHasUnlockedTitles, 
            unlockedTitles: gameState.customization.unlockedTitles,
            display: titleEditEl.style.display 
        });
    }
    
    // Afficher l'ic√¥ne crayon du titre si des titres sont d√©bloqu√©s (m√™me sans titre s√©lectionn√©)
    if (titleEditEl) {
        titleEditEl.style.display = hasUnlockedTitles ? 'flex' : 'none';
    }
}

// Fonction pour mettre √† jour l'affichage de la barre sup√©rieure
function updateTopBarDisplay() {
    const trainerInfo = document.querySelector('.trainer-info');
    if (!trainerInfo) return;
    
    // S'assurer que trainer-info est en flex pour aligner l'ic√¥ne avec le contenu
    trainerInfo.style.display = 'flex';
    trainerInfo.style.alignItems = 'center';
    trainerInfo.style.gap = '8px';
    
    // Mettre √† jour l'ic√¥ne
    const iconEl = trainerInfo.querySelector('#topbar-icon');
    if (iconEl) {
        const selectedIcon = CUSTOMIZATION_DATA.icons.find(i => i.id === (gameState.customization.selectedIcon || 'default')) || CUSTOMIZATION_DATA.icons[0];
        if (selectedIcon) {
            if (selectedIcon.iconUrl) {
                // Cr√©er l'image avec gestion d'erreur
                const img = document.createElement('img');
                img.src = selectedIcon.iconUrl;
                img.crossOrigin = 'anonymous'; // Pour √©viter les probl√®mes CORS
                img.loading = 'eager'; // Chargement imm√©diat
                img.style.cssText = 'width: 32px; height: 32px; image-rendering: pixelated; background: rgba(255,255,255,0.1); border-radius: 50%; object-fit: contain; display: inline-block; vertical-align: middle; flex-shrink: 0;';
                
                // Timeout pour forcer le fallback si l'image ne charge pas rapidement (augment√© pour PWA)
                const timeout = setTimeout(() => {
                    if (!img.complete || img.naturalWidth === 0) {
                        iconEl.innerHTML = '';
                        iconEl.textContent = selectedIcon.icon || 'üë§';
                        iconEl.style.fontSize = '1.2em';
                    }
                }, 5000);
                
                img.onerror = function() {
                    clearTimeout(timeout);
                    // Fallback vers l'emoji si l'image ne charge pas
                    iconEl.innerHTML = '';
                    iconEl.textContent = selectedIcon.icon || 'üë§';
                    iconEl.style.fontSize = '1.2em';
                };
                // Fallback rapide pour PWA
                const quickCheckTopBar = setTimeout(() => {
                    if (!img.complete || img.naturalWidth === 0 || img.offsetWidth === 0) {
                        clearTimeout(timeout);
                        iconEl.innerHTML = '';
                        iconEl.textContent = selectedIcon.icon || 'üë§';
                        iconEl.style.fontSize = '1.2em';
                    }
                }, 1000);
                
                img.onerror = function() {
                    clearTimeout(timeout);
                    clearTimeout(quickCheckTopBar);
                    // Fallback vers l'emoji si l'image ne charge pas
                    iconEl.innerHTML = '';
                    iconEl.textContent = selectedIcon.icon || 'üë§';
                    iconEl.style.fontSize = '1.2em';
                };
                img.onload = function() {
                    clearTimeout(timeout);
                    clearTimeout(quickCheckTopBar);
                    // S'assurer que l'image est visible
                    if (img.complete && img.naturalWidth > 0) {
                        img.style.display = 'inline-block';
                        img.style.visibility = 'visible';
                        img.style.opacity = '1';
                    } else {
                        iconEl.innerHTML = '';
                        iconEl.textContent = selectedIcon.icon || 'üë§';
                        iconEl.style.fontSize = '1.2em';
                    }
                };
                iconEl.innerHTML = '';
                iconEl.appendChild(img);
            } else {
                iconEl.innerHTML = '';
                iconEl.textContent = selectedIcon.icon || 'üë§';
                iconEl.style.fontSize = '1.2em';
            }
        } else {
            // Fallback ultime si aucun ic√¥ne n'est trouv√©
            iconEl.innerHTML = '';
            iconEl.textContent = 'üë§';
            iconEl.style.fontSize = '1.2em';
        }
    }
    
    // Mettre √† jour la barre XP
    const xpBarEl = document.getElementById('xp-bar');
    if (xpBarEl) {
        const selectedBar = CUSTOMIZATION_DATA.xpBars.find(b => b.id === (gameState.customization.selectedXpBar || 'classic_blue'));
        if (selectedBar) xpBarEl.style.background = selectedBar.style;
    }
    
    // Mettre √† jour le titre
    const titleEl = trainerInfo.querySelector('#topbar-title');
    if (titleEl) {
        const selectedTitle = gameState.customization.selectedTitle ? 
            CUSTOMIZATION_DATA.titles.find(t => t.id === gameState.customization.selectedTitle) : null;
        if (selectedTitle) {
            titleEl.textContent = selectedTitle.name;
            titleEl.style.display = 'block';
        } else {
            titleEl.style.display = 'none';
        }
    }
    
    // Appliquer le background au header sticky
    const topBarElement = document.querySelector('.top-bar');
    if (topBarElement) {
        const selectedBgId = gameState.customization.selectedBackground || 'default';
        const bgData = CUSTOMIZATION_DATA.backgrounds.find(b => b.id === selectedBgId);
        if (bgData) {
            topBarElement.style.background = bgData.style;
            topBarElement.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
        }
    }
}

// Fonction pour √©diter le nom du dresseur
window.editTrainerName = function() {
    const currentName = gameState.customization.trainerName || `Dresseur Niveau ${gameState.level}`;
    const newName = prompt('Entrez votre nom de dresseur:', currentName);
    if (newName !== null && newName.trim() !== '') {
        gameState.customization.trainerName = newName.trim();
        saveGame();
        updateProfileDisplay();
        updateTopBarDisplay();
        showToast('‚úÖ Nom mis √† jour !', 'success');
    }
};

// ===== SYST√àME NARRATIF (GDD V10.0) =====
const DIALOGUES = {
    'intro_1': {
        lines: [
            "INIT_SEQUENCE... Syst√®me restaur√©.",
            "Bonjour Archiviste. Je suis Porygon-Z, ton guide.",
            "Ta mission : Reconstruire la base de donn√©es corrompue."
        ],
        trigger: () => !gameState.narrative.history.includes('intro_1')
    },
    'unlock_fishing': {
        lines: [
            "Niveau sup√©rieur d√©tect√© !",
            "Protocole [P√äCHE] activ√©.",
            "Les donn√©es indiquent une forte pr√©sence aquatique."
        ],
        trigger: () => gameState.level >= 2 && !gameState.narrative.history.includes('unlock_fishing')
    },
    'unlock_research': {
        lines: [
            "Analyse termin√©e...",
            "Nous pouvons maintenant exploiter l'√ânergie Onirique (EO).",
            "Le CENTRE DE RECHERCHE est d√©bloqu√© !",
            "Utilise tes Pok√©mon pour g√©n√©rer de l'√©nergie."
        ],
        trigger: () => gameState.level >= 5 && !gameState.narrative.history.includes('unlock_research')
    },
    'unlock_tcg': {
        lines: [
            "Nouveau syst√®me d√©tect√©...",
            "Les CARTES FULL ART sont maintenant disponibles !",
            "Ouvre des boosters pour obtenir des cartes rares.",
            "√âquipe-les comme Mascottes dans tes habitats pour booster la production !"
        ],
        // ‚úÖ CORRECTION : V√©rifier que le module TCG est r√©ellement d√©bloqu√© (niveau 25) et non pas simplement le niveau 2
        trigger: () => gameState.modules && gameState.modules.tcg && gameState.modules.tcg.unlocked && !gameState.narrative.history.includes('unlock_tcg')
    },
    'first_worker': {
        lines: [
            "Excellent ! Premier Pok√©mon assign√©.",
            "La production d'√©nergie commence.",
            "Plus tu assignes de Pok√©mon, plus la production augmente."
        ],
        trigger: () => false // D√©clench√© manuellement
    },
    'first_shiny_worker': {
        lines: [
            "‚ö†Ô∏è ANOMALIE D√âTECT√âE ‚ö†Ô∏è",
            "Un Pok√©mon Shiny a √©t√© assign√© !",
            "L'√ânergie Onirique r√©agit de mani√®re exponentielle...",
            "Production x10 activ√©e !"
        ],
        trigger: () => false // D√©clench√© manuellement
    },
    'shop_purchase': {
        lines: [
            "Upgrade install√© avec succ√®s.",
            "Les performances du syst√®me augmentent.",
            "Continue d'am√©liorer ton infrastructure !"
        ],
        trigger: () => false // D√©clench√© manuellement
    },
    'blueprints_explanation': {
        lines: [
            "ANALYSE DES HABITATS...",
            "Les habitats avanc√©s n√©cessitent des Blueprints.",
            "Ces plans sont trouv√©s dans les Exp√©ditions.",
            "Une fois obtenu, un Blueprint d√©bloque un habitat sp√©cifique.",
            "Exemple : blueprint_ocean d√©bloque l'Oc√©an.",
            "Explore les Exp√©ditions pour trouver ces ressources rares."
        ],
        trigger: () => {
            // D√©clencher quand le joueur voit un habitat verrouill√© pour la premi√®re fois
            const hasLockedHabitats = Object.values(gameState.research?.habitats || {}).some(h => !h.unlocked);
            const hasSeenDialogue = gameState.narrative?.history?.includes('blueprints_explanation');
            return hasLockedHabitats && !hasSeenDialogue && gameState.research?.unlocked;
        }
    },
    'terminal_empty': {
        lines: [
            "SYST√àME TERMINAL...",
            "Le Terminal est actuellement vide.",
            "Pour d√©bloquer les upgrades, tu dois d'abord activer l'Automatisation.",
            "Cela co√ªte 10 Processor Chips.",
            "Les Processor Chips sont obtenus en jouant au Pok√©-Poker.",
            "Une fois l'Automatisation activ√©e, le Terminal affichera les upgrades disponibles."
        ],
        trigger: () => {
            const automationLevel = gameState.research?.automationLevel || 0;
            const hasSeenDialogue = gameState.narrative?.history?.includes('terminal_empty');
            const isOnTerminalTab = document.getElementById('tab-terminal')?.classList.contains('active');
            return automationLevel === 0 && !hasSeenDialogue && gameState.research?.unlocked && isOnTerminalTab;
        }
    }
};

let currentDialogue = null;
let currentLineIndex = 0;
let dialogueTimeout = null;

function checkNarrativeTriggers() {
    // CORRECTION : V√©rifier les flags narratifs pour √©viter les r√©p√©titions
    if (!gameState.system) gameState.system = { narrativeFlags: [] };
    if (!gameState.system.narrativeFlags) gameState.system.narrativeFlags = [];
    if (!gameState.narrative) gameState.narrative = { history: [] };
    if (!gameState.narrative.history) gameState.narrative.history = [];
    
    for (const [id, data] of Object.entries(DIALOGUES)) {
        // Ne pas d√©clencher si d√©j√† vu (v√©rifier les deux syst√®mes)
        const alreadySeen = gameState.narrative.history.includes(id) || 
                           gameState.system.narrativeFlags.includes(id);
        
        if (!alreadySeen && data.trigger && typeof data.trigger === 'function' && data.trigger()) {
            startDialogue(id);
            // Ajouter au flag pour √©viter les r√©p√©titions
            if (!gameState.system.narrativeFlags.includes(id)) {
                gameState.system.narrativeFlags.push(id);
            }
            break;
        }
    }
}

function startDialogue(id) {
    const dialogue = DIALOGUES[id];
    if (!dialogue) return;
    
    gameState.narrative.history.push(id);
    currentDialogue = dialogue;
    currentLineIndex = 0;
    
    showDialogueBox();
    displayNextLine();
}

function showDialogueBox() {
    let overlay = document.getElementById('narrative-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'narrative-overlay';
        overlay.className = 'narrative-overlay';
        // Permettre de cliquer partout sur l'overlay pour avancer
        overlay.onclick = function(e) {
            if (e.target === overlay || e.target.closest('.narrative-box')) {
                advanceDialogue();
            }
        };
        document.body.appendChild(overlay);
    }
    
    // D√©tecter si c'est un dialogue d'erreur/peur (certains mots-cl√©s)
    const isErrorDialogue = currentDialogue && currentDialogue.lines.some(line => 
        line.toLowerCase().includes('erreur') || 
        line.toLowerCase().includes('bug') || 
        line.toLowerCase().includes('corrompu') ||
        line.toLowerCase().includes('anomalie')
    );
    
    const glitchClass = isErrorDialogue ? 'glitch-error' : 'glitch';
    
    overlay.innerHTML = `
        <div class="narrative-box" style="cursor: pointer;">
            <img src="${getAnimatedSpriteUrl(474)}" class="narrative-portrait ${glitchClass}" alt="Porygon-Z">
            <div class="narrative-name">PORYGON-Z</div>
            <div class="narrative-text" id="narrative-text"></div>
            <div class="narrative-next" id="narrative-next">‚ñº</div>
        </div>
    `;
    
    overlay.style.display = 'flex';
}

function displayNextLine() {
    if (!currentDialogue || currentLineIndex >= currentDialogue.lines.length) {
        closeDialogue();
        return;
    }
    
    const textEl = document.getElementById('narrative-text');
    if (!textEl) return;
    
    const line = currentDialogue.lines[currentLineIndex];
    textEl.textContent = '';
    
    let charIndex = 0;
    const typewriter = () => {
        if (charIndex < line.length) {
            textEl.textContent += line[charIndex];
            charIndex++;
            dialogueTimeout = setTimeout(typewriter, 30);
        } else {
            const nextEl = document.getElementById('narrative-next');
            if (nextEl) nextEl.style.display = 'block';
        }
    };
    
    typewriter();
}

window.advanceDialogue = function() {
    if (dialogueTimeout) {
        clearTimeout(dialogueTimeout);
        dialogueTimeout = null;
    }
    
    const textEl = document.getElementById('narrative-text');
    if (textEl && currentDialogue && currentLineIndex < currentDialogue.lines.length) {
        textEl.textContent = currentDialogue.lines[currentLineIndex];
    }
    
    currentLineIndex++;
    const nextEl = document.getElementById('narrative-next');
    if (nextEl) nextEl.style.display = 'none';
    
    if (currentLineIndex < currentDialogue.lines.length) {
        displayNextLine();
    } else {
        closeDialogue();
    }
};

function closeDialogue() {
    const overlay = document.getElementById('narrative-overlay');
    if (overlay) {
        overlay.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 300);
    }
    currentDialogue = null;
    currentLineIndex = 0;
    if (dialogueTimeout) {
        clearTimeout(dialogueTimeout);
        dialogueTimeout = null;
    }
}

// ===== CENTRE DE RECHERCHE 2.0 - NOUVELLES STRUCTURES =====

// Base de donn√©es de l'Arbre de Recherche (Tech Tree)
const TECH_TREE_DB = {
    'node_101': {
        id: 'node_101',
        name: 'R√©seau Myc√©lien',
        desc: 'Les types Plante boostent les types Insecte adjacents de +50% production.',
        icon: 'üçÑ',
        parents: [], // Racine
        cost: { energy: 1000 },
        category: 'bio',
        effect: (grid) => {
            // Logique de boost de voisinage (sera impl√©ment√©e dans Module C)
            return { type: 'neighbor_boost', source: 'Grass', target: 'Insecte', value: 1.5 };
        }
    },
    'node_102': {
        id: 'node_102',
        name: 'Hydro-Refroidissement',
        desc: 'D√©bloque le Slot Centrale (√âlectrik) et +20% production Eau.',
        icon: '‚ö°',
        parents: ['node_101'],
        cost: { energy: 5000 },
        category: 'tech',
        effect: (grid) => {
            return { type: 'unlock_habitat', habitat: 'power_plant' };
        }
    },
    'node_103': {
        id: 'node_103',
        name: 'Symbiose V√©g√©tale',
        desc: 'Les Pok√©mon Plante produisent +30% si adjacents √† une Baie.',
        icon: 'üåø',
        parents: ['node_101'],
        cost: { energy: 3000 },
        category: 'bio',
        effect: (grid) => {
            return { type: 'adjacency_bonus', source: 'plant', target: 'berry', value: 1.3 };
        }
    },
    'node_201': {
        id: 'node_201',
        name: 'Overclock Permanent',
        desc: '+5% production passive globale.',
        icon: 'üîß',
        parents: ['node_102'],
        cost: { energy: 10000 },
        category: 'tech',
        effect: (grid) => {
            return { type: 'global_mult', value: 1.05 };
        }
    }
};

// Types d'Anomalies (Glitchs)
const ANOMALY_TYPES = {
    'frenzy': {
        id: 'frenzy',
        name: 'Frenzy',
        desc: 'Production x7 pendant 77s',
        mult: 7,
        duration: 77000, // 77 secondes
        icon: '‚ö°',
        rarity: 'common',
        spawnChance: 0.4
    },
    'click_frenzy': {
        id: 'click_frenzy',
        name: 'Click Frenzy',
        desc: 'Clic x777 pendant 13s',
        mult: 777,
        duration: 13000, // 13 secondes
        icon: 'üí•',
        rarity: 'rare',
        spawnChance: 0.2
    },
    'building_special': {
        id: 'building_special',
        name: 'Synergie de Type',
        desc: 'Production x(1 + 0.1 √ó Nb Pok√©mon Type X) pendant 30s',
        mult: null, // Calcul√© dynamiquement
        duration: 30000,
        icon: 'üîó',
        rarity: 'uncommon',
        spawnChance: 0.3
    },
    'chain': {
        id: 'chain',
        name: 'Cha√Æne Glitch',
        desc: 'S√©rie rapide de clics bonus (dispara√Æt en 3s)',
        mult: 10,
        duration: 3000,
        icon: 'üîó',
        rarity: 'rare',
        spawnChance: 0.1
    }
};

// Types de sols pour le jardin
const SOIL_TYPES = {
    'clay': { name: 'Argile', mult: 1.0, unlockCost: 0 },
    'fertilizer': { name: 'Fertilisant', mult: 1.5, unlockCost: 5000 },
    'pebbles': { name: 'Gravier', mult: 0.8, unlockCost: 2000 },
    'rich_soil': { name: 'Terreau Riche', mult: 2.0, unlockCost: 20000 }
};

// ===== SYST√àME DE PRESTIGE (OUTSIDERS) - PHASE 4 =====

// Base de donn√©es des upgrades de Prestige (Outsiders)
const PRESTIGE_UPGRADES = {
    'overclock_permanent': {
        id: 'overclock_permanent',
        name: 'Overclock Permanent',
        desc: '+1% efficacit√© de production par niveau',
        icon: '‚ö°',
        baseCost: 1, // Co√ªt en Ancient Data
        costMult: 1.5, // Multiplicateur de co√ªt par niveau
        effect: (level) => ({ type: 'global_mult', value: 1 + (level * 0.01) }),
        maxLevel: 100
    },
    'slot_save': {
        id: 'slot_save',
        name: 'Slot de Sauvegarde',
        desc: 'Permet de garder 1 plante apr√®s reset',
        icon: 'üíæ',
        baseCost: 5,
        costMult: 2.0,
        effect: (level) => ({ type: 'save_slots', value: level }),
        maxLevel: 3
    },
    'ancient_boost': {
        id: 'ancient_boost',
        name: 'Boost Ancestral',
        desc: '+5% multiplicateur passif par niveau',
        icon: 'üîÆ',
        baseCost: 3,
        costMult: 1.8,
        effect: (level) => ({ type: 'passive_mult', value: 1 + (level * 0.05) }),
        maxLevel: 20
    },
    'garden_expansion': {
        id: 'garden_expansion',
        name: 'Expansion du Jardin',
        desc: '+3 plots d√©bloqu√©s par niveau',
        icon: 'üå±',
        baseCost: 2,
        costMult: 2.5,
        effect: (level) => ({ type: 'unlock_plots', value: 3 * level }),
        maxLevel: 9 // 9 niveaux = 27 plots suppl√©mentaires (total 36)
    },
    'mutation_boost': {
        id: 'mutation_boost',
        name: 'Boost de Mutation',
        desc: '+10% chance de mutation par niveau',
        icon: 'üß¨',
        baseCost: 4,
        costMult: 2.0,
        effect: (level) => ({ type: 'mutation_chance', value: 1 + (level * 0.10) }),
        maxLevel: 10
    }
};

// Fonction pour calculer Ancient Data depuis Total Energy Produced
function calculateAncientData(totalEnergyProduced) {
    // Formule : ‚àõ(Total Energy Produced / 1,000,000)
    if (totalEnergyProduced < 1000000) return 0;
    return Math.floor(Math.cbrt(totalEnergyProduced / 1000000) * 100) / 100; // Arrondi √† 2 d√©cimales
}

// Fonction pour effectuer un Hard Reset (Reboot Syst√®me)
window.performPrestigeReset = function() {
    if (!gameState.research || !gameState.research.unlocked) {
        showToast('Le Centre de Recherche doit √™tre d√©bloqu√© !', 'error');
        return;
    }
    
    const totalEnergyProduced = gameState.research.totalEnergyProduced || 0;
    const ancientDataGain = calculateAncientData(totalEnergyProduced);
    
    if (ancientDataGain <= 0) {
        showToast('Vous devez produire au moins 1,000,000 EO pour effectuer un reset !', 'error');
        return;
    }
    
    // Confirmation
    const confirmed = confirm(
        `‚ö†Ô∏è REBOOT SYST√àME ‚ö†Ô∏è\n\n` +
        `Vous allez perdre :\n` +
        `‚Ä¢ Toute votre √ânergie Onirique\n` +
        `‚Ä¢ Tous les Pok√©mon du jardin\n` +
        `‚Ä¢ Tous les upgrades du Tech Tree\n` +
        `‚Ä¢ Toutes les plantes (sauf celles sauvegard√©es)\n` +
        `‚Ä¢ Tous les Chercheurs et Auto-Clickers\n\n` +
        `Vous gagnerez :\n` +
        `‚Ä¢ ${ancientDataGain.toFixed(2)} Ancient Data\n` +
        `‚Ä¢ Multiplicateur passif permanent : +${(ancientDataGain * 0.10 * 100).toFixed(1)}%\n\n` +
        `Continuer ?`
    );
    
    if (!confirmed) return;
    
    // Sauvegarder les plantes selon les slots de sauvegarde
    const saveSlotsLevel = (gameState.research.prestigeUpgrades?.slot_save || 0);
    const savedPlants = [];
    
    if (saveSlotsLevel > 0 && gameState.research.garden && gameState.research.garden.grid) {
        const grid = gameState.research.garden.grid;
        const plants = grid
            .filter(slot => slot.content && slot.content.type === 'plant')
            .slice(0, saveSlotsLevel) // Garder seulement le nombre de slots sauvegard√©s
            .map(slot => slot.content);
        
        savedPlants.push(...plants);
    }
    
    // Ajouter Ancient Data
    gameState.research.ancientData = (gameState.research.ancientData || 0) + ancientDataGain;
    
    // Recalculer le multiplicateur passif
    gameState.research.passiveMultiplier = 1 + (gameState.research.ancientData * 0.10);
    
    // RESET : √ânergie
    gameState.research.energy = 0;
    
    // RESET : Jardin (garder la structure mais vider le contenu)
    if (gameState.research.garden) {
        const grid = initializeGardenGrid();
        
        // R√©ins√©rer les plantes sauvegard√©es
        savedPlants.forEach((plant, index) => {
            if (index < grid.length && grid[index].unlocked) {
                grid[index].content = plant;
            }
        });
        
        gameState.research.garden.grid = grid;
    }
    
    // RESET : Tech Tree
    gameState.research.techTree = {
        unlockedNodes: [],
        availableNodes: ['node_101'] // Premier noeud toujours disponible
    };
    
    // RESET : Anomalies actives
    if (gameState.research.anomalies) {
        gameState.research.anomalies.activeEffects = [];
    }
    
    // RESET : Automatisation (Chercheurs et Auto-Clickers)
    // IMPORTANT : R√©initialiser pour redonner de l'int√©r√™t au Roguelike apr√®s reset
    if (gameState.research.automation) {
        gameState.research.automation.researchers = 0;
        gameState.research.automation.autoClickers = 0;
    }
    
    // Arr√™ter les intervalles d'auto-clic
    if (window.researcherInterval) {
        clearInterval(window.researcherInterval);
        window.researcherInterval = null;
    }
    if (window.autoClickerInterval) {
        clearInterval(window.autoClickerInterval);
        window.autoClickerInterval = null;
    }
    
    // RESET : Total Energy Produced (mais garder l'historique pour les stats)
    // On ne reset pas totalEnergyProduced car on veut garder l'historique
    
    saveGame();
    showToast(`üîÑ Reboot Syst√®me effectu√© ! +${ancientDataGain.toFixed(2)} Ancient Data`, 'success');
    
    // Rafra√Æchir l'UI
    updateResearchUI();
    if (gameState.research.garden && gameState.research.garden.grid) {
        renderGardenGrid();
    } else {
        renderHabitats();
    }
    
    // Afficher la modale de Prestige si c'est le premier reset
    if (gameState.research.ancientData === ancientDataGain) {
        setTimeout(() => {
            showPrestigeModal();
        }, 1000);
    }
};

// Fonction pour afficher la modale de Prestige
function showPrestigeModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(125, 95, 255, 0.3)); padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; border: 3px solid #a855f7; box-shadow: 0 0 50px rgba(168, 85, 247, 0.5);">
            <h1 style="color: #FFD700; text-align: center; font-size: 2.5em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);">
                üîÆ PRESTIGE D√âBLOQU√â üîÆ
            </h1>
            <div style="color: white; font-size: 1.2em; text-align: center; margin-bottom: 30px; line-height: 1.6;">
                <p>Vous avez acc√©d√© au <strong style="color: #FFD700;">Deepnet</strong> !</p>
                <p style="margin-top: 15px; color: rgba(255,255,255,0.8);">
                    Utilisez vos <strong style="color: #a855f7;">Ancient Data</strong> pour acheter des upgrades permanents qui survivront aux resets.
                </p>
            </div>
            <div style="text-align: center;">
                <button onclick="this.closest('.modal').remove(); switchResearchTab('prestige')" 
                        class="btn btn--primary" 
                        style="padding: 15px 30px; font-size: 1.2em; background: linear-gradient(135deg, #a855f7, #7d5fff); border: none;">
                    Acc√©der au Deepnet
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

// Fonction pour acheter un upgrade de Prestige
window.buyPrestigeUpgrade = function(upgradeId) {
    if (!gameState.research || !gameState.research.unlocked) return;
    
    const upgrade = PRESTIGE_UPGRADES[upgradeId];
    if (!upgrade) {
        showToast('Upgrade introuvable !', 'error');
        return;
    }
    
    // Initialiser les upgrades de prestige si n√©cessaire
    if (!gameState.research.prestigeUpgrades) {
        gameState.research.prestigeUpgrades = {};
    }
    
    const currentLevel = gameState.research.prestigeUpgrades[upgradeId] || 0;
    
    // V√©rifier le niveau max
    if (currentLevel >= upgrade.maxLevel) {
        showToast(`${upgrade.name} est d√©j√† au niveau maximum !`, 'info');
        return;
    }
    
    // Calculer le co√ªt
    const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, currentLevel));
    const ancientData = gameState.research.ancientData || 0;
    
    if (ancientData < cost) {
        showToast(`Pas assez d'Ancient Data ! N√©cessite ${cost} AD.`, 'error');
        return;
    }
    
    // Acheter l'upgrade
    gameState.research.ancientData -= cost;
    gameState.research.prestigeUpgrades[upgradeId] = currentLevel + 1;
    
    // Appliquer l'effet
    const effect = upgrade.effect(currentLevel + 1);
    
    if (effect.type === 'global_mult') {
        // Multiplicateur global (d√©j√† appliqu√© dans calculateProduction via passiveMultiplier)
        // On peut aussi l'appliquer directement ici si n√©cessaire
    } else if (effect.type === 'passive_mult') {
        // Multiplicateur passif additionnel
        gameState.research.passiveMultiplier = (gameState.research.passiveMultiplier || 1) * effect.value;
    } else if (effect.type === 'unlock_plots') {
        // D√©bloquer des plots suppl√©mentaires
        gameState.research.garden.unlockedPlots = Math.min(36, 9 + effect.value);
        
        // D√©bloquer les plots dans la grille
        const grid = gameState.research.garden.grid;
        let unlockedCount = 0;
        grid.forEach(slot => {
            if (unlockedCount < gameState.research.garden.unlockedPlots) {
                slot.unlocked = true;
                unlockedCount++;
            }
        });
    }
    
    saveGame();
    showToast(`${upgrade.name} am√©lior√© ! Niveau ${currentLevel + 1}`, 'success');
    
    // Rafra√Æchir l'UI
    renderPrestigeShop();
    updateResearchUI();
    if (gameState.research.garden && gameState.research.garden.grid) {
        renderGardenGrid();
    }
};

// Fonction pour rendre le shop de Prestige
function renderPrestigeShop() {
    const container = document.getElementById('prestige-shop');
    if (!container) return;
    
    const ancientData = gameState.research.ancientData || 0;
    const prestigeUpgrades = gameState.research.prestigeUpgrades || {};
    
    const upgradesHTML = Object.values(PRESTIGE_UPGRADES).map(upgrade => {
        const currentLevel = prestigeUpgrades[upgrade.id] || 0;
        const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, currentLevel));
        const canAfford = ancientData >= cost;
        const isMaxLevel = currentLevel >= upgrade.maxLevel;
        
        const effect = upgrade.effect(currentLevel);
        let effectDesc = '';
        if (effect.type === 'global_mult') {
            effectDesc = `+${((effect.value - 1) * 100).toFixed(1)}% production`;
        } else if (effect.type === 'passive_mult') {
            effectDesc = `+${((effect.value - 1) * 100).toFixed(1)}% multiplicateur passif`;
        } else if (effect.type === 'save_slots') {
            effectDesc = `${effect.value} slot(s) sauvegard√©(s)`;
        } else if (effect.type === 'unlock_plots') {
            effectDesc = `${effect.value} plot(s) suppl√©mentaire(s)`;
        } else if (effect.type === 'mutation_chance') {
            effectDesc = `+${((effect.value - 1) * 100).toFixed(0)}% chance de mutation`;
        }
        
        return `
            <div style="
                background: rgba(30, 30, 50, 0.8);
                border: 2px solid ${canAfford && !isMaxLevel ? '#FFD700' : '#444'};
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 15px;
            ">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 2.5em;">${upgrade.icon}</span>
                            <div>
                                <div style="color: white; font-weight: bold; font-size: 1.2em;">${upgrade.name}</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${upgrade.desc}</div>
                            </div>
                        </div>
                        <div style="color: #a855f7; font-size: 0.95em; margin-top: 10px;">
                            Niveau ${currentLevel}/${upgrade.maxLevel} ${currentLevel > 0 ? `| ${effectDesc}` : ''}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #FFD700; font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                            ${isMaxLevel ? 'MAX' : cost.toLocaleString()} AD
                        </div>
                        <button onclick="buyPrestigeUpgrade('${upgrade.id}')" 
                                class="btn btn--primary" 
                                ${!canAfford || isMaxLevel ? 'disabled' : ''}
                                style="padding: 10px 20px; ${!canAfford || isMaxLevel ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            ${isMaxLevel ? 'Niveau Max' : currentLevel === 0 ? 'Acheter' : 'Am√©liorer'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="background: rgba(20, 20, 35, 0.9); border: 2px solid #FFD700; border-radius: 12px; padding: 30px;">
            <h2 style="color: #FFD700; text-align: center; font-size: 2em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);">
                üîÆ Deepnet - Shop de Prestige
            </h2>
            <div style="text-align: center; margin-bottom: 30px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 10px; border: 2px solid #FFD700;">
                <div style="color: white; font-size: 1.1em; margin-bottom: 5px;">Ancient Data disponible</div>
                <div style="color: #FFD700; font-size: 2.5em; font-weight: bold; font-family: 'VT323', monospace;">
                    ${ancientData.toFixed(2)}
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="color: rgba(255,255,255,0.7); text-align: center; line-height: 1.6;">
                    Les upgrades de Prestige sont <strong style="color: #FFD700;">permanents</strong> et survivent aux resets.<br>
                    Effectuez un "Reboot Syst√®me" pour gagner plus d'Ancient Data.
                </p>
            </div>
            <div>
                ${upgradesHTML}
            </div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(255, 215, 0, 0.3);">
                <button onclick="performPrestigeReset()" 
                        class="btn btn--outline" 
                        style="padding: 12px 30px; border-color: #ef4444; color: #ef4444; font-size: 1.1em;">
                    üîÑ Reboot Syst√®me
                </button>
                <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; margin-top: 10px;">
                    Gain estim√© : ${calculateAncientData(gameState.research.totalEnergyProduced || 0).toFixed(2)} AD
                </div>
            </div>
        </div>
    `;
}

// Fonction pour rendre l'Arbre de Recherche (Tech Tree)
function renderTechTree() {
    const container = document.getElementById('tech-tree-container');
    if (!container) return;
    
    // Initialiser le techTree si n√©cessaire
    if (!gameState.research.techTree) {
        gameState.research.techTree = {
            unlockedNodes: []
        };
    }
    
    const unlockedNodes = gameState.research.techTree.unlockedNodes || [];
    const currentEnergy = gameState.research.energy || 0;
    
    // Organiser les nodes par niveau (parents -> enfants)
    const nodesByLevel = {};
    const allNodeIds = Object.keys(TECH_TREE_DB);
    
    // Trouver les nodes racines (sans parents)
    const rootNodes = allNodeIds.filter(nodeId => {
        const node = TECH_TREE_DB[nodeId];
        return !node.parents || node.parents.length === 0;
    });
    
    // Organiser en niveaux
    let currentLevel = 0;
    let nodesToProcess = [...rootNodes];
    const processed = new Set();
    
    while (nodesToProcess.length > 0) {
        nodesByLevel[currentLevel] = nodesToProcess;
        nodesToProcess.forEach(id => processed.add(id));
        
        const nextLevel = [];
        nodesToProcess.forEach(nodeId => {
            const node = TECH_TREE_DB[nodeId];
            allNodeIds.forEach(childId => {
                const child = TECH_TREE_DB[childId];
                if (child.parents && child.parents.includes(nodeId) && !processed.has(childId)) {
                    nextLevel.push(childId);
                }
            });
        });
        
        nodesToProcess = [...new Set(nextLevel)];
        currentLevel++;
    }
    
    // G√©n√©rer le HTML pour chaque node
    const nodesHTML = Object.entries(nodesByLevel).map(([level, nodeIds]) => {
        const levelNodes = nodeIds.map(nodeId => {
            const node = TECH_TREE_DB[nodeId];
            const isUnlocked = unlockedNodes.includes(nodeId);
            const canUnlock = !isUnlocked && 
                node.parents.every(parentId => unlockedNodes.includes(parentId)) &&
                currentEnergy >= node.cost.energy;
            
            const categoryColor = {
                'bio': '#10b981',
                'tech': '#3b82f6',
                'mystic': '#a855f7'
            }[node.category] || '#6b7280';
            
            return `
                <div class="tech-tree-node" 
                     data-node-id="${nodeId}"
                     style="
                         background: ${isUnlocked ? 'rgba(34, 197, 94, 0.2)' : 'rgba(30, 30, 50, 0.8)'};
                         border: 2px solid ${isUnlocked ? '#22c55e' : canUnlock ? categoryColor : '#444'};
                         border-radius: 12px;
                         padding: 15px;
                         text-align: center;
                         cursor: ${canUnlock ? 'pointer' : 'default'};
                         opacity: ${isUnlocked ? 1 : canUnlock ? 0.8 : 0.5};
                         transition: all 0.3s;
                         position: relative;
                         min-width: 200px;
                     "
                     ${canUnlock ? `onclick="unlockTechNode('${nodeId}')"` : ''}
                     onmouseover="${canUnlock ? "this.style.transform='scale(1.05)'; this.style.boxShadow='0 0 20px " + categoryColor + "'" : ''}"
                     onmouseout="${canUnlock ? "this.style.transform='scale(1)'; this.style.boxShadow='none'" : ''}">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">${node.icon}</div>
                    <div style="color: white; font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">${node.name}</div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-bottom: 10px; line-height: 1.4;">${node.desc}</div>
                    ${isUnlocked ? 
                        '<div style="color: #22c55e; font-size: 0.9em; font-weight: bold;">‚úì D√©bloqu√©</div>' :
                        `<div style="color: ${categoryColor}; font-size: 0.9em;">
                            <div>Co√ªt: ${node.cost.energy.toLocaleString()} EO</div>
                            ${!node.parents.every(p => unlockedNodes.includes(p)) ? 
                                '<div style="color: #ef4444; font-size: 0.8em; margin-top: 5px;">Pr√©requis requis</div>' : 
                                canUnlock ? '<div style="color: #22c55e; font-size: 0.8em; margin-top: 5px;">Cliquez pour d√©bloquer</div>' :
                                '<div style="color: #ef4444; font-size: 0.8em; margin-top: 5px;">√ânergie insuffisante</div>'
                            }
                        </div>`
                    }
                </div>
            `;
        }).join('');
        
        return `
            <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap;">
                ${levelNodes}
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #a855f7; font-size: 2em; margin-bottom: 10px;">üå≥ Arbre de Recherche</h2>
            <div style="color: rgba(255,255,255,0.7); font-size: 1.1em;">
                √ânergie Onirique: <span style="color: #a855f7; font-weight: bold; font-size: 1.3em;">${Math.floor(currentEnergy).toLocaleString()}</span> EO
            </div>
            <div style="color: rgba(255,255,255,0.5); font-size: 0.9em; margin-top: 5px;">
                Nodes d√©bloqu√©s: ${unlockedNodes.length}/${allNodeIds.length}
            </div>
            <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; margin-top: 10px; padding: 10px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; max-width: 600px; margin-left: auto; margin-right: auto;">
                üí° Les nodes d√©bloquent des bonus permanents pour votre production d'√ânergie Onirique.
            </div>
        </div>
        <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
            ${nodesHTML}
        </div>
    `;
}

// Fonction pour d√©bloquer un node du Tech Tree
window.unlockTechNode = function(nodeId) {
    const node = TECH_TREE_DB[nodeId];
    if (!node) return;
    
    if (!gameState.research.techTree) {
        gameState.research.techTree = { unlockedNodes: [] };
    }
    
    const unlockedNodes = gameState.research.techTree.unlockedNodes || [];
    
    // V√©rifier si d√©j√† d√©bloqu√©
    if (unlockedNodes.includes(nodeId)) {
        showToast('Ce node est d√©j√† d√©bloqu√© !', 'info');
        return;
    }
    
    // V√©rifier les pr√©requis
    if (node.parents && node.parents.length > 0) {
        const missingParents = node.parents.filter(p => !unlockedNodes.includes(p));
        if (missingParents.length > 0) {
            showToast('Vous devez d\'abord d√©bloquer les nodes pr√©requis !', 'error');
            return;
        }
    }
    
    // V√©rifier le co√ªt
    if (gameState.research.energy < node.cost.energy) {
        showToast(`√ânergie insuffisante ! (${node.cost.energy.toLocaleString()} EO requis)`, 'error');
        return;
    }
    
    // D√©bloquer le node
    gameState.research.energy -= node.cost.energy;
    unlockedNodes.push(nodeId);
    gameState.research.techTree.unlockedNodes = unlockedNodes;
    
    showToast(`‚ú® ${node.name} d√©bloqu√© !`, 'success');
    
    saveGame();
    renderTechTree();
    updateResearchUI();
};

// Types de plantes disponibles
const PLANT_TYPES = {
    'berry_oran': { name: 'Baie Oran', growthTime: 300000, production: 10, icon: 'ü´ê', seedChance: 0.1 },
    'berry_ceriz': { name: 'Baie Ceriz', growthTime: 600000, production: 50, icon: 'üçí', seedChance: 0.05 },
    'berry_maron': { name: 'Baie Maron', growthTime: 900000, production: 100, icon: 'üå∞', seedChance: 0.03 },
    'herb_rappel': { name: 'Herbe Rappel', growthTime: 1200000, production: 200, icon: 'üåø', seedChance: 0.02 },
    'berry_pecha': { name: 'Baie P√™cha', growthTime: 450000, production: 75, icon: 'üçë', seedChance: 0.01, mutation: true } // Mutation Ceriz + Maron
};

// R√®gles de mutation des plantes
const PLANT_MUTATION_RULES = {
    'berry_pecha': {
        required: ['berry_ceriz', 'berry_maron'],
        chance: 0.05, // 5% de chance par tick si les deux voisins sont pr√©sents
        description: 'Mutation : Baie Ceriz + Baie Maron'
    }
};

// Fonction pour initialiser la grille 6x6
function initializeGardenGrid() {
    const grid = [];
    const size = 6;
    
    for (let row = 0; row < size; row++) {
        for (let col = 0; col < size; col++) {
            const id = `slot_${row}_${col}`;
            const isUnlocked = (row >= 1 && row <= 3 && col >= 1 && col <= 3); // 3x3 central d√©bloqu√©
            
            grid.push({
                id: id,
                row: row,
                col: col,
                unlocked: isUnlocked,
                content: null, // { type: 'pokemon', id: 1, isShiny: false } || { type: 'plant', id: 'berry_oran', growthStart: Date.now() } || null
                type: null // Type de terrain (sera d√©termin√© par le sol)
            });
        }
    }
    
    return grid;
}

// Fonction de migration : Ancienne structure -> Nouvelle structure
function migrateResearchToV2() {
    if (!gameState.research) return;
    
    // V√©rifier si d√©j√† migr√© (pr√©sence de 'garden' ou 'anomalies')
    if (gameState.research.garden || gameState.research.anomalies) {
        return; // D√©j√† migr√©
    }
    
    console.log('üîÑ Migration Research V1 -> V2...');
    
    // Pr√©server les donn√©es existantes
    const oldEnergy = gameState.research.energy || 0;
    const oldTotalEnergy = gameState.research.totalEnergyProduced || 0;
    const oldClickMult = gameState.research.clickMultiplier || 1;
    const oldAutomation = gameState.research.automationLevel || 0;
    const oldUpgrades = gameState.research.upgrades || { mouse_driver: 0, gpu_overclock: 0, virus_scan: 0 };
    
    // Migrer les habitats vers la grille
    const grid = initializeGardenGrid();
    let slotIndex = 0;
    
    if (gameState.research.habitats) {
        Object.values(gameState.research.habitats).forEach(habitat => {
            if (habitat.unlocked && habitat.assigned && habitat.assigned.length > 0) {
                // Migrer les Pok√©mon assign√©s vers la grille
                habitat.assigned.forEach(pokeUid => {
                    if (slotIndex < grid.length && grid[slotIndex].unlocked) {
                        const pokeId = typeof pokeUid === 'string' ? parseInt(pokeUid.split('_')[0]) : pokeUid;
                        const isShiny = typeof pokeUid === 'string' && pokeUid.includes('_');
                        grid[slotIndex].content = {
                            type: 'pokemon',
                            id: pokeId,
                            isShiny: isShiny
                        };
                        slotIndex++;
                    }
                });
            }
        });
    }
    
    // Cr√©er la nouvelle structure
    gameState.research = {
        unlocked: gameState.research.unlocked || false,
        
        // √âconomie
        energy: oldEnergy,
        totalEnergyProduced: oldTotalEnergy,
        ancientData: 0, // Nouvelle monnaie de prestige
        
        // Production
        clickMultiplier: oldClickMult,
        passiveMultiplier: 1 + (oldAutomation * 0.1), // Convertir automationLevel en multiplicateur
        
        // Syst√®me d'Anomalies
        anomalies: {
            activeEffects: [],
            totalClicked: 0,
            glitchLevel: 0
        },
        
        // Tech Tree
        techTree: {
            unlockedNodes: [],
            availableNodes: ['node_101'] // Premier noeud disponible
        },
        
        // Jardin (remplace habitats)
        garden: {
            grid: grid,
            unlockedPlots: 9, // 3x3 central
            soils: 'clay',
            bankedSeeds: []
        },
        
        // Automatisation
        automation: {
            researchers: 0,
            autoClickers: 0
        },
        
        // Pr√©server les anciennes donn√©es pour compatibilit√© (sera supprim√© plus tard)
        _legacy: {
            automationLevel: oldAutomation,
            upgrades: oldUpgrades,
            habitats: gameState.research.habitats
        }
    };
    
    console.log('‚úÖ Migration Research V2 termin√©e');
    saveGame();
}

// ===== SYST√àME DE MUTATION DU JARDIN (TICKS) - PHASE 3 =====

// Variable globale pour tracker le tick du jardin
let gardenTickInterval = null;
let lastGardenTick = Date.now();
const GARDEN_TICK_INTERVAL = 30000; // 30 secondes

// Fonction pour traiter un tick de croissance du jardin
function processGardenTick() {
    if (!gameState.research || !gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const now = Date.now();
    
    // 1. Faire pousser les plantes existantes (v√©rifier croissance)
    grid.forEach(slot => {
        if (!slot.unlocked || !slot.content || slot.content.type !== 'plant') return;
        
        const plant = slot.content;
        const plantData = PLANT_TYPES[plant.id];
        if (!plantData) return;
        
        const growthTime = now - (plant.growthStart || now);
        const neighbors = getGardenNeighbors(slot.row, slot.col, grid);
        
        // Bonus de croissance si Pok√©mon Eau adjacent
        let growthBonus = 1.0;
        neighbors.forEach(neighbor => {
            if (neighbor && neighbor.content && neighbor.content.type === 'pokemon') {
                const pokemonTypes = POKEMON_TYPES[neighbor.content.id] || [];
                if (pokemonTypes.includes('Eau')) {
                    growthBonus *= 1.2; // +20% vitesse de croissance
                }
            }
        });
        
        const adjustedGrowthTime = plantData.growthTime / growthBonus;
        
        // Si la plante est mature, elle produit d√©j√† (g√©r√© dans calculateGardenProduction)
        // Ici on v√©rifie juste si elle peut √™tre r√©colt√©e
    });
    
    // 2. Mutation : V√©rifier les cases vides pour mutations
    grid.forEach(slot => {
        if (!slot.unlocked || slot.content !== null) return; // Case occup√©e ou verrouill√©e
        
        const neighbors = getGardenNeighbors(slot.row, slot.col, grid);
        const neighborPlants = neighbors
            .filter(n => n && n.content && n.content.type === 'plant')
            .map(n => n.content.id);
        
        // V√©rifier les r√®gles de mutation
        Object.entries(PLANT_MUTATION_RULES).forEach(([mutatedPlantId, rule]) => {
            const hasAllRequired = rule.required.every(requiredPlant => 
                neighborPlants.includes(requiredPlant)
            );
            
            if (hasAllRequired) {
                // Calculer la chance de mutation avec les upgrades de Prestige
                let mutationChance = rule.chance;
                
                // Bonus de mutation depuis les upgrades de Prestige
                if (gameState.research.prestigeUpgrades?.mutation_boost) {
                    const boostLevel = gameState.research.prestigeUpgrades.mutation_boost;
                    const boostUpgrade = PRESTIGE_UPGRADES.mutation_boost;
                    if (boostUpgrade) {
                        const effect = boostUpgrade.effect(boostLevel);
                        if (effect.type === 'mutation_chance') {
                            mutationChance *= effect.value;
                        }
                    }
                }
                
                if (Math.random() < mutationChance) {
                    // Mutation r√©ussie !
                    slot.content = {
                        type: 'plant',
                        id: mutatedPlantId,
                        growthStart: now,
                        isMutation: true
                    };
                    
                    showToast(`üå± Mutation ! ${PLANT_TYPES[mutatedPlantId].name} a pouss√© !`, 'success');
                    saveGame();
                    renderGardenGrid(); // Rafra√Æchir l'affichage
                }
            }
        });
    });
    
    // 3. Synergie Insecte : V√©rifier si un Pok√©mon Insecte mange une baie
    grid.forEach(slot => {
        if (!slot.unlocked || !slot.content || slot.content.type !== 'plant') return;
        
        const neighbors = getGardenNeighbors(slot.row, slot.col, grid);
        neighbors.forEach(neighbor => {
            if (neighbor && neighbor.content && neighbor.content.type === 'pokemon') {
                const pokemonTypes = POKEMON_TYPES[neighbor.content.id] || [];
                if (pokemonTypes.includes('Insecte')) {
                    // 1% de chance que l'insecte mange la baie
                    if (Math.random() < 0.01) {
                        // La baie est mang√©e (dispara√Æt)
                        slot.content = null;
                        showToast(`üêõ Un Pok√©mon Insecte a mang√© la baie !`, 'info');
                        saveGame();
                        renderGardenGrid();
                    }
                }
            }
        });
    });
    
    lastGardenTick = now;
}

// Fonction pour d√©marrer le syst√®me de ticks du jardin
function startGardenTickSystem() {
    if (gardenTickInterval) return; // D√©j√† d√©marr√©
    
    // Traiter le tick imm√©diatement
    processGardenTick();
    
    // Puis toutes les 30 secondes
    gardenTickInterval = setInterval(() => {
        processGardenTick();
    }, GARDEN_TICK_INTERVAL);
}

// Fonction pour arr√™ter le syst√®me de ticks
function stopGardenTickSystem() {
    if (gardenTickInterval) {
        clearInterval(gardenTickInterval);
        gardenTickInterval = null;
    }
}

// ===== SYST√àME D'ANOMALIES (GLITCHS) - PHASE 2 =====

// Variable globale pour tracker le spawner d'anomalies
let anomalySpawnerInterval = null;
let activeAnomalyElement = null;

// Fonction pour calculer le multiplicateur d'une anomalie "Building Special"
function calculateBuildingSpecialMult(anomalyType) {
    if (anomalyType.id !== 'building_special') return 1;
    
    // Compter les Pok√©mon par type dans la grille
    if (!gameState.research.garden || !gameState.research.garden.grid) return 1;
    
    const typeCounts = {};
    gameState.research.garden.grid.forEach(slot => {
        if (slot.content && slot.content.type === 'pokemon') {
            const types = POKEMON_TYPES[slot.content.id] || [];
            types.forEach(type => {
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
        }
    });
    
    // Trouver le type le plus pr√©sent
    let maxCount = 0;
    Object.values(typeCounts).forEach(count => {
        if (count > maxCount) maxCount = count;
    });
    
    return 1 + (maxCount * 0.1);
}

// Fonction pour activer un effet d'anomalie
function activateAnomalyEffect(anomalyType) {
    if (!gameState.research.anomalies) {
        gameState.research.anomalies = { activeEffects: [], totalClicked: 0, glitchLevel: 0 };
    }
    
    const now = Date.now();
    let mult = anomalyType.mult || 1;
    
    // Calcul sp√©cial pour "Building Special"
    if (anomalyType.id === 'building_special') {
        mult = calculateBuildingSpecialMult(anomalyType);
    }
    
    const effect = {
        id: anomalyType.id,
        name: anomalyType.name,
        value: mult,
        expires: now + anomalyType.duration,
        icon: anomalyType.icon
    };
    
    gameState.research.anomalies.activeEffects.push(effect);
    
    // Feedback visuel
    showToast(`${anomalyType.icon} ${anomalyType.name} activ√© ! ${anomalyType.desc}`, 'success');
    
    // Effet shake de l'√©cran
    triggerScreenShake(anomalyType.rarity === 'rare' ? 0.3 : 0.15);
    
    saveGame();
}

// Fonction pour d√©clencher un shake de l'√©cran
function triggerScreenShake(intensity = 0.2) {
    const researchPage = document.getElementById('research-page');
    if (!researchPage) return;
    
    const shakeAmount = intensity * 20; // pixels
    const shakeDuration = 500; // ms
    
    let startTime = Date.now();
    const originalTransform = researchPage.style.transform || '';
    
    function shake() {
        const elapsed = Date.now() - startTime;
        if (elapsed >= shakeDuration) {
            researchPage.style.transform = originalTransform;
            return;
        }
        
        const progress = elapsed / shakeDuration;
        const currentShake = shakeAmount * (1 - progress);
        const x = (Math.random() - 0.5) * currentShake;
        const y = (Math.random() - 0.5) * currentShake;
        
        researchPage.style.transform = `translate(${x}px, ${y}px)`;
        requestAnimationFrame(shake);
    }
    
    shake();
}

// Fonction pour cr√©er et afficher une anomalie visuelle
function spawnAnomalyVisual(anomalyType) {
    // Supprimer l'anomalie pr√©c√©dente si elle existe
    if (activeAnomalyElement) {
        activeAnomalyElement.remove();
        activeAnomalyElement = null;
    }
    
    const researchPage = document.getElementById('research-page');
    if (!researchPage) return;
    
    // Cr√©er l'√©l√©ment d'anomalie
    const anomalyDiv = document.createElement('div');
    anomalyDiv.className = 'data-anomaly glitch-effect';
    anomalyDiv.id = 'active-anomaly';
    
    // Position al√©atoire sur l'√©cran (mais visible)
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const left = Math.random() * (viewportWidth - 200) + 100;
    const top = Math.random() * (viewportHeight - 200) + 100;
    
    // Utiliser MissingNo ou Bad Egg pour les anomalies rares
    const isRare = anomalyType.rarity === 'rare';
    const spriteId = isRare ? 0 : 132; // MissingNo (0) pour rare, Bad Egg (132) pour commun
    
    anomalyDiv.innerHTML = `
        <div class="anomaly-content">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${spriteId}.png" 
                 alt="${anomalyType.name}" 
                 class="anomaly-sprite" />
            <div class="anomaly-info">
                <div class="anomaly-name">${anomalyType.icon} ${anomalyType.name}</div>
                <div class="anomaly-desc">${anomalyType.desc}</div>
                <div class="anomaly-timer" id="anomaly-timer">Cliquez !</div>
            </div>
        </div>
    `;
    
    anomalyDiv.style.cssText = `
        position: fixed;
        left: ${left}px;
        top: ${top}px;
        z-index: 9999;
        cursor: pointer;
        animation: anomalyFloat 3s ease-in-out infinite, anomalyGlitch 0.3s ease-in-out infinite;
        pointer-events: auto;
    `;
    
    // Ajouter les styles CSS si pas d√©j√† pr√©sents
    if (!document.getElementById('anomaly-styles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'anomaly-styles';
        styleSheet.textContent = `
            @keyframes anomalyFloat {
                0%, 100% { transform: translateY(0px) rotate(0deg); }
                50% { transform: translateY(-20px) rotate(5deg); }
            }
            @keyframes anomalyGlitch {
                0%, 100% { filter: hue-rotate(0deg) brightness(1); }
                25% { filter: hue-rotate(90deg) brightness(1.5); }
                50% { filter: hue-rotate(180deg) brightness(0.8); }
                75% { filter: hue-rotate(270deg) brightness(1.2); }
            }
            .data-anomaly {
                background: rgba(255, 0, 255, 0.2);
                border: 2px solid #ff00ff;
                border-radius: 15px;
                padding: 15px;
                backdrop-filter: blur(10px);
                box-shadow: 0 0 30px rgba(255, 0, 255, 0.6);
                /* Zone de clic √©largie pour mobile */
                padding: 20px;
                min-width: 120px;
                min-height: 120px;
            }
            .anomaly-content {
                display: flex;
                align-items: center;
                gap: 15px;
            }
            .anomaly-sprite {
                width: 64px;
                height: 64px;
                image-rendering: pixelated;
                filter: drop-shadow(0 0 10px #ff00ff);
            }
            .anomaly-info {
                color: white;
                font-family: 'VT323', monospace;
            }
            .anomaly-name {
                font-size: 1.5em;
                font-weight: bold;
                text-shadow: 0 0 10px #ff00ff;
                margin-bottom: 5px;
            }
            .anomaly-desc {
                font-size: 1em;
                opacity: 0.9;
                margin-bottom: 5px;
            }
            .anomaly-timer {
                font-size: 1.2em;
                color: #20d5d2;
                text-shadow: 0 0 10px #20d5d2;
            }
            .data-anomaly:hover {
                transform: scale(1.1) !important;
                box-shadow: 0 0 50px rgba(255, 0, 255, 1);
            }
        `;
        document.head.appendChild(styleSheet);
    }
    
    // Gestion du clic sur l'anomalie
    anomalyDiv.addEventListener('click', () => {
        activateAnomalyEffect(anomalyType);
        anomalyDiv.remove();
        activeAnomalyElement = null;
        
        // Effet de particules
        createParticleExplosion(left + 100, top + 100, anomalyType.icon);
    });
    
    document.body.appendChild(anomalyDiv);
    activeAnomalyElement = anomalyDiv;
    
    // Auto-disparition apr√®s 10 secondes si pas cliqu√©e
    setTimeout(() => {
        if (activeAnomalyElement === anomalyDiv) {
            anomalyDiv.style.animation = 'anomalyFloat 0.5s ease-out forwards';
            setTimeout(() => {
                if (anomalyDiv.parentNode) {
                    anomalyDiv.remove();
                    activeAnomalyElement = null;
                }
            }, 500);
        }
    }, 10000);
}

// Fonction pour cr√©er une explosion de particules
// OPTIMISATION : Limiter le nombre de particules simultan√©es pour √©viter la surcharge
let activeParticles = 0;
const MAX_PARTICLES = 50; // Limite globale de particules actives

function createParticleExplosion(x, y, icon = '‚ú®') {
    // OPTIMISATION : R√©duire le nombre de particules si d√©j√† beaucoup d'actives
    const particleCount = activeParticles > MAX_PARTICLES * 0.8 ? 10 : 20;
    
    // OPTIMISATION : Utiliser un pool de particules r√©utilisables si possible
    for (let i = 0; i < particleCount; i++) {
        if (activeParticles >= MAX_PARTICLES) break; // Limite stricte
        
        const particle = document.createElement('div');
        particle.textContent = icon;
        particle.style.cssText = `
            position: fixed;
            left: ${x}px;
            top: ${y}px;
            font-size: 1.5em;
            pointer-events: none;
            z-index: 10000;
            animation: particleExplode ${0.5 + Math.random() * 0.5}s ease-out forwards;
            will-change: transform, opacity;
        `;
        
        const angle = (Math.PI * 2 * i) / particleCount;
        const distance = 50 + Math.random() * 50;
        const finalX = x + Math.cos(angle) * distance;
        const finalY = y + Math.sin(angle) * distance;
        
        // Ajouter l'animation CSS si pas d√©j√† pr√©sente (une seule fois)
        if (!document.getElementById('particle-animation-styles')) {
            const styleSheet = document.createElement('style');
            styleSheet.id = 'particle-animation-styles';
            styleSheet.textContent = `
                @keyframes particleExplode {
                    to {
                        transform: translate(var(--tx, 0), var(--ty, 0)) scale(0);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(styleSheet);
        }
        
        // Utiliser CSS variables pour √©viter de cr√©er une animation par particule
        particle.style.setProperty('--tx', `${finalX - x}px`);
        particle.style.setProperty('--ty', `${finalY - y}px`);
        
        document.body.appendChild(particle);
        activeParticles++;
        
        setTimeout(() => {
            if (particle.parentNode) {
                particle.remove();
                activeParticles = Math.max(0, activeParticles - 1);
            }
        }, 1000);
    }
}

// Fonction pour d√©marrer le spawner d'anomalies
function startAnomalySpawner() {
    if (anomalySpawnerInterval) return; // D√©j√† d√©marr√©
    
    function spawnAnomaly() {
        if (!gameState.research || !gameState.research.unlocked) return;
        
        // V√©rifier si une anomalie est d√©j√† active visuellement
        if (activeAnomalyElement) return;
        
        // S√©lectionner un type d'anomalie selon les probabilit√©s
        const rand = Math.random();
        let selectedAnomaly = null;
        let cumulative = 0;
        
        Object.values(ANOMALY_TYPES).forEach(anomaly => {
            if (!selectedAnomaly) {
                cumulative += anomaly.spawnChance;
                if (rand <= cumulative) {
                    selectedAnomaly = anomaly;
                }
            }
        });
        
        if (selectedAnomaly) {
            spawnAnomalyVisual(selectedAnomaly);
        }
    }
    
    // Spawner initial apr√®s un d√©lai al√©atoire (60-180s)
    const initialDelay = 60000 + Math.random() * 120000; // 60-180 secondes
    setTimeout(() => {
        spawnAnomaly();
        
        // Puis spawner r√©guli√®rement toutes les 60-180 secondes
        anomalySpawnerInterval = setInterval(() => {
            spawnAnomaly();
        }, 60000 + Math.random() * 120000);
    }, initialDelay);
}

// Fonction pour arr√™ter le spawner d'anomalies
function stopAnomalySpawner() {
    if (anomalySpawnerInterval) {
        clearInterval(anomalySpawnerInterval);
        anomalySpawnerInterval = null;
    }
    if (activeAnomalyElement) {
        activeAnomalyElement.remove();
        activeAnomalyElement = null;
    }
}

// ===== CENTRE DE RECHERCHE (GDD V10.0) =====
window.clickCrystal = function() {
    if (!gameState.research.unlocked) return;
    
    // Incr√©menter le compteur de clics pour les anomalies
    if (!gameState.research.anomalies) {
        gameState.research.anomalies = { activeEffects: [], totalClicked: 0, glitchLevel: 0 };
    }
    gameState.research.anomalies.totalClicked++;
    
    const baseClick = 1;
    const collectionBonus = Math.max(1, Math.floor(gameState.totalCaught / 10));
    
    // Bonus Souris Optique (mouse_driver)
    const mouseDriverLevel = (gameState.research._legacy?.upgrades?.mouse_driver || gameState.research.upgrades?.mouse_driver || 0);
    const mouseDriverBonus = 1 + (mouseDriverLevel * 0.1);
    
    // Chance critique Anti-Virus (virus_scan)
    const virusScanLevel = (gameState.research._legacy?.upgrades?.virus_scan || gameState.research.upgrades?.virus_scan || 0);
    const critChance = virusScanLevel * 0.01;
    const isCrit = Math.random() < critChance;
    const critMultiplier = isCrit ? 2 : 1;
    
    // Multiplicateur des anomalies actives (STACKING multiplicatif)
    let anomalyClickMult = 1;
    const nowTime = Date.now();
    if (gameState.research.anomalies && gameState.research.anomalies.activeEffects) {
        gameState.research.anomalies.activeEffects.forEach(effect => {
            if (effect.expires > nowTime) {
                // Seulement les anomalies qui affectent les clics
                if (effect.id === 'click_frenzy' || effect.id === 'chain') {
                    anomalyClickMult *= effect.value;
                }
            }
        });
    }
    
    const clickGain = baseClick * collectionBonus * gameState.research.clickMultiplier * mouseDriverBonus * critMultiplier * anomalyClickMult;
    
    // GENESIS REBOOT - Bonus coins par clic du Deck TCG
    const tcgMultipliers = getTCGDeckMultipliers();
    if (tcgMultipliers.clickCoins > 1) {
        const coinsEarned = Math.floor(clickGain * (tcgMultipliers.clickCoins - 1));
        if (coinsEarned > 0) {
            gameState.coins += coinsEarned;
        }
    }
    
    gameState.research.energy += clickGain;
    gameState.research.totalEnergyProduced += gain;
    
    // Mettre √† jour l'√©nergie produite en 24h
    if (!gameState.research.energy24hResetTime) {
        gameState.research.energy24hResetTime = Date.now();
        gameState.research.energy24h = 0;
    }
    
    // R√©initialiser si 24h sont pass√©es
    const now = Date.now();
    const timeSinceReset = now - gameState.research.energy24hResetTime;
    if (timeSinceReset >= 24 * 60 * 60 * 1000) {
        gameState.research.energy24h = 0;
        gameState.research.energy24hResetTime = now;
    }
    
    gameState.research.energy24h += gain;
    
    updateResearchUI();
    saveGame();
    
    // AJOUT: D√©clencher l'animation 3D
    if (typeof Genesis3D !== 'undefined') {
        Genesis3D.triggerClickAnimation();
    }
    
    // Effet visuel sur le Noyau Genesis (fallback pour compatibilit√©)
    const genesisCore = document.getElementById('genesis-core');
    if (genesisCore) {
        genesisCore.style.transform = 'scale(0.9)';
        genesisCore.style.filter = isCrit ? 
            'brightness(2) drop-shadow(0 0 40px #ffd700)' : 
            'brightness(1.5) drop-shadow(0 0 30px #a855f7)';
        setTimeout(() => {
            genesisCore.style.transform = 'scale(1)';
            genesisCore.style.filter = 'drop-shadow(0 0 20px #a855f7)';
        }, 150);
        
        // Feedback visuel flottant "+X EO"
        showFloatingEOGain(gain, genesisCore);
    } else {
        // Si le conteneur 3D existe, utiliser celui-ci pour le feedback flottant
        const container3D = document.getElementById('genesis-3d-container');
        if (container3D) {
            showFloatingEOGain(gain, container3D);
        }
    }
    
    if (isCrit) {
        showToast(`üí• CRITIQUE ! +${Math.floor(gain).toLocaleString()} EO`, 'success');
    }
}

// Fonction pour afficher un feedback visuel flottant "+X EO"
// OPTIMISATION : Limiter le nombre de textes flottants simultan√©s
let activeFloatingTexts = 0;
const MAX_FLOATING_TEXTS = 10;

function showFloatingEOGain(amount, element, isPassive = false) {
    if (!element) return;
    
    // OPTIMISATION : Ne pas cr√©er de texte flottant si trop d'actifs (√©vite la surcharge visuelle)
    if (activeFloatingTexts >= MAX_FLOATING_TEXTS && isPassive) {
        return; // Ignorer les textes passifs si trop d'actifs
    }
    
    const floatingText = document.createElement('div');
    floatingText.textContent = `+${Math.floor(amount).toLocaleString()} EO`;
    floatingText.style.cssText = `
        position: fixed;
        color: ${isPassive ? '#a855f7' : '#20d5d2'};
        font-size: ${isPassive ? '1.2em' : '1.5em'};
        font-weight: bold;
        text-shadow: 0 0 10px rgba(${isPassive ? '168, 85, 247' : '32, 213, 210'}, 0.8), 0 0 20px rgba(${isPassive ? '168, 85, 247' : '32, 213, 210'}, 0.5);
        pointer-events: none;
        z-index: 1000;
        animation: floatEO 2s ease-out forwards;
        font-family: 'VT323', monospace;
        opacity: ${isPassive ? '0.8' : '1'};
        will-change: transform, opacity;
    `;
    
    // Positionner par rapport √† l'√©l√©ment
    const rect = element.getBoundingClientRect();
    floatingText.style.left = (rect.left + rect.width / 2) + 'px';
    floatingText.style.top = (rect.top + rect.height / 2) + 'px';
    floatingText.style.transform = 'translate(-50%, -50%)';
    
    document.body.appendChild(floatingText);
    activeFloatingTexts++;
    
    // Supprimer apr√®s l'animation
    setTimeout(() => {
        if (floatingText.parentNode) {
            floatingText.remove();
            activeFloatingTexts = Math.max(0, activeFloatingTexts - 1);
        }
    }, 2000);
}

// Variable pour tracker la derni√®re production passive (pour √©viter trop de feedbacks)
let lastPassiveProduction = 0;
let passiveProductionAccumulator = 0;

// Fonction pour appliquer la production passive avec feedback visuel
function applyPassiveProduction() {
    if (!gameState.research || !gameState.research.unlocked) return;
    
    const production = calculateProduction();
    if (production <= 0) return;
    
    gameState.research.energy += production;
    gameState.research.totalEnergyProduced += production;
    gameState.research.lastSaveTime = Date.now();
    
    // Mettre √† jour l'√©nergie produite en 24h
    if (!gameState.research.energy24hResetTime) {
        gameState.research.energy24hResetTime = Date.now();
        gameState.research.energy24h = 0;
    }
    
    const now = Date.now();
    const timeSinceReset = now - gameState.research.energy24hResetTime;
    if (timeSinceReset >= 24 * 60 * 60 * 1000) {
        gameState.research.energy24h = 0;
        gameState.research.energy24hResetTime = now;
    }
    
    gameState.research.energy24h += production;
    
    // Feedback visuel pour la production passive (toutes les 5 secondes ou si production > 100)
    const page = document.getElementById('research-page');
    if (page && page.classList.contains('active')) {
        passiveProductionAccumulator += production;
        
        // Afficher un feedback toutes les 5 secondes ou si la production accumul√©e d√©passe 100
        if (passiveProductionAccumulator >= 100 || (Date.now() - (lastPassiveProduction || 0)) >= 5000) {
            const eoDisplay = document.getElementById('eo-display');
            if (eoDisplay) {
                showFloatingEOGain(passiveProductionAccumulator, eoDisplay, true);
            }
            passiveProductionAccumulator = 0;
            lastPassiveProduction = Date.now();
        }
    }
    
    updateResearchUI();
}

// ===== LEADERBOARD SYSTEM =====
function calculateCollectionValue() {
    // Calculer la valeur totale des Pok√©mon assign√©s dans le Centre de Recherche
    let totalValue = 0;
    
    if (!gameState.research || !gameState.research.habitats) return 0;
    
    for (const [habitatId, habitat] of Object.entries(gameState.research.habitats)) {
        if (!habitat.unlocked) continue;
        
        habitat.assigned.forEach(pokeUid => {
            const pokeId = typeof pokeUid === 'string' ? parseInt(pokeUid.split('_')[0]) : pokeUid;
            const isShiny = typeof pokeUid === 'string' && pokeUid.includes('_');
            
            const rarity = getRarity(pokeId);
            const rarityValue = {
                'common': 1,
                'uncommon': 3,
                'rare': 8,
                'super_rare': 20,
                'legendary': 100
            }[rarity] || 1;
            
            // Shiny = x5 valeur
            const value = rarityValue * (isShiny ? 5 : 1);
            totalValue += value;
        });
    }
    
    return totalValue;
}

async function updateLeaderboardScores() {
    if (!window.SupabaseManager || !window.SupabaseManager.isLoggedIn()) return;
    
    try {
        // Utiliser le client SupabaseManager existant pour √©viter de cr√©er de nouveaux clients
        const supabase = window.SupabaseManager.getSupabaseClient();
        if (!supabase) return;
        
        const user = window.SupabaseManager.getUser();
        if (!user) return;
        
        // 1. Top PDG : √ânergie Onirique produite en 24h
        // R√©initialiser si 24h sont pass√©es
        if (gameState.research?.energy24hResetTime) {
            const now = Date.now();
            const timeSinceReset = now - gameState.research.energy24hResetTime;
            if (timeSinceReset >= 24 * 60 * 60 * 1000) {
                gameState.research.energy24h = 0;
                gameState.research.energy24hResetTime = now;
            }
        }
        const last24hEnergy = gameState.research?.energy24h || 0;
        
        // 2. Top Collectionneur : Valeur totale des Pok√©mon dans le Centre
        const collectionValue = calculateCollectionValue();
        
        // 3. Top Strat√®ge : Plus grosse main Poker
        const bestHandScore = gameState.poker?.best_single_hand_score || 0;
        
        // Nom du joueur
        const trainerName = gameState.customization?.trainerName || `Dresseur Niveau ${gameState.level}`;
        
        // Mettre √† jour ou ins√©rer dans la table leaderboard
        const { error } = await supabase.from('leaderboard').upsert({
            user_id: user.id,
            trainer_name: trainerName,
            top_pdg_24h: last24hEnergy,
            top_collectionneur: collectionValue,
            top_strategie: bestHandScore,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id' });
        
        if (error) {
            console.error('Erreur mise √† jour leaderboard:', error);
        } else {
            console.log('‚úÖ Leaderboard mis √† jour');
        }
    } catch (err) {
        console.error('Erreur leaderboard:', err);
    }
}

// Client Supabase partag√© pour le leaderboard (√©vite de cr√©er plusieurs instances)
let leaderboardSupabaseClient = null;

function getLeaderboardSupabaseClient() {
    if (typeof window.supabase === 'undefined') return null;
    
    if (!leaderboardSupabaseClient) {
        leaderboardSupabaseClient = window.supabase.createClient(
            'https://yokqhuqvtuxpfpgapbhy.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlva3FodXF2dHV4cGZwZ2FwYmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MzE2MjAsImV4cCI6MjA3OTQwNzYyMH0.M73eM4M66ibX-GHmhZtAZOci6uYMJ3MggsfGhOQ3eRU',
            {
                auth: {
                    persistSession: false, // Ne pas persister la session pour √©viter les d√©clenchements
                    autoRefreshToken: false // D√©sactiver le refresh automatique
                }
            }
        );
    }
    
    return leaderboardSupabaseClient;
}

async function fetchLeaderboard(type = 'pdg') {
    const supabase = getLeaderboardSupabaseClient();
    if (!supabase) return [];
    
    try {
        let orderBy = 'top_pdg_24h';
        if (type === 'collectionneur') orderBy = 'top_collectionneur';
        if (type === 'strategie') orderBy = 'top_strategie';
        
        const { data, error } = await supabase
            .from('leaderboard')
            .select('trainer_name, top_pdg_24h, top_collectionneur, top_strategie')
            .order(orderBy, { ascending: false })
            .limit(10);
        
        if (error) {
            console.error('Erreur r√©cup√©ration leaderboard:', error);
            return [];
        }
        
        return data || [];
    } catch (err) {
        console.error('Erreur fetch leaderboard:', err);
        return [];
    }
}

window.renderLeaderboard = async function(type = 'pdg') {
    const page = document.getElementById('leaderboard-page');
    if (!page) return;
    
    // GENESIS REBOOT - Explication narrative du Leaderboard (premi√®re fois)
    if (!gameState.system.narrativeFlags.includes('leaderboard_explained_shown')) {
        gameState.system.narrativeFlags.push('leaderboard_explained_shown');
        setTimeout(() => triggerNarrative('leaderboard_explained'), 1000);
    }
    
    const leaderboard = await fetchLeaderboard(type);
    
    const titles = {
        'pdg': { icon: 'üíº', name: 'Top PDG', desc: '√ânergie Onirique produite en 24h', field: 'top_pdg_24h', format: (v) => Math.floor(v).toLocaleString() + ' EO' },
        'collectionneur': { icon: 'üéØ', name: 'Top Collectionneur', desc: 'Valeur totale des Pok√©mon dans le Centre', field: 'top_collectionneur', format: (v) => Math.floor(v).toLocaleString() + ' pts' },
        'strategie': { icon: '‚ô†Ô∏è', name: 'Top Strat√®ge', desc: 'Plus grosse main unique (score Balatro)', field: 'top_strategie', format: (v) => Math.floor(v).toLocaleString() }
    };
    
    const currentTitle = titles[type] || titles.pdg;
    
    page.innerHTML = `
        <div class="container">
            <h1 style="color: white; text-align: center; margin-bottom: 30px; font-size: 2em;">
                ${currentTitle.icon} ${currentTitle.name}
            </h1>
            <p style="color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 30px;">
                ${currentTitle.desc}
            </p>
            
            <!-- Onglets -->
            <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #333;">
                <button onclick="renderLeaderboard('pdg')" class="leaderboard-tab ${type === 'pdg' ? 'active' : ''}" style="flex: 1; padding: 12px; background: ${type === 'pdg' ? 'rgba(168, 85, 247, 0.3)' : 'rgba(30, 30, 50, 0.5)'}; border: none; border-bottom: 3px solid ${type === 'pdg' ? '#a855f7' : 'transparent'}; color: ${type === 'pdg' ? 'white' : 'rgba(255,255,255,0.6)'}; cursor: pointer; font-weight: ${type === 'pdg' ? 'bold' : 'normal'};">
                    üíº PDG
                </button>
                <button onclick="renderLeaderboard('collectionneur')" class="leaderboard-tab ${type === 'collectionneur' ? 'active' : ''}" style="flex: 1; padding: 12px; background: ${type === 'collectionneur' ? 'rgba(168, 85, 247, 0.3)' : 'rgba(30, 30, 50, 0.5)'}; border: none; border-bottom: 3px solid ${type === 'collectionneur' ? '#a855f7' : 'transparent'}; color: ${type === 'collectionneur' ? 'white' : 'rgba(255,255,255,0.6)'}; cursor: pointer; font-weight: ${type === 'collectionneur' ? 'bold' : 'normal'};">
                    üéØ Collectionneur
                </button>
                <button onclick="renderLeaderboard('strategie')" class="leaderboard-tab ${type === 'strategie' ? 'active' : ''}" style="flex: 1; padding: 12px; background: ${type === 'strategie' ? 'rgba(168, 85, 247, 0.3)' : 'rgba(30, 30, 50, 0.5)'}; border: none; border-bottom: 3px solid ${type === 'strategie' ? '#a855f7' : 'transparent'}; color: ${type === 'strategie' ? 'white' : 'rgba(255,255,255,0.6)'}; cursor: pointer; font-weight: ${type === 'strategie' ? 'bold' : 'normal'};">
                    ‚ô†Ô∏è Strat√®ge
                </button>
            </div>
            
            <!-- Classement -->
            <div style="background: rgba(20, 20, 35, 0.8); border: 2px solid #7d5fff; border-radius: 12px; padding: 20px;">
                ${leaderboard.length === 0 ? `
                    <p style="color: rgba(255,255,255,0.6); text-align: center; padding: 40px;">
                        Aucun classement disponible pour le moment.
                    </p>
                ` : leaderboard.map((entry, index) => {
                    const rank = index + 1;
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                    const value = entry[currentTitle.field] || 0;
                    
                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; margin-bottom: 10px; background: ${rank <= 3 ? 'rgba(168, 85, 247, 0.2)' : 'rgba(30, 30, 50, 0.3)'}; border-radius: 10px; border: ${rank <= 3 ? '2px solid #a855f7' : '1px solid rgba(255,255,255,0.1)'};">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 1.5em; font-weight: bold; min-width: 40px;">${medal}</span>
                                <div>
                                    <div style="color: white; font-weight: bold; font-size: 1.1em;">${entry.trainer_name || 'Dresseur'}</div>
                                    <div style="color: rgba(255,255,255,0.6); font-size: 0.9em;">${currentTitle.format(value)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <div style="text-align: center; margin-top: 20px; color: rgba(255,255,255,0.5); font-size: 0.9em;">
                Les classements sont mis √† jour automatiquement
            </div>
        </div>
    `;
};

// Fonction pour obtenir les voisins d'une case dans la grille
function getGardenNeighbors(row, col, grid) {
    const neighbors = [];
    const directions = [
        [-1, -1], [-1, 0], [-1, 1],
        [0, -1],           [0, 1],
        [1, -1],  [1, 0],  [1, 1]
    ];
    
    directions.forEach(([dr, dc]) => {
        const newRow = row + dr;
        const newCol = col + dc;
        if (newRow >= 0 && newRow < 6 && newCol >= 0 && newCol < 6) {
            const neighbor = grid.find(s => s.row === newRow && s.col === newCol);
            if (neighbor) neighbors.push(neighbor);
        }
    });
    
    return neighbors;
}

// Fonction pour rendre la grille du jardin avec interface de plantation
window.renderGardenGrid = function() {
    const container = document.getElementById('garden-grid-container');
    if (!container) return;
    
    if (!gameState.research || !gameState.research.garden || !gameState.research.garden.grid) {
        container.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">Jardin non initialis√©</div>';
        return;
    }
    
    const grid = gameState.research.garden.grid;
    const bankedSeeds = gameState.research.garden.bankedSeeds || [];
    const soilType = gameState.research.garden.soils || 'clay';
    const soilData = SOIL_TYPES[soilType];
    
    // Compter les graines disponibles
    const seedCounts = {};
    bankedSeeds.forEach(seedId => {
        seedCounts[seedId] = (seedCounts[seedId] || 0) + 1;
    });
    
    // Cr√©er la grille 6x6
    let gridHTML = '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-width: 600px; margin: 0 auto;">';
    
    grid.forEach(slot => {
        const isEmpty = !slot.content;
        const isPokemon = slot.content && slot.content.type === 'pokemon';
        const isPlant = slot.content && slot.content.type === 'plant';
        
        let slotHTML = '';
        let slotStyle = `
            aspect-ratio: 1;
            border: 2px solid ${slot.unlocked ? '#444' : '#222'};
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: ${slot.unlocked ? 'rgba(30, 30, 50, 0.8)' : 'rgba(10, 10, 20, 0.5)'};
            cursor: ${slot.unlocked && isEmpty ? 'pointer' : 'default'};
            position: relative;
            overflow: hidden;
        `;
        
        if (!slot.unlocked) {
            slotHTML = '<div style="color: #666; font-size: 0.8em;">üîí</div>';
        } else if (isPokemon) {
            const pokeId = slot.content.id;
            const isShiny = slot.content.isShiny;
            slotHTML = `
                <img src="${getAnimatedSpriteUrl(pokeId, isShiny)}" 
                     alt="${FRENCH_NAMES[pokeId]}" 
                     style="width: 100%; height: 100%; object-fit: contain; padding: 5px;"
                     oncontextmenu="event.preventDefault(); removePokemonFromGarden(${slot.row}, ${slot.col});">
                <div style="position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.7em;" 
                     onclick="removePokemonFromGarden(${slot.row}, ${slot.col})" 
                     title="Retirer">√ó</div>
            `;
        } else if (isPlant) {
            const plant = slot.content;
            const plantData = PLANT_TYPES[plant.id];
            if (plantData) {
                const growthTime = Date.now() - (plant.growthStart || Date.now());
                const progress = Math.min(1, growthTime / plantData.growthTime);
                const isMature = progress >= 1;
                
                slotHTML = `
                    <div style="text-align: center; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px;">
                        <div style="font-size: 2em;">${plantData.icon}</div>
                        <div style="font-size: 0.6em; color: rgba(255,255,255,0.7); margin-top: 5px;">${plantData.name}</div>
                        ${!isMature ? `
                            <div style="width: 90%; height: 4px; background: rgba(0,0,0,0.5); border-radius: 2px; margin-top: 5px; overflow: hidden;">
                                <div style="width: ${progress * 100}%; height: 100%; background: #10b981; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 0.5em; color: rgba(255,255,255,0.5); margin-top: 2px;">${Math.floor(progress * 100)}%</div>
                        ` : `
                            <div style="font-size: 0.5em; color: #10b981; margin-top: 5px; font-weight: bold;">‚úì Mature</div>
                        `}
                    </div>
                    <div style="position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.7em;" 
                         onclick="harvestPlant(${slot.row}, ${slot.col})" 
                         title="R√©colter">‚úì</div>
                `;
            }
        } else {
            // Case vide - proposer d'assigner un Pok√©mon ou planter une graine
            slotHTML = `
                <div style="display: flex; flex-direction: column; gap: 5px; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 5px;">
                    <div style="font-size: 1.5em; opacity: 0.5;">+</div>
                    <div style="font-size: 0.6em; color: rgba(255,255,255,0.5); text-align: center;">Cliquez</div>
                </div>
            `;
            slotStyle += `onclick="openGardenSlotMenu(${slot.row}, ${slot.col})"`;
        }
        
        gridHTML += `<div style="${slotStyle}">${slotHTML}</div>`;
    });
    
    gridHTML += '</div>';
    
    // Interface de plantation (bouton pour ouvrir le menu de graines)
    const seedsHTML = Object.entries(PLANT_TYPES).map(([plantId, plantData]) => {
        const count = seedCounts[plantId] || 0;
        return `
            <div style="
                background: rgba(30, 30, 50, 0.8);
                border: 2px solid ${count > 0 ? '#10b981' : '#444'};
                border-radius: 8px;
                padding: 10px;
                display: flex;
                align-items: center;
                gap: 10px;
                ${count > 0 ? 'cursor: pointer;' : 'opacity: 0.5;'}
            " 
            ${count > 0 ? `onclick="openPlantSeedMenu('${plantId}')"` : ''}
            onmouseover="${count > 0 ? "this.style.background='rgba(16, 185, 129, 0.2)'" : ''}"
            onmouseout="${count > 0 ? "this.style.background='rgba(30, 30, 50, 0.8)'" : ''}">
                <div style="font-size: 2em;">${plantData.icon}</div>
                <div style="flex: 1;">
                    <div style="color: white; font-weight: bold;">${plantData.name}</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 0.8em;">Production: ${plantData.production} EO</div>
                    <div style="color: rgba(255,255,255,0.6); font-size: 0.8em;">Temps: ${Math.floor(plantData.growthTime / 60000)} min</div>
                </div>
                <div style="color: ${count > 0 ? '#10b981' : '#666'}; font-weight: bold; font-size: 1.2em;">${count}</div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="color: #10b981; font-size: 1.5em; margin-bottom: 10px;">üåø Grille de Culture</h3>
            <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">
                Sol actuel: <span style="color: #10b981; font-weight: bold;">${soilData.name}</span> (√ó${soilData.mult.toFixed(1)} production)
            </div>
        </div>
        ${gridHTML}
        <div style="margin-top: 30px;">
            <h4 style="color: white; margin-bottom: 15px; text-align: center;">üå± Graines disponibles</h4>
            <div style="display: flex; flex-direction: column; gap: 10px; max-width: 600px; margin: 0 auto;">
                ${seedsHTML}
            </div>
            ${bankedSeeds.length === 0 ? `
                <div style="text-align: center; color: rgba(255,255,255,0.5); margin-top: 20px; padding: 20px; background: rgba(30, 30, 50, 0.5); border-radius: 8px;">
                    üí° R√©coltez des plantes matures pour obtenir des graines !
                </div>
            ` : ''}
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="harvestMaturePlants()" class="btn btn--primary" style="padding: 10px 20px;">
                üåæ R√©colter toutes les plantes matures
            </button>
        </div>
    `;
};

// Fonction pour ouvrir le menu d'une case du jardin
window.openGardenSlotMenu = function(row, col) {
    const grid = gameState.research.garden.grid;
    const slot = grid.find(s => s.row === row && s.col === col);
    if (!slot || !slot.unlocked || slot.content !== null) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%;">
            <h2 style="color: white; margin-bottom: 20px;">Que voulez-vous faire ?</h2>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button onclick="openAssignGardenSlotModal(${row}, ${col}); this.closest('.modal').remove();" 
                        class="btn btn--primary" 
                        style="padding: 15px; font-size: 1.1em;">
                    üêæ Assigner un Pok√©mon
                </button>
                <button onclick="openPlantSeedMenu(null, ${row}, ${col}); this.closest('.modal').remove();" 
                        class="btn btn--outline" 
                        style="padding: 15px; font-size: 1.1em; border-color: #10b981; color: #10b981;">
                    üå± Planter une graine
                </button>
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn btn--outline" style="margin-top: 20px; width: 100%;">Annuler</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

// Fonction pour ouvrir le menu de plantation de graines
window.openPlantSeedMenu = function(plantId = null, row = null, col = null) {
    const bankedSeeds = gameState.research.garden.bankedSeeds || [];
    const seedCounts = {};
    bankedSeeds.forEach(seedId => {
        seedCounts[seedId] = (seedCounts[seedId] || 0) + 1;
    });
    
    const availableSeeds = Object.entries(PLANT_TYPES).filter(([id]) => (seedCounts[id] || 0) > 0);
    
    if (availableSeeds.length === 0) {
        showToast('Aucune graine disponible ! R√©coltez des plantes matures pour en obtenir.', 'info');
        return;
    }
    
    // Si plantId est fourni, planter directement
    if (plantId && row !== null && col !== null) {
        plantSeed(plantId, row, col);
        return;
    }
    
    // Sinon, ouvrir le menu de s√©lection
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: white; margin-bottom: 20px;">üå± S√©lectionner une graine √† planter</h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                ${availableSeeds.map(([id, plantData]) => `
                    <div onclick="
                        const modal = this.closest('.modal');
                        const row = parseInt(modal.dataset.row);
                        const col = parseInt(modal.dataset.col);
                        if (row !== null && col !== null) {
                            plantSeed('${id}', row, col);
                            modal.remove();
                        } else {
                            showToast('S√©lectionnez d\\'abord une case dans le jardin', 'info');
                        }
                    " 
                    style="
                        background: rgba(16, 185, 129, 0.2);
                        border: 2px solid #10b981;
                        border-radius: 12px;
                        padding: 15px;
                        cursor: pointer;
                        transition: all 0.2s;
                    "
                    onmouseover="this.style.background='rgba(16, 185, 129, 0.3)'; this.style.transform='scale(1.02)'"
                    onmouseout="this.style.background='rgba(16, 185, 129, 0.2)'; this.style.transform='scale(1)'">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2.5em;">${plantData.icon}</div>
                            <div style="flex: 1;">
                                <div style="color: white; font-weight: bold; font-size: 1.1em;">${plantData.name}</div>
                                <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Production: ${plantData.production} EO | Temps: ${Math.floor(plantData.growthTime / 60000)} min</div>
                            </div>
                            <div style="color: #10b981; font-weight: bold; font-size: 1.2em;">√ó${seedCounts[id]}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; margin-top: 20px; padding: 15px; background: rgba(30, 30, 50, 0.5); border-radius: 8px;">
                üí° Cliquez sur une graine, puis sur une case vide du jardin pour planter.
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn btn--outline" style="margin-top: 20px; width: 100%;">Annuler</button>
        </div>
    `;
    
    if (row !== null && col !== null) {
        modal.dataset.row = row;
        modal.dataset.col = col;
    }
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

// Fonction pour planter une graine
window.plantSeed = function(plantId, row, col) {
    if (!gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const slot = grid.find(s => s.row === row && s.col === col);
    
    if (!slot || !slot.unlocked || slot.content !== null) {
        showToast('Cette case n\'est pas disponible !', 'error');
        return;
    }
    
    const bankedSeeds = gameState.research.garden.bankedSeeds || [];
    const seedIndex = bankedSeeds.indexOf(plantId);
    
    if (seedIndex === -1) {
        showToast('Vous n\'avez pas cette graine !', 'error');
        return;
    }
    
    // Retirer la graine de la banque
    bankedSeeds.splice(seedIndex, 1);
    gameState.research.garden.bankedSeeds = bankedSeeds;
    
    // Planter la graine
    slot.content = {
        type: 'plant',
        id: plantId,
        growthStart: Date.now()
    };
    
    const plantData = PLANT_TYPES[plantId];
    showToast(`üå± ${plantData.name} plant√©e !`, 'success');
    
    saveGame();
    renderGardenGrid();
};

// Nouvelle fonction : Calcul de production depuis la grille (Jardin 2.0)
function calculateGardenProduction() {
    if (!gameState.research || !gameState.research.garden || !gameState.research.garden.grid) {
        // Fallback vers ancien syst√®me si pas encore migr√©
        return calculateLegacyProduction();
    }
    
    let totalProduction = 0;
    const grid = gameState.research.garden.grid;
    const soilMult = SOIL_TYPES[gameState.research.garden.soils]?.mult || 1.0;
    
    // Parcourir chaque case de la grille
    grid.forEach(slot => {
        if (!slot.unlocked || !slot.content || slot.content.type !== 'pokemon') return;
        
        const content = slot.content;
        const pokeId = content.id;
        const isShiny = content.isShiny || false;
        
        // R√©cup√©rer le niveau du Pok√©mon
        let pokemonLevel = 1;
        const buddyId = typeof pokeId === 'string' ? pokeId : pokeId;
        if (gameState.buddy && gameState.buddy.buddies[buddyId]) {
            pokemonLevel = gameState.buddy.buddies[buddyId].level || 1;
        } else {
            pokemonLevel = Math.max(1, Math.floor(gameState.level / 2));
        }
        
        const rarity = getRarity(pokeId);
        const baseStatsMap = {
            'common': 300,
            'uncommon': 360,
            'rare': 420,
            'super_rare': 480,
            'legendary': 600
        };
        const baseStats = baseStatsMap[rarity] || 300;
        
        // Formule de base CORRIG√âE (divis√© par 100 au lieu de 10 pour r√©duire la production)
        const basePPS = (baseStats / 100); // R√©duit de 10x pour √©quilibrer
        const levelMult = Math.max(1, pokemonLevel / 5); // R√©duit aussi le bonus de niveau
        const rarityMult = {
            'common': 1,
            'uncommon': 1.2,
            'rare': 1.5,
            'super_rare': 2.0,
            'legendary': 3.0
        }[rarity] || 1; // Multiplicateurs r√©duits
        
        const shinyBonus = isShiny ? 2 : 1; // R√©duit de 10 √† 2
        
        // GENESIS REBOOT - Syst√®me de Synergies Avanc√© (Partie 2)
        let neighborBonus = 1;
        let lineBonus = 1; // Bonus pour toute la ligne (√âlectrik + Eau)
        const neighbors = getGardenNeighbors(slot.row, slot.col, grid);
        const pokemonTypesForSynergy = POKEMON_TYPES[pokeId] || [];
        
        neighbors.forEach(neighbor => {
            if (neighbor && neighbor.content) {
                // Synergie Pok√©mon-Plante
                if (neighbor.content.type === 'plant') {
                    if (pokemonTypesForSynergy.includes('Eau')) {
                        neighborBonus *= 1.1;
                    }
                }
                
                // Synergie Pok√©mon-Pok√©mon
                if (neighbor.content.type === 'pokemon') {
                    const neighborId = neighbor.content.id;
                    const neighborTypes = POKEMON_TYPES[neighborId] || [];
                    
                    // Synergie Feu + Plante (Bonus instantan√© mais fatigue)
                    if (pokemonTypesForSynergy.includes('Feu') && neighborTypes.includes('Plante')) {
                        neighborBonus *= 1.3; // +30% bonus
                        // Note: Le syst√®me de fatigue/cooldown sera ajout√© dans une future version
                    }
                    
                    // Synergie √âlectrik + Eau (Boost de ligne)
                    if (pokemonTypesForSynergy.includes('√âlectrik') && neighborTypes.includes('Eau')) {
                        lineBonus *= 1.2; // +20% pour toute la ligne
                    }
                    
                    // Duo √âvolutif (ex: Pikachu + Raichu)
                    const evolutionPairs = [
                        [25, 26], // Pikachu -> Raichu
                        [133, 134], [133, 135], [133, 136], // √âvoli -> Aquali/Voltali/Pyroli
                        [1, 2], [2, 3], // Bulbizarre -> Herbizarre -> Florizarre
                        [4, 5], [5, 6], // Salam√®che -> Reptincel -> Dracaufeu
                        [7, 8], [8, 9]  // Carapuce -> Carabaffe -> Tortank
                    ];
                    
                    const isEvolutionPair = evolutionPairs.some(pair => 
                        (pair[0] === pokeId && pair[1] === neighborId) ||
                        (pair[1] === pokeId && pair[0] === neighborId)
                    );
                    
                    if (isEvolutionPair) {
                        neighborBonus *= 1.5; // Synergie x1.5 pour duo √©volutif
                    }
                }
            }
        });
        
        // Appliquer le bonus de ligne (√âlectrik + Eau)
        if (lineBonus > 1) {
            // Trouver tous les Pok√©mon de la m√™me ligne
            const sameRowSlots = grid.filter(s => s.row === slot.row && s.unlocked && s.content && s.content.type === 'pokemon');
            if (sameRowSlots.length > 1) {
                // Le bonus s'applique √† toute la ligne
                neighborBonus *= lineBonus;
            }
        }
        
        // Bonus GPU Overclock (si upgrade existe encore)
        const gpuLevel = (gameState.research._legacy?.upgrades?.gpu_overclock || 0);
        const gpuBonus = 1 + (gpuLevel * 0.02); // R√©duit de 0.05 √† 0.02
        
        // Production de base
        let production = basePPS * rarityMult * levelMult * shinyBonus * neighborBonus * soilMult * gpuBonus;
        
        // GENESIS REBOOT - Appliquer les multiplicateurs du Deck Actif TCG
        const tcgMultipliers = getTCGDeckMultipliers();
        
        // Bonus par type
        if (pokemonTypesForSynergy.includes('Feu')) {
            production *= tcgMultipliers.fire;
        }
        if (pokemonTypesForSynergy.includes('Eau')) {
            production *= tcgMultipliers.water;
        }
        if (pokemonTypesForSynergy.includes('Plante')) {
            production *= tcgMultipliers.grass;
        }
        if (pokemonTypesForSynergy.includes('√âlectrik')) {
            production *= tcgMultipliers.electric;
        }
        
        // Bonus global de production
        production *= tcgMultipliers.production;
        
        // Appliquer les effets du Tech Tree
        if (gameState.research.techTree && gameState.research.techTree.unlockedNodes) {
            gameState.research.techTree.unlockedNodes.forEach(nodeId => {
                const node = TECH_TREE_DB[nodeId];
                if (node && node.effect) {
                    const effect = node.effect(grid);
                    if (effect.type === 'neighbor_boost') {
                        // V√©rifier si ce Pok√©mon b√©n√©ficie du boost
                        const pokemonTypes = POKEMON_TYPES[pokeId] || [];
                        const typeMap = { 'Plante': 'Grass', 'Insecte': 'Bug' };
                        if (pokemonTypes.some(t => typeMap[t] === effect.target)) {
                            production *= effect.value;
                        }
                    } else if (effect.type === 'global_mult') {
                        production *= effect.value;
                    }
                }
            });
        }
        
        totalProduction += production;
    });
    
    // Ajouter la production des plantes matures
    grid.forEach(slot => {
        if (!slot.unlocked || !slot.content || slot.content.type !== 'plant') return;
        
        const plant = slot.content;
        const plantData = PLANT_TYPES[plant.id];
        if (!plantData) return;
        
        const growthTime = Date.now() - (plant.growthStart || Date.now());
        if (growthTime >= plantData.growthTime) {
            // Plante mature : production passive
            totalProduction += plantData.production * soilMult;
        }
    });
    
    return totalProduction;
}

// Fonction de fallback pour l'ancien syst√®me (compatibilit√©)
function calculateLegacyProduction() {
    if (!gameState.research.habitats) return 0;
    
    let totalProduction = 0;
    const automationBonus = 1 + ((gameState.research._legacy?.automationLevel || gameState.research.automationLevel || 0) * 0.1);
    
    for (const [habitatId, habitat] of Object.entries(gameState.research.habitats)) {
        if (!habitat.unlocked) continue;
        
        habitat.assigned.forEach(pokeUid => {
            const pokeId = typeof pokeUid === 'string' ? parseInt(pokeUid.split('_')[0]) : pokeUid;
            const isShiny = typeof pokeUid === 'string' && pokeUid.includes('_');
            
            let pokemonLevel = 1;
            const buddyId = typeof pokeUid === 'string' ? pokeUid : pokeUid;
            if (gameState.buddy && gameState.buddy.buddies[buddyId]) {
                pokemonLevel = gameState.buddy.buddies[buddyId].level || 1;
            } else {
                pokemonLevel = Math.max(1, Math.floor(gameState.level / 2));
            }
            
            const rarity = getRarity(pokeId);
            const baseStatsMap = {
                'common': 300,
                'uncommon': 360,
                'rare': 420,
                'super_rare': 480,
                'legendary': 600
            };
            const baseStats = baseStatsMap[rarity] || 300;
            
            // Formule CORRIG√âE (coh√©rente avec le nouveau syst√®me)
            const basePPS = (baseStats / 100); // R√©duit de 10x
            const levelMult = Math.max(1, pokemonLevel / 5); // R√©duit
            const rarityMult = {
                'common': 1,
                'uncommon': 1.2,
                'rare': 1.5,
                'super_rare': 2.0,
                'legendary': 3.0
            }[rarity] || 1; // Multiplicateurs r√©duits
            
            const types = POKEMON_TYPES[pokeId] || [];
            const typeMatch = types.some(t => {
                const typeMap = {
                    'Plante': 'Grass', 'Eau': 'Water', 'Roche': 'Rock',
                    'Feu': 'Fire', '√âlectrik': 'Electric', 'Spectre': 'Ghost'
                };
                return typeMap[t] === habitat.type;
            });
            
            const typeBonus = typeMatch ? 1.5 : 0.8; // R√©duit de 2/0.5 √† 1.5/0.8
            const shinyBonus = isShiny ? 2 : 1; // R√©duit de 10 √† 2
            
            const gpuLevel = (gameState.research._legacy?.upgrades?.gpu_overclock || gameState.research.upgrades?.gpu_overclock || 0);
            const gpuBonus = 1 + (gpuLevel * 0.02); // R√©duit de 0.05 √† 0.02
            
            let mascotteBonus = 1;
            if (habitat.mascotte && gameState.tcg && gameState.tcg.cards[habitat.mascotte]) {
                const card = gameState.tcg.cards[habitat.mascotte];
                const cardTypes = POKEMON_TYPES[card.pokemonId] || [];
                const typeMap = {
                    'Plante': 'Grass', 'Eau': 'Water', 'Roche': 'Rock',
                    'Feu': 'Fire', '√âlectrik': 'Electric', 'Spectre': 'Ghost'
                };
                const cardMatchesHabitat = cardTypes.some(t => typeMap[t] === habitat.type);
                
                if (cardMatchesHabitat) {
                    // Bonus r√©duits pour les cartes TCG
                    mascotteBonus = {
                        'common': 1.2,
                        'uncommon': 1.3,
                        'rare': 1.5,
                        'super_rare': 1.8,
                        'legendary': 2.0
                    }[card.rarity] || 1;
                }
            }
            
            const production = basePPS * rarityMult * levelMult * typeBonus * shinyBonus * automationBonus * gpuBonus * mascotteBonus;
            totalProduction += production;
        });
    }
    
    return totalProduction;
}

// Nouvelle fonction calculateProduction avec support des anomalies (V2.0)
function calculateProduction() {
    // 1. Calcul de base depuis la grille (Jardin)
    let rawProduction = calculateGardenProduction();
    
    // 2. Multiplicateurs Permanents (Tech Tree + Prestige)
    let permanentMult = gameState.research.passiveMultiplier || 1;
    
    // Appliquer les upgrades de Prestige
    if (gameState.research.prestigeUpgrades) {
        Object.entries(gameState.research.prestigeUpgrades).forEach(([upgradeId, level]) => {
            if (level > 0) {
                const upgrade = PRESTIGE_UPGRADES[upgradeId];
                if (upgrade) {
                    const effect = upgrade.effect(level);
                    if (effect.type === 'global_mult') {
                        permanentMult *= effect.value;
                    } else if (effect.type === 'passive_mult') {
                        permanentMult *= effect.value;
                    }
                }
            }
        });
    }
    
    // 3. Multiplicateurs Temporaires (Anomalies) - STACKING multiplicatif
    let tempMult = 1;
    const now = Date.now();
    
    if (gameState.research.anomalies && gameState.research.anomalies.activeEffects) {
        gameState.research.anomalies.activeEffects.forEach(effect => {
            if (effect.expires > now) {
                tempMult *= (effect.value || 1); // Stacking multiplicatif ! (ex: 7 * 777)
            }
        });
        
        // Nettoyer les effets expir√©s
        gameState.research.anomalies.activeEffects = gameState.research.anomalies.activeEffects.filter(e => e.expires > now);
    }
    
    return rawProduction * permanentMult * tempMult;
}

function updateResearchUI() {
    const page = document.getElementById('research-page');
    if (!page || !page.classList.contains('active')) return;
    
    const eoDisplay = document.getElementById('eo-display');
    if (eoDisplay) eoDisplay.textContent = Math.floor(gameState.research.energy).toLocaleString();
    
    const eoPerSec = document.getElementById('eo-per-sec');
    if (eoPerSec) {
        const production = calculateProduction();
        eoPerSec.textContent = production.toFixed(1);
    }
    
    const processorChipsDisplay = document.getElementById('processor-chips-display');
    if (processorChipsDisplay) {
        processorChipsDisplay.textContent = gameState.inventory.processor_chips || 0;
    }
    
    renderHabitats();
    
    // V√©rifier les triggers narratifs pour les habitats
    const hasLockedHabitats = Object.values(gameState.research?.habitats || {}).some(h => !h.unlocked);
    if (hasLockedHabitats && !gameState.narrative.history.includes('blueprints_explanation')) {
        setTimeout(() => {
            startDialogue('blueprints_explanation');
        }, 1000);
    }
}

function renderHabitats() {
    const container = document.getElementById('habitats-list');
    if (!container) return;
    
    // Utiliser le nouveau syst√®me de grille si disponible
    if (gameState.research.garden && gameState.research.garden.grid) {
        renderGardenGrid();
        return;
    }
    
    // Sinon, utiliser l'ancien syst√®me d'habitats
    container.innerHTML = '';
    
    for (const [id, habitat] of Object.entries(gameState.research.habitats)) {
        const card = document.createElement('div');
        card.className = `habitat-card ${habitat.unlocked ? 'unlocked' : 'locked'}`;
        
        const typeColors = {
            'Grass': 'linear-gradient(135deg, #15803d, #14532d)',
            'Water': 'linear-gradient(135deg, #1e40af, #1e3a8a)',
            'Rock': 'linear-gradient(135deg, #854d0e, #451a03)',
            'Fire': 'linear-gradient(135deg, #b91c1c, #7f1d1d)',
            'Electric': 'linear-gradient(135deg, #a16207, #713f12)',
            'Ghost': 'linear-gradient(135deg, #4338ca, #312e81)'
        };
        
        card.style.background = typeColors[habitat.type] || 'rgba(30, 30, 50, 0.8)';
        
        const slotsHTML = Array.from({length: habitat.slots}, (_, i) => {
            const assigned = habitat.assigned[i];
            if (assigned) {
                const pokeId = typeof assigned === 'string' ? parseInt(assigned.split('_')[0]) : assigned;
                const isShiny = typeof assigned === 'string' && assigned.includes('_');
                return `
                    <div class="slot filled" onclick="openAssignModal('${id}', ${i})">
                        <img src="${getAnimatedSpriteUrl(pokeId, isShiny)}" alt="${FRENCH_NAMES[pokeId]}">
                    </div>
                `;
            } else {
                return `<div class="slot" onclick="openAssignModal('${id}', ${i})">+</div>`;
            }
        }).join('');
        
        const upgradeCost = Math.floor(100 * Math.pow(1.5, habitat.level));
        const canUpgrade = gameState.research.energy >= upgradeCost;
        
        // V√©rifier si le blueprint est disponible pour d√©bloquer
        const blueprintKey = `blueprint_${id}`;
        const hasBlueprint = gameState.inventory[blueprintKey] > 0;
        const canUnlock = !habitat.unlocked && hasBlueprint;
        
        // Slot Mascotte TCG
        const mascotteCard = habitat.mascotte && gameState.tcg && gameState.tcg.cards[habitat.mascotte] ? gameState.tcg.cards[habitat.mascotte] : null;
        const mascotteHTML = `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.1);">
                <div style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 8px; font-weight: bold;">üé¥ Mascotte TCG</div>
                <div class="mascotte-slot" onclick="openMascotteModal('${id}')" style="width: 80px; height: 100px; border: 2px ${mascotteCard ? 'solid #FFD700' : 'dashed rgba(168, 85, 247, 0.5)'}; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: ${mascotteCard ? 'rgba(255, 215, 0, 0.1)' : 'rgba(0, 0, 0, 0.3)'}; cursor: pointer; transition: all 0.3s; position: relative; margin: 0 auto;">
                    ${mascotteCard ? `
                        <div style="text-align: center;">
                            <img src="${getAnimatedSpriteUrl(mascotteCard.pokemonId, mascotteCard.isShiny)}" style="width: 50px; height: 50px; image-rendering: pixelated;">
                            <div style="font-size: 0.7em; color: #FFD700; margin-top: 5px;">${FRENCH_NAMES[mascotteCard.pokemonId]}</div>
                            <div style="font-size: 0.6em; color: rgba(255,255,255,0.7);">${mascotteCard.rarity === 'legendary' ? '‚≠ê' : mascotteCard.rarity === 'super_rare' ? '‚ú®' : '‚Ä¢'}</div>
                        </div>
                    ` : `
                        <div style="color: rgba(168, 85, 247, 0.5); font-size: 0.8em; text-align: center;">+ Carte</div>
                    `}
                </div>
                ${mascotteCard ? `
                    <div style="color: #FFD700; font-size: 0.8em; text-align: center; margin-top: 5px;">
                        Bonus: ${mascotteCard.rarity === 'legendary' ? 'x5' : mascotteCard.rarity === 'super_rare' ? 'x3' : mascotteCard.rarity === 'rare' ? 'x2.5' : mascotteCard.rarity === 'uncommon' ? 'x2' : 'x1.5'} Production
                    </div>
                ` : ''}
            </div>
        `;
        
        card.innerHTML = `
            <div class="habitat-header">
                <div class="habitat-name">${habitat.name}</div>
                <div class="habitat-level">Niveau ${habitat.level}</div>
            </div>
            <div class="habitat-slots">${slotsHTML}</div>
            ${habitat.unlocked ? mascotteHTML : ''}
            ${habitat.unlocked ? `
                <button class="habitat-upgrade-btn" onclick="upgradeHabitat('${id}')" ${!canUpgrade ? 'disabled' : ''}>
                    Am√©liorer (${upgradeCost} EO)
                </button>
            ` : canUnlock ? `
                <button class="habitat-upgrade-btn" onclick="unlockHabitat('${id}')" style="background: linear-gradient(135deg, #10b981, #059669);">
                    üîì D√©bloquer avec Blueprint
                </button>
            ` : `
                <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 10px;">
                    Verrouill√© - Blueprint requis
                </div>
            `}
        `;
        
        container.appendChild(card);
    }
}

window.unlockHabitat = function(habitatId) {
    const habitat = gameState.research.habitats[habitatId];
    if (!habitat) return;
    
    const blueprintKey = `blueprint_${habitatId}`;
    if (!gameState.inventory[blueprintKey] || gameState.inventory[blueprintKey] <= 0) {
        showToast('Blueprint requis pour d√©bloquer cet habitat !', 'error');
        return;
    }
    
    gameState.inventory[blueprintKey]--;
    habitat.unlocked = true;
    
    updateResearchUI();
    saveGame();
    showToast(`üîì Habitat ${habitat.name} d√©bloqu√© !`, 'success');
};

window.upgradeHabitat = function(habitatId) {
    const habitat = gameState.research.habitats[habitatId];
    if (!habitat) return;
    
    const cost = Math.floor(100 * Math.pow(1.5, habitat.level));
    if (gameState.research.energy < cost) {
        showToast('Pas assez d\'√ânergie Onirique !', 'error');
        return;
    }
    
    gameState.research.energy -= cost;
    habitat.level++;
    habitat.slots++;
    
    updateResearchUI();
    saveGame();
    showToast(`Habitat ${habitat.name} am√©lior√© !`, 'success');
};

window.openAssignModal = function(habitatId, slotIndex) {
    const habitat = gameState.research.habitats[habitatId];
    if (!habitat || !habitat.unlocked) return;
    
    const types = POKEMON_TYPES;
    const typeMap = {
        'Grass': ['Plante'],
        'Water': ['Eau'],
        'Rock': ['Roche'],
        'Fire': ['Feu'],
        'Electric': ['√âlectrik'],
        'Ghost': ['Spectre']
    };
    
    const compatibleTypes = typeMap[habitat.type] || [];
    const availablePokemon = Array.from(gameState.captured).filter(id => {
        const pokeTypes = types[id] || [];
        return pokeTypes.some(t => compatibleTypes.includes(t));
    });
    
    if (availablePokemon.length === 0) {
        showToast('Aucun Pok√©mon compatible disponible !', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    const pokemonHTML = availablePokemon.map(id => {
        const isShiny = gameState.shinies.has(id);
        const uid = isShiny ? `${id}_shiny` : id;
        const alreadyAssigned = Object.values(gameState.research.habitats).some(h => 
            h.assigned.includes(uid)
        );
        
        return `
            <div class="slot ${alreadyAssigned ? 'disabled' : ''}" onclick="${alreadyAssigned ? '' : `assignPokemon('${habitatId}', ${slotIndex}, ${id}, ${isShiny})`}" style="cursor: ${alreadyAssigned ? 'not-allowed' : 'pointer'}; opacity: ${alreadyAssigned ? 0.5 : 1};">
                <img src="${getAnimatedSpriteUrl(id, isShiny)}" alt="${FRENCH_NAMES[id]}">
                <div style="font-size: 0.7em; margin-top: 5px;">${FRENCH_NAMES[id]}</div>
            </div>
        `;
    }).join('');
    
    modal.innerHTML = `
        <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: white; margin-bottom: 20px;">Assigner un Pok√©mon</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px;">
                ${pokemonHTML}
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn btn--outline" style="margin-top: 20px; width: 100%;">Fermer</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

// ===== FONCTIONS DE GESTION DU JARDIN (DRAG & DROP, R√âCOLTE) =====

// Variables globales pour le drag & drop
let draggedPokemonData = null;

// Fonction pour g√©rer le d√©but du drag
window.handleDragStart = function(event, row, col) {
    if (!gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const slot = grid.find(s => s.row === row && s.col === col);
    if (!slot || !slot.content || slot.content.type !== 'pokemon') return;
    
    draggedPokemonData = {
        row: row,
        col: col,
        pokemon: slot.content
    };
    
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', ''); // N√©cessaire pour Firefox
};

// Fonction pour g√©rer le drag over
window.handleDragOver = function(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
};

// Fonction pour g√©rer le drop
window.handleDrop = function(event, targetRow, targetCol) {
    event.preventDefault();
    
    if (!draggedPokemonData || !gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const targetSlot = grid.find(s => s.row === targetRow && s.col === targetCol);
    
    if (!targetSlot || !targetSlot.unlocked || targetSlot.content !== null) {
        draggedPokemonData = null;
        return;
    }
    
    // D√©placer le Pok√©mon
    const sourceSlot = grid.find(s => s.row === draggedPokemonData.row && s.col === draggedPokemonData.col);
    if (sourceSlot) {
        sourceSlot.content = null;
    }
    
    targetSlot.content = draggedPokemonData.pokemon;
    
    saveGame();
    renderGardenGrid();
    showToast('Pok√©mon d√©plac√© !', 'success');
    
    draggedPokemonData = null;
};

// Fonction pour retirer un Pok√©mon de la grille
window.removePokemonFromGarden = function(row, col) {
    if (!gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const slot = grid.find(s => s.row === row && s.col === col);
    if (!slot || !slot.content || slot.content.type !== 'pokemon') return;
    
    slot.content = null;
    saveGame();
    renderGardenGrid();
    showToast('Pok√©mon retir√© du jardin', 'info');
};

// Fonction pour ouvrir la modale d'assignation d'un slot
window.openAssignGardenSlotModal = function(row, col) {
    if (!gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const slot = grid.find(s => s.row === row && s.col === col);
    if (!slot || !slot.unlocked || slot.content !== null) return;
    
    // R√©cup√©rer tous les Pok√©mon captur√©s
    const availablePokemon = Array.from(gameState.captured).filter(id => {
        // V√©rifier si le Pok√©mon n'est pas d√©j√† dans la grille
        return !grid.some(s => 
            s.content && 
            s.content.type === 'pokemon' && 
            s.content.id === id && 
            !(s.content.isShiny && !gameState.shinies.has(id))
        );
    });
    
    if (availablePokemon.length === 0) {
        showToast('Aucun Pok√©mon disponible !', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    const pokemonHTML = availablePokemon.map(id => {
        const isShiny = gameState.shinies.has(id);
        const alreadyInGarden = grid.some(s => 
            s.content && 
            s.content.type === 'pokemon' && 
            s.content.id === id && 
            s.content.isShiny === isShiny
        );
        
        return `
            <div class="slot ${alreadyInGarden ? 'disabled' : ''}" 
                 onclick="${alreadyInGarden ? '' : `assignPokemonToGarden(${row}, ${col}, ${id}, ${isShiny})`}" 
                 style="cursor: ${alreadyInGarden ? 'not-allowed' : 'pointer'}; opacity: ${alreadyInGarden ? 0.5 : 1};">
                <img src="${getAnimatedSpriteUrl(id, isShiny)}" alt="${FRENCH_NAMES[id]}">
                <div style="font-size: 0.7em; margin-top: 5px;">${FRENCH_NAMES[id]}</div>
            </div>
        `;
    }).join('');
    
    modal.innerHTML = `
        <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: white; margin-bottom: 20px;">Assigner un Pok√©mon au Jardin</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px;">
                ${pokemonHTML}
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn btn--outline" style="margin-top: 20px; width: 100%;">Fermer</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

// Fonction pour assigner un Pok√©mon √† un slot du jardin
window.assignPokemonToGarden = function(row, col, pokemonId, isShiny) {
    if (!gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const slot = grid.find(s => s.row === row && s.col === col);
    
    if (!slot || !slot.unlocked || slot.content !== null) {
        showToast('Cette case n\'est pas disponible !', 'error');
        return;
    }
    
    slot.content = {
        type: 'pokemon',
        id: pokemonId,
        isShiny: isShiny
    };
    
    // Fermer la modale
    const modal = document.querySelector('.modal.active');
    if (modal) modal.remove();
    
    saveGame();
    renderGardenGrid();
    showToast(`${FRENCH_NAMES[pokemonId]} assign√© au jardin !`, 'success');
};

// Fonction pour r√©colter une plante sp√©cifique
window.harvestPlant = function(row, col) {
    if (!gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    const slot = grid.find(s => s.row === row && s.col === col);
    
    if (!slot || !slot.content || slot.content.type !== 'plant') return;
    
    const plant = slot.content;
    const plantData = PLANT_TYPES[plant.id];
    if (!plantData) return;
    
    const growthTime = Date.now() - (plant.growthStart || Date.now());
    const isMature = growthTime >= plantData.growthTime;
    
    if (!isMature) {
        showToast('Cette plante n\'est pas encore mature !', 'info');
        return;
    }
    
    // R√©colter la plante
    const energyGain = plantData.production * (SOIL_TYPES[gameState.research.garden.soils]?.mult || 1);
    gameState.research.energy += energyGain;
    gameState.research.totalEnergyProduced += energyGain;
    
    // Ajouter l'item √† l'inventaire global
    const inventoryKey = plant.id.replace('berry_', '').replace('herb_', '');
    if (!gameState.inventory[inventoryKey]) {
        gameState.inventory[inventoryKey] = 0;
    }
    gameState.inventory[inventoryKey]++;
    
    // Chance de r√©cup√©rer une graine
    if (Math.random() < (plantData.seedChance || 0)) {
        if (!gameState.research.garden.bankedSeeds) {
            gameState.research.garden.bankedSeeds = [];
        }
        gameState.research.garden.bankedSeeds.push(plant.id);
        showToast(`üå± ${plantData.name} r√©colt√©e ! +${Math.floor(energyGain)} EO | +1 ${plantData.name} | Graine obtenue !`, 'success');
    } else {
        showToast(`üå± ${plantData.name} r√©colt√©e ! +${Math.floor(energyGain)} EO | +1 ${plantData.name}`, 'success');
    }
    
    // Retirer la plante
    slot.content = null;
    
    saveGame();
    updateResearchUI();
    renderGardenGrid();
};

// Fonction pour r√©colter toutes les plantes matures
window.harvestMaturePlants = function() {
    if (!gameState.research.garden || !gameState.research.garden.grid) return;
    
    const grid = gameState.research.garden.grid;
    let harvested = 0;
    let totalEnergy = 0;
    let seedsObtained = [];
    
    grid.forEach(slot => {
        if (!slot.unlocked || !slot.content || slot.content.type !== 'plant') return;
        
        const plant = slot.content;
        const plantData = PLANT_TYPES[plant.id];
        if (!plantData) return;
        
        const growthTime = Date.now() - (plant.growthStart || Date.now());
        const isMature = growthTime >= plantData.growthTime;
        
        if (isMature) {
            const energyGain = plantData.production * (SOIL_TYPES[gameState.research.garden.soils]?.mult || 1);
            totalEnergy += energyGain;
            harvested++;
            
            // Ajouter l'item √† l'inventaire global
            const inventoryKey = plant.id.replace('berry_', '').replace('herb_', '');
            if (!gameState.inventory[inventoryKey]) {
                gameState.inventory[inventoryKey] = 0;
            }
            gameState.inventory[inventoryKey]++;
            
            // Chance de graine
            if (Math.random() < (plantData.seedChance || 0)) {
                if (!gameState.research.garden.bankedSeeds) {
                    gameState.research.garden.bankedSeeds = [];
                }
                gameState.research.garden.bankedSeeds.push(plant.id);
                seedsObtained.push(plantData.name);
            }
            
            slot.content = null;
        }
    });
    
    if (harvested === 0) {
        showToast('Aucune plante mature √† r√©colter !', 'info');
        return;
    }
    
    gameState.research.energy += totalEnergy;
    gameState.research.totalEnergyProduced += totalEnergy;
    
    let message = `üå± ${harvested} plante(s) r√©colt√©e(s) ! +${Math.floor(totalEnergy)} EO | +${harvested} item(s)`;
    if (seedsObtained.length > 0) {
        message += ` | ${seedsObtained.length} graine(s) obtenue(s)`;
    }
    
    showToast(message, 'success');
    saveGame();
    updateResearchUI();
    renderGardenGrid();
};

// Fonction pour ouvrir la modale de plantation
window.openPlantSeedModal = function() {
    const bankedSeeds = gameState.research.garden.bankedSeeds || [];
    
    if (bankedSeeds.length === 0) {
        showToast('Vous n\'avez aucune graine ! R√©coltez des plantes matures pour en obtenir.', 'info');
        return;
    }
    
    // Compter les graines par type
    const seedCounts = {};
    bankedSeeds.forEach(seedId => {
        seedCounts[seedId] = (seedCounts[seedId] || 0) + 1;
    });
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    const seedsHTML = Object.entries(seedCounts).map(([seedId, count]) => {
        const plantData = PLANT_TYPES[seedId];
        if (!plantData) return '';
        
        return `
            <div style="
                background: rgba(30, 30, 50, 0.8);
                border: 2px solid #a855f7;
                border-radius: 10px;
                padding: 15px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
            " 
            onclick="openSelectGardenSlotForPlanting('${seedId}')"
            onmouseover="this.style.transform='scale(1.05)'"
            onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 3em; margin-bottom: 10px;">${plantData.icon}</div>
                <div style="color: white; font-weight: bold; margin-bottom: 5px;">${plantData.name}</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">x${count}</div>
            </div>
        `;
    }).join('');
    
    modal.innerHTML = `
        <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%;">
            <h2 style="color: white; margin-bottom: 20px;">üå± Planter une Graine</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px;">
                ${seedsHTML}
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn btn--outline" style="width: 100%;">Fermer</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

// Fonction pour s√©lectionner un slot pour planter
window.openSelectGardenSlotForPlanting = function(seedId) {
    const plantData = PLANT_TYPES[seedId];
    if (!plantData) return;
    
    // Fermer la modale pr√©c√©dente
    const prevModal = document.querySelector('.modal.active');
    if (prevModal) prevModal.remove();
    
    showToast(`Cliquez sur une case vide pour planter ${plantData.name}`, 'info');
    
    // Ajouter un listener temporaire sur les cases vides
    const grid = gameState.research.garden.grid;
    const emptySlots = grid.filter(s => s.unlocked && s.content === null);
    
    if (emptySlots.length === 0) {
        showToast('Aucune case vide disponible !', 'error');
        return;
    }
    
    // Cr√©er une fonction de clic temporaire
    window._tempPlantSeedHandler = function(row, col) {
        const slot = grid.find(s => s.row === row && s.col === col);
        if (!slot || !slot.unlocked || slot.content !== null) return;
        
        // Planter la graine
        slot.content = {
            type: 'plant',
            id: seedId,
            growthStart: Date.now()
        };
        
        // Retirer la graine de la banque
        const seedIndex = gameState.research.garden.bankedSeeds.indexOf(seedId);
        if (seedIndex > -1) {
            gameState.research.garden.bankedSeeds.splice(seedIndex, 1);
        }
        
        saveGame();
        renderGardenGrid();
        showToast(`${plantData.name} plant√©e !`, 'success');
        
        // Nettoyer le handler temporaire
        delete window._tempPlantSeedHandler;
    };
    
    // Modifier temporairement les cases vides pour qu'elles appellent cette fonction
    renderGardenGrid();
    
    // Ajouter un style visuel pour indiquer qu'on peut cliquer
    setTimeout(() => {
        document.querySelectorAll('.garden-slot-empty').forEach(slot => {
            slot.style.border = '2px solid #22c55e';
            slot.style.background = 'rgba(34, 197, 94, 0.3)';
        });
    }, 100);
};

// ===== SYST√àME TCG (Trading Card Game - Collection & Boost) =====
const TCG_BOOSTER_TYPES = {
    'common': { name: 'Booster Standard', cost: 100, cards: 3, rareChance: 0.1 },
    'rare': { name: 'Booster Premium', cost: 500, cards: 5, rareChance: 0.3 },
    'legendary': { name: 'Booster L√©gendaire', cost: 2000, cards: 7, rareChance: 0.7 }
};

function generateTCGCard(pokemonId, forcedRarity = null) {
    const rarity = forcedRarity || getRarity(pokemonId);
    const isShiny = Math.random() < 0.05; // 5% chance Shiny m√™me dans les cartes
    
    // Les cartes peuvent avoir une raret√© sup√©rieure au Pok√©mon de base
    let cardRarity = rarity;
    if (!forcedRarity) {
        const rand = Math.random();
        if (rand < 0.05) cardRarity = 'legendary';
        else if (rand < 0.15) cardRarity = 'super_rare';
        else if (rand < 0.35) cardRarity = 'rare';
        else if (rand < 0.65) cardRarity = 'uncommon';
        else cardRarity = 'common';
    }
    
    return {
        id: `tcg_${pokemonId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        pokemonId: pokemonId,
        rarity: cardRarity,
        isShiny: isShiny,
        obtainedAt: Date.now()
    };
}

// Fonction pour obtenir la configuration de type d'un Pok√©mon
function getTCGTypeConfig(pokemonId) {
    const types = POKEMON_TYPES[pokemonId] || ['Normal'];
    const primaryType = types[0];
    
    const typeMap = {
        'Feu': { color: '#ff4500', dark: '#4a0404', glow: 'rgba(255, 69, 0, 0.8)', icon: 'üî•', edition: 'VOLCANO EDITION', ability: 'SURCHAUFFE' },
        'Eau': { color: '#00bfff', dark: '#05101a', glow: 'rgba(0, 191, 255, 0.8)', icon: 'üíß', edition: 'OCEAN EDITION', ability: 'TORRENT' },
        'Plante': { color: '#32cd32', dark: '#051a05', glow: 'rgba(50, 205, 50, 0.8)', icon: 'üåø', edition: 'JUNGLE EDITION', ability: 'ENGRAIS' },
        'Psy': { color: '#ff00ff', dark: '#1a051a', glow: 'rgba(255, 0, 255, 0.8)', icon: 'üîÆ', edition: 'MYSTIC EDITION', ability: 'PRESSION' },
        '√âlectrik': { color: '#ffd700', dark: '#1a1a05', glow: 'rgba(255, 215, 0, 0.8)', icon: '‚ö°', edition: 'THUNDER EDITION', ability: '√âLECTRISATION' },
        'Roche': { color: '#8b7355', dark: '#1a1a05', glow: 'rgba(139, 115, 85, 0.8)', icon: 'ü™®', edition: 'STONE EDITION', ability: 'SOLIDIT√â' },
        'Spectre': { color: '#9370db', dark: '#1a051a', glow: 'rgba(147, 112, 219, 0.8)', icon: 'üëª', edition: 'SPOOKY EDITION', ability: 'L√âVITATION' },
        'Normal': { color: '#d1d5db', dark: '#1a1a1a', glow: 'rgba(209, 213, 219, 0.8)', icon: '‚ö™', edition: 'GENESIS EDITION', ability: 'ADAPTABILIT√â' }
    };
    
    return typeMap[primaryType] || typeMap['Normal'];
}

function createTCGExternalFx(container, type) {
    container.innerHTML = '';
    
    if (type === 'Feu') {
        let ring = document.createElement('div');
        ring.className = 'tcg-fire-ring';
        container.appendChild(ring);
        for(let i = 0; i < 15; i++) {
            let p = document.createElement('div');
            p.className = 'tcg-ember-external';
            p.style.left = Math.random() * 100 + '%';
            p.style.top = (Math.random() * 50 + 50) + '%';
            p.style.animationDuration = (2 + Math.random() * 3) + 's';
            p.style.animationDelay = Math.random() * 2 + 's';
            container.appendChild(p);
        }
    } else if (type === 'Eau') {
        let splash = document.createElement('div');
        splash.className = 'tcg-water-splash';
        container.appendChild(splash);
        for(let i = 0; i < 20; i++) {
            let b = document.createElement('div');
            b.className = 'tcg-bubble-external';
            b.style.width = (10 + Math.random() * 20) + 'px';
            b.style.height = b.style.width;
            b.style.left = Math.random() * 100 + '%';
            b.style.bottom = '-50px';
            b.style.animationDelay = Math.random() * 2 + 's';
            container.appendChild(b);
        }
    } else if (type === 'Psy') {
        let orbit1 = document.createElement('div');
        orbit1.className = 'tcg-psy-orbit';
        container.appendChild(orbit1);
        let orbit2 = document.createElement('div');
        orbit2.className = 'tcg-psy-orbit';
        orbit2.style.width = '350px';
        orbit2.style.height = '350px';
        orbit2.style.animationDirection = 'reverse';
        orbit2.style.animationDuration = '7s';
        container.appendChild(orbit2);
        for(let i = 0; i < 3; i++) {
            let w = document.createElement('div');
            w.className = 'tcg-psy-wave-external';
            w.style.animationDelay = i * 1 + 's';
            container.appendChild(w);
        }
    }
}

window.openTCGBooster = function(boosterType = 'common') {
    if (!gameState.tcg) gameState.tcg = { unlocked: true, cards: {}, boostersOpened: 0, boosters: 0 };
    
    const booster = TCG_BOOSTER_TYPES[boosterType];
    if (!booster) return;
    
    if (gameState.research.energy < booster.cost) {
        showToast(`Pas assez d'√ânergie Onirique ! (${booster.cost} EO requis)`, 'error');
        return;
    }
    
    gameState.research.energy -= booster.cost;
    gameState.tcg.boostersOpened++;
    
    // G√©n√©rer UNE SEULE carte (mobile-first)
    const allPokemon = Array.from(gameState.captured);
    
    if (allPokemon.length === 0) {
        showToast('Vous devez capturer au moins un Pok√©mon pour ouvrir des boosters !', 'error');
        return;
    }
    
    // G√©n√©rer une seule carte avec chance de raret√© bas√©e sur le type de booster
    let pokemonId;
    let forcedRarity = null;
    
    const rand = Math.random();
    if (rand < booster.rareChance) {
        // Chance de rare selon le booster
        const rarePokemon = allPokemon.filter(id => {
            const r = getRarity(id);
            return r === 'rare' || r === 'super_rare' || r === 'legendary';
        });
        if (rarePokemon.length > 0) {
            pokemonId = rarePokemon[Math.floor(Math.random() * rarePokemon.length)];
            forcedRarity = getRarity(pokemonId);
        } else {
            pokemonId = allPokemon[Math.floor(Math.random() * allPokemon.length)];
        }
    } else {
        pokemonId = allPokemon[Math.floor(Math.random() * allPokemon.length)];
    }
    
    const card = generateTCGCard(pokemonId, forcedRarity);
    
    // Stocker la carte temporairement (une seule carte)
    window._tempTCGCards = [card];
    
    // Cr√©er la modale avec animation de booster
    const modal = document.createElement('div');
    modal.className = 'modal active tcg-booster-modal';
    modal.id = 'tcg-booster-modal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, #0a0a0a 0%, #000 100%); z-index: 10001; display: flex; align-items: center; justify-content: center; overflow: hidden; font-family: "Roboto Condensed", sans-serif;';
    
    // D√©terminer le type du booster (bas√© sur la carte unique)
    const firstCard = window._tempTCGCards[0];
    const typeConfig = getTCGTypeConfig(firstCard.pokemonId);
    
    // Appliquer les variables CSS
    const root = document.documentElement;
    root.style.setProperty('--tcg-type-color', typeConfig.color);
    root.style.setProperty('--tcg-type-dark', typeConfig.dark);
    root.style.setProperty('--tcg-type-glow', typeConfig.glow);
    
    modal.innerHTML = `
        <div id="tcg-flash" class="tcg-flash"></div>
        
        <!-- BOOSTER -->
        <div id="tcg-booster" class="tcg-booster-container idle" onclick="tcgOpenPack()">
            <div class="tcg-booster-body">
                <div class="tcg-booster-foil"></div>
                <div class="tcg-booster-art">
                    <img src="${getOfficialSpriteUrl(firstCard.pokemonId, firstCard.isShiny)}" class="tcg-booster-pokemon-img">
                </div>
                <div class="tcg-booster-title">GENESIS</div>
                <div class="tcg-booster-edition">${typeConfig.edition}</div>
            </div>
        </div>
        
        <!-- EFFETS EXTERNES -->
        <div id="tcg-external-fx" class="tcg-external-fx-container">
            <div class="tcg-aura-ring"></div>
            <div id="tcg-specific-fx"></div>
        </div>
        
        <!-- CARTE (une seule carte, mobile-first) -->
        <div id="tcg-cards-container" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; display: flex; align-items: center; justify-content: center; z-index: 150;"></div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialiser les effets externes
    createTCGExternalFx(document.getElementById('tcg-specific-fx'), typeConfig.icon === 'üî•' ? 'Feu' : typeConfig.icon === 'üíß' ? 'Eau' : typeConfig.icon === 'üîÆ' ? 'Psy' : 'Normal');
    document.getElementById('tcg-external-fx').style.display = 'block';
    
    // Effet parallaxe sur le booster
    modal.addEventListener('mousemove', (e) => {
        const boosterEl = document.getElementById('tcg-booster');
        if (boosterEl && boosterEl.style.display !== 'none') {
            const x = (e.clientX / window.innerWidth - 0.5) * 30;
            const y = (e.clientY / window.innerHeight - 0.5) * 30;
            boosterEl.style.transform = `rotateY(${x}deg) rotateX(${-y}deg)`;
            const foil = boosterEl.querySelector('.tcg-booster-foil');
            if (foil) {
                foil.style.backgroundPosition = `${e.clientX}px ${e.clientY}px`;
            }
        }
    });
    
    saveGame();
};

window.tcgOpenPack = function() {
    const booster = document.getElementById('tcg-booster');
    const flash = document.getElementById('tcg-flash');
    const cardsContainer = document.getElementById('tcg-cards-container');
    const externalFx = document.getElementById('tcg-external-fx');
    
    if (!booster || !flash || !cardsContainer) return;
    
    booster.classList.remove('idle');
    booster.style.animation = 'tcgShakeHard 0.5s ease-in-out';
    
    setTimeout(() => {
        flash.style.animation = 'tcgFlash 0.6s ease-out';
        setTimeout(() => {
            booster.style.display = 'none';
            externalFx.style.display = 'none';
            cardsContainer.style.display = 'flex';
            
            // R√©v√©ler la carte unique
            if (window._tempTCGCards && window._tempTCGCards.length > 0) {
                setTimeout(() => {
                    revealTCGCard(window._tempTCGCards[0], 0);
                }, 200);
            }
        }, 100);
    }, 500);
};

function revealTCGCard(card, index) {
    const cardsContainer = document.getElementById('tcg-cards-container');
    if (!cardsContainer) return;
    
    const typeConfig = getTCGTypeConfig(card.pokemonId);
    const rarityStars = {
        'common': '‚òÖ',
        'uncommon': '‚òÖ‚òÖ',
        'rare': '‚òÖ‚òÖ‚òÖ',
        'super_rare': '‚òÖ‚òÖ‚òÖ‚òÖ',
        'legendary': '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'
    };
    
    // Calculer HP bas√© sur la raret√©
    const hpMap = {
        'common': 60,
        'uncommon': 90,
        'rare': 120,
        'super_rare': 150,
        'legendary': 180
    };
    const hp = hpMap[card.rarity] || 60;
    
    // D√©terminer le bonus de production
    const bonusMap = {
        'common': 'x1.5',
        'uncommon': 'x2',
        'rare': 'x2.5',
        'super_rare': 'x3',
        'legendary': 'x5'
    };
    const bonus = bonusMap[card.rarity] || 'x1';
    
    const cardWrapper = document.createElement('div');
    cardWrapper.className = 'tcg-card-wrapper';
    cardWrapper.style.display = 'block';
    cardWrapper.id = `tcg-card-${card.id}`;
    // Style mobile-first : carte centr√©e et dimensionn√©e pour mobile
    cardWrapper.style.width = '100%';
    cardWrapper.style.maxWidth = '350px';
    cardWrapper.style.margin = '0 auto';
    
    // V√©rifier si le sprite est petit (comme Mewtwo)
    const isSmallSprite = [150, 151].includes(card.pokemonId);
    
    cardWrapper.innerHTML = `
        <div class="tcg-card-face tcg-card-front">
            <div class="tcg-card-background"></div>
            <div class="tcg-bg-fx-container"></div>
            <div class="tcg-fx-container"></div>
            <div class="tcg-pokemon-sprite-container">
                <img src="${getAnimatedSpriteUrl(card.pokemonId, card.isShiny)}" class="tcg-pokemon-sprite ${isSmallSprite ? 'large-sprite' : ''}">
            </div>
            <div class="tcg-holo-overlay"></div>
            <div class="tcg-card-header">
                <div class="tcg-card-name">${FRENCH_NAMES[card.pokemonId]}</div>
                <div class="tcg-card-hp">HP ${hp}</div>
            </div>
            <div class="tcg-card-footer">
                <div class="tcg-ability-box">
                    <div class="tcg-ability-name">${typeConfig.icon} MODULE: ${typeConfig.ability}</div>
                    <div class="tcg-ability-text">${card.isShiny ? '‚ú® SHINY ‚ú®<br>' : ''}Bonus de production: <strong>${bonus}</strong> pour l'habitat compatible.</div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; color:#aaa; font-size:0.8em;">
                    <span>GEN-${String(card.pokemonId).padStart(3, '0')}/151</span>
                    <span class="tcg-rarity-icon">${rarityStars[card.rarity]}</span>
                </div>
            </div>
        </div>
        <div class="tcg-card-face tcg-card-back">
            <div class="tcg-pokeball-logo"></div>
        </div>
    `;
    
    cardsContainer.appendChild(cardWrapper);
    
    // Appliquer les couleurs de type
    const cardFront = cardWrapper.querySelector('.tcg-card-front');
    const cardBg = cardWrapper.querySelector('.tcg-card-background');
    const cardHp = cardWrapper.querySelector('.tcg-card-hp');
    
    if (cardFront) {
        cardFront.style.setProperty('--tcg-type-color', typeConfig.color);
        cardFront.style.setProperty('--tcg-type-glow', typeConfig.glow);
    }
    if (cardBg) {
        cardBg.style.background = `radial-gradient(circle at 50% 40%, ${typeConfig.color}, #000)`;
    }
    if (cardHp) {
        cardHp.style.color = typeConfig.color;
    }
    
    // Animation de flip
    requestAnimationFrame(() => {
        cardWrapper.classList.add('flipping');
    });
    
    // Effet parallaxe sur la carte
    const holo = cardWrapper.querySelector('.tcg-holo-overlay');
    cardWrapper.addEventListener('mousemove', (e) => {
        if (cardWrapper.classList.contains('flipping')) {
            const rect = cardWrapper.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width;
            const y = (e.clientY - rect.top) / rect.height;
            const rotateY = (x - 0.5) * 25;
            const rotateX = (y - 0.5) * -25;
            const cardFront = cardWrapper.querySelector('.tcg-card-front');
            if (cardFront) {
                cardFront.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
            }
            if (holo) {
                holo.style.backgroundPosition = `${x * 100}% ${y * 100}%`;
                holo.style.opacity = 0.4 + Math.abs(x - 0.5);
            }
        }
    });
    
    // Clic pour s√©lectionner la carte
    cardWrapper.style.cursor = 'pointer';
    cardWrapper.onclick = () => {
        selectTCGCard(card.id);
    };
    
    // Ajouter un indicateur visuel de clic (mobile-first)
    setTimeout(() => {
        const clickHint = document.createElement('div');
        clickHint.style.cssText = 'position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); color: #ffd700; font-size: 1em; font-weight: bold; text-align: center; text-shadow: 0 0 10px rgba(255,215,0,0.8); animation: tcgPulseAura 2s infinite; white-space: nowrap; width: 100%; max-width: 300px; padding: 10px;';
        clickHint.textContent = 'üëÜ Cliquez pour ajouter √† la collection';
        cardWrapper.style.position = 'relative';
        cardWrapper.style.marginBottom = '60px'; // Espace pour le message
        cardWrapper.appendChild(clickHint);
    }, 1500);
};

window.selectTCGCard = function(cardId) {
    if (!window._tempTCGCards) return;
    
    const card = window._tempTCGCards.find(c => c.id === cardId);
    if (!card) return;
    
    // Ajouter la carte √† la collection
    if (!gameState.tcg.cards) gameState.tcg.cards = {};
    gameState.tcg.cards[cardId] = card;
    
    const rarityNames = {
        'common': 'Commun',
        'uncommon': 'Peu Commun',
        'rare': 'Rare',
        'super_rare': 'Super Rare',
        'legendary': 'L√©gendaire'
    };
    
    showToast(`‚ú® ${FRENCH_NAMES[card.pokemonId]} ${card.isShiny ? 'SHINY ' : ''}(${rarityNames[card.rarity]}) ajout√© √† votre collection !`, 'success');
    
    // Fermer la modale
    const modal = document.getElementById('tcg-booster-modal');
    if (modal) {
        modal.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => {
            modal.remove();
            window._tempTCGCards = null;
            saveGame();
            // Rafra√Æchir l'UI si on est sur la page Research
            if (document.getElementById('research-page')?.classList.contains('active')) {
                renderResearchPage();
            }
        }, 500);
    } else {
        // Fallback pour l'ancienne modale
        document.querySelectorAll('.modal.active').forEach(m => {
            if (m.querySelector('.tcg-card') || m.classList.contains('tcg-booster-modal')) m.remove();
        });
        window._tempTCGCards = null;
        saveGame();
    }
};

window.openMascotteModal = function(habitatId) {
    const habitat = gameState.research.habitats[habitatId];
    if (!habitat || !habitat.unlocked) return;
    
    if (!gameState.tcg || !gameState.tcg.cards || Object.keys(gameState.tcg.cards).length === 0) {
        showToast('Vous n\'avez aucune carte TCG ! Ouvrez des boosters dans le Terminal.', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    const typeMap = {
        'Grass': ['Plante'],
        'Water': ['Eau'],
        'Rock': ['Roche'],
        'Fire': ['Feu'],
        'Electric': ['√âlectrik'],
        'Ghost': ['Spectre']
    };
    
    const compatibleTypes = typeMap[habitat.type] || [];
    const availableCards = Object.values(gameState.tcg.cards).filter(card => {
        const cardTypes = POKEMON_TYPES[card.pokemonId] || [];
        return cardTypes.some(t => compatibleTypes.includes(t));
    });
    
    if (availableCards.length === 0) {
        modal.innerHTML = `
            <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center;">
                <h2 style="color: white; margin-bottom: 20px;">Aucune carte compatible</h2>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                    Vous n'avez aucune carte TCG compatible avec l'habitat ${habitat.name}.
                </p>
                <button onclick="this.closest('.modal').remove()" class="btn btn--primary" style="width: 100%; padding: 15px;">
                    Fermer
                </button>
            </div>
        `;
    } else {
        const cardsHTML = availableCards.map(card => {
            const rarityColors = {
                'common': '#9ca3af',
                'uncommon': '#3b82f6',
                'rare': '#8b5cf6',
                'super_rare': '#f59e0b',
                'legendary': '#ef4444'
            };
            const isEquipped = habitat.mascotte === card.id;
            const bonus = {
                'common': 'x1.5',
                'uncommon': 'x2',
                'rare': 'x2.5',
                'super_rare': 'x3',
                'legendary': 'x5'
            }[card.rarity] || 'x1';
            
            return `
                <div class="tcg-card-select" onclick="equipMascotte('${habitatId}', '${card.id}')" style="background: ${rarityColors[card.rarity] || '#9ca3af'}; border: 3px solid ${isEquipped ? '#FFD700' : 'rgba(255,255,255,0.3)'}; border-radius: 12px; padding: 15px; cursor: pointer; transition: all 0.3s; ${isEquipped ? 'box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);' : ''}" onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform='scale(1)'">
                    <img src="${getAnimatedSpriteUrl(card.pokemonId, card.isShiny)}" style="width: 100px; height: 100px; image-rendering: pixelated; margin-bottom: 10px;">
                    <div style="color: white; font-weight: bold; font-size: 1em; margin-bottom: 5px;">${FRENCH_NAMES[card.pokemonId]}</div>
                    <div style="color: ${card.isShiny ? '#FFD700' : 'rgba(255,255,255,0.8)'}; font-size: 0.9em; font-weight: bold; margin-bottom: 5px;">${card.isShiny ? '‚ú® SHINY' : ''}</div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 0.85em; margin-bottom: 8px;">${card.rarity}</div>
                    <div style="color: #FFD700; font-weight: bold; font-size: 1.1em;">Bonus: ${bonus}</div>
                    ${isEquipped ? '<div style="color: #FFD700; font-weight: bold; margin-top: 8px;">‚úì √âQUIP√âE</div>' : ''}
                </div>
            `;
        }).join('');
        
        modal.innerHTML = `
            <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h2 style="color: white; margin-bottom: 20px; text-align: center;">üé¥ Choisir une Mascotte</h2>
                <p style="color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 20px;">
                    S√©lectionnez une carte pour √©quiper l'habitat ${habitat.name}
                </p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    ${cardsHTML}
                </div>
                ${habitat.mascotte ? `
                    <button onclick="unequipMascotte('${habitatId}')" class="btn btn--outline" style="width: 100%; padding: 12px; margin-bottom: 10px;">
                        Retirer la mascotte actuelle
                    </button>
                ` : ''}
                <button onclick="this.closest('.modal').remove()" class="btn btn--primary" style="width: 100%; padding: 15px;">
                    Fermer
                </button>
            </div>
        `;
    }
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

window.equipMascotte = function(habitatId, cardId) {
    const habitat = gameState.research.habitats[habitatId];
    if (!habitat || !gameState.tcg || !gameState.tcg.cards[cardId]) return;
    
    // Retirer la carte de l'ancien habitat si √©quip√©e ailleurs
    Object.values(gameState.research.habitats).forEach(h => {
        if (h.mascotte === cardId) {
            h.mascotte = null;
        }
    });
    
    habitat.mascotte = cardId;
    const card = gameState.tcg.cards[cardId];
    
    updateResearchUI();
    saveGame();
    
    document.querySelectorAll('.modal.active').forEach(m => m.remove());
    
    const bonus = {
        'common': 'x1.5',
        'uncommon': 'x2',
        'rare': 'x2.5',
        'super_rare': 'x3',
        'legendary': 'x5'
    }[card.rarity] || 'x1';
    
    showToast(`üé¥ ${FRENCH_NAMES[card.pokemonId]} √©quip√© comme Mascotte ! (Bonus: ${bonus})`, 'success');
};

window.unequipMascotte = function(habitatId) {
    const habitat = gameState.research.habitats[habitatId];
    if (!habitat) return;
    
    habitat.mascotte = null;
    updateResearchUI();
    saveGame();
    
    document.querySelectorAll('.modal.active').forEach(m => m.remove());
    showToast('Mascotte retir√©e', 'info');
};

window.assignPokemon = function(habitatId, slotIndex, pokemonId, isShiny) {
    const habitat = gameState.research.habitats[habitatId];
    if (!habitat) return;
    
    const uid = isShiny ? `${pokemonId}_shiny` : pokemonId;
    
    // V√©rifier si c'est le premier assignement global
    const totalAssigned = Object.values(gameState.research.habitats).reduce((sum, h) => sum + h.assigned.length, 0);
    const isFirstWorker = totalAssigned === 0;
    
    // Retirer de l'ancien habitat si assign√© ailleurs
    for (const [hid, h] of Object.entries(gameState.research.habitats)) {
        const index = h.assigned.indexOf(uid);
        if (index !== -1) {
            h.assigned.splice(index, 1);
        }
    }
    
    // Assigner au nouveau slot
    if (habitat.assigned[slotIndex]) {
        // Remplacer
        habitat.assigned[slotIndex] = uid;
    } else {
        // Ajouter
        habitat.assigned.push(uid);
    }
    
    document.querySelectorAll('.modal.active').forEach(m => m.remove());
    updateResearchUI();
    saveGame();
    showToast(`${FRENCH_NAMES[pokemonId]} assign√© !`, 'success');
    
    // Triggers narratifs contextuels
    if (isFirstWorker && typeof startDialogue === 'function') {
        setTimeout(() => startDialogue('first_worker'), 500);
    } else if (isShiny && typeof startDialogue === 'function') {
        setTimeout(() => startDialogue('first_shiny_worker'), 500);
    }
};

// Phrases funs pour le News Ticker
const NEWS_TICKER_PHRASES = [
    "‚ö° L'√ânergie Onirique atteint des niveaux critiques !",
    "üî¨ Nouvelle d√©couverte : Les Pok√©mon g√©n√®rent de l'√©nergie passive !",
    "üíé Processor Chips disponibles dans le Pok√©-Poker !",
    "üìã Blueprints rares trouv√©s dans les Exp√©ditions !",
    "üå± La For√™t produit plus d'√©nergie que pr√©vu !",
    "‚ö° Le Noyau Genesis r√©agit aux interactions !",
    "üîÆ Porygon-Z d√©tecte des anomalies dans les donn√©es...",
    "üí´ L'√ânergie Onirique peut √™tre convertie en upgrades !",
    "üéØ Nouveaux habitats √† d√©bloquer avec les Blueprints !",
    "‚öôÔ∏è Syst√®me d'automatisation disponible avec Processor Chips !",
    "üåü Les Pok√©mon Shiny produisent 5x plus d'√©nergie !",
    "üîã Production offline calcul√©e automatiquement !"
];

let newsTickerInterval = null;

function startNewsTicker() {
    const ticker = document.getElementById('news-ticker');
    if (!ticker) {
        // R√©essayer apr√®s un court d√©lai si l'√©l√©ment n'existe pas encore
        setTimeout(startNewsTicker, 100);
        return;
    }
    
    let currentIndex = 0;
    
    const updateTicker = () => {
        if (ticker) {
            const phrase = NEWS_TICKER_PHRASES[currentIndex];
            
            // Afficher le texte d'abord sans animation
            ticker.textContent = phrase;
            ticker.classList.remove('animated');
            ticker.style.paddingLeft = '0';
            ticker.style.transform = 'translateX(0)';
            ticker.style.opacity = '1';
            
            // Forcer le reflow pour s'assurer que le texte est visible
            void ticker.offsetHeight;
            
            // Calculer la dur√©e de l'animation bas√©e sur la longueur du texte
            const textWidth = ticker.scrollWidth;
            const containerWidth = ticker.parentElement.offsetWidth;
            const totalDistance = textWidth + containerWidth;
            const duration = Math.max(10, (totalDistance / 50)); // 50px par seconde
            
            // Attendre un peu puis ajouter l'animation de d√©filement
            setTimeout(() => {
                ticker.style.animation = `ticker-scroll ${duration}s linear infinite`;
                ticker.classList.add('animated');
            }, 500);
            
            currentIndex = (currentIndex + 1) % NEWS_TICKER_PHRASES.length;
        }
    };
    
    // Initialiser imm√©diatement
    updateTicker();
    
    // Nettoyer l'ancien interval s'il existe
    if (newsTickerInterval) clearInterval(newsTickerInterval);
    
    // Mettre √† jour toutes les 5 secondes
    newsTickerInterval = setInterval(updateTicker, 5000);
}

function applyOfflineProduction() {
    if (!gameState.research || !gameState.research.unlocked) return;
    
    const now = Date.now();
    const lastSave = gameState.research.lastSaveTime || now;
    const timeDiff = Math.max(0, now - lastSave);
    const maxOfflineTime = 24 * 60 * 60 * 1000;
    const offlineTime = Math.min(timeDiff, maxOfflineTime);
    const secondsOffline = Math.floor(offlineTime / 1000);
    
    if (secondsOffline < 60) return; // Moins d'1 minute, pas de notification
    
    const productionPerSecond = calculateProduction();
    const offlineEnergy = productionPerSecond * secondsOffline;
    
    if (offlineEnergy > 0) {
        gameState.research.energy += offlineEnergy;
        gameState.research.totalEnergyProduced += offlineEnergy;
        gameState.research.lastSaveTime = now;
        
        const hours = Math.floor(secondsOffline / 3600);
        const minutes = Math.floor((secondsOffline % 3600) / 60);
        if (hours > 0 || minutes > 0) {
            showToast(`‚ö° Production offline : +${Math.floor(offlineEnergy).toLocaleString()} EO (${hours}h ${minutes}m)`, 'success');
        }
    }
}

function renderResearchPage() {
    const page = document.getElementById('research-page');
    if (!page) return;
    
    if (!gameState.research.unlocked) {
        page.innerHTML = `
            <div class="container" style="text-align: center; padding: 40px;">
                <h1 style="color: #a855f7;">üîí Centre de Recherche Verrouill√©</h1>
                <p style="color: rgba(255,255,255,0.7); margin-top: 20px;">D√©bloquez le Centre de Recherche au niveau 5.</p>
            </div>
        `;
        return;
    }
    
    applyOfflineProduction();
    
    const processorChips = gameState.inventory.processor_chips || 0;
    const automationLevel = gameState.research.automationLevel || 0;
    
    // Structure propre : Chaque vue a son conteneur ID unique
    page.innerHTML = `
        <div class="container" style="padding-bottom: 100px;">
            <div id="research-view-lab" class="research-view">
            <div id="news-ticker-container" class="news-ticker-container">
                <div class="news-ticker-label">üì°</div>
                    <div class="news-ticker-text-wrapper"><div id="news-ticker" class="news-ticker-text"></div></div>
            </div>
            
                <div class="research-header" style="position: relative;">
                    <button id="research-back-btn" onclick="(() => { const nav = document.getElementById('research-bottom-nav'); if (nav) nav.remove(); stopAnomalySpawner(); window.switchPage('home'); })()" style="position: absolute; left: 10px; top: 10px; background: rgba(168, 85, 247, 0.4); border: 2px solid #a855f7; border-radius: 50%; width: 55px; height: 55px; color: white; font-size: 1.8em; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 10; box-shadow: 0 0 20px rgba(168, 85, 247, 0.6); padding: 0; min-width: 55px; min-height: 55px;" onmouseover="this.style.background='rgba(168, 85, 247, 0.6)'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='rgba(168, 85, 247, 0.4)'; this.style.transform='scale(1)';">
                        ‚Üê
                    </button>
                    <h1 style="margin:0; font-size: 1.2em; opacity: 0.8;">‚ö° √ânergie Onirique</h1>
                    <div id="eo-display" style="font-size: 3.5em; font-weight: 900; color: white; text-shadow: 0 0 20px #a855f7; line-height: 1.1;">0</div>
                    <div style="color: #a855f7; font-family: monospace; font-size: 1.1em; margin-top: 5px;">+<span id="eo-per-sec">0</span> / sec</div>
            </div>
            
                <div id="research-buffs-header" style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; min-height: 10px;"></div>
                
                <!-- Noyau Central 3D (Master-Tech) -->
                <div class="crystal-core-container" id="genesis-3d-container" onclick="window.clickCrystal()">
                    <!-- Le canvas 3D sera inject√© ici par JS -->
            </div>
            
                <div style="background: linear-gradient(90deg, rgba(20, 20, 35, 0.8), rgba(30, 30, 60, 0.8)); border: 1px solid #a855f7; border-radius: 12px; padding: 15px; margin-top: 20px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display:flex; flex-direction:column;">
                        <span style="color: #20d5d2; font-weight: bold; font-size: 0.8em; text-transform: uppercase;">Automatisation</span>
                        <span style="color: white; font-weight: bold;">Niveau ${automationLevel}</span>
                </div>
                    <div style="text-align: right;">
                         <span style="color: rgba(255,255,255,0.6); font-size: 0.8em; display:block;">${processorChips} Chips</span>
                        ${automationLevel === 0 ? 
                            `<button onclick="buyAutomationUpgrade()" class="btn btn--primary" ${processorChips < 10 ? 'disabled' : ''} style="padding: 6px 12px; font-size: 0.8em; margin-top:4px;">D√©bloquer (10 üíæ)</button>` : 
                            `<button onclick="switchResearchView('terminal')" class="btn btn--outline" style="padding: 6px 12px; font-size: 0.8em; margin-top:4px; border-color: #a855f7; color: #a855f7;">Am√©liorer</button>`
                        }
            </div>
                </div>
            </div>
            
            <div id="research-view-garden" class="research-view" style="display: none;">
                <div style="text-align:center; margin-bottom:20px;">
                    <h2 style="color: #10b981; margin:0; font-size: 2em;">üåø Bio-D√¥me</h2>
                    <p style="color:rgba(255,255,255,0.5); font-size:0.9em;">Cultivez des baies et attirez des Pok√©mon</p>
                </div>
                <div id="garden-content-wrapper"></div>
                </div>

            <div id="research-view-terminal" class="research-view" style="display: none;">
                <h2 style="text-align:center; color: #a855f7; margin-bottom:15px;">üíª Terminal Genesis</h2>
                
                        <div class="research-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button id="tab-terminal-main" class="research-tab active" onclick="switchTerminalTab('main')" style="flex: 1;">‚ö° Upgrades</button>
                            <button id="tab-terminal-production" class="research-tab" onclick="switchTerminalTab('production')" style="flex: 1;">üå± Production</button>
                            <button id="tab-terminal-tech" class="research-tab" onclick="switchTerminalTab('tech')" style="flex: 1;">üå≥ Arbre</button>
                            ${(gameState.research.ancientData || 0) > 0 ? `<button id="tab-terminal-prestige" class="research-tab" onclick="switchTerminalTab('prestige')" style="flex: 1; color: #FFD700;">üîÆ Prestige</button>` : ''}
                </div>
                        
                        <div id="terminal-content-main"><div id="terminal-shop"></div></div>
                        <div id="terminal-content-production" style="display:none;"><div id="berry-production-container"></div></div>
                        <div id="terminal-content-tech" style="display:none;"><div id="tech-tree-container"></div></div>
                        <div id="terminal-content-prestige" style="display:none;"><div id="prestige-shop"></div></div>
            </div>

            <div id="research-view-berrydex" class="research-view" style="display: none;">
                <div id="berrydex-content"></div>
            </div>
        </div>
    `;
    
    // Initialisation
    startNewsTicker();
    startAnomalySpawner();
    createResearchBottomNav(); // Cr√©e la barre du bas avec le bouton Quitter
    
    // Force la mise √† jour des valeurs
    updateResearchUI();
    
    // Mettre √† jour l'affichage des buffs actifs
    updateActiveBuffsDisplay();
    
    // Mettre √† jour les buffs toutes les secondes
    setInterval(updateActiveBuffsDisplay, 1000);
    
    // Rendu du Jardin (Nouveau vs Ancien syst√®me)
    const gardenWrapper = document.getElementById('garden-content-wrapper');
    if (gardenWrapper) {
        // On utilise un wrapper pour √™tre s√ªr d'injecter au bon endroit
        // Si le syst√®me de grille existe, on l'utilise, sinon habitats classiques
    if (gameState.research.garden && gameState.research.garden.grid) {
            // Cr√©er un div temporaire pour renderGardenGrid qui s'attend souvent √† trouver l'ID par d√©faut
            gardenWrapper.innerHTML = '<div id="garden-grid-container"></div>';
        renderGardenGrid();
    } else {
            gardenWrapper.innerHTML = '<div id="habitats-list"></div>';
        renderHabitats();
        }
    }
    
    // D√©marrer les auto-clickers si disponibles
    if (gameState.research.automation) {
        if (gameState.research.automation.researchers > 0) {
            startResearcherAutoClick();
        }
        if (gameState.research.automation.autoClickers > 0) {
            startAutoClicker();
        }
    }

    // D√©marrer le moteur 3D
    setTimeout(() => {
        if (typeof Genesis3D !== 'undefined') {
            Genesis3D.init('genesis-3d-container');
        }
    }, 100); // Petit d√©lai pour s'assurer que le DOM est pr√™t

    // Vue par d√©faut
    switchResearchView('lab');
}

// Mise √† jour de la Barre du bas (avec bouton Quitter)
window.createResearchBottomNav = function() {
    const oldNav = document.getElementById('research-bottom-nav');
    if (oldNav) oldNav.remove();
    
    const researchPage = document.getElementById('research-page');
    if (!researchPage) return;
    
    const nav = document.createElement('div');
    nav.id = 'research-bottom-nav';
    nav.style.cssText = `
        position: fixed;
        bottom: 0; left: 0; right: 0;
        background: rgba(15, 15, 25, 0.98);
        border-top: 1px solid rgba(168, 85, 247, 0.3);
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 10px 5px;
        padding-bottom: max(10px, env(safe-area-inset-bottom));
        z-index: 9999;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
    `;
    
    const tabs = [
        { id: 'lab', icon: '‚ö°', label: 'Labo', view: 'lab' },
        { id: 'garden', icon: 'üå±', label: 'Jardin', view: 'garden' },
        { id: 'terminal', icon: 'üíª', label: 'Terminal', view: 'terminal' },
        { id: 'berrydex', icon: 'üìñ', label: 'BerryDex', view: 'berrydex' },
        { id: 'quit', icon: 'üè†', label: 'Quitter', action: 'quit' } // Le bouton sauveur !
    ];
    
    tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.id = `research-nav-${tab.id}`;
        btn.className = 'research-nav-btn';
        btn.innerHTML = `
            <div style="font-size: 1.4em; margin-bottom: 2px;">${tab.icon}</div>
            <div style="font-size: 0.7em; font-weight: 600;">${tab.label}</div>
        `;
        btn.style.cssText = `
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.5);
            padding: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        `;
        
        btn.addEventListener('click', () => {
            if (tab.action === 'quit') {
                // Action pour quitter le mode recherche
                const navBar = document.getElementById('research-bottom-nav');
                if (navBar) navBar.remove();
                stopAnomalySpawner(); // Arr√™te les glitchs quand on part
                switchPage('home');
            } else {
            switchResearchView(tab.view);
            }
        });
        
        nav.appendChild(btn);
    });
    
    researchPage.appendChild(nav);
    // Initialiser le bouton actif
    const labBtn = document.getElementById('research-nav-lab');
    if(labBtn) {
        labBtn.style.color = '#a855f7';
        labBtn.style.background = 'rgba(168, 85, 247, 0.2)';
    }
};

// Mise √† jour de la fonction de navigation (Switch)
window.switchResearchView = function(view) {
    // 1. Cacher toutes les vues
    const views = document.querySelectorAll('.research-view');
    views.forEach(el => el.style.display = 'none');

    // 2. Afficher la vue demand√©e avec animation
    const targetEl = document.getElementById(`research-view-${view}`);
    if (targetEl) {
        targetEl.style.display = 'block';
        targetEl.style.animation = 'fadeIn 0.3s ease';
    }

    // 3. Mise √† jour visuelle des boutons de la barre du bas
    document.querySelectorAll('.research-nav-btn').forEach(btn => {
        btn.style.background = 'transparent';
        btn.style.color = 'rgba(255,255,255,0.5)';
        btn.style.transform = 'scale(1)';
    });
    
    const activeBtn = document.getElementById(`research-nav-${view}`);
    if (activeBtn) {
        activeBtn.style.background = 'rgba(168, 85, 247, 0.2)';
        activeBtn.style.color = '#a855f7';
        activeBtn.style.transform = 'scale(1.1)';
    }
    
    // 4. Chargement sp√©cifique des donn√©es
    if (view === 'lab') {
        // R√©initialiser le moteur 3D quand on revient au Labo
        setTimeout(() => {
            if (typeof Genesis3D !== 'undefined') {
                const container = document.getElementById('genesis-3d-container');
                if (container && !container.querySelector('canvas')) {
                    Genesis3D.init('genesis-3d-container');
                }
            }
        }, 100);
    } else if (view === 'terminal') {
        renderTerminalShop();
        switchTerminalTab('main');
    } else if (view === 'berrydex') {
        renderBerryDex();
    }
};

// Fonction utilitaire pour les onglets du terminal
window.switchTerminalTab = function(tab) {
    ['main', 'production', 'tech', 'prestige'].forEach(t => {
        const el = document.getElementById(`terminal-content-${t}`);
        const btn = document.getElementById(`tab-terminal-${t}`);
        if (el) el.style.display = 'none';
        if (btn) btn.classList.remove('active');
    });
    
    const targetEl = document.getElementById(`terminal-content-${tab}`);
    const targetBtn = document.getElementById(`tab-terminal-${tab}`);
    
    if (targetEl) {
        targetEl.style.display = 'block';
        targetEl.style.animation = 'fadeIn 0.3s ease';
    }
    if (targetBtn) targetBtn.classList.add('active');
    
    if (tab === 'tech' && typeof renderTechTree === 'function') renderTechTree();
    if (tab === 'prestige') renderPrestigeShop();
    if (tab === 'production') renderBerryProduction();
    if (tab === 'main') renderTerminalShop();
};

// GENESIS REBOOT - Syst√®me de Production de Baies (EO -> Baies)
// Configuration de production
const BERRY_PRODUCTION_CONFIG = {
    framby: {
        id: 'framby',
        name: 'Baie Framby',
        icon: 'üçì',
        cost: 1000, // EO
        time: 3600000, // 1h en ms
        desc: 'Reconstitution mol√©culaire √† partir de donn√©es brutes.'
    },
    pinap: {
        id: 'pinap',
        name: 'Baie Pinap',
        icon: 'üçç',
        cost: 5000, // EO
        time: 10800000, // 3h en ms
        desc: 'Reconstitution mol√©culaire avanc√©e.'
    },
    ceriz: {
        id: 'ceriz',
        name: 'Baie Ceriz',
        icon: 'üçí',
        cost: 10000, // EO
        time: 21600000, // 6h en ms
        desc: 'Reconstitution mol√©culaire de pointe.'
    }
};

// Initialiser les queues de production si n√©cessaire
function initBerryProduction() {
    if (!gameState.research.berryProduction) {
        gameState.research.berryProduction = {
            queue: [], // [{berryId, startTime, endTime}]
            maxQueue: 3 // Nombre maximum de productions simultan√©es
        };
    }
}

// Fonction pour rendre l'interface de production de baies
function renderBerryProduction() {
    const container = document.getElementById('berry-production-container');
    if (!container) return;
    
    initBerryProduction();
    
    const production = gameState.research.berryProduction || { queue: [], maxQueue: 3 };
    const currentEnergy = gameState.research.energy || 0;
    const now = Date.now();
    
    // Nettoyer les productions termin√©es
    production.queue = production.queue.filter(item => item.endTime > now);
    
    // G√©n√©rer le HTML des baies disponibles
    const berriesHTML = Object.values(BERRY_PRODUCTION_CONFIG).map(berry => {
        const canAfford = currentEnergy >= berry.cost;
        const canQueue = production.queue.length < production.maxQueue;
        const canProduce = canAfford && canQueue;
        
        return `
            <div style="
                background: rgba(30, 30, 50, 0.8);
                border: 2px solid ${canProduce ? '#10b981' : '#444'};
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 15px;
            ">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="font-size: 3em;">${berry.icon}</div>
                    <div style="flex: 1;">
                        <div style="color: white; font-weight: bold; font-size: 1.2em; margin-bottom: 5px;">${berry.name}</div>
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">${berry.desc}</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <div style="color: #a855f7; font-size: 0.9em; margin-bottom: 5px;">Co√ªt: ${berry.cost.toLocaleString()} EO</div>
                        <div style="color: #20d5d2; font-size: 0.9em;">Temps: ${Math.floor(berry.time / 3600000)}h</div>
                    </div>
                    <button onclick="startBerryProduction('${berry.id}')" 
                            class="btn btn--primary" 
                            ${!canProduce ? 'disabled' : ''}
                            style="padding: 10px 20px; ${!canProduce ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        Produire
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    // G√©n√©rer le HTML de la queue de production
    const queueHTML = production.queue.length > 0 ? production.queue.map((item, index) => {
        const berry = BERRY_PRODUCTION_CONFIG[item.berryId];
        if (!berry) return '';
        
        const remaining = Math.max(0, item.endTime - now);
        const progress = Math.min(1, 1 - (remaining / berry.time));
        const hours = Math.floor(remaining / 3600000);
        const minutes = Math.floor((remaining % 3600000) / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        const timeStr = hours > 0 ? `${hours}h ${minutes}m` : minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
        const isComplete = remaining === 0;
        
        return `
            <div style="
                background: ${isComplete ? 'rgba(16, 185, 129, 0.2)' : 'rgba(30, 30, 50, 0.8)'};
                border: 2px solid ${isComplete ? '#10b981' : '#444'};
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 10px;
            ">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                    <div style="font-size: 2.5em;">${berry.icon}</div>
                    <div style="flex: 1;">
                        <div style="color: white; font-weight: bold; font-size: 1.1em;">${berry.name}</div>
                        <div style="color: ${isComplete ? '#10b981' : 'rgba(255,255,255,0.7)'}; font-size: 0.9em;">
                            ${isComplete ? '‚úÖ Termin√© !' : `Temps restant: ${timeStr}`}
                        </div>
                    </div>
                    ${isComplete ? `
                        <button onclick="claimBerryProduction(${index})" class="btn btn--primary" style="padding: 8px 16px;">
                            R√©cup√©rer
                        </button>
                    ` : ''}
                </div>
                ${!isComplete ? `
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${progress * 100}%; height: 100%; background: linear-gradient(90deg, #10b981, #20d5d2); transition: width 0.3s;"></div>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('') : '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">Aucune production en cours</div>';
    
    container.innerHTML = `
        <div style="background: rgba(20, 20, 35, 0.8); border: 2px solid #10b981; border-radius: 12px; padding: 20px;">
            <h3 style="color: #10b981; margin-bottom: 20px; text-align: center;">üå± Production de Baies</h3>
            <p style="color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 20px; font-family: 'VT323', monospace;">
                Reconstitution mol√©culaire √† partir de donn√©es brutes (√ânergie Onirique)
            </p>
            
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(168, 85, 247, 0.1); border-radius: 8px;">
                <div style="color: #a855f7; font-size: 1.1em; font-weight: bold;">
                    √ânergie Onirique: ${Math.floor(currentEnergy).toLocaleString()} EO
                </div>
                <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; margin-top: 5px;">
                    Queue: ${production.queue.length}/${production.maxQueue}
                </div>
            </div>
            
            <div style="margin-bottom: 30px;">
                <h4 style="color: #10b981; margin-bottom: 15px; font-size: 1.1em;">üì¶ Queue de Production</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${queueHTML}
                </div>
            </div>
            
            <div>
                <h4 style="color: #10b981; margin-bottom: 15px; font-size: 1.1em;">üå± Baies Disponibles</h4>
                <div>
                    ${berriesHTML}
                </div>
            </div>
        </div>
    `;
    
    // Auto-refresh toutes les secondes pour mettre √† jour les timers
    if (production.queue.length > 0) {
        setTimeout(() => {
            if (document.getElementById('berry-production-container')) {
                renderBerryProduction();
            }
        }, 1000);
    }
}

// Fonction pour d√©marrer une production de baie
window.startBerryProduction = function(berryId) {
    initBerryProduction();
    
    const berry = BERRY_PRODUCTION_CONFIG[berryId];
    if (!berry) return;
    
    const production = gameState.research.berryProduction;
    const currentEnergy = gameState.research.energy || 0;
    
    // V√©rifications
    if (currentEnergy < berry.cost) {
        showToast(`Pas assez d'√ânergie Onirique ! (${berry.cost.toLocaleString()} EO requis)`, 'error');
        return;
    }
    
    if (production.queue.length >= production.maxQueue) {
        showToast(`Queue pleine ! (${production.maxQueue} productions max)`, 'error');
        return;
    }
    
    // D√©marrer la production
    const now = Date.now();
    
    // GENESIS REBOOT - Appliquer Overclock Vitesse (r√©duction du temps)
    initPokerOverclocks();
    const speedOverclock = gameState.poker.overclocks?.speed || 0;
    const timeReduction = 1 - (speedOverclock * 0.10); // -10% par niveau
    const actualTime = Math.floor(berry.time * Math.max(0.1, timeReduction)); // Minimum 10% du temps original
    
    production.queue.push({
        berryId: berryId,
        startTime: now,
        endTime: now + actualTime
    });
    
    // D√©biter l'EO
    gameState.research.energy -= berry.cost;
    
    // Trigger narratif Porygon
    showPorygonMessage([
        'Reconstitution mol√©culaire en cours...',
        `${berry.name} en production.`
    ], 'progress');
    
    saveGame();
    renderBerryProduction();
    updateResearchUI();
    showToast(`üå± Production de ${berry.name} d√©marr√©e !`, 'success');
};

// Fonction pour r√©cup√©rer une baie produite
window.claimBerryProduction = function(index) {
    initBerryProduction();
    
    const production = gameState.research.berryProduction;
    if (index < 0 || index >= production.queue.length) return;
    
    const item = production.queue[index];
    const now = Date.now();
    
    if (item.endTime > now) {
        showToast('La production n\'est pas encore termin√©e !', 'error');
        return;
    }
    
    const berry = BERRY_PRODUCTION_CONFIG[item.berryId];
    if (!berry) return;
    
    // Ajouter la baie √† l'inventaire
    if (!gameState.inventory[berry.id]) {
        gameState.inventory[berry.id] = 0;
    }
    gameState.inventory[berry.id]++;
    
    // Retirer de la queue
    production.queue.splice(index, 1);
    
    showToast(`‚úÖ ${berry.name} r√©cup√©r√©e !`, 'success');
    saveGame();
    renderBerryProduction();
};

// Fonction pour rendre le BerryDex (Journal Botanique)
function renderBerryDex() {
    let container = document.getElementById('berrydex-content');
    if (!container) {
        container = document.createElement('div');
        container.id = 'berrydex-content';
        container.style.cssText = 'padding: 20px; padding-bottom: 80px;';
        const researchPage = document.getElementById('research-page');
        if (researchPage) {
            const tabContent = document.getElementById('research-tab-content');
            if (tabContent) {
                tabContent.appendChild(container);
            } else {
                researchPage.appendChild(container);
            }
        }
    }
    
    container.style.display = 'block';
    
    // Plantes d√©couvertes (celles qu'on a r√©colt√©es au moins une fois)
    const discoveredPlants = [];
    const undiscoveredPlants = [];
    
    Object.entries(PLANT_TYPES).forEach(([plantId, plantData]) => {
        const inventoryKey = plantId.replace('berry_', '').replace('herb_', '');
        const hasDiscovered = (gameState.inventory[inventoryKey] || 0) > 0;
        
        if (hasDiscovered) {
            discoveredPlants.push({ id: plantId, ...plantData });
        } else {
            // Pour les plantes inconnues, afficher les indices de mutation
            let mutationHint = '';
            if (PLANT_MUTATION_RULES[plantId]) {
                const rule = PLANT_MUTATION_RULES[plantId];
                mutationHint = rule.required.map(req => {
                    const reqPlant = PLANT_TYPES[req];
                    return reqPlant ? reqPlant.icon : '??';
                }).join(' + ');
            }
            undiscoveredPlants.push({ id: plantId, ...plantData, mutationHint });
        }
    });
    
    container.innerHTML = `
        <div style="background: rgba(20, 20, 35, 0.9); border: 2px solid #22c55e; border-radius: 12px; padding: 20px;">
            <h2 style="color: #22c55e; text-align: center; font-size: 2em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);">
                üìñ Journal Botanique
            </h2>
            
            <div style="margin-bottom: 30px;">
                <h3 style="color: #22c55e; margin-bottom: 15px; font-size: 1.3em;">üå± Plantes D√©couvertes (${discoveredPlants.length}/${Object.keys(PLANT_TYPES).length})</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    ${discoveredPlants.map(plant => `
                        <div style="
                            background: rgba(34, 197, 94, 0.1);
                            border: 2px solid #22c55e;
                            border-radius: 10px;
                            padding: 15px;
                            text-align: center;
                        ">
                            <div style="font-size: 3em; margin-bottom: 10px;">${plant.icon}</div>
                            <div style="color: white; font-weight: bold; margin-bottom: 5px;">${plant.name}</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85em; margin-bottom: 5px;">
                                Production: ${plant.production} EO
                            </div>
                            <div style="color: rgba(255,255,255,0.6); font-size: 0.8em;">
                                Temps: ${Math.floor(plant.growthTime / 60000)}min
                            </div>
                            ${plant.mutation ? '<div style="color: #FFD700; font-size: 0.75em; margin-top: 5px;">‚≠ê Mutation</div>' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${undiscoveredPlants.length > 0 ? `
                <div>
                    <h3 style="color: rgba(255,255,255,0.5); margin-bottom: 15px; font-size: 1.2em;">‚ùì Plantes Inconnues (${undiscoveredPlants.length})</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                        ${undiscoveredPlants.map(plant => `
                            <div style="
                                background: rgba(0, 0, 0, 0.3);
                                border: 2px dashed rgba(255,255,255,0.3);
                                border-radius: 10px;
                                padding: 15px;
                                text-align: center;
                                opacity: 0.6;
                            ">
                                <div style="font-size: 3em; margin-bottom: 10px; filter: grayscale(100%);">‚ùì</div>
                                <div style="color: rgba(255,255,255,0.5); font-weight: bold; margin-bottom: 5px;">???</div>
                                ${plant.mutationHint ? `
                                    <div style="color: #FFD700; font-size: 0.9em; margin-top: 10px;">
                                        Indice: ${plant.mutationHint}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                    <div style="font-size: 3em; margin-bottom: 10px;">üéâ</div>
                    <div>Toutes les plantes ont √©t√© d√©couvertes !</div>
                </div>
            `}
        </div>
    `;
}

// Fonction pour mettre √† jour l'affichage des buffs actifs
function updateActiveBuffsDisplay() {
    const buffsContainer = document.getElementById('research-buffs-header');
    if (!buffsContainer || !gameState.research || !gameState.research.anomalies) return;
    
    const now = Date.now();
    const activeEffects = (gameState.research.anomalies.activeEffects || []).filter(e => e.expires > now);
    
    if (activeEffects.length === 0) {
        buffsContainer.innerHTML = '';
        return;
    }
    
    buffsContainer.innerHTML = activeEffects.map((effect, index) => {
        const remaining = Math.max(0, Math.ceil((effect.expires - now) / 1000));
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
        
        // R√©cup√©rer la description compl√®te depuis ANOMALY_TYPES
        const anomalyType = ANOMALY_TYPES[effect.id];
        const fullDesc = anomalyType ? anomalyType.desc : `Multiplicateur x${effect.value}`;
        
        return `
            <div class="active-buff-icon" data-effect-index="${index}" style="
                position: relative;
                width: 50px;
                height: 50px;
                background: rgba(255, 0, 255, 0.3);
                border: 2px solid #ff00ff;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5em;
                cursor: pointer;
                box-shadow: 0 0 20px rgba(255, 0, 255, 0.6);
                transition: transform 0.2s, box-shadow 0.2s;
            " title="${effect.name}: x${effect.value} - ${timeStr} restantes">
                ${effect.icon || '‚ö°'}
                <div style="
                    position: absolute;
                    bottom: -5px;
                    right: -5px;
                    background: rgba(0, 0, 0, 0.8);
                    color: #20d5d2;
                    font-size: 0.6em;
                    padding: 2px 4px;
                    border-radius: 4px;
                    font-family: 'VT323', monospace;
                    min-width: 30px;
                    text-align: center;
                ">${timeStr}</div>
            </div>
        `;
    }).join('');
    
    // Ajouter les event listeners pour afficher la description au clic
    buffsContainer.querySelectorAll('.active-buff-icon').forEach((icon, index) => {
        icon.addEventListener('click', () => {
            const effect = activeEffects[index];
            const anomalyType = ANOMALY_TYPES[effect.id];
            const remaining = Math.max(0, Math.ceil((effect.expires - Date.now()) / 1000));
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            const timeStr = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            
            const fullDesc = anomalyType ? anomalyType.desc : `Multiplicateur x${effect.value}`;
            
            showBuffDescription(effect, fullDesc, timeStr);
        });
        
        // Effet hover
        icon.addEventListener('mouseenter', () => {
            icon.style.transform = 'scale(1.1)';
            icon.style.boxShadow = '0 0 30px rgba(255, 0, 255, 0.9)';
        });
        icon.addEventListener('mouseleave', () => {
            icon.style.transform = 'scale(1)';
            icon.style.boxShadow = '0 0 20px rgba(255, 0, 255, 0.6)';
        });
    });
}

// Fonction pour afficher la description d√©taill√©e d'un buff
function showBuffDescription(effect, description, timeRemaining) {
    // Supprimer l'ancienne description si elle existe
    const oldDesc = document.getElementById('buff-description-popup');
    if (oldDesc) oldDesc.remove();
    
    // Cr√©er la popup de description
    const popup = document.createElement('div');
    popup.id = 'buff-description-popup';
    popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(20, 20, 35, 0.98), rgba(30, 30, 60, 0.98));
        border: 2px solid #ff00ff;
        border-radius: 16px;
        padding: 25px;
        z-index: 10000;
        box-shadow: 0 0 40px rgba(255, 0, 255, 0.8), inset 0 0 20px rgba(255, 0, 255, 0.1);
        max-width: 400px;
        min-width: 300px;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(10px);
    `;
    
    popup.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size: 3em; margin-bottom: 10px; filter: drop-shadow(0 0 10px #ff00ff);">
                ${effect.icon || '‚ö°'}
            </div>
            <h3 style="color: #ff00ff; font-size: 1.5em; margin: 0; text-shadow: 0 0 15px rgba(255, 0, 255, 0.6);">
                ${effect.name}
            </h3>
        </div>
        
        <div style="
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 0, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        ">
            <div style="color: rgba(255,255,255,0.9); font-size: 1.1em; line-height: 1.5; text-align: center;">
                ${description}
            </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">
                <strong style="color: #20d5d2;">Multiplicateur:</strong> x${effect.value}
            </div>
            <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">
                <strong style="color: #20d5d2;">Temps restant:</strong> ${timeRemaining}
            </div>
        </div>
        
        <button onclick="document.getElementById('buff-description-popup')?.remove()" style="
            width: 100%;
            padding: 12px;
            background: rgba(255, 0, 255, 0.2);
            border: 2px solid #ff00ff;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        " onmouseover="this.style.background='rgba(255, 0, 255, 0.4)'; this.style.boxShadow='0 0 25px rgba(255, 0, 255, 0.6)';" onmouseout="this.style.background='rgba(255, 0, 255, 0.2)'; this.style.boxShadow='0 0 15px rgba(255, 0, 255, 0.3)';">
            Fermer
        </button>
    `;
    
    // Ajouter un overlay sombre en arri√®re-plan
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        animation: fadeIn 0.3s ease;
    `;
    overlay.addEventListener('click', () => {
        popup.remove();
        overlay.remove();
    });
    
    document.body.appendChild(overlay);
    document.body.appendChild(popup);
    
    // Fermer avec la touche Escape
    const escapeHandler = (e) => {
        if (e.key === 'Escape') {
            popup.remove();
            overlay.remove();
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
}

window.switchResearchTab = function(tab) {
    // Mettre √† jour les onglets
    document.querySelectorAll('.research-tab').forEach(t => {
        t.classList.remove('active');
        t.style.background = 'rgba(30, 30, 50, 0.5)';
        t.style.borderBottomColor = 'transparent';
        t.style.color = 'rgba(255,255,255,0.6)';
    });
    
    const activeTab = document.getElementById(`tab-${tab}`);
    if (activeTab) {
        activeTab.classList.add('active');
        if (tab === 'prestige') {
            activeTab.style.background = 'rgba(255, 215, 0, 0.2)';
            activeTab.style.borderBottomColor = '#FFD700';
        } else {
            activeTab.style.background = 'rgba(168, 85, 247, 0.3)';
            activeTab.style.borderBottomColor = '#a855f7';
        }
        activeTab.style.color = 'white';
    }
    
    // Afficher le contenu correspondant
    document.getElementById('tab-content-habitats').style.display = tab === 'habitats' ? 'block' : 'none';
    document.getElementById('tab-content-terminal').style.display = tab === 'terminal' ? 'block' : 'none';
    const prestigeContent = document.getElementById('tab-content-prestige');
    if (prestigeContent) {
        prestigeContent.style.display = tab === 'prestige' ? 'block' : 'none';
    }
    
    if (tab === 'terminal') {
        renderTerminalShop();
        // V√©rifier si on doit afficher le dialogue Terminal vide
        const automationLevel = gameState.research?.automationLevel || 0;
        if (automationLevel === 0 && !gameState.narrative.history.includes('terminal_empty')) {
            setTimeout(() => {
                startDialogue('terminal_empty');
            }, 500);
        }
    } else if (tab === 'prestige') {
        renderPrestigeShop();
    }
};

function renderTerminalShop() {
    const container = document.getElementById('terminal-shop');
    if (!container) {
        console.error("Terminal shop container not found!");
        return;
    }
    
    try {
        console.log("Rendering terminal shop...");
        
        // V√©rifier que gameState.research existe
        if (!gameState || !gameState.research) {
            console.error("gameState.research n'est pas d√©fini!");
            container.innerHTML = `
                <div style="background: rgba(20, 20, 35, 0.8); border: 2px solid #ef4444; border-radius: 12px; padding: 20px; text-align: center;">
                    <h3 style="color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è Erreur</h3>
                    <p style="color: rgba(255,255,255,0.7);">Le syst√®me de recherche n'est pas initialis√©. Veuillez rafra√Æchir la page.</p>
                </div>
            `;
            return;
        }
        
        // V√©rifier que TCG_BOOSTER_TYPES est d√©fini, sinon utiliser une valeur par d√©faut
        let boosterTypes = typeof TCG_BOOSTER_TYPES !== 'undefined' ? TCG_BOOSTER_TYPES : null;
        if (!boosterTypes) {
            console.warn("TCG_BOOSTER_TYPES n'est pas d√©fini, utilisation de valeurs par d√©faut");
            boosterTypes = {
                'common': { name: 'Booster Standard', cost: 100, cards: 3, rareChance: 0.1 },
                'rare': { name: 'Booster Premium', cost: 500, cards: 5, rareChance: 0.3 },
                'legendary': { name: 'Booster L√©gendaire', cost: 2000, cards: 7, rareChance: 0.7 }
            };
        }
        
        // Initialiser les upgrades si n√©cessaire
        if (!gameState.research.upgrades) {
            gameState.research.upgrades = {
                mouse_driver: 0,
                gpu_overclock: 0,
                virus_scan: 0
            };
        }
        
        const upgrades = [
            {
                id: 'mouse_driver',
                name: 'Souris Optique',
                icon: 'üñ±Ô∏è',
                desc: 'Click Power +10% par niveau',
                baseCost: 100,
                costMult: 1.5,
                effect: (level) => `+${level * 10}% Click Power`
            },
            {
                id: 'gpu_overclock',
                name: 'Overclock GPU',
                icon: '‚ö°',
                desc: 'Production Passive +5% par niveau',
                baseCost: 500,
                costMult: 1.6,
                effect: (level) => `+${level * 5}% Production`
            },
            {
                id: 'virus_scan',
                name: 'Anti-Virus',
                icon: 'üõ°Ô∏è',
                desc: 'Chance Critique Click +1% par niveau',
                baseCost: 1000,
                costMult: 2.0,
                effect: (level) => `+${level}% Critique`
            }
        ];
        
        // G√©n√©rer le HTML des boosters avec gestion d'erreur
        let boostersHTML = '';
        try {
            const boosterEntries = Object.entries(boosterTypes);
            if (boosterEntries.length === 0) {
                boostersHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center;">Aucun booster disponible</p>';
            } else {
                boostersHTML = boosterEntries.map(([type, booster]) => {
                    try {
                        const canAfford = (gameState.research.energy || 0) >= (booster.cost || 0);
                        const totalCards = Object.keys(gameState.tcg?.cards || {}).length;
                        
                        return `
                            <div style="background: rgba(30, 30, 50, 0.6); border: 2px solid ${canAfford ? '#FFD700' : '#444'}; border-radius: 10px; padding: 12px; display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="color: white; font-weight: bold; font-size: 1em; margin-bottom: 5px;">${booster.name || 'Booster'}</div>
                                    <div style="color: rgba(255,255,255,0.6); font-size: 0.85em;">${booster.cards || 0} cartes ‚Ä¢ ${Math.round((booster.rareChance || 0) * 100)}% rare</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #20d5d2; font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">
                                        ${(booster.cost || 0).toLocaleString()} EO
                                    </div>
                                    <button onclick="openTCGBooster('${type}')" 
                                            class="btn btn--primary" 
                                            ${!canAfford ? 'disabled' : ''}
                                            style="padding: 8px 16px; ${!canAfford ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                        Ouvrir
                                    </button>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error(`Erreur lors du rendu du booster ${type}:`, e);
                        return '';
                    }
                }).filter(html => html !== '').join('');
            }
        } catch (e) {
            console.error("Erreur lors de la g√©n√©ration des boosters:", e);
            boostersHTML = '<p style="color: #ef4444; text-align: center;">Erreur lors du chargement des boosters</p>';
        }
        
        // G√©n√©rer le HTML des upgrades avec gestion d'erreur
        let upgradesHTML = '';
        try {
            upgradesHTML = upgrades.map(upgrade => {
                try {
                    const level = gameState.research.upgrades[upgrade.id] || 0;
                    const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, level));
                    const canAfford = (gameState.research.energy || 0) >= cost;
                    
                    return `
                        <div class="terminal-upgrade-card" style="background: rgba(30, 30, 50, 0.6); border: 2px solid ${canAfford ? '#a855f7' : '#444'}; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 2em;">${upgrade.icon}</span>
                                    <div>
                                        <div style="color: white; font-weight: bold; font-size: 1.1em;">${upgrade.name}</div>
                                        <div style="color: rgba(255,255,255,0.6); font-size: 0.9em;">${upgrade.desc}</div>
                                    </div>
                                </div>
                                <div style="color: #a855f7; font-size: 0.9em; margin-top: 5px;">
                                    Niveau ${level} ${level > 0 ? `| ${upgrade.effect(level)}` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #20d5d2; font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                                    ${cost.toLocaleString()} EO
                                </div>
                                <button onclick="buyTerminalUpgrade('${upgrade.id}')" 
                                        class="btn btn--primary" 
                                        ${!canAfford ? 'disabled' : ''}
                                        style="padding: 8px 16px; ${!canAfford ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                    ${level === 0 ? 'Acheter' : 'Am√©liorer'}
                                </button>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error(`Erreur lors du rendu de l'upgrade ${upgrade.id}:`, e);
                    return '';
                }
            }).filter(html => html !== '').join('');
        } catch (e) {
            console.error("Erreur lors de la g√©n√©ration des upgrades:", e);
            upgradesHTML = '<p style="color: #ef4444; text-align: center;">Erreur lors du chargement des upgrades</p>';
        }
        
        // Calculer le nombre total de cartes TCG
        const totalCards = Object.keys(gameState.tcg?.cards || {}).length;
        
        // G√©n√©rer le HTML final
        container.innerHTML = `
            <div style="background: rgba(20, 20, 35, 0.8); border: 2px solid #7d5fff; border-radius: 12px; padding: 20px;">
                <h3 style="color: #a855f7; margin-bottom: 20px; text-align: center;">üíª Terminal Genesis</h3>
                <p style="color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 20px; font-family: 'VT323', monospace;">
                    Am√©liorez votre infrastructure avec l'√ânergie Onirique
                </p>
                
                <!-- Section Boosters TCG -->
                <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid rgba(125, 95, 255, 0.3);">
                    <h4 style="color: #FFD700; margin-bottom: 15px; text-align: center; font-size: 1.2em;">üé¥ Boosters TCG</h4>
                    <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 15px; font-size: 0.9em;">
                        Ouvrez des boosters pour obtenir des Cartes Full Art et √©quipez-les comme Mascottes !
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${boostersHTML}
                    </div>
                    ${totalCards > 0 ? `
                        <div style="text-align: center; margin-top: 15px; color: rgba(255,255,255,0.7); font-size: 0.9em;">
                            üìö Collection : ${totalCards} carte${totalCards > 1 ? 's' : ''}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Section Automatisation (Puces M√©moire) -->
                <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid rgba(125, 95, 255, 0.3);">
                    <h4 style="color: #20d5d2; margin-bottom: 15px; text-align: center; font-size: 1.2em;">üíæ Automatisation</h4>
                    <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 15px; font-size: 0.9em;">
                        Achetez des Chercheurs avec des Puces M√©moire obtenues en mode Exp√©dition
                    </p>
                    <div style="text-align: center; margin-bottom: 15px; padding: 10px; background: rgba(32, 213, 210, 0.1); border-radius: 8px;">
                        <div style="color: #20d5d2; font-size: 1.1em; font-weight: bold;">
                            üíæ Puces M√©moire : ${(gameState.inventory.memory_chips || 0).toLocaleString()}
                        </div>
                    </div>
                    ${renderAutomationShop()}
                </div>
                
                <h4 style="color: #a855f7; margin-bottom: 15px; text-align: center; font-size: 1.2em;">‚öôÔ∏è Upgrades Syst√®me</h4>
                ${(gameState.research?.automationLevel || 0) === 0 ? `
                    <div style="background: rgba(168, 85, 247, 0.2); border: 2px solid #a855f7; border-radius: 10px; padding: 12px; margin-bottom: 15px; text-align: center;">
                        <p style="color: rgba(255,255,255,0.8); margin: 0; font-size: 0.9em;">
                            üí° Les upgrades sont disponibles m√™me sans automatisation !<br>
                            L'automatisation augmente la production passive (+10% par niveau).
                        </p>
                    </div>
                ` : ''}
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    ${upgradesHTML}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error("Erreur critique dans renderTerminalShop:", error);
        container.innerHTML = `
            <div style="background: rgba(20, 20, 35, 0.8); border: 2px solid #ef4444; border-radius: 12px; padding: 20px; text-align: center;">
                <h3 style="color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è Erreur de Rendu</h3>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 10px;">Une erreur s'est produite lors du chargement du Terminal.</p>
                <p style="color: rgba(255,255,255,0.5); font-size: 0.9em;">Erreur: ${error.message}</p>
                <button onclick="renderTerminalShop()" class="btn btn--primary" style="margin-top: 15px;">R√©essayer</button>
            </div>
        `;
    }
}

// ===== FONCTIONS D'AUTOMATISATION (Puces M√©moire) =====

// Fonction pour rendre le shop d'automatisation
function renderAutomationShop() {
    const memoryChips = gameState.inventory.memory_chips || 0;
    const researchers = gameState.research.automation?.researchers || 0;
    const autoClickers = gameState.research.automation?.autoClickers || 0;
    
    // Co√ªts exponentiels
    const researcherCost = 10 * Math.pow(2, researchers);
    const autoClickerCost = 20 * Math.pow(2, autoClickers);
    
    return `
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div style="background: rgba(30, 30, 50, 0.6); border: 2px solid ${memoryChips >= researcherCost ? '#20d5d2' : '#444'}; border-radius: 10px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="font-size: 2em;">üë®‚Äçüî¨</span>
                            <div>
                                <div style="color: white; font-weight: bold; font-size: 1.1em;">Chercheur</div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.9em;">Auto-clic toutes les 5 secondes</div>
                            </div>
                        </div>
                        <div style="color: #20d5d2; font-size: 0.9em; margin-top: 5px;">
                            Poss√©d√© : ${researchers} | Production : +${researchers * 10} EO/sec
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #20d5d2; font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                            ${researcherCost.toLocaleString()} üíæ
                        </div>
                        <button onclick="buyResearcher()" 
                                class="btn btn--primary" 
                                ${memoryChips < researcherCost ? 'disabled' : ''}
                                style="padding: 8px 16px; ${memoryChips < researcherCost ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            Acheter
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="background: rgba(30, 30, 50, 0.6); border: 2px solid ${memoryChips >= autoClickerCost ? '#20d5d2' : '#444'}; border-radius: 10px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="font-size: 2em;">ü§ñ</span>
                            <div>
                                <div style="color: white; font-weight: bold; font-size: 1.1em;">Auto-Clicker</div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.9em;">Clic automatique toutes les 2 secondes</div>
                            </div>
                        </div>
                        <div style="color: #20d5d2; font-size: 0.9em; margin-top: 5px;">
                            Poss√©d√© : ${autoClickers} | Clics : +${autoClickers * 0.5}/sec
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #20d5d2; font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                            ${autoClickerCost.toLocaleString()} üíæ
                        </div>
                        <button onclick="buyAutoClicker()" 
                                class="btn btn--primary" 
                                ${memoryChips < autoClickerCost ? 'disabled' : ''}
                                style="padding: 8px 16px; ${memoryChips < autoClickerCost ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                            Acheter
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Fonction pour acheter un Chercheur
window.buyResearcher = function() {
    if (!gameState.research.automation) {
        gameState.research.automation = { researchers: 0, autoClickers: 0 };
    }
    
    const researchers = gameState.research.automation.researchers || 0;
    const cost = 10 * Math.pow(2, researchers);
    const memoryChips = gameState.inventory.memory_chips || 0;
    
    if (memoryChips < cost) {
        showToast(`Pas assez de Puces M√©moire ! (${cost} requis)`, 'error');
        return;
    }
    
    gameState.inventory.memory_chips -= cost;
    gameState.research.automation.researchers = researchers + 1;
    
    // D√©marrer l'auto-clic si pas d√©j√† d√©marr√©
    if (!window.researcherInterval) {
        startResearcherAutoClick();
    }
    
    saveGame();
    renderTerminalShop();
    showToast(`üë®‚Äçüî¨ Chercheur achet√© ! Production passive augment√©e.`, 'success');
};

// Fonction pour acheter un Auto-Clicker
window.buyAutoClicker = function() {
    if (!gameState.research.automation) {
        gameState.research.automation = { researchers: 0, autoClickers: 0 };
    }
    
    const autoClickers = gameState.research.automation.autoClickers || 0;
    const cost = 20 * Math.pow(2, autoClickers);
    const memoryChips = gameState.inventory.memory_chips || 0;
    
    if (memoryChips < cost) {
        showToast(`Pas assez de Puces M√©moire ! (${cost} requis)`, 'error');
        return;
    }
    
    gameState.inventory.memory_chips -= cost;
    gameState.research.automation.autoClickers = autoClickers + 1;
    
    // D√©marrer l'auto-clic si pas d√©j√† d√©marr√©
    if (!window.autoClickerInterval) {
        startAutoClicker();
    }
    
    saveGame();
    renderTerminalShop();
    showToast(`ü§ñ Auto-Clicker achet√© ! Clics automatiques activ√©s.`, 'success');
};

// Fonction pour d√©marrer l'auto-clic des Chercheurs (OPTIMIS√âE pour performance)
function startResearcherAutoClick() {
    // Nettoyer l'ancien interval si existe
    if (window.researcherInterval) {
        clearInterval(window.researcherInterval);
        window.researcherInterval = null;
    }
    
    window.researcherInterval = setInterval(() => {
        if (!gameState.research || !gameState.research.unlocked) {
            if (window.researcherInterval) {
                clearInterval(window.researcherInterval);
                window.researcherInterval = null;
            }
            return;
        }
        
        const researchers = gameState.research.automation?.researchers || 0;
        if (researchers === 0) {
            if (window.researcherInterval) {
                clearInterval(window.researcherInterval);
                window.researcherInterval = null;
            }
            return;
        }
        
        // Chaque chercheur g√©n√®re 10 EO toutes les 5 secondes
        // OPTIMISATION : Accumuler la production pour √©viter trop de mises √† jour UI
        const production = researchers * 10;
        gameState.research.energy += production;
        gameState.research.totalEnergyProduced += production;
        
        // Mettre √† jour l'UI seulement toutes les secondes pour √©viter la surcharge
        const now = Date.now();
        if (!window.lastResearcherUIUpdate) window.lastResearcherUIUpdate = now;
        if (now - window.lastResearcherUIUpdate >= 1000) {
            updateResearchUI();
            window.lastResearcherUIUpdate = now;
        }
    }, 5000); // Toutes les 5 secondes
}

// Fonction pour d√©marrer l'auto-clic des Auto-Clickers (OPTIMIS√âE pour performance)
function startAutoClicker() {
    // Nettoyer l'ancien interval si existe
    if (window.autoClickerInterval) {
        clearInterval(window.autoClickerInterval);
        window.autoClickerInterval = null;
    }
    
    window.autoClickerInterval = setInterval(() => {
        if (!gameState.research || !gameState.research.unlocked) {
            if (window.autoClickerInterval) {
                clearInterval(window.autoClickerInterval);
                window.autoClickerInterval = null;
            }
            return;
        }
        
        const autoClickers = gameState.research.automation?.autoClickers || 0;
        if (autoClickers === 0) {
            if (window.autoClickerInterval) {
                clearInterval(window.autoClickerInterval);
                window.autoClickerInterval = null;
            }
            return;
        }
        
        // OPTIMISATION CRITIQUE : Calculer tous les clics en une seule fois au lieu de boucler
        // Cela √©vite d'appeler clickCrystal() 50 fois et de cr√©er 50 particules/effets visuels
        const baseClick = 1;
        const collectionBonus = Math.max(1, Math.floor(gameState.totalCaught / 10));
        const mouseDriverLevel = (gameState.research._legacy?.upgrades?.mouse_driver || gameState.research.upgrades?.mouse_driver || 0);
        const mouseDriverBonus = 1 + (mouseDriverLevel * 0.1);
        const virusScanLevel = (gameState.research._legacy?.upgrades?.virus_scan || gameState.research.upgrades?.virus_scan || 0);
        const critChance = virusScanLevel * 0.01;
        
        // Multiplicateur des anomalies actives
        let anomalyClickMult = 1;
        const nowTime = Date.now();
        if (gameState.research.anomalies && gameState.research.anomalies.activeEffects) {
            gameState.research.anomalies.activeEffects.forEach(effect => {
                if (effect.expires > nowTime) {
                    if (effect.id === 'click_frenzy' || effect.id === 'chain') {
                        anomalyClickMult *= effect.value;
                    }
                }
            });
        }
        
        // Calculer le gain par clic
        const gainPerClick = baseClick * collectionBonus * gameState.research.clickMultiplier * mouseDriverBonus * anomalyClickMult;
        
        // Appliquer les crits (approximation : moyenne de crits sur tous les clics)
        const expectedCrits = autoClickers * critChance;
        const critBonus = 1 + expectedCrits; // Si 10% crit et 50 clickers = +5 bonus en moyenne
        const totalGain = gainPerClick * autoClickers * critBonus;
        
        // Appliquer directement sans effets visuels pour les auto-clickers
        gameState.research.energy += totalGain;
        gameState.research.totalEnergyProduced += totalGain;
        gameState.research.anomalies.totalClicked += autoClickers;
        
        // Mettre √† jour l'UI seulement toutes les secondes
        const now = Date.now();
        if (!window.lastAutoClickerUIUpdate) window.lastAutoClickerUIUpdate = now;
        if (now - window.lastAutoClickerUIUpdate >= 1000) {
            updateResearchUI();
            window.lastAutoClickerUIUpdate = now;
        }
    }, 2000); // Toutes les 2 secondes
}

window.buyTerminalUpgrade = function(upgradeId) {
    if (!gameState.research.upgrades) {
        gameState.research.upgrades = {
            mouse_driver: 0,
            gpu_overclock: 0,
            virus_scan: 0
        };
    }
    
    const upgrades = {
        mouse_driver: { baseCost: 100, costMult: 1.5 },
        gpu_overclock: { baseCost: 500, costMult: 1.6 },
        virus_scan: { baseCost: 1000, costMult: 2.0 }
    };
    
    const upgrade = upgrades[upgradeId];
    if (!upgrade) return;
    
    const level = gameState.research.upgrades[upgradeId] || 0;
    const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, level));
    
    if (gameState.research.energy < cost) {
        showToast('Pas assez d\'√ânergie Onirique !', 'error');
        return;
    }
    
    gameState.research.energy -= cost;
    gameState.research.upgrades[upgradeId] = level + 1;
    
    // Appliquer les effets
    if (upgradeId === 'mouse_driver') {
        gameState.research.clickMultiplier = 1 + ((gameState.research.upgrades.mouse_driver || 0) * 0.1);
    }
    
    saveGame();
    renderTerminalShop();
    updateResearchUI();
    
    const upgradeNames = {
        mouse_driver: 'Souris Optique',
        gpu_overclock: 'Overclock GPU',
        virus_scan: 'Anti-Virus'
    };
    
    showToast(`‚úÖ ${upgradeNames[upgradeId]} niveau ${gameState.research.upgrades[upgradeId]} achet√© !`, 'success');
    
    // Trigger narratif
    if (typeof startDialogue === 'function') {
        setTimeout(() => startDialogue('shop_purchase'), 500);
    }
};

window.buyAutomationUpgrade = function() {
    const processorChips = gameState.inventory.processor_chips || 0;
    const cost = 10 * Math.pow(2, gameState.research.automationLevel || 0);
    
    if (processorChips < cost) {
        showToast(`Pas assez de Processor Chips ! (${cost} requis)`, 'error');
        return;
    }
    
    gameState.inventory.processor_chips -= cost;
    gameState.research.automationLevel = (gameState.research.automationLevel || 0) + 1;
    
    // Bonus : +10% production par niveau d'automatisation
    const bonus = 1 + (gameState.research.automationLevel * 0.1);
    
    saveGame();
    renderResearchPage();
    showToast(`‚öôÔ∏è Automatisation niveau ${gameState.research.automationLevel} d√©bloqu√© ! (+${Math.round((bonus - 1) * 100)}% production)`, 'success');
    
    // Trigger narratif
    if (typeof startDialogue === 'function') {
        setTimeout(() => startDialogue('shop_purchase'), 500);
    }
};

document.addEventListener('DOMContentLoaded',()=>{
    if(!gameState.incubation)gameState.incubation={eggs:[],incubators:1};
    if(!gameState.catchbot)gameState.catchbot={active:false,lastCatch:Date.now(),storage:[]};
    if(!gameState.golden)gameState.golden=new Set();
    if(!gameState.inventory.eggs)gameState.inventory.eggs=[];
    if(!gameState.research)gameState.research={unlocked:false,energy:0,totalEnergyProduced:0,clickMultiplier:1,lastSaveTime:Date.now(),automationLevel:0,upgrades:{mouse_driver:0,gpu_overclock:0,virus_scan:0},habitats:{'forest':{name:'For√™t',type:'Grass',level:0,unlocked:true,slots:1,assigned:[]},'ocean':{name:'Oc√©an',type:'Water',level:0,unlocked:false,slots:1,assigned:[]},'cave':{name:'Grotte',type:'Rock',level:0,unlocked:false,slots:1,assigned:[]},'volcano':{name:'Volcan',type:'Fire',level:0,unlocked:false,slots:1,assigned:[]},'power_plant':{name:'Centrale',type:'Electric',level:0,unlocked:false,slots:1,assigned:[]},'graveyard':{name:'Cimeti√®re',type:'Ghost',level:0,unlocked:false,slots:1,assigned:[]}}};
    if(!gameState.narrative)gameState.narrative={queue:[],history:[],currentSpeaker:'porygon'};
    if(!gameState.tcg)gameState.tcg={unlocked:false,cards:{},boostersOpened:0};
    if(!gameState.inventory.processor_chips)gameState.inventory.processor_chips=0;
    loadGame();
    
    // GENESIS REBOOT - Initialisation du syst√®me narratif
    if (!gameState.system) {
        gameState.system = {
            currentPhase: 'BOOT_SEQUENCE',
            integrity: 0,
            glitchLevel: 1.0,
            porygonMood: 'PANIC',
            narrativeFlags: []
        };
    }
    
    // Cr√©er le widget Porygon
    createPorygonWidget();
    
    // ‚úÖ CORRECTION : Ne pas afficher la popup "System failure" si l'intro n'a pas encore √©t√© vue
    // S√©quence de boot (premi√®re fois seulement, mais seulement apr√®s l'intro)
    if (gameState.captured.size === 0 && !gameState.system.narrativeFlags.includes('intro_boot_sequence') && gameState.introSeen) {
        setTimeout(() => {
            triggerNarrative('intro_boot_sequence');
            // Appliquer l'effet visuel glitch√© au d√©but
            document.body.classList.add('system-critical');
        }, 500);
    } else {
        // ‚úÖ CORRECTION : Ne pas appliquer le glitch si l'intro n'a pas √©t√© vue
        if (gameState.introSeen) {
            // V√©rifier l'int√©grit√© du syst√®me
            checkSystemIntegrity();
            // Mettre √† jour l'effet visuel selon l'int√©grit√©
            updateSystemVisuals();
        } else {
            // Pendant l'intro, retirer toutes les classes de glitch
            document.body.classList.remove('system-critical', 'system-unstable', 'system-stable', 'system-optimized', 'system-advanced');
        }
    }
    
    // V√©rifier les d√©blocages de modules
    checkModuleUnlocks();
    if(gameState.level>=5)gameState.research.unlocked=true;
    if(gameState.research&&gameState.research.unlocked)applyOfflineProduction();
    updateUI();
    updateUIFishing();
    renderBlindBoxHistory();
    renderBuddyHomeDisplay();
    renderShop();
    renderInventory();
    renderPokedexGrid();
    renderAllQuests();
    updateProfileStats();
    renderActiveBoosts();
    renderCaptureHistory();
    renderFishingHistory();
    checkAndUnlockCustomization();
    updateProfileDisplay();
    updateTopBarDisplay();
    updateCustomizationNotification();
    // CORRECTION : Ne pas d√©clencher les dialogues au chargement si le joueur est d√©j√† avanc√©
    // Les dialogues seront d√©clench√©s naturellement lors de la progression
    // checkNarrativeTriggers(); // D√©sactiv√© au chargement pour √©viter les r√©p√©titions
    const spawnBtn=document.getElementById('spawn-btn');
    if(spawnBtn){
        const spawnBtnText=document.getElementById('spawn-btn-text');
        if(spawnBtnText){
            spawnBtnText.innerHTML=`${getItemIconDisplay('pokeball','1.2em')} Capturer un Pok√©mon`;
        }
        const spawnHandler=function(e){
            if(e){
                e.preventDefault();
                e.stopPropagation();
            }
            if(typeof window.spawnPokemon==='function'){
                window.spawnPokemon();
            }else if(typeof spawnPokemon==='function'){
                spawnPokemon();
            }else{
                console.error('spawnPokemon n\'est pas d√©finie');
            }
        };
        spawnBtn.onclick=spawnHandler;
        spawnBtn.removeEventListener('click',spawnHandler);
        spawnBtn.addEventListener('click',spawnHandler,{capture:true,passive:false});
        console.log('‚úÖ Bouton spawn attach√©:',spawnBtn,typeof window.spawnPokemon);
    }
    setInterval(()=>{
        gameState.totalPlaytime+=30000;
        updateBoosts();
        updateBlindBoxTimer();
        updateFishingTokens();
        updateExpeditionTicketTimer();
        updateCatchbot();
        if(gameState.research&&gameState.research.unlocked){
            const production=calculateProduction();
            gameState.research.energy+=production;
            gameState.research.totalEnergyProduced+=production;
            gameState.research.lastSaveTime=Date.now();
            if(!gameState.research.energy24hResetTime){
                gameState.research.energy24hResetTime=Date.now();
                gameState.research.energy24h=0;
            }
            const now=Date.now();
            const timeSinceReset=now-gameState.research.energy24hResetTime;
            if(timeSinceReset>=24*60*60*1000){
                gameState.research.energy24h=0;
                gameState.research.energy24hResetTime=now;
            }
            gameState.research.energy24h+=production;
            updateResearchUI();
        }
        saveGame();
    },1000);
    setInterval(()=>{
        saveGame();
    },30000);
    console.log('‚ú® V10.0 - POK√âMON COLLECTOR V10.0 CHARG√â AVEC SUCC√àS! (Syst√®me Narratif + Centre de Recherche + Polish)');
});

const style=document.createElement('style');style.textContent=`
:root{
--expedition-bg-main:#f0f4ff;
--expedition-bg-secondary:#faf8ff;
--expedition-accent-primary:#7d5fff;
--expedition-accent-secondary:#20d5d2;
--expedition-accent-tertiary:#ff6b9d;
--expedition-gradient-header:linear-gradient(135deg,#7d5fff 0%,#a855f7 50%,#20d5d2 100%);
--expedition-gradient-panel:linear-gradient(180deg,rgba(255,255,255,0.95) 0%,rgba(250,248,255,0.9) 100%);
--expedition-gradient-button:linear-gradient(135deg,#7d5fff 0%,#9333ea 100%);
--expedition-shadow-sm:0 2px 8px rgba(125,95,255,0.08);
--expedition-shadow-md:0 4px 16px rgba(125,95,255,0.12);
--expedition-shadow-lg:0 8px 24px rgba(125,95,255,0.18);
--expedition-shadow-glow:0 0 24px rgba(125,95,255,0.3);
--expedition-text-primary:#2d1b69;
--expedition-text-secondary:#6b5b95;
--expedition-text-muted:#9d8ec4;
--chain-tier-0:#cbd5e1;
--chain-tier-1:#4ade80;
--chain-tier-2:#3b82f6;
--chain-tier-3:#a855f7;
--chain-tier-4:#fbbf24;
--emotion-success:#10b981;
--emotion-warning:#f59e0b;
--emotion-danger:#ef4444;
--emotion-shiny:#fbbf24;
--emotion-legendary:#a855f7;
}
#expedition-page{background:var(--expedition-bg-main)!important;}
#expedition-container{background:var(--expedition-bg-main)!important;padding:20px;}
@keyframes slideInRight{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
@keyframes slideOutRight{from{transform:translateX(0);opacity:1;}to{transform:translateX(400px);opacity:0;}}

/* Animations Balatro-style pour transitions */
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes fadeOut{from{opacity:1;}to{opacity:0;}}
@keyframes slideUp{from{transform:translateY(30px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes scaleBounce{0%{transform:scale(0.5);opacity:0;}50%{transform:scale(1.15);}100%{transform:scale(1);opacity:1;}}
@keyframes screenShake{0%,100%{transform:translateX(0);}10%,30%,50%,70%,90%{transform:translateX(-2px);}20%,40%,60%,80%{transform:translateX(2px);}}
@keyframes screenShakeStrong{0%,100%{transform:translateX(0);}10%,30%,50%,70%,90%{transform:translateX(-5px) rotate(-0.5deg);}20%,40%,60%,80%{transform:translateX(5px) rotate(0.5deg);}}
@keyframes fireRise{0%{transform:translateY(0) scale(1);opacity:1;}100%{transform:translateY(-100vh) scale(0.3);opacity:0;}}
@keyframes confettiBurst{0%{transform:translate(0,0) rotate(0deg) scale(1);opacity:1;}100%{transform:translate(var(--tx,200px),var(--ty,200px)) rotate(720deg) scale(0);opacity:0;}}
@keyframes goldFloat{0%{transform:translate(0,0) scale(1);opacity:0.9;}50%{opacity:1;}100%{transform:translate(var(--tx,50px),var(--ty,-100px)) scale(0.5);opacity:0;}}
@keyframes badgeReveal{0%{transform:scale(0) rotate(-180deg);opacity:0;}50%{transform:scale(1.3) rotate(0deg);}100%{transform:scale(1) rotate(0deg);opacity:1;}}
@keyframes badgeSpin{0%{transform:rotate(0deg) scale(0);}50%{transform:rotate(180deg) scale(1.2);}100%{transform:rotate(360deg) scale(1);}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes bounceIn{0%{transform:scale(0.3);opacity:0;}50%{transform:scale(1.05);}70%{transform:scale(0.9);}100%{transform:scale(1);opacity:1;}}
@keyframes shake{0%,100%{transform:rotate(-5deg);}50%{transform:rotate(5deg);}}
@keyframes pokeball-shake{0%,100%{transform:rotate(0deg) scale(1);}25%{transform:rotate(-15deg) scale(1.1);}75%{transform:rotate(15deg) scale(1.1);}}
@keyframes eggShake{0%,100%{transform:rotate(-5deg);}50%{transform:rotate(5deg);}}
@keyframes boxShake{0%,100%{transform:rotate(-3deg);}50%{transform:rotate(3deg);}}
@keyframes boxGlow{0%,100%{filter:drop-shadow(0 0 20px rgba(255,215,0,0.5));}50%{filter:drop-shadow(0 0 40px rgba(255,215,0,1));}}
@keyframes explode{0%{transform:scale(1);opacity:1;}100%{transform:scale(3);opacity:0;}}
@keyframes fishingRod{0%,100%{transform:rotate(-10deg);}50%{transform:rotate(10deg);}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.7;}}
@keyframes evolutionPulse{0%,100%{transform:scale(1);filter:brightness(1);}50%{transform:scale(1.2);filter:brightness(1.5);}}
@keyframes tokenPop{0%{transform:translate(-50%,-50%)scale(0);opacity:0;}50%{transform:translate(-50%,-50%)scale(1.2);opacity:1;}100%{transform:translate(-50%,-50%)scale(1)translateY(-50px);opacity:0;}
@keyframes shinyFloat{0%,100%{transform:translateY(0px);}50%{transform:translateY(-15px);}}
@keyframes shinyGlow{0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.5),0 0 40px rgba(255,215,0,0.3);}50%{box-shadow:0 0 30px rgba(255,215,0,0.8),0 0 60px rgba(255,215,0,0.5),0 0 80px rgba(255,215,0,0.3);}}
@keyframes shinyParticles{0%{opacity:0;transform:translate(0,0)scale(0);}50%{opacity:1;transform:translate(var(--tx),var(--ty))scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty))scale(0);}}
@keyframes starTwinkle{0%,100%{opacity:0.3;transform:scale(0.8);}50%{opacity:1;transform:scale(1.2);}}
@keyframes chainBump{0%{transform:scale(1) translateY(0);}40%{transform:scale(1.3) translateY(-15px);}60%{transform:scale(1.2) translateY(-10px);}100%{transform:scale(1) translateY(0);}}
@keyframes chainPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
@keyframes chainShatter{0%,100%{transform:translateX(0);}10%,30%,50%,70%,90%{transform:translateX(-8px);}20%,40%,60%,80%{transform:translateX(8px);}}
@keyframes particleBurst{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0);}}
@keyframes doorSlideIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
@keyframes flashFade{0%{opacity:1;}100%{opacity:0;}}
@keyframes captureFlash{0%{opacity:0;transform:scale(0.8);}50%{opacity:1;transform:scale(1.1);}100%{opacity:0;transform:scale(1);}}
@keyframes badgePulse{0%,100%{transform:translateX(50%) scale(1);}50%{transform:translateX(50%) scale(1.05);}}
@keyframes confettiFall{0%{transform:translateY(0) rotate(0deg);opacity:1;}100%{transform:translateY(100vh) rotate(720deg);opacity:0;}}
@keyframes titleBounce{0%{opacity:0;transform:scale(0.5) translateY(-30px);}60%{transform:scale(1.1) translateY(0);}100%{opacity:1;transform:scale(1) translateY(0);}}
@keyframes statPop{0%{opacity:0;transform:scale(0.8) translateY(20px);}100%{opacity:1;transform:scale(1) translateY(0);}}
@keyframes rewardPop{0%{opacity:0;transform:scale(0) rotate(-10deg);}100%{opacity:1;transform:scale(1) rotate(0);}}
@keyframes pokemonSlideIn{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
.captured-pokemon.shiny{border-color:var(--emotion-shiny)!important;box-shadow:0 0 20px rgba(251,191,36,0.3)!important;}
.captured-pokemon.target{border-color:var(--expedition-accent-tertiary)!important;box-shadow:0 0 20px rgba(255,107,157,0.3)!important;}
`;
document.head.appendChild(style);

// ===== SYST√àME D'INVENTAIRE AVEC VENTE (V9.0) =====

window.renderInventory = function() {
    const grid = document.getElementById('inventory-grid');
    if (!grid) return;
    
    const showUnowned = document.getElementById('show-unowned')?.checked || false;
    grid.innerHTML = '';
    
    // D√©finir les cat√©gories
    const categories = {
        balls: { name: '‚öæ Balls', items: ['pokeball', 'greatball', 'ultraball', 'masterball', 'diveball'] },
        berries: { name: 'üçì Baies', items: ['framby', 'pinap', 'ceriz'] },
        boosts: { name: '‚ú® Boosts', items: ['incensefleur', 'marin_lure', 'exp_charm', 'lucky_charm', 'charm_collection', 'legendary_radar'] },
        stones: { name: 'üíé Pierres d\'√âvolution', items: ['fire_stone', 'water_stone', 'thunder_stone', 'moon_stone', 'leaf_stone'] },
        lootboxes: { name: 'üì¶ Lootboxes', items: ['lootbox', 'rarebox', 'suprarebox', 'ultrabox'] },
        treasures: { name: 'üíé Tr√©sors', items: ['pearl', 'big_pearl', 'stardust', 'star_piece', 'heart_scale', 'golden_magikarp'] }
    };
    
    // Fonction pour cr√©er une carte d'item
    const createItemCard = (item) => {
        const hasSellPrice = item.sellPrice !== undefined && item.sellPrice > 0;
        const canUse = !hasSellPrice && (['lootbox', 'rarebox', 'suprarebox', 'ultrabox', 'legendary_radar', 'exp_charm', 'lucky_charm', 'incensefleur', 'marin_lure', 'charm_collection'].includes(item.id));
        
        let buttonHTML = '';
        if (hasSellPrice && item.qty > 0) {
            buttonHTML = `<button onclick="sellItem('${item.id}')" class="btn btn--primary" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer;">
                üí∞ Vendre (${item.sellPrice}üí∞)
            </button>`;
        } else if (canUse && item.qty > 0) {
            if (item.id.startsWith('lootbox') || item.id === 'rarebox' || item.id === 'suprarebox' || item.id === 'ultrabox') {
                buttonHTML = `<button onclick="openLootbox('${item.id}')" class="btn btn--primary" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer;">
                    Ouvrir
                </button>`;
            } else if (item.id === 'legendary_radar') {
                buttonHTML = `<button onclick="activateBoostItem('${item.id}')" class="btn btn--primary" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer;">
                    Utiliser
                </button>`;
            } else if (['exp_charm', 'lucky_charm', 'incensefleur', 'marin_lure', 'charm_collection'].includes(item.id)) {
                buttonHTML = `<button onclick="activateBoostItem('${item.id}')" class="btn btn--primary" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer;">
                    Activer
                </button>`;
            }
        }
        
        const card = document.createElement('div');
        card.className = 'inventory-item';
        if (item.qty === 0) card.classList.add('not-owned');
        card.innerHTML = `
            <div class="item-icon">${getItemIconDisplay(item.id, '3em')}</div>
            <div class="item-name">${item.name}</div>
            <div class="item-quantity">${item.qty > 0 ? `√ó${item.qty}` : '√ó0'}</div>
            <div class="item-description">${item.desc}</div>
            ${buttonHTML}
        `;
        return card;
    };
    
    // Parcourir chaque cat√©gorie
    Object.entries(categories).forEach(([catKey, cat]) => {
        const categoryItems = cat.items.map(id => ({
            id,
            ...ALL_ITEMS[id],
            qty: gameState.inventory[id] || 0
        })).filter(item => showUnowned || item.qty > 0);
        
        if (categoryItems.length === 0) return;
        
        // Titre de section
        const sectionTitle = document.createElement('div');
        sectionTitle.style.cssText = 'grid-column: 1 / -1; font-size: 1.5em; font-weight: 700; color: #FFFFFF; margin: 20px 0 15px 0; padding: 10px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)); border-radius: 10px; border: 2px solid rgba(102, 126, 234, 0.5);';
        sectionTitle.textContent = cat.name;
        grid.appendChild(sectionTitle);
        
        // Items de la cat√©gorie
        categoryItems.forEach(item => {
            grid.appendChild(createItemCard(item));
        });
    });
    
    // Ajouter les boutons sp√©ciaux (≈íufs, Catchbot)
    const specialButtons = document.createElement('div');
    specialButtons.style.cssText = 'grid-column: 1 / -1; display: flex; gap: 15px; margin-top: 20px;';
    specialButtons.innerHTML = `
        <button onclick="if(window.openEggsModal) openEggsModal();" class="btn btn--primary" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; color: white; font-weight: bold; border-radius: 12px; cursor: pointer; font-size: 1.1em;">
            ü•ö ≈íufs (${(gameState.inventory.eggs || []).length})
        </button>
        ${gameState.catchbot?.active ? `
        <button onclick="if(window.claimCatchbot) claimCatchbot();" class="btn btn--primary" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; color: white; font-weight: bold; border-radius: 12px; cursor: pointer; font-size: 1.1em;">
            ü§ñ Catchbot (${gameState.catchbot.storage?.length || 0})
        </button>
        ` : ''}
    `;
    grid.appendChild(specialButtons);
    
    // Attacher les event listeners pour les boosts
    grid.querySelectorAll('.activate-boost-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            if (window.activateBoostItem) {
                window.activateBoostItem(itemId);
            }
        });
    });
};

window.sellItem = function(itemId) {
    const item = ALL_ITEMS[itemId];
    if (!item || !item.sellPrice) {
        showToast('Cet objet ne peut pas √™tre vendu !', 'error');
        return;
    }
    
    const qty = gameState.inventory[itemId] || 0;
    if (qty <= 0) {
        showToast('Vous n\'avez pas cet objet !', 'error');
        return;
    }
    
    // Vendre 1 unit√©
    gameState.inventory[itemId]--;
    const coinsEarned = item.sellPrice;
    gameState.coins += coinsEarned;
    
    saveGame();
    updateUI();
    showToast(`‚úÖ ${item.name} vendu pour ${coinsEarned}üí∞`, 'success');
};

// ===== GENESIS REBOOT - PARTIE 3 : ENDGAME =====

// 1. POK√â-POKER : CHEAT CODES (Hacking Tools)
// Variables globales pour les cheat codes
let pokerCheatState = {
    xrayActive: false,
    xrayNextCard: null,
    glitchDrawUsed: false
};

// Fonction pour activer X-Ray (Voir la prochaine carte)
window.activatePokerXRay = function() {
    const cost = 1000; // EO
    if (!gameState.research || gameState.research.energy < cost) {
        showPorygonMessage(['√ânergie Onirique insuffisante !', 'X-Ray n√©cessite 1000 EO.'], 'error');
        return;
    }
    
    const run = gameState.poker.current_run;
    if (!run || run.deck.length === 0) {
        showToast('Aucune carte disponible √† voir !', 'error');
        return;
    }
    
    // D√©biter l'EO
    gameState.research.energy -= cost;
    
    // Voir la prochaine carte
    pokerCheatState.xrayActive = true;
    pokerCheatState.xrayNextCard = run.deck[run.deck.length - 1];
    
    showPorygonMessage(['X-Ray activ√© !', 'Prochaine carte r√©v√©l√©e.'], 'progress');
    saveGame();
    updateResearchUI();
    
    // Afficher la carte dans l'UI Poker
    if (typeof renderPokerGame === 'function') {
        renderPokerGame();
    }
};

// Fonction pour activer Glitch Draw (Transformer une carte en Joker)
window.activatePokerGlitchDraw = function(cardIndex) {
    const cost = 5000; // EO
    if (!gameState.research || gameState.research.energy < cost) {
        showPorygonMessage(['√ânergie Onirique insuffisante !', 'Glitch Draw n√©cessite 5000 EO.'], 'error');
        return;
    }
    
    if (pokerCheatState.glitchDrawUsed) {
        showToast('Glitch Draw d√©j√† utilis√© cette main !', 'error');
        return;
    }
    
    if (cardIndex < 0 || cardIndex >= pokerDrawnCards.length) {
        showToast('Carte invalide !', 'error');
        return;
    }
    
    // D√©biter l'EO
    gameState.research.energy -= cost;
    
    // Transformer la carte en Joker
    const jokerCard = {
        id: 'joker',
        suit: 'JOKER',
        rank: 'JOKER',
        pokedex_number: 0,
        is_shiny: false,
        name: 'Joker',
        type: 'JOKER'
    };
    
    pokerDrawnCards[cardIndex] = jokerCard;
    pokerCheatState.glitchDrawUsed = true;
    
    showPorygonMessage(['Glitch Draw activ√© !', 'Carte transform√©e en Joker.'], 'progress');
    saveGame();
    updateResearchUI();
    
    // Rafra√Æchir l'UI
    if (typeof renderPokerGame === 'function') {
        renderPokerGame();
    }
};

// 2. TCG : DECK ACTIF AVEC PASSIFS
// Initialiser le deck actif TCG
function initTCGActiveDeck() {
    if (!gameState.tcg.activeDeck) {
        gameState.tcg.activeDeck = [];
    }
    if (!gameState.tcg.activeDeckMaxSize) {
        gameState.tcg.activeDeckMaxSize = 5;
    }
}

// Fonction pour obtenir les multiplicateurs du Deck Actif
function getTCGDeckMultipliers() {
    initTCGActiveDeck();
    
    const multipliers = {
        fire: 1,
        water: 1,
        grass: 1,
        electric: 1,
        berryCost: 1,
        clickCoins: 1,
        production: 1
    };
    
    if (!gameState.tcg.activeDeck || gameState.tcg.activeDeck.length === 0) {
        return multipliers;
    }
    
    gameState.tcg.activeDeck.forEach(cardId => {
        const card = gameState.tcg.cards[cardId];
        if (!card) return;
        
        const pokemonId = card.pokemonId;
        const types = POKEMON_TYPES[pokemonId] || [];
        const rarity = card.rarity;
        
        // Effets bas√©s sur le type du Pok√©mon
        if (types.includes('Feu')) {
            multipliers.fire += 0.2; // +20% production pour Pok√©mon Feu
        }
        if (types.includes('Eau')) {
            multipliers.water += 0.15; // +15% production pour Pok√©mon Eau
        }
        if (types.includes('Plante')) {
            multipliers.grass += 0.15; // +15% production pour Pok√©mon Plante
        }
        if (types.includes('√âlectrik')) {
            multipliers.electric += 0.1; // +10% production pour Pok√©mon √âlectrik
        }
        
        // Effets bas√©s sur la raret√©
        if (rarity === 'rare' || rarity === 'super_rare' || rarity === 'legendary') {
            multipliers.production += 0.05; // +5% production globale par carte rare
        }
        
        // Effets sp√©cifiques par Pok√©mon
        if (pokemonId === 6) { // Dracaufeu
            multipliers.fire += 0.2; // Bonus suppl√©mentaire pour Dracaufeu
        }
        if (pokemonId === 113) { // Leveinard
            multipliers.berryCost -= 0.05; // -5% co√ªt de production des baies
        }
        if (pokemonId === 52) { // Miaouss
            multipliers.clickCoins += 0.1; // +10% coins par clic manuel
        }
    });
    
    return multipliers;
}

// Fonction pour ajouter une carte au Deck Actif
window.addCardToActiveDeck = function(cardId) {
    initTCGActiveDeck();
    
    if (gameState.tcg.activeDeck.length >= gameState.tcg.activeDeckMaxSize) {
        showToast(`Deck Actif plein ! (${gameState.tcg.activeDeckMaxSize} cartes max)`, 'error');
        return;
    }
    
    if (gameState.tcg.activeDeck.includes(cardId)) {
        showToast('Cette carte est d√©j√† dans le Deck Actif !', 'error');
        return;
    }
    
    if (!gameState.tcg.cards[cardId]) {
        showToast('Carte non trouv√©e !', 'error');
        return;
    }
    
    gameState.tcg.activeDeck.push(cardId);
    saveGame();
    showToast(`‚úÖ ${FRENCH_NAMES[gameState.tcg.cards[cardId].pokemonId]} ajout√© au Deck Actif !`, 'success');
    
    // Rafra√Æchir l'UI si on est sur la page Research
    if (document.getElementById('research-page')?.classList.contains('active')) {
        updateResearchUI();
    }
};

// Fonction pour retirer une carte du Deck Actif
window.removeCardFromActiveDeck = function(cardId) {
    initTCGActiveDeck();
    
    const index = gameState.tcg.activeDeck.indexOf(cardId);
    if (index === -1) {
        showToast('Carte non trouv√©e dans le Deck Actif !', 'error');
        return;
    }
    
    gameState.tcg.activeDeck.splice(index, 1);
    saveGame();
    showToast('Carte retir√©e du Deck Actif', 'info');
    
    // Rafra√Æchir l'UI
    if (document.getElementById('research-page')?.classList.contains('active')) {
        updateResearchUI();
    }
};

// 3. MISSINGNO : √âV√âNEMENT BOSS FINAL
// Fonction pour d√©clencher l'√©v√©nement MissingNo
function triggerMissingNoEvent() {
    // Blackout
    const blackout = document.createElement('div');
    blackout.id = 'missingno-blackout';
    blackout.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000;
        z-index: 99999;
        animation: fadeIn 0.5s ease;
    `;
    document.body.appendChild(blackout);
    
    // Arr√™ter la musique si elle existe
    const audioElements = document.querySelectorAll('audio');
    audioElements.forEach(audio => {
        if (!audio.paused) {
            audio.pause();
        }
    });
    
    // Message Porygon (Terreur)
    setTimeout(() => {
        showPorygonMessage([
            'NON !',
            'Il √©tait cach√© dans le dernier fichier !',
            'Il corrompt la passerelle !',
            'SYST√àME EN DANGER !'
        ], 'panic');
        
        // Apparition de MissingNo
        setTimeout(() => {
            startMissingNoBossBattle();
        }, 3000);
    }, 1000);
}

// 4. COMBAT DE BOSS MISSINGNO
// QA & POLISHING : HP ajust√© pour un combat de 5-10 minutes avec attaques sp√©ciales
let missingNoBossState = {
    hp: 500000,  // R√©duit de 1M √† 500k pour un combat plus dynamique
    maxHp: 500000,
    active: false,
    damageInterval: null
};

// Fonction pour d√©marrer le combat de boss
function startMissingNoBossBattle() {
    missingNoBossState.active = true;
    missingNoBossState.hp = 500000;
    missingNoBossState.maxHp = 500000;
    
    // QA & POLISHING : Effet visuel de glitch sur toute l'interface
    document.body.style.filter = 'grayscale(50%) invert(10%)';
    document.body.style.animation = 'screenGlitch 0.1s infinite';
    
    // Tremblement de l'√©cran
    let shakeCount = 0;
    const shakeInterval = setInterval(() => {
        if (shakeCount >= 20) {
            clearInterval(shakeInterval);
            document.body.style.transform = '';
            return;
        }
        const x = (Math.random() - 0.5) * 10;
        const y = (Math.random() - 0.5) * 10;
        document.body.style.transform = `translate(${x}px, ${y}px)`;
        shakeCount++;
    }, 50);
    
    const blackout = document.getElementById('missingno-blackout');
    if (blackout) blackout.remove();
    
    // Cr√©er l'UI du combat
    const battleModal = document.createElement('div');
    battleModal.id = 'missingno-battle-modal';
    battleModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.95);
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.5s ease;
    `;
    
    battleModal.innerHTML = `
        <div style="text-align: center; max-width: 800px; width: 90%;">
            <h1 style="color: #ff00ff; font-size: 3em; margin-bottom: 20px; text-shadow: 0 0 20px #ff00ff; animation: glitch 0.3s infinite;">
                ‚ö†Ô∏è SYSTEM CRASH ‚ö†Ô∏è
            </h1>
            
            <div style="margin: 40px 0;">
                <img id="missingno-sprite" src="${getMissingNoSpriteUrl()}" 
                     style="width: 300px; height: 300px; image-rendering: pixelated; 
                            filter: drop-shadow(0 0 30px #ff00ff) hue-rotate(0deg);
                            animation: missingnoGlitch 0.5s infinite;">
            </div>
            
            <div style="background: rgba(255, 0, 255, 0.2); border: 2px solid #ff00ff; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="color: white; font-size: 1.2em; margin-bottom: 10px;">HP: <span id="missingno-hp">${missingNoBossState.hp.toLocaleString()}</span> / ${missingNoBossState.maxHp.toLocaleString()}</div>
                <div style="width: 100%; height: 30px; background: rgba(0,0,0,0.5); border-radius: 15px; overflow: hidden;">
                    <div id="missingno-hp-bar" style="width: 100%; height: 100%; background: linear-gradient(90deg, #ff00ff, #ff0080); transition: width 0.3s;"></div>
                </div>
            </div>
            
            <div style="background: rgba(32, 213, 210, 0.2); border: 2px solid #20d5d2; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="color: #20d5d2; font-size: 1.1em; margin-bottom: 10px;">DPS (Production EO/s): <span id="missingno-dps">0</span></div>
                <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Votre infrastructure attaque automatiquement !</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <button id="missingno-burst-chips" onclick="missingNoBurstAttack('chips')" 
                        class="btn btn--primary" 
                        style="padding: 15px; background: rgba(255, 215, 0, 0.2); border: 2px solid #FFD700;">
                    üíæ Attaque Chips<br>
                    <span style="font-size: 0.8em;">Sacrifier 10 Chips</span>
                </button>
                <button id="missingno-burst-berries" onclick="missingNoBurstAttack('berries')" 
                        class="btn btn--primary"
                        style="padding: 15px; background: rgba(16, 185, 129, 0.2); border: 2px solid #10b981;">
                    üçì Attaque Baies<br>
                    <span style="font-size: 0.8em;">Sacrifier 5 Baies</span>
                </button>
            </div>
            
            <div style="color: rgba(255,255,255,0.6); font-size: 0.9em; text-align: center;">
                üí° Utilisez vos ressources accumul√©es pour "Patcher" MissingNo !
            </div>
        </div>
    `;
    
    document.body.appendChild(battleModal);
    
    // Ajouter les animations CSS
    if (!document.getElementById('missingno-styles')) {
        const style = document.createElement('style');
        style.id = 'missingno-styles';
        style.textContent = `
            @keyframes glitch {
                0%, 100% { transform: translate(0); }
                20% { transform: translate(-2px, 2px); }
                40% { transform: translate(-2px, -2px); }
                60% { transform: translate(2px, 2px); }
                80% { transform: translate(2px, -2px); }
            }
            @keyframes missingnoGlitch {
                0%, 100% { filter: drop-shadow(0 0 30px #ff00ff) hue-rotate(0deg); }
                25% { filter: drop-shadow(0 0 30px #ff00ff) hue-rotate(90deg); }
                50% { filter: drop-shadow(0 0 30px #ff00ff) hue-rotate(180deg); }
                75% { filter: drop-shadow(0 0 30px #ff00ff) hue-rotate(270deg); }
            }
            @keyframes screenGlitch {
                0%, 100% { filter: grayscale(50%) invert(10%); }
                25% { filter: grayscale(60%) invert(15%) hue-rotate(5deg); }
                50% { filter: grayscale(40%) invert(5%) hue-rotate(-5deg); }
                75% { filter: grayscale(55%) invert(12%) hue-rotate(3deg); }
            }
            @keyframes screenShake {
                0%, 100% { transform: translate(0, 0); }
                25% { transform: translate(-5px, 5px); }
                50% { transform: translate(5px, -5px); }
                75% { transform: translate(-3px, -3px); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // D√©marrer le DPS automatique
    startMissingNoDPS();
    
    // Mettre √† jour l'UI toutes les secondes
    updateMissingNoBattleUI();
}

// Fonction pour d√©marrer le DPS automatique
function startMissingNoDPS() {
    if (missingNoBossState.damageInterval) {
        clearInterval(missingNoBossState.damageInterval);
    }
    
    missingNoBossState.damageInterval = setInterval(() => {
        if (!missingNoBossState.active) {
            clearInterval(missingNoBossState.damageInterval);
            return;
        }
        
        // Calculer la production EO/s
        const production = calculateProduction ? calculateProduction() : 0;
        const dps = production; // 1 EO/s = 1 DPS
        
        // Infliger des d√©g√¢ts
        missingNoBossState.hp = Math.max(0, missingNoBossState.hp - dps);
        
        // V√©rifier si le boss est vaincu
        if (missingNoBossState.hp <= 0) {
            defeatMissingNo();
        }
        
        updateMissingNoBattleUI();
    }, 1000); // Toutes les secondes
}

// Fonction pour mettre √† jour l'UI du combat
function updateMissingNoBattleUI() {
    const hpEl = document.getElementById('missingno-hp');
    const hpBarEl = document.getElementById('missingno-hp-bar');
    const dpsEl = document.getElementById('missingno-dps');
    
    if (hpEl) {
        hpEl.textContent = Math.floor(missingNoBossState.hp).toLocaleString();
    }
    
    if (hpBarEl) {
        const percentage = (missingNoBossState.hp / missingNoBossState.maxHp) * 100;
        hpBarEl.style.width = `${percentage}%`;
    }
    
    if (dpsEl) {
        const production = calculateProduction ? calculateProduction() : 0;
        dpsEl.textContent = Math.floor(production).toLocaleString();
    }
    
    // Mettre √† jour les boutons d'attaque
    const chipsBtn = document.getElementById('missingno-burst-chips');
    const berriesBtn = document.getElementById('missingno-burst-berries');
    
    const pokerChips = gameState.poker?.current_run?.chips || 0;
    const totalBerries = (gameState.inventory.framby || 0) + (gameState.inventory.pinap || 0) + (gameState.inventory.ceriz || 0);
    
    if (chipsBtn) {
        chipsBtn.disabled = pokerChips < 10;
        chipsBtn.style.opacity = pokerChips < 10 ? '0.5' : '1';
    }
    
    if (berriesBtn) {
        berriesBtn.disabled = totalBerries < 5;
        berriesBtn.style.opacity = totalBerries < 5 ? '0.5' : '1';
    }
}

// Fonction pour l'attaque sp√©ciale (Burst)
window.missingNoBurstAttack = function(type) {
    if (!missingNoBossState.active) return;
    
    if (type === 'chips') {
        const run = gameState.poker.current_run;
        if (!run || run.chips < 10) {
            showToast('Pas assez de Chips ! (10 requis)', 'error');
            return;
        }
        
        run.chips -= 10;
        // QA & POLISHING : D√©g√¢ts augment√©s pour satisfaction (10% des HP max)
        const damage = 50000; // 10% des HP max (500k)
        missingNoBossState.hp = Math.max(0, missingNoBossState.hp - damage);
        
        // Effet visuel d'attaque
        const battleModal = document.getElementById('missingno-battle-modal');
        if (battleModal) {
            battleModal.style.animation = 'screenShake 0.3s ease';
            setTimeout(() => battleModal.style.animation = '', 300);
        }
        
        showToast(`üíæ Attaque Chips ! -${damage.toLocaleString()} HP`, 'success');
    } else if (type === 'berries') {
        const totalBerries = (gameState.inventory.framby || 0) + (gameState.inventory.pinap || 0) + (gameState.inventory.ceriz || 0);
        if (totalBerries < 5) {
            showToast('Pas assez de Baies ! (5 requises)', 'error');
            return;
        }
        
        // Sacrifier 5 baies (priorit√©: Ceriz > Pinap > Framby)
        let sacrificed = 0;
        if (gameState.inventory.ceriz >= 5) {
            gameState.inventory.ceriz -= 5;
            sacrificed = 5;
        } else if (gameState.inventory.pinap >= 5) {
            gameState.inventory.pinap -= 5;
            sacrificed = 5;
        } else if (gameState.inventory.framby >= 5) {
            gameState.inventory.framby -= 5;
            sacrificed = 5;
        } else {
            // M√©lange si n√©cessaire
            let remaining = 5;
            if (gameState.inventory.ceriz > 0) {
                const take = Math.min(remaining, gameState.inventory.ceriz);
                gameState.inventory.ceriz -= take;
                remaining -= take;
            }
            if (gameState.inventory.pinap > 0 && remaining > 0) {
                const take = Math.min(remaining, gameState.inventory.pinap);
                gameState.inventory.pinap -= take;
                remaining -= take;
            }
            if (gameState.inventory.framby > 0 && remaining > 0) {
                const take = Math.min(remaining, gameState.inventory.framby);
                gameState.inventory.framby -= take;
                remaining -= take;
            }
            sacrificed = 5 - remaining;
        }
        
        // QA & POLISHING : D√©g√¢ts augment√©s pour satisfaction (15% des HP max)
        const damage = 75000; // 15% des HP max (500k)
        missingNoBossState.hp = Math.max(0, missingNoBossState.hp - damage);
        
        // Effet visuel d'attaque
        const battleModal = document.getElementById('missingno-battle-modal');
        if (battleModal) {
            battleModal.style.animation = 'screenShake 0.3s ease';
            setTimeout(() => battleModal.style.animation = '', 300);
        }
        
        showToast(`üçì Attaque Baies ! -${damage.toLocaleString()} HP`, 'success');
    }
    
    saveGame();
    updateMissingNoBattleUI();
    
    // V√©rifier si le boss est vaincu
    if (missingNoBossState.hp <= 0) {
        defeatMissingNo();
    }
};

// Fonction pour la d√©faite de MissingNo (AM√âLIOR√âE avec phases dramatiques)
function defeatMissingNo() {
    missingNoBossState.active = false;
    if (missingNoBossState.damageInterval) {
        clearInterval(missingNoBossState.damageInterval);
    }
    
    const battleModal = document.getElementById('missingno-battle-modal');
    if (!battleModal) return;
    
    // ===== PHASE 2 : LE SACRIFICE DE PORYGON =====
    // Porygon prend un coup pour sauver le joueur
    battleModal.innerHTML = `
        <div style="text-align: center; max-width: 600px; width: 90%;">
            <h1 style="color: #ff6b6b; font-size: 2.5em; margin-bottom: 20px; text-shadow: 0 0 20px #ff6b6b;">
                ‚ö†Ô∏è INTERCEPTION
            </h1>
            <div style="font-size: 4em; margin: 30px 0; animation: pulse 1s infinite;">üî∑</div>
            <p style="color: white; font-size: 1.3em; margin-bottom: 20px; line-height: 1.6;">
                Porygon-Z intercepte l'attaque finale de MissingNo...
            </p>
            <p style="color: rgba(255,255,255,0.9); font-size: 1.1em; margin-bottom: 20px; font-style: italic;">
                "Je... Je ne peux pas laisser l'Archiviste... √™tre supprim√©."
            </p>
            <p style="color: #ff6b6b; font-size: 1em; margin-bottom: 30px; font-weight: bold;">
                "Redirection de la corruption vers mon noyau."
            </p>
        </div>
    `;
    
    // Animation de sacrifice
    setTimeout(() => {
        // ===== PHASE 3 : LA RESTAURATION =====
        battleModal.innerHTML = `
            <div style="text-align: center; max-width: 600px; width: 90%;">
                <h1 style="color: #10b981; font-size: 3em; margin-bottom: 20px; text-shadow: 0 0 20px #10b981; animation: victoryPulse 2s infinite;">
                    ‚úÖ PATCH APPLIQU√â
                </h1>
                <div style="font-size: 5em; margin: 40px 0; animation: victorySpin 1s ease;">üéñÔ∏è</div>
                <p style="color: white; font-size: 1.5em; margin-bottom: 20px;">
                    MissingNo a √©t√© neutralis√© !
                </p>
                <p style="color: rgba(255,255,255,0.8); font-size: 1.1em; margin-bottom: 20px; line-height: 1.6;">
                    L'√ânergie Onirique accumul√©e au Labo a permis de restaurer Porygon.
                </p>
                <p style="color: rgba(255,255,255,0.7); margin-bottom: 30px;">
                    La passerelle vers Johto est maintenant s√©curis√©e.
                </p>
                <button onclick="completeMissingNoDefeat()" class="btn btn--primary" style="padding: 15px 40px; font-size: 1.2em; animation: buttonPulse 1.5s infinite;">
                    Acc√©der √† Johto
                </button>
            </div>
        `;
        
        // Retirer les effets de glitch
        document.body.style.filter = '';
        document.body.style.animation = '';
        document.body.style.transform = '';
        
        // Restaurer Porygon (son int√©grit√© revient √† la normale)
        if (gameState.system) {
            gameState.system.porygonIntegrity = 100;
            gameState.system.glitchLevel = 0;
        }
    }, 3000);
    
    // Ajouter le Badge Glitch √† l'inventaire
    if (!gameState.inventory.missingno_badge) {
        gameState.inventory.missingno_badge = 1;
    }
    
    saveGame();
}

// Fonction pour compl√©ter la d√©faite et d√©bloquer Johto
window.completeMissingNoDefeat = function() {
    const battleModal = document.getElementById('missingno-battle-modal');
    if (battleModal) battleModal.remove();
    
    // QA & POLISHING : C√©l√©bration avec confettis
    createConfettiCelebration();
    
    // D√©bloquer Johto
    if (!gameState.unlockedRegions) gameState.unlockedRegions = new Set(['Kanto']);
    gameState.unlockedRegions.add('Johto');
    
    // QA & POLISHING : New Game+ - V√©rification de la sauvegarde
    // CONSERVER :
    // - Chips Poker (gameState.poker)
    // - Cartes TCG (gameState.tcg)
    // - Niveau Labo et upgrades (gameState.research)
    // - Overclocks (gameState.poker.overclocks)
    // - Badge MissingNo (gameState.inventory.missingno_badge)
    // - Pok√©dex Kanto compl√©t√© (gameState.captured reste intact pour Kanto)
    
    // BUG FIX : Retrait de la variable "morte" capturedJohto
    // Le syst√®me actuel avec gameState.captured (Set unique) + getCaughtCount(region) fonctionne parfaitement
    // Pas besoin de dupliquer les donn√©es. Le filtre par r√©gion se fait via getCaughtCount() et getPokemonRegion()
    // Cette variable n'√©tait jamais utilis√©e car addToCollection continue d'ajouter dans gameState.captured
    
    showPorygonMessage([
        'Syst√®me rebooting...',
        'Passerelle Johto activ√©e.',
        'Nouvelle r√©gion d√©bloqu√©e !',
        'Porygon-Z purifi√© ! üòä'
    ], 'happy');
    
    saveGame();
    updateUI();
    
    // QA & POLISHING : Changement de palette de couleurs (Or/Argent)
    setTimeout(() => {
        document.body.style.setProperty('--theme-primary', '#FFD700');
        document.body.style.setProperty('--theme-secondary', '#C0C0C0');
        document.body.style.transition = 'all 1s ease';
        
        // Animation de transition de couleur
        const style = document.createElement('style');
        style.id = 'johto-theme-transition';
        style.textContent = `
            @keyframes victoryPulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            @keyframes victorySpin {
                0% { transform: rotate(0deg) scale(0); }
                50% { transform: rotate(180deg) scale(1.2); }
                100% { transform: rotate(360deg) scale(1); }
            }
            @keyframes buttonPulse {
                0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
                50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.8); }
            }
        `;
        document.head.appendChild(style);
    }, 500);
    
    showToast('üéâ Johto d√©bloqu√© ! Nouvelle aventure commence !', 'success');
};

// QA & POLISHING : Fonction pour cr√©er une c√©l√©bration avec confettis
function createConfettiCelebration() {
    const colors = ['#FFD700', '#C0C0C0', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];
    const confettiCount = 100;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            left: ${Math.random() * 100}vw;
            top: -10px;
            z-index: 100000;
            pointer-events: none;
            border-radius: 50%;
            animation: confettiFall ${2 + Math.random() * 3}s linear forwards;
        `;
        
        document.body.appendChild(confetti);
        
        setTimeout(() => {
            if (confetti.parentNode) confetti.remove();
        }, 5000);
    }
    
    // Ajouter l'animation CSS si pas d√©j√† pr√©sente
    if (!document.getElementById('confetti-animation')) {
        const style = document.createElement('style');
        style.id = 'confetti-animation';
        style.textContent = `
            @keyframes confettiFall {
                to {
                    transform: translateY(100vh) rotate(${360 + Math.random() * 360}deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
}

// 5. SHOP SECRET POKER (Overclocks)
// Initialiser les overclocks
function initPokerOverclocks() {
    if (!gameState.poker.overclocks) {
        gameState.poker.overclocks = {
            speed: 0,      // R√©duit le temps de production des Baies (-10% par niveau)
            scanner: 0     // Augmente la raret√© des spawns sauvages (+5% par niveau)
        };
    }
}

// Fonction pour ouvrir le Shop Secret Poker
window.openPokerSecretShop = function() {
    initPokerOverclocks();
    
    const run = gameState.poker.current_run;
    const chips = run ? run.chips : 0;
    const overclocks = gameState.poker.overclocks;
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center;';
    
    modal.innerHTML = `
        <div style="background: rgba(30, 30, 50, 0.95); padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid #FFD700;">
            <h2 style="color: #FFD700; margin-bottom: 20px; text-align: center; font-size: 2em;">üîß Shop Secret</h2>
            <p style="color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 20px;">
                Utilisez vos Processor Chips pour acheter des Overclocks
            </p>
            
            <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                <div style="color: #FFD700; font-size: 1.2em; font-weight: bold;">
                    üíæ Chips: ${chips.toLocaleString()}
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div style="background: rgba(30, 30, 50, 0.8); border: 2px solid ${chips >= (overclocks.speed + 1) * 50 ? '#10b981' : '#444'}; border-radius: 12px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="color: white; font-weight: bold; font-size: 1.2em; margin-bottom: 5px;">‚ö° Overclock Vitesse</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Niveau ${overclocks.speed}</div>
                            <div style="color: #10b981; font-size: 0.9em; margin-top: 5px;">
                                R√©duit le temps de production des Baies de ${overclocks.speed * 10}%
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #FFD700; font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                                ${((overclocks.speed + 1) * 50).toLocaleString()} üíæ
                            </div>
                            <button onclick="buyPokerOverclock('speed')" 
                                    class="btn btn--primary" 
                                    ${chips < (overclocks.speed + 1) * 50 ? 'disabled' : ''}
                                    style="padding: 10px 20px; ${chips < (overclocks.speed + 1) * 50 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                Acheter
                            </button>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(30, 30, 50, 0.8); border: 2px solid ${chips >= (overclocks.scanner + 1) * 75 ? '#20d5d2' : '#444'}; border-radius: 12px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <div style="color: white; font-weight: bold; font-size: 1.2em; margin-bottom: 5px;">üîç Overclock Scanner</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.9em;">Niveau ${overclocks.scanner}</div>
                            <div style="color: #20d5d2; font-size: 0.9em; margin-top: 5px;">
                                Augmente la raret√© des spawns sauvages de +${overclocks.scanner * 5}%
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #FFD700; font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                                ${((overclocks.scanner + 1) * 75).toLocaleString()} üíæ
                            </div>
                            <button onclick="buyPokerOverclock('scanner')" 
                                    class="btn btn--primary" 
                                    ${chips < (overclocks.scanner + 1) * 75 ? 'disabled' : ''}
                                    style="padding: 10px 20px; ${chips < (overclocks.scanner + 1) * 75 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                Acheter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="this.closest('.modal').remove()" class="btn btn--outline" style="margin-top: 20px; width: 100%;">Fermer</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
};

// Fonction pour acheter un Overclock
window.buyPokerOverclock = function(type) {
    initPokerOverclocks();
    
    const run = gameState.poker.current_run;
    if (!run) {
        showToast('Aucune run active !', 'error');
        return;
    }
    
    const overclocks = gameState.poker.overclocks;
    const currentLevel = overclocks[type] || 0;
    const cost = type === 'speed' ? (currentLevel + 1) * 50 : (currentLevel + 1) * 75;
    
    if (run.chips < cost) {
        showToast(`Pas assez de Chips ! (${cost.toLocaleString()} requis)`, 'error');
        return;
    }
    
    // Acheter l'overclock
    run.chips -= cost;
    overclocks[type] = currentLevel + 1;
    
    const name = type === 'speed' ? 'Overclock Vitesse' : 'Overclock Scanner';
    showToast(`‚úÖ ${name} niveau ${overclocks[type]} achet√© !`, 'success');
    
    saveGame();
    
    // Rafra√Æchir le shop
    const modal = document.querySelector('.modal.active');
    if (modal) modal.remove();
    openPokerSecretShop();
};

// ===== POLISHING : SYST√àME DE PARTICULES AU CLIC GLOBAL =====
let clickParticlesContainer = null;

function initClickParticles() {
    if (clickParticlesContainer) return;
    
    clickParticlesContainer = document.createElement('div');
    clickParticlesContainer.className = 'click-particles';
    clickParticlesContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        z-index: 9999;
    `;
    document.body.appendChild(clickParticlesContainer);
} // FIN initClickParticles

function createClickParticles(x, y, count = 8) {
    if (!clickParticlesContainer) initClickParticles();
    
    const colors = [
        'rgba(125, 95, 255, 1)', // Violet
        'rgba(32, 213, 210, 1)',  // Cyan
        'rgba(255, 215, 0, 1)',  // Or
        'rgba(168, 85, 247, 1)'  // Violet fonc√©
    ];
    
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'click-particle';
        
        const angle = (Math.PI * 2 * i) / count;
        const distance = 30 + Math.random() * 20;
        const xOffset = Math.cos(angle) * distance;
        const yOffset = Math.sin(angle) * distance;
        
        particle.style.cssText = `
            position: absolute;
            left: ${x}px;
            top: ${y}px;
            width: 6px;
            height: 6px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            border-radius: 50%;
            box-shadow: 0 0 10px ${colors[Math.floor(Math.random() * colors.length)]};
        `;
        
        particle.style.setProperty('--particle-x', `${xOffset}px`);
        particle.style.setProperty('--particle-y', `${yOffset}px`);
        
        clickParticlesContainer.appendChild(particle);
        
        setTimeout(() => {
            if (particle.parentNode) particle.remove();
        }, 600);
    }
} // FIN createClickParticles

// POLISHING : Ajouter les particules au clic sur les boutons importants
(function() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            initClickParticles();
            
            document.addEventListener('click', (e) => {
                const target = e.target;
                
                if (target.classList.contains('btn--primary') || 
                    target.classList.contains('btn--large') ||
                    target.id === 'spawn-btn' ||
                    target.id === 'fishing-btn' ||
                    target.onclick ||
                    target.closest('.btn--primary')) {
                    
                    const rect = target.getBoundingClientRect();
                    const x = rect.left + rect.width / 2;
                    const y = rect.top + rect.height / 2;
                    
                    createClickParticles(x, y, 6);
                }
            });
        });
    } else {
        // DOM d√©j√† charg√©
        initClickParticles();
        
        document.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.classList.contains('btn--primary') || 
                target.classList.contains('btn--large') ||
                target.id === 'spawn-btn' ||
                target.id === 'fishing-btn' ||
                target.onclick ||
                target.closest('.btn--primary')) {
                
                const rect = target.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                
                createClickParticles(x, y, 6);
            }
        });
    }
})();