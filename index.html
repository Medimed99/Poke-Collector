<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2C2F33">
    <meta name="description" content="Collectez et Ã©voluez vos PokÃ©mon prÃ©fÃ©rÃ©s dans cette aventure immersive !">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PokÃ©mon Collector">
    <title>PokÃ©mon Blind Box Collector V6.2</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <!-- POLISHING : Typographie professionnelle -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- âœ… CORRECTION : Polices pixel pour l'intro -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- React & Dependencies for PokÃ©-Poker -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js for 3D PokÃ©ball -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Supabase for Cloud Save -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes shine {
            0%, 100% {
                filter: brightness(1);
                transform: scale(1);
            }
            50% {
                filter: brightness(1.5);
                transform: scale(1.1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(125, 95, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(125, 95, 255, 0.6);
            }
        }
        
        /* ===== POKÃ‰-POKER STYLES ===== */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap');
        
        :root { --bg-dark: #050510; }
        
        #poker-page .crt::before { 
            content: " "; 
            display: block; 
            position: absolute; 
            top: 0; 
            left: 0; 
            bottom: 0; 
            right: 0; 
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); 
            z-index: 999; 
            background-size: 100% 2px, 3px 100%; 
            pointer-events: none; 
        }
        
        #poker-page .pixel-font { font-family: 'Press Start 2P', monospace; }
        #poker-page .pixel-border { box-shadow: -3px 0 0 0 black, 3px 0 0 0 black, 0 -3px 0 0 black, 0 3px 0 0 black; margin: 3px; }
        #poker-page .neon-text { text-shadow: 2px 2px 0px #000, 0 0 10px currentColor; }
        #poker-page .modal-backdrop { background-color: rgba(0,0,0,0.95); backdrop-filter: blur(8px); }
        #poker-page .card-container { image-rendering: pixelated; transition: transform 0.2s; background-size: cover; background-position: center; position: relative; box-shadow: 4px 4px 0px rgba(0,0,0,0.5); }
        #poker-page .card-container:hover { transform: translateY(-10px) scale(1.05); z-index: 40; }
        #poker-page .card-container.selected { transform: translateY(-25px) !important; box-shadow: 0 0 0 3px #fbbf24, 0 0 15px #fbbf24 !important; z-index: 50 !important; border-color: #fbbf24 !important; }
        #poker-page .card-container.scoring { transform: translateY(-40px) scale(1.2) !important; box-shadow: 0 0 0 4px #fff, 0 0 40px #fff !important; z-index: 100 !important; filter: brightness(1.2) !important; }
        #poker-page .card-container.dimmed { filter: brightness(0.4) grayscale(0.8); transform: scale(0.95); }
        #poker-page .is-shiny { position: relative; overflow: hidden; border: 2px solid #ffd700 !important; box-shadow: 0 0 15px #ffd700; }
        #poker-page .is-shiny::after { content: ""; position: absolute; top: -100%; left: -100%; width: 300%; height: 300%; background: linear-gradient(115deg, transparent 20%, rgba(255,0,0,0.4) 30%, rgba(255,255,0,0.4) 40%, rgba(0,255,0,0.4) 50%, rgba(0,255,255,0.4) 60%, rgba(0,0,255,0.4) 70%, rgba(255,0,255,0.4) 80%, transparent 90%); mix-blend-mode: color-dodge; animation: holo-shine 3s linear infinite; pointer-events: none; }
        @keyframes holo-shine { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(20px, 20px) rotate(360deg); } }
        #poker-page .pokeball-pattern { background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1) 15%, transparent 16%), linear-gradient(to bottom, transparent 48%, rgba(0,0,0,0.15) 48%, rgba(0,0,0,0.15) 52%, transparent 52%); pointer-events: none; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #poker-page .animate-slide-in { animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 15px #60a5fa; } 50% { box-shadow: 0 0 30px #3b82f6; } }
        #poker-page .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes secret-unlock { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        #poker-page .animate-secret { animation: secret-unlock 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes defeat-shake { 0% { transform: translate(0,0); filter: brightness(1); } 20% { transform: translate(-10px, 0); filter: brightness(1); } 40% { transform: translate(10px, 0); filter: brightness(0.8); } 60% { transform: translate(-10px, 0); filter: brightness(0.6); } 80% { transform: translate(10px, 0); filter: brightness(0.4); opacity: 1; } 100% { transform: translate(0,0); filter: brightness(0); opacity: 0; scale: 0.8; } }
        #poker-page .animate-defeat { animation: defeat-shake 2s forwards; }
        @keyframes badge-appear { 0% { transform: scale(0) rotate(-180deg); opacity: 0; } 70% { transform: scale(1.5) rotate(10deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        #poker-page .animate-badge { animation: badge-appear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #poker-page .animate-bounce-slow { animation: bounce-slow 3s ease-in-out infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        #poker-page .animate-shimmer { animation: shimmer 2s ease-in-out infinite; }
        
        #poker-page { background-color: var(--bg-dark); color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden; user-select: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100vh; z-index: 1000; }
        
        /* Cacher les barres de menu quand on est sur la page poker */
        body:has(#poker-page.active) .top-bar,
        body:has(#poker-page.active):not(:has(.poker-start-screen)) .bottom-nav {
            display: none !important;
        }
        
        /* AmÃ©liorer la lisibilitÃ© sur mobile */
        @media (max-width: 768px) {
            #poker-page {
                font-size: 16px;
            }
            
            #poker-page .pixel-font {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                font-weight: bold;
                letter-spacing: 0.5px;
            }
            
            #poker-page .font-vt323 {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                font-weight: 600;
            }
            
            /* Agrandir les cartes sur mobile - 2 lignes de 4 */
            #poker-page .card-container {
                min-width: 90px !important;
                min-height: 130px !important;
                width: 90px !important;
                height: 130px !important;
            }
            
            /* Forcer 2 lignes de 4 cartes sur mobile */
            #poker-page .flex.flex-wrap.gap-2,
            #poker-page .flex.flex-wrap.gap-3,
            #poker-page .flex.flex-wrap.gap-4 {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                grid-template-rows: repeat(2, auto) !important;
                gap: 6px !important;
                max-height: none !important;
                overflow-y: visible !important;
                justify-items: center;
                align-items: end;
            }
            
            /* Interface des dresseurs sur mobile - plus compacte */
            #poker-page .min-h-\[400px\] {
                min-height: 320px !important;
            }
            
            /* Espacement des dresseurs sur mobile */
            #poker-page .gap-4.md\\:gap-12,
            #poker-page .gap-4.md\\:gap-12 > * {
                gap: 8px !important;
            }
            
            /* Centrer les sprites dans les cartes */
            #poker-page .card-container img {
                display: block;
                margin: 0 auto;
                object-fit: contain;
                object-position: center;
            }
        }
        
        /* Mode paysage - garder la police lisible */
        @media (orientation: landscape) and (max-height: 600px) {
            #poker-page {
                font-size: 14px !important;
            }
            
            #poker-page .pixel-font {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                font-weight: bold !important;
                letter-spacing: 0.5px !important;
            }
            
            #poker-page .font-vt323 {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
                font-weight: 600 !important;
            }
            
            /* Agrandir le texte dans les cartes */
            #poker-page .text-\[10px\],
            #poker-page .text-\[8px\] {
                font-size: 12px !important;
            }
            
            /* Ajuster les boutons */
            #poker-page button {
                font-size: 14px !important;
                padding: 10px 16px !important;
                min-height: 44px; /* Taille tactile minimale */
            }
            
            /* Ajuster les textes */
            #poker-page .text-xs {
                font-size: 13px !important;
            }
            
            /* RÃ©duire les espacements pour tout faire tenir */
            #poker-page .p-4 {
                padding: 12px !important;
            }
            
            #poker-page .p-8 {
                padding: 16px !important;
            }
            
            #poker-page .gap-8 {
                gap: 12px !important;
            }
        }
        
        /* Styles globaux pour centrer tous les sprites animÃ©s */
        img[src*="generation-v/black-white/animated"] {
            object-fit: contain !important;
            object-position: center !important;
            display: block;
            margin: 0 auto;
            image-rendering: pixelated;
        }
    </style>
</head>
<body>
    <!-- INTRO OVERLAY (Nouvelle SÃ©quence Mobile First) -->
    <div id="game-boy-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50000;">
        <div class="scanlines"></div>
        
        <!-- START SCREEN -->
        <div id="start-screen">
            <h1>POKÃ‰MON<br>1511</h1>
            <button class="start-btn" onclick="window.startIntroSequence()">NOUVELLE PARTIE</button>
        </div>
        
        <!-- PHASE 1 : PROF CHEN -->
        <div id="scene-retro" class="scene-retro hidden">
            <div class="actors-container">
                <!-- Sprite Chen (Source Fiable) -->
                <img src="https://play.pokemonshowdown.com/sprites/trainers/oak.png" id="oak-sprite" class="prof-sprite" alt="Prof Chen" onerror="this.style.display='none'; document.getElementById('oak-fallback').style.display='block';">
                <div id="oak-fallback" class="prof-fallback">ğŸ‘¨â€ğŸ”¬</div>
                
                <!-- ANIMATION POKEMON -->
                <div id="intro-pkmn-container" class="intro-pokemon-container">
                    <div id="pokeball-anim" class="pokeball-throw"></div>
                    <div id="flash-anim" class="flash-effect"></div>
                    <!-- Gengar (Ectoplasma) - ID 94 -->
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/94.png" id="intro-pokemon" class="pokemon-intro-sprite" alt="Ectoplasma">
                </div>
            </div>
            
            <div class="dialog-container">
                <div class="dialog-box-retro">
                    <span id="retro-text"></span>
                    <div id="retro-arrow" class="next-arrow">â–¼</div>
                </div>
            </div>
        </div>
        
        <!-- PHASE 2 : TERMINAL -->
        <div id="terminal-screen"></div>
        
        <!-- PHASE 3 : PORYGON-Z -->
        <div id="porygon-scene">
            <div class="cyber-grid"></div>
            <img src="https://img.pokemondb.net/sprites/black-white/anim/normal/porygon-z.gif" class="porygon-sprite" alt="Porygon-Z" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/474.gif'; this.onerror=function(){this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/474.png';};">
            
            <div class="porygon-ui">
                <div class="porygon-dialog-box">
                    <span id="porygon-text"></span>
                </div>
                
                <div id="input-container" class="user-input-container">
                    <div class="input-wrapper">
                        <input type="text" id="username" class="login-input" placeholder="Identifiant..." autocomplete="off" maxlength="12">
                        <button class="login-btn" onclick="window.finishIntroSequence()">CONNECTER</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ARCHITECTURE V7.0 GENESIS - SYSTEM LOG (Murmures d'Entropie) -->
    <div id="system-log" class="system-log">
        <!-- Les murmures apparaÃ®tront ici dynamiquement -->
    </div>
    
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="trainer-info" onclick="switchPage('profile')" style="cursor: pointer;">
                <span id="topbar-icon" style="font-size: 1.2em; margin-right: 8px;">ğŸ‘¤</span>
                <div style="flex: 1;">
                    <span class="trainer-level">Niveau: <span id="trainer-level">1</span></span>
                    <div id="topbar-title" style="font-size: 0.75em; color: rgba(255,255,255,0.7); margin-top: 2px; display: none;"></div>
                    <div class="xp-bar-container">
                        <div class="xp-bar-fill" id="xp-bar" style="width: 0%"></div>
                    </div>
                    <span class="xp-text" id="xp-text">0 / 500 XP</span>
                </div>
            </div>
        </div>
        <div class="top-bar-right">
            <!-- Jauge de StabilitÃ© SystÃ¨me (visible pour les niveaux 1-2) -->
            <div id="system-stability-display" style="display: none; flex-direction: column; align-items: flex-end; margin-right: 10px; min-width: 120px;">
                <div style="font-size: 0.7em; color: rgba(255,255,255,0.7); margin-bottom: 3px; font-family: var(--font-family-pixel);">STABILITÃ‰</div>
                <div style="width: 100px; height: 8px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; position: relative;">
                    <div id="stability-bar-fill" style="height: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); width: 0%; transition: width 0.5s ease; border-radius: 10px;"></div>
                </div>
                <div id="stability-text" style="font-size: 0.7em; color: rgba(255,255,255,0.8); margin-top: 2px; font-family: var(--font-family-pixel);">0%</div>
            </div>
            <div id="active-boosts" style="display: flex; gap: 8px; align-items: center; margin-right: 10px;"></div>
            <div class="resource-display">
                <span class="resource-icon">ğŸ’°</span>
                <span id="coins-display">3000</span>
            </div>
            <div class="resource-display" onclick="toggleStreakTooltip()" style="cursor: pointer;">
                <span class="resource-icon">ğŸ”¥</span>
                <span id="streak-display">0</span>
            </div>
        </div>
    </div>

    <!-- PAGE: BLIND BOX -->
    <div id="home-page" class="page active">
        <div class="container">
            <h1 style="text-align: center; margin-bottom: 20px;">ğŸ Blind Box</h1>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“š</div>
                    <div class="stat-value" id="pokedex-count">0</div>
                    <div class="stat-label">PokÃ©mon capturÃ©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âœ¨</div>
                    <div class="stat-value" id="shiny-count">0</div>
                    <div class="stat-label">Shinies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ”¥</div>
                    <div class="stat-value" id="best-streak">0</div>
                    <div class="stat-label">Meilleur streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ</div>
                    <div class="stat-value" id="blindbox-count">5/5</div>
                    <div class="stat-label">Blind Box dispo</div>
                </div>
            </div>

            <div class="game-section">
                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: white; margin-bottom: 15px;">ğŸ¾ Compagnon Buddy</h3>
                    <div id="buddy-home-display" style="text-align: center;">
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">Aucun Buddy sÃ©lectionnÃ©</p>
                        <button onclick="window.showBuddySelection && window.showBuddySelection();" class="btn btn--primary" style="padding: 12px 24px;">
                            Choisir un Buddy
                        </button>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(236, 72, 153, 0.3)); padding: 40px; border-radius: 20px; text-align: center; margin-bottom: 30px;">
                    <div id="blindbox-gift-3d-container" style="width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 20px; background: radial-gradient(circle, #2a2a40 0%, #0f0f15 100%); box-shadow: 0 0 50px rgba(255, 215, 0, 0.2); position: relative; animation: shine 2s infinite;"></div>
                    <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px; color: white;">
                        Blind Box disponibles: <span id="blindbox-count-page">5/5</span>
                    </div>
                    <div style="font-size: 0.9em; color: rgba(255,255,255,0.7); margin-bottom: 10px;" id="pity-counter">
                        0/20 vers LÃ©gendaire garanti
                    </div>
                    <div id="blindbox-timer" style="font-size: 0.85em; color: #FFD700; margin-bottom: 10px; display: none;"></div>
                    <button onclick="openBlindBox()" class="btn btn--primary btn--large" style="padding: 15px 40px; font-size: 1.2em;">
                        âœ¨ Ouvrir une Blind Box âœ¨
                    </button>
                </div>
                
                <div style="background: var(--dark-surface); padding: 20px; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“œ Historique rÃ©cent</h3>
                    <div id="blindbox-history"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE: CAPTURE -->
    <div id="capture-page" class="page">
        <div class="container">
            <h1 style="text-align: center; margin-bottom: 20px;">âš¾ Capture & PÃªche</h1>
            
            <div class="capture-tabs">
                <button class="capture-tab-button active" onclick="switchCaptureTab('capture')">âš¾ Capture</button>
                <button class="capture-tab-button" onclick="scrollToPeche()">ğŸ£ PÃªche</button>
            </div>
            
            <div class="game-section" id="capture-section">
                <div id="encounter" style="min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); border-radius: 12px; padding: 40px;">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Ccircle cx='100' cy='100' r='95' fill='%23ee1515'/%3E%3Ccircle cx='100' cy='100' r='95' fill='none' stroke='%23000' stroke-width='5'/%3E%3Crect x='0' y='95' width='200' height='10' fill='%23000'/%3E%3Ccircle cx='100' cy='100' r='60' fill='white'/%3E%3Ccircle cx='100' cy='100' r='60' fill='none' stroke='%23000' stroke-width='5'/%3E%3Ccircle cx='100' cy='100' r='30' fill='white'/%3E%3Ccircle cx='100' cy='100' r='30' fill='none' stroke='%23000' stroke-width='5'/%3E%3Ccircle cx='100' cy='100' r='15' fill='%23000'/%3E%3C/svg%3E" style="width: 200px; height: 200px;">
                </div>
                <button id="spawn-btn" class="btn btn--primary btn--large" style="width: 100%; margin-top: 15px; padding: 15px; font-size: 1.1em; display: flex; align-items: center; justify-content: center; gap: 8px;" onclick="if(typeof window.spawnPokemon==='function'){window.spawnPokemon();}else if(typeof spawnPokemon==='function'){spawnPokemon();}else{console.error('spawnPokemon non disponible');}">
                    <span id="spawn-btn-text">Capturer un PokÃ©mon</span>
                </button>
                
                <div style="background: var(--dark-surface); padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: white;">ğŸ“œ Historique des rencontres</h3>
                    <div id="capture-history"></div>
                </div>
            </div>
            
            <div class="game-section" id="fishing-section" style="margin-top: 50px; scroll-margin-top: 100px; position: relative;">
                <h2 style="text-align: center; margin-bottom: 20px;">ğŸ£ PÃªche</h2>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                    <span id="fishing-unlock-text">DÃ©bloquÃ© au niveau 2.</span>
                </p>
                
                <div id="fishing-zone" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(14, 165, 233, 0.3)); padding: 40px; border-radius: 20px; text-align: center; position: relative;">
                    <div id="fishing-wave-3d-container" style="width: 100%; height: 200px; margin: 0 auto 20px; border-radius: 20px; background: linear-gradient(to bottom, #1a1a2e 0%, #0d47a1 100%); position: relative; overflow: hidden;"></div>
                    <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: white;">
                        Jetons de pÃªche: <span id="fishing-tokens">10</span> ğŸ£
                    </div>
                    <div id="fishing-token-timer" style="font-size: 0.85em; color: #FFD700; margin-bottom: 10px; display: none;"></div>
                    <button id="fishing-btn" onclick="startFishing()" class="btn btn--primary btn--large" style="padding: 15px 40px; font-size: 1.2em;" disabled>
                        ğŸ£ PÃªcher un PokÃ©mon
                    </button>
                </div>
                
                <div style="background: var(--dark-surface); padding: 20px; border-radius: 15px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: white;">ğŸ“œ Historique des pÃªches</h3>
                    <div id="fishing-history"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE: POKÃ‰DEX -->
    <div id="pokedex-page" class="page">
        <div class="container">
            <h1 style="text-align: center; margin-bottom: 20px;">ğŸ“š PokÃ©dex</h1>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="switchPokedexMode('grid')" id="mode-grid-btn" class="btn btn--primary" style="margin-right: 10px;">ğŸ“Š Dex</button>
            </div>
            
            <div style="background: var(--dark-surface); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <select id="pokedex-filter-status" onchange="filterPokedex()" style="padding: 10px; border-radius: 8px; background: var(--dark-elevated); border: 2px solid var(--dark-border); color: white; font-size: 14px;">
                        <option value="all">Tous</option>
                        <option value="caught">CapturÃ©s</option>
                        <option value="not-caught">Non capturÃ©s</option>
                        <option value="shiny">Shiny</option>
                    </select>
                    <select id="pokedex-filter-rarity" onchange="filterPokedex()" style="padding: 10px; border-radius: 8px; background: var(--dark-elevated); border: 2px solid var(--dark-border); color: white; font-size: 14px;">
                        <option value="all">Toutes raretÃ©s</option>
                        <option value="common">Commun</option>
                        <option value="uncommon">Peu Commun</option>
                        <option value="rare">Rare</option>
                        <option value="super_rare">Super Rare</option>
                        <option value="legendary">LÃ©gendaire</option>
                    </select>
                    <select id="pokedex-filter-type" onchange="filterPokedex()" style="padding: 10px; border-radius: 8px; background: var(--dark-elevated); border: 2px solid var(--dark-border); color: white; font-size: 14px;">
                        <option value="all">Tous types</option>
                        <option value="Normal">Normal</option>
                        <option value="Fire">Feu</option>
                        <option value="Water">Eau</option>
                        <option value="Electric">Ã‰lectrik</option>
                        <option value="Grass">Plante</option>
                        <option value="Ice">Glace</option>
                        <option value="Fighting">Combat</option>
                        <option value="Poison">Poison</option>
                        <option value="Ground">Sol</option>
                        <option value="Flying">Vol</option>
                        <option value="Psychic">Psy</option>
                        <option value="Bug">Insecte</option>
                        <option value="Rock">Roche</option>
                        <option value="Ghost">Spectre</option>
                        <option value="Dragon">Dragon</option>
                    </select>
                    <select id="pokedex-filter-evolvable" onchange="filterPokedex()" style="padding: 10px; border-radius: 8px; background: var(--dark-elevated); border: 2px solid var(--dark-border); color: white; font-size: 14px;">
                        <option value="all">Tous</option>
                        <option value="evolvable">Ã‰voluables uniquement</option>
                    </select>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--text-secondary); margin-bottom: 5px;">RÃ©gion actuelle</div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea;" id="current-region-display">Kanto</div>
                    <div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;">
                        <span id="region-progress-display">0/151</span> PokÃ©mon capturÃ©s
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap;">
                <button id="region-tab-kanto" class="btn btn--primary" onclick="switchPokedexRegion('Kanto')" style="padding: 10px 20px;">
                    ğŸŒ‹ Kanto
                </button>
                <button id="region-tab-johto" class="btn btn--outline" onclick="switchPokedexRegion('Johto')" style="padding: 10px 20px;">
                    ğŸ”ï¸ Johto
                </button>
                <button id="region-tab-hoenn" class="btn btn--outline" onclick="switchPokedexRegion('Hoenn')" style="padding: 10px 20px;">
                    ğŸŒŠ Hoenn
                </button>
            </div>
            
            <div id="pokemon-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;"></div>
            <div id="pokemon-list" style="display: none;"></div>
        </div>
    </div>

    <!-- PAGE: BOUTIQUE -->
    <div id="shop-page" class="page">
        <div class="container">
            <h1 style="text-align: center; margin-bottom: 20px;">ğŸ›’ Boutique</h1>
            
            <div class="shop-tabs">
                <button class="shop-tab-button active" onclick="scrollToSection('shop-pokeballs')">âš¾ PokÃ©balls</button>
                <button class="shop-tab-button" onclick="scrollToSection('shop-berries')">ğŸ“ Baies</button>
                <button class="shop-tab-button" onclick="scrollToSection('shop-items')">âœ¨ Objets</button>
                <button class="shop-tab-button" onclick="scrollToSection('shop-lootboxes')">ğŸ Lootboxes</button>
            </div>
            
            <div id="shop-content" style="max-width: 800px; margin: 0 auto;">
                <div id="shop-pokeballs" class="shop-section"><h2>âš¾ PokÃ©balls</h2><div id="shop-pokeballs-items"></div></div>
                <div id="shop-berries" class="shop-section" style="margin-top: 40px;"><h2>ğŸ“ Baies</h2><div id="shop-berries-items"></div></div>
                <div id="shop-items" class="shop-section" style="margin-top: 40px;"><h2>âœ¨ Objets SpÃ©ciaux</h2><div id="shop-items-items"></div></div>
                <div id="shop-lootboxes" class="shop-section" style="margin-top: 40px;"><h2 style="display: flex; align-items: center; gap: 10px;">ğŸ Lootboxes <span onclick="showLootboxInfo()" style="cursor: pointer; font-size: 1em; color: #ffd700; background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.3)); width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; transition: all 0.3s; border: 2px solid rgba(255,215,0,0.6); box-shadow: 0 0 15px rgba(255,215,0,0.4); animation: pulse 2s infinite;" onmouseenter="this.style.background='linear-gradient(135deg, rgba(255,215,0,0.5), rgba(255,165,0,0.5))'; this.style.borderColor='rgba(255,215,0,0.9)'; this.style.transform='scale(1.2)'; this.style.boxShadow='0 0 25px rgba(255,215,0,0.7)'; this.style.animation='none'" onmouseleave="this.style.background='linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.3))'; this.style.borderColor='rgba(255,215,0,0.6)'; this.style.transform='scale(1)'; this.style.boxShadow='0 0 15px rgba(255,215,0,0.4)'; this.style.animation='pulse 2s infinite'" title="ğŸ’¡ En savoir plus sur les Lootboxes">â„¹ï¸</span></h2><div id="shop-lootboxes-items"></div></div>
            </div>
        </div>
    </div>

    <!-- PAGE: QUÃŠTES -->
    <div id="quests-page" class="page">
        <div class="container">
            <h1 style="text-align: center; margin-bottom: 20px;">âœ¨ QuÃªtes & DÃ©fis</h1>
            
            <div class="quest-tabs">
                <button class="quest-tab-button active" onclick="scrollToSection('quests-daily')">ğŸ“… Quotidiennes</button>
                <button class="quest-tab-button" onclick="scrollToSection('quests-special')">ğŸ¯ SpÃ©ciales</button>
                <button class="quest-tab-button" onclick="scrollToSection('quests-permanent')">ğŸ† Permanentes</button>
            </div>
            
            <div id="quests-daily" class="game-section" style="margin-bottom: 30px;"><h2>ğŸ“… QuÃªtes Quotidiennes</h2><div id="daily-quests-container"></div></div>
            <div id="quests-special" class="game-section" style="margin-bottom: 30px;"><h2>ğŸ¯ QuÃªtes SpÃ©ciales</h2><div id="special-quests-container"></div></div>
            <div id="quests-permanent" class="game-section"><h2>ğŸ† Challenges Permanents</h2><div id="permanent-quests-container"></div></div>
        </div>
    </div>

    <!-- PAGE: INVENTAIRE -->
    <div id="inventory-page" class="page">
        <div class="container" style="max-width: 800px;">
            <h1 style="text-align: center; margin-bottom: 20px;">ğŸ’ Inventaire</h1>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <label style="color: var(--text-secondary); cursor: pointer;">
                    <input type="checkbox" id="show-unowned" onchange="renderInventory()" style="margin-right: 8px;">
                    Afficher les objets non obtenus
                </label>
            </div>
            
            <div id="inventory-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;"></div>
        </div>
    </div>

    <!-- PAGE: PROFIL -->
    <div id="profile-page" class="page">
        <div class="container" style="max-width: 700px;">
            <h1 style="text-align: center; margin-bottom: 30px;">ğŸ‘¤ Profil Dresseur</h1>
            
            <div id="profile-header-bg" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)); padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; position: relative;">
                <div style="position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 0.9em; color: rgba(255,255,255,0.4); transition: all 0.3s; display: flex; align-items: center; gap: 4px;" onmouseenter="this.style.color='rgba(255,255,255,0.7)'" onmouseleave="this.style.color='rgba(255,255,255,0.4)'" onclick="openCustomizationEditor('icon')" title="Ã‰diter l'icÃ´ne"><span style="filter: grayscale(100%); opacity: 0.5;">âœï¸</span><span style="font-size: 0.75em;">IcÃ´ne</span></div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div id="profile-icon" style="font-size: 3em; flex-shrink: 0;">ğŸ‘¤</div>
                    <div style="position: relative; display: flex; align-items: center; gap: 8px;">
                        <div id="profile-name" style="font-size: 1.8em; font-weight: bold; color: white;">
                            Dresseur Niveau <span id="profile-level">1</span>
                        </div>
                        <span style="cursor: pointer; font-size: 0.8em; color: rgba(255,255,255,0.4); transition: all 0.3s; display: flex; align-items: center; gap: 3px; flex-shrink: 0;" onmouseenter="this.style.color='rgba(255,255,255,0.7)'" onmouseleave="this.style.color='rgba(255,255,255,0.4)'" onclick="editTrainerName()" title="Ã‰diter le nom"><span style="filter: grayscale(100%); opacity: 0.5;">âœï¸</span><span style="font-size: 0.7em;">Nom</span></span>
                    </div>
                </div>
                <div id="profile-title" style="font-size: 1em; color: rgba(255,255,255,0.9); margin-bottom: 10px; font-style: italic; display: none;"></div>
                <div id="profile-title-edit" style="position: absolute; bottom: 10px; left: 10px; cursor: pointer; font-size: 0.9em; color: rgba(255,255,255,0.4); transition: all 0.3s; display: none; align-items: center; gap: 4px;" onmouseenter="this.style.color='rgba(255,255,255,0.7)'" onmouseleave="this.style.color='rgba(255,255,255,0.4)'" onclick="openCustomizationEditor('title')" title="Ã‰diter le titre"><span style="filter: grayscale(100%); opacity: 0.5;">âœï¸</span><span style="font-size: 0.75em;">Titre</span></div>
                <div style="position: relative; display: inline-block; width: 100%; max-width: 300px;">
                    <div style="color: rgba(255,255,255,0.8); margin-bottom: 15px;">
                        <span id="profile-xp">0</span> / <span id="profile-xp-next">500</span> XP
                    </div>
                    <div style="width: 100%; height: 15px; background: rgba(0,0,0,0.3); border-radius: 15px; overflow: hidden; margin: 0 auto; position: relative;">
                        <div id="profile-xp-bar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s;"></div>
                        <div id="xp-bar-edit-btn" onclick="openCustomizationEditor('xpbar')" style="display: none; position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 0.8em; color: rgba(255,255,255,0.4); transition: all 0.3s;" onmouseenter="this.style.color='rgba(255,255,255,0.7)'" onmouseleave="this.style.color='rgba(255,255,255,0.4)'" title="Ã‰diter la barre XP">âœï¸</div>
                    </div>
                </div>
                <div style="position: absolute; bottom: 10px; right: 10px; cursor: pointer; font-size: 0.9em; color: rgba(255,255,255,0.4); transition: all 0.3s; display: flex; align-items: center; gap: 4px;" onmouseenter="this.style.color='rgba(255,255,255,0.7)'" onmouseleave="this.style.color='rgba(255,255,255,0.4)'" onclick="openCustomizationEditor('background')" title="Ã‰diter le background"><span style="filter: grayscale(100%); opacity: 0.5;">âœï¸</span><span style="font-size: 0.75em;">Fond</span></div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">PokÃ©dex</div>
                    <div class="stat-value" id="profile-pokedex">0</div>
                    <div style="font-size: 0.9em; color: #666;">/ 151</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total CapturÃ©s</div>
                    <div class="stat-value" id="profile-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Shinies</div>
                    <div class="stat-value" style="color: #FFD700;" id="profile-shinies">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Meilleur Streak</div>
                    <div class="stat-value" style="color: #f97316;" id="profile-best-streak">0</div>
                </div>
            </div>
            
            <div class="game-section" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸŒ RÃ©gions</h3>
                <div id="regions-container" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;"></div>
            </div>

            <div class="game-section" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸ“Š Statistiques</h3>
                <div style="display: grid; gap: 10px;">
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
                        <span>â±ï¸ Temps de jeu</span>
                        <span id="stat-playtime">0h 0m</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
                        <span>ğŸ¯ Taux de rÃ©ussite</span>
                        <span id="stat-success-rate">0%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
                        <span>ğŸ“¦ Blind Box ouvertes</span>
                        <span id="stat-blindbox">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
                        <span>ğŸ£ PokÃ©mon pÃªchÃ©s</span>
                        <span id="stat-fished">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
                        <span>ğŸ’° Coins gagnÃ©s (total)</span>
                        <span id="stat-coins-earned">0</span>
                    </div>
                </div>
            </div>

            <!-- Section Leaderboard -->
            <div class="game-section" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸ† Classements</h3>
                <button onclick="switchPage('leaderboard')" class="btn btn--primary" style="width: 100%; padding: 15px; font-size: 1.1em; background: linear-gradient(135deg, #a855f7, #7d5fff); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);">
                    ğŸ“Š Voir les Leaderboards
                </button>
                <p style="color: rgba(255,255,255,0.6); text-align: center; margin-top: 10px; font-size: 0.9em;">
                    Top PDG â€¢ Top Collectionneur â€¢ Top StratÃ¨ge
                </p>
            </div>

            <!-- Section Sauvegarde Cloud -->
            <div class="game-section" style="margin-bottom: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); padding: 20px; border-radius: 15px; border: 2px solid rgba(102, 126, 234, 0.3);">
                <h3 style="margin-bottom: 15px; color: white;">ğŸ’¾ Archivage des DonnÃ©es</h3>
                <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 0.9em;">Archivez les donnÃ©es rÃ©cupÃ©rÃ©es pour les synchroniser sur tous vos terminaux.</p>
                <div id="profile-cloud-section" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; justify-content: center;">
                    <!-- Le bouton sera ajoutÃ© dynamiquement par updateAuthUI -->
                </div>
                <div id="profile-cloud-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <!-- Boutons d'action cloud (charger/sauvegarder) -->
                </div>
            </div>

            <div style="text-align: center;">
                <button id="refresh-page-btn" class="btn btn--outline" style="background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #3b82f6;" onclick="window.location.reload()">
                    ğŸ”„ Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- PAGE: POKÃ‰-POKER -->
    <div id="poker-page" class="page crt" style="background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; position: relative;">
        <div id="poker-root"></div>
    </div>

    <!-- PAGE: EXPEDITION -->
    <div id="expedition-page" class="page">
        <div class="container" id="expedition-container">
            <!-- Content will be dynamically generated -->
        </div>
    </div>

    <!-- PAGE: RECHERCHE -->
    <div id="leaderboard-page" class="page">
        <!-- Contenu gÃ©nÃ©rÃ© par renderLeaderboard() -->
    </div>
    
    <div id="research-page" class="page">
        <!-- Content will be dynamically generated -->
    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="hub-overlay" id="hubOverlay" onclick="toggleHub()">
        <div class="hub-grid" onclick="event.stopPropagation()">
            <div class="hub-item quests" onclick="selectHubItem('quests')">
                <div class="hub-notif" id="hub-notif-quests" style="display:none;">!</div>
                <div class="hub-icon">âœ¨</div>
                <div class="hub-label">QuÃªtes</div>
                <div class="hub-desc">Objectifs & DÃ©fis</div>
            </div>
            <div class="hub-item inventory" onclick="selectHubItem('inventory')">
                <div class="hub-icon">ğŸ’</div>
                <div class="hub-label">Inventaire</div>
                <div class="hub-desc">Objets & Å’ufs</div>
            </div>
            <div class="hub-item pokedex" onclick="selectHubItem('pokedex')">
                <div class="hub-icon">ğŸ“š</div>
                <div class="hub-label">PokÃ©dex</div>
                <div class="hub-desc">Collection 100%</div>
            </div>
            <div class="hub-item shop" onclick="selectHubItem('shop')">
                <div class="hub-icon">ğŸ›’</div>
                <div class="hub-label">Boutique</div>
                <div class="hub-desc">Packs & Jokers</div>
            </div>
            <div class="hub-item research" onclick="selectHubItem('research')">
                <div class="hub-icon">âš¡</div>
                <div class="hub-label">Recherche</div>
                <div class="hub-desc">Ã‰nergie Onirique</div>
            </div>
        </div>
    </div>

    <nav class="new-bottom-nav">
        <button class="nav-btn active" id="nav-btn-home" onclick="selectNav('home')">
            <span class="nav-icon">ğŸ</span>
            <span class="nav-label">Box</span>
        </button>

        <button class="nav-btn" id="nav-btn-capture" onclick="selectNav('capture')">
            <span class="nav-icon" id="nav-capture-icon"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" style="width: 24px; height: 24px; image-rendering: pixelated; vertical-align: middle; display: inline-block; object-fit: contain;" alt="Master Ball" onerror="this.style.display='none'; this.parentElement.innerHTML='ğŸ’œ';"></span>
            <span class="nav-label">Capture</span>
        </button>

        <div class="nav-hub-wrapper" id="hubWrapper">
            <button class="nav-hub-btn" onclick="toggleHub()">
                <img id="hubIcon" src="assets/icons/pokeball-hub.png" alt="Menu" class="hub-icon-img" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'">
            </button>
        </div>

        <button class="nav-btn" id="nav-btn-expedition" onclick="selectNav('expedition')">
            <span class="nav-icon">ğŸ—ºï¸</span>
            <span class="nav-label">ExpÃ©dition</span>
        </button>

        <button class="nav-btn" id="nav-btn-poker" onclick="selectNav('poker')">
            <span class="nav-icon">ğŸƒ</span>
            <span class="nav-label">PokÃ©-Poker</span>
        </button>
    </nav>

    <script>
        let isHubOpen = false;

        function toggleHub() {
            isHubOpen = !isHubOpen;
            const overlay = document.getElementById('hubOverlay');
            const wrapper = document.getElementById('hubWrapper');

            if (isHubOpen) {
                overlay.classList.add('active');
                wrapper.classList.add('hub-open');
                if (window.navigator && window.navigator.vibrate) try { window.navigator.vibrate(10); } catch(e){}
            } else {
                overlay.classList.remove('active');
                wrapper.classList.remove('hub-open');
            }
        }

        function selectNav(pageName) {
            if (isHubOpen) toggleHub();
            updateActiveNav(pageName);
            if (window.switchPage) window.switchPage(pageName);
        }

        function selectHubItem(pageName) {
            // âœ… CORRECTION : Protection renforcÃ©e pour bloquer les quÃªtes au niveau 1
            if (pageName === 'quests') {
                if (!window.gameState || !window.gameState.modules || !window.gameState.modules.quests || 
                    (!window.gameState.modules.quests.unlocked && (window.gameState.level < 2 || window.gameState.level === 1))) {
                    if (window.showToast) window.showToast('ğŸ”’ Les QuÃªtes seront dÃ©bloquÃ©es au niveau 2 !', 'error');
                    return;
                }
            }
            
            // âœ… Protection : Bloquer le Laboratoire jusqu'au niveau 5
            if (pageName === 'research') {
                if (!window.gameState || !window.gameState.research || 
                    (!window.gameState.research.unlocked && window.gameState.level < 5)) {
                    if (window.showToast) window.showToast('ğŸ”’ Le Centre de Recherche sera dÃ©bloquÃ© au niveau 5 !', 'error');
                    return;
                }
            }
            
            toggleHub();
            // DÃ©sactive la surbrillance du bas quand on est dans une sous-page du Hub
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (window.switchPage) window.switchPage(pageName);
        }

        function updateActiveNav(pageName) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('nav-btn-' + pageName);
            if (btn) btn.classList.add('active');
        }
    </script>

    <!-- LOAD JAVASCRIPT -->
    <!-- Ordre de chargement critique pour Ã©viter les erreurs de dÃ©pendances -->
    <!-- 1. Supabase (doit Ãªtre disponible pour app.js dans saveGame) -->
    <script src="supabase_manager.js"></script>
    <script src="supabase_ui.js"></script>
    <!-- ARCHITECTURE V7.0 GENESIS - Configuration API (ZÃ©ro-Asset) -->
    <script src="config/api_endpoints.js"></script>
    <!-- ARCHITECTURE V7.0 GENESIS - Bible Narrative -->
    <script src="data/narrative_db.js"></script>
    <!-- 2. Moteur 3D Genesis (doit Ãªtre chargÃ© avant app.js) -->
    <script src="genesis-3d.js"></script>
    <!-- 3. app.js dÃ©finit gameState (exposÃ© sur window.gameState) -->
    <script src="app.js"></script>
    <!-- 3. Scripts qui dÃ©pendent de gameState (chargÃ©s aprÃ¨s app.js) -->
    <script src="capture_minigame_logic.js"></script>
    <script src="game_extensions.js"></script>
    <script src="poker_meta_shop.js"></script>
    <script src="premium_fx.js"></script>
    <script src="fishing_overhaul.js"></script>
    <!-- 4. PWA UI - Gestion de l'installation -->
    <script src="pwa_ui.js"></script>
    
    <!-- POKÃ‰-POKER GAME SCRIPT - Code complet fourni par l'utilisateur -->
    <script>
        // QA & POLISHING : Chargement robuste du PokÃ©-Poker avec gestion d'erreurs amÃ©liorÃ©e
        (function() {
            let initAttempts = 0;
            const MAX_INIT_ATTEMPTS = 50; // AugmentÃ© Ã  25 secondes (50 * 500ms) pour les tÃ©lÃ©phones lents
            let babelCompileStartTime = null;
            
            // Fonction pour initialiser le composant React aprÃ¨s que Babel ait compilÃ©
            function tryInitPokerApp() {
                initAttempts++;
                const rootElement = document.getElementById('poker-root');
                
                // VÃ©rifications de dÃ©bogage
                if (initAttempts === 1) {
                    console.log('ğŸ® Initialisation PokÃ©-Poker...');
                    console.log('React disponible:', typeof React !== 'undefined');
                    console.log('ReactDOM disponible:', typeof ReactDOM !== 'undefined');
                    console.log('Babel disponible:', typeof Babel !== 'undefined');
                    console.log('poker-root existe:', !!rootElement);
                }
                
                // VÃ©rifier les dÃ©pendances critiques
                if (!rootElement) {
                    if (initAttempts < MAX_INIT_ATTEMPTS) {
                        setTimeout(tryInitPokerApp, 200);
                    } else {
                        console.error('âŒ Timeout: poker-root n\'existe pas');
                    }
                    return;
                }
                
                if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                    if (initAttempts < MAX_INIT_ATTEMPTS) {
                        setTimeout(tryInitPokerApp, 200);
                    } else {
                        console.error('âŒ Timeout: React ou ReactDOM ne sont pas disponibles');
                        rootElement.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-family: VT323, monospace;">Erreur: React n\'est pas chargÃ©.<br><small>VÃ©rifiez votre connexion internet.</small></div>';
                    }
                    return;
                }
                
                // VÃ©rifier si Babel est en train de compiler
                if (typeof Babel === 'undefined') {
                    if (initAttempts < MAX_INIT_ATTEMPTS) {
                        setTimeout(tryInitPokerApp, 200);
                    } else {
                        console.error('âŒ Timeout: Babel n\'est pas disponible');
                        rootElement.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-family: VT323, monospace;">Erreur: Babel n\'est pas chargÃ©.<br><small>VÃ©rifiez votre connexion internet.</small></div>';
                    }
                    return;
                }
                
                // VÃ©rifier si App est dÃ©fini (compilÃ© par Babel)
                if (typeof App !== 'undefined') {
                    try {
                        console.log('âœ… Rendu du composant PokÃ©-Poker...');
                        const root = ReactDOM.createRoot(rootElement);
                        // Utiliser React.createElement car nous sommes en JavaScript pur, pas en JSX
                        root.render(React.createElement(App));
                        console.log('âœ… PokÃ©-Poker initialisÃ© avec succÃ¨s!');
                        if (babelCompileStartTime) {
                            console.log('â±ï¸ Temps de compilation Babel:', Date.now() - babelCompileStartTime, 'ms');
                        }
                        return; // SuccÃ¨s
                    } catch (error) {
                        console.error('âŒ Erreur lors du rendu du composant PokÃ©-Poker:', error);
                        rootElement.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-family: VT323, monospace;">Erreur de chargement du jeu PokÃ©-Poker.<br><small>' + error.message + '</small><br><button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #a855f7; color: white; border: none; border-radius: 8px; cursor: pointer;">Recharger</button></div>';
                        return; // Erreur
                    }
                } else {
                    // App n'est pas encore dÃ©fini, Babel n'a peut-Ãªtre pas encore compilÃ©
                    if (!babelCompileStartTime && initAttempts > 5) {
                        // Si on attend depuis plus de 5 tentatives, Babel est probablement en train de compiler
                        babelCompileStartTime = Date.now();
                    }
                    
                    if (initAttempts < MAX_INIT_ATTEMPTS) {
                        if (initAttempts % 10 === 0) {
                            console.log('â³ En attente de la compilation Babel... (tentative ' + initAttempts + '/' + MAX_INIT_ATTEMPTS + ')');
                        }
                        setTimeout(tryInitPokerApp, 500);
                    } else {
                        console.error('âŒ Timeout: Le composant App n\'a pas Ã©tÃ© compilÃ© par Babel aprÃ¨s ' + MAX_INIT_ATTEMPTS + ' tentatives');
                        rootElement.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-family: VT323, monospace;">Erreur: Le jeu PokÃ©-Poker n\'a pas pu Ãªtre chargÃ©.<br><small>Le composant App n\'a pas Ã©tÃ© trouvÃ© aprÃ¨s ' + (MAX_INIT_ATTEMPTS * 500 / 1000) + ' secondes.<br>Votre appareil est peut-Ãªtre trop lent. Essayez de recharger la page.</small><br><button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #a855f7; color: white; border: none; border-radius: 8px; cursor: pointer;">Recharger</button></div>';
                    }
                }
            }
            
            // Fonction pour charger le fichier JSX
            function loadPokerGame() {
                // VÃ©rifier que React et ReactDOM sont disponibles
                if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                    console.error('âŒ React ou ReactDOM ne sont pas disponibles');
                    return;
                }
                
                fetch('poker-game-full.jsx')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erreur HTTP: ' + response.status);
                        }
                        return response.text();
                    })
                    .then(code => {
                        console.log('ğŸ“¦ Chargement du fichier poker-game-full.jsx...');
                        
                        // VÃ©rifier que Babel est disponible
                        if (typeof Babel === 'undefined') {
                            throw new Error('Babel n\'est pas disponible');
                        }
                        
                        console.log('âš™ï¸ Compilation du JSX avec Babel...');
                        const compileStartTime = Date.now();
                        try {
                            // QA & POLISHING : Compilation Babel avec gestion d'erreurs amÃ©liorÃ©e
                            const compiledCode = Babel.transform(code, {
                                presets: ['react'],
                                // Options supplÃ©mentaires pour amÃ©liorer la compatibilitÃ©
                                compact: false,
                                retainLines: false
                            }).code;
                            
                            const compileTime = Date.now() - compileStartTime;
                            console.log('âœ… Code compilÃ© avec succÃ¨s en ' + compileTime + 'ms, exÃ©cution...');
                            
                            // VÃ©rifier si le script a dÃ©jÃ  Ã©tÃ© ajoutÃ©
                            const existingScript = document.getElementById('poker-game-script');
                            if (existingScript) {
                                existingScript.remove();
                            }
                            
                            // ExÃ©cuter le code compilÃ©
                            const script = document.createElement('script');
                            script.id = 'poker-game-script';
                            script.textContent = compiledCode;
                            
                            // QA & POLISHING : Ajouter un gestionnaire d'erreur au script
                            script.onerror = function(error) {
                                console.error('âŒ Erreur d\'exÃ©cution du script compilÃ©:', error);
                                const rootElement = document.getElementById('poker-root');
                                if (rootElement) {
                                    rootElement.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-family: VT323, monospace;">Erreur d\'exÃ©cution du code compilÃ©.<br><small>' + error.message + '</small><br><button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #a855f7; color: white; border: none; border-radius: 8px; cursor: pointer;">Recharger</button></div>';
                                }
                            };
                            
                            document.head.appendChild(script);
                            
                            // QA & POLISHING : Attendre un peu plus longtemps pour les appareils lents
                            setTimeout(tryInitPokerApp, 1000); // AugmentÃ© de 500ms Ã  1000ms
                        } catch (compileError) {
                            console.error('âŒ Erreur de compilation Babel:', compileError);
                            const rootElement = document.getElementById('poker-root');
                            if (rootElement) {
                                rootElement.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-family: VT323, monospace;">Erreur de compilation Babel.<br><small>' + compileError.message + '</small><br><button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #a855f7; color: white; border: none; border-radius: 8px; cursor: pointer;">Recharger</button></div>';
                            }
                            throw compileError;
                        }
                    })
                    .catch(error => {
                        console.error('âŒ Erreur de chargement du fichier poker-game-full.jsx:', error);
                        // Fallback: initialisation basique
                        const rootElement = document.getElementById('poker-root');
                        if (rootElement && typeof ReactDOM !== 'undefined') {
                            const root = ReactDOM.createRoot(rootElement);
                            root.render(React.createElement('div', { 
                                className: 'text-white text-center p-8',
                                style: { padding: '40px', fontFamily: 'VT323, monospace' }
                            }, [
                                React.createElement('h2', { key: 'title', style: { marginBottom: '20px' } }, 'Erreur de chargement'),
                                React.createElement('p', { key: 'error' }, 'Erreur: ' + error.message),
                                React.createElement('p', { key: 'reload' }, 'Veuillez recharger la page.')
                            ]));
                        }
                    });
            }
            
            // Attendre que le DOM soit prÃªt
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadPokerGame);
            } else {
                // Le DOM est dÃ©jÃ  chargÃ©
                setTimeout(loadPokerGame, 100);
            }
        })();
    </script>
    
    <script>
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function scrollToPeche() {
            const fishingSection = document.getElementById('fishing-section');
            if (fishingSection) {
                fishingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function switchCaptureTab(tab) {
            const captureSection = document.getElementById('capture-section');
            if (tab === 'capture' && captureSection) {
                captureSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Initialize Supabase Manager after page load
        document.addEventListener('DOMContentLoaded', () => {
            // Attendre que tous les scripts soient chargÃ©s
            setTimeout(() => {
                if (window.SupabaseManager) {
                    window.SupabaseManager.init();
                } else {
                    // Si SupabaseManager n'est pas encore chargÃ©, rÃ©essayer
                    setTimeout(() => {
                        if (window.SupabaseManager) {
                            window.SupabaseManager.init();
                        } else {
                            // Afficher quand mÃªme le bouton de connexion
                            if (window.updateAuthUI) {
                                window.updateAuthUI(false);
                            }
                        }
                    }, 1000);
                }
            }, 500);
            
            // Initialiser les modÃ¨les 3D aprÃ¨s chargement
            setTimeout(() => {
                if (window.initFishingWave3D) {
                    window.initFishingWave3D();
                }
                if (window.initBlindBoxGift3D) {
                    window.initBlindBoxGift3D();
                }
            }, 1000);
        });
    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            // Forcer la mise Ã  jour du service worker
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.update();
                }
            });
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('âœ… Service Worker registered:', registration.scope);
                        
                        // VÃ©rifier les mises Ã  jour immÃ©diatement et pÃ©riodiquement
                        registration.update();
                        
                        // Ã‰couter les mises Ã  jour disponibles
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nouvelle version disponible, forcer le rechargement
                                    console.log('ğŸ”„ Nouvelle version disponible, rechargement...');
                                    if (confirm('Une nouvelle version est disponible. Voulez-vous recharger la page ?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                        
                        // VÃ©rifier les mises Ã  jour pÃ©riodiquement
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Toutes les minutes
                    })
                    .catch((error) => {
                        console.warn('âŒ Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
